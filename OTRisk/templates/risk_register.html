{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-heatmap.min.js"></script>


    <script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
    {% load django_bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}

    <title>Assess CyberPHA</title>
    <style>
    .small-font {
        font-size: 0.8rem; /* adjust as needed */
   }

    .navbar-scroll .nav-link,
    .navbar-scroll .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #ffffff;
    }

    /* Color of the navbar BEFORE scroll */
    .navbar-scroll {
      background-color: #000000;
        text-decoration-color: #FFFFFF;
    }


    /* Color of the links AFTER scroll */
    .navbar-scrolled .nav-link,
    .navbar-scrolled .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #262626;
    }

    .navbar-logo {
    position: absolute;
    top: 5px; /* Adjust this as needed */
    left: 5; /* Adjust this as needed */
    height: 100px; /* Adjust this as needed */
    z-index: 10;
}
        .table-wrap {
          height: 200px;
          overflow-y: auto;
        }

        .small-font {
        font-size: 0.8rem; /* adjust as needed */
        }

    .clickable-label:hover {
        cursor: pointer;
    }

    .table tbody tr:hover {
    cursor: pointer;
    }



    .heatmap {
        border-collapse: collapse;
    }
    .heatmap td {
        width: 60px;
        height: 60px;
        text-align: center;
        border: 1px solid #ccc;
    }
    .Low { background-color: #d8e6d6; }
    .Low-Medium { background-color: #f7e5a0; }
    .Medium { background-color: #f9d56e; }
    .Medium-High { background-color: #f9a56e; }
    .High { background-color: #f95d6a; }
</style>


</head>
<body>

<nav class="navbar navbar-expand-lg navbar-scroll fixed-top shadow-0 border-bottom border-dark rounded">
  <div class="container-fluid d-flex justify-content-between">
   <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}"><img src="/static/images/logo1-2.jpg" style="height: 140px; width: 140px" class="navbar-logo" alt="">  </a>
      <h4 class="my-auto text-center flex-grow-1"><font color="white">OT Cybersecurity Risk Register</font></h4>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}"><i class="bi bi-journal-text"></i> CyberPHA</a>
        </li>
          <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:ra_actions_view' %}" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Actions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:risk_register' %}" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Risk Register</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-file-earmark-easel"></i> Reports
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports' %}" >QRAW Reports</a></li>
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports_pha' %}">CyberPHA Reports</a></li>
              </ul>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_scenario' %}">Scenario Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_consequence' %}">Consequence Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:admin_users' %}">Admin Users</a></li>
                  {% if user.is_staff %}
                    <!-- Links visible only to superusers -->
                    <li><a class="dropdown-item" href="{% url 'OTRisk:user_admin' %}">User Administration</a></li>
                      <li><a class="dropdown-item" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a></li>
                    {% endif %}

              </ul>

        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:profile' %}">
                <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
            </a>
        </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </li>
      </ul>
    </div>
  </div>

</nav>
<div class="row">
<div class="col-md-1 " style="background-color: black"></div>
<div class="col-md-10 ">

    <h2>Risk Register</h2>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Facility Name</th>
                <th>Assessment Unit</th>
                <th>Risk Scenario</th>
                <th>Residual Risk</th>
                <th>BIA</th>
                <th>Est Costs (Low/Medium/High)</th>
                <th>Assessment Start</th>
                <th>Assessment End</th>
                <th>Probability</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr>
                <td>{{ item.CyberPHA__FacilityName }}</td>
                <td>{{ item.CyberPHA__AssessmentUnit }}</td>
                <td>{{ item.Scenario }}</td>
                <td>
                    {% if item.RRa == "Low" %}
                        <span style="color:green;">●</span>
                    {% elif item.RRa == "Low/Medium" %}
                        <span style="color:olive;">●</span>
                    {% elif item.RRa == "Medium" %}
                        <span style="color:yellow;">●</span>
                    {% elif  item.RRa == "Medium/High" %}
                        <span style="color:orange;">●</span>
                    {% elif item.RRa == "High" %}
                        <span style="color:red;">●</span>
                    {% endif %}
                    {{ item.RRa }}
                </td>
                <td>{{ item.business_impact_analysis_score }}({{ item.business_impact_analysis_code }})</td>
                <td>${{ item.sle_low|intcomma }}/${{ item.sle|intcomma }}/${{ item.sle_high|intcomma }}</td>

                <td>{{ item.CyberPHA__AssessmentStartDate|date:"d M Y" }}</td>
                <td>{{ item.CyberPHA__AssessmentEndDate|date:"d M Y" }}</td>

                <td>
                    {% if item.probability < 25 %}
                        <span style="color:green;">●</span>
                    {% elif item.probability >= 25 and item.probability < 50 %}
                        <span style="color:yellow;">●</span>
                    {% elif item.probability >= 50 and item.probability < 75 %}
                        <span style="color:orange;">●</span>
                    {% elif item.probability >= 75 %}
                        <span style="color:red;">●</span>
                    {% endif %}
                    {{ item.probability }}%
                </td>


            </tr>
            {% endfor %}
        </tbody>
    </table>


</div>
<div class="col-md-1 " style="background-color: black"></div>
</div>

<div class="row">
    <div class="col-md-1 " style="background-color: black"></div>
    <div class="col-md-5 ">
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-3">
                <br><br>
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row">
                            <h5 class="card-title text-center text-black card-title-light">Est. Costs (Best Case)</h5>
                        </div>
                        <div class="row">
                            <h3 class="card-text text-center text-black">${{ sle_low_sum|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <br><br>
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row">
                            <h5 class="card-title text-center text-black card-title-light">Est. Costs (Likely Case)</h5>
                        </div>
                        <div class="row">
                            <h3 class="card-text text-center text-black">${{ sle_sum|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <br><br>
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row">
                            <h5 class="card-title text-center text-black card-title-light">Est. Costs (Worst Case)</h5>
                        </div>
                        <div class="row">
                            <h3 class="card-text text-center text-black">${{ sle_high_sum|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2"></div>
        </div>
    </div>
    <div class="col-md-5 ">
        <div id="heatmapContainer" style="width: 100%; height: 400px;"></div>
    </div>
    <div class="col-md-1 " style="background-color: black"></div>
</div>
<script>
    anychart.onDocumentReady(function() {
        // create data
        var data = [];

        {% for item in heatmap_data %}
            data.push({
                x: "{{ item.probability }}",
                y: "{{ item.likelihood }}",
                heat: {{ item.count }},
                fill: getHeatmapColor("{{ item.likelihood }}", "{{ item.probability }}")
            });
        {% endfor %}

        function getHeatmapColor(likelihood, probability) {
            // Define your color logic here based on likelihood and probability
            if (likelihood === "Low" && probability === "Low") return "#00FF00"; // green
    if (likelihood === "Low" && probability === "Low/Medium") return "#66FF66"; // lighter green
    if (likelihood === "Low" && probability === "Medium") return "#CCFF66"; // yellow-green
    if (likelihood === "Low" && probability === "Medium/High") return "#FFFF66"; // yellow
    if (likelihood === "Low" && probability === "High") return "#FFCC66"; // orange-yellow

    if (likelihood === "Low/Medium" && probability === "Low") return "#66FF66"; // lighter green
    if (likelihood === "Low/Medium" && probability === "Low/Medium") return "#CCFF66"; // yellow-green
    if (likelihood === "Low/Medium" && probability === "Medium") return "#FFFF66"; // yellow
    if (likelihood === "Low/Medium" && probability === "Medium/High") return "#FFCC66"; // orange-yellow
    if (likelihood === "Low/Medium" && probability === "High") return "#FF9966"; // orange

    if (likelihood === "Medium" && probability === "Low") return "#CCFF66"; // yellow-green
    if (likelihood === "Medium" && probability === "Low/Medium") return "#FFFF66"; // yellow
    if (likelihood === "Medium" && probability === "Medium") return "#FFCC66"; // orange-yellow
    if (likelihood === "Medium" && probability === "Medium/High") return "#FF9966"; // orange
    if (likelihood === "Medium" && probability === "High") return "#FF6633"; // dark orange

    if (likelihood === "Medium/High" && probability === "Low") return "#FFFF66"; // yellow
    if (likelihood === "Medium/High" && probability === "Low/Medium") return "#FFCC66"; // orange-yellow
    if (likelihood === "Medium/High" && probability === "Medium") return "#FF9966"; // orange
    if (likelihood === "Medium/High" && probability === "Medium/High") return "#FF6633"; // dark orange
    if (likelihood === "Medium/High" && probability === "High") return "#FF3333"; // red-orange

    if (likelihood === "High" && probability === "Low") return "#FFCC66"; // orange-yellow
    if (likelihood === "High" && probability === "Low/Medium") return "#FF9966"; // orange
    if (likelihood === "High" && probability === "Medium") return "#FF6633"; // dark orange
    if (likelihood === "High" && probability === "Medium/High") return "#FF3333"; // red-orange
    if (likelihood === "High" && probability === "High") return "#FF0000"; // red
            return "#FFFF00"; // default to yellow
        }

        // create a chart
        var chart = anychart.heatMap(data);

        // set the chart title
        chart.title("Risk Heatmap");
        // set the x-axis title
        chart.xAxis().title("Probability");
        // set the y-axis title
        chart.yAxis().title("Residual Risk");
        // set the container id
        chart.container("heatmapContainer");

        // initiate drawing the chart
        chart.draw();
    });
</script>

