{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">
    <!-- Load jQuery (only one version) -->
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>iOTa</title>
    <link rel="icon" href="{% static 'images/iota - white 1.png' %}" type="image/x-icon">
    <!-- Load jQuery (only one version) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap and related scripts -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- SweetAlert -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<!-- AnyChart -->
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<link href="https://cdn.anychart.com/releases/8.10.0/css/anychart-ui.min.css" rel="stylesheet" type="text/css">
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-exports.min.js"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-bullet.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-cartesian.min.js"></script>




    <script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
    {% load django_bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}

    <title>Assess CyberPHA</title>
    <style>
    .small-font {
        font-size: 0.8rem; /* adjust as needed */
   }


    .form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}
.navbar {
    background-color: #464748;
    border-bottom: 1px solid #000;
    height: 50px; /* Fixed height */
    position: relative;
}

.owl-logo {
    height: 60px; /* Set a fixed height for the image */
    width: auto; /* Maintain aspect ratio */
    position: relative;
    top: 50%; /* Center vertically in the navbar */
    transform: translateY(-30%); /* Adjust vertical position */
    margin-bottom: -20px; /* Negative margin to overlap */
}

.navbar-brand, .nav-link {
    color: #d3d1cd !important; /* White text for clear visibility on initial view */
}

.menu-item {
    border-right: 1px solid #4B6B6B; /* Subtle line between items */
    font-size: 14px; /* Adjust font size */
}

.menu-item:last-child {
    border-right: none; /* Remove border for the last item */
}

.menu-item:hover, .dropdown-item:hover {
    background-color: #3A5F5F; /* Slightly lighter grey on hover */
    color: #E0E0E0; /* Light grey text on hover */
}

.nav-link:hover, .dropdown-item {
    color: #E0E0E0; /* Light grey text on hover */
}

.dropdown-menu {
    background-color: #464748; /* Dark Slate Grey */
    border: none;
}

.dropdown-item {
    color: #FFFFFF; /* White text for clear visibility */
}

.dropdown-item:hover {
    background-color: #3A5F5F; /* Slightly lighter grey on hover */
    color: #E0E0E0;
}
        .table-wrap {
          height: 200px;
          overflow-y: auto;
        }

        .small-font {
        font-size: 0.8rem; /* adjust as needed */
        }

    .clickable-label:hover {
        cursor: pointer;
    }

    .table tbody tr:hover {
    cursor: pointer;
    }



    .heatmap {
        border-collapse: collapse;
    }
    .heatmap td {
        width: 60px;
        height: 60px;
        text-align: center;
        border: 1px solid #ccc;
    }
    .Low { background-color: #d8e6d6; }
    .Low-Medium { background-color: #f7e5a0; }
    .Medium { background-color: #f9d56e; }
    .Medium-High { background-color: #f9a56e; }
    .High { background-color: #f95d6a; }

    .body {
        font-size: 10px;
    }
</style>


</head>
<body style="background-color: #464748">
<script>anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");</script>

<nav class="navbar navbar-expand-lg navbar-scroll shadow-0 border-bottom rounded">
    <div class="container-fluid d-flex justify-content-between">
        <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}">
            &nbsp; &nbsp; &nbsp; &nbsp;
            <img src="{% static 'images/anzen_owl.png' %}" class="owl-logo" style="width: 18%; height: 18%">
        </a>
        <h6 class="my-auto text-center flex-grow-1 navbar-brand"><img src="{% static 'images/anzen_noowl.png' %}" style="width: 15%; height: 15%"> Risk Register</h6>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-calculator"></i> QRAW</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}"><i class="bi bi-journal-text"></i> CyberPHA</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:scenario_sim' %}"><i class="bi bi-bricks"></i> Scenario Builder</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:ra_actions_view_default' %}"><i class="bi-file-earmark-easel"></i> Actions</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:risk_register' %}"><i class="bi-file-earmark-easel"></i> Risk Register</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:list_frameworks' %}"><i class="bi-file-earmark-easel"></i> Assessments</a>
                </li>
    <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">

                    <li><a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:setup_org' %}">Set Defaults</a></li>
                  <li><a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:admin_users' %}">Admin Users</a></li>
              <li><a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:upload_questionnaire' %}">Upload Questionnaires</a></li>
                  {% if user.is_staff %}
                    <!-- Links visible only to superusers -->
                    <li><a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:user_admin' %}">User Administration</a></li>
                      <li><a class="dropdown-item"  style="font-size: 12px;" href="{% url 'OTRisk:organization_form' %}">Manage Organizations</a></li>

                      <li><a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a></li>
                    {% endif %}

              </ul>

        </li>
    <li class="nav-item menu-item">
    <a class="nav-link" href="{% url 'accounts:profile' %}">
    <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
    </a>
    </li>
    <li class="nav-item menu-item">
    <a class="nav-link" href="{% url 'logout' %}">
    <i class="bi bi-box-arrow-right"></i> Logout
    </a>
    </li>
    </ul>
    </div>
    </div>
    </nav>

<div class="row">
<div class="col-md-1 "></div>
<div class="col-md-6 ">
    <br>
    <div class="form-group">
    <table class="table table-bordered table-striped compact" id="tbl_risk_register" style="font-size: 10px">
        <thead>
            <tr>
                <th>Facility Name</th>
                <th>Assessment Unit</th>
                <th>Risk Scenario</th>
                <th>Residual Risk</th>
                <th>BIA</th>
                <th>Est Costs (Low/Medium/High)</th>
                <th>Probability</th>
                <th>Snapshots</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr data-id="{{ item.ID }}">

                <td><a href="{% url 'OTRisk:iotaphamanager_with_id' item.CyberPHA__ID %}">{{ item.CyberPHA__FacilityName }}</a>
</td>
                <td>{{ item.CyberPHA__AssessmentUnit }}</td>
                <td>{{ item.Scenario }}</td>
                <td>
                    {% if item.RRa == "Low" %}
                        <span style="color:green;">●</span>
                    {% elif item.RRa == "Low/Medium" %}
                        <span style="color:olive;">●</span>
                    {% elif item.RRa == "Medium" %}
                        <span style="color:yellow;">●</span>
                    {% elif  item.RRa == "Medium/High" %}
                        <span style="color:orange;">●</span>
                    {% elif item.RRa == "High" %}
                        <span style="color:red;">●</span>
                    {% endif %}
                    {{ item.RRa }}
                </td>
                <td>{{ item.business_impact_analysis_score }}({{ item.business_impact_analysis_code }})</td>
                <td>${{ item.sle_low|intcomma }}/${{ item.sle|intcomma }}/${{ item.sle_high|intcomma }}</td>


                <td>
                    {% if item.probability < 25 %}
                        <span style="color:green;">●</span>
                    {% elif item.probability >= 25 and item.probability < 50 %}
                        <span style="color:yellow;">●</span>
                    {% elif item.probability >= 50 and item.probability < 75 %}
                        <span style="color:orange;">●</span>
                    {% elif item.probability >= 75 %}
                        <span style="color:red;">●</span>
                    {% endif %}
                    {{ item.probability }}%
                </td>
                <td>
                    {% if item.snapshots == 1 %}
                        <a href="{% url 'OTRisk:view_snapshots' item.ID %}">View Snapshots</a>
                    {% endif %}
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <script>
 $(document).ready(function() {
    $("table tbody tr").click(function() {
        var scenarioId = $(this).data("id");
        loadScenarioDetails(scenarioId);
    });
    $("table tbody tr:first").trigger('click');
});


$(document).ready(function() {
    $(document).on('click', '#saveRiskData', function() {
        var formData = $("#riskForm").serialize();
        $.post("{% url 'OTRisk:save_risk_data' %}", formData, function(response) {
            if(response.status == 'success') {
                alert("Data saved successfully!");
            } else {
                alert("Error saving data!");
            }
        });
    });
});



    </script>

</div> <!-- risk register table -->
<div class="col-md-5 " >
    <div class="row" style="height: 20px"></div>

        <div class="row align-items-center">
            <br>
            <div class="col-md-12 d-flex justify-content-center align-items-end">

                <!-- <div id="bia_container" style="width: 75%; height: 320px; border: solid #7d929e 1px"></div> -->
                <div id="heatmapContainer" style="width: 75%; height: 320px; border: solid  #7d929e 1px"></div>
            </div>
            <script>
            document.getElementById('bia_container').innerHTML = '';
            anychart.onDocumentReady(function() {
            // Extract data for the line chart
            var biaData = [
            {% for item in bia_data_with_id %}
            {x: "{{ item.x }}", value: {{ item.value }}, id: {{ item.id }}},
            {% endfor %}
            ];

            // Create the line chart
            var chart = anychart.cartesian();

            // Add data to the chart
            var series = chart.marker(biaData); // Store the series in a variable

            series.listen("pointClick", function(e) {
            var pointId = e.iterator.get("id");
            loadScenarioDetails(pointId); // Call the function you defined earlier
            });

            chart.yScale().minimum(0);
            chart.yScale().maximum(100);
            // Set chart title and labels
            chart.title("BIA Scores");
            chart.xAxis().title("Assessments");
            chart.yAxis().title("BIA Score");

            // Set the container id for the chart
            chart.container("bia_container");
            var credits = chart.credits();
            credits.enabled(false);
            // Draw the chart
            chart.draw();
            });
            </script>
        </div>   <!-- BIA Score marker chart -->
        <br>
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <div class="form-group">
                    <div class="row">
                    <div class="col-md-4">
                        <br><br>
                        <div class="card shadow-lg inner-card">
                            <div class="card-body">
                                <div class="row justify-content-center align-items-center" style="font-size: 12px">
                                    Est. Costs (Best Case)
                                </div>
                                <div class="row">
                                    <h6 class="card-text text-center">${{ sle_low_sum|intcomma }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <br><br>
                        <div class="card shadow-lg inner-card">
                            <div class="card-body">
                                <div class="row justify-content-center align-items-center" style="font-size: 12px">
                                    Est. Costs (Likely Case)
                                </div>
                                <div class="row">
                                    <h6 class="card-text text-center">${{ sle_sum|intcomma }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
            <br><br>
            <div class="card shadow-lg inner-card">
                <div class="card-body">
                    <div class="row justify-content-center align-items-center" style="font-size: 12px">
                       Est. Costs (Worst Case)
                    </div>
                    <div class="row">
                        <h6 class="card-text text-center">${{ sle_high_sum|intcomma }}</h6>
                    </div>
                </div>
            </div>
        </div>
                        </div>
                </div>
            </div>
            <div class="col-md-2"></div>
        </div> <!-- cost boxes -->

    <div class="row" style="height: 10px"></div>
</div>

<div class="row">
<div class="col-md-1 " ></div>
<div class="col-md-10 ">
<div class="card" style="display: none;" id="scenarioDetailsCard">
<div class="card-header">
Scenario Details
</div>
<div class="card-body" id="scenarioDetails">


<strong>ID:</strong> <span id="detail_ID"></span> <strong>CyberPHA:</strong> <span id="detail_CyberPHA"></span>



<div class="row">
    <div class="col-md-4">
        <div class="card shadow-lg inner-card">
            <div class="card-body">
                <div class="row">
                    <h6 class="card-title text-left card-title-light">Scenario:</h6>
                </div>
                <div class="row" style="font-size: 12px">
                    <span id="scenario_description"></span>
                </div>
            </div>
        </div>
        <br>
        <div class="card shadow-lg inner-card">
            <div class="card-body">
                <div class="row">
                    <h6 class="card-title text-left card-title-light">Consequences:</h6>
                </div>
                <div class="row" style="font-size: 12px">
                    <span id="consequence_description"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="row">
            <div class="col-md-3" style="height:100%">
                <div class="card shadow-lg inner-card" style="height:100%;">
                    <div class="card-body">
                        <div class="row justify-content-center align-items-center" style="font-size: 12px">
                            Attack Success Probability
                        </div>
                        <div class="row justify-content-center align-items-center" style="font-size: 16px">
                            <div id="gaugeProbContainer"></div>
                            <br>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row justify-content-center align-items-center" style="font-size: 12px">
                            Control Effectiveness
                        </div>
                        <div class="row justify-content-center align-items-center" style="font-size: 16px">
                            <div id="gaugeEffectivenessContainer"></div>
                            <br>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row justify-content-center align-items-center" style="font-size: 12px">
                            Scenario Likelihood
                        </div>
                    <div class="row justify-content-center align-items-center" style="font-size: 16px">
                        <div id="gaugeLikelihoodContainer"></div>
                        <br>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-lg inner-card">
                <div class="card-body">
                    <div class="row justify-content-center align-items-center" style="font-size: 12px">
                        Residual Risk
                    </div>
                    <div class="row justify-content-center align-items-center" style="font-size: 16px">
                        <div id="gaugeResidualRisk"></div>
                        <br>
                    </div>
                </div>
            </div>
        </div>

</div>
<div class="row" style="height: 70%">

</div>

</div>

</div>
<br>
<div class="row">
<div class="col-md-4" style="border: 1px solid darkgrey;">
<!-- user controls -->
<form id="riskForm">
{% csrf_token %}
<br>
<input type="hidden" id="scenario_id" name="scenario_id" value="${data.ID}">
<label for="risk_owner" class="form-control" style="border: none;">Risk Owner:</label>

<input type="text" class="form-control" id="risk_owner" name="risk_owner" required>
<br>
<label for="risk_priority" class="form-control" style="border: none;">Risk Priority:</label>
<select id="risk_priority" name="risk_priority" class="form-control">
<option value="Low">Low</option>
<option value="Medium">Medium</option>
<option value="High">High</option>
<option value="Critical">Critical</option>
</select>
<br>
<label for="risk_response" class="form-control" style="border: none;">Risk Response:</label>
<select id="risk_response" name="risk_response" class="form-control">
<option value="Manage">Manage</option>
<option value="Mitigate">Mitigate</option>
<option value="Transfer">Transfer</option>
<option value="Accept">Accept</option>
</select>
<br>
<label for="risk_status" class="form-control" style="border: none;">Risk Status:</label>
<select id="risk_status" name="risk_status" class="form-control">
<option value="Open">Open</option>
<option value="Closed">Closed</option>
</select>
<br>
<label for="risk_open_date" class="form-control" style="border: none;">Risk Open Date:</label>
<input type="date" class="form-control" id="risk_open_date" name="risk_open_date" required>
<br>
<label for="risk_close_date" class="form-control" style="border: none;">Risk Close Date:</label>
<input type="date" class="form-control" id="risk_close_date" name="risk_close_date" required>
<br>
<button type="button"  class="btn btn-primary"  id="saveRiskData">Save</button>
</form>
</div>
<div class="col-md-8">

<div class="row" style="height:50%">

<div class="col-md-6" id="impactChartContainer"></div>

<div class="col-md-6" id="bulletChartContainer"></div>
</div>
</div>
</div>

</div>
</div>
</div>
<div class="col-md-1 "></div>
</div>





<!-- end of header detail -->

<div class="row">
    <div class="col-md-1 "></div>
    <div class="col-md-10 " style="background-color: white">
        <div class="card" style="display: none;" id="scenarioDetailsCard">
          <div class="card-header">
            Scenario Details
          </div>
          <div class="card-body" id="scenarioDetails">
            <!-- Details will be populated here -->
          </div>
        </div>
    </div>
    <div class="col-md-1 " style="background-color: white"></div>
</div>
<script>

    anychart.onDocumentReady(function() {
        // create data
        var data = [];

        {% for item in heatmap_data %}
            data.push({
                x: "{{ item.probability }}",
                y: "{{ item.likelihood }}",
                heat: {{ item.count }},
                fill: getHeatmapColor("{{ item.likelihood }}", "{{ item.probability }}")
            });
        {% endfor %}

        function getHeatmapColor(likelihood, probability) {
            // Define your color logic here based on likelihood and probability
            if (likelihood === "Low" && probability === "Low") return "#00FF00"; // green
    if (likelihood === "Low" && probability === "Low/Medium") return "#66FF66"; // lighter green
    if (likelihood === "Low" && probability === "Medium") return "#CCFF66"; // yellow-green
    if (likelihood === "Low" && probability === "Medium/High") return "#FFFF66"; // yellow
    if (likelihood === "Low" && probability === "High") return "#FFCC66"; // orange-yellow

    if (likelihood === "Low/Medium" && probability === "Low") return "#66FF66"; // lighter green
    if (likelihood === "Low/Medium" && probability === "Low/Medium") return "#CCFF66"; // yellow-green
    if (likelihood === "Low/Medium" && probability === "Medium") return "#FFFF66"; // yellow
    if (likelihood === "Low/Medium" && probability === "Medium/High") return "#FFCC66"; // orange-yellow
    if (likelihood === "Low/Medium" && probability === "High") return "#FF9966"; // orange

    if (likelihood === "Medium" && probability === "Low") return "#CCFF66"; // yellow-green
    if (likelihood === "Medium" && probability === "Low/Medium") return "#FFFF66"; // yellow
    if (likelihood === "Medium" && probability === "Medium") return "#FFCC66"; // orange-yellow
    if (likelihood === "Medium" && probability === "Medium/High") return "#FF9966"; // orange
    if (likelihood === "Medium" && probability === "High") return "#FF6633"; // dark orange

    if (likelihood === "Medium/High" && probability === "Low") return "#FFFF66"; // yellow
    if (likelihood === "Medium/High" && probability === "Low/Medium") return "#FFCC66"; // orange-yellow
    if (likelihood === "Medium/High" && probability === "Medium") return "#FF9966"; // orange
    if (likelihood === "Medium/High" && probability === "Medium/High") return "#FF6633"; // dark orange
    if (likelihood === "Medium/High" && probability === "High") return "#FF3333"; // red-orange

    if (likelihood === "High" && probability === "Low") return "#FFCC66"; // orange-yellow
    if (likelihood === "High" && probability === "Low/Medium") return "#FF9966"; // orange
    if (likelihood === "High" && probability === "Medium") return "#FF6633"; // dark orange
    if (likelihood === "High" && probability === "Medium/High") return "#FF3333"; // red-orange
    if (likelihood === "High" && probability === "High") return "#FF0000"; // red
            return "#FFFF00"; // default to yellow
        }

        // create a chart
        var chart = anychart.heatMap(data);

        // set the chart title
        chart.title("Risk Heatmap");
        chart.title(false);

        // set the x-axis title
        chart.xAxis().title("Probability");
        // set the y-axis title
        chart.yAxis().title("Residual Risk");
        // set the container id
        chart.container("heatmapContainer");
        var credits = chart.credits();
            credits.enabled(false);
        // initiate drawing the chart
        chart.draw();
    });

    $(document).ready(function() {
    // Initialize DataTable with options
    $('#tbl_risk_register').DataTable({
        "paging": true, // Enable pagination
        "pageLength": 8, // Set the number of rows per page
        "searching": false, // Enable searching
        "lengthChange": false,
        "order": [] // Disable initial sorting if needed
    });
});

function loadScenarioDetails(scenarioId) {
    $.get("{% url 'OTRisk:getSingleScenario' %}", { id: scenarioId }, function(data) {
        // Populate placeholders with data
        $('#detail_ID').text(data.ID);
        $('#detail_CyberPHA').text(data.CyberPHA);
        $('#scenario_description').text(data.Scenario);
        $('#consequence_description').text(data.Consequence);

        $('#scenario_probability').text(data.probability);
        $('#scenario_sis_outage').text(data.sis_outage);
        $('#scenario_sis_compromise').text(data.sis_compromise);
        $('#scenario_ThreatClass').text(data.ThreatClass);
        $('#scenario_standards').text(data.standards);

        $("#scenarioDetailsCard").show(); // Show the card

        clearContainer('bulletChartContainer');
        clearContainer('impactChartContainer');
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeEffectivenessContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');

        createProbGauge(data.probability);
        createEffectivenessGauge(data.control_effectiveness);
        createLikelihoodGauge(data.likelihood);
        createResidualRiskGauge(data.RRa);

                var rangeData = [
            {x: "Best Case", low: 0, high: data.sle_low},
            {x: "Median Case", low: 0, high: data.sle},
            {x: "Worst Case", low: 0, high: data.sle_high}
        ];

        $("#scenarioDetailsCard").show(); // Show the card

        var riskPriorityValue = data.risk_priority;
        var riskOwner = data.risk_owner;
        var riskResponse = data.risk_response;
        var riskStatus = data.risk_status;
        var riskOpenDate = data.risk_open_date;
        var riskCloseDate = data.risk_close_date;

        // Set the dropdown to the correct value
        $("#risk_priority").val(riskPriorityValue);
        $("#risk_owner").val(riskOwner);
        $("#risk_response").val(riskResponse);
        $("#risk_status").val(riskStatus);
        $("#risk_open_date").val(riskOpenDate);
        $("#risk_close_date").val(riskCloseDate);

        anychart.theme('darkBlue');

        var rangechart = anychart.area();
        var credits = rangechart.credits();
            credits.enabled(false);
        var series = rangechart.rangeStepArea(rangeData);
        var yAxis = rangechart.yAxis();

        yAxis.labels().format('${%Value}');
        rangechart.container("bulletChartContainer");
        rangechart.draw();

        var chartData = [
            {x: "Safety", value: data.impactSafety},
            {x: "Danger", value: data.impactDanger},
            {x: "Production", value: data.impactProduction},
            {x: "Finance", value: data.impactFinance},
            {x: "Reputation", value: data.impactReputation},
            {x: "Environment", value: data.impactEnvironment},
            {x: "Regulation", value: data.impactRegulation},
            {x: "Data", value: data.impactData},
            {x: "Supply", value: data.impactSupply}
        ];

        var chart = anychart.column();
        chart.data(chartData);
        chart.title("Impact Analysis");
        var credits = chart.credits();
            credits.enabled(false);
        var yAxisScale = anychart.scales.linear();
        yAxisScale.minimum(0);
        yAxisScale.maximum(10);
        var yAxis_ = chart.yAxis();
        yAxis_.scale(yAxisScale);
        var xAxis = chart.xAxis();
        xAxis.labels().rotation(45);
        chart.container("impactChartContainer");
        chart.draw();
    });
}

function clearContainer(containerId) {
    var container = document.getElementById(containerId);

    // Check if the container is null before proceeding
    if (container === null) {
        return;
    }

    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
}

function createProbGauge(score) {

    // Remove the '%' character from the score string
    var scoreStripped = score.replace('%', '');

    // Convert the stripped string to an integer
    var scoreInt = parseInt(scoreStripped, 10);

    // Now you can use scoreInt in your function
    var dataSet = anychart.data.set([scoreInt]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeProbContainer').draw();
}

function createEffectivenessGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["red", "orange", "yellow", "green"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeEffectivenessContainer').draw();
}

function createLikelihoodGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeLikelihoodContainer').draw();
}

function createResidualRiskGauge(rating) {
    // Translate the rating to a numerical value
    var score;
    switch (rating) {
        case "Low":
            score = 10;
            break;
        case "Low/Medium":
            score = 33;
            break;
        case "Medium":
            score = 50;
            break;
        case "Medium/High":
            score = 66;
            break;
        case "High":
            score = 90;
            break;
        default:
            console.error("Invalid rating value");
            return;
    }



    var data = [score];
    // set the gauge type
   var gauge = anychart.gauges.linear();
   gauge.layout('horizontal'); // Set the layout to horizontal
        var credits = gauge.credits();
    credits.enabled(false);
   // set the data for the gauge
   gauge.data(data);

   var scaleBarColorScale = anychart.scales.ordinalColor().ranges(
  [
    {
      from: 0,
      to: 25,

        color: ['#CAD70b', '#2AD62A']
    },
    {
      from: 25,
      to: 50,

        color: ['#FFD700', '#CAD70b']
    },
    {
      from: 50,
      to: 75,
      color: ['#EB7A02', '#FFD700']
    },
    {
      from: 75,
      to: 100,
       color: ['#D81E05', '#EB7A02']
    }
  ]
);
var scaleBar = gauge.scaleBar(0);

   // set the height and offset of the Scale Bar (both as percentages of the gauge height)
   scaleBar.width('15%');
   scaleBar.offset('31.5%');

   // use the color scale (defined earlier) as the color scale of the Scale Bar
   scaleBar.colorScale(scaleBarColorScale);

   // add a marker pointer
   var marker = gauge.marker(0);
    marker.width(15);
   // set the offset of the pointer as a percentage of the gauge width
   marker.offset('43%');

   // set the marker type
   marker.type('triangle-up');
   // set the color of the marker to black
   marker.color('black');
    // set the zIndex of the marker
   marker.zIndex(10);

   // configure the scale
   var scale = gauge.scale();
   scale.minimum(0);
   scale.maximum(100);
   scale.ticks().interval(10);

    var axis = gauge.axis();
    axis.minorTicks(true)
    axis.minorTicks().stroke('#cecece');
    axis.width('1%');
    axis.offset('29.5%');
    axis.orientation('top');

    // format axis labels
    axis.labels().format(function() {
        if (this.value == 0) return "Low";
        else if (this.value == 50) return "Medium";
        else if (this.value == 100) return "High";
        else return "";  // This will hide other labels
    });
    gauge.width('100%');


    gauge.layout();
   // set paddings
   gauge.padding([0, 50]);


    // Draw the chart
    gauge.container('gaugeResidualRisk').draw();
}
</script>

</div>
</body>
</html>