{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Load jQuery (only one version) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap and related scripts -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- SweetAlert -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<!-- AnyChart -->
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<link href="https://cdn.anychart.com/releases/8.10.0/css/anychart-ui.min.css" rel="stylesheet" type="text/css">
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-exports.min.js"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-bullet.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-base.min.js"></script>




    <script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
    {% load django_bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}

    <title>Assess CyberPHA</title>
    <style>
    .small-font {
        font-size: 0.8rem; /* adjust as needed */
   }

    .navbar-scroll .nav-link,
    .navbar-scroll .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #ffffff;
    }

    /* Color of the navbar BEFORE scroll */
    .navbar-scroll {
      background-color: #000000;
        text-decoration-color: #FFFFFF;
    }


    /* Color of the links AFTER scroll */
    .navbar-scrolled .nav-link,
    .navbar-scrolled .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #262626;
    }

    .navbar-logo {
    position: absolute;
    top: 5px; /* Adjust this as needed */
    left: 5; /* Adjust this as needed */
    height: 100px; /* Adjust this as needed */
    z-index: 10;
}
        .table-wrap {
          height: 200px;
          overflow-y: auto;
        }

        .small-font {
        font-size: 0.8rem; /* adjust as needed */
        }

    .clickable-label:hover {
        cursor: pointer;
    }

    .table tbody tr:hover {
    cursor: pointer;
    }



    .heatmap {
        border-collapse: collapse;
    }
    .heatmap td {
        width: 60px;
        height: 60px;
        text-align: center;
        border: 1px solid #ccc;
    }
    .Low { background-color: #d8e6d6; }
    .Low-Medium { background-color: #f7e5a0; }
    .Medium { background-color: #f9d56e; }
    .Medium-High { background-color: #f9a56e; }
    .High { background-color: #f95d6a; }
</style>


</head>
<body>

<nav class="navbar navbar-expand-lg navbar-scroll fixed-top shadow-0 border-bottom border-dark rounded">
  <div class="container-fluid d-flex justify-content-between">
   <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}"><img src="{% static 'images/logo1-2.jpg' %}" style="height: 140px; width: 140px" class="navbar-logo" alt="">   </a>
      <h4 class="my-auto text-center flex-grow-1"><font color="white">OT Cybersecurity Risk Register</font></h4>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}"><i class="bi bi-journal-text"></i> CyberPHA</a>
        </li>
          <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:ra_actions_view' %}" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Actions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:risk_register' %}" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Risk Register</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-file-earmark-easel"></i> Reports
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports' %}" >QRAW Reports</a></li>
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports_pha' %}">CyberPHA Reports</a></li>
              </ul>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_scenario' %}">Scenario Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_consequence' %}">Consequence Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:admin_users' %}">Admin Users</a></li>
                  {% if user.is_staff %}
                    <!-- Links visible only to superusers -->
                    <li><a class="dropdown-item" href="{% url 'OTRisk:user_admin' %}">User Administration</a></li>
                      <li><a class="dropdown-item" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a></li>
                    {% endif %}

              </ul>

        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:profile' %}">
                <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
            </a>
        </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </li>
      </ul>
    </div>
  </div>

</nav>
<div class="row">
<div class="col-md-1 " style="background-color: black"></div>
<div class="col-md-10 ">
    <br><br><br>
    <h2>Risk Register</h2>
    <table class="table table-bordered table-striped" id="tbl_risk_register">
        <thead>
            <tr>
                <th>Facility Name</th>
                <th>Assessment Unit</th>
                <th>Risk Scenario</th>
                <th>Residual Risk</th>
                <th>BIA</th>
                <th>Est Costs (Low/Medium/High)</th>
                <th>Assessment Start</th>
                <th>Assessment End</th>
                <th>Probability</th>
                <th>Snapshots</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr data-id="{{ item.ID }}">

                <td>{{ item.CyberPHA__FacilityName }}</td>
                <td>{{ item.CyberPHA__AssessmentUnit }}</td>
                <td>{{ item.Scenario }}</td>
                <td>
                    {% if item.RRa == "Low" %}
                        <span style="color:green;">●</span>
                    {% elif item.RRa == "Low/Medium" %}
                        <span style="color:olive;">●</span>
                    {% elif item.RRa == "Medium" %}
                        <span style="color:yellow;">●</span>
                    {% elif  item.RRa == "Medium/High" %}
                        <span style="color:orange;">●</span>
                    {% elif item.RRa == "High" %}
                        <span style="color:red;">●</span>
                    {% endif %}
                    {{ item.RRa }}
                </td>
                <td>{{ item.business_impact_analysis_score }}({{ item.business_impact_analysis_code }})</td>
                <td>${{ item.sle_low|intcomma }}/${{ item.sle|intcomma }}/${{ item.sle_high|intcomma }}</td>

                <td>{{ item.CyberPHA__AssessmentStartDate|date:"d M Y" }}</td>
                <td>{{ item.CyberPHA__AssessmentEndDate|date:"d M Y" }}</td>

                <td>
                    {% if item.probability < 25 %}
                        <span style="color:green;">●</span>
                    {% elif item.probability >= 25 and item.probability < 50 %}
                        <span style="color:yellow;">●</span>
                    {% elif item.probability >= 50 and item.probability < 75 %}
                        <span style="color:orange;">●</span>
                    {% elif item.probability >= 75 %}
                        <span style="color:red;">●</span>
                    {% endif %}
                    {{ item.probability }}%
                </td>
                <td>
                    {% if item.snapshots == 1 %}
                        <a href="{% url 'OTRisk:view_snapshots' item.ID %}">View Snapshots</a>
                    {% endif %}
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
    $(document).ready(function() {

        $("table tbody tr").click(function() {
            var scenarioId = $(this).data("id");

            $.get("{% url 'OTRisk:getSingleScenario' %}", { id: scenarioId }, function(data) {

                 var detailsHtml = `

            <p><strong>ID:</strong> ${data.ID}      <strong>CyberPHA:</strong> ${data.CyberPHA}</p>
            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow-lg inner-card">
                        <div class="card-body">
                            <div class="row">
                                <h5 class="card-title text-center text-black card-title-light">Scenario</h5>
                            </div>
                            <div class="row">
                                <p>${data.Scenario}</p>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="card shadow-lg inner-card">
                        <div class="card-body">
                            <div class="row">
                                <h5 class="card-title text-center text-black card-title-light">Consequences</h5>
                            </div>
                            <div class="row">
                                <p>${data.Consequence}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8" id="impactChartContainer"></div>
            </div>
            <br>
            <div class="row">
                <div class="col-md-4" style="border: 1px solid darkgrey;">
                    <!-- user controls -->
                    <form id="riskForm">
                        {% csrf_token %}
                        <br>
                        <input type="hidden" id="scenario_id" name="scenario_id" value="${data.ID}">
                        <label for="risk_owner" class="form-control" style="border: none;">Risk Owner:</label>

                        <input type="text" class="form-control" id="risk_owner" name="risk_owner" required>
                        <br>
                        <label for="risk_priority"class="form-control" style="border: none;">Risk Priority:</label>
                        <select id="risk_priority" name="risk_priority" class="form-control">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                        <br>
                        <label for="risk_response" class="form-control" style="border: none;">Risk Response:</label>
                        <select id="risk_response" name="risk_response" class="form-control">
                            <option value="Manage">Manage</option>
                            <option value="Mitigate">Mitigate</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Accept">Accept</option>
                        </select>
                        <br>
                        <label for="risk_status" class="form-control" style="border: none;">Risk Status:</label>
                        <select id="risk_status" name="risk_status" class="form-control">
                            <option value="Open">Open</option>
                            <option value="Closed">Closed</option>
                        </select>
                        <br>
                        <label for="risk_open_date" class="form-control" style="border: none;">Risk Open Date:</label>
                        <input type="date" class="form-control" id="risk_open_date" name="risk_open_date" required>
                        <br>
                        <label for="risk_close_date" class="form-control" style="border: none;">Risk Close Date:</label>
                        <input type="date" class="form-control" id="risk_close_date" name="risk_close_date" required>
                        <br>
                        <button type="button"  class="btn btn-primary"  id="saveRiskData">Save</button>
                    </form>
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="card shadow-lg inner-card">
                                <div class="card-body">
                                    <div class="row">
                                        <h5 class="card-title text-center text-black card-title-light">Attack Success Probability</h5>
                                    </div>
                                    <div class="row">
                                        <p>${data.probability}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <div class="card shadow-lg inner-card">
                                <div class="card-body">
                                    <div class="row">
                                        <h5 class="card-title text-center text-black card-title-light">Production Outage</h5>
                                    </div>
                                    <div class="row">
                                        <p>${data.outage}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <div class="card shadow-lg inner-card">
                                <div class="card-body">
                                    <div class="row">
                                        <h5 class="card-title text-center text-black card-title-light">SIS Outage</h5>
                                    </div>
                                    <div class="row">
                                        <p>${data.sis_outage}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card shadow-lg inner-card">
                                <div class="card-body">
                                    <div class="row">
                                        <h5 class="card-title text-center text-black card-title-light">SIS Compromise</h5>
                                    </div>
                                    <div class="row">
                                        <p>${data.sis_compromise}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card shadow-lg inner-card">
                                <div class="card-body">
                                    <div class="row">
                                        <h5 class="card-title text-center text-black card-title-light">Risk Category</h5>
                                    </div>
                                    <div class="row">
                                        <p>${data.RiskCategory}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card shadow-lg inner-card">
                                <div class="card-body">
                                    <div class="row">
                                        <h5 class="card-title text-center text-black card-title-light">Standards</h5>
                                    </div>
                                    <div class="row">
                                        <p>${data.standards}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="height: 70%">
                        <div class="col-md-12" id="bulletChartContainer"></div>
                    </div>

                  </div>

            </div>
        `;


        $("#scenarioDetails").html(detailsHtml);
        $("#scenarioDetailsCard").show(); // Show the card
        var riskPriorityValue = data.risk_priority;
        var riskOwner = data.risk_owner;
        var riskResponse = data.risk_response;
        var riskStatus = data.risk_status;
        var riskOpenDate = data.risk_open_date;
        var riskCloseDate = data.risk_close_date;
        // Set the dropdown to the correct value
        $("#risk_priority").val(riskPriorityValue);
        $("#risk_owner").val(riskOwner);
        $("#risk_response").val(riskResponse);
        $("#risk_status").val(riskStatus);
        $("#risk_open_date").val(riskOpenDate);
        $("#risk_close_date").val(riskCloseDate);


        var rangeData = [
                {x: "Best Case", low: 0, high: data.sle_low},
                {x: "Median Case", low: 0, high: data.sle},
                {x: "Worst Case", low: 0, high: data.sle_high}
            ];

            anychart.theme('darkBlue');
            var rangechart = anychart.area();

            var series = rangechart.rangeStepArea(rangeData);
            // Format the y-axis to show values in US$
            var yAxis = rangechart.yAxis();
            yAxis.labels().format('${%Value}');
            // Set the container for the chart
            rangechart.container("bulletChartContainer");
            rangechart.draw();




 // Create the bar chart
            var chartData = [
                {x: "Safety", value: data.impactSafety},
                {x: "Danger", value: data.impactDanger},
                {x: "Production", value: data.impactProduction},
                {x: "Finance", value: data.impactFinance},
                {x: "Reputation", value: data.impactReputation},
                {x: "Environment", value: data.impactEnvironment},
                {x: "Regulation", value: data.impactRegulation},
                {x: "Data", value: data.impactData},
                {x: "Supply", value: data.impactSupply}
            ];

            var chart = anychart.column();
            chart.data(chartData);
            chart.title("Impact Analysis");
            // Set the y-axis scale to range from 0 to 10
            var yAxisScale = anychart.scales.linear();
            yAxisScale.minimum(0);
            yAxisScale.maximum(10);

            var yAxis = chart.yAxis();
            yAxis.scale(yAxisScale);
            chart.container("impactChartContainer");
            chart.draw();

        });

    });
});

$(document).ready(function() {
    $(document).on('click', '#saveRiskData', function() {
        var formData = $("#riskForm").serialize();
        $.post("{% url 'OTRisk:save_risk_data' %}", formData, function(response) {
            if(response.status == 'success') {
                alert("Data saved successfully!");
            } else {
                alert("Error saving data!");
            }
        });
    });
});



    </script>

</div>
<div class="col-md-1 " style="background-color: black"></div>
</div>

<div class="row">
    <div class="col-md-1 " style="background-color: black"></div>
    <div class="col-md-5 ">
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-3">
                <br><br>
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row">
                            <h5 class="card-title text-center text-black card-title-light">Est. Costs (Best Case)</h5>
                        </div>
                        <div class="row">
                            <h3 class="card-text text-center text-black">${{ sle_low_sum|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <br><br>
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row">
                            <h5 class="card-title text-center text-black card-title-light">Est. Costs (Likely Case)</h5>
                        </div>
                        <div class="row">
                            <h3 class="card-text text-center text-black">${{ sle_sum|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <br><br>
                <div class="card shadow-lg inner-card">
                    <div class="card-body">
                        <div class="row">
                            <h5 class="card-title text-center text-black card-title-light">Est. Costs (Worst Case)</h5>
                        </div>
                        <div class="row">
                            <h3 class="card-text text-center text-black">${{ sle_high_sum|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2"></div>
        </div>
    </div>
    <div class="col-md-5 ">
        <div id="heatmapContainer" style="width: 100%; height: 400px;"></div>
    </div>
    <div class="col-md-1 " style="background-color: black"></div>
</div>
<div class="row" style="height: 10px;">
    <div class="col-md-1 " style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: black"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div>
<div class="row">
    <div class="col-md-1 " style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: black">
        <div class="card" style="display: none;" id="scenarioDetailsCard">
          <div class="card-header">
            Scenario Details
          </div>
          <div class="card-body" id="scenarioDetails">
            <!-- Details will be populated here -->
          </div>
        </div>
    </div>
    <div class="col-md-1 " style="background-color: black"></div>
</div>
<script>

    anychart.onDocumentReady(function() {
        // create data
        var data = [];

        {% for item in heatmap_data %}
            data.push({
                x: "{{ item.probability }}",
                y: "{{ item.likelihood }}",
                heat: {{ item.count }},
                fill: getHeatmapColor("{{ item.likelihood }}", "{{ item.probability }}")
            });
        {% endfor %}

        function getHeatmapColor(likelihood, probability) {
            // Define your color logic here based on likelihood and probability
            if (likelihood === "Low" && probability === "Low") return "#00FF00"; // green
    if (likelihood === "Low" && probability === "Low/Medium") return "#66FF66"; // lighter green
    if (likelihood === "Low" && probability === "Medium") return "#CCFF66"; // yellow-green
    if (likelihood === "Low" && probability === "Medium/High") return "#FFFF66"; // yellow
    if (likelihood === "Low" && probability === "High") return "#FFCC66"; // orange-yellow

    if (likelihood === "Low/Medium" && probability === "Low") return "#66FF66"; // lighter green
    if (likelihood === "Low/Medium" && probability === "Low/Medium") return "#CCFF66"; // yellow-green
    if (likelihood === "Low/Medium" && probability === "Medium") return "#FFFF66"; // yellow
    if (likelihood === "Low/Medium" && probability === "Medium/High") return "#FFCC66"; // orange-yellow
    if (likelihood === "Low/Medium" && probability === "High") return "#FF9966"; // orange

    if (likelihood === "Medium" && probability === "Low") return "#CCFF66"; // yellow-green
    if (likelihood === "Medium" && probability === "Low/Medium") return "#FFFF66"; // yellow
    if (likelihood === "Medium" && probability === "Medium") return "#FFCC66"; // orange-yellow
    if (likelihood === "Medium" && probability === "Medium/High") return "#FF9966"; // orange
    if (likelihood === "Medium" && probability === "High") return "#FF6633"; // dark orange

    if (likelihood === "Medium/High" && probability === "Low") return "#FFFF66"; // yellow
    if (likelihood === "Medium/High" && probability === "Low/Medium") return "#FFCC66"; // orange-yellow
    if (likelihood === "Medium/High" && probability === "Medium") return "#FF9966"; // orange
    if (likelihood === "Medium/High" && probability === "Medium/High") return "#FF6633"; // dark orange
    if (likelihood === "Medium/High" && probability === "High") return "#FF3333"; // red-orange

    if (likelihood === "High" && probability === "Low") return "#FFCC66"; // orange-yellow
    if (likelihood === "High" && probability === "Low/Medium") return "#FF9966"; // orange
    if (likelihood === "High" && probability === "Medium") return "#FF6633"; // dark orange
    if (likelihood === "High" && probability === "Medium/High") return "#FF3333"; // red-orange
    if (likelihood === "High" && probability === "High") return "#FF0000"; // red
            return "#FFFF00"; // default to yellow
        }

        // create a chart
        var chart = anychart.heatMap(data);

        // set the chart title
        chart.title("Risk Heatmap");
        // set the x-axis title
        chart.xAxis().title("Probability");
        // set the y-axis title
        chart.yAxis().title("Residual Risk");
        // set the container id
        chart.container("heatmapContainer");

        // initiate drawing the chart
        chart.draw();
    });

    $(document).ready(function() {
    // Initialize DataTable with options
    $('#tbl_risk_register').DataTable({
        "paging": true, // Enable pagination
        "pageLength": 5, // Set the number of rows per page
        "searching": true, // Enable searching
        "order": [] // Disable initial sorting if needed
    });
});


</script>

