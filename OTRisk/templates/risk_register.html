{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">
    <!-- Load jQuery (only one version) -->
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">
    <!-- Load jQuery (only one version) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap and related scripts -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- AnyChart -->
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<link href="https://cdn.anychart.com/releases/8.10.0/css/anychart-ui.min.css" rel="stylesheet" type="text/css">
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-exports.min.js"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-bullet.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-cartesian.min.js"></script>
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>





    <script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
    {% load django_bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}

    <title>Assess CyberPHA</title>
    <style>
        #tbl_risk_register td:nth-child(4), /* Residual Risk */
#tbl_risk_register td:nth-child(7) { /* Probability */
    text-align: center; /* Center-align the content */
}

#tbl_risk_register td:first-child {
    background-color: #b2b5b6; /* Header background color */
    color: #020202; /* Header text color */
    font-weight: bold; /* Make header text bold */
    padding: 0.75rem; /* Larger padding for header */
    font-size: 1.2em;

}
#tbl_risk_register td:nth-child(3) { /* Adjust based on actual cell order */
    font-size: 1.1em; /* Larger font size for scenario text */
    font-weight: bold; /* Optional: make scenario text bold */
    color: #333; /* Scenario text color */
}


#tbl_risk_register {
    border-collapse: separate;
    border-spacing: 0.5rem; /* Adjust based on your spacing preference */
    background-color: transparent; /* Remove default table background */
}

#tbl_risk_register thead {
    display: none; /* Hide the table header */
}

#tbl_risk_register tbody tr {
    display: block;
    background-color: #f9f9f9; /* Card background color */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Card shadow */
    border-radius: 0.5rem; /* Card corner rounding */
    margin-bottom: 0.5rem; /* Space between cards */
    overflow: hidden; /* Ensures the border radius applies to child elements */
}

#tbl_risk_register td {
    display: block; /* Stack cells vertically */
    padding: 0.5rem; /* Cell padding */
    border-bottom: 1px solid #ececec; /* Line between cells */
}

#tbl_risk_register td:last-child {
    border-bottom: none; /* Remove bottom border for the last cell */
}

.small-font {
    font-size: 1rem; /* adjust as needed */
}
.form-group {
border: 1px solid #464748; /* Border color */
box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
background-color: #5E6266; /* Lighter shade of #464748 */
padding: 15px; /* Optional: for internal spacing */
}
body {
        background-color: #464748;
        color: #d3d1cd;
    }
.sidebar {
    display: flex;
    height: 100vh;
    background-color: #2D2E30; /* Darker shade for sidebar */
    padding: 1vw;
    width: 10vw; /* Sidebar width */
}
.sidebar-logo {
    padding: 1vw;
    text-align: center;
}
    .nav-sidebar {
        display: flex;
        flex-direction: column;
        padding-left: 0;
        list-style: none;
    }
    .nav-sidebar .nav-item {
        padding: 0.1vw;
        /* border-bottom: 1px solid  #fac330; /* Light orange line */
        margin: 0 10%;
        gap: 1rem;
    }
   .nav-sidebar .nav-link {
        color: #d3d1cd;
        border-radius: 0;
        transition: color 0.3s ease-in-out;
        font-size: 0.7rem;
    }
    .nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
        background-color: #3A5F5F;
        color: #E0E0E0;
    }
    /* Enhance dropdown menu */
    .dropdown-menu {
        background-color: #d3d1cd;
        border: none;
    }
    .dropdown-item:hover, .dropdown-item:focus {
        background-color: #fac330; /* Light orange background for hovered dropdown items */
        color: #2D2E30;
    }
    .content {
        padding: 20px;
    }
   .custom-main-content {
    position: relative; /* Adjust if necessary */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    max-width: calc(90vw - 200px); /* 90% of the viewport width minus sidebar width */
    margin-left: 200px; /* Push content to the right of the sidebar */
}

@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: calc(100% - 200px);
        max-width: calc(90vw - 200px);
        margin-left: 100px;
    }
}


    .table tbody tr:hover {
    cursor: pointer;
    }



    .heatmap {
        border-collapse: collapse;
    }
    .heatmap td {
        width: 60px;
        height: 60px;
        text-align: center;
        border: 1px solid #ccc;
    }
    .Low { background-color: #d8e6d6; }
    .Low-Medium { background-color: #f7e5a0; }
    .Medium { background-color: #f9d56e; }
    .Medium-High { background-color: #f9a56e; }
    .High { background-color: #f95d6a; }

    .body {
        font-size: 10px;
    }
.custom-main-content .container {
    width: 100%; /* Ensure the container fills the custom-main-content */
    max-width: none; /* Override Bootstrap's max-width for containers if necessary */
}
.top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 100px; /* Align with the end of the sidebar */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}

.page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.5rem; /* Adjust size as needed */
}

@media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
}
.nav-sidebar .nav-link img {
    width: 1.25em; /* Scales with the font size */
    height: 1.25em; /* Scales with the font size */
}
/* Larger icons for tablets */
@media (min-width: 768px) {
    .nav-sidebar .nav-link img {
    width: 1.5em;
    height: 1.5em;
    }
}
/* Even larger icons for desktops */
@media (min-width: 992px) {
    .nav-sidebar .nav-link img {
    width: 1.75em;
    height: 1.75em;
    }
}
    .nav-sidebar .nav-link img {
    width: 1.25em; /* Scales with the font size */
    height: 1.25em; /* Scales with the font size */
}
/* Larger icons for tablets */
@media (min-width: 768px) {
    .nav-sidebar .nav-link img {
    width: 1.5em;
    height: 1.5em;
    }
}
/* Even larger icons for desktops */
@media (min-width: 992px) {
    .nav-sidebar .nav-link img {
    width: 1.75em;
    height: 1.75em;
    }
}
        /* Adjusting the size of the risk circles */
.risk-circle {
    font-size: 3em; /* Adjusts the size of the circle */
    line-height: 1; /* Helps with vertical alignment */
    display: inline-block; /* Allows setting dimensions */
    width: 1em; /* Keeps the width proportional to the font size */
    text-align: center; /* Centers the circle symbol ● */
}

/* Example CSS for different risk levels */
.risk-circle.low {
    color: green;
}

.risk-circle.low-medium {
    color: olive;
}

.risk-circle.medium {
    color: yellow;
}

.risk-circle.medium-high {
    color: orange;
}

.risk-circle.high {
    color: red;
}
.vertical-align-middle {
    vertical-align: middle;
    display: inline-block;
    line-height: normal; /* Adjust as needed */
}

.risk-circle {
    vertical-align: middle; /* Aligns the circle vertically */
    /* Other properties as defined before */
}
.value-container {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 5px;
    color: #fff;
    margin-right: 5px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    font-weight: bold;
}

.best-case {
    background-color: #4CAF50; /* Green */
}

.median-case {
    background-color: #FFEB3B; /* Yellow */
    color: #000; /* For better contrast */
}

.worst-case {
    background-color: #F44336; /* Red */
}

.value-label {
    display: block;
    text-align: center;
    font-size: 0.75rem;
    margin-top: 4px;
}

/* Ensures the container aligns well with table structure */
.currency-container {
    display: flex;
    justify-content: start;
    align-items: center;
}

/* Custom modal sizing */
#riskTreatmentModal .modal-dialog {
    max-width: 80%;
    width: auto !important;
}
.modal-body {
    display: flex; /* Enable flexbox */
    justify-content: center; /* Center content horizontally */
    align-items: center; /* Center content vertically */
    text-align: center; /* Ensure text is centered if applicable */
    max-height: 80vh; /* Set a minimum height to ensure space for centering */
    overflow-y: auto;
    margin-top: 20px;
}

/* Mermaid SVG adjustments for better readability */
.mermaid svg {
    max-height: 65vh;  /* Adjust height automatically */
    width: 100%; /* Ensure it does not exceed the modal width */
    max-width: 100%; /* Prevent exceeding the modal width */
    font-size: 1.5em !important; /* Override font size directly */
    font-family: 'Open Sans', sans-serif;
    display: block; /* Remove inline styling */
    overflow: visible;
}
.mermaid .node {
    stroke: #333; /* Border color */
    fill: #fff; /* Background color */
}
.mermaid .node text {
    fill: #333; /* Text color */
    font-size: 0.9em; /* Larger text for readability */
    text-wrap: normal; /* Ensure text wraps */
}
.modal-lg {
    max-width: 95%; /* Or any other max-width that fits your design */
}

.modal-header {
    background-color: #007bff; /* Blue background for the header */
    color: #ffffff; /* White text color */
    border-bottom: 2px solid #0056b3; /* Darker blue border at the bottom */
    border-top-left-radius: 8px; /* Rounded top left corner */
    border-top-right-radius: 8px; /* Rounded top right corner */
}
.modal-title {
    font-weight: bold;
}


.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  max-width: 95%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
}
.modal-dialog {
    max-width: 95%; /* Use a maximum width */
    width: auto; /* Allow it to adjust based on content width */
}
</style>


</head>
<body style="background-color: #464748">


<script>
    anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");
    mermaid.initialize({startOnLoad:true});
</script>

<div class="container-fluid">
<!-- Spinner Overlay -->


    <div class="row">
       {% include 'menu_bar.html' %}

            <main role="main" class="col-md-10 ml-sm-auto col-lg-12  custom-main-content" >
            <div class="top-strip">
                <h1 class="page-title">Risk Register@AnzenOT (Beta)</h1>
            </div>
            <div class="container mt-5" >
                <div class="row">
                  <div class="col-md-2">
                      <div class="form-group">

                            <h5><i class="bi bi-funnel"></i> </h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Low" id="filterLow">
                                <label class="form-check-label" for="filterLow">
                                    Low (<span id="countLow">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Low/Medium" id="filterLowMedium">
                                <label class="form-check-label" for="filterLowMedium">
                                    Low/Medium (<span id="countLowMedium">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Medium" id="filterMedium">
                                <label class="form-check-label" for="filterMedium">
                                    Medium (<span id="countMedium">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Medium/High" id="filterMediumHigh">
                                <label class="form-check-label" for="filterMediumHigh">
                                    Medium/High (<span id="countMediumHigh">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="High" id="filterHigh">
                                <label class="form-check-label" for="filterHigh">
                                    High (<span id="countHigh">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="NoValue" id="filterNoValue">
                                <label class="form-check-label" for="filterNoValue">
                                    No Selection (<span id="countNoValue">0</span>)
                                </label>
                            </div>
                      </div>
                </div>

        <div class="col-md-6">
            <!-- Spinner Overlay -->
            <div id="spinnerOverlay" style="display: none; position: fixed; top: 5vw; left: 20vw; height: 110vh; width: 110vw; background: rgba(0, 0, 0, 0.5); z-index: 1050; justify-content: center; align-items: flex-start; padding-top: 20px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>

            <div class="form-group">
                <table class="table table-bordered table-striped compact" id="tbl_risk_register" style="font-size: 10px; width:100%">
                    <thead>
                        <tr>
                            <th>Facility Name</th>
                            <th>Assessment Unit</th>
                            <th>Risk Scenario</th>
                            <th>Residual Risk</th>
                            <th>BIA</th>
                            <th>Est Costs (Low/Medium/High)</th>
                            <th>Probability</th>
                            <th>Snapshots</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in data %}
                        <tr data-id="{{ item.ID }}">

                            <td>
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        Facility: <a href="{% url 'OTRisk:iotaphamanager_with_id' item.CyberPHA__ID %}" style="color:#000">{{ item.CyberPHA__FacilityName }}</a>
                                    </div>
                                <div class="col-md-1 text-md-right">
                                    <div class="vertical-align-middle">Risk:</div>
                                </div>
                                    <div class="col-md-3">
                                        <div class="risk_display">

                                             {% if item.RRa == "Low" %}
                                                <span class="risk-circle low" style="color:green;">●</span>
                                            {% elif item.RRa == "Low/Medium" %}
                                                <span class="risk-circle low-medium" style="color:olive;">●</span>
                                            {% elif item.RRa == "Medium" %}
                                                <span class="risk-circle medium" style="color:yellow;">●</span>
                                            {% elif  item.RRa == "Medium/High" %}
                                                <span class="risk-circle medium-high" style="color:orange;">●</span>
                                            {% elif item.RRa == "High" %}
                                                <span class="risk-circle high" style="color:red;">●</span>
                                            {% endif %}
                                            {{ item.RRa }}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        Priority: <span class="editable-priority" data-id="{{ item.ID }}">{{ item.risk_priority }}</span>
                                    </div>

                                </div>

                            </td>
                            <td><b>Assessment Unit:</b> {{ item.CyberPHA__AssessmentUnit }}</td>
                            <td>{{ item.Scenario }}</td>
                            <td>

                            </td>
                            <td>
                                <div class="row">
                                    <div class="col-md-6">
                                         <div class="vertical-align-middle">Business Impact Assessment:
                                             {% if item.business_impact_analysis_code == "Low" %}
                                                <span class="risk-circle low" style="color:green;" >●</span>
                                            {% elif item.business_impact_analysis_code == "Low/Medium" %}
                                                <span class="risk-circle low-medium" style="color:olive;">●</span>
                                            {% elif item.business_impact_analysis_code == "Medium" %}
                                                <span class="risk-circle medium" style="color:yellow;">●</span>
                                            {% elif  item.business_impact_analysis_code == "Medium/High" %}
                                                <span class="risk-circle medium-high" style="color:orange;">●</span>
                                            {% elif item.business_impact_analysis_code == "High" %}
                                                <span class="risk-circle high" style="color:red;">●</span>
                                            {% endif %}
                                            {{ item.business_impact_analysis_code }} ({{ item.business_impact_analysis_score }})
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                         <div class="vertical-align-middle">Attack Success Probability:
                                              {% if item.probability < 25 %}
                                                    <span class="risk-circle high" style="color:green;">●</span>
                                                {% elif item.probability >= 25 and item.probability < 50 %}
                                                    <span class="risk-circle high" style="color:yellow;">●</span>
                                                {% elif item.probability >= 50 and item.probability < 75 %}
                                                    <span class="risk-circle high" style="color:orange;">●</span>
                                                {% elif item.probability >= 75 %}
                                                    <span class="risk-circle high" style="color:red;">●</span>
                                                {% endif %}
                                                {{ item.probability }}%
                                         </div>
                                    </div>



                                </div>
                            </td>
                            <td>
                                <div class="currency-container">
                                    <div class="value-container best-case">
                                        ${{ item.sle_low|intcomma }}
                                        <span class="value-label">Best Case</span>
                                    </div>
                                    <div class="value-container median-case">
                                        ${{ item.sle|intcomma }}
                                        <span class="value-label">Median Case</span>
                                    </div>
                                    <div class="value-container worst-case">
                                        ${{ item.sle_high|intcomma }}
                                        <span class="value-label">Worst Case</span>
                                    </div>
                                </div>
                            </td>



                            <td>

                            </td>
                            <td>
                                <div class="row">
                                    <div class="col-md-3">
                                        Risk Owner: <span class="editable-owner" data-id="{{ item.ID }}">{{ item.risk_owner }}</span>
                                    </div>
                                    <div class="col-md-3">
                                        Status: <span class="editable-status" data-id="{{ item.ID }}">{{ item.risk_status }}</span>
                                    </div>
                                    <div class="col-md-3">
                                        Risk Open Date: <span class="editable-open-date" data-id="{{ item.ID }}">{{ item.risk_open_date }}</span>
                                    </div>
                                    <div class="col-md-3">
                                        Risk Close Date: <span class="editable-close-date" data-id="{{ item.ID }}">{{ item.risk_close_date }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if item.snapshots == 1 %}
                                    <a href="{% url 'OTRisk:view_snapshots' item.ID %}">View Snapshots</a>
                                {% endif %}
                            </td>
                            <td>
                                <div class="row">
                                    <div class="col-md-3">
                                        <a href="#" onclick="showOrGenerateRiskTreatmentPlan({{ item.ID }}); return false;"><i class="bi bi-diagram-3"></i> View/Generate Risk Treatment Plan</a>
                                    </div>
                                    <div class="col-md-6"></div>
                                    <div class="col-md-3"><a href="#" onclick="deletefromrr({{ item.ID }}); return false;"><i class="bi bi-trash-fill"></i>Delete from Risk Register</a></div>
                                </div>
                            </td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div> <!-- risk register table -->

</div>
<script>

 $(document).ready(function() {
    $("table tbody tr").click(function() {


    });
    $("table tbody tr:first").trigger('click');
});





    </script>
<script>
$(document).ready(function() {
    function updateTable() {
        let selectedRisks = $('input[type="checkbox"]:checked').map(function() {
        return $(this).val();
    }).get();

        $('#tbl_risk_register tbody tr').each(function() {
            let cellText = $(this).find('.risk_display').clone().children().remove().end().text().trim();

        // Determine if the row should be shown based on the filters applied
        let showRow = selectedRisks.length === 0 || selectedRisks.includes(cellText) || (cellText === "" && selectedRisks.includes("NoValue"));

        $(this).toggle(showRow);
        });
    }

    $('input[type="checkbox"]').on('change', updateTable);
    updateTable(); // Initial update

    function updateCounts() {
        let riskValues = {
            'Low': 0,
            'Medium': 0,
            'High': 0,
            'Low/Medium': 0,
            'Medium/High': 0,
            'NoValue': 0
        };

         $('#tbl_risk_register tbody tr').each(function() {
        // Use .find('.risk_display') to get the container
        // Then, use .clone() to make a copy of it, so original content is not altered
        // Use .children().remove() to remove child elements from the copy, leaving text only
        // Finally, use .text().trim() on the modified copy to get clean text
        let cellText = $(this).find('.risk_display').clone().children().remove().end().text().trim();

        if (cellText === "") {
            riskValues['NoValue']++;
        } else if (riskValues.hasOwnProperty(cellText)) {
            riskValues[cellText]++;
        }
    });

    // Update counts in the UI
    for (let risk in riskValues) {
        $('#count' + risk.replace(/\//g, '').replace('NoValue', 'NoValue')).text(riskValues[risk]);
    }
}

$(document).ready(function() {
    updateCounts(); // Call this function to update counts on page load
});
});
</script>



<script>





$(document).ready(function() {
    $('body').on('click', '.editable-status', function() {
        var currentStatus = $(this).text();
        var id = $(this).data('id');
        var selectHtml = `<select class="form-control status-select" data-id="${id}">
            <option value="Open">Open</option>
            <option value="Closed">Closed</option>

        </select>`;
        $(this).replaceWith(selectHtml);
        $('.status-select').val(currentStatus); // Select the current value
    });

    $('body').on('change', '.status-select', function() {
        var newStatus = $(this).val();
        var id = $(this).data('id');
        // AJAX call to update the priority
        $.ajax({
            url: '/OTRisk/update_risk_status/', // Update with your URL
            method: 'POST',
            data: {
                'id': id,
                'newStatus': newStatus,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // On success, replace the select back to span with the new value
                var spanHtml = `<span class="editable-status" data-id="${id}">${newStatus}</span>`;
                $('.status-select[data-id="'+id+'"]').replaceWith(spanHtml);
            },
            error: function(xhr, status, error) {
                // Handle any error
                alert('Error updating status. Please try again.');
            }
        });
    });
});




$(document).ready(function() {
    $('body').on('click', '.editable-priority', function() {
        var currentPriority = $(this).text();
        var id = $(this).data('id');
        var selectHtml = `<select class="form-control priority-select" data-id="${id}">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
        </select>`;
        $(this).replaceWith(selectHtml);
        $('.priority-select').val(currentPriority); // Select the current value
    });

    $('body').on('change', '.priority-select', function() {
        var newPriority = $(this).val();
        var id = $(this).data('id');
        // AJAX call to update the priority
        $.ajax({
            url: '/OTRisk/update_risk_priority/', // Update with your URL
            method: 'POST',
            data: {
                'id': id,
                'newPriority': newPriority,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // On success, replace the select back to span with the new value
                var spanHtml = `<span class="editable-priority" data-id="${id}">${newPriority}</span>`;
                $('.priority-select[data-id="'+id+'"]').replaceWith(spanHtml);
            },
            error: function(xhr, status, error) {
                // Handle any error
                alert('Error updating priority. Please try again.');
            }
        });
    });
});

$(document).ready(function() {

    $('body').on('click', '.editable-owner', function() {
        var currentOwner = $(this).text();
        var id = $(this).data('id');
        var inputHtml = `<input type="text" class="form-control owner-input" data-id="${id}" value="${currentOwner}">`;
        $(this).replaceWith(inputHtml);
        $('.owner-input[data-id="' + id + '"]').focus();
    });

    $('body').on('blur', '.owner-input', function() {
        var newOwner = $(this).val();
        var id = $(this).data('id');
        // AJAX call to update the owner
        $.ajax({
            url: '/OTRisk/update_risk_owner/', // Update with your URL
            method: 'POST',
            data: {
                'id': id,
                'new_owner': newOwner,
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                // On success, replace the input back to span with the new value
                var spanHtml = `<span class="editable-owner" data-id="${id}">${newOwner}</span>`;
                $('.owner-input[data-id="'+id+'"]').replaceWith(spanHtml);
            },
            error: function(xhr, status, error) {
                // Handle any error
                alert('Error updating risk owner. Please try again.');
            }
        });
    });

    $('body').on('click', '.editable-open-date', function() {
        var currentOpenDate = $(this).text();
        var id = $(this).data('id');
        var inputHtml = `<input type="date" class="form-control open-date-input" data-id="${id}" value="${currentOpenDate}">`;
        $(this).replaceWith(inputHtml);
    });

    $('body').on('blur', '.open-date-input', function() {
        var newOpenDate = $(this).val();
        var id = $(this).data('id');
        // AJAX call to update the open date
        updateDateField(id, newOpenDate, '/OTRisk/update_risk_open_date/', '.editable-open-date');

    });

    // Editable Risk Close Date
    $('body').on('click', '.editable-close-date', function() {
        var currentCloseDate = $(this).text();
        var id = $(this).data('id');
        var inputHtml = `<input type="date" class="form-control close-date-input" data-id="${id}" value="${currentCloseDate}">`;
        $(this).replaceWith(inputHtml);
    });

    $('body').on('blur', '.close-date-input', function() {
        var newCloseDate = $(this).val();
        var id = $(this).data('id');
        // AJAX call to update the close date
        updateDateField(id, newCloseDate, '/OTRisk/update_risk_close_date/', '.editable-close-date');
    });
    function updateDateField(id, newValue, url, selectorClass) {
        $.ajax({
            url: url,
            method: 'POST',
            data: {
                'id': id,
                'new_value': newValue,
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                var spanHtml = `<span class="${selectorClass.substr(1)}" data-id="${id}">${newValue}</span>`;
                $('input[data-id="'+id+'"]').replaceWith(spanHtml);
            },
            error: function(xhr, status, error) {
                alert('Error updating date. Please try again.');
            }
        });
    }

});

// Assuming you're using jQuery to handle the click event on your new link
$('a.generate-plan').on('click', function(e) {
    e.preventDefault();
    var riskId = $(this).data('risk-id');
    $.get('/OTRisk/risk_treatment/' + riskId, function(data) {
        if (data.create_plan) {
            Swal.fire({
                title: 'Generate Risk Treatment Plan?',
                text: data.message,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, generate it!',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Call your generate function
                    $.post('/OTRisk/generate-risk-treatment-plan/' + riskId, function(data) {
                        // Show the modal with the generated plan
                        $('#riskTreatmentModal .modal-body').html(data.risk_treatment_plan);
                        $('#riskTreatmentModal').modal('show');
                    });
                }
            });
        } else {
            // Show the modal directly if the plan exists
            $('#riskTreatmentModal .modal-body').html(data.risk_treatment_plan);
            $('#riskTreatmentModal').modal('show');
        }
    });
});

function deletefromrr(riskId) {
    // Use SweetAlert2 to show a confirmation dialog
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel!'
    }).then((result) => {
        if (result.isConfirmed) {
            // User confirmed the action, proceed with the deletion
            const csrfToken = getCookie('csrftoken'); // Helper function to get CSRF token

            $.ajax({
                url: `/OTRisk/delete_from_risk_register/${riskId}/`, // Update URL as necessary
                type: 'POST',
                data: {
                    'risk_id': riskId,
                },
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                success: function(response) {
                    // If successful, reload the risk register page
                    Swal.fire(
                        'Deleted!',
                        'The record has been deleted.',
                        'success'
                    ).then(() => {
                        window.location.href = '/OTRisk/risk_register/'; // Redirect to the risk register view
                    });
                },
                error: function(xhr, status, error) {
                    // Handle error
                    Swal.fire(
                        'Failed!',
                        'Failed to delete the record. Please try again.',
                        'error'
                    );
                }
            });
        }
        // If result.isConfirmed is false, the user clicked "No, cancel!" and the action is cancelled
    });
}



function showOrGenerateRiskTreatmentPlan(riskId) {
    $.ajax({
        url: '/OTRisk/risk_treatment/' + riskId + '/',
        method: 'GET',
        dataType: 'json', // Make sure to expect JSON data
        success: function(response) {
            // Check if a plan is returned instead of relying on a 'create_plan' flag
            if (response.risk_treatment_plan) {
                // Plan exists, show it
                var mermaidSyntax = convertToMermaid(response.risk_treatment_plan);
                $('#riskTreatmentModal .modal-body').html('<div class="mermaid">' + mermaidSyntax + '</div>');
                $('#riskTreatmentModal').on('shown.bs.modal', function () {
                    mermaid.initialize(mermaidConfig);
                    mermaid.init(undefined, '.mermaid');
                });
                $('#riskTreatmentModal').modal('show');
            } else {
                // No plan exists, prompt to create one
                Swal.fire({
                    title: 'No risk treatment plan has been generated. Do you wish to create one?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                }).then((result) => {
                    if (result.isConfirmed) {
                        generateRiskTreatmentPlan(riskId);
                    }
                });
            }
        },
        error: function() {
            alert('Failed to check the risk treatment plan. Please try again.');
        }
    });
}

var mermaidConfig = {
    startOnLoad: true,
    theme: 'default',
    flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'linear',
    },
    themeVariables: {
        fontSize: '16px',
        fontFamily: '"Open Sans", sans-serif',
        nodeBorder: '2px solid #444',
        primaryColor: '#4F81BD', // Example of changing the node color
        primaryBorderColor: '#4F81BD',
        primaryTextColor: '#ffffff',
        edgeLabelBackground: '#c3c3c3',
        clusterBkg: '#ffffff',
        clusterBorder: '#4F81BD',
        lineColor: '#4F81BD',
        arrowheadColor: '#4F81BD',
        nodeBkg: '#4F81BD',
        nodeMaxWidth: '240px', // Attempting to standardize node width
    },
    er: {
        useMaxWidth: true,
    },
    sequence: {
        useMaxWidth: true,
    },
};


function generateRiskTreatmentPlan(riskId) {
    $('#spinnerOverlay').show();

    const csrfToken = getCookie('csrftoken'); // Get CSRF token from cookies
    $.ajax({
        url: '/OTRisk/generate_risk_treatment_plan/', // Update with the correct URL
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken}, // Add CSRF token to the request header
        data: {
            'risk_id': riskId,
        },
        success: function(response) {
            if (response.status === 'success') {
                 $('#spinnerOverlay').hide();
                // Display the new plan in the modal's body
                var mermaidSyntax = convertToMermaid(response.risk_treatment_plan);
                // Set the Mermaid syntax to the modal's body
                $('#riskTreatmentModal .modal-body').html('<div class="mermaid">' + mermaidSyntax + '</div>');

                // Initialize or re-render Mermaid diagrams
                $('#riskTreatmentModal').on('shown.bs.modal', function () {
                    mermaid.initialize(mermaidConfig);
                    mermaid.init(undefined, '.mermaid');
                });

                $('#riskTreatmentModal').modal('show');
            } else {
                alert('An error occurred. Please try again.');
                 $('#spinnerOverlay').hide();
            }
        },
        error: function() {
            alert('Failed to generate the risk treatment plan. Please try again.');
             $('#spinnerOverlay').hide();
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function convertToMermaid(riskTreatmentPlan) {
    let mermaidSyntax = 'graph TD\n';
    let steps = riskTreatmentPlan.split('\n').filter(line => line.startsWith('- Step'));

    steps.forEach((step, index) => {
        let [action, description] = step.split('-').slice(1).join('-').trim().split(': ');
        let header = action.trim();
        let body = description.trim();

        let currentNode = `Step${index + 1}`;
        let nextNode = steps[index + 1] ? `Step${index + 2}` : '';

        // Constructing node content with a header and body. The <br> tag is used for line breaks within the node.
        let nodeContent = `<b>${sanitizeTextForMermaid(header)}</b><br>${sanitizeTextForMermaid(body)}`;

        mermaidSyntax += `${currentNode}("${nodeContent}")`;

        if (nextNode) {
            mermaidSyntax += ` --> ${nextNode}`;
        }
        mermaidSyntax += '\n';
    });

    return mermaidSyntax;
}


function sanitizeTextForMermaid(text) {
    // Basic text sanitization for Mermaid compatibility
    return text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}


</script>


</div>
 </main>
    </div>
</div>

<!-- Risk Treatment Plan Modal -->
<div class="modal fade" id="riskTreatmentModal" tabindex="-1" aria-labelledby="riskTreatmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="riskTreatmentModalLabel">Risk Treatment Plan</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Content will be loaded dynamically -->
      </div>
      <div class="modal-footer">
       <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


</body>
</html>