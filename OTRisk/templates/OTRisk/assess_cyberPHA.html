{% load static %}
<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>


    <script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
    {% load bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}

    <title>Assess CyberPHA</title>
    <style>
    .small-font {
        font-size: 0.8rem; /* adjust as needed */
   }

    .navbar-scroll .nav-link,
    .navbar-scroll .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #ffffff;
    }

    /* Color of the navbar BEFORE scroll */
    .navbar-scroll {
      background-color: #000000;
        text-decoration-color: #FFFFFF;
    }


    /* Color of the links AFTER scroll */
    .navbar-scrolled .nav-link,
    .navbar-scrolled .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #262626;
    }

    .navbar-logo {
    position: absolute;
    top: 5px; /* Adjust this as needed */
    left: 5; /* Adjust this as needed */
    height: 100px; /* Adjust this as needed */
    z-index: 10;
}
        .table-wrap {
          height: 200px;
          overflow-y: auto;
        }

        .small-font {
        font-size: 0.8rem; /* adjust as needed */
        }


    </style>
    <script>
      // Initialize sliders when the page loads
      window.onload = function() {
        initSlider("range_safety", "safetyrange");
        initSlider("range_life", "liferange");
        initSlider("range_production", "productionrange");
        initSlider("range_finance", "financerange");
        initSlider("range_reputation", "reputationrange");
        initSlider("range_environment", "environmentrange");
        initSlider("range_regulatory", "regulatoryrange");
        initSlider("range_data", "datarange");
        // init other sliders...
      };

      $(function () {
          $('[data-bs-toggle="tooltip"]').tooltip()
        })
</script>


</head>
<body>

<nav class="navbar navbar-expand-lg navbar-scroll fixed-top shadow-0 border-bottom border-dark rounded">
  <div class="container-fluid d-flex justify-content-between">
   <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}"><img src="/static/images/logo1-2.jpg" style="height: 140px; width: 140px" class="navbar-logo" alt="">  </a>
      <h4 class="my-auto text-center flex-grow-1"><font color="white">CyberPHA Scenario Analysis</font></h4>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> CyberPHA
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="{% url 'OTRisk:iotaphamanager' %}"> CyberPHA Manager</a></li>
                <li><a class="dropdown-item" href="{% url 'OTRisk:walkdown' %}"> Site Walkdown</a></li>
                <li><a class="dropdown-item" href="#">Workshop</a></li>
              </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:walkdown' %}" tabindex="-1" ><i class="bi bi-kanban"></i> New Walkdown</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Reports</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" tabindex="-1" ><i class="bi bi-ui-checks-grid"></i> Admin</a>
      </li>
          <li class="nav-item">
          <a href="#" onclick="window.open('{% static 'OTRisk/help_pha.html' %}', 'newwindow', 'width=600,height=400'); return false;"><i class="bi bi-question-circle"></i> Help</a>

      </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:profile' %}">
          <i class="bi bi-person-fill"></i> User: {{ user.first_name }} {{ user.last_name }}
        </a>

        </li>
      </ul>
    </div>
  </div>

</nav>

<form id="cyberpha-form">
{% csrf_token %}

<div class="row" style="height: 10px; padding-top: 20px; background-color: black">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8 " ></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->
<div class="row" style="height: 10px; padding-top: 20px; background-color: black">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: white" ></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->

<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: #FFC017">
    <figure class="text-center">

    <h4><br><br>CyberPHA Scenario Analysis - <span id="facilityName"></span></h4>
        <h6>Risk weightings set to <span id="facilityName2" class="text-decoration-underline text-body-emphasis" data-bs-toggle="tooltip" data-bs-placement="top" title="If the incorrect industry is displayed, return to the 'CyberPHA Manager' screen and select the 'Edit' button for this assessment from the table. Select the correct industry in the Assessment Setup form and save the record before re-selecting it to return to this screen"></span> industry</h6>


    </figure>
    <script>
        console.log(sessionStorage.getItem('sessionIndustry'));

        document.getElementById('facilityName').textContent = sessionStorage.getItem('sessionFacility');
        document.getElementById('facilityName2').textContent = sessionStorage.getItem('sessionIndustry');
        //document.getElementById('hdnID').value = sessionStorage.getItem('activeCyberPHA');

     </script>
    </div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: black"></div>
</div>
<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->

<div class="row" style="height: 300px">
    <div class="col-md-1" style="background-color: black">
        <button type="button" id="addScenarioBtn" class="form-control  btn-link" onclick="resetformcontrols()" style="background-color: black; color: white;">New Scenario</button>
        <script>
            function resetformcontrols() {
                // document.getElementById("mitigation-measure").selectedIndex=0;
                // document.getElementById("hdnScenarioID").value=0;
            }
        </script>
        <br>

            <!-- Modify the submit button to open the confirmation modal -->
            <button type="button" class="form-control btn-link" data-bs-toggle="modal" style="background-color: black; color: white;" onclick="processFormData()">Save Scenario</button>

        <br>
            <button type="button" class="form-control btn-link" onclick="getCyberPHAReport()" style="background-color: black; color: white;" >Scenario Report</button>
            <script>
                function goToScenarioReport() {
                    // var hdnID = document.getElementById('hdnID').value;  // assuming 'hdnID' is the id of your input field
                    // window.location.href = "{% url 'OTRisk:scenarioreport' %}?hdnID=" + hdnID;
                }
            </script>

    </div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8 " style="background-color: #FFC017; padding: 20px">
        <div class="table-wrap rounded-3" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white; height: 250px">
            <table id="userscenarioList" class="table table-hover table-bordered small small-font overflow-auto" style="background-color: white;">
                <thead>
                    <tr>
                        <th rowspan="2">ID</th>
                        <th rowspan="2">Scenario</th>
                        <th colspan="8">Impact Assessment Scores (Max = 10)</th>
                        <th rowspan="2">Threat</th>
                        <th rowspan="2">Risk</th>
                        <th rowspan="2"></th>
                    </tr>
                    <tr>
                        <th>Sfty</th>
                        <th>Dgr</th>
                        <th>Env</th>
                        <th>Cst</th>
                        <th>Ops</th>
                        <th>Data</th>
                        <th>Regs</th>
                        <th>Rep</th>
                    </tr>
                </thead>

                <tbody id="userscenarioListBody">
                  {% for saved_scenarios in saved_scenarios %}
                  <tr onclick="fillScenario({{ saved_scenarios.ID}})">
                    <td>{{ saved_scenarios.ID }}</td>
                    <td>{{ saved_scenarios.Scenario }}</td>
                    <td>{{ saved_scenarios.impactSafety }}</td>
                    <td>{{ saved_scenarios.impactDanger}}</td>
                    <td>{{ saved_scenarios.impactEnvironment }}</td>
                    <td>{{ saved_scenarios.impactFinance}}</td>
                    <td>{{ saved_scenarios.impactProduction}}</td>
                    <td>{{ saved_scenarios.impactData}}</td>
                    <td>{{ saved_scenarios.impactRegulation}}</td>
                    <td>{{ saved_scenarios.impactReputation}}</td>
                    <td>{{ saved_scenarios.ThreatClass }}</td>
                    <td>{{ saved_scenarios.RiskCategory }}</td>
                    <td>
                        <a href="{% url 'OTRisk:deletescenario' saved_scenarios.ID saved_scenarios.CyberPHA %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this record? (Note that if you proceed, the record will be virtually deleted and can be recovered if necessary)')">Del</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
                <script>
                function fillScenario(scenarioId) {
                    $('#mitigation-measure').val([]);
                    $('#mitigation-measure').trigger('change');
                    $('#threatactions').val([]);
                    $('#threatactions').trigger('change');
                    // Send a GET request to the getSingleScenario view
                    $.get("{% url 'OTRisk:getSingleScenario' %}", { id: scenarioId }, function(data) {
                        // Fill the form fields with the returned data
                        $('#txtScenario').val(data.Scenario);
                        $('#txtConsequence').val(data.Consequence);
                        $('#threat-intelligence').val(data.ThreatClass);
                        // Split the Countermeasures string into an array and set the selected values of the dropdown

                        var countermeasuresArray = data.Countermeasures.split(',');
                        $('#mitigation-measure').val(countermeasuresArray);
                        $('#mitigation-measure').trigger('change');

                        var threatactionsArray = data.ThreatAction.split(',');
                        $('#threatactions').val(threatactionsArray);
                        $('#threatactions').trigger('change');

                         $('#risk-category').val(data.RiskCategory);
                         $('#range_safety').val(data.impactSafety);
                         $('#range_life').val(data.impactDanger);
                         $('#range_production').val(data.impactProduction);
                         $('#range_finance').val(data.impactFinance);
                         $('#range_reputation').val(data.impactReputation);
                         $('#range_environment').val(data.impactEnvironment);
                         $('#range_regulation').val(data.impactRegulation);
                         $('#range_data').val(data.impactData);
                         // $('#selStandards').val(data.RiskCategory);

                        $('#txtScenarioAnalysis').val(data.recommendations);
                        $('#SMrange').val(data.SM);
                        $('#MELrange').val(data.MEL);
                        $('#RRMrange').val(data.RRM);
                        $('#SArange').val(data.SA);
                        $('#MELarange').val(data.MELA);
                         $('#txtRRa').val(data.RRa);
                        $('#txtControlAnalysis').val(data.control_recommendations);
                        });
                    }
            </script>

        </div>
    </div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: black"></div>
</div> <!-- list of user entered scenarios -->




<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->




<div class="row small-font" >
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8">
        <div class="row" style="background-color: #FFC017">
            <h5><p class="form-container" style="text-align: center; color: #494949">Scenario Selection</p></h5>
        </div>
        <div class ="row" style="background-color: #FFC017">
            <div class="col-md-6 d-flex justify-content-center">
                <br><br>
                <div class="table-wrap border border-warning rounded p-3" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white;">
                    <table id="scenarioList" class="table table-hover table-bordered small small-font overflow-auto" style="width: 100%; background-color: white">
                        <thead>
                            <tr>
                                <th>Scenario</th>
                            </tr>
                        </thead>
                        <tbody id="scenarioListBody">
                            {% for scenario in scenarios %}
                            <tr onclick="selectScenario(this)">
                                <td>{{ scenario.Scenario }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <script>
                    $(document).ready(function() {
                        $('#scenarioList').DataTable();
                    });
                </script>
            </div>
            <div class="col-md-6">
                <div class="row  rounded p-3">
                    <textarea id="txtScenario" name="txtScenario" class="form-control" rows="6" placeholder="Select a scenario from the table or enter your own...." style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white"></textarea>
                </div>
            </div>
        </div>

    </div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: black"></div>
</div> <!-- scenario list table -->

<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: #FFC017; box-shadow: 0px 10px 10px rgba(0, 0, 0, 0.5);"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->
<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->

<div class="row small-font">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8">
        <div class="row" style="background-color: #FFC017">
            <h5><p class="form-container" style="text-align: center; color: #494949">Consequence Selection</p></h5>
        </div>
        <div class ="row" style="background-color: #FFC017">
            <div class="col-md-6 d-flex justify-content-center">
                <br><br>
                <div class="table-wrap border border-warning rounded p-3" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white;">
                    <table id="consequenceListTable" class="table table-hover table-bordered small small-font overflow-auto" style="width:100%">
                        <thead>
                            <tr>
                                <th>Consequence</th>
                            </tr>
                        </thead>
                        <tbody id="consequenceListTableBody">
                            {% for consequenceList in consequenceList %}
                            <tr onclick="selectConsequence('{{ consequenceList.Consequence }}')">
                                <td>{{ consequenceList.Consequence }}</td>
                              </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <script>
                    $(document).ready(function() {
                        $('#consequenceListTable').DataTable();
                    });
                </script>
            </div>
            <div class="col-md-6">
                <div class="row  rounded p-3">
                    <textarea id="txtConsequence" name="txtConsequence" class="form-control" rows="6" placeholder="Select up to three consequences from the table or enter your own...." style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white"></textarea>
                </div>
            </div>
        </div>
    </div>






    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: black"></div>
</div> <!-- consequence list table -->

<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: #ffc017; box-shadow: 0px 10px 10px rgba(0, 0, 0, 0.5);"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->
<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->

    <input type="hidden" id="hdnID" name="hdnID" >
<input type="hidden" id="hdnScenario" name="hdnScenario" value = {{ scenarioID }}>
<script>

    // document.getElementById('hdnID').value = sessionStorage.getItem('activeCyberPHA');

</script>



<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->


<div class="row" >
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-4 " style="background-color: #FFC017">
        <label class="form-label" for="threat-intelligence">Threat Source</label>
        <select class="form-control" name="threat-intelligence" id="threat-intelligence" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 10px; background-color: white">
            <option value="">-- Select a threat source --</option>
            {% for threat_intelligence in threat_intelligence %}
                <option value="{{ threat_intelligence.ThreatDescription }}">{{ threat_intelligence.ThreatDescription }}</option>
            {% endfor %}
        </select>
        <br>

        <label class="form-label" for="threatactions">Threat Action</label>
        <select class="form-control" name="threatactions" id="threatactions" multiple="multiple" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white">
        <option value="">Select a threat action</option>
        {% for threatactions in threatactions  %}
            <option value="{{ threatactions.ThreatAction }}">{{ threatactions.ThreatAction }}</option>
        {% endfor %}
    </select>

        <script>
        $(document).ready(function() {
            $('#threatactions').select2({
                placeholder: "Select Threat Actions",
                allowClear: true
            });
        });
        </script>
    </div>
    <div class="col-md-4 " style="background-color: #FFC017">
        <label class="form-label" for="mitigation-measure">Current Controls</label>
        <select class="form-control" name="mitigation-measure" id="mitigation-measure" multiple="multiple" title="Select one or more existing controls implemented within the environment" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white">
        <option value="">-- Select Controls --</option>
        {% for mitigation_measure in mitigation_measures %}
            <option value="{{ mitigation_measure.ControlObjective }}">{{ mitigation_measure.ControlObjective }}</option>
        {% endfor %}
        </select>

        <script>
        $(document).ready(function() {
            $('#mitigation-measure').select2({
                placeholder: "Select Current Controls",
                allowClear: true
            });
        });
        </script>

        <br><br>
        <label class="form-label" for="risk-category">Risk Category</label>
            <select class="form-control" name="risk-category" id="risk-category" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 10px; background-color: white">
              <option value="">Select a risk category</option>
              {% for risk_category in risk_categories %}
                <option value="{{ risk_category.CategoryName }}">{{ risk_category.CategoryName }}</option>
              {% endfor %}
            </select>


    </div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div>
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8 " style="background-color: #FFC017; height: 10px"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->

<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->


<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-4" style="background-color: #FFC017">
        <h4>Impact Analysis</h4>
         <!--slider for safety rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the overall impact on safety of the selected scenario">Safety</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_safety" name="range_safety" onchange="initSlider('range_safety', 'safetyrange');">
                    </div>
                    <div class="col-3"><label id="safetyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></div>
                </div>
                <!--slider for safety rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the danger to life of the selected scenario">Life</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_life" name="range_life" onchange="initSlider('range_life', 'liferange');">
                    </div>
                    <div class="col-3"><h6><label id="liferange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for safety rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the production and operational impacts of the selected scenario">Production</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_production" name="range_production" onchange="initSlider('range_production', 'productionrange');">
                    </div>
                    <div class="col-3"><h6><label id="productionrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                 <!--slider for safety rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the cost impact of the selected scenario">Financial</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_finance" name="range_finance" onchange="initSlider('range_finance', 'financerange');">
                    </div>
                    <div class="col-3"><h6><label id="financerange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for safety rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the impact on the organization's public reputation of the selected scenario">Reputation</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_reputation" name="range_reputation" onchange="initSlider('range_reputation', 'reputationrange');">
                    </div>
                    <div class="col-3"><h6><label id="reputationrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for environment impact rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the environmental impact of the selected scenario">Environment</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_environment" name="range_environment" onchange="initSlider('range_environment', 'environmentrange');">
                    </div>
                    <div class="col-3"><h6><label id="environmentrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for regulatory impact rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the regulatory compliance impact of the selected scenario">Regulatory</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_regulatory" name="range_regulatory" onchange="initSlider('range_regulatory', 'regulatoryrange');">
                    </div>
                    <div class="col-3"><h6><label id="regulatoryrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for data impact rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " data-bs-toggle="tooltip" data-bs-placement="top" title="Use the slider to estimate the impact on data of the selected scenario">Data/IP</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="range_data" name="range_data" onchange="initSlider('range_data', 'datarange');">
                    </div>
                    <div class="col-3"><h6><label id="datarange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
    </div>

    <div class="col-md-4" style="background-color: #FFC017">
        <h4>Assessment - Current Controls</h4>
                <!--slider for UEL - likelihood without controls-->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Severity Mitigated (Sm)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="SMrange" name="SMrange" onchange="initSlider('SMrange','range_SM');">
                    </div>
                    <div class="col-3"><h6><label id="range_SM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for MEL - Mitigated Exposure Level-->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Mitigated Exposure (MEL)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="MELrange" name="MELrange" onchange="initSlider('MELrange','range_MEL');">
                    </div>
                    <div class="col-3"><h6><label id="range_MEL" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for MEL - Mitigated Exposure Level-->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Residual Risk (RRm)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="RRMrange" name="RRMrange" onchange="initSlider('RRMrange','range_RRM');">
                    </div>
                    <div class="col-3"><h6><label id="range_RRM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                    <row>
                        <div class=col-md-6>
                            <label class="form-label" for="selStandards">Standards</label>
                            <select class="form-control" name="selStandards" id="selStandards" title="Select which standards to align with for recommendations">
                            <option value="">-- Select Standard --</option>
                            {% for standardslist in standardslist %}
                                <option value="{{ standardslist.standard }}">{{ standardslist.standard}}</option>
                            {% endfor %}
                            </select>

                        </div>
                        <div class=col-md-6>
                            <button id="risk-assessment-btn" type="button" class="btn-primary">Assess Scenario</button><br>
                            <div id="loadingSpinner" class="spinner-border" role="status" style="display: none;">
                              <span class="visually-hidden">Loading...</span>
                            </div>

                                <script>
                                 // AJAX function call on button click
                                $(document).ready(function () {
                                    $("#risk-assessment-btn").click(function () {
                                        // Call the function to assess the risk
                                        assessScenario();
                                    });
                                });
                                </script>
                        </div>

                    </row>

    </div>

    <div class="col-md-1" style="background-color: darkgray"></div>
     <div class="col-md-1" style="background-color: black"></div>
</div>

<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->

<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-4" style="background-color: white">
        <div class="row  rounded p-3 ">
            <label for="txtControlAnalysis" class="small-font">Control Recommendations:</label>
            <textarea id="txtControlAnalysis" name="txtControlAnalysis" class="form-control border border-danger" rows="6"  style="resize: none"></textarea><br>
        </div>

    </div>
    <div class="col-md-4" style="background-color: white">
        <div class="row  rounded p-3 ">
            <label for="txtScenarioAnalysis" class="small-font">Recommendations will align with selected standards:</label>
            <textarea id="txtScenarioAnalysis" name="txtScenarioAnalysis" class="form-control border border-danger" rows="6"  style="resize: none"></textarea>
        </div>

    </div>
    <div class="col-md-1" style="background-color: darkgray"></div>
     <div class="col-md-1" style="background-color: black"></div>
</div>




<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-4" style="background-color: white">
        <h4>Adjusted Risk (After Action)</h4>
                <!--slider for Severity level (Sa) -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Severity Adjusted(Sa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="SArange" name="SArange" onchange="initSlider('SArange','range_SA');">
                    </div>
                    <div class="col-3"><h6><label id="range_SA" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for Mitigated Exposure (MELa) -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Mitigated Exposure (MELa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="form-range" id="MELarange" name="MELarange" onchange="initSlider('MELarange','range_MELa');">
                    </div>
                    <div class="col-3"><h6><label id="range_MELa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
                <!--slider for Residual Risk (RRa) -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Residual Risk (RRa)</label></div>
                    <div class="col-7"><input type="text" id="txtRRa" name="txtRRa" class="form-control">
                      <!-- <input type="range" min="1" max="10" value="1" class="form-range" id="RRarange" name="RRarange" onchange="initSlider('RRarange','range_RRa');"> -->
                    </div>
                    <div class="col-3"><h6><label id="range_RRa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>

    </div>
     <div class="col-md-4" style="background-color: white">
        <h4>Quantitative Assessment</h4>
        <div class="form-group">
            <label for="aro">Annualized Rate of Occurrence (ARO):</label>
            <input type="range" class="form-control-range" id="aro" name="aro" min="0" max="12" step="1" oninput="updatearoOutput(this.value)">
            <output for="aro" id="aroOutput">0</output>
        </div>
        <br>
        <div class="form-group">
            <label for="sle">Event Costs (SLE):</label>
            <input type="range" class="form-control-range" id="sle" name="sle" min="0" max="10000000" step="1000">
            <output for="sle" id="sleOutput">$0</output>
        </div>
        <br>
        <div class="form-group">
            <label for="ale">Annualized Loss Expectancy (ALE):</label>
            <output id="ale">$0</output>
        </div>
        <br>
        <div class="form-group">
            <label for="countermeasureCosts">Cost of Countermeasures:</label>
            <input type="range" class="form-control-range" id="countermeasureCostsRange" name="countermeasureCostsRange" min="0" max="1000000" step="1000" oninput="updateCountermeasureCostsOutput(this.value)">
            <output for="countermeasureCostsRange" id="countermeasureCostsOutput">$0</output>
        </div>
         <script>
            function updatearoOutput(value) {
              document.getElementById('aroOutput').textContent = value;
              // calculateALE();
            }
            function updateCountermeasureCostsOutput(value) {
              document.getElementById('countermeasureCostsOutput').textContent = value;
            }

            $(document).ready(function() {
              $('#eventCosts').on('input', function() {
                var cost = parseInt($(this).val()).toLocaleString();
                $('#eventCostsOutput').text('$' + cost);
                //calculateALE();
              });

              function calculateALE() {
                var aro = parseInt($('#aro').val());
                var eventCosts = parseInt($('#eventCosts').val());
                var sle = eventCosts;
                var aro = aro;
                var ale = sle * aro;
                $('#ale').text('$' + ale.toLocaleString());
              }
            });
          </script>
    </div>
    <div class="col-md-1" style="background-color: darkgray"></div>
     <div class="col-md-1" style="background-color: black"></div>
</div>
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8 " style="background-color: white; height: 10px"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->



<script>

      function initSlider(sliderId, outputId) {
        var slider = document.getElementById(sliderId);
        var output = document.getElementById(outputId);

        // Display the default slider value
        output.innerHTML = getSeverityLabel(slider.value);

        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
          output.innerHTML = getSeverityLabel(this.value);
          //calculateRiskScore();
        };
      }

      function getSeverityLabel(value) {
        switch (parseInt(value)) {
          case 1:
            case 2:
            return "Low";
          case 3:
            case 4:
            return "Low/Medium";
          case 5:
            case 6:
            return "Medium";
          case 7:
            case 8:
            return "Medium/High";
          case 9:
            case 10:
            return "High";
          default:
            return "";
        }
      }

      // Initialize sliders
      // initSlider("range_severity", "severityrange");
      // Add more sliders as needed
      // initSlider("another_slider_id", "another_output_id");





        //scoring functions for the gauge controls
    function calculateRiskScore() {

    var severity = parseInt(document.getElementById("range_severity").value);
      var severityWeight = parseInt(document.getElementById("S_Weight").value);
      var frequency = parseInt(document.getElementById("range_frequency").value);
      var frequencyWeight = parseInt(document.getElementById("F_Weight").value);
      var exposure = parseInt(document.getElementById("range_exposure").value);
      var exposureWeight = parseInt(document.getElementById("E_Weight").value);
      var resilience = parseInt(document.getElementById("range_resilience").value);
      var resilienceWeight = parseInt(document.getElementById("R_Weight").value);

      // Calculate the raw score
      var rawScore = (severity * severityWeight) + (frequency * frequencyWeight) + (exposure * exposureWeight) + (resilience * resilienceWeight);

      // Normalize the score between 1 and 10
      var minScore = 0; // Update this if a minimum possible score is defined
      var maxScore = 200; // Update this if a maximum possible score is defined
      var normalizedScore = (rawScore - minScore) / (maxScore - minScore) * 9 + 1;

      // Round the normalized score to two decimal places
      normalizedScore = Math.round(normalizedScore * 100) / 100;

      // Generate the corresponding rating based on the normalized score
      var rating;
      if (normalizedScore <= 2) {
        rating = "Low";
      } else if (normalizedScore <= 4) {
        rating = "Low/Medium";
      } else if (normalizedScore <= 6) {
        rating = "Medium";
      } else if (normalizedScore <= 8) {
        rating = "Medium/High";
      } else {
        rating = "High";
      }

    }

        function calculateUnmitigatedRisk() {

          // Calculate unmitigated risk
            var likelihood = parseInt(document.getElementById("range_UEL").value);
            var severity = parseInt(document.getElementById("range_Unmitigated").value);
            var slt = parseInt(document.getElementById("range_SLT").value);

          const unmitigatedRisk = likelihood * severity;

          // Normalize the unmitigated risk to a score between 0 and 10
          const normalizedScore = (unmitigatedRisk - 1) / 4 * 10;
          // Compare the normalized score with Safety Level Target (SL-T)
          if (normalizedScore <= slt) {
            return 'Low risk';
          } else if (normalizedScore > slt && normalizedScore <= 2 * slt) {
            return 'Medium risk';
          } else {
            return 'High risk';
          }


        }


          // Function to save or update CyberPHA data
        function getCyberPHAReport() {
            const cyberPHAID = sessionStorage.getItem('activeCyberPHA');

            // Create a form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'OTRisk:phascenarioreport' %}";

            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = getCookie('csrftoken');
            form.appendChild(csrfInput);

            // Add cyberPHAID
            const cyberPHAIDInput = document.createElement('input');
            cyberPHAIDInput.type = 'hidden';
            cyberPHAIDInput.name = 'cyberPHAID';
            cyberPHAIDInput.value = cyberPHAID;
            form.appendChild(cyberPHAIDInput);

            // Append the form to body and submit
            document.body.appendChild(form);
            form.submit();
        }



        // Function to save or update CyberPHA data
        function saveOrUpdateCyberPHA(formData) {
          // Get the CSRF token from the cookie
          const csrftoken = getCookie('csrftoken');

          // Create a new XMLHttpRequest object
          const xhr = new XMLHttpRequest();

          // Set up the request
          xhr.open('POST', "{% url 'OTRisk:save_or_update_cyberpha' %}", true);

          xhr.setRequestHeader('X-CSRFToken', csrftoken);


          // Define the callback function for when the request is completed
          xhr.onload = function() {
            if (xhr.status === 200) {
              location.reload()
              // Optionally, perform any additional actions or show a success message
            } else {
              console.error('Failed to save or update CyberPHA data');
              // Optionally, handle the error or show an error message
            }
          };

          // Send the request with the form data
          xhr.send(formData);
          $('#confirmationModal').modal('hide');
        }


        function getCookie(name) {
          const cookieValue = document.cookie
            .split(';')
            .map(cookie => cookie.trim())
            .find(cookie => cookie.startsWith(name + '='));

          if (cookieValue) {
            return cookieValue.split('=')[1];
          }

          return null;
        }

          // Event listener for form submission
          function processFormData() {
            $('#loadingSpinner').show();
            // Get the values of the form fields
            const scenario = document.getElementById('txtScenario').value;
            const consequence = document.getElementById('txtConsequence').value
            const threatSource = document.getElementById('threat-intelligence').value;
            const threatactions = document.getElementById('threatactions');
            let selectedThreatOptions = Array.from(threatactions.selectedOptions).map(option => option.value);
            const mitigationMeasures = document.getElementById('mitigation-measure');
            let selectedMitigationOptions = Array.from(mitigationMeasures.selectedOptions).map(option => option.value);
            const riskCategory = document.getElementById('risk-category').value;
            const safety = document.getElementById('range_safety').value;
            const life = document.getElementById('range_life').value;
            const production = document.getElementById('range_production').value;
            const financial = document.getElementById('range_finance').value;
            const reputation = document.getElementById('range_reputation').value;
            const environment = document.getElementById('range_environment').value;
            const regulatory = document.getElementById('range_regulatory').value;
            const data = document.getElementById('range_data').value;
            const sm = document.getElementById('SMrange').value;
            const mel = document.getElementById('MELrange').value;
            const rrm = document.getElementById('RRMrange').value;
            const sa = document.getElementById('SArange').value;
            const mela = document.getElementById('MELarange').value;
            const cyberpha = sessionStorage.getItem('activeCyberPHA')
            const recommendations = document.getElementById('txtScenarioAnalysis').value
            const controls = document.getElementById('txtControlAnalysis').value
            const rra =  document.getElementById('txtRRa').value

            // const likelihood = document.getElementById('likelihood').value;
            //onst impact = document.getElementById('impact').value;

            // Create a FormData object
                const formData = new FormData();
                formData.append('scenario', scenario);
                formData.append('consequence', consequence);
                formData.append('threatSource', threatSource);
                formData.append('threatAction', selectedThreatOptions);
                formData.append('mitigationMeasures', selectedMitigationOptions);
                formData.append('riskCategory', riskCategory);
                formData.append('safety', safety);
                formData.append('life', life);
                formData.append('production', production);
                formData.append('financial', financial);
                formData.append('reputation', reputation);
                formData.append('environment', environment);
                formData.append('regulatory', regulatory);
                formData.append('data', data);
                formData.append('sm', sm);
                formData.append('mel', mel);
                formData.append('rrm', rrm);
                formData.append('sa', sa);
                formData.append('mela', mela);
                formData.append('rra', rra);
                formData.append('recommendations',recommendations)
                formData.append('cyberpha', cyberpha);
                formData.append('controls', controls);

                // Call the saveOrUpdateCyberPHA function
                saveOrUpdateCyberPHA(formData);

                $('#loadingSpinner').hide();
          }



        </script>
    </form>



    <script>

        // Function to add a new scenario row to the table
        function addScenarioRow() {
            var scenarioCount = document.querySelectorAll('#scenarioTable tbody tr').length + 1;
            var row = document.createElement('tr');
            row.id = 'scenarioRow' + scenarioCount;

            // Create table cells for each field
            var assessmentNameCell = document.createElement('td');
            var scenarioCell = document.createElement('td');
            var controlObjectiveCell = document.createElement('td');
            var riskCategoryCell = document.createElement('td');
            var mitigationMeasuresCell = document.createElement('td');
            var likelihoodCell = document.createElement('td');
            var impactCell = document.createElement('td');
            var riskLevelCell = document.createElement('td');

            // Create form elements for each field
            var assessmentNameInput = document.createElement('input');
            assessmentNameInput.type = 'text';
            assessmentNameInput.name = 'assessment_name';
            assessmentNameCell.appendChild(assessmentNameInput);

            var scenarioInput = document.createElement('input');
            scenarioInput.type = 'text';
            scenarioInput.name = 'scenarios[' + scenarioCount + '][scenario]';
            scenarioCell.appendChild(scenarioInput);

            var controlObjectiveSelect = document.createElement('select');
            controlObjectiveSelect.name = 'scenarios[' + scenarioCount + '][control_objective]';
            // Populate control objectives dynamically

            var riskCategorySelect = document.createElement('select');
            riskCategorySelect.name = 'scenarios[' + scenarioCount + '][CategoryName]';
            // Populate risk categories dynamically


            var mitigationMeasuresSelect = document.createElement('select');
            mitigationMeasuresSelect.name = 'scenarios[' + scenarioCount + '][mitigation_measures]';
            // Populate mitigation measures dynamically

            var likelihoodInput = document.createElement('input');
            likelihoodInput.type = 'number';
            likelihoodInput.name = 'scenarios[' + scenarioCount + '][likelihood]';
            likelihoodCell.appendChild(likelihoodInput);

            var impactInput = document.createElement('input');
            impactInput.type = 'number';
            impactInput.name = 'scenarios[' + scenarioCount + '][impact]';
            impactCell.appendChild(impactInput);

            var riskLevelInput = document.createElement('input');
            riskLevelInput.type = 'text';
            riskLevelInput.name = 'scenarios[' + scenarioCount + '][risk_level]';
            riskLevelInput.disabled = true;
            riskLevelCell.appendChild(riskLevelInput);

            // Append form elements to the cells
            assessmentNameCell.appendChild(assessmentNameInput);
            scenarioCell.appendChild(scenarioInput);
            controlObjectiveCell.appendChild(controlObjectiveSelect);
            riskCategoryCell.appendChild(riskCategorySelect);
            mitigationMeasuresCell.appendChild(mitigationMeasuresSelect);
            likelihoodCell.appendChild(likelihoodInput);
            impactCell.appendChild(impactInput);
            riskLevelCell.appendChild(riskLevelInput);

            // Append cells to the row
            row.appendChild(assessmentNameCell);
            row.appendChild(scenarioCell);
            row.appendChild(controlObjectiveCell);
            row.appendChild(riskCategoryCell);
            row.appendChild(mitigationMeasuresCell);
            row.appendChild(likelihoodCell);
            row.appendChild(impactCell);
            row.appendChild(riskLevelCell);

            // Append row to the table
            document.getElementById('scenarioTable').appendChild(row);
        }

        // Event listener for adding a new scenario row
        document.getElementById('addScenarioBtn').addEventListener('click', function() {
            addScenarioRow();
        });



        // Function to fetch and populate the mitigation measures dynamically
        function populateMitigationMeasures(controlObjectiveSelect) {
            fetch('/OTRisk/get_mitigation_measures/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(measure => {
                        let option = document.createElement('option');
                        option.value = measure;
                        option.text = measure;
                        controlObjectiveSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.log('Error fetching mitigation measures:', error);
                });
        }

        // Event listener to populate the mitigation measures when the control objective is selected
        document.addEventListener('change', function(event) {
            const element = event.target;
            if (element.tagName === 'SELECT' && element.name.includes('control_objective')) {
                const controlObjectiveSelect = element;
                const mitigationMeasuresSelect = controlObjectiveSelect.closest('tr').querySelector('select[name$="[mitigation_measures]"]');
                // Clear previous options
                while (mitigationMeasuresSelect.firstChild) {
                    mitigationMeasuresSelect.removeChild(mitigationMeasuresSelect.firstChild);
                }
                // Populate mitigation measures based on selected control objective
                populateMitigationMeasures(mitigationMeasuresSelect);
            }
        });

        $(".slider")

        $(document).ready(function() {


          });

         // AJAX function to call the Django view
        function assessScenario() {
            $('#loadingSpinner').show();

            let scenario = document.getElementById('txtScenario').value;
            let consequence = document.getElementById('txtConsequence').value
            let threatsource = document.getElementById('threat-intelligence').value;
            let threatactions = document.getElementById('threatactions');
            let selectedThreatOptions = Array.from(threatactions.selectedOptions).map(option => option.value);
            let mitigationMeasures = document.getElementById('mitigation-measure');
            let selectedMitigationOptions = Array.from(mitigationMeasures.selectedOptions).map(option => option.value);
            let riskCategory = document.getElementById('risk-category').value;
            let safety = document.getElementById('range_safety').value;
            let life = document.getElementById('range_life').value;
            let production = document.getElementById('range_production').value;
            let financial = document.getElementById('range_finance').value;
            let reputation = document.getElementById('range_reputation').value;
            let environment = document.getElementById('range_environment').value;
            let regulatory = document.getElementById('range_regulatory').value;
            let data = document.getElementById('range_data').value;
            let sm = document.getElementById('SMrange').value;
            let mel = document.getElementById('MELrange').value;
            let rrm = document.getElementById('RRMrange').value;
            let sa = document.getElementById('SArange').value;
            let mela = document.getElementById('MELarange').value;
            let industry = sessionStorage.getItem('sessionIndustry')
            let facilityType = sessionStorage.getItem('sessionFacilityType')
            let standards = document.getElementById('selStandards').value;



            // Make the AJAX call to the Django view using a separate endpoint for risk assessment
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:scenario_analysis' %}",  // URL for the Django view
                data: {
                    // Pass the impact scores and scenario information as parameters
                    industry: industry,
                    facility_type: facilityType,
                    scenario: scenario,
                    consequence: consequence,
                    threatsource: threatsource,
                    selectedThreatOptions: selectedThreatOptions,
                    selectedMitigationOptions: selectedMitigationOptions,
                    safety: safety,
                    life: life,
                    production: production,
                    reputation: reputation,
                    environment: environment,
                    regulatory: regulatory,
                    data: data,
                    sm: sm,
                    mel: mel,
                    rrm: sa,
                    standards: standards

                },
                success: function (response) {

                   document.getElementById('SArange').value = response.adjustedSeverity;
                   document.getElementById('MELarange').value = response.adjustedExposure;
                   document.getElementById('txtRRa').value = response.adjustedRR

                   document.getElementById('txtControlAnalysis').value = response.controls;
                   document.getElementById('txtScenarioAnalysis').value = response.recommendations;
                     $('#loadingSpinner').hide();

                },
                error: function (xhr, status, error) {
                    // Handle any errors that occur during the AJAX call
                    console.error(error);
                    $('#loadingSpinner').hide();
                },
            });
        }


</script>


</body>
</html>
