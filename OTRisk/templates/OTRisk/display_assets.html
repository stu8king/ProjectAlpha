{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Data Display</title>
     <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

<link rel="stylesheet" type="text/css" href="{% static 'css/otriskstyle.css' %}">
<style>
    .scale-table {
        transform: scale(0.5);
        transform-origin: top left;
        width: 200%; /* Keeps the original scaling for the table */
    }
    #network {
        width: 100%;
        height: 80vh; /* Increased height to accommodate larger diagrams */
        overflow: scroll; /* Auto will only show scroll bars when necessary */
        margin-top: 1rem; /* Keep minimal space to maintain layout integrity */
        border: 1px solid #ccc; /* Helps define the boundary of the network diagram */
    }
    svg {
        display: block; /* Prevents extra space/margin below the SVG */
        width: 100%; /* Ensures SVG scales with the container width */
        min-height: 50%; /* Minimum height to start with, can be larger depending on content */
        overflow: scroll;
    }
</style>


</head>
<body>
    <div class="container-fluid">
        <div class="row">
            {% include 'menu_bar.html' %}
            <main role="main" class="col-md-10 ml-sm-auto col-lg-12  custom-main-content" >
            <div class="top-strip">
                <h1 class="page-title">Assets@AnzenOT </h1>
            </div>
         <div class="container mt-4">
         <div class="row">
         <div class="col">
        <h2 class="mb-4">Exalens Incidents</h2>
         <div class="scale-table">
         <table class="table table-striped" id="assetsTable">
            <thead>
                <tr>
                  <th>Incident ID</th>
                  <th>Inc. Number</th>
                  <th>Classification</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th>First Seen</th>
                  <th>Last Seen</th>
                  <th>Duration (s)</th>
                  <th>Occurrences</th>
                  <th>Source IP</th>
                  <th>Destination IP</th>
                  <th>Category</th>
                  <th>Strength</th>
                  <th>Actor</th>
                </tr>
            </thead>
            <tbody style="color:white">
                {% for incident in data %}
                    <tr>
                        <td>{{ incident.incident_id }}</td>
                        <td>{{ incident.incident_no }}</td>
                        <td>{{ incident.classification }}</td>
                        <td>{{ incident.detection_name }}</td>
                        <td>{{ incident.status }}</td>
                        <td>{{ incident.first_seen_utc }}</td>
                        <td>{{ incident.last_seen_utc }}</td>
                        <td>{{ incident.duration }}</td>
                        <td>{{ incident.occurrances }}</td>
                        <td>{{ incident.src_hostname }}</td>
                        <td>{{ incident.dst_hostname }}</td>
                        <td>{{ incident.category }}</td>
                        <td>{{ incident.strength }}</td>
                        <td>{{ incident.actor }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="10">No data available</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="network"></div>
         </div>

         </div>
         </div>

    </div>
            </main>
        </div>
    </div>


<script type="application/json" id="graph-data">
    {{ graph_data_json|safe }}
</script>
<script>
     var graph = JSON.parse(document.getElementById('graph-data').textContent);
    var network = document.getElementById('network');
    var width = network.clientWidth;
    var height = network.clientHeight;

    var svg = d3.select("#network").append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`) // Ensures SVG is responsive
        .attr("preserveAspectRatio", "xMidYMid meet"); // Keeps aspect ratio

    // Create a lookup to find nodes by id to set up links correctly
    var nodeById = new Map(graph.nodes.map(node => [node.id, node]));

    // Filter links to ensure both source and target exist
    graph.links = graph.links.filter(link => nodeById.get(link.source) && nodeById.get(link.target));

    // Update link sources and targets to direct node references
    graph.links.forEach(link => {
        link.source = nodeById.get(link.source);
        link.target = nodeById.get(link.target);
    });

    // Initialize the simulation with force properties
    var simulation = d3.forceSimulation(graph.nodes)
        .force("link", d3.forceLink(graph.links).distance(50))
        .force("charge", d3.forceManyBody().strength(-100))
        .force("center", d3.forceCenter(width / 2, height / 2));

    // Create the link lines.
    var link = svg.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(graph.links)
        .enter().append("line")
        .attr("stroke-width", 2)
        .attr("stroke", "gray");

    // Create the node circles.
    var node = svg.append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(graph.nodes)
        .enter().append("circle")
        .attr("r", 5)
        .attr("fill", function(d) { return d.group === 1 ? "red" : "blue"; });

    // Draw node labels.
    var labels = svg.append("g")
        .attr("class", "labels")
        .selectAll("text")
        .data(graph.nodes)
        .enter().append("text")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) { return d.id });

    // Update positions each tick
    simulation.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });

        labels.attr("x", function(d) { return d.x; })
              .attr("y", function(d) { return d.y; });
    });


        $(document).ready(function() {
            $('#assetsTable').DataTable();  // Initialize the DataTable on the 'assetsTable'
        });
         </script>

</body>
</html>
