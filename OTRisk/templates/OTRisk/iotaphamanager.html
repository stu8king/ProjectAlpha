{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Home</title>
 <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
     <!-- Bootstrap Select JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script>
        $('select').selectpicker();
    </script>
    {% load bootstrap5 %}
     {% bootstrap_css %}
     {% bootstrap_javascript %}

    <style>

        #headertable tbody tr:hover {
        background-color: #f5f5f5; /* Change this to the color you want */
        }

       .navbar-scroll .nav-link,
        .navbar-scroll .navbar-toggler-icon,
        .navbar-scroll .navbar-brand {
          color: #ffffff;
        }

        /* Color of the navbar BEFORE scroll */
        .navbar-scroll {
          background-color: #000000;
            text-decoration-color: #FFFFFF;
        }


        /* Color of the links AFTER scroll */
        .navbar-scrolled .nav-link,
        .navbar-scrolled .navbar-toggler-icon,
        .navbar-scroll .navbar-brand {
          color: #262626;
        }

        .navbar-logo {
        position: absolute;
        top: 5px; /* Adjust this as needed */
        left: 5px; /* Adjust this as needed */
        height: 100px; /* Adjust this as needed */
        z-index: 10;
        }

            .col-md-2 {
        place-items: center;
        background-color: lightgrey;
    }

    .small-font {
        font-size: 0.8rem; /* adjust as needed */
   }
    </style>
</head>
<body style="background-color: black">
<nav class="navbar navbar-expand-lg navbar-scroll fixed-top shadow-0 border-bottom border-dark rounded">
  <div class="container-fluid d-flex justify-content-between">
   <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}"><img src="/static/images/logo1-2.jpg" style="height: 140px; width: 140px" class="navbar-logo" alt="">  </a>
      <h4 class="my-auto text-center flex-grow-1"><font color="white">CyberPHA Manager</font></h4>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> CyberPHA
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="{% url 'OTRisk:cyber_pha_manager' %}"> CyberPHA Manager</a></li>
                <li><a class="dropdown-item" href="{% url 'OTRisk:walkdown' %}"> Site Walkdown</a></li>
                <li><a class="dropdown-item" href="#">Workshop</a></li>
              </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:walkdown' %}" tabindex="-1" ><i class="bi bi-kanban"></i> Site Walkdown</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Reports</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" tabindex="-1" ><i class="bi bi-ui-checks-grid"></i> Admin</a>
      </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:profile' %}">
          <i class="bi bi-person-fill"></i> User: {{ user.first_name }} {{ user.last_name }}
        </a>

        </li>

        <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<form name="frmHeader" id="frmRAW" method="POST" action="{% url 'OTRisk:iotaphamanager' %}">
{% csrf_token %}
<br><br>
<div class="row" style="height: 10px; padding-top: 20px; background-color: black">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: darkgray"></div>

    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->
<div class="row" style="height: 10px">
    <div class="col-md-1 "></div>
    <div class="col-md-10 ">
     <div class="row" style="background-color: darkgray; height: 10px"></div>
   </div>
    <div class="col-md-1 "></div>
</div> <!-- dark grey stripe -->

<div class="row">
    <div class="col-md-1 bg-black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-8 bg-white">
        <br>
        <label for="headertable" class="form-label">Select a record in the table to view and edit the CyberPHA</label>
        <table id="headertable" class="table table-striped table-bordered small-font">
        <thead>
            <tr>
                <th>ID</th>
                <th>Site</th>
                <th>Type</th>
                <th>Unit</th>
                <th>Zone</th>
                <th>Leader</th>
                <th>Date</th>
                <!-- Add more <th> elements for each field in the RAWorksheet model -->
            </tr>
        </thead>
        <tbody>
            {% for pha_header_records in pha_header_records %}
                <tr data-id="{{ pha_header_records.ID }}">
                    <td>{{ pha_header_records.ID }}</td>
                    <td>{{ pha_header_records.FacilityName }}</td>
                    <td>{{ pha_header_records.FacilityType }}</td>
                    <td>{{ pha_header_records.AssessmentUnit }}</td>
                    <td>{{ pha_header_records.AssessmentZone }}</td>
                    <td>{{ pha_header_records.PHALeader }}</td>
                    <td>{{ pha_header_records.Date }}</td>
                    <!-- Add more <td> elements for each field in the RAWorksheet model -->
                </tr>
            {% endfor %}
        </tbody>
        </table>
        <script>
            $(document).ready(function() {
            $('#headertable').on('click', 'tbody tr', function () {
                var recordId = $(this).data('id');  // get the ID of the clicked row
                sessionStorage.setItem('activeCyberPHA', recordId);
                $.ajax({
                    url: '/OTRisk/get_headerrecord',  // the URL of the view that will handle the request
                    data: {
                        'record_id': recordId
                    },
                    dataType: 'json',
                    success: function (data) {

                        $('#txtTitle').val(data.title);
                        $('#txtLeader').val(data.leader);
                        $('#selIndustry').val(data.industry);
                        $('#txtUnit').val(data.unit);
                        $('#txtFacility').val(data.facility);
                        $('#txtLeaderEmail').val(data.leaderemail);
                        $('#selFacilityType').val(data.facilitytype);
                        $('#selZone').val(data.zone);
                        $('#txtStartDate').val(data.startdate);
                        $('#txtEndDate').val(data.enddate);
                        $('#txtSafetySummary').val(data.safetysummary);
                        $('#txtChemical').val(data.chemicalsummary);
                        $('#txtPhysical').val(data.physicalsummary);
                        $('#txtOther').val(data.othersummary);
                        $('#txtAddress').val(data.address);
                        $('#btnformSubmit').prop('disabled', true);

                        sessionStorage.setItem('sessionIndustry', data.industry);
                        sessionStorage.setItem('sessionFacilityType', data.facilitytype);
                        sessionStorage.setItem('sessionFacility', data.facility);


                    }
                });
            });
        });



    </script>
    </div> <!-- table view of existing risk assessments -->
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-1 bg-black"></div>
</div>

<div class="row" style="height: 10px">
    <div class="col-md-1 "></div>
    <div class="col-md-10 ">
     <div class="row" style="background-color: darkgray; height: 10px"></div>
   </div>
    <div class="col-md-1 "></div>
</div> <!-- dark grey stripe -->
<div class="row">
        <div class="col-md-1 "></div>
        <div class="col-md-10 ">
         <div class="row" style="background-color: darkgray; height: 40px; border: 1px solid black;">
             <div class="col-md-1 text-left">
             </div>
             <div class="col-md-2 text-left" style="background-color: darkgray">
                <h5 style="background-color: darkgray">CyberPHA Header</h5>
             </div>
             <div class="col-md-3 text-left"></div>
            <div class="col-md-6 text-right">
                <button type="submit" id="btnformSubmit" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-secondary" id="resetButton">Reset</button>
                <script>
                $(document).ready(function() {
                    $('#resetButton').on('click', function() {
                        // Reset textboxes and textareas
                        $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtAddress, #txtFacility, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther').val('');

                        // Reset select dropdowns
                        $('#selIndustry, #selFacilityType, #selZone').prop('selectedIndex', 0);
                        $('#btnformSubmit').prop('disabled', false);
                    });
                });

            </script>
                <button type="button" class="btn btn-dark" id="scenarioButton">Scenarios</button>

                <script>
                     $(document).ready(function() {
                        $('#scenarioButton').on('click', function() {
                            window.location.href = "{% url 'OTRisk:assess_cyberpha' %}?active_cyberpha=" + sessionStorage.getItem('activeCyberPHA');
                        });
                     });
                </script>
             </div>
        </div>

       </div>
        <div class="col-md-1 "></div>
    </div> <!-- dark grey stripe with submit/reset buttons-->
<div class="row" style="height: 10px">
    <div class="col-md-1 "></div>
    <div class="col-md-10 ">
     <div class="row" style="background-color: darkgray; height: 10px"></div>
   </div>
    <div class="col-md-1 "></div>
</div> <!-- dark grey stripe -->

<div class="row small-font">
    <div class="col-md-1 bg-black"></div>
    <div class="col-md-1" style="background-color: darkgray"></div>
    <div class="col-md-3 bg-white">
        <label for="txtTitle">Title</label><input type="text" class="form-control" name="txtTitle" id="txtTitle">
        <label for="txtLeader">Leader</label><input type="text" class="form-control" name="txtLeader" id="txtLeader">
        <label for="selIndustry">Industry</label>
        <select class="form-control" name="selIndustry" id="selIndustry">
            <option> -- Select Industry -- </option>
            {% for industries in industries %}
                    <option value="{{ industries.Industry }}">{{  industries.Industry }}</option>
                {% endfor %}
        </select>
        <label for="txtUnit">Unit</label><input type="text" class="form-control" name="txtUnit" id="txtUnit">
        <label for="txtStartDate">Start Date</label><input type="date" class="form-control" name="txtStartDate" id="txtStartDate">
        <label for="txtAddress">Address</label><textarea class="form-control" rows="2" name="txtAddress" id="txtAddress" style="resize: none"></textarea>
        <br>

    </div>
    <div class="col-md-3 bg-white">
        <label for="txtFacility">Facility</label><input type="text" class="form-control" name="txtFacility" id="txtFacility">
        <label for="txtLeaderEmail">Leader Email</label><input type="text" class="form-control" name="txtLeaderEmail" id="txtLeaderEmail">
        <label for="selFacilityType">Facility Type</label>
        <select class="form-control" name="selFacilityType" id="selFacilityType">
            <option> -- Select Facility Type -- </option>
            {% for facilities in facilities %}
                    <option value="{{ facilities.FacilityType }}">{{  facilities.FacilityType }}</option>
                {% endfor %}
        </select>
        <label for="selZone">Zone</label>
        <select class="form-control" name="selZone" id="selZone">
            <option> -- Select Plant Zone -- </option>
            {% for zones in zones %}
                    <option value="{{ zones.PlantZone }}">{{  zones.PlantZone }}</option>
            {% endfor %}
        </select>
        <script>
            $(document).ready(function() {
                $('#selZone').select2();
            });
        </script>
        <label for="txtEndDate">End Date</label><input type="date" class="form-control" name="txtEndDate" id="txtEndDate">

    </div>

    <div class="col-md-3" style="background-color: darkgray">
        <button id="risk-assessment-btn" type="button" class="btn btn-link">Assess Facility Profile</button><br>
        <p style="font-size: 10px">A valid address, industry, and facility name must be entered for the risk profile to be accurately assessed. Profiles are generated by a machine-learning algorithm and may slightly vary given the same inputs at different times</p>
        <label for="txtSafetySummary">Safety Summary:</label><textarea rows="2" name="txtSafetySummary" id="txtSafetySummary" class="form-control" style="resize: none"></textarea>
        <label for="txtChemical">Chemical Storage:</label><textarea rows="2" name="txtChemical" id="txtChemical" class="form-control" style="resize: none"></textarea>
        <label for="txtPhysical">Physical Security:</label><textarea rows="2" name="txtPhysical" id="txtPhysical" class="form-control" style="resize: none"></textarea>
        <label for="txtOther">Other Local Risks:</label><textarea rows="2" name="txtOther" id="txtOther" class="form-control" style="resize: none"></textarea>

    <script>
        // AJAX function call on button click
        $(document).ready(function () {
            $("#risk-assessment-btn").click(function () {
                // Call the function to assess the risk
                assessRisk();
            });
        });

        // AJAX function to call the Django view
        function assessRisk() {
            $('#loadingSpinner').show();
            // Gather the necessary data for the AJAX request (impact scores and scenario information)
            let address = document.getElementById('txtAddress').value;
            let facilityType = document.getElementById('selFacilityType').value;
            let industry = document.getElementById('selIndustry').value;


            // Make the AJAX call to the Django view using a separate endpoint for risk assessment
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:facility_risk_profile' %}",  // URL for the Django view
                data: {
                    // Pass the impact scores and scenario information as parameters
                    industry: industry,
                    facility_type: facilityType,
                    address: address
                },
                success: function (response) {

                    // Write the response data to the textboxes
                    document.getElementById('txtSafetySummary').value = response.safety_summary;
                    document.getElementById('txtChemical').value = response.chemical_summary;
                    document.getElementById('txtPhysical').value = response.physical_security_summary;
                    document.getElementById('txtOther').value = response.other_summary;
                     $('#loadingSpinner').hide();

                },
                error: function (xhr, status, error) {
                    // Handle any errors that occur during the AJAX call
                    console.error(error);
                    $('#loadingSpinner').hide();
                },
            });
        }

    </script>




    </div>
    <div class="col-md-1 bg-black"></div>
</div>


</form>

<script>
    $(document).ready(function(){
    $('#headertable').dataTable( {
        "pageLength": 5,
            "lengthChange": false

    } );
});

</script>
</body>
</html>