{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<!--suppress ALL -->
<html lang="">
<head>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">

 <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
    function initMap() {

    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJu4p9r_vFL9g5nzctO4yLbNxjK08q4G0&loading=async&callback=initMap"></script>
<script src="{% static "js/connector_charts.js" %}"></script>




     <!-- Bootstrap Select JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'anychart/dist/js/anychart-bundle.min.js' %}"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!-- <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-core.min.js" type="text/javascript"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script> -->
    {% load django_bootstrap5 %}
     {% bootstrap_css %}
     {% bootstrap_javascript %}

<link rel="stylesheet" type="text/css" href="{% static 'css/info_block.css' %}">
<style>
body {
    background-color: #464748;
    color: #d3d1cd;
}
.sidebar {
    display: flex;
    height: 100vh;
    background-color: #2D2E30; /* Darker shade for sidebar */
    padding: 1vw;
    width: 10vw; /* Sidebar width */
    border-right: 0.5px solid #65c8d0; /* Added right border */
    box-shadow: 1px 0 3px rgba(0, 0, 0, 0.1);
}

.sidebar-logo {
    padding: 1vw;
    text-align: center;
}
.nav-sidebar .nav-link img {
    width: 1.25em; /* Scales with the font size */
    height: 1.25em; /* Scales with the font size */
}
.nav-sidebar {
    display: flex;
    flex-direction: column;
    padding-left: 0;
    list-style: none;
}
.nav-sidebar .nav-item {
    padding: 0.1vw;
    /* border-bottom: 1px solid  #fac330; /* Light orange line */
    margin: 0 10%;
    gap: 1rem;
}
.nav-sidebar .nav-link {
    color: #d3d1cd;
    border-radius: 0;
    transition: color 0.3s ease-in-out;
    font-size: 0.7rem;
}
.nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
    background-color: #3A5F5F;
    color: #E0E0E0;
}

.table-responsive {
    max-width: 100%; /* Ensure table fits within the parent */
    overflow-x: auto; /* Allow horizontal scrolling if needed */
}
#map {
    height: 400px;
    width: 100%;
}

#headertable button {
    background-color: #007bff;
    color: #fff;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.3s;
}

#headertable button:hover {
    background-color: #0056b3;
}
        table.dataTable thead th {
            color: #ffffff;
        }
        table.dataTable tbody td {
            color: #000B1D;
        }
        table.dataTable {
            width: 100%;
            border-collapse: collapse;
        }
        table.dataTable thead th,
        table.dataTable tbody td {
            padding: 8px;
            text-align: left;
        }


        table.dataTable tbody tr.selected {
            background-color: #4CAF50 !important;
            color: #ffffff;
        }
           .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #d3d1cd !important;
            background-color: #333333 !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            color: #ffffff !important;
            background-color: #565656 !important;
        }

#assessment_summary {
    display: block; /* Make the span behave like a block element */
    background-color: #f2f2f2; /* Light grey background */
    border-left: 5px solid #4CAF50; /* Green left border for emphasis */
    padding: 10px; /* Padding inside the container */
    margin-top: 20px; /* Margin at the top */
    margin-bottom: 10px; /* Margin at the bottom */
    font-family: Arial, sans-serif; /* Font family */
    font-size: 14px; /* Font size */
    color: #000; /* Text color */
    border-radius: 5px; /* Rounded corners */
}

#assessment_score {
    display: block; /* Make the span behave like a block element */
    font-weight: bold; /* Make the text bold */
    font-size: 16px; /* Larger font size for emphasis */
    color: #f7f8f7; /* Green color to match the border of the summary */
    margin-bottom: 20px; /* Bottom margin */
}

  #risk_score_container {
    width: 100%;
    height: 20vh;
    margin: 0 auto; /* Center the chart horizontally */
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ccc; /* Light border */
    border-radius: 10px; /* Rounded corners */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
    padding: 10px; /* Padding inside the container */
    box-sizing: border-box; /* Include padding in width and height calculations */
}

#risk_score_number {
    font-size: 1em; /* Increase the font size */
    text-align: center;
    color: #fff; /* White text color for better contrast */
    margin-top: 10px; /* Space above the text */
}

    /* Hide the first column */
.hidden-column {
    display: none;
}
.highlighted {
    background-color: #65C8D0 !important;
    color: black !important;
}
.selected {
            background-color: #65C8D0 !important;
            color: black !important;
        }
        .selectable-row {
            cursor: pointer;
        }
/* Base style for the delete button */
.delete-btn {
    background-color: #ff6666 !important; /* Base red color */
    color: white !important; /* White text */
    border: none !important; /* Remove default border */
    border-radius: 4px !important; /* Rounded corners */
    padding: 10px 20px !important; /* Padding for the button */
    cursor: pointer !important; /* Pointer cursor on hover */
    text-align: center !important; /* Center the text */
    text-decoration: none !important; /* Remove text underline */
    display: inline-block !important; /* Display inline-block */
    transition: background-color 0.3s, color 0.3s !important; /* Smooth transition for hover effects */
}

/* Hover effect for the delete button */
.delete-btn:hover {
    background-color: #ff3333 !important; /* Darker shade of red on hover */
}
.scaled-text {
    font-size: 75%; /* Scale the font size to 75% */
}
        .btn-custom {
            width: 95%;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            color: #000;
            background-color: #65c8d0;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .btn-custom:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn-custom:active {
            background-color: #004085;
            transform: translateY(1px);
        }

        .btn-custom i {
            margin-right: 8px;
        }
        /* Progress Bar Container */
.progress-bar-container {
    width: calc(100% - 2vw); /* Adjust the width to align with the custom-main-content padding */
    margin-left: 5vw; /* Align with the custom-main-content margin */
    height: 20px;
    background-color: #e0e0e0; /* Background color of the progress bar container */
    border-radius: 10px;
    margin-bottom: 20px; /* Space between the progress bar and the tab content */
}


/* Progress Bar */
.progress-bar {
    height: 100%;
    width: 0%; /* Initial width of the progress bar, will be updated dynamically */
    background-color: #007bff; /* Progress bar color */
    border-radius: 10px;
}
.form-group-phaform {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 5px; /* Optional: for internal spacing */
}
.form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}
#list, #connector, #tools, #physical, #asset, #threat, #insight, #strategy, #safety, #chemical, #compliance {
        display: none;
    }
.switch {
  position: relative;
  display: inline-block;
  width: 3rem;
  height: 1.4rem;
}
.switch-container {
  text-align: center;
  margin-bottom: 15px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 1rem;
}

.slider:before {
  position: absolute;
  content: "";
  height: 1rem;
  width: 1rem;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #65c8d0;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

/* Show/Hide label */
.switch-label {
  display: block;
  margin-left:5px;
  font-size: 10px;
  color: #fff;
}

@media (min-width: 768px) {
    .nav-sidebar .nav-link img {
    width: 1.5em;
    height: 1.5em;
    }
}
/* Even larger icons for desktops */
@media (min-width: 992px) {
    .nav-sidebar .nav-link img {
    width: 1.75em;
    height: 1.75em;
    }
}
@media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
     .sub-menu {
        left: 0;
        width: 100px; /* Adjust for smaller screens */
    }


}
.custom-main-content {

min-height: 100vh; /* Ensure it fills the viewport height */
}
@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: 100%;

        margin-left: 4vw;
    }
}

     .page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.5rem; /* Adjust size as needed */
}
     .top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 100px; /* Align with the end of the sidebar */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}
     .sub-menu {
    position: fixed; /* Fixed position to stay in view */
    top: 0; /* Align with the top of the viewport */
    left: 10vw; /* Position the sub-menu right next to the sidebar */
    width: 5vw; /* Width of the sub-menu */
    height: 100vh; /* Full viewport height */
    /* background-color: #333; /* Sub-menu background color */
    color: #fff; /* Text color */
    padding: 0.5vw ; /* Padding */
    box-sizing: border-box; /* Include padding in width calculation */
    font-size: 0.8rem;
}
.sub-menu ul {
    list-style: none; /* Remove default list styling */
    padding: 0; /* Remove default padding */
    margin: 0; /* Remove default margin */
}

.sub-menu li a {
    color: #d3d1cd; /* Link color */
    text-decoration: none; /* Remove underline */
    display: block; /* Make the links fill the container */
    padding: 10px 0; /* Padding for touch targets */
    transition: background-color 0.3s; /* Smooth transition for hover effect */
}
.sub-menu li a:hover, .sub-menu li a.active {
    background-color: #57595b; /* Hover/active background color */
}
#darktrace_tactics {
    width: 100%;
    height: 100%;
    position: relative;
}

.anychart-container {
    width: 100% !important;
    height: 100% !important;
    position: relative !important;
}
     .summary-box {
            flex: 0 1 calc(33.333% - 20px); /* 1 boxes per row accounting for gap */
            font-size: 0.7em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* External shadow */
            padding: 5px;
            background-color: #fff;
            border-radius: 5px; /* Slightly rounded corners for a modern look */
            margin-bottom: 20px; /* Space between rows */
            box-sizing: border-box;
            height: auto; /* Adjust height based on content */
            background-repeat: no-repeat;
            background-position: 1px top; /* Adjust the position as needed */
            background-size: 20px 20px; /* Adjust the size of the icon as needed */
        }
        .summary-container {
            display: flex;
            flex-wrap: wrap;
            gap: 7px; /* Space between boxes */
            justify-content: flex-start;
            padding: 20px;
        }

        .safety-summary-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px; /* Space between boxes */
    justify-content: flex-start;
    padding: 20px;
}

.safety-summary-box {
    flex: 0 1 calc(33.333% - 20px); /* 3 boxes per row accounting for gap */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* External shadow */
    padding: 10px;
    background-color: #fff;
    border-radius: 5px; /* Slightly rounded corners for a modern look */
    margin-bottom: 20px; /* Space between rows */
    box-sizing: border-box;
    height: auto; /* Adjust height based on content */
    /* background-image: url('/static/images/green_cube.png'); /* Path to your static image */
    background-repeat: no-repeat;
    background-position: 1px top; /* Adjust the position as needed */
    background-size: 20px 20px; /* Adjust the size of the icon as needed */
}
.organize-container {
    display: flex;
    justify-content: center;
    width: 100%;
}
.hidden-column {
    display: none;
}

.th-title {
    width: 40% !important;
}

.th-site, .td-site {
    width: 20% !important;
}

.th-type, .td-type {
    width: 20% !important;
}

.th-empty {
    width: 10% !important;
}

.form-label {
    color: white;
}

.report-button, .delete-btn {
    width: 100%; /* Adjust as needed */
}
    .inset-container {
        padding: 10px; /* Padding inside the container */
        border: 0.5px solid #65c8d0; /* Half-pixel border */
        background: inherit; /* Keep the same background color */
        box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.6), inset -3px -3px 6px rgba(255, 255, 255, 0.4); /* Enhanced inset shadow for a more obvious effect */
        display: inline-block; /* Adjust to content size */
        border-radius: 5px; /* Slight rounding for a smoother look */
    }

    .inset-label {
        font-size: 18px;
        color: #fff; /* White text */
        margin: 0; /* Remove default margin */
    }
.assignGroupModal
 {
/* bug fix - no overlay */
display: none;}

</style>

</head>
<body style="background-color: #464748">
<script>

isUserChange = false;
anychart.licenseKey("{{ anychart_key }}");
sessionStorage.setItem('fid', 0);

sessionStorage.setItem('activeCyberPHA','');
sessionStorage.setItem('sessionCountry','');
sessionStorage.setItem('sessionFacility','');
sessionStorage.setItem('sessionFacilityType','');
sessionStorage.setItem('sessionIndustry','');

function expandFacilityDetails() {
    var scenarioDetailsBlock = $(".info-block:contains('Assessment Facility')");
    var blockBody = scenarioDetailsBlock.find(".block-body");
    blockBody.show();
    scenarioDetailsBlock.find(".toggle-body").text("-");
    scenarioDetailsBlock.css('z-index', ++zIndexCounter);
    //closeScenarioList();
}

    //disable all controls and reset local session variable when form loads
    document.addEventListener('DOMContentLoaded', function() {


        document.getElementById("txtTitle").setAttribute('disabled', true);
        document.getElementById("txtLeader").setAttribute('disabled', true);

        document.getElementById("txtUnit").setAttribute('disabled', true);
        document.getElementById("txtStartDate").setAttribute('disabled', true);

        document.getElementById("txtLeaderEmail").setAttribute('disabled', true);
        document.getElementById("assessment_id").setAttribute('disabled', true);
        document.getElementById("selZone").setAttribute('disabled', true);
        document.getElementById("selSL").setAttribute('disabled', true);
        document.getElementById("txtEndDate").setAttribute('disabled', true);
        document.getElementById("txtSafetySummary").setAttribute('disabled', true);
        document.getElementById("txtChemical").setAttribute('disabled', true);
        document.getElementById("txtPhysical").setAttribute('disabled', true);
        document.getElementById("txtOther").setAttribute('disabled', true);
        document.getElementById("txtCompliance").setAttribute('disabled', true);
        document.getElementById("threatSummary").setAttribute('disabled', true);
        document.getElementById("insightSummary").setAttribute('disabled', true);
        document.getElementById("strategySummary").setAttribute('disabled', true);
         $('#risk-assessment-btn').prop('disabled', true);
         $('#btnformSubmit').prop('disabled', true);
         $('#scenarioButton').prop('disabled', true);
         $('#generatePPT').prop('disabled', true);

         const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('record_id');

        if (recordId) {
            // Call the function to fetch and display the record
            fetchHeaderRecord(recordId);

        }
});



function clearContainer(containerId) {
    var container = document.getElementById(containerId);
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
}

function drawGauge(score) {

    clearContainer('pha_gauge');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);

    gauge.background().fill("#333");

    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

    gauge.title("PHA Profile Rating (/100)");
    gauge.title().fontColor("#FFFFFF");
    gauge.title().fontSize(8);
    gauge.title().orientation("bottom");


    // Draw the chart
    gauge.container('pha_gauge').draw();
}

function drawControlGauge(score) {

    clearContainer('control_gauge');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);

     gauge.background().fill("#333");
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);
    gauge.title("Control Effectiveness %");
     gauge.title().fontColor("#FFFFFF");
    gauge.title().fontSize(8);
    gauge.title().orientation("bottom");
    // Draw the chart
    gauge.container('control_gauge').draw();
}

function showNotification(message, isError = false) {
    var notificationDiv = document.getElementById('notificationMessage');
    notificationDiv.innerHTML = message;
    notificationDiv.style.display = 'block';
    notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

    // Automatically hide the notification after some time
    setTimeout(function() {
        notificationDiv.style.display = 'none';
    }, 5000); // Hide after 5 seconds
}

var map;

</script>

<div class="container-fluid">
    <div class="row">
        {% include 'menu_bar.html' %}
        <div id="notificationMessage" class="notification-message" style="display: none;"></div>
        <!-- Main content area, including sub-menu and tabs -->
        <div class="col-md-9 col-lg-10">
        <div class="top-strip">
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md-1">

                </div>
                <div class="col-md-2">
                    <button type="submit" id="btnformSubmit" class="btn btn-custom nav-link" title="Click here to save the current facility information" style="transform: scale(0.8)"><i class="bi bi-floppy2-fill"></i> Save</button>
                    <div id="spinnerContainer" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>

                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-custom nav-link " id="resetButton" title="Click here to begin a new CyberPHA" style="transform: scale(0.8)"><i class="bi bi-plus-circle"></i> New</button>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-custom nav-link " id="scenarioButton" title="Click here to view scenarios for the currently selected facility " style="transform: scale(0.8)"><i class="bi bi-pencil-square"></i> Edit Scenarios</button>
                        <script>
                             $(document).ready(function() {
                                $('#scenarioButton').on('click', function() {
                                    window.location.href = "{% url 'OTRisk:assess_cyberpha' %}?active_cyberpha=" + sessionStorage.getItem('activeCyberPHA');
                                });
                             });
                        </script>
                </div>


                <div class="col-md-2">
                     <button type="button" id="copyAssessment" class="btn btn-custom nav-link" title="Creates a clone of the currently selected CyberPHA and related scenarios" style="transform: scale(0.8)"><i class="bi bi-copy"></i> Clone</button>
                        <script>
                        $(document).ready(function() {
                        // Event handler for the Copy button
                         $('#copyAssessment').click(function() {
                            Swal.fire({
                                title: 'Are you sure?',
                                text: "Do you wish to copy the currently selected CyberPHA Assessment?",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes',
                                cancelButtonText: 'Cancel'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    $('#facilityDetailsModal').modal('show');
                                    populateCountries();
                                }
                            });
                        });



                        // Form submission logic (to be expanded in further instructions)
                        $('#facilityDetailsForm').submit(function(event) {
                            event.preventDefault();
                            // Logic to handle form submission will go here
                            $('#facilityDetailsModal').modal('hide');
                        });
                    });

                    </script>
                </div>

            </div>
            <p></p><br>
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md-5">
                    <div class="inset-container">
                    <label id="lblCyberPHATitle" class="inset-label">CyberPHA Setup</label>
                    <p></p>
                </div>
                    <div id="progressBarContainerProfile" class="progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBarProfile"></div>
                    </div>
                    <span id="progressBarMessageProfile" style="display:block; text-align:center; margin-top:5px;"></span>
                </div>

                <div class="col-md-6"></div>
            </div>
        </div>
        <div id="notificationMessage" class="notification-message" style="display: none;"></div>
        <div class="spinner" id="loadingSpinner"></div>
        <form name="frmHeader" id="frmRAW" method="POST" action="{% url 'OTRisk:iotaphamanager' %}">
        {% csrf_token %}

     <input type="hidden" name="txtHdnCyberPHAID" id="txtHdnCyberPHAID" value="0">


     <input type="hidden" id="hdn_pha_score" name="hdn_pha_score" value="{{ pha_header_records.pha_score }}">

    <div class="sub-menu sub-menu-container small-font">
        <br><br><br><br><br><br><br><br><br><br>

        <br>
         <div id="block_selector">
             <div class="organize-container">
                <a href="#" id="organizeBlocks" style="display: block; color: white; margin-top: 10px;">Organize</a>
            </div>
             <br>
        <div class="switch-container">
            <span class="switch-label">CyberPHA List</span>
            <label class="switch">
                <input type="checkbox" data-block-id="list">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Connectors</span>
            <label class="switch">
                <input type="checkbox" data-block-id="connector">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Tools</span>
            <label class="switch">
                <input type="checkbox" data-block-id="tools">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Physical Security</span>
            <label class="switch">
                <input type="checkbox" data-block-id="physical">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">OT Asset</span>
            <label class="switch">
                <input type="checkbox" data-block-id="asset">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Threats</span>
            <label class="switch">
                <input type="checkbox" data-block-id="threat">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Insights</span>
            <label class="switch">
                <input type="checkbox" data-block-id="insight">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Strategy</span>
            <label class="switch">
                <input type="checkbox" data-block-id="strategy">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Safety</span>
            <label class="switch">
                <input type="checkbox" data-block-id="safety">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Chemicals</span>
            <label class="switch">
                <input type="checkbox" data-block-id="chemical">
                <span class="slider"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Compliance</span>
            <label class="switch">
                <input type="checkbox" data-block-id="compliance">
                <span class="slider"></span>
            </label>
        </div>
    </div>
     <div id="pha_gauge" style="display: none;"></div>
    <div id="control_gauge" style="display: none;"></div>

</div>
<script>
$(document).ready(function() {
    // Toggle the display of the submenu when the Facility Profile heading is clicked
    $('.facility-profile-heading').click(function(e) {
        e.preventDefault(); // Prevent the default anchor behavior
        // Toggle the submenu visibility
        $(this).children('.facility-profile-submenu').slideToggle('fast');
    });

    // Prevent the submenu from hiding when its items are clicked
    $('.facility-profile-submenu a').click(function(e) {
        e.stopPropagation(); // Stop the click event from propagating to the parent
    });
});
</script>
 <script>
    $(document).ready(function() {

        // Load Facility button click handler
        $('#loadFacilityButton').on('click', function () {
            // Fetch the list of facilities and populate the modal
            $.ajax({
                url: '/OTRisk/get_facilities/', // Adjust the URL to your actual endpoint
                type: 'GET',
                dataType: 'json',
                success: function (data) {

                    let facilitiesHtml = '';
                    data.facilities.forEach(function (facility) {
                        facilitiesHtml += `<li class="list-group-item list-group-item-action" data-id="${facility.id}">
                        ${facility.name}
                        </li>`;
                    });

                    $('#facilityList').html(facilitiesHtml);


                    // Add click event to each list item
                    $('#facilityList li').on('click', function () {
                        let facilityId = $(this).data('id');
                        loadFacility(facilityId);
                    });

                    // Show the modal
                    $('#loadFacilityModal').modal('show');

                },
                error: function (xhr, status, error) {
                    swal.fire("Error", "An error occurred while loading the facilities: " + error, "error");
                }
            });
        });
    });

    function loadFacility(facilityId) {
        $.ajax({
            url: `/OTRisk/get_facility/${facilityId}/`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                if (data && data.facility) {
                    // Populate form fields with the selected facility data
                    $('#facilityid').val(data.facility.id);
                    sessionStorage.setItem('fid', data.facility.id);
                    $('#lblFacilityName').text(data.facility.name);
                    $('#lblFacilityAddress').text(data.facility.address);
                    $('#lblFacilityIndustry').text(data.facility.industry__Industry);
                    $('#lblFacilityType').text(data.facility.type__type);
                    $('#lblFacilityEmployees').text(data.facility.employees);
                    $('#lblFacilityRevenue').text(data.facility.revenue);
                    $('#lblFacilityOC').text(data.facility.operating_cost);
                    $('#lblFacilityNPM').text(data.facility.profit_margin);
                    $('#lblFacilityShiftModel').text(data.facility.shift_model);
                    $('#txthdnLat').val(data.facility.lat);
                    $('#txthdnLong').val(data.facility.lon);
                    populateSummary("safetySummaryContainer", data.facility.safetySummary);
                    // populateSummary("chemicalContainer", data.facility.chemicalSummary);
                    populateSummary("physicalContainer", data.facility.physicalSummary);
                    populateSummary("complianceContainer", data.facility.complianceSummary);
                    populateChemicalJSON(JSON.parse(data.facility.type__chemprofile));
                    $('#txtChemical').val(data.facility.chemicalSummary);
                    $('#txtSafetySummary').val(data.facility.safetySummary);
                    $('#txtPhysical').val(data.facility.physicalSummary);
                    $('#txtCompliance').val(data.facility.complianceSummary);
                    drawGauge(data.facility.pha_score);
                    $('#hdn_pha_score').val(data.facility.pha_score);
                    $('#txthdnAQI').val(data.facility.aqi_score);
                    updateMapAndAQI(data.facility.lat, data.facility.lon, data.facility.address, ''); // Pass country if needed
                    // Close the modal
                    $('#loadFacilityModal').modal('hide');
                } else {
                    swal.fire("Error", "Failed to load facility details.", "error");
                }
            },
            error: function(xhr, status, error) {
                swal.fire("Error", "An error occurred while loading the facility: " + error, "error");
            }
        });
    }
</script>
    <script>
                    var mapPopulated = false;

                    function updateMapAndAQI(latitude, longitude, address) {
                        var hdnLat = document.getElementById('txthdnLat');
                        var hdnLong = document.getElementById('txthdnLong');
                        var mapElement = document.getElementById('facility_map');

                        var createMap = function(lat, lng, title) {
                            setTimeout(function() { // Introduce a delay
                            var latLng = new google.maps.LatLng(lat, lng);
                            var map = new google.maps.Map(mapElement, {
                                center: latLng,
                                zoom: 18,
                                mapTypeId: google.maps.MapTypeId.SATELLITE
                            });

                            var marker = new google.maps.Marker({
                                position: latLng,
                                map: map,
                                title: title || 'Selected Facility'
                            });
                            hdnLat.value = lat;
                            hdnLong.value = lng;

                            }, 100); // Delay in milliseconds, adjust as needed
                        };
                        createMap(parseFloat(latitude), parseFloat(longitude), 'Facility Location');

                    }

               function drawGoogleMap(latitude, longitude, address, country) {
                    var hdnLat = document.getElementById('txthdnLat');
                    var hdnLong = document.getElementById('txthdnLong');
                    var mapElement = document.getElementById('facility_map');

                    var createMap = function(lat, lng, title) {
                        setTimeout(function() { // Introduce a delay
                            var latLng = new google.maps.LatLng(lat, lng);
                            var map = new google.maps.Map(mapElement, {
                                center: latLng,
                                zoom: 18,
                                mapTypeId: google.maps.MapTypeId.SATELLITE
                            });

                            var marker = new google.maps.Marker({
                                position: latLng,
                                map: map,
                                title: title || 'Selected Facility'
                            });
                            hdnLat.value = lat;
                            hdnLong.value = lng;

                            mapPopulated = true;
                        }, 100); // Delay in milliseconds, adjust as needed
                    };

                    createMap(parseFloat(latitude), parseFloat(longitude), 'Facility Location');

                }


                </script>

     <div class="custom-main-content" >
        <div id="block_container" >
            <div class="row" id="block_rows">
                <div class="col-md-6" id="block_row_left">
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block1">
                            <div class="info-block" id="list">
                                    <div class="block-header">
                                        CyberPHA List
                                    <button type="button" class="toggle-body">+</button>
                                    </div>
                                    <div class="block-body">
                                        <div class="block-body-content" style="align-items: center; align-content: center">

                                            <div class="row" style="width: 95%" >
                                                <div class="col-md-col">

                                                <div class="form-group">
                                                    <label class="form-label" style="color:white">Select a record in the table to view and edit the CyberPHA</label>
                                                    <div >
                                                        <table id="headertable" class="table table-striped" style="color: #f0f0f0; ">
                                                            <thead >
                                                                 <tr>
                                                                <th class="th hidden-column">ID</th>
                                                            <th class="th-title">Title</th>
                                                            <th class="th-site">Site</th>
                                                            <th class="th-type">Type</th>
                                                            <th class="th-empty"></th>
                                                            <th class="th-empty"></th>
                                                            </tr>
                                                            </thead>
                                                            <tbody style="font-size: 10px">
                                                                {% for pha_header_records in pha_header_records %}
                                                                <tr data-id="{{ pha_header_records.ID }}" class="selectable-row">
                                                                    <td class="hidden-column">{{ pha_header_records.ID }}</td>
                                                                    <td >
                                                                    {{ pha_header_records.title }}
                                                                    {% if pha_header_records.is_default %}
                                                                        (Default Facility)
                                                                    {% endif %}
                                                                    </td>
                                                                    <td>{{ pha_header_records.FacilityName }}</td>
                                                                    <td>{{ pha_header_records.FacilityType }}</td>
                                                                    <input type="hidden" name="AssessmentUnit_{{ pha_header_records.ID }}" value="{{ pha_header_records.AssessmentUnit }}">
                                                                    <input type="hidden" name="AssessmentZone_{{ pha_header_records.ID }}" value="{{ pha_header_records.AssessmentZone }}">
                                                                    <input type="hidden" name="Industry_{{ pha_header_records.ID }}" value="{{ pha_header_records.Industry }}">

                                                                    <td>
                                                                        {% if pha_header_records.scenario_count != 0 %}
                                                                            <button type="button" class="report-button" onclick="window.open('{% url 'OTRisk:pha_reports' cyber_pha_header_id=pha_header_records.ID %}', '_blank')">Report</button>
                                                                        {% endif %}
                                                                    </td>

                                                                    <td>
                                                                    <button type="button" class="delete-btn" data-id="{{ pha_header_records.ID }}">Delete</button>

                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                        </table>
                                                     </div>
                                                </div>
                                                </div>

                                            </div>


                                        <script>
                                        $(document).ready(function() {
                                            function minimizeBlock(block) {

                                                var blockBody = block.find(".block-body");
                                                if (blockBody.is(":visible")) {
                                                    blockBody.toggle();
                                                    block.find(".toggle-body").text("+");
                                                }
                                            }
                                 // Event handler for clicking on a table row
                                 $('#headertable').on('click', 'tbody tr.selectable-row', function () {

                                     $('tr.selectable-row').removeClass('highlighted');
                                     $(this).addClass('highlighted');

                                     let recordId = $(this).data('id');  // get the ID of the clicked row
                                     let title = $(this).find('td:nth-child(2)').text();
                                     let facility = $(this).find('td:nth-child(3)').text();
                                     document.getElementById("lblCyberPHATitle").textContent = 'CyberPHA: ' + title + '@' + facility ;
                                     //make all the sub menu tabs active
                                     fetchHeaderRecord(recordId);
                  });

                                 // Check if a saved_record_id is provided in the rendered context
                                 let savedRecordId = "{{ saved_record_id }}";  // Get the saved_record_id from the Django context
                                 if (savedRecordId && savedRecordId !== "None") {
                                     $('tr[data-id="' + savedRecordId + '"]').addClass('highlighted');
                                     fetchHeaderRecord(savedRecordId);

                                 }


                             });

                         $(document).on('click', '.delete-btn', function() {
                        var recordId = $(this).data('id');
                        if(confirm('Are you sure you want to delete this record?')) {
                            $.ajax({
                                url: '{% url "OTRisk:delete_pha_record" %}',
                                type: 'POST',
                                data: {
                                    'id': recordId,
                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                },
                                success: function(response) {
                                    if(response.deleted) {
                                        window.location.reload();
                                    } else {
                                        alert('Error deleting record.');
                                    }
                                }
                            });
                        }
                    });
                        </script>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>
                    <!--block 3 scripts -->
                    <script>
                            $(document).ready(function() {
                            $('#assign-group-btn').on('click', function() {

                            var cyberphaId = sessionStorage.getItem('activeCyberPHA'); // Retrieve from session storage
                            var existingGroupId = $('#existing_group').val();
                            var newGroupName = $('#new_group_name').val();
                            var newGroupType = $('#new_group_type').val();

                            $.ajax({
                                type: 'POST',
                                url: '/OTRisk/assign_cyberpha_to_group/', // URL to Django view for assignment
                                data: {
                                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                                    'cyberpha_id': cyberphaId,
                                    'existing_group_id': existingGroupId,
                                    'new_group_name': newGroupName,
                                    'new_group_type': newGroupType
                                },
                                success: function(response) {
                                    // Handle success
                                    var assignGroupModal = new bootstrap.Modal(document.getElementById('assignGroupModal'));
                                    assignGroupModal.hide();

                                    updateGroupAssignmentsDisplay(cyberphaId); // Function to refresh group assignments on the page
                                    updateGroupList();
                                    $('#assignGroupModal').modal('hide');

                                },
                                error: function(error) {
                                    // Handle error
                                    console.error('Error:', error);
                                }
                            });
                        });
                    });

                    function updateGroupAssignmentsDisplay(cyberphaId) {
                        $.ajax({
                            type: 'GET',
                            url: '/OTRisk/fetch_groups/', // URL to a Django view that returns group assignments
                            data: { 'cyberpha_id': cyberphaId },
                            success: function(response) {
                                // Assuming 'response' contains an array of group names or objects
                                var currentGroupsDiv = $('#currentGroupsDiv');
                                currentGroupsDiv.empty();

                                if (response.groups && response.groups.length > 0) {
                                    response.groups.forEach(function(group) {
                                        // Assuming 'group' contains a property 'name'
                                        currentGroupsDiv.append($('<p>').text(group.name));
                                    });
                                } else {
                                    currentGroupsDiv.append($('<p>').text('No groups assigned.'));
                                }
                            },
                            error: function(error) {
                                console.error('Error fetching group assignments:', error);
                            }
                        });
                    }

                    function updateGroupList() {
                        $.ajax({
                            type: 'GET',
                            url: '/OTRisk/fetch_all_groups/', // URL to Django view
                            success: function(response) {
                                var existingGroupSelect = $('#existing_group');
                                existingGroupSelect.empty();

                                existingGroupSelect.append($('<option>', {
                                    value: '',
                                    text: 'Select a Group'
                                }));

                                response.groups.forEach(function(group) {
                                    existingGroupSelect.append($('<option>', {
                                        value: group.id,
                                        text: group.name
                                    }));
                                });
                            },
                            error: function(error) {
                                console.error('Error fetching groups:', error);
                            }
                        });
                    }


                    document.addEventListener('DOMContentLoaded', function() {
                        var workflowSelector = document.getElementById('workflow_selector');
                        workflowSelector.addEventListener('change', function() {
                            if (this.value === 'Complete') {
                                swal.fire({
                                    title: 'CyberPHA Completed?',
                                    text: "Once you save the status of this record as 'Complete', you will not be able to make further changes.",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Yes, I understand'
                                });
                            }
                        });
                    });

                    updateGroupList();
                    </script>
                    <script type="text/javascript">
                                    function validateEmail(input) {
                                        var regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                                        if (!regex.test(input.value)) {
                                            alert('Please enter a valid email address');
                                            input.focus();
                                        }
                                    }
                                </script>
                    <script type="text/javascript">
                                                    function validateDates() {
                                                        var startDate = document.getElementById('txtStartDate').value;
                                                        var endDate = document.getElementById('txtEndDate').value;

                                                        if (endDate < startDate) {
                                                            alert('End date cannot be before start date');
                                                            document.getElementById('txtEndDate').value = '';
                                                        }
                                                    }
                                                    </script>
                     <script>

                                                    $(document).ready(function() {

                                                        let isUserChange = false;
                                                        $("#assessment-select").selectmenu().selectmenu("menuWidget").addClass("overflow");

                                                         $('#assessment_id').change(function() {
                                                              if (!isUserChange) return;
                                                        var assessmentId = $(this).val();
                                                        var industry = document.getElementById('lblFacilityIndustry').textContent;
                                                        var facilityType = document.getElementById('lblFacilityType').textContent;

                                                        if(assessmentId  && isUserChange) {
                                                            Swal.fire({
                                                            title: 'Loading',
                                                            text: 'Please wait while we check and update the assessment summary...',
                                                            allowOutsideClick: false,
                                                            didOpen: () => {
                                                                Swal.showLoading();
                                                            }
                                                        });
                                                            $.ajax({
                                                                url: '/OTRisk/get_assessment_summary/',  // Update with the actual URL
                                                                type: 'POST',
                                                                data: { 'assessment_id': assessmentId,
                                                                            'industry': industry,
                                                                            'facilityType': facilityType,
                                                                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                                },
                                                                success: function(response) {
                                                                    Swal.close();
                                                                    isUserChange = false;
                                                                    $('#assessmentspinnerContainer').hide();
                                                                    if(response.error) {
                                                                        console.log(response.error);
                                                                    } else {
                                                                        $('#assessment_summary').text(response.summary);
                                                                        $('#assessment_score').text('Score: ' + response.score  + '/100');
                                                                        setBorderColorByScore(response.score);
                                                                        drawControlGauge(response.score);
                                                                        document.getElementById('last_assessment_score').value = response.score;
                                                                        document.getElementById('last_assessment_summary').value = response.summary;

                                                                    }
                                                                },
                                                                error: function(xhr, errmsg, err) {
                                                                    Swal.close();
                                                                    alert('AJAX call failed: ' + errmsg);
                                                                }
                                                            });
                                                        }

                                                     isUserChange = false;
                                                    });

                                                    $('#assessment_id').change(function() {
                                                        isUserChange = true; // Set true on any change event
                                                    });


                                                     function setBorderColorByScore(score) {
                                                        var borderColor = '#4CAF50'; // Default color
                                                        score = parseInt(score); // Convert score to integer

                                                        if (score < 30) {
                                                            borderColor = 'red';
                                                        } else if (score >= 30 && score <= 70) {
                                                            borderColor = 'yellow';
                                                        } // If score > 70, default green color is used

                                                        $('#assessment_summary').css('border-left', '5px solid ' + borderColor);
                                                    }
                                                   });
                                                </script>
                    <div class="flex-row">

                    <div class="col-md-12 flex-col" id="block3">
                                <div class="info-block" id="detail">
                                        <div class="block-header">
                                            Assessment Facility
                                            <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" style="align-items: center; align-content: center">
                                            <button type="button" class="btn btn-primary" id="loadFacilityButton" disabled>Load Facility</button>
                                            <p></p>
                                            <div class="row" style="width:95%"> <!-- data rows -->
                                                <div class="col-md-6">

                                                <div class="form-group">
                                                <input type="hidden" id="facilityid" name="facilityid" value="{{ current_pha_header.facility_id }}">
                                                <div class="row">
                                                    <div class="col-md-12">
                                                    <label style="color: #b7b9c0">Facility Name: &nbsp;&nbsp;</label><label name="lblFacilityName" id="lblFacilityName">{{ current_pha_header.facility.business_name }}</label><br>
                                                    <label style="color: #b7b9c0">Address: &nbsp;&nbsp;</label><label name="lblFacilityAddress" id="lblFacilityAddress" >{{ current_pha_header.facility.address }}</label><br>
                                                    <label style="color: #b7b9c0">Industry: &nbsp;&nbsp;</label><label name="lblFacilityIndustry" id="lblFacilityIndustry" >{{ current_pha_header.Industry }}</label><br>
                                                    <label style="color: #b7b9c0">Facility Type: &nbsp;&nbsp;</label><label name="lblFacilityType" id="lblFacilityType" >{{ current_pha_header.FacilityType }}</label><br>
                                                    <label style="color: #b7b9c0">Shift Model: &nbsp;&nbsp;</label><label name="lblFacilityShiftModel" id="lblFacilityShiftModel" >{{ current_pha_header.shift_model }}</label><br>
                                                    <label style="color: #b7b9c0">Employees: &nbsp;&nbsp;</label><label name="lblFacilityEmployees" id="lblFacilityEmployees" >{{ current_pha_header.EmployeesOnSite }}</label><br>
                                                    <label style="color: #b7b9c0">Revenue: &nbsp;&nbsp;</label><label name="lblFacilityRevenue" id="lblFacilityRevenue" >{{ annual_revenue_str|default:'0' }}</label><br>
                                                    <label style="color: #b7b9c0">Operating Cost/Hour: &nbsp;&nbsp;</label><label name="lblFacilityOC" id="lblFacilityOC" >{{ coho_str|default:'0' }}</label><br>
                                                    <label style="color: #b7b9c0">Net Profit Margin: &nbsp;&nbsp;</label><label name="lblFacilityNPM" id="lblFacilityNPM" >{{ coho_str|default:'0' }}</label><br>
                                                    <br>
                                                        <div class="form-group">
                                                    <label style="color: white">Air Quality Index (AQI):</label>
                                                    <div id="aqiGlobe" class="aqi-globe">--</div>
                                                        <input type="hidden" id="txthdnAQI">
                                                </div>
                                                    </div>
                                                </div>



                                        </div>

                                     </div>

                                                <div class="col-md-6" style="background-color: #464748;">
                                                <div id="facility_map" style="height: 95%; border:1"></div>
                                                <input type="hidden" id="txthdnLat" name="txthdnLat">
                                                <input type="hidden" id="txthdnLong" name="txthdnLong">
                                            </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
</div>

                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block5">
                            <div class="info-block" id="tools">
                                    <div class="block-header">
                                    Tools & Software
                                    <button type="button" class="toggle-body">+</button>
                                    </div>
                                    <div class="block-body">
                                        <div class="block-body-content" style="align-items: center; align-content: center">
                                        <h3 style="color: white">OT Tools & Software</h3>
                                        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
                                            <div class="card-body">
                                                <label style="color:white">List tools and software purchased to mitigate OT cybersecurity risks</label>
                                                <div class="table-responsive">
                                                    <table class="table" id="investmentTable">
                                                        <colgroup>
                                                            <col span="1" style="width: 50%;"> <!-- Vendor Name -->
                                                            <col span="1" style="width: 40%;"> <!-- Product Name -->
                                                            <col span="1" style="width: 10%;"> <!-- Action -->
                                                        </colgroup>
                                                        <thead>
                                                            <tr>
                                                                <th>Vendor Name</th>
                                                                <th>Product Name</th>
                                                                <th>Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    <select name="vendor_name[]" class="form-control vendor-select">
                                                                        <option value="">Select Vendor</option>
                                                                        {% for vendor in unique_vendors_json %}
                                                                            <option value="{{ vendor }}">{{ vendor }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <select name="product_name[]" class="form-control product-select">
                                                                        <option value="">Select Product</option>
                                                                    </select>
                                                                </td>
                                                                <td><button class="btn btn-danger removeRow">Remove</button></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    <button type="button" class="btn btn-primary" id="addRow">Add Row</button>
                                                </div>
                                            </div>
                                        </div>
                                            </div>
                                    </div>
                                        <script>
                            $(document).ready(function() {
                                var vendors = JSON.parse('{{ vendors_json|escapejs }}');
                                var uniqueVendors = JSON.parse('{{ unique_vendors_json|escapejs }}');

                                $("#addRow").click(function() {
                                    var newRow = `<tr>
                                        <td>
                                            <select name="vendor_name[]" class="form-control vendor-select">
                                                <option value="">Select Vendor</option>
                                                ${uniqueVendors.map(v => `<option value="${v}">${v}</option>`).join('')}
                                            </select>
                                        </td>
                                        <td>
                                            <select name="product_name[]" class="form-control product-select">
                                                <option value="">Select Product</option>
                                            </select>
                                        </td>
                                        <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
                                    </tr>`;
                                    $("#investmentTable tbody").append(newRow);
                                });

                                $(document).on('change', '.vendor-select', function() {
                                    var vendor = $(this).val();
                                    var productSelect = $(this).closest('tr').find('.product-select');
                                    var products = vendors.filter(v => v.vendor === vendor).map(v => v.product);

                                    productSelect.empty().append('<option value="">Select Product</option>');
                                    products.forEach(function(product) {
                                        productSelect.append(`<option value="${product}">${product}</option>`);
                                    });
                                });

                                $(document).on('click', '.removeRow', function() {
                                    $(this).closest('tr').remove();
                                });
                            });
                            </script>

                                </div>
                        </div>

                    </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block7">
                            <div class="info-block" id="asset">
                                    <div class="block-header">
                                    OT Asset Profile
                                    <button type="button" class="toggle-body">+</button>
                                    </div>
                                    <div class="block-body">
                                        <div class="block-body-content" style="align-items: center; align-content: center">
                                            <p style="color:white">OT devices most likely to be present within the facility</p>
                                                <div class="row" style="width:95%">
                                                    <div class="col">
                                                        <div class="form-group" style="width: 95%;">
                                                            <div id="otherContainer" class="safety-summary-container"></div>
                                                            <textarea rows="25" name="txtOther" id="txtOther" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.otherSummary }}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                    </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block9">
                            <div class="info-block" id="insight">
                                    <div class="block-header">
                                    Security Insights
                                    <button type="button" class="toggle-body">+</button>
                                    </div>
                                    <div class="block-body">
                                        <div class="block-body-content" style="align-items: center; align-content: center">
                                        <p style="color:white">Relevant OT Cybersecurity insights to consider for the facility</p>
                                         <div class="row" style="width:95%">
                                                <div class="col">
                                            <div class="form-group">
                                         <div id="insightContainer" class="safety-summary-container"></div>

                                                <textarea rows="25" name="insightSummary" id="insightSummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.insightSummary }}</textarea>
                                         </div>
                                                </div>
                                         </div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                    </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block11">
                            <div class="info-block" id="safety">
                                    <div class="block-header">
                                    Safety Profile <img src="{% static 'images/osha_safety.png' %}" style="width: 50px" class="img-fluid" alt="Logo">
                                    <button type="button" class="toggle-body">+</button>
                                    </div>
                                    <div class="block-body">
                                    <div class="block-body-content" style="align-items: center; align-content: center">
                                    <p style="color:white">Safety considerations for the facility</p>
                                    <div class="row" style="width:95%">
                                        <div class="col">
                                    <div class="form-group">
                                    <div id="safetySummaryContainer" class="safety-summary-container"></div>
                                    <textarea rows="25" name="txtSafetySummary" id="txtSafetySummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.safetySummary }}</textarea>
                                    </div>
                                        </div>
                                    </div>
                                </div>
                                    </div>
                                </div>
                        </div>

                    </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block13">
                            <div class="info-block" id="compliance">
                                    <div class="block-header">
                                    Compliance Profile
                                    <button type="button" class="toggle-body">+</button>
                                    </div>
                                    <div class="block-body">
                                    <div class="block-body-content" style="align-items: center; align-content: center">
                                     <p style="color:white">Regulatory compliance requirements for this facility</p>
                                     <div class="row" style="width:95%">
                                                <div class="col">
                                            <div class="form-group">
                                     <div id="complianceContainer" class="safety-summary-container"></div>
                                     <textarea rows="25" name="txtCompliance" id="txtCompliance" hidden class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.complianceSummary }}</textarea>
                                     </div>
                                                </div>
                                     </div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                        </div>
                </div>

            <div class="col-md-6" id="block_row_right">
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block2">
        <div class="info-block" id="config">
            <div class="block-header">
                CyberPHA Configuration
                <button type="button" class="toggle-body">+</button>
            </div>
            <div class="block-body">
                <div class="block-body-content" style="align-items: center; align-content: center;">

                    <div class="container-fluid" style="width: 100%;">
                        <div class="row" style="width: 95%;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtTitle" class="control-label text-light" title="Enter a descriptive title for this assessment">CyberPHA Title</label>
                                    <input type="text" class="form-control" name="txtTitle" id="txtTitle" value="{{ current_pha_header.title }}" maxlength="100" style="font-size: 0.9em;">
                                    <br>
                                    <label for="txtLeader" class="control-label text-light" title="Enter the name of the person leading this assessment">CyberPHA Owner</label>
                                    <input type="text" class="form-control" name="txtLeader" id="txtLeader" value="{{ current_pha_header.PHALeader }}" maxlength="100" style="font-size: 0.9em;">
                                    <br>
                                    <label for="txtLeaderEmail" class="control-label text-light" title="Enter the email address of the person leading this assessment">Email</label>
                                    <input type="email" class="form-control" name="txtLeaderEmail" id="txtLeaderEmail" value="{{ current_pha_header.PHALeaderEmail }}" onblur="validateEmail(this)" style="font-size: 0.9em;">
                                    <br>

                                        <label for="txtStartDate" class="control-label text-light" title="Enter the intended assessment start date">Start Date</label>
                                        <input type="date" class="form-control" name="txtStartDate" id="txtStartDate" value="{{ current_pha_header.AssessmentStartDate|date:'Y-m-d' }}" style="font-size: 0.9em;">
                                        <br>
                                        <label for="txtEndDate" class="control-label text-light" title="Enter the intended assessment end date">End Date</label>
                                        <input type="date" class="form-control" name="txtEndDate" id="txtEndDate" value="{{ current_pha_header.AssessmentEndDate|date:'Y-m-d' }}" onchange="validateDates()" style="font-size: 0.9em;">
                                        <br>

                                        <label for="txtUnit" class="control-label text-light" title="Enter the facility unit, if applicable, that's in scope for the current assessment">Unit</label>
                                        <input type="text" class="form-control" name="txtUnit" id="txtUnit" value="{{ current_pha_header.AssessmentUnit }}" maxlength="100" style="font-size: 0.9em;">
                                        <br>
                                        <label for="selZone" class="control-label text-light" title="Enter the facility zone, if applicable, that's in scope for the current assessment">Zone</label>
                                        <select class="form-control" name="selZone" id="selZone" style="font-size: 0.9em;">
                                            <option value=""> -- Select Plant Zone -- </option>
                                            {% for zone in zones %}
                                                <option value="{{ zone.PlantZone }}" {% if current_pha_header.AssessmentZone == zone.PlantZone %}selected{% endif %}>{{ zone.PlantZone }}</option>
                                            {% endfor %}
                                        </select>

                                </div>
                                <div class="form-group p-3" style="background-color: #ccc; border: 0.5px solid #65C8D0; border-radius: 5px; box-shadow: 0 0 3px #65C8D0;">
                                    <label class="control-label" style="color: black;" title="Check the box if there is an OT Cybersecurity Incident Response Plan for the facility">OT Incident Response (IR)</label>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="ir_plan" name="ir_plan" style="transform: scale(1.5); margin-right: 10px;">
                                        <label class="form-check-label" for="ir_plan" style="color: black;">OT IR Plan (Yes/No)</label>
                                    </div>

                                    <div class="form-group mb-3">
                                        <label for="ir_plan_date" class="control-label" style="color: black;" title="Enter the date that the Incident Response Plan was last tested">Last Tested Date</label>
                                        <input type="date" class="form-control" name="ir_plan_date" id="ir_plan_date" value="" style="font-size: 0.9em; width: 80%;">
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ir_plan_ut" name="ir_plan_ut" style="transform: scale(1.5); margin-right: 10px;">
                                        <label class="form-check-label" for="ir_plan_ut" style="color: black;">Never Tested</label>
                                    </div>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="selSL" class="control-label text-light" title="Select the targeted security level, if applicable, per ISA-62443-3-2 Annex A">Target Security Level (SL-T)</label>
                                    <select class="form-control" name="selSL" id="selSL" style="font-size: 0.9em;">
                                        <option value="0"> -- Select SL-T -- </option>
                                        {% for value, description in SECURITY_LEVELS %}
                                            <option value="{{ value }}" {% if current_pha_header.sl_t|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="assessment_id" class="control-label text-light" title="Select the control assessment questionnaire that applies to the facility. If no control assessment has been completed, click on Assessments in the menu to go to the assessments page">Control Assessment</label>
                                    <select class="form-control" id="assessment_id" name="assessment_id" style="font-size: 0.9em;">
                                        <option value="">Select an Assessment</option>
                                        {% for assessment in assessments %}
                                            <option value="{{ assessment.id }}" {% if current_pha_header.assessment == assessment.id %}select{% endif %}>{{ assessment.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="hidden" id="last_assessment_score" name="last_assessment_score">
                                    <input type="hidden" id="last_assessment_summary" name="last_assessment_summary">
                                    <div id="assessmentspinnerContainer" style="display: none;">
                                        <div class="spinner-border" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </div>
                                    <span id="assessment_summary" style="font-size:0.9em;"></span>
                                    <span id="assessment_score"></span>
                                </div>
                                <div class="form-group">
                                    <label for="walkdown_id" class="control-label text-light" title="Select the site walkdown questionnaire that applies to the facility. If no site walkdown has been completed, click on Assessments in the menu to go to the assessments page">Site Walk-Down Assessment</label>
                                    <select class="form-control" id="walkdown_id" name="walkdown_id" style="font-size: 0.9em;">
                                        <option value="">Select the site walkdown</option>
                                        {% for walkdown in walkdowns %}
                                            <option value="{{ walkdown.id }}" {% if current_pha_header.walkdown == walkdown.id %}select{% endif %}>{{ walkdown.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div id="walkdownspinnerContainer" style="display: none;">
                                        <div class="spinner-border" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </div>
                                    <span id="walkdown_summary"></span>
                                    <span id="walkdown_score"></span>
                                </div>
                                <div class="form-group text-light">
                                    Current Group Assignments:
                                    <div id="currentGroupsDiv" style="font-size: 0.9em;"></div>
                                    <button type="button" class="btn btn-primary mt-2" id="assigntogroupbtn" >Assign to Group</button>
                                    <script>
                                    $(document).ready(function() {

                                        $('#assigntogroupbtn').on('click', function () {
                                            $('#assignGroupModal').modal('show');

                                        })
                                    })
                                    </script>


                                </div>
                                <div class="form-group">
                                    <label for="workflow_selector" class="control-label text-light">Workflow Status</label>
                                    <select class="form-control" id="workflow_selector" name="workflow_selector" style="font-size: 0.9em;">
                                        <option value="">Select a Status</option>
                                        {% for status, status_display in workflow_status_choices %}
                                            <option value="{{ status }}" {% if current_workflow_status == status %} selected {% endif %}>{{ status_display }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#moderatorModal">Select CyberPHA Moderators</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                    </div>

                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block4">
                                <div class="info-block" id="connector">
                                    <div class="block-header">
                                    Third Party Connectors
                                    <button type="button" class="toggle-body">+</button>
                                    </div>
                                    <div class="block-body">
                                    <div class="block-body-content" style="align-items: center; align-content: center">
                                    <div class="row" style="width: 98%">
                                    <div class="col">
                                    <div class="form-group">
                                    <div class="row" >
                                        <div class="col-md-3">
                                            <label for="connector_select" style="color: white" title="Select the relevant installed internal solution that AnzenOT can connect to">Select Product:</label>
                                            <select class="form-control" id="connector_select" name="connector_select">
                                                <option value="">Select Connector</option>
                                                <option value="Darktrace" {% if current_pha_header.darktrace_client %}selected{% endif %}>Darktrace</option>
                                                <option value="Exalens" {% if current_pha_header.exalens_client and not current_pha_header.darktrace_client %}selected{% endif %}>Exalens</option>
                                            </select>
                                        </div>
                                        <div class="col-md-9">
                                        </div>
                                    </div>
                                    <br><br>
                                    <div id="darktraceConfig" style="display: none;">
                                        <br>
                                        <div class="row" style="width:98%">
                                            <div class="col-md-2 d-flex align-items-start">
                                                <img src="{% static 'images/darktrace_logo.png' %}" alt="Darktrace Logo" class="mb-3" style="width: 100px; margin-top: auto">
                                            </div>
                                            <div class="col-md-2 d-flex align-items-start">
                                                <a href="#" id="useDefaultsLink_darktrace" style="color:white">Use Defaults</a>
                                                <script>
                                                    $(document).ready(function() {
                                                        $('#useDefaultsLink_darktrace').click(function(event) {
                                                            event.preventDefault(); // Prevent the default link behavior

                                                            $.ajax({
                                                                url: '/OTRisk/darktrace_defaults/',
                                                                type: 'GET',
                                                                success: function(response) {
                                                                    $('#darktrace_host').val(response.darktrace_host);
                                                                    $('#darktrace_public_key').val(response.darktrace_public_key);
                                                                    $('#darktrace_private_key').val(response.darktrace_private_key);

                                                                    },
                                                                error: function(error) {
                                                                    console.log('Error fetching Exalens defaults:', error);
                                                                }
                                                            });
                                                        });
                                                    });


                                                    </script>
                                            </div>
                                            <div class="col-md-1">
                                                <button id="toggleColumnBtn" type="button" class="btn btn-secondary" style="color: white;"><<</button>
                                            </div>
                                            <div class="col-md-7">
                                             </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="row" style="width:98%">
                                                <div class="col-md-3" id="leftColumn">
                                                    <label for="darktrace_public_key">Public Key</label>
                                                    <input type="text" class="form-control" id="darktrace_public_key" name="darktrace_public_key" placeholder="Enter Darktrace Public Key">
                                                    <br>
                                                    <label for="darktrace_private_key">Private Key</label>
                                                    <input type="password" class="form-control" id="darktrace_private_key" name="darktrace_private_key" placeholder="Enter Darktrace Private Key">
                                                    <br>
                                                    <label for="darktrace_host">Host</label>
                                                    <input type="text" class="form-control" id="darktrace_host" name="darktrace_host" placeholder="Enter Darktrace Host">
                                                    <br>
                                                    <button id="DarktraceConnectionBtn" type="button" class="btn btn-primary">Connect to Darktrace</button>
                                                </div>
                                                <div class="col-md-9" id="rightColumn">
                                                    <div id="darktrace_risk_status" class="form-group">
                                                    <br>
                                                    <div class="row" >
                                                        <div class="col-md-6">
                                                            <div id="darktrace_control_status" class="scaled-text"></div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div id="darktrace_risk_statement" class="scaled-text"></div>
                                                        </div>
                                                    </div>
                                                    <br>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <label id="label_darktrace_incident_severity" name="label_darktrace_incident_severity" style="font-size: 1em">Incident Severity</label>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label id="label_darktrace_category" name="label_darktrace_category" style="font-size: 1em">Incident Category</label>
                                                         </div>

                                                    </div>

                                                    <div class="row" style="display: flex; align-items: center; justify-content: center">
                                                        <div class="col-md-6">
                                                            <div id="risk_score_container">
                                                                <div id="darktrace_tactics_container" style="width: 100%; height: 200px; position: relative;">
                                                                    <div id="darktrace_tactics" style="width: 100%; height: 100%;"></div>
                                                                </div>
                                                                                                                    <input type="hidden" id="hdn_darktrace_tactics" name="hdn_darktrace_tactics">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div id="risk_score_container">
                                                                <div id="darktrace_tactics_container" style="width: 100%; height: 200px; position: relative;">
                                                                <div id="darktrace_mitre" style="width: 100%; height: 100%; "></div>
                                                                </div>
                                                                <input type="hidden" id="hdn_darktrace_mitre" name="hdn_darktrace_mitre">
                                                            </div>
                                                        </div>


                                                    </div>
                                                        <div class="row">
                                                            <div class="col">

                                                            <div id="darktrace_risk_score_container">
                                                                 <div id="darktrace_risk_score_number"></div>
                                                            </div>
                                                            </div>
                                                        </div>


                                            </div>
                                        </div>
                                            </div>
                                        </div>
                                    </div>


                                             <!-- Exalens configuration fields -->
                                    <div id="exalensConfig" style="display: none;">
                                    <br>
                                       <div class="row" style="width:98%">

                                        <div class="form-group">
                                            <div class="row" style="width:98%">
                                                <div class="col-md-3" id="leftColumn">
                                                    <label for="exalensApiKey">Exalens API Key</label>
                                                    <input type="password" class="form-control" id="exalensApiKey" name="exalensApiKey" placeholder="Enter Exalens API Key">
                                                    <br>
                                                    <label for="exalensClientId">Exalens Client ID</label>
                                                    <input type="text" class="form-control" id="exalensClientId" name="exalensClientId" placeholder="Enter Exalens Client ID">
                                                    <br>
                                                    <label for="exalensIpAddress">Exalens IP Address</label>
                                                    <input type="text" class="form-control" id="exalensIpAddress" name="exalensIpAddress" placeholder="Enter Exalens IP Address">
                                                    <br>
                                                    <button id="ExalensConnectionBtn" type="button" class="btn btn-primary">Connect to Exalens</button>
                                                </div>
                                                <div class="col-md-9" id="rightColumn">
                                                    <div id="exalens_risk_status" class="form-group">
                                                        <br>

                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div id="control_status" class="scaled-text"></div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div id="risk_statement" class="scaled-text"></div>
                                                            </div>
                                                        </div>
                                                        <br>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label id="label_exalens_incident_severity" name="label_exalens_incident_severity" style="font-size: 1em">Incident Severity</label>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label id="label_exalens_category" name="label_exalens_category" style="font-size: 1em">Incident Category</label>
                                                             </div>

                                                        </div>
                                                         <div class="row" style="display: flex; align-items: center; justify-content: center">
                                                             <div class="col-md-6">
                                                                 <div id="risk_score_container">
                                                                <div id="exalens_severity_distribution" style="width: 100%; height: 200px;"></div>
                                                                 </div>
                                                            </div>

                                                             <div class="col-md-6">
                                                                 <div id="risk_score_container">
                                                                <div id="exalens_category_distribution" style="width: 100%; height: 200px;"></div>
                                                                 </div>
                                                            </div>


                                                         </div>
                                                        <div class="row">
                                                            <div class="col">
                                                            <div id="risk_score_chart" style="display:none"></div>
                                                            <div id="exalens_risk_score_container">
                                                                 <div id="risk_score_number"></div>
                                                            </div>
                                                            </div>
                                                        </div>
                                                        <br>
                                                        <div class="row" style="display: flex; align-items: center; justify-content: center">
                                                            <div class="col-md-6">

                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div id="risk_score_number"></div>
                                                                </div>
                                                             </div>
                                                         </div>
                                                    </div>
                                                </div>
                                            </div>
                                    </div>
                                                <input type="hidden" id="hdn_exalens_status" name="hdn_exalens_status">
                                                <input type="hidden" id="hdn_exalens_risk" name="hdn_exalens_risk">
                                                <input type="hidden" id="hdn_exalens_score" name="hdn_exalens_score">
                                                <input type="hidden" id="hdn_darktrace_status" name="hdn_darktrace_status">
                                                <input type="hidden" id="hdn_darktrace_risk" name="hdn_darktrace_risk">
                                                <input type="hidden" id="hdn_darktrace_score" name="hdn_darktrace_score">
                                                <div id="config-data"
                                                     data-darktrace-client="{{ current_pha_header.darktrace_client }}"
                                                     data-exalens-client="{{ current_pha_header.exalens_client }}"
                                                     data-exalens-api="{{ current_pha_header.exalens_api }}"
                                                     data-exalens-status="{{ current_pha_header.exalens_status }}"
                                                     data-exalens-risk="{{ current_pha_header.exalens_risk }}"
                                                     data-exalens-score="{{ current_pha_header.exalens_score }}"
                                                     data-darktrace-public-api="{{ current_pha_header.darktrace_public_api }}"
                                                     data-darktrace-private-api="{{ current_pha_header.darktrace_private_api }}"
                                                     data-darktrace-status="{{ current_pha_header.darktrace_status }}"
                                                     data-darktrace-risk="{{ current_pha_header.darktrace_risk }}"
                                                     data-darktrace-score="{{ current_pha_header.darktrace_score }}"
                                                     data-darktrace-tactics="{{ current_pha_header.darktrace_tactics_report }}"
                                                     data-darktrace-mitre="{{ current_pha_header.darktrace_mitre_report }}">
                                                </div>

                                                <script>
                                                function formatResponse(responseString) {

                                                    if (responseString == null || responseString.trim() === '') {
                                                        return '';
                                                    }
                                                    // Split the response string into an array using '-' as the delimiter and remove any empty elements
                                                    let responseArray = responseString.split('- ').filter(item => item.trim() !== '');

                                                    // Join the response array into a formatted string with each item as a list item
                                                    return responseArray.map(item => `<li>${item.trim()}</li>`).join('');
                                                }



                                                document.getElementById('DarktraceConnectionBtn').addEventListener('click', function() {
                                                var darktrace_host = document.getElementById('darktrace_host').value;
                                                var darktrace_public_key = document.getElementById('darktrace_public_key').value;
                                                var darktrace_private_key = document.getElementById('darktrace_private_key').value;

                                                $.ajax({
                                                    url: '/OTRisk/cyberpha_darktrace_connection/',
                                                    type: 'POST',
                                                    data: {
                                                        darktrace_host: darktrace_host,
                                                        darktrace_public_key: darktrace_public_key,
                                                        darktrace_private_key: darktrace_private_key,
                                                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                                                    },
                                                    beforeSend: function() {
                                                        Swal.fire({
                                                            title: 'Processing...',
                                                            text: 'Please wait while we retrieve the data.',
                                                            allowOutsideClick: false,
                                                            didOpen: () => {
                                                                Swal.showLoading()
                                                            }
                                                        });
                                                    },
                                                    success: function(response) {
                                                        // Update text content
                                                        let controlStatusString = Array.isArray(response["Control Status"]) ? response["Control Status"].join('- ') : response["Control Status"];
                                                        let riskStatementString = Array.isArray(response["Risk Statement"]) ? response["Risk Statement"].join('- ') : response["Risk Statement"];

                                                        // Format the responses
                                                        let formattedControlStatus = formatResponse(controlStatusString);
                                                        let formattedRiskStatement = formatResponse(riskStatementString);

                                                        // Update the innerHTML of the elements with formatted content
                                                        document.getElementById('darktrace_control_status').innerHTML = "<b>Darktrace Status:</b><ul>" + formattedControlStatus + "</ul>";
                                                        document.getElementById('darktrace_risk_statement').innerHTML = "<b>Inferred Risk:</b><ul>" + formattedRiskStatement + "</ul>";

                                                        document.getElementById('darktrace_risk_score_number').innerText = "Risk Score: " + response["Risk Score"] + "/100";
                                                        document.getElementById('hdn_darktrace_status').value = response["Control Status"];
                                                        document.getElementById('hdn_darktrace_risk').value = response["Risk Statement"];
                                                        document.getElementById('hdn_darktrace_score').value = response["Risk Score"];

                                                        //darktrace_risk_score_chart(response["Risk Score"]);
                                                        darktrace_incident_severity_DistributionChart(response["severity_of_incidents"]);
                                                        darktrace_tactics_DistributionChart(response["mitre_tactics_count"]);
                                                        var leftColumn = document.getElementById('leftColumn');
                                                        var rightColumn = document.getElementById('rightColumn');
                                                        var toggleButton = document.getElementById('toggleColumnBtn');
                                                        leftColumn.style.display = 'none';
                                                        rightColumn.classList.remove('col-md-9');
                                                        rightColumn.classList.add('col-md-12');
                                                        toggleButton.innerText = '>>';
                                                    },
                                                    complete: function() {
                                                        Swal.close();
                                                    },
                                                    error: function() {
                                                        Swal.fire({
                                                            icon: 'error',
                                                            title: 'Error',
                                                            text: 'Failed to retrieve the risk status.'
                                                        });
                                                    },

                                                });
                                            });



                                                document.getElementById('ExalensConnectionBtn').addEventListener('click', function() {
                                                var exalensIP = document.getElementById('exalensIpAddress').value;
                                                var exalensClientID = document.getElementById('exalensClientId').value;
                                                var exalensAPIKey = document.getElementById('exalensApiKey').value;

                                                $.ajax({
                                                    url: '/OTRisk/cyberpha_exalens_connection/',
                                                    type: 'POST',
                                                    data: {
                                                        exalens_ip: exalensIP,
                                                        client_id: exalensClientID,
                                                        api_key: exalensAPIKey,
                                                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                                                    },
                                                    beforeSend: function() {
                                                        Swal.fire({
                                                            title: 'Processing...',
                                                            text: 'Please wait while we retrieve the data.',
                                                            allowOutsideClick: false,
                                                            didOpen: () => {
                                                                Swal.showLoading()
                                                            }
                                                        });
                                                    },
                                                    success: function(response) {
                                                        // Update text content
                                                        document.getElementById('control_status').innerHTML = "<b>Exalens Status:</b> " + response["Control Status"];
                                                        document.getElementById('risk_statement').innerHTML = "<b>Inferred Risk:</b> " + response["Risk Statement"];

                                                        document.getElementById('risk_score_number').innerText = "Risk Score: " + response["Risk Score"] + "/100";
                                                        document.getElementById('hdn_exalens_status').value = response["Control Status"];
                                                        document.getElementById('hdn_exalens_risk').value = response["Risk Statement"];
                                                        document.getElementById('hdn_exalens_score').value = response["Risk Score"];
                                                        exalens_createSeverityDistributionChart(response["Severity Distribution"]);
                                                        exalens_createCategoryDistributionChart(response[ "Incident Category Breakdown"]);

                                                        exalens_risk_score_chart(response["Risk Score"]);

                                                    },
                                                    complete: function() {
                                                        Swal.close();
                                                    },
                                                    error: function() {
                                                        Swal.fire({
                                                            icon: 'error',
                                                            title: 'Error',
                                                            text: 'Failed to retrieve the risk status.'
                                                        });
                                                    },

                                                });
                                            });


                                            $(document).ready(function() {
                                                        var configData = $('#config-data').data();

                                                        var darktraceClient = configData.darktraceClient;
                                                        var exalensClient = configData.exalensClient;

                                                        if (darktraceClient !== "") {
                                                            $('#connector_select').val('Darktrace');
                                                        } else if (exalensClient !== "") {
                                                            $('#connector_select').val('Exalens');
                                                        } else {
                                                            $('#connector_select').val('');
                                                        }

                                                        $('#connector_select').change(function() {
                                                            var selectedValue = $(this).val();
                                                            if (selectedValue === 'Exalens') {
                                                                $('#exalensConfig').show();
                                                                $('#darktraceConfig').hide();

                                                                $('#exalensApiKey').val(configData.exalensApi);
                                                                $('#exalensClientId').val(exalensClient);
                                                                $('#exalensIpAddress').val(configData.exalensIp);

                                                                document.getElementById('control_status').innerHTML = "<b>Exalens Status:</b> " + configData.exalensStatus;
                                                                document.getElementById('risk_statement').innerHTML = "<b>Inferred Risk:</b> " + configData.exalensRisk;

                                                                document.getElementById('risk_score_number').innerText = "Risk Score: " + configData.exalensScore + "/100";
                                                                document.getElementById('hdn_exalens_status').value = configData.exalensStatus;
                                                                document.getElementById('hdn_exalens_risk').value = configData.exalensRisk;
                                                                document.getElementById('hdn_exalens_score').value = configData.exalensScore;

                                                                exalens_risk_score_chart(configData.exalensScore);
                                                            } else if (selectedValue === 'Darktrace') {
                                                                $('#darktraceConfig').show();
                                                                $('#exalensConfig').hide();

                                                                 $('#darktrace_public_key').val(configData.darktracePublicApi);
                                                                $('#darktrace_private_key').val(configData.darktracePrivateApi);
                                                                $('#darktrace_host').val(darktraceClient);

                                                                let controlStatusString = Array.isArray(configData.darkTraceStatus) ? configData.darkTraceStatus.join('- ') : configData.darkTraceStatus;
                                                                let riskStatementString = Array.isArray(configData.darktraceRisk) ? configData.darktraceRisk.join('- ') : configData.darktraceRisk;

                                                                // Format the responses
                                                                let formattedControlStatus = formatResponse(controlStatusString);
                                                                let formattedRiskStatement = formatResponse(riskStatementString);

                                                                // Update the innerHTML of the elements with formatted content
                                                                document.getElementById('darktrace_control_status').innerHTML = "<b>Darktrace Status:</b><ul>" + formattedControlStatus + "</ul>";
                                                                document.getElementById('darktrace_risk_statement').innerHTML = "<b>Inferred Risk:</b><ul>" + formattedRiskStatement + "</ul>";

                                                                document.getElementById('darktrace_risk_score_number').innerText = "Risk Score: " + configData.darktraceScore + "/100";
                                                                document.getElementById('hdn_darktrace_status').value = configData.darktraceStatus;
                                                                document.getElementById('hdn_darktrace_risk').value = configData.darktraceRisk;
                                                                document.getElementById('hdn_darktrace_score').value = configData.darktraceScore;

                                                                darktrace_incident_severity_DistributionChart(configData.darktraceTactics);
                                                                darktrace_tactics_DistributionChart(configData.darktraceMitre);
                                                                document.getElementById('hdn_darktrace_tactics').value = configData.darktraceTactics;
                                                                document.getElementById('hdn_darktrace_mitre').value = configData.darktraceMitre;

                                                                // darktrace_risk_score_chart(configData.darktraceScore);
                                                                var leftColumn = document.getElementById('leftColumn');
                                                                var rightColumn = document.getElementById('rightColumn');
                                                                var toggleButton = document.getElementById('toggleColumnBtn');
                                                                leftColumn.style.display = 'none';
                                                                rightColumn.classList.remove('col-md-9');
                                                                rightColumn.classList.add('col-md-12');
                                                                toggleButton.innerText = '>>';
                                                            } else {
                                                                $('#exalensConfig').hide();
                                                                $('#darktraceConfig').hide();
                                                            }
                                                        }).trigger('change'); // Trigger change event to set initial visibility
                                                    });




                                                </script>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                    </div>
                                    </div>
                            </div>
                    </div>
                    </div>



                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block6">
                                <div class="info-block" id="physical">
                                        <div class="block-header" >

                                        Physical Security Profile <img src="{% static 'images/osha_exclamation.png' %}" style="width: 50px" class="img-fluid" alt="Logo">
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" style="align-items: center; align-content: center">
                                                <p style="color:white">Physical security considerations for the location of the facility</p>
                                                <div class="row" style="width:95%">
                                                    <div class="col">
                                                        <div class="form-group">
                                                            <div id="physicalContainer" class="safety-summary-container"></div>
                                                            <textarea rows="25" name="txtPhysical" id="txtPhysical" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.physicalSummary }}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                    </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block8">
                                <div class="info-block" id="threat">
                                        <div class="block-header">
                                        Threat Profile
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" style="align-items: center; align-content: center">
                                            <p style="color:white">OT Cybersecurity threats most relevant to this facility</p>
                                             <div class="row" style="width:95%">
                                                <div class="col">
                                                <div class="form-group">
                                             <div id="threatContainer" class="safety-summary-container"></div>
                                                    <textarea rows="25" name="threatSummary" id="threatSummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.threatSummary }}</textarea>
                                             </div>
                                                </div>
                                             </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block10">
                                <div class="info-block" id="strategy">
                                        <div class="block-header">
                                        OT Cybersecurity Strategy
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" style="align-items: center; align-content: center">
                                            <p style="color:white">OT Cybersecurity strategy most relevant to this facility</p>
                                                <div class="row" style="width:95%">
                                                    <div class="col">
                                                        <div class="form-group">
                                                            <div id="strategyContainer" class="safety-summary-container"></div>
                                                            <textarea rows="25" name="strategySummary" id="strategySummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.strategySummary }}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                    </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block12">
                                <div class="info-block" id="chemical">
                                        <div class="block-header">
                                        Chemical Profile
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" style="align-items: center; align-content: center">
                                                <p style="color:white">Chemical storage and by-product profile for the facility</p>
                                                <div class="row" style="width:95%">
                                                    <div class="col">
                                                <div class="form-group">
                                                 <div id="chemicalContainer" class="safety-summary-container"></div>
                                                 <textarea rows="25" name="txtChemical" id="txtChemical" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.chemicalSummary }}</textarea>
                                             </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                    </div>
                    <div class="flex-row">
                        <div class="col-md-12 flex-col" id="block14">
                            <div class="info-block" id="scenarios">
                                        <div class="block-header">
                                        Saved Scenarios
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" style="align-items: center; align-content: center">
                                                <p style="color:white"></p>
                                                <div class="row" style="width:95%">
                                                    <table class="table table-striped" style="color: #f0f0f0; ">
                                                        <thead>
                                                            <tr style="color: #ffffff;">
                                                                <th scope="col">#</th>
                                                                <th scope="col" style="width:70%">Scenario</th>
                                                                <th scope="col">BIA Score</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="scenarios-table-body">
                                                            <!-- Table rows will be inserted here by JavaScript -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
     </div>



{% if new_record_id %}
    <script>
        // Set the value of the hidden textbox field
        document.querySelector('input[name="txtHdnCyberPHAID"]').value = "{{ new_record_id }}";

        // Store the value in the local session storage
        sessionStorage.setItem('activeCyberPHA', "{{ new_record_id }}");
    </script>

{% endif %}

<script>
    var pha_score = {{ current_pha_header.pha_score|default:0 }};
    drawGauge(pha_score);
    drawControlGauge(0);

    $("#generatePPT").click(function(e) {
    e.preventDefault();  // This prevents the default form submission

    $.ajax({
        type: "POST",
        url: "{% url 'OTRisk:generate_ppt' %}",
        data: {
            FacilityName: $("#lblFacilityName").text(),
            txtSafetySummary: $("#txtSafetySummary").val(),
            txtChemical: $("#txtChemical").val(),
            txtPhysical: $("#txtPhysical").val(),
            txtOther: $("#txtOther").val(),
            txtCompliance: $("#txtCompliance").val(),
            threatSummary: $("#threatSummary").val(),
            insightSummary: $("#insightSummary").val(),
            strategySummary: $("#strategySummary").val(),
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val() // Ensure CSRF token is sent with POST request
        },
        dataType: "json",
        success: function(response) {
            if (response.status === "success") {
                // Redirect to the provided download URL
                window.location.href = response.download_url;
            } else {
                alert("An error occurred: " + response.error);
            }
        },
        error: function(error) {
            alert("An error occurred: " + error.statusText);
        }
    });
});

    $(document).ready(function() {
    $("#risk-assessment-btn").click(function() {
        var employeeCount = $("#txtEmployees").val();

        var address = $("#lblFacilityAddress").text().trim(); // Get Address and trim whitespace

            Swal.fire({
                title: 'Warning',
                text: 'Generating the assessment profile can take up to a minute. Proceed?',
                imageUrl: '/static/images/anzen_owl.png',
                imageWidth: 150, // Adjust as necessary
                imageHeight: 150, // Adjust as necessary
                background: '#000', // Black background
                color: '#fff', // Set text color to white
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                }

            }).then((result) => {
                if (result) {
                     // Show spinner
                    assessRisk();

                }
            });

    });
});

    function populateSummary(containerId, summaryData) {
    if (!summaryData || !summaryData.trim()) {
        return;
    }

    // Clear existing content
    $('#' + containerId).empty();

    // Normalize newline characters and split the summary by new lines, filter out empty lines
    const normalizedData = summaryData.replace(/\r\n|\r|\n/g, '\n');
    const items = normalizedData.split('\n').filter(item => item.trim() !== '');

    // Get the reference to the corresponding textarea
    const textareaMapping = {
        'safetySummaryContainer': $('#txtSafetySummary'),
        'complianceContainer': $('#txtCompliance'),
        'physicalContainer': $('#txtPhysical'),
        'otherContainer': $('#txtOther'),
        'chemicalContainer': $('#txtChemical'),
        'threatContainer': $('#threatSummary'),
        'insightContainer': $('#insightSummary'),
        'strategyContainer': $('#strategySummary')
    };
    const txtArea = textareaMapping[containerId];

    // Function to create and attach the remove icon to a box
    function attachRemoveIcon(box, item) {
        const removeIcon = $('<img class="remove-item" src="/static/images/red_delete_circle.png" style="cursor: pointer; margin-left: 5px; width: 1em; height: 1em;">');
        box.append(removeIcon);

        // Attach click event handler to the remove icon
        removeIcon.click(() => {
            // Show confirmation message using SweetAlert
            swal.fire({
                title: "Are you sure?",
                text: "Once removed, you will not be able to recover this item!",
                imageUrl: '/static/images/anzen_owl.png',
                imageWidth: 150,
                imageHeight: 150,
                background: '#000',
                color: '#fff',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-custom-border'
                }
            }).then((willDelete) => {
                if (willDelete.isConfirmed) {
                    // Remove the item from the set
                    box.remove();
                    // Remove corresponding text from textarea
                    let newText = txtArea.val().replace(item, '');
                    txtArea.val(newText);

                    // Renumber and reattach icons to remaining items
                    renumberAndAttachIcons();

                    swal.fire("Item has been removed!");
                } else {
                    swal.fire("Your item is safe!");
                }
            });
        });
    }

    // Function to renumber and reattach icons to remaining items
    function renumberAndAttachIcons() {
        $('#' + containerId).find('.safety-summary-box').each((idx, el) => {
            const box = $(el);
            const currentItemText = box.text();
            const newItemNumber = idx + 1;
            const newItemText = currentItemText.replace(/^\d+/, newItemNumber);
            box.text(newItemText);
            attachRemoveIcon(box, newItemText);

            // Update text area with new item numbers
            let newText = txtArea.val().replace(currentItemText, newItemText);
            txtArea.val(newText);
        });
    }

    // Iterate over items and create boxes
    items.forEach((item, index) => {
        const box = $('<div class="safety-summary-box" style="color: #000; font-size: 0.7em"></div>').text(item);
        $('#' + containerId).append(box);

        // Attach remove icon and its event handler to the box
        attachRemoveIcon(box, item);
    });
}

    function populateThreatSummary(containerId, summaryData) {
    function renumberAndAttachIcons() {
        $('#' + containerId).find('.safety-summary-box').each((idx, el) => {
            const box = $(el);
            const currentItemText = box.text();
            const newItemNumber = idx + 1;
            const newItemText = currentItemText.replace(/^\d+/, newItemNumber);
            box.text(newItemText);
            attachRemoveIcon(box, newItemText);

            // Update text area with new item numbers
            let newText = txtArea.val().replace(currentItemText, newItemText);
            txtArea.val(newText);
        });
    }

    function attachRemoveIcon(box, item) {
        const removeIcon = $('<img class="remove-item" src="/static/images/red_delete_circle.png" style="cursor: pointer; margin-left: 5px; width: 1em; height: 1em;">');
        box.append(removeIcon);

        removeIcon.click(() => {
            swal.fire({
                title: "Are you sure?",
                text: "Once removed, you will not be able to recover this item!",
                imageUrl: '/static/images/anzen_owl.png',
                imageWidth: 150,
                imageHeight: 150,
                background: '#000',
                color: '#fff',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-custom-border'
                }
            }).then((willDelete) => {
                if (willDelete.isConfirmed) {
                    box.remove();
                    swal.fire("Item has been removed!");
                } else {
                    swal.fire("Your item is safe!");
                }
            });
        });
    }

    $('#' + containerId).empty();
    const normalizedData = summaryData.replace(/\r\n|\r|\n/g, '\n');
    const items = normalizedData.split('\n').filter(item => item.trim() !== '');

    items.forEach((item, index) => {
        // Use a regular expression to split the description from the probability
        const regex = /(.+?)\s*\.\s*\(Probability: (\d+%)\)/;
        const match = item.match(regex);
        const txtArea = $('#threatSummary');

        let threatDescription, probability;
        if (match) {
            threatDescription = match[1] + '.'; // Include the period that was removed in the regex
            probability = match[2];
        } else {
            threatDescription = item; // Default to the whole item if no match is found
            probability = 'N/A';
        }

        const box = $('<div class="safety-summary-box" style="color: #000; padding: 5px; margin-bottom: 5px; border: 1px solid #ccc;"></div>');
        const content = `<div>${threatDescription}</div><div class="probability-value" style="font-weight: bold; margin-top: 5px;">Probability of occurrence: ${probability}</div>`;
        box.html(content);
        $('#' + containerId).append(box);

        attachRemoveIcon(box, item); // Ensure attachRemoveIcon is defined or this line should be adjusted accordingly.
    });
}

      // AJAX function to call the Django view
    function assessRisk() {
            $('#progressBarContainerProfile').show();
            $('#progressBarProfile').css('width', '0%').attr('aria-valuenow', 0);
            $('#progressBarMessageProfile').text('').show(); // Initialize and show message
            $('.tab-link').addClass('disabled');
            $('.nav-link').addClass('disabled');

            let progress = 0;
            let progressBarInterval = setInterval(function() {
                progress += 2; // Increment progress by 2% every second
                if (progress <= 100) {
            $('#progressBarProfile').css('width', progress + '%').attr('aria-valuenow', progress);

            // Update progress bar message based on current progress
            switch (true) {
                case (progress === 4):
                    $('#progressBarMessageProfile').text('Creating safety profile...');
                    break;
                case (progress === 15):
                    $('#progressBarMessageProfile').text('Creating chemical profile...');
                    break;
                case (progress === 30):
                    $('#progressBarMessageProfile').text('Assessing location for physical security...');
                    break;
                case (progress === 40):
                    $('#progressBarMessageProfile').text('Determining OT assets...');
                    break;
                case (progress === 55):
                    $('#progressBarMessageProfile').text('Retrieving compliance requirements...');
                    break;
                case (progress === 65):
                    $('#progressBarMessageProfile').text('Creating OT Cybersecurity threat profile...');
                    break;
                case (progress === 75):
                    $('#progressBarMessageProfile').text('Providing security insights...');
                    break;
                case (progress === 85):
                    $('#progressBarMessageProfile').text('Suggesting OT cybersecurity strategy');
                    break;
            }
        } else {
            clearInterval(progressBarInterval); // Clear interval if progress exceeds 100%
        }
    }, 1500); // Update progress every second
            // Gather the necessary data for the AJAX request (impact scores and scenario information)

            let facilityid = document.getElementById('facilityid').value;
            let assessment_id = document.getElementById('assessment_id').value;
            let AQI = document.getElementById('txthdnAQI').value;
            let sl = document.getElementById('selSL').value;
            let hasIRPlan = document.getElementById('ir_plan').checked
            let irPlanDate = document.getElementById('ir_plan_date').value;
            let irPlanNeverTested = document.getElementById('ir_plan_ut').checked;
            let investments = [];
            $('#investmentTable tbody tr').each(function() {
                let investment = {
                    vendor_name: $(this).find('select[name="vendor_name[]"]').val(),
                    product_name: $(this).find('select[name="product_name[]"]').val()
                };
                investments.push(investment);
            });
            let connector_status = '';
            let connector_risk = '';
            let connector_score = 0;
            let exalensScore = parseInt(document.getElementById('hdn_exalens_score').value, 10);

            if (exalensScore > 0){
                 connector_status = document.getElementById('hdn_exalens_status').value;
                 connector_risk = document.getElementById('hdn_exalens_risk').value;
                 connector_score = exalensScore;
            }

            // Make the AJAX call to the Django view using a separate endpoint for risk assessment
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:facility_risk_profile' %}",  // URL for the Django view
                data: {
                    // Pass the impact scores and scenario information as parameters
                    facilityid,
                    assessment_id: assessment_id,
                    aqi: AQI,
                    sl: sl,
                    investments: JSON.stringify(investments),
                    has_ir_plan: hasIRPlan,
                    ir_plan_date: irPlanDate,
                    ir_plan_never_tested: irPlanNeverTested,
                    connector_status: connector_status,
                    connector_risk: connector_risk,
                    connector_score: connector_score
                 },

                success: function (response) {
                    clearInterval(progressBarInterval);
                    $('#progressBarContainerProfile').hide();
                    $('#progressBarMessageProfile').hide();
                    $('.tab-link').removeClass('disabled');
                    $('.nav-link').removeClass('disabled');
                    // Write the response data to the textboxes
                    document.getElementById('txtOther').value = response.other_summary;
                    document.getElementById('threatSummary').value = response.threatSummary;
                    document.getElementById('strategySummary').value = response.strategySummary;
                    document.getElementById('insightSummary').value = response.insightSummary;
                    // document.getElementById('hdn_pha_score').value = response.pha_score;

                    //populateSummary("safetySummaryContainer", response.safety_summary);
                    //populateSummary("complianceContainer", response.compliance_summary);
                    //populateSummary("physicalContainer", response.physical_security_summary);
                    populateSummary("otherContainer", response.other_summary);
                    //populateSummary("chemicalContainer", response.chemical_summary);
                    populateSummary("threatContainer", response.threatSummary);
                    populateSummary("insightContainer", response.insightSummary);
                    populateSummary("strategyContainer", response.strategySummary);

                    //drawGauge(response.pha_score);

                     $('#spinnerContainerProfile').hide();
                      // Expand the Facility Profile submenu if it's not already expanded
                    // This assumes you have some CSS/JS logic to toggle visibility based on a class like 'expanded'
                    $('.facility-profile-heading').addClass('expanded');
                    $('.facility-profile-submenu').show(); // Make sure the submenu is visible

                },
                error: function (xhr, status, error) {
                    // Handle any errors that occur during the AJAX call
                    clearInterval(progressBarInterval);
                    $('#progressBarContainerProfile').hide();
                    $('#progressBarMessageProfile').hide();
                    $('.nav-link').removeClass('disabled');
                },
            });
        }

    function showNotification(message, isError = false) {
        var notificationDiv = document.getElementById('notificationMessage');
        notificationDiv.innerHTML = message;
        notificationDiv.style.display = 'block';
        notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

        // Automatically hide the notification after some time
        setTimeout(function() {
        notificationDiv.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }
    </script>
<br>

<!-- Modal -->
<div class="modal fade" id="moderatorModal" tabindex="-1" role="dialog" aria-labelledby="moderatorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moderatorModalLabel">Select CyberPHA Moderators</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div class="form-group">
                        <label for="targetDate">Target Completion Date:</label>
                        <input type="text" class="form-control" id="targetDate" name="targetDate" placeholder="mm/dd/yy">
                        <script>
                        $( function() {
                            $( "#targetDate" ).datepicker({
                                dateFormat: "mm/dd/yy"
                            });
                        });
                        </script>

                    </div>
                    <table class="table" >
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Select</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Moderators will be populated dynamically by JavaScript -->
                        </tbody>
                    </table>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <!-- Add more buttons if needed -->
            </div>
        </div>
    </div>
</div>

 </form>



<script>
    $(document).ready(function() {
    $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary,  #assessment_id,  #selZone, #selSL,  #btnformSubmit,  #risk-assessment-btn, #scenarioButton, #generatePPT').prop('disabled', false);
     $('#btnformSubmit').prop('disabled', false);
     $('#scenarioButton').prop('disabled', false);
    $('#loadFacilityButton').prop('disabled', false);
        var table = $('#headertable').DataTable({
            "pageLength": 10,
            "lengthChange": false
        });

        function navigateToRecord(recordId) {
            var allPages = table.page.info().pages;
            var found = false;

            for (var i = 0; i < allPages; i++) {
                // Navigate to the page
                table.page(i).draw('page');

                // Check if the record is in the current page
                var row = $('tr[data-id="' + recordId + '"]');
                if (row.length) {
                    // Record found, highlight it
                    $('tr.selectable-row').removeClass('highlighted');
                    row.addClass('highlighted');
                    found = true;
                    break;
                }
            }

            if (!found) {
                console.log("Record not found");
            }
        }

        // Check if a saved_record_id is provided in the rendered context
        let savedRecordId = "{{ saved_record_id }}";
        if (savedRecordId && savedRecordId !== "None") {
            navigateToRecord(savedRecordId);
        }

        $('#headertable').on('click', 'tbody tr.selectable-row', function() {
            let recordId = $(this).data('id');

            navigateToRecord(recordId);
        });
});

function populateInvestmentTable(investments) {
    const tableBody = $('#investmentTable tbody');
    tableBody.empty(); // Clear existing rows

    investments.forEach(function(investment) {
        const row = `<tr>

            <td><input type="text" name="vendor_name[]" value="${investment.vendor_name}" class="form-control"></td>
            <td><input type="text" name="product_name[]" value="${investment.product_name}" class="form-control"></td>

            <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
        </tr>`;
        tableBody.append(row);
    });

    // Ensure the removeRow button functionality is re-bound after adding new rows
    $('.removeRow').off('click').on('click', function() {
        $(this).closest('tr').remove();
    });
}

function setBorderColorByScore_(score) {
        var borderColor = '#4CAF50'; // Default color
        score = parseInt(score); // Convert score to integer

        if (score < 30) {
            borderColor = 'red';
        } else if (score >= 30 && score <= 70) {
            borderColor = 'yellow';
        } // If score > 70, default green color is used

        $('#assessment_summary').css('border-left', '5px solid ' + borderColor);
    }

function minimizeBlock(block) {
    var blockBody = block.find(".block-body");
    if (blockBody.is(":visible")) {
        blockBody.toggle();
        block.find(".toggle-body").text("+");
    }
}

function scenarioTable(scenarios){

    const tableBody = document.getElementById("scenarios-table-body");

    scenarios.forEach((scenario, index) => {
        const row = document.createElement("tr");

        const cellIndex = document.createElement("th");
        cellIndex.scope = "row";
        cellIndex.textContent = index + 1;
        cellIndex.style.color = '#f0f0f0';
        row.appendChild(cellIndex);

        const cellScenario = document.createElement("td");
        let scenarioText = scenario.Scenario.split(" ").slice(0, 20).join(" ");
        if (scenario.Scenario.split(" ").length > 20) {
            scenarioText += '...';
        }
        cellScenario.textContent = scenarioText;
        cellScenario.style.color = '#f0f0f0';
         cellScenario.style.fontSize = '80%';
        row.appendChild(cellScenario);

        const cellScore = document.createElement("td");
        const score = scenario.business_impact_score;
        let color;
        if (score <= 30) {
            color = '#66c2a5'; // Color-blind friendly green
        } else if (score <= 70) {
            color = '#fc8d62'; // Color-blind friendly orange
        } else {
            color = '#8da0cb'; // Color-blind friendly purple
        }
        cellScore.innerHTML = `
            <div style="font-weight: bold; font-size: 1.2em; color: #f0f0f0;">
                ${score}
            </div>
            <div class="progress" style="height: 20px; background-color: #444;">
                <div class="progress-bar" role="progressbar" style="width: ${score}%; background-color: ${color};" aria-valuenow="${score}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        `;
        row.appendChild(cellScore);

        tableBody.appendChild(row);
        });
}

function fetchHeaderRecord(recordId) {

                 sessionStorage.setItem('activeCyberPHA', recordId);
                 isUserChange = false;
                 // Set the value of the hidden text field
                 document.getElementById('txtHdnCyberPHAID').value = recordId;
                 $.ajax({
                     url: '/OTRisk/get_headerrecord',  // the URL of the view that will handle the request
                     data: {
                         'record_id': recordId
                     },
                     dataType: 'json',
                     success: function (data) {

                         $('#txtTitle').val(data.headerrecord.title);

                         $('#lblCyberPHATitle').text('CyberPHA: ' + data.headerrecord.title + '@' + data.headerrecord.facility) ;

                         $('#txtLeader').val(data.headerrecord.leader);
                         $('#txtUnit').val(data.headerrecord.unit);

                         $('#lblFacilityName').text(data.headerrecord.facility);
                         $('#lblFacilityAddress').text(data.headerrecord.address);
                         $('#lblFacilityIndustry').text(data.headerrecord.Industry);
                         $('#lblFacilityType').text(data.headerrecord.facilitytype);

                         $('#txtLeaderEmail').val(data.headerrecord.leaderemail);

                         $('#assessment_id').val(data.headerrecord.assessment_id);
                         $('#assessment_id').val(data.headerrecord.assessment_id).trigger('change');

                         $('#selZone').val(data.headerrecord.zone);
                         $('#selSL').val(data.headerrecord.sl_t);
                         $('#txtStartDate').val(data.headerrecord.startdate);
                         $('#txtEndDate').val(data.headerrecord.enddate);
                         $('#txtSafetySummary').val(data.headerrecord.safetysummary);

                         $('#txtChemical').val(data.headerrecord.chemicalsummary);
                         $('#txtPhysical').val(data.headerrecord.physicalsummary);
                         $('#txtOther').val(data.headerrecord.othersummary);
                         $('#txtCompliance').val(data.headerrecord.compliancesummary);
                         $('#threatSummary').val(data.headerrecord.threatSummary);
                         $('#insightSummary').val(data.headerrecord.insightSummary);
                         $('#strategySummary').val(data.headerrecord.strategySummary);


                         $('#lblFacilityShiftModel').text(data.headerrecord.shift_model);
                         $('#lblFacilityEmployees').text(data.headerrecord.EmployeesOnSite);
                         $('#lblFacilityRevenue').text(formatAsCurrency(data.headerrecord.annual_revenue));
                         $('#lblFacilityNPM').text(data.headerrecord.npm);
                         $('#lblFacilityOC').text(formatAsCurrency(data.headerrecord.coho));

                         $('#hdn_pha_score').val(data.headerrecord.pha_score);


                         $('#txthdnLat').val(data.headerrecord.facilityLat);
                         $('#txthdnLong').val(data.headerrecord.facilityLong);
                         $('#txthdnAQI').val(data.headerrecord.facilityAQI);

                         $('#facilityid').val(data.headerrecord.facility_id);
                         sessionStorage.setItem('fid', data.headerrecord.facility_id);
                         // Populate the new incident response planning fields
                        $('#ir_plan').prop('checked', data.headerrecord.has_incident_response_plan);
                        $('#ir_plan_date').val(data.headerrecord.plan_last_tested_date);
                        $('#ir_plan_ut').prop('checked', data.headerrecord.plan_never_tested);
                        $('#assessment_summary').text(data.headerrecord.last_assessment_summary);
                        $('#assessment_score').text('Score: ' + data.headerrecord.last_assessment_score + '/100');

                        if (data.headerrecord.exalens_api) {
                            $('#exalensConfig').show();
                            $('#exalensApiKey').val(data.headerrecord.exalens_api);
                            $('#exalensClientId').val(data.headerrecord.exalens_client);
                            $('#exalensIpAddress').val(data.headerrecord.exalens_ip);

                            document.getElementById('control_status').innerHTML = "<b>Exalens Status:</b> " + data.headerrecord.exalens_status;
                            document.getElementById('risk_statement').innerHTML = "<b>Inferred Risk:</b> " + data.headerrecord.exalens_risk;

                            document.getElementById('risk_score_number').innerText = "Risk Score: " + data.headerrecord.exalens_score + "/100";
                            document.getElementById('hdn_exalens_status').value = data.headerrecord.exalens_status;
                            document.getElementById('hdn_exalens_risk').value = data.headerrecord.exalens_risk;
                            document.getElementById('hdn_exalens_score').value = data.headerrecord.exalens_score;

                            exalens_risk_score_chart(data.headerrecord.exalens_score);
                        } else {
                            $('#exalensConfig').hide();
                            $('#exalensApiKey').val('');
                            $('#exalensClientId').val('');
                            $('#exalensIpAddress').val('');
                            document.getElementById('control_status').innerText = '';
                            document.getElementById('risk_statement').innerText = '';
                            document.getElementById('risk_score_number').innerText = '';
                            document.getElementById('hdn_exalens_status').value = '';
                            document.getElementById('hdn_exalens_risk').value = '';
                            document.getElementById('hdn_exalens_score').value = '';

                            exalens_risk_score_chart(0);
                        }

                        if (data.headerrecord.darktrace_public_api) {
                            $('#darktraceConfig').show();
                            $('#darktrace_public_key').val(data.headerrecord.darktrace_public_api);
                            $('#darktrace_private_key').val(data.headerrecord.darktrace_private_api);
                            $('#darktrace_host').val(data.headerrecord.darktrace_client);

                            let controlStatusString = Array.isArray(data.headerrecord.darktrace_status) ? data.headerrecord.darktrace_status.join('- ') : data.headerrecord.darktrace_status;
                            let riskStatementString = Array.isArray(data.headerrecord.darktrace_risk) ? data.headerrecord.darktrace_risk.join('- ') : data.headerrecord.darktrace_risk;

                            // Format the responses
                            let formattedControlStatus = formatResponse(controlStatusString);
                            let formattedRiskStatement = formatResponse(riskStatementString);

                            // Update the innerHTML of the elements with formatted content
                            document.getElementById('darktrace_control_status').innerHTML = "<b>Darktrace Status:</b><ul>" + formattedControlStatus + "</ul>";
                            document.getElementById('darktrace_risk_statement').innerHTML = "<b>Inferred Risk:</b><ul>" + formattedRiskStatement + "</ul>";


                            document.getElementById('darktrace_risk_score_number').innerText = "Risk Score: " + data.headerrecord.darktrace_score + "/100";
                            document.getElementById('hdn_darktrace_status').value = data.headerrecord.darktrace_status;
                            document.getElementById('hdn_darktrace_risk').value = data.headerrecord.darktrace_risk;
                            document.getElementById('hdn_darktrace_score').value = data.headerrecord.darktrace_score;

                            //darktrace_risk_score_chart(data.headerrecord.darktrace_score);
                            darktrace_incident_severity_DistributionChart(data.headerrecord.darktrace_tactics_report);
                            darktrace_tactics_DistributionChart(data.headerrecord.darktrace_mitre_report);
                            document.getElementById('hdn_darktrace_tactics').value = data.headerrecord.darktrace_mitre_report;
                            document.getElementById('hdn_darktrace_mitre').value = data.headerrecord.darktrace_mitre_report;

                            var leftColumn = document.getElementById('leftColumn');
                            var rightColumn = document.getElementById('rightColumn');
                            var toggleButton = document.getElementById('toggleColumnBtn');
                            leftColumn.style.display = 'none';
                            rightColumn.classList.remove('col-md-9');
                            rightColumn.classList.add('col-md-12');
                            toggleButton.innerText = '>>';

                        } else {
                            $('#darktraceConfig').hide();
                            $('#darktrace_public_key').val('');
                            $('#darktrace_private_key').val('');
                            $('#darktrace_host').val('');
                            document.getElementById('darktrace_control_status').innerText = '';
                            document.getElementById('darktrace_risk_statement').innerText = '';
                            document.getElementById('darktrace_risk_score_number').innerText = '';
                            document.getElementById('hdn_darktrace_status').value = '';
                            document.getElementById('hdn_darktrace_risk').value = '';
                            document.getElementById('hdn_darktrace_score').value = '';

                            //darktrace_risk_score_chart(0);
                        }

                        $('#defaultFacility').prop('checked', data.headerrecord.is_default);
                        // Logic to enable/disable the date field and plan_never_tested checkbox
                        if (data.headerrecord.has_incident_response_plan) {
                            $('#ir_plan_date').prop('disabled', false);
                            if (data.headerrecord.plan_last_tested_date) {
                                $('#ir_plan_ut').prop('disabled', true).prop('checked', false);
                            } else {
                                $('#ir_plan_ut').prop('disabled', false);
                            }
                        } else {
                            $('#ir_plan_date').prop('disabled', true).val('');
                            $('#ir_plan_ut').prop('disabled', true).prop('checked', false);
                        }



                        $('#ir_plan_date').change(function() {
                            if ($(this).val()) {
                                $('#ir_plan_ut').prop('checked', false).prop('disabled', true);
                            } else {
                                $('#ir_plan_ut').prop('disabled', false);
                            }
                        });

                         var lat = data.headerrecord.facilityLat;
                         var long = data.headerrecord.facilityLong;
                         var address = data.headerrecord.address + ', ' + data.headerrecord.facilityCity + ', ' + data.headerrecord.facilityCode;
                         // var country = data.headerrecord.country
                         updateMapAndAQI(lat,long,address);
                         aqi(lat,long,address);
                         drawGauge(data.headerrecord.pha_score);
                        setBorderColorByScore_(data.headerrecord.last_assessment_score);
                         drawControlGauge(data.headerrecord.last_assessment_score);

                         populateInvestmentTable(data.investments);

                         populateSummary("safetySummaryContainer", data.headerrecord.safetysummary);
                         populateSummary("complianceContainer", data.headerrecord.compliancesummary);
                         populateSummary("physicalContainer", data.headerrecord.physicalsummary);
                         populateSummary("otherContainer", data.headerrecord.othersummary);
                         // populateSummary("chemicalContainer", data.headerrecord.chemicalsummary);
                         populateChemicalJSON(JSON.parse(data.headerrecord.chemicalsummary));
                         populateThreatSummary("threatContainer", data.headerrecord.threatSummary);
                         populateSummary("insightContainer", data.headerrecord.insightSummary);
                         populateSummary("strategyContainer", data.headerrecord.strategySummary);


                         scenarioTable(data.scenarios);

                         sessionStorage.setItem('sessionIndustry', data.headerrecord.industry);
                         sessionStorage.setItem('sessionFacilityType', data.headerrecord.facilitytype);
                         sessionStorage.setItem('sessionFacility', data.headerrecord.facility);
                         sessionStorage.setItem('sessionCountry', data.headerrecord.country);
                         var pha_score = data.headerrecord.pha_score;

                         // Enable the controls
                         $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary,  #assessment_id,  #selZone, #selSL,  #btnformSubmit,  #risk-assessment-btn, #scenarioButton, #generatePPT').prop('disabled', false);
                         $('#btnformSubmit').prop('disabled', false);
                         $('#scenarioButton').prop('disabled', false);
                         // Set the workflow status dropdown
                         // Ensure the current workflow status matches the format of the dropdown options
                         var currentWorkflowStatus = data.headerrecord.current_workflow_status;

                         var workflowSelector = $('#workflow_selector');

                         // Check if the current workflow status exists in the options
                         if (workflowSelector.find("option[value='" + currentWorkflowStatus + "']").length > 0) {
                             workflowSelector.val(currentWorkflowStatus).trigger('change');
                         } else {
                             // If the status doesn't exist, select the default placeholder
                             workflowSelector.val('').trigger('change');
                         }

                         if (currentWorkflowStatus == 'Complete') {

                             lockControls();
                         } else {
                             unlockControls();
                         }

                         $('#generatePPT').prop('disabled', false);
                         populateModeratorsTable(data.organization_moderators, data.moderator_ids);
                         // Populate current group assignments

                         populateCurrentGroups(data.headerrecord.current_groups);

                         // Populate all available groups in the dropdown (for the modal)
                         populateAllGroupsDropdown(data.all_groups);
                         updateGroupAssignmentsDisplay(recordId);
                         updateGroupList();
                         document.getElementById("last_assessment_score").value=data.headerrecord.last_assessment_score;
                          document.getElementById("last_assessment_summary").value=data.headerrecord.last_assessment_summary;
                         $('#last_assessment_summary').text(data.headerrecord.last_assessment_summary);
                        $('#last_assessment_score').text(data.headerrecord.last_assessment_score);


                        var infoBlock = $(".info-block:has(#headertable)");
                        minimizeBlock(infoBlock);
                        expandFacilityDetails();
                        // expandFacilityDetailsBlock();

                     }
                 });
             }

            function formatAsCurrency(value) {
                 // Strip any non-digit characters
                 let cleanedValue = String(value).replace(/\D/g, '');

                 // Convert the number to a currency format
                 return parseInt(cleanedValue).toLocaleString('en-US', {
                     style: 'currency',
                     currency: 'USD',
                     minimumFractionDigits: 0
                 });
             }

function populateModeratorsTable(moderators, moderatorIds) {
                 var tbody = $('#moderatorModal tbody');
                 tbody.empty(); // Clear existing rows

                 moderators.forEach(function (moderator) {
                     var checked = moderatorIds.includes(moderator.id) ? 'checked' : '';
                     var row = '<tr>' +
                         '<td>' + moderator.name + '</td>' +
                         '<td><input type="checkbox" name="moderator" value="' + moderator.id + '" ' + checked + '></td>' +
                         '</tr>';
                     tbody.append(row);
                 });
             }

                 // Function to populate current groups
 function populateCurrentGroups(groups) {
                 var currentGroupsDiv = $('#currentGroupsDiv');
                 currentGroupsDiv.empty(); // Clear existing content

                 // Check if 'groups' is an array and has elements
                 if (Array.isArray(groups) && groups.length > 0) {
                     groups.forEach(function (group) {
                         currentGroupsDiv.append($('<p>').text(group.name));
                     });
                 } else {
                     // Handle non-array or empty 'groups'
                     currentGroupsDiv.append($('<p>').text('No groups assigned.'));
                 }
             }


 function populateAllGroupsDropdown(groups) {
                 var allGroupsSelect = $('#existing_group'); // ID of the select element in the modal
                 allGroupsSelect.empty(); // Clear existing options

                 allGroupsSelect.append($('<option>', {
                     value: '',
                     text: 'Select a Group'
                 }));

                 if (groups && groups.length > 0) {
                     groups.forEach(function (group) {
                         allGroupsSelect.append($('<option>', {
                             value: group.id,
                             text: group.name
                         }));
                     });
                 }
             }
</script>

<div class="modal fade" id="countryModal" tabindex="-1" aria-labelledby="countryModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModal_Label">Country Selection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Selecting the correct country in which the facility is located improves the accuracy of the scenario event cost estimation</p>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="assessmentDialog" tabindex="-1" aria-labelledby="assessmentDialogLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assessmentDialogLabel">Select an Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pha_header_records in pha_header_records %}
                            <tr class="selectable-row" data-id="{{ pha_header_records.ID }}">
                                <td>{{ pha_header_records.title }}</td>
                                <td>{{ pha_header_records.latest_workflow_status }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->


<script>
    $(document).ready(function() {
    // Bind the CreateCopy function directly to the Save button's click event
    $('#saveCopy').click(function(event) {
        event.preventDefault();  // Prevent any default button click behavior
        CreateCopy();  // Execute the function to handle the copy operation
    });

    // Function to handle the copying of CyberPHA data
    function CreateCopy() {
        // Gather form data
        var postData = {
            FacilityName: $('#FacilityName').val(),
            facilityAddress: $('#facilityAddress').val(),
            facilityCode: $('#facilityCode').val(),
            facilityCity: $('#facilityCity').val(),
            facilityState: $('#facilityState').val(),

            'csrfmiddlewaretoken': '{{ csrf_token }}'
        };

        // Fetch the pha_id from session storage (set this value when the CyberPHA is selected)
        var pha_id = sessionStorage.getItem('activeCyberPHA');

        // AJAX request to Django server to duplicate the CyberPHA record
        $.ajax({

            url: '/OTRisk/copy_cyber_pha/' + pha_id + '/',  // Ensure your Django URL configuration can handle this route
            method: 'POST',
            data: postData,
            success: function(response) {
                Swal.fire(
                    'Copied!',
                    'The CyberPHA assessment has been successfully cloned.',
                    'success'
                );
                $('#facilityDetailsModal').modal('hide');
            },
            error: function() {
                Swal.fire(
                    'Error',
                    'There was a problem cloning the CyberPHA assessment. Please try again.',
                    'error'
                );
            }
        });
    }
});

// Define the csrfSafeMethod function to check if a HTTP method is safe from CSRF protection
function csrfSafeMethod(method) {
    // These HTTP methods do not require CSRF protection
    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
}

// Define the getCookie function to retrieve the CSRF token from cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Check if this cookie name starts with the specified name
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Using jQuery
$(document).ready(function() {
    // Update the displayed value when the slider changes
    $("input[type='range']").on('input', function() {
        var id = $(this).attr('id').replace("mitigation_", "");
        $("#mitigationValue_" + id).text($(this).val());
    });

});

function aqi(latitude,longitude,address,country) {
    $.ajax({
        type: 'GET',
        url: '/OTRisk/air_quality_index/',  // Update with the correct path to your Django view
        data: {'lat': latitude, 'lon': longitude, 'address': address, 'country': country},
        success: function (response) {
            if (response.aqi !== undefined) {
                $('#txthdnAQI').val(response.aqi);
                var aqiValue = response.aqi;
                var aqiGlobe = $('#aqiGlobe');
                aqiGlobe.text(aqiValue);

                // Determine the background color based on AQI value
                var bgColor;
                if (aqiValue <= 50) {
                    bgColor = 'green';
                } else if (aqiValue <= 100) {
                    bgColor = 'yellow';
                } else if (aqiValue <= 150) {
                    bgColor = 'orange';
                } else if (aqiValue <= 200) {
                    bgColor = 'red';
                } else if (aqiValue <= 300) {
                    bgColor = 'purple';
                } else if (aqiValue <= 500) {
                    bgColor = 'brown';
                } else {
                    bgColor = 'grey'; // Default or error case
                }

                // Apply the background color
                aqiGlobe.css('background-color', bgColor);
            } else {

            }
        },
        error: function () {

        }
    });
}

function lockControls() {
    // Disable all input, select, and button elements
    document.querySelectorAll('input, select, button').forEach(function(el) {
        // Exclude elements inside the 'headertable' table and the 'resetButton' by id
        if (!el.closest('#headertable') && el.id !== 'resetButton') {
            el.disabled = true;
        }
    });
}

function disableTableInputs(tableId, disable) {
    var inputs = document.querySelectorAll('#' + tableId + ' input');
    inputs.forEach(function(input) {
        input.disabled = disable;
    });
}

function unlockControls() {
        // Disable all input, select, and button elements
        document.querySelectorAll('input, select, button').forEach(function(el) {

            el.disabled = false;
        })
    }

                // Add an event listener to the "Save Header" button
document.getElementById('btnformSubmit').addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent the form submission (if it's within a form)


                    var title = document.getElementById('txtTitle').value.trim();
                    var fid = sessionStorage.getItem('fid');
                    var missingFields = [];

                    if (!title) missingFields.push('CyberPHA Title');
                    if (!fid || parseInt(fid) <= 0) {
                        missingFields.push('Select Facility');
                    }

                     // Check if all required fields have values
                    if (missingFields.length > 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Missing Information',
                        text: 'Please fill in the following fields before saving: ' + missingFields.join(', ') + '.',
                        footer: '<b>Note:</b> Highlighted fields are required.'
                    }).then(() => {

                    });
                    return; // Exit the function and do not proceed
                }
                    // Show a SweetAlert confirmation dialog
                    Swal.fire({
                        title: 'Confirm Save?',
                        text: "Are you sure you want to save the CyberPHA information? (Note: The profile is generated the first time a new facility is saved. This can take up to a minute to complete)",
                        imageUrl: '/static/images/anzen_owl.png',
                        imageWidth: 150, // Adjust as necessary
                        imageHeight: 150, // Adjust as necessary
                        background: '#000', // Black background
                        color: '#fff', // Set text color to white
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes',
                        cancelButtonText: 'Cancel',
                        customClass: {
                            popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire({
                            title: 'Processing...',
                            html: 'Please wait while we save your information.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading(); // This will show a spinner
                            }
                            });
                            // User confirmed, continue with the form submission
                             disableTableInputs('headertable', true);
                            document.forms['frmRAW'].submit();
                             disableTableInputs('headertable', false);
                        } else {
                            // User canceled the action
                            // You can add additional code here if needed
                        }
                    });
                });

$(document).ready(function() {

    // Function to clear containers
    function clearContainer(containerId) {
        document.getElementById(containerId).innerHTML = '';
    }

    // Function to reset the form and perform the required actions
    function resetForm() {
        $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate,  #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtEmployees,  #shift_model, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary').val('');
        $('#negligible_low, #negligible_high, #minor_low, #minor_high, #moderate_low, #moderate_high, #significant_low, #significant_high, #severe_low, #severe_high').val(0);
        $('#assessment_id, #selZone, #selSL').prop('selectedIndex', 0);
        $('#investmentTable tbody').empty();
        $('#selectFacility, #facilitiesDropdown, #searchButton, #txtTitle, #txtLeader, #txtUnit, #txtStartDate,  #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary, #selZone, #selSL, #btnformSubmit, #risk-assessment-btn').prop('disabled', false);
        $('#btnformSubmit').prop('disabled', false);
        $('#searchButton').prop('disabled', false);
        $('#loadFacilityButton').prop('disabled', false);
        clearContainer('pha_gauge');
        clearContainer('control_gauge');
        document.getElementById('safetySummaryContainer').innerHTML = '';
        document.getElementById('physicalContainer').innerHTML = '';
        document.getElementById('otherContainer').innerHTML = '';
        document.getElementById('complianceContainer').innerHTML = '';
        document.getElementById('threatContainer').innerHTML = '';
        document.getElementById('chemicalContainer').innerHTML = '';
        document.getElementById('insightContainer').innerHTML = '';
        document.getElementById('strategyContainer').innerHTML = '';
        document.getElementById("lblCyberPHATitle").textContent = '@';
        $('#defaultFacility').prop('checked', false);

        // Reset session variables
        sessionStorage.setItem('activeCyberPHA', '0');
        // Set the value of the hidden text field
        document.getElementById('txtHdnCyberPHAID').value = '0';

    }

    // Check if autoStart parameter is present
    const urlParams = new URLSearchParams(window.location.search);
    const autoStart = urlParams.get('autoStart') === 'true';

    if (autoStart) {
        resetForm();
    } else {
        $('#resetButton').on('click', function() {
            Swal.fire({
                title: 'Create new CyberPHA?',
                text: "Are you sure you want to create a new CyberPHA? Any unsaved data will be lost",
                imageUrl: '/static/images/anzen_owl.png',
                imageWidth: 150, // Adjust as necessary
                imageHeight: 150, // Adjust as necessary
                background: '#000', // Black background
                color: '#fff', // Set text color to white
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    resetForm();
                    //expandFacilityDetailsBlock();
                }
            });
        });
    }
});

function populateChemicalJSON(chemicalData) {
    // Check if the data is a string, and if so, parse it into an object
    if (typeof chemicalData === 'string') {
        try {
            chemicalData = JSON.parse(chemicalData);
        } catch (e) {
            console.error("Error parsing chemical data JSON:", e);
            return;
        }
    }

    // Clear existing content
    $('#chemicalContainer').empty();

    if (!chemicalData || !chemicalData.chemicals || !Array.isArray(chemicalData.chemicals)) {
        console.error("Chemical data is invalid or missing. Expected an object with a 'chemicals' array.");
        return;
    }

    // Iterate over the chemicals and create boxes
    chemicalData.chemicals.forEach((chemical, index) => {
        const toxicText = chemical.toxic ? 'Yes' : 'No';
        const flammableText = chemical.flammable ? 'Yes' : 'No';
        const boxText = `Name: ${chemical.chemicalName}\nToxic: ${toxicText}\nFlammable: ${flammableText}\nCAS: ${chemical.CAS}`;
        const box = $('<div class="summary-box" style="color: #000; width: 100%; white-space: pre-line;"></div>').text(boxText);
        $('#chemicalContainer').append(box);
    });
}
</script>
        <script>

    document.getElementById('toggleColumnBtn').addEventListener('click', function() {
    var leftColumn = document.getElementById('leftColumn');
    var rightColumn = document.getElementById('rightColumn');
    var toggleButton = document.getElementById('toggleColumnBtn');

    if (leftColumn.style.display === 'none') {
        leftColumn.style.display = 'block';
        rightColumn.classList.remove('col-md-12');
        rightColumn.classList.add('col-md-9');
        toggleButton.innerText = '<<';
    } else {
        leftColumn.style.display = 'none';
        rightColumn.classList.remove('col-md-9');
        rightColumn.classList.add('col-md-12');
        toggleButton.innerText = '>>';
    }
    });
        </script>
<div class="col-md-0" style="background-color: #464748; align-items: center; visibility: hidden">
<div class="form-group">
<button type="button" class="form-control" id="searchButton" >Search</button>
<div id="spinner_facility" style="display: none;"></div>
</div>
</div>
</div>
 <div class="modal fade" id="loadFacilityModal" tabindex="-1" role="dialog" aria-labelledby="loadFacilityModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadFacilityModalLabel">Select a Facility</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul id="facilityList" class="list-group">
                  <!-- Facility names will be populated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
    </div>
</div>
</div>
<script src="{% static "js/block_manager.js" %}"></script>
 <div class="modal fade" id="assignGroupModal" tabindex="-1"  role="dialog"  aria-labelledby="assignGroupModalLabel" aria-hidden="true">>
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h4 class="modal-title">Assign to Group</h4>
                                                    <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="group-assignment-form">
                                                        <div class="form-group">
                                                            <label for="existing_group">Existing Group:</label>
                                                            <select class="form-control" id="existing_group" name="existing_group">
                                                                <option value="">Select a Group</option>
                                                                {% for group in all_groups %}
                                                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_group_name">New Group Name:</label>
                                                            <input type="text" class="form-control" id="new_group_name" name="new_group_name">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_group_type">New Group Type:</label>
                                                            <select class="form-control" id="new_group_type" name="new_group_type">
                                                                {% for type_value, type_name in group_types %}
                                                                    <option value="{{ type_value }}">{{ type_name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <input type="hidden" name="cyberpha_id" value="{{ current_pha_header.ID }}">
                                                        <button type="button" id="assign-group-btn" class="btn btn-primary">Assign</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
    </div>
</div>
</body>
</html>