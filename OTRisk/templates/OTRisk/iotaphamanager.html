{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<!--suppress ALL -->
<html lang="">
<head>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">

 <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
    function initMap() {

    }
</script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJu4p9r_vFL9g5nzctO4yLbNxjK08q4G0&loading=async&callback=initMap"></script>





     <!-- Bootstrap Select JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'anychart/dist/js/anychart-bundle.min.js' %}"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!-- <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-core.min.js" type="text/javascript"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script> -->
    {% load django_bootstrap5 %}
     {% bootstrap_css %}
     {% bootstrap_javascript %}
<link rel="stylesheet" type="text/css" href="{% static 'css/otriskstyle.css' %}">
<style>
#assessment_summary {
    display: block; /* Make the span behave like a block element */
    background-color: #f2f2f2; /* Light grey background */
    border-left: 5px solid #4CAF50; /* Green left border for emphasis */
    padding: 10px; /* Padding inside the container */
    margin-top: 20px; /* Margin at the top */
    margin-bottom: 10px; /* Margin at the bottom */
    font-family: Arial, sans-serif; /* Font family */
    font-size: 14px; /* Font size */
    color: #000; /* Text color */
    border-radius: 5px; /* Rounded corners */
}

#assessment_score {
    display: block; /* Make the span behave like a block element */
    font-weight: bold; /* Make the text bold */
    font-size: 16px; /* Larger font size for emphasis */
    color: #f7f8f7; /* Green color to match the border of the summary */
    margin-bottom: 20px; /* Bottom margin */
}
</style>

</head>
<body style="background-color: #464748">
<script>

anychart.licenseKey("{{ anychart_key }}");


sessionStorage.setItem('activeCyberPHA','');
sessionStorage.setItem('sessionCountry','');
sessionStorage.setItem('sessionFacility','');
sessionStorage.setItem('sessionFacilityType','');
sessionStorage.setItem('sessionIndustry','');

fetch('https://restcountries.com/v3.1/all')
    .then(response => response.json())
    .then(data => {
        // Sort the countries alphabetically
        data.sort((a, b) => a.name.common.localeCompare(b.name.common));

        // Add a blank option as the default
        $('#countrySelector').append(new Option('', ''));

        // Populate the dropdown
        data.forEach(country => {
            const countryName = country.name.common;
            $('#countrySelector').append(new Option(countryName, countryName));
        });
    })
    .then(() => {
        $('#countrySelector').select2({
            placeholder: "Select a country", // This will display the placeholder text
            allowClear: true // This allows users to clear the selected value
        });
        $('#countrySelector').val('United States').trigger('change');
    })
    .catch(error => {
        console.error("There was an error fetching the country list:", error);
    });

    //disable all controls and reset local session variable when form loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("txtTitle").setAttribute('disabled', true);
        document.getElementById("txtLeader").setAttribute('disabled', true);
        document.getElementById("selIndustry").setAttribute('disabled', true);
        document.getElementById("txtUnit").setAttribute('disabled', true);
        document.getElementById("txtStartDate").setAttribute('disabled', true);
        document.getElementById("txtAddress").setAttribute('disabled', true);
        document.getElementById("txtFacility").setAttribute('disabled', true);
        document.getElementById("txtLeaderEmail").setAttribute('disabled', true);
        document.getElementById("selFacilityType").setAttribute('disabled', true);
        document.getElementById("assessment_id").setAttribute('disabled', true);
        document.getElementById("selZone").setAttribute('disabled', true);
        document.getElementById("selSL").setAttribute('disabled', true);
        document.getElementById("txtEndDate").setAttribute('disabled', true);
        document.getElementById("txtEmployees").setAttribute('disabled', true);
        document.getElementById("cyber_insurance").disabled = true;
        document.getElementById("annual_revenue").setAttribute('disabled', true);
        document.getElementById("shift_model").setAttribute('disabled', true);
        document.getElementById("countrySelector").setAttribute('disabled', true);
        document.getElementById("txtSafetySummary").setAttribute('disabled', true);
        document.getElementById("txtChemical").setAttribute('disabled', true);
        document.getElementById("txtPhysical").setAttribute('disabled', true);
        document.getElementById("txtOther").setAttribute('disabled', true);
        document.getElementById("txtCompliance").setAttribute('disabled', true);
        document.getElementById("threatSummary").setAttribute('disabled', true);
        document.getElementById("insightSummary").setAttribute('disabled', true);
        document.getElementById("strategySummary").setAttribute('disabled', true);
         $('#risk-assessment-btn').prop('disabled', true);
         $('#btnformSubmit').prop('disabled', true);
         $('#scenarioButton').prop('disabled', true);
         $('#generatePPT').prop('disabled', true);
});

function clearContainer(containerId) {
    var container = document.getElementById(containerId);
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
}

function drawGauge(score) {

    clearContainer('pha_gauge');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);

    gauge.background().fill("#333");

    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

    gauge.title("PHA Profile Rating (/100)");
    gauge.title().fontColor("#FFFFFF");
    gauge.title().fontSize(8);
    gauge.title().orientation("bottom");


    // Draw the chart
    gauge.container('pha_gauge').draw();
}

function drawControlGauge(score) {

    clearContainer('control_gauge');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);

     gauge.background().fill("#333");
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);
    gauge.title("Control Effectiveness %");
     gauge.title().fontColor("#FFFFFF");
    gauge.title().fontSize(8);
    gauge.title().orientation("bottom");
    // Draw the chart
    gauge.container('control_gauge').draw();
}

function showNotification(message, isError = false) {
    var notificationDiv = document.getElementById('notificationMessage');
    notificationDiv.innerHTML = message;
    notificationDiv.style.display = 'block';
    notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

    // Automatically hide the notification after some time
    setTimeout(function() {
        notificationDiv.style.display = 'none';
    }, 5000); // Hide after 5 seconds
}

var map;
</script>
<div class="container-fluid">
<div class="row">

{% include 'menu_bar.html' %}
<div id="notificationMessage" class="notification-message" style="display: none;"></div>
    <!-- Main content area, including sub-menu and tabs -->
    <div class="col-md-9 col-lg-10">
    <div class="top-strip">
        <div class="row">
            <div class="col-md-1"></div>
            <div class="col-md-3">
            <h1 class="page-title">CyberPHA@AnzenOT (Beta)</h1>
            </div>
            <div class="col-md-1">
                <button type="submit" id="btnformSubmit" class="btn nav-link"> Save</button>
                <div id="spinnerContainer" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>

            </div>
            <div class="col-md-1">
                <button type="button" class="btn nav-link " id="resetButton"><i class="bi bi-plus-circle"></i> New</button>
                    <script>
$(document).ready(function() {
    $('#resetButton').on('click', function() {
        // SweetAlert confirmation prompt

            Swal.fire({
                title: 'Create new CyberPHA?',
                text: "Are you sure you want to create a new CyberPHA? Any unsaved data will be lost",
                imageUrl: '/static/images/anzen_owl.png',
                imageWidth: 150, // Adjust as necessary
                imageHeight: 150, // Adjust as necessary
                background: '#000', // Black background
                color: '#fff', // Set text color to white
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                }
        }).then((willProceed) => {
            if (willProceed) {
                // User clicked 'Yes, proceed', so execute the reset actions
                // Reset textboxes and textareas
                $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtAddress, #txtFacility, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtEmployees, #annual_revenue, #cyber_insurance, #shift_model, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary, #zipCode, #txtCity, #txtState ').val('');
                $('#negligible_low, #negligible_high, #minor_low, #minor_high,#moderate_low, #moderate_high, #significant_low, #significant_high, #severe_low, #severe_high').val(0);
                // Reset select dropdowns
                $('#selIndustry, #selFacilityType, #assessment_id, #selZone, #selSL').prop('selectedIndex', 0);
                $('#investmentTable tbody').empty();
                // Enable the controls
                $('#selectFacility, #facilitiesDropdown, #searchButton, #txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtAddress, #txtFacility, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary, #selFacilityType, #selIndustry, #selZone, #selSL, #shift_model, #txtEmployees, #annual_revenue, #cyber_insurance, #countrySelector, #btnformSubmit, #risk-assessment-btn, #zipCode, #txtCity, #txtState').prop('disabled', false);
                $('#btnformSubmit').prop('disabled', false);
                $('#searchButton').prop('disabled', false);
                clearContainer('pha_gauge');
                clearContainer('control_gauge');
                document.getElementById('safetySummaryContainer').innerHTML = '';
                document.getElementById('physicalContainer').innerHTML = '';
                document.getElementById('otherContainer').innerHTML = '';
                document.getElementById('complianceContainer').innerHTML = '';
                document.getElementById('threatContainer').innerHTML = '';
                document.getElementById('chemicalContainer').innerHTML = '';
                document.getElementById('insightContainer').innerHTML = '';
                document.getElementById('strategyContainer').innerHTML = '';
                document.getElementById("lblCyberPHATitle").textContent = '@';

                //reset session variables
                sessionStorage.setItem('activeCyberPHA', '0');
                // Set the value of the hidden text field
                document.getElementById('txtHdnCyberPHAID').value = '0';
                $('.tab-content').removeClass('active').hide();
                $('#tab2').addClass('active').show();
            }
        });
    });
});
</script>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn nav-link " id="scenarioButton"><i class="bi bi-pencil-square"></i> Scenarios</button>
                    <script>
                         $(document).ready(function() {
                            $('#scenarioButton').on('click', function() {
                                window.location.href = "{% url 'OTRisk:assess_cyberpha' %}?active_cyberpha=" + sessionStorage.getItem('activeCyberPHA');
                            });
                         });
                    </script>
            </div>
            <div class="col-md-1">
                <button type="button" id="risk-assessment-btn" class="btn nav-link" >Profile</button></div>


            <div class="col-md-1">
                 <button id="generatePPT" class="btn nav-link" style="visibility: hidden"><i class="bi bi-printer"></i> Print</button>
            </div>
            <div class="col-md-3"></div>
        </div>
        <<div class="row">
            <div class="col-md-1"></div>
            <div class="col-md-5">
                <label id="lblCyberPHATitle" style="font-size: 18px; background-color: #F2BB13; color:#000"></label>
                <div id="progressBarContainerProfile" class="progress" style="display: none;">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBarProfile"></div>
                </div>
                <span id="progressBarMessageProfile" style="display:block; text-align:center; margin-top:5px;"></span>
            </div>

            <div class="col-md-6"></div>
        </div>
    </div>
    <div id="notificationMessage" class="notification-message" style="display: none;"></div>
    <div class="spinner" id="loadingSpinner"></div>
     <form name="frmHeader" id="frmRAW" method="POST" action="{% url 'OTRisk:iotaphamanager' %}">
        {% csrf_token %}

     <input type="hidden" name="txtHdnCyberPHAID" id="txtHdnCyberPHAID" value="0">
     <input type="hidden" id="hdn_pha_score" name="hdn_pha_score" value="{{ pha_header_records.pha_score }}">

    <div class="sub-menu">
        <br><br><br><br><br><br><br><br><br><br>

    <ul>
        <li><a href="#" data-tab="tab1" class="tab-link">CyberPHA List</a></li>
        <li><a href="#" data-tab="tab2" class="tab-link tab-inactive">Facility Details</a></li>
        <li><a href="#" data-tab="tab3" class="tab-link tab-inactive">CyberPHA Setup</a></li>
        <li><a href="#" data-tab="tab13" class="tab-link tab-inactive">Risk Tolerance</a></li>
        <li><a href="#" data-tab="tab4" class="tab-link tab-inactive">Tools & Software</a></li>
        <br>
        <!-- Facility Profile Heading -->
        <li class="facility-profile-heading">Facility Profile
            <ul class="facility-profile-submenu">
                <li><a href="#" data-tab="tab5" class="tab-link tab-inactive">Safety</a></li>
                <li><a href="#" data-tab="tab6" class="tab-link tab-inactive">Chemical</a></li>
                <li><a href="#" data-tab="tab7" class="tab-link tab-inactive">Physical Security</a></li>
                <li><a href="#" data-tab="tab8" class="tab-link tab-inactive">OT Assets</a></li>
                <li><a href="#" data-tab="tab9" class="tab-link tab-inactive">Compliance</a></li>
                <li><a href="#" data-tab="tab10" class="tab-link tab-inactive">Threats</a></li>
                <li><a href="#" data-tab="tab11" class="tab-link tab-inactive">Insights</a></li>
                <li><a href="#" data-tab="tab12" class="tab-link tab-inactive">Strategy</a></li>
            </ul>
        </li>
    </ul>
        <br>
<div id="pha_gauge"></div>

        <div id="control_gauge"></div>
</div>
<script>
$(document).ready(function() {
    // Toggle the display of the submenu when the Facility Profile heading is clicked
    $('.facility-profile-heading').click(function(e) {
        e.preventDefault(); // Prevent the default anchor behavior
        // Toggle the submenu visibility
        $(this).children('.facility-profile-submenu').slideToggle('fast');
    });

    // Prevent the submenu from hiding when its items are clicked
    $('.facility-profile-submenu a').click(function(e) {
        e.stopPropagation(); // Stop the click event from propagating to the parent
    });
});
</script>

     <div class="custom-main-content" >

     <div class="tab-content active" id="tab1">
        <h3 style="color: white">CyberPHA </h3>

        <div class="form-group">

        <label class="form-label" style="color:white">Select a record in the table to view and edit the CyberPHA</label>
        <table id="headertable" class="table small-font compact">
        <thead >
            <tr>
                <th class="th">ID</th>
                <th>Title</th>
                <th>Site</th>
                <th>Type</th>
                <th>Owner</th>
                <th>Date</th>
                <th>BIA</th>
                <th>Scenarios</th>
                <th>Status</th>
                <th>Actions</th>
                <th></th>
                <th></th>
                <!-- Add more <th> elements for each field in the RAWorksheet model -->
            </tr>
        </thead>
        <tbody style="font-size: 10px">
            {% for pha_header_records in pha_header_records %}
                <tr data-id="{{ pha_header_records.ID }}" class="selectable-row">
                    <td>{{ pha_header_records.ID }}</td>
                    <td style="font-size: 14px; font-weight: bold">{{ pha_header_records.title }}</td>
                    <td>{{ pha_header_records.FacilityName }}</td>
                    <td>{{ pha_header_records.FacilityType }}</td>
                    <td>{{ pha_header_records.PHALeader }}</td>
                    <td>{{ pha_header_records.AssessmentStartDate|date:"m/d/Y" }}</td>
                     <input type="hidden" name="AssessmentUnit_{{ pha_header_records.ID }}" value="{{ pha_header_records.AssessmentUnit }}">
                    <input type="hidden" name="AssessmentZone_{{ pha_header_records.ID }}" value="{{ pha_header_records.AssessmentZone }}">
                    <input type="hidden" name="Industry_{{ pha_header_records.ID }}" value="{{ pha_header_records.Industry }}">
                     <td style="background-color:
                        {% if pha_header_records.bia_scenarios == None %}
                            white  <!-- Default color for null or None values -->
                        {% elif pha_header_records.bia_scenarios == 0 or pha_header_records.bia_scenarios == 1 or pha_header_records.bia_scenarios == 2 %}
                            green
                        {% elif pha_header_records.bia_scenarios == 3 %}
                            olive
                        {% elif pha_header_records.bia_scenarios == 4 or pha_header_records.bia_scenarios == 5 %}
                            yellow
                        {% elif pha_header_records.bia_scenarios == 6 or pha_header_records.bia_scenarios == 7 %}
                            orange
                        {% elif pha_header_records.bia_scenarios == 8 or pha_header_records.bia_scenarios == 9 %}
                            red
                        {% elif pha_header_records.bia_scenarios == 10 %}
                            scarlet
                        {% else %}
                            white
                        {% endif %}
                ; text-align: center">
                {{ pha_header_records.bia_scenarios|default_if_none:"N/A" }}  <!-- Display "N/A" if bia_scenarios is None -->
            </td>

                    <td style="text-align: center">{{ pha_header_records.scenario_count }}</td>
                    <td>{{ pha_header_records.latest_workflow_status }}</td>
                     <td style="text-align: center">
                        {% if pha_header_records.ra_action_count > 0 %}
                            <a href="{% url 'OTRisk:ra_actions_view_pha' pha_id=pha_header_records.ID %}">{{ pha_header_records.ra_action_count }}</a>

                        {% else %}
                            {{ pha_header_records.ra_action_count }}
                        {% endif %}
                    </td>
                    <td>
                        {% if pha_header_records.scenario_count != 0 %}
                            <a class="dropdown-item" href="{% url 'OTRisk:pha_reports'  cyber_pha_header_id=pha_header_records.ID  %}" style="font-weight: bold; color: black">Report</a>
                        {% else %}

                        {% endif %}
                    </td>
                    <td>
                    <button type="button" class="delete-btn" data-id="{{ pha_header_records.ID }}">Delete</button>
                    </td>

                    <!-- Add more <td> elements for each field in the RAWorksheet model -->
                </tr>
            {% endfor %}
        </tbody>
        </table>
        </div>

        <script>
         $(document).ready(function() {
             // Event handler for clicking on a table row
             $('#headertable').on('click', 'tbody tr.selectable-row', function () {
                 // Remove 'highlighted' class from all other rows
                 $(this).toggleClass('selected');
                 $('tr.selectable-row').removeClass('highlighted');


                 let recordId = $(this).data('id');  // get the ID of the clicked row
                 let title = $(this).find('td:nth-child(2)').text();
                 let facility = $(this).find('td:nth-child(3)').text();
                 document.getElementById("lblCyberPHATitle").textContent = title + '@' + facility ;
                 //make all the sub menu tabs active
                 $('.tab-link.tab-inactive').removeClass('tab-inactive');
                 fetchHeaderRecord(recordId);
             });

             // Check if a saved_record_id is provided in the rendered context
             let savedRecordId = "{{ saved_record_id }}";  // Get the saved_record_id from the Django context
             if (savedRecordId && savedRecordId !== "None") {
                 $('tr[data-id="' + savedRecordId + '"]').addClass('highlighted');
                 $('.tab-link.tab-inactive').removeClass('tab-inactive');
                 fetchHeaderRecord(savedRecordId);
             }


         });

     $(document).on('click', '.delete-btn', function() {
    var recordId = $(this).data('id');
    if(confirm('Are you sure you want to delete this record?')) {
        $.ajax({
            url: '{% url "OTRisk:delete_pha_record" %}',
            type: 'POST',
            data: {
                'id': recordId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if(response.deleted) {
                    window.location.reload();
                } else {
                    alert('Error deleting record.');
                }
            }
        });
    }
});
    </script>
     </div>

     <div class="tab-content" id="tab2">
        <h3 style="color:white">Facility Details</h3>
        <label id="facility_detail_label" style="color:white">Information about the selected facility </label>
        <div class="row">
            <div class="col-md-6">
                <form id="zipForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="countrySelector" style="color: white">Country:</label>
                                <select id="countrySelector" name="countrySelector" style="width: 400px;"></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="zipCode" style="color: white">Zip/Post Code:</label>
                            <input type="text" class="form-control" id="zipCode" name="zipCode" placeholder="Enter ZIP Code">
                            <div class="modal fade" id="facilitiesModal" tabindex="-1" aria-labelledby="facilitiesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="facilitiesModalLabel">Select a Facility</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <select id="facilitiesDropdown" class="form-control"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="selectFacility">Select</button>
      </div>
    </div>
  </div>
</div>
                            </div>
                        </div>

                    </div>
                </form>
            <script>
                var mapPopulated = false;

               function drawGoogleMap(latitude, longitude, address, country) {

                    var mapElement = document.getElementById('facility_map');

                    var createMap = function(lat, lng, title) {
                        setTimeout(function() { // Introduce a delay
                            var latLng = new google.maps.LatLng(lat, lng);
                            var map = new google.maps.Map(mapElement, {
                                center: latLng,
                                zoom: 18,
                                mapTypeId: google.maps.MapTypeId.SATELLITE
                            });

                            var marker = new google.maps.Marker({
                                position: latLng,
                                map: map,
                                title: title || 'Selected Facility'
                            });

                            mapPopulated = true;
                        }, 100); // Delay in milliseconds, adjust as needed
                    };



    if (latitude && longitude) {
        // If latitude and longitude are provided, draw the map directly
        createMap(parseFloat(latitude), parseFloat(longitude), 'Facility Location');
    } else if (address && country) {
        // If address and country are provided, use Geocoding API to find the location
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({ 'address': address + ', ' + country }, function(results, status) {
            if (status === 'OK') {
                var location = results[0].geometry.location;
                createMap(location.lat(), location.lng(), results[0].formatted_address);
            } else {
                console.error('Geocode was not successful for the following reason: ' + status);
            }
        });
    } else {
        console.error('Insufficient data provided to draw the map.');
    }
}


                $(document).ready(function() {
                        function attemptMapPopulation() {

                            var country = $('#countrySelector').val();
                            var city = $('#txtCity').val().trim();
                            var address = $('#txtAddress').val().trim();
                            var zipCode = $('#zipCode').val().trim();

                            // Check if country is not "United States", city is entered, and map hasn't been populated
                            if (!mapPopulated || country !== "United States" && city ) {
                                var fullAddress = address + ', ' + city + ', ' + zipCode;
                                drawGoogleMap(null, null, fullAddress, country);
                                var latitude = "";
                                var longitude = "";
                                var address = fullAddress;
                                var country = country;

                                $.ajax({
                                    type: 'GET',
                                    url: '/OTRisk/air_quality_index/',
                                    data: { 'lat': latitude, 'lon': longitude, 'address': address, 'country': country },
                                    success: function(response) {

                                        if (response.aqi !== undefined) {
                                            $('#txthdnAQI').val(response.aqi);
                                            var aqiValue = response.aqi;
                                            var aqiGlobe = $('#aqiGlobe');
                                            aqiGlobe.text(aqiValue);

                                            // Determine the background color based on AQI value
                                            var bgColor;
                                            if (aqiValue <= 50) {
                                                bgColor = 'green';
                                            } else if (aqiValue <= 100) {
                                                bgColor = 'yellow';
                                            } else if (aqiValue <= 150) {
                                                bgColor = 'orange';
                                            } else if (aqiValue <= 200) {
                                                bgColor = 'red';
                                            } else if (aqiValue <= 300) {
                                                bgColor = 'purple';
                                            } else if (aqiValue <= 500) {
                                                bgColor = 'brown';
                                            } else {
                                                bgColor = 'grey'; // Default or error case
                                            }

                                            // Apply the background color
                                            aqiGlobe.css('background-color', bgColor);
                                        } else {

                                        }
                                    },
                                    error: function() {

                                    }
                                });
                            }
                        }

                        // Event listener for the city input field losing focus
                        $('#txtCity').blur(function() {
                            attemptMapPopulation();
                        });

                        var facilitiesData = []; // To store facilities data

                        $('#searchButton').on('click', function() {
                            var zipCode = $('#zipCode').val().trim();
                            // Validate ZIP code format (standard 5 digits or ZIP+4 format)
                            var isValidZip = /^\d{5}(-\d{4})?$/.test(zipCode);

                            if (!zipCode || !isValidZip) {
                                // Show SweetAlert message instead of the default alert
                                swal.fire("Invalid Input", "Enter a valid ZIP code to search.", "error");
                                return; // Exit the function if ZIP code is invalid
                            }

                            $('#spinner_facility').show(); // Show spinner

                            $.ajax({
                                type: 'GET',
                                url: '/OTRisk/facilities/',
                                data: { 'zip': zipCode },
                                success: function(response) {
                                    $('#spinner_facility').hide(); // Hide spinner
                                    var dropdown = $('#facilitiesDropdown');
                                    dropdown.empty(); // Clear previous options
                                    facilitiesData = response.facilities.Results.FRSFacility; // Store facilities data

                                    if (facilitiesData && facilitiesData.length > 0) {
                                        facilitiesData.forEach(function(facility) {
                                            dropdown.append($('<option>', {
                                                value: facility.RegistryId,
                                                text: facility.FacilityName
                                            }));
                                        });
                                        $('#facilitiesModal').modal('show'); // Show the modal
                                    } else {
                                        alert('No facilities found.');
                                    }
                                },
                                error: function() {
                                    $('#spinner_facility').hide(); // Hide spinner on error
                                    alert('Failed to fetch facilities. Please try again.');
                                }
                            });
                        });

                        // Handle facility selection and display details
                        $('#selectFacility').click(function() {
                            var selectedRegistryId = $('#facilitiesDropdown').val();
                            var selectedFacility = facilitiesData.find(facility => facility.RegistryId === selectedRegistryId);
                            if (selectedFacility) {
                                var details = Object.keys(selectedFacility).map(key => `${key}: ${selectedFacility[key]}`).join('\n');
                                $('#txtFacility').val(selectedFacility.FacilityName || '');
                                $('#txtAddress').val(selectedFacility.LocationAddress || '');
                                $('#txtCity').val(selectedFacility.CityName || '');
                                $('#txtState').val(selectedFacility.StateAbbr || '');
                                $('#txthdnLat').val(selectedFacility.Latitude83);
                                $('#txthdnLong').val(selectedFacility.Longitude83);
                                $('#facilitiesModal').modal('hide'); // Hide the modal

                                drawGoogleMap(selectedFacility.Latitude83, selectedFacility.Longitude83, null, null); // Example for New York, NY
                                var latitude = selectedFacility.Latitude83;
                                var longitude = selectedFacility.Longitude83;

                                $.ajax({
                                    type: 'GET',
                                    url: '/OTRisk/air_quality_index/',  // Update with the correct path to your Django view
                                    data: { 'lat': latitude, 'lon': longitude },
                                    success: function(response) {
                                        if (response.aqi !== undefined) {
                                            $('#txthdnAQI').val(response.aqi);
                                            var aqiValue = response.aqi;
                                            var aqiGlobe = $('#aqiGlobe');
                                            aqiGlobe.text(aqiValue);
                                            // Determine the background color based on AQI value
                                            var bgColor;
                                            if (aqiValue <= 50) {
                                                bgColor = 'green';
                                            } else if (aqiValue <= 100) {
                                                bgColor = 'yellow';
                                            } else if (aqiValue <= 150) {
                                                bgColor = 'orange';
                                            } else if (aqiValue <= 200) {
                                                bgColor = 'red';
                                            } else if (aqiValue <= 300) {
                                                bgColor = 'purple';
                                            } else if (aqiValue <= 500) {
                                                bgColor = 'brown';
                                            } else {
                                                bgColor = 'grey'; // Default or error case
                                            }

                                            // Apply the background color
                                            aqiGlobe.css('background-color', bgColor);
                                        } else {

                                        }
                                    },
                                    error: function() {

                                    }
                                });
                            }
                        });
                    });
                    $(document).ready(function() {
                        // Initially hide the search button if the selected country is not "United States"
                        toggleSearchButtonVisibility();

                        // Event listener for changes on the country selector
                        $('#countrySelector').change(function() {
                            toggleSearchButtonVisibility();
                        });

                        function toggleSearchButtonVisibility() {
                            // Check if the selected country is "United States"
                            if ($('#countrySelector').val() === "United States") {
                                $('#searchButton').show(); // Show the search button
                            } else {
                                $('#searchButton').hide(); // Hide the search button
                            }
                        }
                    });

                </script>
                <div class="form-group">
                    <label for="txtFacility" style="color: white">Facility:</label>
                    <input type="text" class="form-control" name="txtFacility" id="txtFacility" value="{{ current_pha_header.FacilityName }}"  maxlength="100"  required>
                </div>
            <div class="form-group">
                    <label for="txtAddress" style="color: white">Facility Address:</label>
                    <input type="text"  class="form-control"  name="txtAddress" id="txtAddress"  maxlength="500" value="{{ current_pha_header.facilityAddress }}" required>
                    <br>
                    <label for="txtCity" style="color: white">City:</label>
                    <input type="text"  class="form-control"  name="txtCity" id="txtCity"  maxlength="50" value="" required>
                    <br>
                    <label for="txtState" style="color: white">State:</label>
                    <input type="text"  class="form-control"  name="txtState" id="txtState"  maxlength="50" value="" required>
            </div>
                <div class="form-group">
                    <label for="selIndustry" style="color: white">Industry:</label>
                    <select class="form-control" name="selIndustry" id="selIndustry">
                        <option value=""> -- Select Industry -- </option>
                        {% for industry in industries %}
                            <option value="{{ industry.Industry }}"
                                    {% if current_pha_header.Industry == industry.Industry %}selected{% endif %}>
                                {{ industry.Industry }}
                            </option>
                        {% endfor %}
                    </select>
                    </div>

                    <div class="form-group">
                    <label for="txtEmployees" style="color: white">Employees on Site:</label>
                    <input type="number" class="form-control" name="txtEmployees" id="txtEmployees" value="{{ current_pha_header.EmployeesOnSite }}" max="99999">
                    </div>

                    <div class="form-group">
                    <label for="selFacilityType" style="color: white">Facility Type:</label>
                    <select class="form-control" name="selFacilityType" id="selFacilityType">
                        <option value=""> -- Select Facility Type -- </option>
                        {% for facilities in facilities %}
                                <option value="{{ facilities.FacilityType }}"
                                {% if current_pha_header.FacilityType == facilities.FacilityType %}selected{% endif %}>
                                {{  facilities.FacilityType }}</option>
                            {% endfor %}
                    </select>
                    <script>
                        $(document).ready(function() {
                            $('#selFacilityType').select2();
                            $('#selIndustry').select2();
                        });

                    </script>
                </div>
                 <div class="form-group">
                    <div class="row">
                        <div class="col-md-4" style="background-color: #5E6266;">
                            <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="annual_revenue" style="color: white">Facility Annual Revenue:</label>
                                    <input type="text" class="form-control currency-input" name="annual_revenue" id="annual_revenue" value="{{ annual_revenue_str|default:'0' }}" oninput="checkMaxValue(this)" required>
                                    <script>
                                        document.addEventListener("DOMContentLoaded", function() {
                                            const currencyInput = document.getElementById('annual_revenue');

                                            currencyInput.addEventListener('input', function(e) {
                                                // Strip any non-digit characters
                                                let value = e.target.value.replace(/\D/g, '');

                                                // Convert the number to a currency format
                                                e.target.value = parseInt(value).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
                                            });
                                        });

                                        function checkMaxValue(input) {
                                            // Remove any non-digit characters (e.g., currency symbols, commas)
                                            var numericValue = input.value.replace(/[^0-9]/g, '');

                                            if (parseInt(numericValue) > 999999999) {
                                                input.value = '$999,999,999';
                                            } else {
                                                // Optionally, re-add currency formatting
                                                input.value = '$' + numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                                            }
                                        }
                                    </script>

                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" style="background-color: #5E6266;">
                            <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
                                <div class="card-body">
                                    <label for="coho" style="color: white">Operating Cost/Hour:</label>
                                    <input type="text" class="form-control currency-input" name="coho" id="coho" value="{{ coho_str|default:'0' }}" oninput="checkMaxValue(this)" required>
                                    <script>
                                        document.addEventListener("DOMContentLoaded", function() {
                                            const currencyInput = document.getElementById('coho');

                                            currencyInput.addEventListener('input', function(e) {
                                                // Strip any non-digit characters
                                                let value = e.target.value.replace(/\D/g, '');

                                                // Convert the number to a currency format
                                                e.target.value = parseInt(value).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
                                            });
                                        });


                </script>

                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" style="background-color: #5E6266;">
                            <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
                                <div class="card-body">
                                    <label for="npm" style="color: white">Facility NPM (%):</label>
                                    <input type="number" class="form-control" name="npm" id="npm" value="{{ npm|default:'0' }}" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

             </div>

            <div class="col-md-6" style="background-color: #464748;">
                <div class="form-group">
                    <div id="facility_map" style="height: 400px;"></div>
                    <input type="hidden" id="txthdnLat">
                    <input type="hidden" id="txthdnLong">
                </div>
                <div class="form-group">
                <label style="color: white">Air Quality Index (AQI):</label>
                <div id="aqiGlobe" class="aqi-globe">--</div>
                    <input type="hidden" id="txthdnAQI">
            </div>

                <div class="form-group">
                    <label for="txtUnit" style="color: white">Unit:</label>
                    <input type="text" class="form-control" name="txtUnit" id="txtUnit" value="{{ current_pha_header.AssessmentUnit }}" required maxlength="100">
                    <br>
                    <label for="selZone" style="color: white">Zone:</label>
                    <select class="form-control" name="selZone" id="selZone">
                        <option value = ""> -- Select Plant Zone -- </option>
                        {% for zone in zones %}
                            <option value="{{ zone.PlantZone }}"
                            {% if current_pha_header.AssessmentZone == zone.PlantZone %}selected{% endif %}>
                                {{ zone.PlantZone }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="shift_model" style="color: white">Shift Model:</label>
                    <select class="form-control" name="shift_model" id="shift_model" required>
                        <option value="">Select Shift Model</option>
                        {% for model in SHIFT_MODELS %}
                            <option value="{{ model.0 }}" {% if current_pha_header.shift_model == model.0 %}selected{% endif %}>{{ model.1 }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group d-flex flex-column align-items-center justify-content-center h-100">
                <label for="ir_plan" style="color: white">OT IR Plan (Yes/No):</label>
                <br>
                <input type="checkbox" id="ir_plan" name="ir_plan" style="transform: scale(2); margin-right: 5px;">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group d-flex flex-column align-items-center justify-content-center h-100">
                <label for="ir_plan_date" style="color: white">Last Tested Date:</label>
                <br>
                <input type="date" class="form-control" name="ir_plan_date" id="ir_plan_date" value="">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group d-flex flex-column align-items-center justify-content-center h-100">
                <label for="ir_plan_ut" style="color: white">Never Tested (Yes/No):</label>
                <br>
                <input type="checkbox" id="ir_plan_ut" name="ir_plan_ut" style="transform: scale(2); margin-right: 5px;">
            </div>
        </div>
    </div>
</div>

    <div class="form-group">
        <label for="selSL" style="color: white">Target Security Level (SL-T):</label>
        <select class="form-control" name="selSL" id="selSL">
        <option value="0"> -- Select SL-T -- </option>
        {% for value, description in SECURITY_LEVELS %}
            <option value="{{ value }}"
            {% if current_pha_header.sl_t|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                {{ description }}</option>
        {% endfor %}
        </select>
    </div>



    </div>
</div>
</div>

     <div class="tab-content" id="tab3">
        <h3 style="color:white">CyberPHA Setup</h3>
        <label id="cyberpha_detail_label" style="color:white">Information about the CyberPHA </label>

        <script>
        $(document).ready(function() {
        $('#assign-group-btn').on('click', function() {

        var cyberphaId = sessionStorage.getItem('activeCyberPHA'); // Retrieve from session storage
        var existingGroupId = $('#existing_group').val();
        var newGroupName = $('#new_group_name').val();
        var newGroupType = $('#new_group_type').val();

        $.ajax({
            type: 'POST',
            url: '/OTRisk/assign_cyberpha_to_group/', // URL to Django view for assignment
            data: {
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                'cyberpha_id': cyberphaId,
                'existing_group_id': existingGroupId,
                'new_group_name': newGroupName,
                'new_group_type': newGroupType
            },
            success: function(response) {
                // Handle success
                var assignGroupModal = new bootstrap.Modal(document.getElementById('assignGroupModal'));
                assignGroupModal.hide();

                updateGroupAssignmentsDisplay(cyberphaId); // Function to refresh group assignments on the page
                updateGroupList();

            },
            error: function(error) {
                // Handle error
                console.error('Error:', error);
            }
        });
    });
});

function updateGroupAssignmentsDisplay(cyberphaId) {
    $.ajax({
        type: 'GET',
        url: '/OTRisk/fetch_groups/', // URL to a Django view that returns group assignments
        data: { 'cyberpha_id': cyberphaId },
        success: function(response) {
            // Assuming 'response' contains an array of group names or objects
            var currentGroupsDiv = $('#currentGroupsDiv');
            currentGroupsDiv.empty();

            if (response.groups && response.groups.length > 0) {
                response.groups.forEach(function(group) {
                    // Assuming 'group' contains a property 'name'
                    currentGroupsDiv.append($('<p>').text(group.name));
                });
            } else {
                currentGroupsDiv.append($('<p>').text('No groups assigned.'));
            }
        },
        error: function(error) {
            console.error('Error fetching group assignments:', error);
        }
    });
}

function updateGroupList() {
    $.ajax({
        type: 'GET',
        url: '/OTRisk/fetch_all_groups/', // URL to Django view
        success: function(response) {
            var existingGroupSelect = $('#existing_group');
            existingGroupSelect.empty();

            existingGroupSelect.append($('<option>', {
                value: '',
                text: 'Select a Group'
            }));

            response.groups.forEach(function(group) {
                existingGroupSelect.append($('<option>', {
                    value: group.id,
                    text: group.name
                }));
            });
        },
        error: function(error) {
            console.error('Error fetching groups:', error);
        }
    });
}


document.addEventListener('DOMContentLoaded', function() {
    var workflowSelector = document.getElementById('workflow_selector');
    workflowSelector.addEventListener('change', function() {
        if (this.value === 'Complete') {
            swal.fire({
                title: 'CyberPHA Completed?',
                text: "Once you save the status of this record as 'Complete', you will not be able to make further changes.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, I understand'
            });
        }
    });
});

updateGroupList();
</script>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="txtTitle" style="color: white">CyberPHA Title</label>
                    <input type="text" class="form-control" name="txtTitle" id="txtTitle" value="{{ current_pha_header.title }}" maxlength="100" style="font-size: 16px; font-weight: bold;" required>
                </div>
                <div class="form-group">
                    <label for="txtLeader" style="color: white">CyberPHA Owner:</label>
                    <input type="text" class="form-control" name="txtLeader" id="txtLeader" value="{{ current_pha_header.PHALeader }}" maxlength="100"  required>
                </div>
                <div class="form-group">
                    <label for="txtLeaderEmail" style="color: white">CyberPHA Owner Email:</label>
                    <input type="email" class="form-control" name="txtLeaderEmail" id="txtLeaderEmail" value="{{ current_pha_header.PHALeaderEmail }}" required onblur="validateEmail(this)">
                    <script type="text/javascript">
                    function validateEmail(input) {
                        var regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                        if (!regex.test(input.value)) {
                            alert('Please enter a valid email address');
                            input.focus();
                        }
                    }
                </script>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="txtStartDate" style="color: white">Start Date:</label>
                            <input type="date" class="form-control" name="txtStartDate" id="txtStartDate"  value="{{ current_pha_header.AssessmentStartDate }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="txtEndDate" style="color: white">End Date:</label>
                            <input type="date" class="form-control" name="txtEndDate" id="txtEndDate" value="{{ current_pha_header.AssessmentEndDate }}" onchange="validateDates()">
                        </div>
                         <script type="text/javascript">
                        function validateDates() {
                            var startDate = document.getElementById('txtStartDate').value;
                            var endDate = document.getElementById('txtEndDate').value;

                            if (endDate < startDate) {
                                alert('End date cannot be before start date');
                                document.getElementById('txtEndDate').value = '';
                            }
                        }
                    </script>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label for="assessment_id" style="color: white">Control Assessment:</label>
                    <select class="form-control"   id="assessment_id" name="assessment_id">
                        <option value="">Select an Assessment</option>
                        {% for assessment in assessments %}
                            <option value="{{ assessment.id }}"
                            {% if current_pha_header.assessment == assessment.id %}select{% endif %}>
                                {{ assessment.name }}</option>
                        {% endfor %}
                    </select>
                    <div id="assessmentspinnerContainer" style="display: none;">
                        <div class="spinner-border" role="status">

                            <span class="sr-only">Loading...</span>
                            <input type="hidden" id="last_assessment_score" name="last_assessment_score">
                            <input type="hidden" id="last_assessment_summary" name="last_assessment_summary">
                        </div>
                    </div>
                </div>
             <!-- Container to display the summary and score -->
            <span id="assessment_summary" ></span>
            <br>
            <span id="assessment_score" ></span>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#moderatorModal">
                        Select CyberPHA Moderators
                    </button>
                </div>
                <script>

                        $(document).ready(function() {

                            let isUserChange = false;
                            $("#assessment-select").selectmenu().selectmenu("menuWidget").addClass("overflow");

                             $('#assessment_id').change(function() {
                                  if (!isUserChange) return;
                            var assessmentId = $(this).val();
                            var industry = document.getElementById('selIndustry').value;
                            var facilityType = document.getElementById('selFacilityType').value;
                            if(assessmentId  && isUserChange) {
                                $('#assessmentspinnerContainer').show();
                                $.ajax({
                                    url: '/OTRisk/get_assessment_summary/',  // Update with the actual URL
                                    type: 'POST',
                                    data: { 'assessment_id': assessmentId,
                                                'industry': industry,
                                                'facilityType': facilityType,
                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                    },
                                    success: function(response) {
                                        $('#assessmentspinnerContainer').hide();
                                        if(response.error) {
                                            alert(response.error);
                                        } else {
                                            $('#assessment_summary').text(response.summary);
                                            $('#assessment_score').text('Score: ' + response.score  + '/100');
                                            setBorderColorByScore(response.score);
                                            drawControlGauge(response.score);
                                            document.getElementById('last_assessment_score').value = response.score;
                                            document.getElementById('last_assessment_summary').value = response.summary;
                                        }
                                    },
                                    error: function(xhr, errmsg, err) {
                                        $('#assessmentspinnerContainer').hide();
                                        alert('AJAX call failed: ' + errmsg);
                                    }
                                });
                            }

                         isUserChange = false;
                        });

                        $('#assessment_id').change(function() {
                            isUserChange = true; // Set true on any change event
                        });
                       function fetchHeaderRecord(recordId) {
                            isUserChange = false; // Ensure the flag is false before programmatically setting value
                            $('#assessment_id').val(recordId).trigger('change');
                            // The flag doesn't need to be reset here as it's handled in the change event
                        }
                         function setBorderColorByScore(score) {
                            var borderColor = '#4CAF50'; // Default color
                            score = parseInt(score); // Convert score to integer

                            if (score < 30) {
                                borderColor = 'red';
                            } else if (score >= 30 && score <= 70) {
                                borderColor = 'yellow';
                            } // If score > 70, default green color is used

                            $('#assessment_summary').css('border-left', '5px solid ' + borderColor);
                        }
                       });
                    </script>

                <div class="form-group">
                    <label for="workflow_selector" style="color: white">Workflow Status:</label>
                    <select class="form-control" id="workflow_selector" name="workflow_selector">
                        <option value="">Select a Status</option>
                        {% for status, status_display in workflow_status_choices %}
                            <option value="{{ status }}"
                                    {% if current_workflow_status == status %} selected {% endif %}>
                                {{ status_display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="color: white">
                        Current Group Assignments:
                        <br>
                        <div id="currentGroupsDiv" style="font-size: 16px">
                        </div>
                    <br>
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#assignGroupModal">
                        Assign to Group
                    </button>

            </div>

            </div>
        </div>

        <div class="modal" id="assignGroupModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Assign to Group</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="group-assignment-form">
                            <!-- Existing Groups -->
                            <div class="form-group">
                                <label for="existing_group">Existing Group:</label>
                                <select class="form-control" id="existing_group" name="existing_group">
                                    <option value="">Select a Group</option>
                                    {% for group in all_groups %}
                                        <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- New Group -->
                            <div class="form-group">
                                <label for="new_group_name">New Group Name:</label>
                                <input type="text" class="form-control" id="new_group_name" name="new_group_name">
                            </div>
                            <div class="form-group">
                            <label for="new_group_type">New Group Type:</label>
                            <select class="form-control" id="new_group_type" name="new_group_type">
                                {% for type_value, type_name in group_types %}
                                    <option value="{{ type_value }}">{{ type_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                            <!-- Hidden Field for CyberPHA ID -->
                            <input type="hidden" name="cyberpha_id" value="{{ current_pha_header.ID }}">
                            <!-- Submit Button -->
                            <button type="button" id="assign-group-btn"  class="btn btn-primary">Assign</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>




     </div>
     <div class="tab-content" id="tab4">
        <h3 style="color: white">OT Tools & Software</h3>
         <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label style="color:white">List tools and software purchased to mitigate OT cybersecurity risks</label>
                <div class="table-responsive">

                  <table class="table" id="investmentTable">
                    <colgroup>
                          <col span="1" style="width: 20%;"> <!-- Type -->
                          <col span="1" style="width: 20%;"> <!-- Vendor Name -->
                          <col span="1" style="width: 20%;"> <!-- Product Name -->
                          <col span="1" style="width: 15%;"> <!-- Cost -->
                          <col span="1" style="width: 15%;"> <!-- Date -->
                          <col span="1" style="width: 10%;"> <!-- Action -->
                        </colgroup>
                    <thead>
                      <tr>
                        <th>Type</th>
                        <th>Vendor Name</th>
                        <th>Product Name</th>
                        <th>Cost</th>
                        <th>Date</th> <!-- New Date Column -->
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                          <td>
                              <input type="hidden" name="investment_id[]" value="{{ investment.id | default:'' }}" class="form-control">
                              <select name="investment_type[]" class="form-control">
                                <option value="Software">Software</option>
                                <option value="Hardware">Hardware</option>
                              </select>
                          </td>
                          <td><input type="text" name="vendor_name[]" class="form-control" /></td>
                          <td><input type="text" name="product_name[]" class="form-control" /></td>
                          <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
                          <td><input type="date" name="date[]" class="form-control" /></td>
                          <td><button class="btn btn-danger removeRow">Remove</button></td>
                      </tr>
                    </tbody>

                  </table>
                  <button type="button" class="btn btn-primary" id="addRow">Add Row</button>

                </div>
            </div>
            <script>
            $(document).ready(function() {
              $("#addRow").click(function() {
            var newRow = `<tr>
                <td>
                    <input type="hidden" name="investment_id[]" value="" class="form-control">
                    <select name="investment_type[]" class="form-control">
                        <option value="Software">Software</option>
                        <option value="Hardware">Hardware</option>
                        <option value="People">People</option> <!-- Assuming you want to add this option -->
                    </select>
                </td>
                <td><input type="text" name="vendor_name[]" class="form-control" /></td>
                <td><input type="text" name="product_name[]" class="form-control" /></td>
                <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
                <td><input type="date" name="date[]" class="form-control" /></td>
                <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
            </tr>`;
            $("#investmentTable tbody").append(newRow);
        });


              $(document).on('click', '.removeRow', function() {
                $(this).closest('tr').remove();
              });
            });
            </script>
         </div>
     </div>
     <div class="tab-content" id="tab5">
        <h3 style="color:white">Safety Profile <img src="{% static 'images/osha_safety.png' %}" style="width: 50px" class="img-fluid" alt="Logo"></h3>
         <p style="color:white">Safety considerations for the facility</p>

            <div class="form-group">
            <div id="safetySummaryContainer" class="safety-summary-container"></div>
            <textarea rows="25" name="txtSafetySummary" id="txtSafetySummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.safetySummary }}</textarea>


            </div>
     </div>
     <div class="tab-content" id="tab6">
        <h3 style="color:white">Chemical Profile <img src="{% static 'images/osha_chemical.png' %}" style="width: 50px" class="img-fluid" alt="Logo"></h3>
        <p style="color:white">Chemical storage and by-product profile for the facility</p>
         <div class="form-group">
         <div id="chemicalContainer" class="safety-summary-container"></div>
         <textarea rows="25" name="txtChemical" id="txtChemical" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.chemicalSummary }}</textarea>
         </div>
     </div>
     <div class="tab-content" id="tab7">
        <h3 style="color:white">Physical Security Profile <img src="{% static 'images/osha_exclamation.png' %}" style="width: 50px" class="img-fluid" alt="Logo"></h3>
        <p style="color:white">Physical security considerations for the location of the facility</p>
         <div class="form-group">
         <div id="physicalContainer" class="safety-summary-container"></div>
                <textarea rows="25" name="txtPhysical" id="txtPhysical" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.physicalSummary }}</textarea>
             </div>
     </div>
     <div class="tab-content" id="tab8">
        <h3 style="color:white">OT Asset Profile</h3>
        <p style="color:white">OT devices most likely to be present within the facility</p>
          <div class="form-group">
         <div id="otherContainer" class="safety-summary-container"></div>
                <textarea rows="25" name="txtOther" id="txtOther" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.otherSummary }}</textarea>
          </div>
     </div>
     <div class="tab-content" id="tab9">
        <h3 style="color:white">Compliance Profile </h3>
         <p style="color:white">Regulatory compliance requirements most likely to apply for this facility</p>
         <div class="form-group">
         <div id="complianceContainer" class="safety-summary-container"></div>
         <textarea rows="25" name="txtCompliance" id="txtCompliance" hidden class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.complianceSummary }}</textarea>
         </div>
         </div>
     <div class="tab-content" id="tab10">
        <h3 style="color:white">Threat Profile</h3>
        <p style="color:white">OT Cybersecurity threats most relevant to this facility</p>
         <div class="form-group">
         <div id="threatContainer" class="safety-summary-container"></div>
                <textarea rows="25" name="threatSummary" id="threatSummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.threatSummary }}</textarea>
         </div>
         </div>
     <div class="tab-content" id="tab11">
        <h3 style="color:white">Security Insights</h3>
        <p style="color:white">Relevant OT Cybersecurity insights to consider for the facility</p>
         <div class="form-group">
         <div id="insightContainer" class="safety-summary-container"></div>
                <textarea rows="25" name="insightSummary" id="insightSummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.insightSummary }}</textarea>
         </div>
     </div>
     <div class="tab-content" id="tab12">
        <h3 style="color:white">OT Cybersecurity Strategy</h3>
        <p style="color:white">OT Cybersecurity strategy most relevant to this facility</p>
        <div class="form-group">
            <div id="strategyContainer" class="safety-summary-container"></div>
            <textarea rows="25" name="strategySummary" id="strategySummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly hidden>{{ current_pha_header.strategySummary }}</textarea>
        </div>
     </div>
     <div class="tab-content" id="tab13">
        <h3 style="color:white">Risk Tolerance Levels</h3>
        <p style="color:white">Specify the risk tolerance levels for each severity category. Values should be entered in USD.</p>

         <div class="row">
             <div class="col-md-6">
                <div class="form-group row">
                    <div class="col-md-6">
                        <label style="color:white">Negligible Low Value ($):</label>
                        <input type="number" class="form-control" id="negligible_low" name="negligible_low" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                    <div class="col-md-6">
                        <label style="color:white">Negligible High Value ($):</label>
                        <input type="number" class="form-control" id="negligible_high" name="negligible_high" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-md-6">
                        <label style="color:white">Minor Low Value ($):</label>
                        <input type="number" class="form-control" id="minor_low" name="minor_low" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                    <div class="col-md-6">
                        <label style="color:white">Minor High Value ($):</label>
                        <input type="number" class="form-control" id="minor_high" name="minor_high" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-md-6">
                        <label style="color:white">Moderate Low Value ($):</label>
                        <input type="number" class="form-control" id="moderate_low" name="moderate_low" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                    <div class="col-md-6">
                        <label style="color:white">Moderate High Value ($):</label>
                        <input type="number" class="form-control" id="moderate_high" name="moderate_high" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-md-6">
                        <label style="color:white">Significant Low Value ($):</label>
                        <input type="number" class="form-control" id="significant_low" name="significant_low" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                    <div class="col-md-6">
                        <label style="color:white">Significant High Value ($):</label>
                        <input type="number" class="form-control" id="significant_high" name="significant_high" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-md-6">
                        <label style="color:white">Severe Low Value ($):</label>
                        <input type="number" class="form-control" id="severe_low" name="severe_low" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                    <div class="col-md-6">
                        <label style="color:white">Severe High Value ($):</label>
                        <input type="number" class="form-control" id="severe_high" name="severe_high" placeholder="0.00" min="0" step="1000" style="max-width: 250px;">
                    </div>
                </div>

             </div>
             <div class="col-md-6">
                 <div class="form-group">
                 <div id="riskHeatMap" style="width: 100%; height: 400px;"></div>
                 </div>
             </div>
         </div>

        <h3 style="color:white">Cybersecurity Insurance Cover</h3>
        <p style="color:white">Specific cybersecurity insurance policy coverage if relevant or load previously saved defaults.</p>
        <div class="row">
             <div class="col-md-6" style="color:white">
                <div class="form-group row">
                        <div class="col-md-3">
                            <label class="form-check-label" for="useOrgDefaults">
                                Use organization defaults
                            </label>
                        </div>
                        <div class="col-md-3">
                            <input class="form-check-input" type="checkbox" id="useOrgDefaults" name="useOrgDefaults">
                        </div>
                        <div class="col-md-6">

                        </div>
                    </div>
                 <div class="form-group row">
                        <div class="col-md-3">
                            <label for="first_party_coverage">First Party Coverage:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="first_party_coverage" name="first_party_coverage">
                        </div>
                        <div class="col-md-3">
                            <label for="third_party_coverage">Third Party Coverage:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="third_party_coverage" name="third_party_coverage">
                        </div>
                        <div class="col-md-3">
                            <label for="security_event_liability">Security Event Liability:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="security_event_liability" name="security_event_liability">
                        </div>
                    </div>
                <div class="form-group row">
                        <div class="col-md-3">
                             <label for="privacy_regulatory_actions">Privacy Regulatory Actions:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="privacy_regulatory_actions" name="privacy_regulatory_actions">
                        </div>
                        <div class="col-md-3">
                            <label for="cyber_extortion_coverage">Cyber Extortion Coverage:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="cyber_extortion_coverage" name="cyber_extortion_coverage">
                        </div>
                        <div class="col-md-3">
                            <label for="data_breach_response_coverage">Data Breach Response Coverage:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="data_breach_response_coverage" name="data_breach_response_coverage">
                        </div>
                    </div>
                 <div class="form-group row">
                        <div class="col-md-3">
                              <label for="business_interruption_coverage">Business Interruption Coverage:</label>
                        </div>
                        <div class="col-md-1">
                           <input type="checkbox" class="form-check-input" id="business_interruption_coverage" name="business_interruption_coverage">
                        </div>
                        <div class="col-md-3">
                            <label for="dependent_business_coverage">Dependent Business Coverage:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="dependent_business_coverage" name="dependent_business_coverage">
                        </div>
                        <div class="col-md-3">
                           <label for="data_recovery">Data Recovery:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="data_recovery" name="data_recovery">
                        </div>
                    </div>
                  <div class="form-group row">
                        <div class="col-md-3">
                                <label for="hardware_replacement">Hardware Replacement:</label>
                        </div>
                        <div class="col-md-1">
                             <input type="checkbox" class="form-check-input" id="hardware_replacement" name="hardware_replacement">
                        </div>
                        <div class="col-md-3">
                            <label for="reputation_harm">Reputation Harm:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="reputation_harm" name="reputation_harm">
                        </div>
                        <div class="col-md-3">
                            <label for="media_liability">Media Liability:</label>
                        </div>
                        <div class="col-md-1">
                           <input type="checkbox" class="form-check-input" id="media_liability" name="media_liability">
                        </div>
                    </div>
                 <div class="form-group row">
                        <div class="col-md-3">
                            <label for="pci_dss">PCI DSS:</label>
                        </div>
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input" id="pci_dss" name="pci_dss">
                        </div>
                        <div class="col-md-3">

                        </div>
                        <div class="col-md-1">

                        </div>
                        <div class="col-md-3">

                        </div>
                        <div class="col-md-1">

                        </div>
                    </div>
                 <div class="form-group row">
                        <div class="col-md-3">
                            <label for="overall_aggregate_limit">Overall Aggregate Limit ($):</label>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="overall_aggregate_limit" name="overall_aggregate_limit" placeholder="0.00" min="0" max="999999999" step="0.01" required>
                        </div>
                        <div class="col-md-3">
                            <label for="per_claim_limit">Per Claim Limit ($):</label>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="per_claim_limit" name="per_claim_limit" placeholder="0" min="0" max="365" required>
                        </div>

                    </div>
                 <div class="form-group row">
                        <div class="col-md-3">
                            <label for="deductible_amount">Deductible ($):</label>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="deductible_amount" name="deductible_amount" placeholder="0.00" min="0" max="999999999" step="0.01" required>
                        </div>
                        <div class="col-md-3">
                           <label for="cancellation_terms_days">Cancellation Terms (Days):</label>
                        </div>
                        <div class="col-md-3">
                             <input type="number" class="form-control" id="cancellation_terms_days" name="cancellation_terms_days" placeholder="0" min="0" max="365" required>
                        </div>

                    </div>
                 <div class="form-group row">
                        <div class="col-md-3">
                            <label for="premium_base">Premium Base ($):</label>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="premium_base" name="premium_base" placeholder="0.00" min="0" max="999999999" step="0.01" required>
                        </div>
                        <div class="col-md-3">
                            <label for="notification_period_days">Notification Period (Days):</label>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="notification_period_days" name="notification_period_days" placeholder="0" min="0" max="365" required>
                        </div>

                    </div>

                </div>



<script>
anychart.onDocumentReady(function () {
    // Define the matrix data
    var data = [
    // Negligible
    {x: "Negligible", y: "Very Likely", heat: 5, label: 'Low Med'},
    {x: "Negligible", y: "Likely", heat: 4, label: 'Low'},
    {x: "Negligible", y: "Possible", heat: 3, label: 'Low'},
    {x: "Negligible", y: "Unlikely", heat: 2, label: 'Low'},
    {x: "Negligible", y: "Very Unlikely", heat: 1, label: 'Low'},
    // Minor
    {x: "Minor", y: "Very Likely", heat: 6, label: 'Med'},
    {x: "Minor", y: "Likely", heat: 5, label: 'Low Med'},
    {x: "Minor", y: "Possible", heat: 4, label: 'Low Med'},
    {x: "Minor", y: "Unlikely", heat: 3, label: 'Low Med'},
    {x: "Minor", y: "Very Unlikely", heat: 2, label: 'Low'},
    // Moderate
    {x: "Moderate", y: "Very Likely", heat: 7, label: 'Med Hi'},
    {x: "Moderate", y: "Likely", heat: 6, label: 'Med'},
    {x: "Moderate", y: "Possible", heat: 5, label: 'Med'},
    {x: "Moderate", y: "Unlikely", heat: 4, label: 'Low Med'},
    {x: "Moderate", y: "Very Unlikely", heat: 3, label: 'Low Med'},
    // Significant
    {x: "Significant", y: "Very Likely", heat: 8, label: 'High'},
    {x: "Significant", y: "Likely", heat: 7, label: 'Med Hi'},
    {x: "Significant", y: "Possible", heat: 6, label: 'Med Hi'},
    {x: "Significant", y: "Unlikely", heat: 5, label: 'Med'},
    {x: "Significant", y: "Very Unlikely", heat: 4, label: 'Med'},
    // Severe
    {x: "Severe", y: "Very Likely", heat: 9, label: 'High'},
    {x: "Severe", y: "Likely", heat: 8, label: 'High'},
    {x: "Severe", y: "Possible", heat: 7, label: 'Med Hi'},
    {x: "Severe", y: "Unlikely", heat: 6, label: 'Med Hi'},
    {x: "Severe", y: "Very Unlikely", heat: 5, label: 'Med'},
];




    // Create a heat map chart
    var chart = anychart.heatMap(data);

    // Configure the color scale
    chart.colorScale(anychart.scales.linearColor());
    chart.colorScale().colors(["#00FF00", "#FFFF00", "#FFA500", "#FF0000"]);
    chart.labels().enabled(true);
    chart.labels().format(function() {
        return this.getData('label'); // Use the 'label' property for the cell text
    });
    // Set the titles for the axes
    chart.xAxis().title("Severity Levels");
    chart.yAxis().title("Likelihood");
    chart.title("Risk Severity Heat Map");
    chart.container("riskHeatMap");
    chart.draw();

    // Function to update x-axis labels based on severity levels' low/high values
    window.updateSeverityLabels = function(severityData) {
        chart.xAxis().labels().format(function() {
        var severityLevel = this.value;
        var lowHigh = severityData[severityLevel]; // Fetch the low/high value
        return severityLevel + " (" + lowHigh + ")"; // Combine for the label
    });
    chart.draw(); // Redraw to apply updates
    };
});

// Example severity data, replace with dynamic data as needed
var severityData = {
    "Negligible": "0/1",
    "Minor": "1/2",
    "Moderate": "2/3",
    "Significant": "3/4",
    "Severe": "4/5"
};

// Call this function when you need to update the labels, e.g., after fetching data
//updateSeverityLabels(severityData);
</script>



</div>


<script>
$(document).ready(function() {
    $('#useOrgDefaults').change(function() {
        if (this.checked) {
            fetchOrgDefaults();
        } else {
            $('#cyberPHADefaultsForm .form-control').val(''); // Clear all input fields if the checkbox is deselected
        }
    });

    function fetchOrgDefaults() {
        $.ajax({
            url: '/OTRisk/fetch_insurance_defaults/',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                populateForm(data);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function populateForm(data) {
    $.each(data, function(key, value) {
        var element = $('#' + key);
        if (element.attr('type') === 'checkbox') {
            // For checkboxes, set 'checked' property based on boolean value
            element.prop('checked', value);
        } else {
            // For other input types, use the 'val' method
            element.val(value);
        }
    });
}

});
</script>




    </div>


</div>

<script>
    $(document).ready(function() {
    // Hide all tab content by default, except the first one
    $(".tab-content").not(":first").hide();
    // Remove 'active' class from all tab contents except the first
    $(".tab-content").not(":first").removeClass('active');

    // When a tab is clicked
    $(".sub-menu a").click(function(e) {
        e.preventDefault(); // Prevent the default link behavior

        // Get the data-tab attribute value of the clicked tab
        var tabId = $(this).attr("data-tab");

        // Remove 'active' class from all tab contents
        $(".tab-content").removeClass('active').hide();

        // Add 'active' class to the clicked tab's content and show it
        $("#" + tabId).addClass('active').fadeIn();

        // Optionally, add 'active' class to the clicked tab and remove from others
        $(".sub-menu a").removeClass('active'); // Remove active from all tabs
        $(this).addClass('active'); // Add active to the clicked tab
    });
});

</script>

{% if new_record_id %}
    <script>
        // Set the value of the hidden textbox field
        document.querySelector('input[name="txtHdnCyberPHAID"]').value = "{{ new_record_id }}";

        // Store the value in the local session storage
        sessionStorage.setItem('activeCyberPHA', "{{ new_record_id }}");
    </script>

{% endif %}



<script>
drawGauge({{ current_pha_header.pha_score }});
drawControlGauge(0);

$("#generatePPT").click(function(e) {
    e.preventDefault();  // This prevents the default form submission

    $.ajax({
        type: "POST",
        url: "{% url 'OTRisk:generate_ppt' %}",
        data: {
            FacilityName: $("#txtFacility").val(),
            txtSafetySummary: $("#txtSafetySummary").val(),
            txtChemical: $("#txtChemical").val(),
            txtPhysical: $("#txtPhysical").val(),
            txtOther: $("#txtOther").val(),
            txtCompliance: $("#txtCompliance").val(),
            threatSummary: $("#threatSummary").val(),
            insightSummary: $("#insightSummary").val(),
            strategySummary: $("#strategySummary").val(),
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val() // Ensure CSRF token is sent with POST request
        },
        dataType: "json",
        success: function(response) {
            if (response.status === "success") {
                // Redirect to the provided download URL
                window.location.href = response.download_url;
            } else {
                alert("An error occurred: " + response.error);
            }
        },
        error: function(error) {
            alert("An error occurred: " + error.statusText);
        }
    });
});



$(document).ready(function() {
    $("#risk-assessment-btn").click(function() {
        var employeeCount = $("#txtEmployees").val();
        var zipCode = $("#zipCode").val().trim(); // Get ZIP Code and trim whitespace
        var address = $("#txtAddress").val().trim(); // Get Address and trim whitespace


        // Check if employeeCount is a number and greater than 0
        if ($.isNumeric(employeeCount) && parseInt(employeeCount) > 0 && zipCode !== "" && address !== "") {
            // Prompt the user for confirmation
            Swal.fire({
                title: 'Warning',
                text: 'Generating the assessment profile can take up to a minute. Proceed?',
                imageUrl: '/static/images/anzen_owl.png',
                imageWidth: 150, // Adjust as necessary
                imageHeight: 150, // Adjust as necessary
                background: '#000', // Black background
                color: '#fff', // Set text color to white
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                }

            }).then((result) => {
                if (result) {
                     // Show spinner
                    assessRisk();

                }
            });
        } else {
            swal.fire({
                icon: 'error',
                title: 'Risk Profile Error',
                text: 'Please enter a valid number of employees greater than 0'
            });
        }
    });
});

function populateSummary(containerId, summaryData) {
    // Clear existing content
    $('#' + containerId).empty();

    // Normalize newline characters and split the summary by new lines, filter out empty lines
    const normalizedData = summaryData.replace(/\r\n|\r|\n/g, '\n');
    const items = normalizedData.split('\n').filter(item => item.trim() !== '');

    // Get the reference to the corresponding textarea
    const textareaMapping = {
        'safetySummaryContainer': $('#txtSafetySummary'),
        'complianceContainer': $('#txtCompliance'),
        'physicalContainer': $('#txtPhysical'),
        'otherContainer': $('#txtOther'),
        'chemicalContainer': $('#txtChemical'),
        'threatContainer': $('#threatSummary'),
        'insightContainer': $('#insightSummary'),
        'strategyContainer': $('#strategySummary')
    };
    const txtArea = textareaMapping[containerId];

    // Function to create and attach the remove icon to a box
    function attachRemoveIcon(box, item) {
        const removeIcon = $('<img class="remove-item" src="/static/images/red_delete_circle.png" style="cursor: pointer; margin-left: 5px; width: 1em; height: 1em;">');
        box.append(removeIcon);

        // Attach click event handler to the remove icon
        removeIcon.click(() => {
            // Show confirmation message using SweetAlert
            swal.fire({
                title: "Are you sure?",
                text: "Once removed, you will not be able to recover this item!",
                imageUrl: '/static/images/anzen_owl.png',
                imageWidth: 150,
                imageHeight: 150,
                background: '#000',
                color: '#fff',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-custom-border'
                }
            }).then((willDelete) => {
                if (willDelete.isConfirmed) {
                    // Remove the item from the set
                    box.remove();
                    // Remove corresponding text from textarea
                    let newText = txtArea.val().replace(item, '');
                    txtArea.val(newText);

                    // Renumber and reattach icons to remaining items
                    renumberAndAttachIcons();

                    swal.fire("Item has been removed!");
                } else {
                    swal.fire("Your item is safe!");
                }
            });
        });
    }

    // Function to renumber and reattach icons to remaining items
    function renumberAndAttachIcons() {
        $('#' + containerId).find('.safety-summary-box').each((idx, el) => {
            const box = $(el);
            const currentItemText = box.text();
            const newItemNumber = idx + 1;
            const newItemText = currentItemText.replace(/^\d+/, newItemNumber);
            box.text(newItemText);
            attachRemoveIcon(box, newItemText);

            // Update text area with new item numbers
            let newText = txtArea.val().replace(currentItemText, newItemText);
            txtArea.val(newText);
        });
    }

    // Iterate over items and create boxes
    items.forEach((item, index) => {
        const box = $('<div class="safety-summary-box" style="color: #000"></div>').text(item);
        $('#' + containerId).append(box);

        // Attach remove icon and its event handler to the box
        attachRemoveIcon(box, item);
    });
}







      // AJAX function to call the Django view
        function assessRisk() {
            $('#progressBarContainerProfile').show();
            $('#progressBarProfile').css('width', '0%').attr('aria-valuenow', 0);
            $('#progressBarMessageProfile').text('').show(); // Initialize and show message
            $('.tab-link').addClass('disabled');
            $('.nav-link').addClass('disabled');

            let progress = 0;
            let progressBarInterval = setInterval(function() {
                progress += 2; // Increment progress by 2% every second
                if (progress <= 100) {
            $('#progressBarProfile').css('width', progress + '%').attr('aria-valuenow', progress);

            // Update progress bar message based on current progress
            switch (true) {
                case (progress === 4):
                    $('#progressBarMessageProfile').text('Creating safety profile...');
                    break;
                case (progress === 15):
                    $('#progressBarMessageProfile').text('Creating chemical profile...');
                    break;
                case (progress === 30):
                    $('#progressBarMessageProfile').text('Assessing location for physical security...');
                    break;
                case (progress === 40):
                    $('#progressBarMessageProfile').text('Determining OT assets...');
                    break;
                case (progress === 55):
                    $('#progressBarMessageProfile').text('Retrieving compliance requirements...');
                    break;
                case (progress === 65):
                    $('#progressBarMessageProfile').text('Creating OT Cybersecurity threat profile...');
                    break;
                case (progress === 75):
                    $('#progressBarMessageProfile').text('Providing security insights...');
                    break;
                case (progress === 85):
                    $('#progressBarMessageProfile').text('Suggesting OT cybersecurity strategy');
                    break;
            }
        } else {
            clearInterval(progressBarInterval); // Clear interval if progress exceeds 100%
        }
    }, 1000); // Update progress every second
            // Gather the necessary data for the AJAX request (impact scores and scenario information)
            let address = document.getElementById('txtAddress').value;
            let facilityType = document.getElementById('selFacilityType').value;
            let assessment_id = document.getElementById('assessment_id').value;
            let industry = document.getElementById('selIndustry').value;
            let country = document.getElementById('countrySelector').value;
            let facility = document.getElementById('txtFacility').value;
            let shift_model = document.getElementById('shift_model').value;
            let employees = document.getElementById('txtEmployees').value;
            let AQI = document.getElementById('txthdnAQI').value;
            let sl = document.getElementById('selSL').value;
            let hasIRPlan = document.getElementById('ir_plan').checked
            let irPlanDate = document.getElementById('ir_plan_date').value;
            let irPlanNeverTested = document.getElementById('ir_plan_ut').checked;
            let investments = [];
            $('#investmentTable tbody tr').each(function() {
                let investment = {
                    type: $(this).find('select[name="investment_type[]"]').val(),
                    vendor_name: $(this).find('input[name="vendor_name[]"]').val(),
                    product_name: $(this).find('input[name="product_name[]"]').val(),
                    cost: $(this).find('input[name="cost[]"]').val(),
                    date: $(this).find('input[name="date[]"]').val()
                };
                investments.push(investment);
            });

            // Make the AJAX call to the Django view using a separate endpoint for risk assessment
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:facility_risk_profile' %}",  // URL for the Django view
                data: {
                    // Pass the impact scores and scenario information as parameters
                    industry: industry,
                    facility_type: facilityType,
                    address: address,
                    country: country,
                    facility: facility,
                    shift_model: shift_model,
                    employees: employees,
                    assessment_id: assessment_id,
                    aqi: AQI,
                    sl: sl,
                    investments: JSON.stringify(investments),
                    has_ir_plan: hasIRPlan,
                    ir_plan_date: irPlanDate,
                    ir_plan_never_tested: irPlanNeverTested
                 },

                success: function (response) {
                    clearInterval(progressBarInterval);
                    $('#progressBarContainerProfile').hide();
                    $('#progressBarMessageProfile').hide();
                    $('.tab-link').removeClass('disabled');
                    $('.nav-link').removeClass('disabled');
                    // Write the response data to the textboxes
                    document.getElementById('txtSafetySummary').value = response.safety_summary;

                    document.getElementById('txtChemical').value = response.chemical_summary;
                    document.getElementById('txtPhysical').value = response.physical_security_summary;
                    document.getElementById('txtOther').value = response.other_summary;
                    document.getElementById('txtCompliance').value = response.compliance_summary;
                    document.getElementById('threatSummary').value = response.threatSummary;
                    document.getElementById('strategySummary').value = response.strategySummary;
                    document.getElementById('insightSummary').value = response.insightSummary;
                    document.getElementById('hdn_pha_score').value = response.pha_score;

                    populateSummary("safetySummaryContainer", response.safety_summary);
                    populateSummary("complianceContainer", response.compliance_summary);
                    populateSummary("physicalContainer", response.physical_security_summary);
                    populateSummary("otherContainer", response.other_summary);
                    populateSummary("chemicalContainer", response.chemical_summary);
                    populateSummary("threatContainer", response.threatSummary);
                    populateSummary("insightContainer", response.insightSummary);
                    populateSummary("strategyContainer", response.strategySummary);

                    drawGauge(response.pha_score);

                     $('#spinnerContainerProfile').hide();
                      // Expand the Facility Profile submenu if it's not already expanded
                    // This assumes you have some CSS/JS logic to toggle visibility based on a class like 'expanded'
                    $('.facility-profile-heading').addClass('expanded');
                    $('.facility-profile-submenu').show(); // Make sure the submenu is visible

                    // Make tab5 the active and visible tab
                    // First, remove 'active' class from all tabs to hide them
                    $('.tab-content').removeClass('active').hide();


                    // Then, add 'active' class to tab5 and show it
                    $('#tab5').addClass('active').show();

                },
                error: function (xhr, status, error) {
                    // Handle any errors that occur during the AJAX call
                    clearInterval(progressBarInterval);
                    $('#progressBarContainerProfile').hide();
                    $('#progressBarMessageProfile').hide();
                    $('.tab-link').removeClass('disabled');
                    $('.nav-link').removeClass('disabled');
                },
            });
        }

    function showNotification(message, isError = false) {
        var notificationDiv = document.getElementById('notificationMessage');
        notificationDiv.innerHTML = message;
        notificationDiv.style.display = 'block';
        notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

        // Automatically hide the notification after some time
        setTimeout(function() {
        notificationDiv.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }
    </script>
    <br>

    </div>



    <div class="col-md-1" style="background-color: #464748;"></div>
</div>



<!-- Modal -->
<div class="modal fade" id="moderatorModal" tabindex="-1" role="dialog" aria-labelledby="moderatorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moderatorModalLabel">Select CyberPHA Moderators</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
    <form id="moderatorsForm">
        <div class="form-group">
                        <label for="targetDate">Target Completion Date:</label>
                        <input type="text" class="form-control" id="targetDate" name="targetDate" placeholder="mm/dd/yy">
                        <script>
                        $( function() {
                            $( "#targetDate" ).datepicker({
                                dateFormat: "mm/dd/yy"
                            });
                        });
                        </script>

                    </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
                <!-- Moderators will be populated dynamically by JavaScript -->
            </tbody>
        </table>
    </form>
</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <!-- Add more buttons if needed -->
            </div>
        </div>
    </div>
</div>


</form>

<script>
    $(document).ready(function() {
        var table = $('#headertable').DataTable({
            "pageLength": 20,
            "lengthChange": false
        });

        function navigateToRecord(recordId) {
            var allPages = table.page.info().pages;
            var found = false;

            for (var i = 0; i < allPages; i++) {
                // Navigate to the page
                table.page(i).draw('page');

                // Check if the record is in the current page
                var row = $('tr[data-id="' + recordId + '"]');
                if (row.length) {
                    // Record found, highlight it
                    $('tr.selectable-row').removeClass('highlighted');
                    row.addClass('highlighted');
                    found = true;
                    break;
                }
            }

            if (!found) {
                console.log("Record not found");
            }
        }

        // Check if a saved_record_id is provided in the rendered context
        let savedRecordId = "{{ saved_record_id }}";
        if (savedRecordId && savedRecordId !== "None") {
            navigateToRecord(savedRecordId);
        }

        $('#headertable').on('click', 'tbody tr.selectable-row', function() {
            let recordId = $(this).data('id');
            navigateToRecord(recordId);
        });
});

    function populateInvestmentTable(investments) {
    const tableBody = $('#investmentTable tbody');
    tableBody.empty(); // Clear existing rows

    investments.forEach(function(investment) {
        const row = `<tr>
            <td><input type="hidden" name="investment_id[]" value="${investment.id}" class="form-control">
                <select name="investment_type[]" class="form-control">
                    <option value="Software" ${investment.investment_type === 'Software' ? 'selected' : ''}>Software</option>
                    <option value="Hardware" ${investment.investment_type === 'Hardware' ? 'selected' : ''}>Hardware</option>
                    <option value="People" ${investment.investment_type === 'People' ? 'selected' : ''}>People</option>
                </select>
            </td>
            <td><input type="text" name="vendor_name[]" value="${investment.vendor_name}" class="form-control"></td>
            <td><input type="text" name="product_name[]" value="${investment.product_name}" class="form-control"></td>
            <td><input type="number" name="cost[]" value="${investment.cost}" class="form-control" step="0.01"></td>
            <td><input type="date" name="date[]" value="${investment.date}" class="form-control"></td>
            <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
        </tr>`;
        tableBody.append(row);
    });

    // Ensure the removeRow button functionality is re-bound after adding new rows
    $('.removeRow').off('click').on('click', function() {
        $(this).closest('tr').remove();
    });
}
             function setBorderColorByScore_(score) {
                            var borderColor = '#4CAF50'; // Default color
                            score = parseInt(score); // Convert score to integer

                            if (score < 30) {
                                borderColor = 'red';
                            } else if (score >= 30 && score <= 70) {
                                borderColor = 'yellow';
                            } // If score > 70, default green color is used

                            $('#assessment_summary').css('border-left', '5px solid ' + borderColor);
                        }
            function fetchHeaderRecord(recordId) {

                 sessionStorage.setItem('activeCyberPHA', recordId);
                 isUserChange = false;
                 // Set the value of the hidden text field
                 document.getElementById('txtHdnCyberPHAID').value = recordId;
                 $.ajax({
                     url: '/OTRisk/get_headerrecord',  // the URL of the view that will handle the request
                     data: {
                         'record_id': recordId
                     },
                     dataType: 'json',
                     success: function (data) {

                         $('#txtTitle').val(data.headerrecord.title);

                         $('#lblCyberPHATitle').text(data.headerrecord.title + '@' + data.headerrecord.facility) ;

                         $('#txtLeader').val(data.headerrecord.leader);
                         $('#selIndustry').val(data.headerrecord.Industry);
                          $('#selIndustry').val(data.headerrecord.Industry).trigger('change');
                         $('#txtUnit').val(data.headerrecord.unit);
                         $('#txtFacility').val(data.headerrecord.facility);
                         $('#txtLeaderEmail').val(data.headerrecord.leaderemail);
                         $('#selFacilityType').val(data.headerrecord.facilitytype);

                         $('#selFacilityType').val(data.headerrecord.facilitytype).trigger('change');

                         $('#assessment_id').val(data.headerrecord.assessment_id);
                         $('#assessment_id').val(data.headerrecord.assessment_id).trigger('change');

                         $('#selZone').val(data.headerrecord.zone);
                         $('#selSL').val(data.headerrecord.sl_t);
                         $('#txtStartDate').val(data.headerrecord.startdate);
                         $('#txtEndDate').val(data.headerrecord.enddate);
                         $('#txtSafetySummary').val(data.headerrecord.safetysummary);

                         $('#txtChemical').val(data.headerrecord.chemicalsummary);
                         $('#txtPhysical').val(data.headerrecord.physicalsummary);
                         $('#txtOther').val(data.headerrecord.othersummary);
                         $('#txtCompliance').val(data.headerrecord.compliancesummary);
                         $('#threatSummary').val(data.headerrecord.threatSummary);
                         $('#insightSummary').val(data.headerrecord.insightSummary);
                         $('#strategySummary').val(data.headerrecord.strategySummary);

                         $('#countrySelector').val(data.headerrecord.country).trigger('change');
                         $('#shift_model').val(data.headerrecord.shift_model);
                         $('#txtEmployees').val(data.headerrecord.EmployeesOnSite);
                         $('#annual_revenue').val(formatAsCurrency(data.headerrecord.annual_revenue));
                         $('#cyber_insurance').val(data.headerrecord.cyber_insurance);
                         $('#cyber_insurance').val(data.headerrecord.cyber_insurance).trigger('change');
                         $('#hdn_pha_score').val(data.headerrecord.pha_score);
                         $('#npm').val(data.headerrecord.npm);
                         $('#coho').val(formatAsCurrency(data.headerrecord.coho));
                         $('#txtAddress').val(data.headerrecord.address);
                         $('#txthdnLat').val(data.headerrecord.facilityLat);
                         $('#txthdnLong').val(data.headerrecord.facilityLong);
                         $('#txthdnAQI').val(data.headerrecord.facilityAQI);
                         $('#txtCity').val(data.headerrecord.facilityCity);
                         $('#txtState').val(data.headerrecord.facilityState);
                         $('#zipCode').val(data.headerrecord.facilityCode);
                         // Populate the new incident response planning fields
                        $('#ir_plan').prop('checked', data.headerrecord.has_incident_response_plan);
                        $('#ir_plan_date').val(data.headerrecord.plan_last_tested_date);
                        $('#ir_plan_ut').prop('checked', data.headerrecord.plan_never_tested);
                        $('#assessment_summary').text(data.headerrecord.last_assessment_summary);
                        $('#assessment_score').text('Score: ' + data.headerrecord.last_assessment_score + '/100');
                        $('#last_assessment_summary').text(data.headerrecord.last_assessment_summary);
                        $('#last_assessment_score').text(data.headerrecord.last_assessment_score);
                        // Logic to enable/disable the date field and plan_never_tested checkbox
                        if (data.headerrecord.has_incident_response_plan) {
                            $('#ir_plan_date').prop('disabled', false);
                            if (data.headerrecord.plan_last_tested_date) {
                                $('#ir_plan_ut').prop('disabled', true).prop('checked', false);
                            } else {
                                $('#ir_plan_ut').prop('disabled', false);
                            }
                        } else {
                            $('#ir_plan_date').prop('disabled', true).val('');
                            $('#ir_plan_ut').prop('disabled', true).prop('checked', false);
                        }



                        $('#ir_plan_date').change(function() {
                            if ($(this).val()) {
                                $('#ir_plan_ut').prop('checked', false).prop('disabled', true);
                            } else {
                                $('#ir_plan_ut').prop('disabled', false);
                            }
                        });

                         var lat = data.headerrecord.facilityLat;
                         var long = data.headerrecord.facilityLong;
                         var address = data.headerrecord.address + ', ' + data.headerrecord.facilityCity + ', ' + data.headerrecord.facilityCode;
                         var country = data.headerrecord.country
                         drawGoogleMap(lat,long,address,country);
                         aqi(lat,long,address,country);
                         drawGauge(data.headerrecord.pha_score);
                        setBorderColorByScore_(data.headerrecord.last_assessment_score);
                         drawControlGauge(data.headerrecord.last_assessment_score);

                         populateInvestmentTable(data.investments);

                         populateSummary("safetySummaryContainer", data.headerrecord.safetysummary);
                         populateSummary("complianceContainer", data.headerrecord.compliancesummary);
                         populateSummary("physicalContainer", data.headerrecord.physicalsummary);
                         populateSummary("otherContainer", data.headerrecord.othersummary);
                         populateSummary("chemicalContainer", data.headerrecord.chemicalsummary);
                         populateSummary("threatContainer", data.headerrecord.threatSummary);
                         populateSummary("insightContainer", data.headerrecord.insightSummary);
                         populateSummary("strategyContainer", data.headerrecord.strategySummary);
                          if (data.cyber_defaults) {
                            $('#overall_aggregate_limit').val(data.cyber_defaults.overall_aggregate_limit);
                            $('#per_claim_limit').val(data.cyber_defaults.per_claim_limit);
                            $('#deductible_amount').val(data.cyber_defaults.deductible_amount);
                            $('#premium_base').val(data.cyber_defaults.premium_base);
                            $('#notification_period_days').val(data.cyber_defaults.notification_period_days);
                            $('#cancellation_terms_days').val(data.cyber_defaults.cancellation_terms_days);

                            // Populate checkbox fields
                            $('#first_party_coverage').prop('checked', data.cyber_defaults.first_party_coverage);
                            $('#third_party_coverage').prop('checked', data.cyber_defaults.third_party_coverage);
                            $('#security_event_liability').prop('checked', data.cyber_defaults.security_event_liability);
                            $('#privacy_regulatory_actions').prop('checked', data.cyber_defaults.privacy_regulatory_actions);
                            $('#cyber_extortion_coverage').prop('checked', data.cyber_defaults.cyber_extortion_coverage);
                            $('#data_breach_response_coverage').prop('checked', data.cyber_defaults.data_breach_response_coverage);
                            $('#business_interruption_coverage').prop('checked', data.cyber_defaults.business_interruption_coverage);
                            $('#dependent_business_coverage').prop('checked', data.cyber_defaults.dependent_business_coverage);
                            $('#data_recovery').prop('checked', data.cyber_defaults.data_recovery);
                            $('#hardware_replacement').prop('checked', data.cyber_defaults.hardware_replacement);
                            $('#reputation_harm').prop('checked', data.cyber_defaults.reputation_harm);
                            $('#media_liability').prop('checked', data.cyber_defaults.media_liability);
                            $('#pci_dss').prop('checked', data.cyber_defaults.pci_dss);
                        }
                         const riskToleranceFields = [
                            'negligible_low', 'negligible_high',
                            'minor_low', 'minor_high',
                            'moderate_low', 'moderate_high',
                            'significant_low', 'significant_high',
                            'severe_low', 'severe_high'
                        ];

                        riskToleranceFields.forEach(field => {
                            if (data.risk_tolerance && data.risk_tolerance[field] !== undefined) {
                                $('#' + field).val(parseFloat(data.risk_tolerance[field]).toFixed(2));
                            } else {
                                $('#' + field).val(''); // Clear the field if data is missing
                            }
                        });
                         sessionStorage.setItem('sessionIndustry', data.headerrecord.industry);
                         sessionStorage.setItem('sessionFacilityType', data.headerrecord.facilitytype);
                         sessionStorage.setItem('sessionFacility', data.headerrecord.facility);
                         sessionStorage.setItem('sessionCountry', data.headerrecord.country);
                         var pha_score = data.headerrecord.pha_score;

                         // Enable the controls
                         $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtAddress, #txtFacility, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary, #selFacilityType, #assessment_id, #cyber_insurance, #shift_model, #annual_revenue, #txtEmployees, #selIndustry, #selZone, #selSL, #countrySelector, #btnformSubmit,  #risk-assessment-btn, #scenarioButton, #generatePPT').prop('disabled', false);
                         $('#btnformSubmit').prop('disabled', false);
                         $('#scenarioButton').prop('disabled', false);
                         // Set the workflow status dropdown
                         // Ensure the current workflow status matches the format of the dropdown options
                         var currentWorkflowStatus = data.headerrecord.current_workflow_status;

                         var workflowSelector = $('#workflow_selector');

                         // Check if the current workflow status exists in the options
                         if (workflowSelector.find("option[value='" + currentWorkflowStatus + "']").length > 0) {
                             workflowSelector.val(currentWorkflowStatus).trigger('change');
                         } else {
                             // If the status doesn't exist, select the default placeholder
                             workflowSelector.val('').trigger('change');
                         }

                         if (currentWorkflowStatus == 'Complete') {

                             lockControls();
                         } else {
                             unlockControls();
                         }

                         $('#generatePPT').prop('disabled', false);
                         populateModeratorsTable(data.organization_moderators, data.moderator_ids);
                         // Populate current group assignments

                         populateCurrentGroups(data.headerrecord.current_groups);

                         // Populate all available groups in the dropdown (for the modal)
                         populateAllGroupsDropdown(data.all_groups);
                         updateGroupAssignmentsDisplay(recordId);
                         updateGroupList();
                        $('.tab-content').removeClass('active').hide();
                        $('#tab2').addClass('active').show();


                     }
                 });
             }

function formatAsCurrency(value) {
                 // Strip any non-digit characters
                 let cleanedValue = String(value).replace(/\D/g, '');

                 // Convert the number to a currency format
                 return parseInt(cleanedValue).toLocaleString('en-US', {
                     style: 'currency',
                     currency: 'USD',
                     minimumFractionDigits: 0
                 });
             }

function populateModeratorsTable(moderators, moderatorIds) {
                 var tbody = $('#moderatorModal tbody');
                 tbody.empty(); // Clear existing rows

                 moderators.forEach(function (moderator) {
                     var checked = moderatorIds.includes(moderator.id) ? 'checked' : '';
                     var row = '<tr>' +
                         '<td>' + moderator.name + '</td>' +
                         '<td><input type="checkbox" name="moderator" value="' + moderator.id + '" ' + checked + '></td>' +
                         '</tr>';
                     tbody.append(row);
                 });
             }

                 // Function to populate current groups
 function populateCurrentGroups(groups) {
                 var currentGroupsDiv = $('#currentGroupsDiv');
                 currentGroupsDiv.empty(); // Clear existing content

                 // Check if 'groups' is an array and has elements
                 if (Array.isArray(groups) && groups.length > 0) {
                     groups.forEach(function (group) {
                         currentGroupsDiv.append($('<p>').text(group.name));
                     });
                 } else {
                     // Handle non-array or empty 'groups'
                     currentGroupsDiv.append($('<p>').text('No groups assigned.'));
                 }
             }


 function populateAllGroupsDropdown(groups) {
                 var allGroupsSelect = $('#existing_group'); // ID of the select element in the modal
                 allGroupsSelect.empty(); // Clear existing options

                 allGroupsSelect.append($('<option>', {
                     value: '',
                     text: 'Select a Group'
                 }));

                 if (groups && groups.length > 0) {
                     groups.forEach(function (group) {
                         allGroupsSelect.append($('<option>', {
                             value: group.id,
                             text: group.name
                         }));
                     });
                 }
             }
</script>

<div class="modal fade" id="countryModal" tabindex="-1" aria-labelledby="countryModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModal_Label">Country Selection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Selecting the correct country in which the facility is located improves the accuracy of the scenario event cost estimation</p>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="assessmentDialog" tabindex="-1" aria-labelledby="assessmentDialogLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assessmentDialogLabel">Select an Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pha_header_records in pha_header_records %}
                            <tr class="selectable-row" data-id="{{ pha_header_records.ID }}">
                                <td>{{ pha_header_records.title }}</td>
                                <td>{{ pha_header_records.latest_workflow_status }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->


<script>
// Define the csrfSafeMethod function to check if a HTTP method is safe from CSRF protection
function csrfSafeMethod(method) {
    // These HTTP methods do not require CSRF protection
    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
}

// Define the getCookie function to retrieve the CSRF token from cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Check if this cookie name starts with the specified name
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Using jQuery
$(document).ready(function() {
    // Update the displayed value when the slider changes
    $("input[type='range']").on('input', function() {
        var id = $(this).attr('id').replace("mitigation_", "");
        $("#mitigationValue_" + id).text($(this).val());
    });

});

function aqi(latitude,longitude,address,country) {
    $.ajax({
        type: 'GET',
        url: '/OTRisk/air_quality_index/',  // Update with the correct path to your Django view
        data: {'lat': latitude, 'lon': longitude, 'address': address, 'country': country},
        success: function (response) {
            if (response.aqi !== undefined) {
                $('#txthdnAQI').val(response.aqi);
                var aqiValue = response.aqi;
                var aqiGlobe = $('#aqiGlobe');
                aqiGlobe.text(aqiValue);

                // Determine the background color based on AQI value
                var bgColor;
                if (aqiValue <= 50) {
                    bgColor = 'green';
                } else if (aqiValue <= 100) {
                    bgColor = 'yellow';
                } else if (aqiValue <= 150) {
                    bgColor = 'orange';
                } else if (aqiValue <= 200) {
                    bgColor = 'red';
                } else if (aqiValue <= 300) {
                    bgColor = 'purple';
                } else if (aqiValue <= 500) {
                    bgColor = 'brown';
                } else {
                    bgColor = 'grey'; // Default or error case
                }

                // Apply the background color
                aqiGlobe.css('background-color', bgColor);
            } else {

            }
        },
        error: function () {

        }
    });
}
</script>

<div class="card mb-3 shadow-sm" style="visibility: hidden">
            <div class="card-body">
    <label for="cyber_insurance">Cyber Insurance</label>
    <select class="form-control" name="cyber_insurance" id="cyber_insurance">

        <option value="0" {% if current_pha_header.cyber_insurance == false %}selected{% endif %}>No</option>
        <option value="1" {% if current_pha_header.cyber_insurance == true %}selected{% endif %}>Yes</option>
    </select>
    <script>
       $(document).ready(function() {
                $('#cyber_insurance').select2();

                // var cyber_insurance_value = data.headerrecord.cyber_insurance ? "1" : "0";
                // $('#cyber_insurance').val(cyber_insurance_value).trigger('change');
            });

    </script>
</div>
</div>
<script>
    function lockControls() {
    // Disable all input, select, and button elements
    document.querySelectorAll('input, select, button').forEach(function(el) {
        // Exclude elements inside the 'headertable' table and the 'resetButton' by id
        if (!el.closest('#headertable') && el.id !== 'resetButton') {
            el.disabled = true;
        }
    });
}


function unlockControls() {
        // Disable all input, select, and button elements
        document.querySelectorAll('input, select, button').forEach(function(el) {

            el.disabled = false;
        })
    }

                // Add an event listener to the "Save Header" button
                document.getElementById('btnformSubmit').addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent the form submission (if it's within a form)

                    // Validate required fields
                    var industry = document.getElementById('selIndustry').value;
                    var facilityType = document.getElementById('selFacilityType').value;
                    var facilityName = document.getElementById('txtFacility').value.trim();
                    var employees = document.getElementById('txtEmployees').value.trim();
                    var address = document.getElementById('txtAddress').value.trim();
                    var country = document.getElementById('countrySelector').value;

                     // Check if all required fields have values
                    if (!industry || !facilityType || !facilityName || !employees || !address || !country) {
                       Swal.fire({
                            icon: 'error',
                            title: 'Missing Information',
                            text: 'Please fill in all required fields before saving.'
                        }).then(() => {
                            // After closing the alert, make tab2 active and visible
                            $('.tab-content').removeClass('active').hide();

                             $('#tab2').addClass('active').show();
                        });
                        return; // Exit the function and do not proceed to show the save confirmation
                    }
                    // Show a SweetAlert confirmation dialog
                    Swal.fire({
                        title: 'Confirm Save?',
                        text: "Are you sure you want to save the CyberPHA information? (Note: The profile is generated the first time a new facility is saved. This can take up to a minute to complete)",
                        imageUrl: '/static/images/anzen_owl.png',
                        imageWidth: 150, // Adjust as necessary
                        imageHeight: 150, // Adjust as necessary
                        background: '#000', // Black background
                        color: '#fff', // Set text color to white
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes',
                        cancelButtonText: 'Cancel',
                        customClass: {
                            popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire({
                            title: 'Processing...',
                            html: 'Please wait while we save your information.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading(); // This will show a spinner
                            }
                            });
                            // User confirmed, continue with the form submission
                            document.forms['frmRAW'].submit();
                        } else {
                            // User canceled the action
                            // You can add additional code here if needed
                        }
                    });
                });

            </script>
<div class="col-md-0" style="background-color: #464748; align-items: center; visibility: hidden">
<div class="form-group">
<button type="button" class="form-control" id="searchButton" >Search</button>
<div id="spinner_facility" style="display: none;"></div>
</div>
</div>
</div>
</body>
</html>