{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<!--suppress ALL -->
<html lang="">
<head>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">

 <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js">

     <!-- Bootstrap Select JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="{% static 'anychart/dist/js/anychart-bundle.min.js' %}"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!-- <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-core.min.js" type="text/javascript"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script> -->
    {% load django_bootstrap5 %}
     {% bootstrap_css %}
     {% bootstrap_javascript %}

<style>
.table th {
    background-color: #007bff; /* Example color - a shade of blue */
    color: white;             /* White text color for contrast */
    text-align: center;       /* Center-align the text */
    padding: 10px;            /* Add more padding for spacing */
    font-weight: bold;        /* Make the text bold */
    border-bottom: 2px solid #0056b3; /* A darker border at the bottom for depth */
    text-transform: uppercase; /* Uppercase letters for a more professional look */
}


.table td {
padding: 12px; /* More padding for table cells */
border-bottom: 1px solid #dee2e6;
}


.notification-message {
    position: fixed; /* or absolute */
    top: 20px; /* Distance from top */
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000; /* Ensure it's above other elements */
    display: none;
    padding: 10px 20px;
    background-color: #4CAF50; /* Green for success */
    color: white;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    animation: fadeOut 5s ease 3s forwards; /* fades out after 3 seconds, total 5s animation */
}

.notification-message.error {
    background-color: #f44336; /* Red for error */
}

@keyframes fadeOut {
to {
    opacity: 0;
    visibility: hidden;
}
}


body {
    font-size: 14px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
     background-color: #f4f7fa;
    color: #333;
}
    html, body, #container {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }
    .currency-input {
        text-align: right; /* Aligns the number to the right */
    }

    .custom-btn {
            width: 150px;  /* Adjust this value as needed */
            height: 50px;  /* Adjust this value as needed */
            background-color: white;
            border: 1px solid grey;
            color: black; /* Set the text color to black */
        }
   .custom-btn:hover {
    background-color: #f7f7f7; /* Slightly darker background on hover */
    border: 1px solid #d0d0d0; /* Slightly darker border on hover */
}

    #headertable tbody tr:hover {
    background-color: #f5f5f5; /* Change this to the color you want */
    }

.navbar {
    background-color: #464748;
    border-bottom: 1px solid #000;
    height: 50px; /* Fixed height */
    position: relative;
}

.owl-logo {
    height: 60px; /* Set a fixed height for the image */
    width: auto; /* Maintain aspect ratio */
    position: relative;
    top: 50%; /* Center vertically in the navbar */
    transform: translateY(-30%); /* Adjust vertical position */
    margin-bottom: -20px; /* Negative margin to overlap */
}


.navbar-brand, .nav-link {
    color: #d3d1cd; /* White text for clear visibility on initial view */
}

.menu-item {
    border-right: 1px solid #4B6B6B; /* Subtle line between items */
    font-size: 14px; /* Adjust font size */
}

.menu-item:last-child {
    border-right: none; /* Remove border for the last item */
}

.menu-item:hover, .dropdown-item:hover {
    background-color: #3A5F5F; /* Slightly lighter grey on hover */
    color: #E0E0E0; /* Light grey text on hover */
}

.nav-link:hover, .dropdown-item {
    color: #E0E0E0; /* Light grey text on hover */
}

.dropdown-menu {
    background-color: #464748; /* Dark Slate Grey */
    border: none;
}

.dropdown-item {
    color: #FFFFFF; /* White text for clear visibility */
}

.dropdown-item:hover {
    background-color: #3A5F5F; /* Slightly lighter grey on hover */
    color: #E0E0E0;}

        .col-md-2 {
    place-items: center;
    background-color: lightgrey;
}

.small-font {
    font-size: 0.8rem; /* adjust as needed */
}

    .spinner {
    border: 16px solid #f3f3f3;
    border-top: 16px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 2s linear infinite;
    display: none; /* Initially hidden */
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.selectable-row:hover {
cursor: pointer;
background-color: #f5f5f5;  /* Optional: to give a slight background change on hover */
}

.highlighted {
    background-color: #f3dc47 !important;
    color: white !important;
}
body {
    font-size: 12px;
}

    .icon-text {
    font-size: 24px; /* Adjust as needed */
}

.icon-text img {
    vertical-align: middle;
    height: 1em; /* This will make the image the same height as the text */
}

/* Custom Dialog Styles */
#assessmentDialog .modal-dialog {
    max-width: 800px; /* Adjust the width of the dialog */
}

#assessmentDialog .modal-content {
    border-radius: 5px; /* Rounded corners for the modal */
}

#assessmentDialog .modal-header {
    background-color: #f3f3f3; /* Light grey header */
    border-bottom: 1px solid #ddd; /* Separator line */
}

#assessmentDialog .modal-title {
    color: #333; /* Dark text for the title */
}

#assessmentDialog .modal-body {
    background-color: #fff; /* White background for the body */
}

#assessmentDialog .table {
    margin-bottom: 0; /* Remove margin for the table */
}

#assessmentDialog .table th {
    background-color: #e9ecef; /* Light grey background for table headers */
    color: #333; /* Dark text for headers */
    border-top: none; /* Remove top border */
}

#assessmentDialog .table td {
    color: #555; /* Slightly darker text for table data */
}

#assessmentDialog .table tr.selectable-row:hover {
    cursor: pointer;
    background-color: #f0f0f0; /* Light grey background on hover */
}

#assessmentDialog .btn-close {
    color: #333; /* Dark color for close button */
}

/* Additional styling can be added as needed */

.form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}
.form-sim .form-control {
    max-width: 100%; /* Ensures select does not exceed container width */
    width: auto; /* Optional: Ensures select width is based on content up to max-width */
}
/* Change font color of the DataTable pagination info */
.dataTables_info {
    color: white;
}

/* Change font color of the DataTable search label */
.dataTables_filter label {
    color: white;
}
#headertable_wrapper .dataTables_info {
    color: white !important;
}

#headertable_wrapper .dataTables_paginate .paginate_button {
    color: white !important;
}

/* Enhance nav-tabs appearance */
.nav-tabs .nav-link.active {
    background-color: #f0f0f8;
    border-color: #dee2e6 #dee2e6 #fff;
    color: #495057;
}

.nav-tabs .nav-link i {
    margin-right: 8px;
    color: #007bff; /* Adjust the color to match your theme */
}

/* Style text areas */
.tab-pane textarea {
    background-color: #f8f9fa;
    border: 1px solid #c5c7c9;
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
    border-radius: 5px;
}

/* Custom scrollbar for text areas */
.tab-pane textarea::-webkit-scrollbar {
    width: 8px;
}

.tab-pane textarea::-webkit-scrollbar-thumb {
    background-color: #007bff; /* Adjust the color to match your theme */
    border-radius: 4px;
}

/* Responsive images/icons in tab content */
.tab-pane img {
    width: 50px; /* Adjust based on your layout */
    float: right;
    margin: 10px;
}
@media (max-width: 768px) {
  .modal-lg {
    max-width: 90%; /* Adjust based on preference */
  }
}
</style>
</head>
<body style="background-color: #464748">
<script>

anychart.licenseKey("{{ anychart_key }}");


sessionStorage.setItem('activeCyberPHA','');
sessionStorage.setItem('sessionCountry','');
sessionStorage.setItem('sessionFacility','');
sessionStorage.setItem('sessionFacilityType','');
sessionStorage.setItem('sessionIndustry','');

fetch('https://restcountries.com/v3.1/all')
    .then(response => response.json())
    .then(data => {
        // Sort the countries alphabetically
        data.sort((a, b) => a.name.common.localeCompare(b.name.common));

        // Add a blank option as the default
        $('#countrySelector').append(new Option('', ''));

        // Populate the dropdown
        data.forEach(country => {
            const countryName = country.name.common;
            $('#countrySelector').append(new Option(countryName, countryName));
        });
    })
    .then(() => {
        $('#countrySelector').select2({
            placeholder: "Select a country", // This will display the placeholder text
            allowClear: true // This allows users to clear the selected value
        });
    })
    .catch(error => {
        console.error("There was an error fetching the country list:", error);
    });

    //disable all controls and reset local session variable when form loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("txtTitle").setAttribute('disabled', true);
        document.getElementById("txtLeader").setAttribute('disabled', true);
        document.getElementById("selIndustry").setAttribute('disabled', true);
        document.getElementById("txtUnit").setAttribute('disabled', true);
        document.getElementById("txtStartDate").setAttribute('disabled', true);
        document.getElementById("txtAddress").setAttribute('disabled', true);
        document.getElementById("txtFacility").setAttribute('disabled', true);
        document.getElementById("txtLeaderEmail").setAttribute('disabled', true);
        document.getElementById("selFacilityType").setAttribute('disabled', true);
        document.getElementById("assessment_id").setAttribute('disabled', true);
        document.getElementById("selZone").setAttribute('disabled', true);
        document.getElementById("selSL").setAttribute('disabled', true);
        document.getElementById("txtEndDate").setAttribute('disabled', true);
        document.getElementById("txtEmployees").setAttribute('disabled', true);
        document.getElementById("cyber_insurance").disabled = true;
        document.getElementById("annual_revenue").setAttribute('disabled', true);
        document.getElementById("shift_model").setAttribute('disabled', true);
        document.getElementById("countrySelector").setAttribute('disabled', true);
        document.getElementById("txtSafetySummary").setAttribute('disabled', true);
        document.getElementById("txtChemical").setAttribute('disabled', true);
        document.getElementById("txtPhysical").setAttribute('disabled', true);
        document.getElementById("txtOther").setAttribute('disabled', true);
        document.getElementById("txtCompliance").setAttribute('disabled', true);
        document.getElementById("threatSummary").setAttribute('disabled', true);
        document.getElementById("insightSummary").setAttribute('disabled', true);
        document.getElementById("strategySummary").setAttribute('disabled', true);
         $('#risk-assessment-btn').prop('disabled', true);
         $('#btnformSubmit').prop('disabled', true);
         $('#scenarioButton').prop('disabled', true);
         $('#generatePPT').prop('disabled', true);
});

function clearContainer(containerId) {
    var container = document.getElementById(containerId);
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
}

function drawGauge(score) {

    clearContainer('pha_gauge');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);
    gauge.title("PHA Profile Rating (/100)");
    // Draw the chart
    gauge.container('pha_gauge').draw();
}

function drawControlGauge(score) {

    clearContainer('control_gauge');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);
    gauge.title("Control Effectiveness %");
    // Draw the chart
    gauge.container('control_gauge').draw();
}

</script>

<nav class="navbar navbar-expand-lg navbar-scroll shadow-0 border-bottom rounded">
    <div class="container-fluid d-flex justify-content-between">
        <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}">
            &nbsp; &nbsp; &nbsp; &nbsp;
            <img src="{% static 'images/anzen_owl.png' %}" class="owl-logo" style="width: 18%; height: 18%">
        </a>
        <h6 class="my-auto text-center flex-grow-1 navbar-brand"><img src="{% static 'images/anzen_noowl.png' %}" style="width: 15%; height: 15%" alt=""> CyberPHA</h6>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-calculator"></i> QRAW</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}"><i class="bi bi-journal-text"></i> CyberPHA</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:scenario_sim' %}"><i class="bi bi-bricks"></i> Scenario Builder</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:ra_actions_view_default' %}"><i class="bi-file-earmark-easel"></i> Actions</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:risk_register' %}"><i class="bi-file-earmark-easel"></i> Risk Register</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:list_frameworks' %}"><i class="bi-file-earmark-easel"></i> Assessments</a>
                </li>
    <li class="nav-item dropdown menu-item">
    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <i class="bi bi-diagram-3"></i> Admin
    </a>
    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
    <li><a class="dropdown-item" href="{% url 'OTRisk:admin_users' %}">Admin Users</a></li>
    {% if user.is_staff %}
    <li><a class="dropdown-item" href="{% url 'OTRisk:user_admin' %}">User Administration</a></li>
    <li><a class="dropdown-item" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a></li>
    {% endif %}
    </ul>
    </li>
    <li class="nav-item menu-item">
    <a class="nav-link" href="{% url 'accounts:profile' %}">
    <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
    </a>
    </li>
    <li class="nav-item menu-item">
    <a class="nav-link" href="{% url 'logout' %}">
    <i class="bi bi-box-arrow-right"></i> Logout
    </a>
    </li>
    </ul>
    </div>
    </div>
    </nav>

<div id="notificationMessage" class="notification-message" style="display: none;"></div>
<form name="frmHeader" id="frmRAW" method="POST" action="{% url 'OTRisk:iotaphamanager' %}">
{% csrf_token %}
<br>
<div class="row">
    <div class="col-md-1" style="background-color: #464748"></div>
    <div class="col-md-10">
    <div class="row">
    <div class="form-group">
    <div class="col-md-12 " style="background-color: #464748">
        <label for="headertable" class="form-label" style="color:white">Select a record in the table to view and edit the CyberPHA</label>
        <table id="headertable" class="table small-font compact">
        <thead style="background-color: #2c2c2c; color: white">
            <tr>
                <th class="th">ID</th>
                <th>Title</th>
                <th>Site</th>
                <th>Type</th>
                <th>Unit</th>
                <th>Zone</th>
                <th>Owner</th>
                <th>Date</th>
                <th>BIA</th>
                <th>Scenarios</th>
                <th>Status</th>
                <th>Actions</th>
                <th></th>
                <!-- Add more <th> elements for each field in the RAWorksheet model -->
            </tr>
        </thead>
        <tbody style="font-size: 10px">
            {% for pha_header_records in pha_header_records %}
                <tr data-id="{{ pha_header_records.ID }}" class="selectable-row">
                    <td>{{ pha_header_records.ID }}</td>
                    <td>{{ pha_header_records.title }}</td>
                    <td>{{ pha_header_records.FacilityName }}</td>
                    <td>{{ pha_header_records.FacilityType }}</td>
                    <td>{{ pha_header_records.AssessmentUnit }}</td>
                    <td>{{ pha_header_records.AssessmentZone }}</td>
                    <td>{{ pha_header_records.PHALeader }}</td>
                    <td>{{ pha_header_records.AssessmentStartDate|date:"m/d/Y" }}</td>

                     <td style="background-color:
                        {% if pha_header_records.bia_scenarios == None %}
                            white  <!-- Default color for null or None values -->
                        {% elif pha_header_records.bia_scenarios == 0 or pha_header_records.bia_scenarios == 1 or pha_header_records.bia_scenarios == 2 %}
                            green
                        {% elif pha_header_records.bia_scenarios == 3 %}
                            olive
                        {% elif pha_header_records.bia_scenarios == 4 or pha_header_records.bia_scenarios == 5 %}
                            yellow
                        {% elif pha_header_records.bia_scenarios == 6 or pha_header_records.bia_scenarios == 7 %}
                            orange
                        {% elif pha_header_records.bia_scenarios == 8 or pha_header_records.bia_scenarios == 9 %}
                            red
                        {% elif pha_header_records.bia_scenarios == 10 %}
                            scarlet
                        {% else %}
                            white
                        {% endif %}
                ; text-align: center">
                {{ pha_header_records.bia_scenarios|default_if_none:"N/A" }}  <!-- Display "N/A" if bia_scenarios is None -->
            </td>



                    <td style="text-align: center">{{ pha_header_records.scenario_count }}</td>
                    <td>{{ pha_header_records.latest_workflow_status }}</td>
                     <td style="text-align: center">
                        {% if pha_header_records.ra_action_count > 0 %}
                            <a href="{% url 'OTRisk:ra_actions_view_pha' pha_id=pha_header_records.ID %}">{{ pha_header_records.ra_action_count }}</a>

                        {% else %}
                            {{ pha_header_records.ra_action_count }}
                        {% endif %}
                    </td>
                    <td>
                        {% if pha_header_records.scenario_count != 0 %}
                            <a class="dropdown-item" href="{% url 'OTRisk:pha_reports'  cyber_pha_header_id=pha_header_records.ID  %}" style="font-weight: bold; color: black">Report</a>
                        {% else %}

                        {% endif %}
                    </td>
                    <!-- Add more <td> elements for each field in the RAWorksheet model -->
                </tr>
            {% endfor %}
        </tbody>
        </table>

        <script>
         $(document).ready(function() {
             // Event handler for clicking on a table row
             $('#headertable').on('click', 'tbody tr.selectable-row', function () {
                 // Remove 'highlighted' class from all other rows
                 $('tr.selectable-row').removeClass('highlighted');

                 // Add 'highlighted' class to the clicked row
                 $(this).addClass('highlighted');

                 let recordId = $(this).data('id');  // get the ID of the clicked row
                 fetchHeaderRecord(recordId);
             });

             // Check if a saved_record_id is provided in the rendered context
             let savedRecordId = "{{ saved_record_id }}";  // Get the saved_record_id from the Django context
             if (savedRecordId && savedRecordId !== "None") {
                 $('tr[data-id="' + savedRecordId + '"]').addClass('highlighted');
                 // If a savedRecordId is provided, automatically trigger the AJAX call
                 fetchHeaderRecord(savedRecordId);
             }










         });
    </script>
    </div> <!-- table view of existing risk assessments -->
    </div>
    </div>
    </div>
    <div class="col-md-1" style="background-color: #464748"></div>
</div>

<div class="row">
    <div class="col-md-1" style="background-color: #464748"></div>
    <div class="col-md-3" style="background-color: #464748"></div>
    <div class="col-md-4" style="background-color: #464748">
        <div class="form-group">
            <div class="row">
                <div class="col-md-3">
                    <button type="submit" id="btnformSubmit" class="form-control"><i class="bi bi-file-earmark-plus"></i> Save</button>
                    <script>
                // Add an event listener to the "Save Header" button
                document.getElementById('btnformSubmit').addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent the form submission (if it's within a form)

                    // Show a SweetAlert confirmation dialog
                    swal({
                        title: "Confirm Save?",
                        text: "Are you sure you want to save the header information?",
                        icon: "warning",
                        buttons: ["Cancel", "Save"],
                        dangerMode: true,
                    })
                    .then((willSave) => {
                        if (willSave) {
                            // User confirmed, continue with the form submission
                            document.forms['frmRAW'].submit();

                        } else {
                            // User canceled the action
                            // You can add additional code here if needed
                        }
                    });
                });
            </script>
                </div>
                <div class="col-md-3" >
                    <button type="button" class="form-control " id="resetButton"><i class="bi bi-plus-circle"></i> New</button>
                    <script>
$(document).ready(function() {
    $('#resetButton').on('click', function() {
        // SweetAlert confirmation prompt
        swal({
            title: 'Are you sure you wish to create a new CyberPHA?',
            text: "Any unsaved changes to the current records will be lost.",
            icon: 'warning',
            buttons: true, // This will enable both buttons
            dangerMode: true,
            buttons: ["Cancel", "Yes, proceed"] // Define the buttons
        }).then((willProceed) => {
            if (willProceed) {
                // User clicked 'Yes, proceed', so execute the reset actions
                // Reset textboxes and textareas
                $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtAddress, #txtFacility, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtEmployees, #annual_revenue, #cyber_insurance, #shift_model, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary').val('');

                // Reset select dropdowns
                $('#selIndustry, #selFacilityType, #assessment_id, #selZone, #selSL').prop('selectedIndex', 0);
                $('#investmentTable tbody').empty();
                // Enable the controls
                $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtAddress, #txtFacility, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary, #selFacilityType, #selIndustry, #selZone, #selSL, #shift_model, #txtEmployees, #annual_revenue, #cyber_insurance, #countrySelector, #btnformSubmit, #risk-assessment-btn').prop('disabled', false);
                $('#btnformSubmit').prop('disabled', false);
                clearContainer('pha_gauge');
                clearContainer('control_gauge');
                //reset session variables
                sessionStorage.setItem('activeCyberPHA', '0');
                // Set the value of the hidden text field
                document.getElementById('txtHdnCyberPHAID').value = '0';
            }
        });
    });
});
</script>


                </div>
                <div class="col-md-3" >
                    <button type="button" class="form-control " id="scenarioButton"><i class="bi bi-pencil-square"></i> Scenarios</button>
                    <script>
                         $(document).ready(function() {
                            $('#scenarioButton').on('click', function() {
                                window.location.href = "{% url 'OTRisk:assess_cyberpha' %}?active_cyberpha=" + sessionStorage.getItem('activeCyberPHA');
                            });
                         });
                    </script>
                </div>
                <div class="col-md-3" >
                    <button id="generatePPT" class="form-control"><i class="bi bi-printer"></i> Print</button>
                </div>
            </div>
        </div>

    </div>
    <div class="col-md-3" style="background-color: #464748"></div>
    <div class="col-md-1" style="background-color: #464748"></div>
</div>


<div class="row" style="background-color: #464748">
    <div class="col-md-1 " style="background-color: #464748"></div>
    <div class="col-md-10 " >
     <div class="row" style="background-color: #464748; height: 10px"></div>
   </div>
    <div class="col-md-1 " style="background-color: #464748;"></div>
</div> <!-- dark grey stripe -->

<div class="row" style="height: 10px">
    <div class="col-md-1 " style="background-color: #464748;"></div>
    <div class="col-md-10 ">
     <div class="row" style="background-color: #464748; height: 10px"></div>
   </div>
    <div class="col-md-1 " style="background-color: #464748;"></div>
</div> <!-- dark grey stripe -->
    <input type="hidden" name="txtHdnCyberPHAID" id="txtHdnCyberPHAID" value="0">
{% if new_record_id %}
    <script>
        // Set the value of the hidden textbox field
        document.querySelector('input[name="txtHdnCyberPHAID"]').value = "{{ new_record_id }}";

        // Store the value in the local session storage
        sessionStorage.setItem('activeCyberPHA', "{{ new_record_id }}");
    </script>

{% endif %}
<div class="row small-font">
    <div class="col-md-1" style="background-color: #464748;"></div>
    <div class="col-md-3 " style="background-color: #464748;">
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <label for="txtTitle" style="color: white">Title:</label><input type="text" class="form-control" name="txtTitle" id="txtTitle" value="{{ current_pha_header.title }}" maxlength="100" style="font-size: 16px; font-weight: bold;" required>
            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <label for="txtLeader" style="color: white">CyberPHA Owner:</label><input type="text" class="form-control" name="txtLeader" id="txtLeader" value="{{ current_pha_header.PHALeader }}" maxlength="100"  required>
            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="selIndustry" style="color: white">Industry:</label>
                <select class="form-control" name="selIndustry" id="selIndustry">
                    <option value=""> -- Select Industry -- </option>
                    {% for industry in industries %}
                        <option value="{{ industry.Industry }}"
                                {% if current_pha_header.Industry == industry.Industry %}selected{% endif %}>
                            {{ industry.Industry }}
                        </option>
                    {% endfor %}
                </select>

            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="txtUnit" style="color: white">Unit:</label><input type="text" class="form-control" name="txtUnit" id="txtUnit" value="{{ current_pha_header.AssessmentUnit }}" required maxlength="100">
            </div>
        </div>

        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
        <div class="card-body">
            <label for="shift_model" style="color: white">Shift Model:</label>
            <select class="form-control" name="shift_model" id="shift_model" required>
                <option value="">Select Shift Model</option>
                {% for model in SHIFT_MODELS %}
                    <option value="{{ model.0 }}" {% if current_pha_header.shift_model == model.0 %}selected{% endif %}>{{ model.1 }}</option>
                {% endfor %}
            </select>
        </div>
</div>
    <div class="form-group">
        <div class="row">
    <div class="col-md-4" style="background-color: #5E6266;">
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <label for="annual_revenue" style="color: white">Facility Annual Revenue:</label>
                <input type="text" class="form-control currency-input" name="annual_revenue" id="annual_revenue" value="{{ annual_revenue_str|default:'0' }}" oninput="checkMaxValue(this)" required>
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        const currencyInput = document.getElementById('annual_revenue');

                        currencyInput.addEventListener('input', function(e) {
                            // Strip any non-digit characters
                            let value = e.target.value.replace(/\D/g, '');

                            // Convert the number to a currency format
                            e.target.value = parseInt(value).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
                        });
                    });

                    function checkMaxValue(input) {
                        // Remove any non-digit characters (e.g., currency symbols, commas)
                        var numericValue = input.value.replace(/[^0-9]/g, '');

                        if (parseInt(numericValue) > 999999999) {
                            input.value = '$999,999,999';
                        } else {
                            // Optionally, re-add currency formatting
                            input.value = '$' + numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        }
                    }
                </script>

            </div>
        </div>
    </div>
    <div class="col-md-4" style="background-color: #5E6266;">
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="coho" style="color: white">Operating Cost/Hour:</label>
                <input type="text" class="form-control currency-input" name="coho" id="coho" value="{{ coho_str|default:'0' }}" oninput="checkMaxValue(this)" required>
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        const currencyInput = document.getElementById('coho');

                        currencyInput.addEventListener('input', function(e) {
                            // Strip any non-digit characters
                            let value = e.target.value.replace(/\D/g, '');

                            // Convert the number to a currency format
                            e.target.value = parseInt(value).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
                        });
                    });


                </script>

            </div>
        </div>
    </div>
    <div class="col-md-4" style="background-color: #5E6266;">
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="npm" style="color: white">Facility NPM (%):</label>
                <input type="number" class="form-control" name="npm" id="npm" value="{{ npm|default:'0' }}" min="0" max="100">


            </div>
        </div>
    </div>
</div>
    </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <label for="txtStartDate" style="color: white">Start Date:</label><input type="date" class="form-control" name="txtStartDate" id="txtStartDate"  value="{{ current_pha_header.AssessmentStartDate }}" required>
            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <label for="txtAddress" style="color: white">Facility Address:</label>
                <textarea class="form-control" rows="2" name="txtAddress" id="txtAddress" style="resize: none" maxlength="500" required>{{ current_pha_header.facilityAddress }}</textarea>
            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
            <label for="countrySelector" style="color: white">Country:</label><a href="#" data-bs-toggle="modal" data-bs-target="#countryModal">❓</a><br><select id="countrySelector" name="countrySelector" style="width: 400px;"></select>

            </div>
        </div>
        <br>

    </div>


    <div class="col-md-3" style="background-color: #464748;">
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <label for="txtFacility" style="color: white">Facility:</label><input type="text" class="form-control" name="txtFacility" id="txtFacility" value="{{ current_pha_header.FacilityName }}"  maxlength="100"  required>
            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <label for="txtLeaderEmail" style="color: white">Leader Email:</label><input type="email" class="form-control" name="txtLeaderEmail" id="txtLeaderEmail" value="{{ current_pha_header.PHALeaderEmail }}" required onblur="validateEmail(this)">
                <script type="text/javascript">
                    function validateEmail(input) {
                        var regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                        if (!regex.test(input.value)) {
                            alert('Please enter a valid email address');
                            input.focus();
                        }
                    }
                </script>
            </div>
        </div>

        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="selFacilityType" style="color: white">Facility Type:</label><br>
                <select class="form-control" name="selFacilityType" id="selFacilityType">
                    <option value=""> -- Select Facility Type -- </option>
                    {% for facilities in facilities %}
                            <option value="{{ facilities.FacilityType }}"
                            {% if current_pha_header.FacilityType == facilities.FacilityType %}selected{% endif %}>
                            {{  facilities.FacilityType }}</option>
                        {% endfor %}
                </select>
                <script>
                    $(document).ready(function() {
                        $('#selFacilityType').select2();
                    });

                </script>
            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">    <label for="selZone" style="color: white">Zone:</label>
                <select class="form-control" name="selZone" id="selZone">
                    <option value = ""> -- Select Plant Zone -- </option>
                    {% for zone in zones %}
                        <option value="{{ zone.PlantZone }}"
                        {% if current_pha_header.AssessmentZone == zone.PlantZone %}selected{% endif %}>
                            {{ zone.PlantZone }}</option>
                    {% endfor %}
                </select>

            </div>

        </div>

        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="selSL" style="color: white">Target Security Level (SL-T):</label>
                <select class="form-control" name="selSL" id="selSL">
            <option value="0"> -- Select SL-T -- </option>
            {% for value, description in SECURITY_LEVELS %}
                <option value="{{ value }}"
                {% if current_pha_header.sl_t|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                    {{ description }}</option>
            {% endfor %}
        </select>
            </div>
        </div>


        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="txtEmployees" style="color: white">Employees on Site:</label><input type="number" class="form-control" name="txtEmployees" id="txtEmployees" value="{{ current_pha_header.EmployeesOnSite }}" max="99999">

            </div>
        </div>

        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <label for="txtEndDate" style="color: white">End Date:</label><input type="date" class="form-control" name="txtEndDate" id="txtEndDate" value="{{ current_pha_header.AssessmentEndDate }}" onchange="validateDates()">
            </div>
        </div>
        <script type="text/javascript">
            function validateDates() {
                var startDate = document.getElementById('txtStartDate').value;
                var endDate = document.getElementById('txtEndDate').value;

                if (endDate < startDate) {
                    alert('End date cannot be before start date');
                    document.getElementById('txtEndDate').value = '';
                }
            }
        </script>


        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
            <label for="assessment_id" style="color: white">Control Assessment:</label>
                <select class="form-control"   id="assessment_id" name="assessment_id">
                    <option value="">Select an Assessment</option>
                    {% for assessment in assessments %}
                        <option value="{{ assessment.id }}"
                        {% if current_pha_header.assessment == assessment.id %}select{% endif %}>
                            {{ assessment.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
           <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#investmentModal">
                OT Security Investments
                </button>
            </div>
        </div>
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
            <div class="card-body">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#moderatorModal">
                    Select CyberPHA Moderators
                </button>
            </div>
        </div>


        <script>
            $(document).ready(function() {
                $("#assessment-select").selectmenu().selectmenu("menuWidget").addClass("overflow");
            });
        </script>



        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;">
    <div class="card-body">
        <label for="workflow_selector" style="color: white">Workflow Status:</label>
        <select class="form-control" id="workflow_selector" name="workflow_selector">
            <option value="">Select a Status</option>
            {% for status, status_display in workflow_status_choices %}
                <option value="{{ status }}"
                        {% if current_workflow_status == status %} selected {% endif %}>
                    {{ status_display }}
                </option>
            {% endfor %}
        </select>
    </div>
        <div class="card-body" style="color: white">
        Current Group Assignments:
        <div id="currentGroupsDiv">
    <!-- Current groups will be populated here by the fetchHeaderRecord function -->
</div>
       <!-- Button to Open the Modal -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#assignGroupModal">
    Assign to Group
</button>


<div class="modal" id="assignGroupModal">
    <div class="modal-dialog">
        <div class="modal-content">


            <div class="modal-header">
                <h4 class="modal-title">Assign to Group</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>


            <div class="modal-body">
                <form id="group-assignment-form">
                    <!-- Existing Groups -->
                    <div class="form-group">
                        <label for="existing_group">Existing Group:</label>
                        <select class="form-control" id="existing_group" name="existing_group">
                            <option value="">Select a Group</option>
                            {% for group in all_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- New Group -->
                    <div class="form-group">
                        <label for="new_group_name">New Group Name:</label>
                        <input type="text" class="form-control" id="new_group_name" name="new_group_name">
                    </div>
                    <div class="form-group">
                    <label for="new_group_type">New Group Type:</label>
                    <select class="form-control" id="new_group_type" name="new_group_type">
                        {% for type_value, type_name in group_types %}
                            <option value="{{ type_value }}">{{ type_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                    <!-- Hidden Field for CyberPHA ID -->
                    <input type="hidden" name="cyberpha_id" value="{{ current_pha_header.ID }}">
                    <!-- Submit Button -->
                    <button type="button" id="assign-group-btn"  class="btn btn-primary">Assign</button>
                </form>
            </div>

        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="investmentModal" tabindex="-1" role="dialog" aria-labelledby="investmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="investmentModalLabel">Add Cybersecurity Investments</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div class="table-responsive">

          <table class="table" id="investmentTable">
            <colgroup>
                  <col span="1" style="width: 20%;"> <!-- Type -->
                  <col span="1" style="width: 20%;"> <!-- Vendor Name -->
                  <col span="1" style="width: 20%;"> <!-- Product Name -->
                  <col span="1" style="width: 15%;"> <!-- Cost -->
                  <col span="1" style="width: 15%;"> <!-- Date -->
                  <col span="1" style="width: 10%;"> <!-- Action -->
                </colgroup>
            <thead>
              <tr>
                <th>Type</th>
                <th>Vendor Name</th>
                <th>Product Name</th>
                <th>Cost</th>
                <th>Date</th> <!-- New Date Column -->
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                    <td><input type="hidden" name="investment_id[]" value="{{ investment.id | default:'' }}" class="form-control"></td>
                <td><select name="investment_type[]" class="form-control">
                    <option value="Software">Software</option>
                    <option value="Hardware">Hardware</option>
                    </select>
                </td>

                <td><input type="text" name="vendor_name[]" class="form-control" /></td>
                <td><input type="text" name="product_name[]" class="form-control" /></td>
                <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
                <td><input type="date" name="date[]" class="form-control" /></td> <!-- New Date Input -->
                <td><button class="btn btn-danger removeRow">Remove</button></td>
              </tr>
            </tbody>

          </table>
          <button type="button" class="btn btn-primary" id="addRow">Add Row</button>

          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

      </div>
    </div>
  </div>
</div>
<script>
$(document).ready(function() {
  $("#addRow").click(function() {
    var newRow = `<tr>
      <td><select name="investment_type[]" class="form-control">
        <option value="Software">Software</option>
        <option value="Hardware">Hardware</option>
        <option value="People">People</option>
      </select></td>
      <td><input type="text" name="vendor_name[]" class="form-control" /></td>
      <td><input type="text" name="product_name[]" class="form-control" /></td>
      <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
      <td><input type="date" name="date[]" class="form-control" /></td>
      <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
    </tr>`;
    $("#investmentTable tbody").append(newRow);
  });

  $(document).on('click', '.removeRow', function() {
    $(this).closest('tr').remove();
  });
});
</script>


    </div>


</div>
<script>
$(document).ready(function() {
    $('#assign-group-btn').on('click', function() {

        var cyberphaId = sessionStorage.getItem('activeCyberPHA'); // Retrieve from session storage
        var existingGroupId = $('#existing_group').val();
        var newGroupName = $('#new_group_name').val();
        var newGroupType = $('#new_group_type').val();

        $.ajax({
            type: 'POST',
            url: '/OTRisk/assign_cyberpha_to_group/', // URL to Django view for assignment
            data: {
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                'cyberpha_id': cyberphaId,
                'existing_group_id': existingGroupId,
                'new_group_name': newGroupName,
                'new_group_type': newGroupType
            },
            success: function(response) {
                // Handle success

                updateGroupAssignmentsDisplay(cyberphaId); // Function to refresh group assignments on the page
                updateGroupList();
                $('#assignGroupModal').modal('hide');
            },
            error: function(error) {
                // Handle error
                console.error('Error:', error);
            }
        });
    });
});

function updateGroupAssignmentsDisplay(cyberphaId) {
    $.ajax({
        type: 'GET',
        url: '/OTRisk/fetch_groups/', // URL to a Django view that returns group assignments
        data: { 'cyberpha_id': cyberphaId },
        success: function(response) {
            // Assuming 'response' contains an array of group names or objects
            var currentGroupsDiv = $('#currentGroupsDiv');
            currentGroupsDiv.empty();

            if (response.groups && response.groups.length > 0) {
                response.groups.forEach(function(group) {
                    // Assuming 'group' contains a property 'name'
                    currentGroupsDiv.append($('<p>').text(group.name));
                });
            } else {
                currentGroupsDiv.append($('<p>').text('No groups assigned.'));
            }
        },
        error: function(error) {
            console.error('Error fetching group assignments:', error);
        }
    });
}

function updateGroupList() {
    $.ajax({
        type: 'GET',
        url: '/OTRisk/fetch_all_groups/', // URL to Django view
        success: function(response) {
            var existingGroupSelect = $('#existing_group');
            existingGroupSelect.empty();

            existingGroupSelect.append($('<option>', {
                value: '',
                text: 'Select a Group'
            }));

            response.groups.forEach(function(group) {
                existingGroupSelect.append($('<option>', {
                    value: group.id,
                    text: group.name
                }));
            });
        },
        error: function(error) {
            console.error('Error fetching groups:', error);
        }
    });
}


document.addEventListener('DOMContentLoaded', function() {
    var workflowSelector = document.getElementById('workflow_selector');
    workflowSelector.addEventListener('change', function() {
        if (this.value === 'Complete') {
            swal({
                title: 'CyberPHA Completed?',
                text: "Once you save the status of this record as 'Complete', you will not be able to make further changes.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, I understand'
            });
        }
    });
});

updateGroupList();
</script>

    </div>

    <div class="col-md-4 row" style="background-color: #464748;">
        <div class="card mb-3 shadow-sm" style="background-color: #5E6266;"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
               <button id="risk-assessment-btn" type="button" class="btn btn-link" style="text-decoration: none; color: white">
                    <img src="{% static 'images/facility1.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">
                    Create Facility PHA Profile
                </button>
                <br>
                <div class="spinner" id="loadingSpinner"></div>
                <p style="font-size: 10px; color: white">A valid address, industry, and facility name must be entered for the risk profile to be accurately assessed. Profiles are generated by a machine-learning algorithm and may slightly vary given the same inputs at different times</p>
                <div class="form-group">
                <div class="row">
                    <div class="col-md-6" style="background-color: #5E6266;">
                        <div id="pha_gauge"></div>

                    </div>
                    <div class="col-md-6" style="background-color: #5E6266;">
                        <div id="control_gauge"></div>
                    </div>
                </div>
                </div>
                <input type="hidden" id="hdn_pha_score" name="hdn_pha_score" value="{{ pha_header_records.pha_score }}">
                <script>
                    drawGauge({{ current_pha_header.pha_score }});
                    drawControlGauge(0);
                </script>
                <div class="form-group">
                <div class="card mb-3 shadow-sm">
    <div class="card-body">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="myTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="safety-tab" data-toggle="tab" href="#safety" role="tab" aria-controls="safety" aria-selected="true"><i class="bi bi-cone-striped"></i> Safety</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="chemical-tab" data-toggle="tab" href="#chemical" role="tab" aria-controls="chemical" aria-selected="false"><i class="bi bi-radioactive"></i> Chemical</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="physical-tab" data-toggle="tab" href="#physical" role="tab" aria-controls="physical" aria-selected="false"><i class="bi bi-shield-exclamation"></i> Physical Security</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="other-tab" data-toggle="tab" href="#other" role="tab" aria-controls="other" aria-selected="false"><i class="bi bi-pc-display-horizontal"></i> OT Assets</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="other-tab" data-toggle="tab" href="#compliance" role="tab" aria-controls="other" aria-selected="false"><i class="bi bi-card-checklist"></i> Compliance</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="other-tab" data-toggle="tab" href="#threats" role="tab" aria-controls="other" aria-selected="false"><i class="bi bi-exclamation-circle"></i> Threats</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="other-tab" data-toggle="tab" href="#insights" role="tab" aria-controls="other" aria-selected="false"><i class="bi bi-binoculars"></i> Insight</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="other-tab" data-toggle="tab" href="#strategy" role="tab" aria-controls="other" aria-selected="false"><i class="bi bi-send-check"></i> Strategy</a>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content mt-3">
            <div class="tab-pane active" id="safety" role="tabpanel" aria-labelledby="safety-tab">
                <label for="txtSafetySummary">Safety Summary:</label>


                <textarea rows="25" name="txtSafetySummary" id="txtSafetySummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.safetySummary }}</textarea>
            </div>
            <div class="tab-pane" id="chemical" role="tabpanel" aria-labelledby="chemical-tab">
                <label for="txtChemical">Chemical Storage:</label>
                <textarea rows="25" name="txtChemical" id="txtChemical" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.chemicalSummary }}</textarea>
            </div>
            <div class="tab-pane" id="physical" role="tabpanel" aria-labelledby="physical-tab">
                <label for="txtPhysical">Physical Security:</label>
                <textarea rows="25" name="txtPhysical" id="txtPhysical" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.physicalSummary }}</textarea>
            </div>
            <div class="tab-pane" id="other" role="tabpanel" aria-labelledby="other-tab">
                <label for="txtOther">OT Assets:</label>
                <textarea rows="25" name="txtOther" id="txtOther" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.otherSummary }}</textarea>
            </div>
            <div class="tab-pane" id="compliance" role="tabpanel" aria-labelledby="other-tab">
                <label for="txtCompliance">Compliance:</label>
                <textarea rows="25" name="txtCompliance" id="txtCompliance" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.complianceSummary }}</textarea>
            </div>
            <div class="tab-pane" id="threats" role="tabpanel" aria-labelledby="other-tab">
                <label for="threatSummary">Threats and Vulnerabilities:</label>
                <textarea rows="25" name="threatSummary" id="threatSummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.threatSummary }}</textarea>
            </div>
            <div class="tab-pane" id="insights" role="tabpanel" aria-labelledby="other-tab">
                <label for="insightSummary">Insights:</label>
                <textarea rows="25" name="insightSummary" id="insightSummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.insightSummary }}</textarea>
            </div>
            <div class="tab-pane" id="strategy" role="tabpanel" aria-labelledby="other-tab">
                <label for="strategySummary">Defense Strategies:</label>
                <textarea rows="25" name="strategySummary" id="strategySummary" class="form-control" style="resize: none; background-color: white; border-width: 0px" readonly>{{ current_pha_header.strategySummary }}</textarea>
            </div>
        </div>
    </div>
</div>
                </div>
                </div>

        </div>

    <script>
$("#generatePPT").click(function(e) {
    e.preventDefault();  // This prevents the default form submission

    $.ajax({
        type: "POST",
        url: "{% url 'OTRisk:generate_ppt' %}",
        data: {
            FacilityName: $("#txtFacility").val(),
            txtSafetySummary: $("#txtSafetySummary").val(),
            txtChemical: $("#txtChemical").val(),
            txtPhysical: $("#txtPhysical").val(),
            txtOther: $("#txtOther").val(),
            txtCompliance: $("#txtCompliance").val(),
            threatSummary: $("#threatSummary").val(),
            insightSummary: $("#insightSummary").val(),
            strategySummary: $("#strategySummary").val(),
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val() // Ensure CSRF token is sent with POST request
        },
        dataType: "json",
        success: function(response) {
            if (response.status === "success") {
                // Redirect to the provided download URL
                window.location.href = response.download_url;
            } else {
                alert("An error occurred: " + response.error);
            }
        },
        error: function(error) {
            alert("An error occurred: " + error.statusText);
        }
    });
});



$(document).ready(function() {
    $("#risk-assessment-btn").click(function() {
        var employeeCount = $("#txtEmployees").val();

        // Check if employeeCount is a number and greater than 0
        if ($.isNumeric(employeeCount) && parseInt(employeeCount) > 0) {
            // Prompt the user for confirmation
            swal({
                title: 'Warning',
                text: 'Generating the assessment profile can take up to a minute. Proceed?',
                icon: 'warning',
                buttons: true,
            }).then((result) => {
                if (result) {
                    // If the user confirms, call the function to assess the risk
                    assessRisk();
                }
            });
        } else {
            swal({
                icon: 'error',
                title: 'Risk Profile Error',
                text: 'Please enter a valid number of employees greater than 0'
            });
        }
    });
});


        // AJAX function to call the Django view
        function assessRisk() {
            $('#loadingSpinner').show();
            // Gather the necessary data for the AJAX request (impact scores and scenario information)
            let address = document.getElementById('txtAddress').value;
            let facilityType = document.getElementById('selFacilityType').value;
            let assessment_id = document.getElementById('assessment_id').value;
            let industry = document.getElementById('selIndustry').value;
            let country = document.getElementById('countrySelector').value;
            let facility = document.getElementById('txtFacility').value;
            let shift_model = document.getElementById('shift_model').value;
            let employees = document.getElementById('txtEmployees').value;
            let investments = [];
            $('#investmentTable tbody tr').each(function() {
                let investment = {
                    type: $(this).find('select[name="investment_type[]"]').val(),
                    vendor_name: $(this).find('input[name="vendor_name[]"]').val(),
                    product_name: $(this).find('input[name="product_name[]"]').val(),
                    cost: $(this).find('input[name="cost[]"]').val(),
                    date: $(this).find('input[name="date[]"]').val()
                };
                investments.push(investment);
            });
            // Make the AJAX call to the Django view using a separate endpoint for risk assessment
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:facility_risk_profile' %}",  // URL for the Django view
                data: {
                    // Pass the impact scores and scenario information as parameters
                    industry: industry,
                    facility_type: facilityType,
                    address: address,
                    country: country,
                    facility: facility,
                    shift_model: shift_model,
                    employees: employees,
                    assessment_id: assessment_id,
                    investments: JSON.stringify(investments)
                 },
                success: function (response) {

                    // Write the response data to the textboxes
                    document.getElementById('txtSafetySummary').value = response.safety_summary;
                    document.getElementById('txtChemical').value = response.chemical_summary;
                    document.getElementById('txtPhysical').value = response.physical_security_summary;
                    document.getElementById('txtOther').value = response.other_summary;
                    document.getElementById('txtCompliance').value = response.compliance_summary;
                    document.getElementById('threatSummary').value = response.threatSummary;
                    document.getElementById('strategySummary').value = response.strategySummary;
                    document.getElementById('insightSummary').value = response.insightSummary;
                    document.getElementById('hdn_pha_score').value = response.pha_score;


                    drawGauge(response.pha_score);

                     $('#loadingSpinner').hide();

                },
                error: function (xhr, status, error) {
                    // Handle any errors that occur during the AJAX call
                    console.error(error);
                    $('#loadingSpinner').hide();
                },
            });
        }

    function showNotification(message, isError = false) {
        var notificationDiv = document.getElementById('notificationMessage');
        notificationDiv.innerHTML = message;
        notificationDiv.style.display = 'block';
        notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

        // Automatically hide the notification after some time
        setTimeout(function() {
        notificationDiv.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }
    </script>
    <br>

    </div>



    <div class="col-md-1" style="background-color: #464748;"></div>
</div>


<div class="row">
        <div class="col-md-1 " style="background-color: #464748;"></div>
        <div class="col-md-10 " style="background-color: #464748;">
         <div class="row" style="background-color: #464748; height: 200px; ">
             <div class="col-md-1 text-left" style="background-color: #464748;">
             </div>
             <div class="col-md-2 text-left" style="background-color: #464748;">
             </div>
             <div class="col-md-3 text-left" style="background-color: #464748;"></div>
            <div class="col-md-6 text-right" style="background-color: #464748;">


             </div>
        </div>

       </div>
        <div class="col-md-1 " style="background-color: #464748;"></div>
    </div> <!-- dark grey stripe with submit/reset buttons-->

<!-- Modal -->
<div class="modal fade" id="moderatorModal" tabindex="-1" role="dialog" aria-labelledby="moderatorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moderatorModalLabel">Select CyberPHA Moderators</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
    <form id="moderatorsForm">
        <div class="form-group">
                        <label for="targetDate">Target Completion Date:</label>
                        <input type="text" class="form-control" id="targetDate" name="targetDate" placeholder="mm/dd/yy">
                        <script>
                        $( function() {
                            $( "#targetDate" ).datepicker({
                                dateFormat: "mm/dd/yy"
                            });
                        });
                        </script>

                    </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
                <!-- Moderators will be populated dynamically by JavaScript -->
            </tbody>
        </table>
    </form>
</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <!-- Add more buttons if needed -->
            </div>
        </div>
    </div>
</div>


</form>

<script>
    $(document).ready(function() {
        var table = $('#headertable').DataTable({
            "pageLength": 5,
            "lengthChange": false
        });

        function navigateToRecord(recordId) {
            var allPages = table.page.info().pages;
            var found = false;

            for (var i = 0; i < allPages; i++) {
                // Navigate to the page
                table.page(i).draw('page');

                // Check if the record is in the current page
                var row = $('tr[data-id="' + recordId + '"]');
                if (row.length) {
                    // Record found, highlight it
                    $('tr.selectable-row').removeClass('highlighted');
                    row.addClass('highlighted');
                    found = true;
                    break;
                }
            }

            if (!found) {
                console.log("Record not found");
            }
        }

        // Check if a saved_record_id is provided in the rendered context
        let savedRecordId = "{{ saved_record_id }}";
        if (savedRecordId && savedRecordId !== "None") {
            navigateToRecord(savedRecordId);
        }

        $('#headertable').on('click', 'tbody tr.selectable-row', function() {
            let recordId = $(this).data('id');
            navigateToRecord(recordId);
        });
});

    function populateInvestmentTable(investments) {
    const tableBody = $('#investmentTable tbody');
    tableBody.empty(); // Clear existing rows

    investments.forEach(function(investment) {
        const row = `<tr>
            <td><input type="hidden" name="investment_id[]" value="${investment.id}" class="form-control">
                <select name="investment_type[]" class="form-control">
                    <option value="Software" ${investment.investment_type === 'Software' ? 'selected' : ''}>Software</option>
                    <option value="Hardware" ${investment.investment_type === 'Hardware' ? 'selected' : ''}>Hardware</option>
                    <option value="People" ${investment.investment_type === 'People' ? 'selected' : ''}>People</option>
                </select>
            </td>
            <td><input type="text" name="vendor_name[]" value="${investment.vendor_name}" class="form-control"></td>
            <td><input type="text" name="product_name[]" value="${investment.product_name}" class="form-control"></td>
            <td><input type="number" name="cost[]" value="${investment.cost}" class="form-control" step="0.01"></td>
            <td><input type="date" name="date[]" value="${investment.date}" class="form-control"></td>
            <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
        </tr>`;
        tableBody.append(row);
    });

    // Ensure the removeRow button functionality is re-bound after adding new rows
    $('.removeRow').off('click').on('click', function() {
        $(this).closest('tr').remove();
    });
}

function fetchHeaderRecord(recordId) {
                 sessionStorage.setItem('activeCyberPHA', recordId);
                 // Set the value of the hidden text field
                 document.getElementById('txtHdnCyberPHAID').value = recordId;
                 $.ajax({
                     url: '/OTRisk/get_headerrecord',  // the URL of the view that will handle the request
                     data: {
                         'record_id': recordId
                     },
                     dataType: 'json',
                     success: function (data) {

                         $('#txtTitle').val(data.headerrecord.title);
                         $('#txtLeader').val(data.headerrecord.leader);
                         $('#selIndustry').val(data.headerrecord.industry);
                         $('#txtUnit').val(data.headerrecord.unit);
                         $('#txtFacility').val(data.headerrecord.facility);
                         $('#txtLeaderEmail').val(data.headerrecord.leaderemail);
                         $('#selFacilityType').val(data.headerrecord.facilitytype);

                         $('#selFacilityType').val(data.headerrecord.facilitytype).trigger('change');

                         $('#assessment_id').val(data.headerrecord.assessment_id);
                         $('#assessment_id').val(data.headerrecord.assessment_id).trigger('change');

                         $('#selZone').val(data.headerrecord.zone);
                         $('#selSL').val(data.headerrecord.sl_t);
                         $('#txtStartDate').val(data.headerrecord.startdate);
                         $('#txtEndDate').val(data.headerrecord.enddate);
                         $('#txtSafetySummary').val(data.headerrecord.safetysummary);
                         $('#txtChemical').val(data.headerrecord.chemicalsummary);
                         $('#txtPhysical').val(data.headerrecord.physicalsummary);
                         $('#txtOther').val(data.headerrecord.othersummary);
                         $('#txtCompliance').val(data.headerrecord.compliancesummary);
                         $('#threatSummary').val(data.headerrecord.threatSummary);
                         $('#insightSummary').val(data.headerrecord.insightSummary);
                         $('#strategySummary').val(data.headerrecord.strategySummary);
                         $('#txtAddress').val(data.headerrecord.address);
                         $('#countrySelector').val(data.headerrecord.country).trigger('change');
                         $('#shift_model').val(data.headerrecord.shift_model);
                         $('#txtEmployees').val(data.headerrecord.EmployeesOnSite);
                         $('#annual_revenue').val(formatAsCurrency(data.headerrecord.annual_revenue));
                         $('#cyber_insurance').val(data.headerrecord.cyber_insurance);
                         $('#cyber_insurance').val(data.headerrecord.cyber_insurance).trigger('change');
                         $('#hdn_pha_score').val(data.headerrecord.pha_score);
                         $('#npm').val(data.headerrecord.npm);
                         $('#coho').val(formatAsCurrency(data.headerrecord.coho));
                         drawGauge(data.headerrecord.pha_score);

                         drawControlGauge(data.control_effectiveness);

                         populateInvestmentTable(data.investments);

                         sessionStorage.setItem('sessionIndustry', data.headerrecord.industry);
                         sessionStorage.setItem('sessionFacilityType', data.headerrecord.facilitytype);
                         sessionStorage.setItem('sessionFacility', data.headerrecord.facility);
                         sessionStorage.setItem('sessionCountry', data.headerrecord.country);
                         var pha_score = data.headerrecord.pha_score;

                         // Enable the controls
                         $('#txtTitle, #txtLeader, #txtUnit, #txtStartDate, #txtAddress, #txtFacility, #txtLeaderEmail, #txtEndDate, #txtSafetySummary, #txtChemical, #txtPhysical, #txtOther, #txtCompliance, #strategySummary, #insightSummary, #threatSummary, #selFacilityType, #assessment_id, #cyber_insurance, #shift_model, #annual_revenue, #txtEmployees, #selIndustry, #selZone, #selSL, #countrySelector, #btnformSubmit,  #risk-assessment-btn, #scenarioButton, #generatePPT').prop('disabled', false);
                         $('#btnformSubmit').prop('disabled', false);
                         $('#scenarioButton').prop('disabled', false);
                         // Set the workflow status dropdown
                         // Ensure the current workflow status matches the format of the dropdown options
                         var currentWorkflowStatus = data.headerrecord.current_workflow_status;

                         var workflowSelector = $('#workflow_selector');

                         // Check if the current workflow status exists in the options
                         if (workflowSelector.find("option[value='" + currentWorkflowStatus + "']").length > 0) {
                             workflowSelector.val(currentWorkflowStatus).trigger('change');
                         } else {
                             // If the status doesn't exist, select the default placeholder
                             workflowSelector.val('').trigger('change');
                         }

                         if (currentWorkflowStatus == 'Complete') {

                             lockControls();
                         } else {
                             unlockControls();
                         }

                         $('#generatePPT').prop('disabled', false);
                         populateModeratorsTable(data.organization_moderators, data.moderator_ids);
                         // Populate current group assignments
                         console.log(data.all_groups);
                         populateCurrentGroups(data.headerrecord.current_groups);

                         // Populate all available groups in the dropdown (for the modal)
                         populateAllGroupsDropdown(data.all_groups);
                         updateGroupAssignmentsDisplay(recordId);
                         updateGroupList();


                     }
                 });
             }

function formatAsCurrency(value) {
                 // Strip any non-digit characters
                 let cleanedValue = String(value).replace(/\D/g, '');

                 // Convert the number to a currency format
                 return parseInt(cleanedValue).toLocaleString('en-US', {
                     style: 'currency',
                     currency: 'USD',
                     minimumFractionDigits: 0
                 });
             }

function populateModeratorsTable(moderators, moderatorIds) {
                 var tbody = $('#moderatorModal tbody');
                 tbody.empty(); // Clear existing rows

                 moderators.forEach(function (moderator) {
                     var checked = moderatorIds.includes(moderator.id) ? 'checked' : '';
                     var row = '<tr>' +
                         '<td>' + moderator.name + '</td>' +
                         '<td><input type="checkbox" name="moderator" value="' + moderator.id + '" ' + checked + '></td>' +
                         '</tr>';
                     tbody.append(row);
                 });
             }

                 // Function to populate current groups
 function populateCurrentGroups(groups) {
                 var currentGroupsDiv = $('#currentGroupsDiv');
                 currentGroupsDiv.empty(); // Clear existing content

                 // Check if 'groups' is an array and has elements
                 if (Array.isArray(groups) && groups.length > 0) {
                     groups.forEach(function (group) {
                         currentGroupsDiv.append($('<p>').text(group.name));
                     });
                 } else {
                     // Handle non-array or empty 'groups'
                     currentGroupsDiv.append($('<p>').text('No groups assigned.'));
                 }
             }


 function populateAllGroupsDropdown(groups) {
                 var allGroupsSelect = $('#existing_group'); // ID of the select element in the modal
                 allGroupsSelect.empty(); // Clear existing options

                 allGroupsSelect.append($('<option>', {
                     value: '',
                     text: 'Select a Group'
                 }));

                 if (groups && groups.length > 0) {
                     groups.forEach(function (group) {
                         allGroupsSelect.append($('<option>', {
                             value: group.id,
                             text: group.name
                         }));
                     });
                 }
             }
</script>

<div class="modal fade" id="countryModal" tabindex="-1" aria-labelledby="countryModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModal_Label">Country Selection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Selecting the correct country in which the facility is located improves the accuracy of the scenario event cost estimation</p>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="assessmentDialog" tabindex="-1" aria-labelledby="assessmentDialogLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assessmentDialogLabel">Select an Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pha_header_records in pha_header_records %}
                            <tr class="selectable-row" data-id="{{ pha_header_records.ID }}">
                                <td>{{ pha_header_records.title }}</td>
                                <td>{{ pha_header_records.latest_workflow_status }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Define the csrfSafeMethod function to check if a HTTP method is safe from CSRF protection
function csrfSafeMethod(method) {
    // These HTTP methods do not require CSRF protection
    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
}

// Define the getCookie function to retrieve the CSRF token from cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Check if this cookie name starts with the specified name
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Using jQuery
$(document).ready(function() {
    // Update the displayed value when the slider changes
    $("input[type='range']").on('input', function() {
        var id = $(this).attr('id').replace("mitigation_", "");
        $("#mitigationValue_" + id).text($(this).val());
    });

});

</script>

<div class="card mb-3 shadow-sm" style="visibility: hidden">
            <div class="card-body">
    <label for="cyber_insurance">Cyber Insurance</label>
    <select class="form-control" name="cyber_insurance" id="cyber_insurance">

        <option value="0" {% if current_pha_header.cyber_insurance == false %}selected{% endif %}>No</option>
        <option value="1" {% if current_pha_header.cyber_insurance == true %}selected{% endif %}>Yes</option>
    </select>
    <script>
       $(document).ready(function() {
                $('#cyber_insurance').select2();

                // var cyber_insurance_value = data.headerrecord.cyber_insurance ? "1" : "0";
                // $('#cyber_insurance').val(cyber_insurance_value).trigger('change');
            });

    </script>
</div>
</div>
<script>
    function lockControls() {
    // Disable all input, select, and button elements
    document.querySelectorAll('input, select, button').forEach(function(el) {
        // Exclude elements inside the 'headertable' table and the 'resetButton' by id
        if (!el.closest('#headertable') && el.id !== 'resetButton') {
            el.disabled = true;
        }
    });
}


function unlockControls() {
        // Disable all input, select, and button elements
        document.querySelectorAll('input, select, button').forEach(function(el) {

            el.disabled = false;
        })
    }
</script>

</body>
</html>