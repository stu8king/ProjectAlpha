{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/anzen_owl.png' %}" type="image/x-icon">
<!-- FontAwesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>

<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<!-- Bootstrap CSS -->
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

<!-- jQuery (Full version, required for Bootstrap and jQuery UI) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- Popper.js (Required for Bootstrap) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<!-- D3.js -->
<script src="https://d3js.org/d3.v6.min.js"></script>

<!-- AnyChart -->
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-linear-gauge.min.js"></script>


<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">

{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

<style>
#checklistContainer {
        /* Keep the responsive width adjustments */
        width: 10vw;
        max-width: 100%; /* Ensures it doesn't overflow its parent container */

        /* Revert the positioning to the original or desired spot */
        position: absolute; /* Adjust based on your layout's needs */
        left: initial; /* Or specify the exact position if needed, e.g., '20px' */
        right: initial; /* Resetting any previously set right value */

        /* Maintain margin, padding, and optional styles for aesthetics */
        margin-left: 2vw; /* Adjust as necessary for spacing from the left or surrounding content */
        padding: 10px;

        /* Optional: Add background, border, and shadow for aesthetics */
        background-color: #464748;
        border-radius: 0.1vw;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);

        /* Ensure it's above other content if necessary */
        z-index: 1;
    }

    #checklistContainer {
    color: white; /* White text color */
}

/* Style for the text next to checkboxes */
#checklistContainer div {
    font-size: 0.8em; /* Smaller font size */
}
    .custom-checkbox {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 1em;
    height: 1em;
    border: 1px solid #000; /* Black border */
    border-radius: 0.15em;
    outline: none;
    cursor: pointer;
    position: relative;
}

.custom-checkbox:checked {
    background-color: #000; /* Black background when checked */
}

.custom-checkbox:checked:after {
    content: '';
    position: absolute;
    top: 0.15em;
    left: 0.45em;
    width: 0.2em;
    height: 0.6em;
    border: solid white;
    border-width: 0 0.15em 0.15em 0;
    transform: rotate(45deg);
}
/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0,0.4);
  padding-top: 60px;
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}
.form-group {
border: 1px solid #464748; /* Border color */
box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
background-color: #5E6266; /* Lighter shade of #464748 */
padding: 15px; /* Optional: for internal spacing */
}


     body {
        background-color: #464748;
        color: #d3d1cd;
    }
.sidebar {
    display: flex;
    height: 100vh;
    background-color: #2D2E30; /* Darker shade for sidebar */
    padding: 1vw;
    width: 10vw; /* Sidebar width */
}
    .sidebar-logo {
    padding: 1vw;
    text-align: center;
}
    .nav-sidebar {
        display: flex;
        flex-direction: column;
        padding-left: 0;
        list-style: none;
    }
    .nav-sidebar .nav-item {
        padding: 0.1vw;
        /* border-bottom: 1px solid  #fac330; /* Light orange line */
        margin: 0 10%;
        gap: 1rem;
    }
    .nav-sidebar .nav-link {
        color: #d3d1cd;
        border-radius: 0;
        transition: color 0.3s ease-in-out;
        font-size: 0.7rem;
    }
    .nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
        background-color: #3A5F5F;
        color: #E0E0E0;
    }
    /* Enhance dropdown menu */
    .dropdown-menu {
        background-color: #d3d1cd;
        border: none;
    }
    .dropdown-item:hover, .dropdown-item:focus {
        background-color: #fac330; /* Light orange background for hovered dropdown items */
        color: #2D2E30;
    }
    .content {
        padding: 20px;
    }
.custom-main-content {
    position: relative; /* Needed for absolute positioning of tabs */
    margin-left: 10px; /* Adjust to account for both sidebars */
    width: calc(100% - 350px); /* Adjust based on the total width of the sidebars */
    min-height: 100vh; /* Ensure it fills the viewport height */
}


@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: calc(100% - 200px);
        max-width: calc(90vw - 200px);
        margin-left: 100px;
    }
}
.form-sim .form-control {
    max-width: 100%; /* Ensures select does not exceed container width */
    width: auto; /* Optional: Ensures select width is based on content up to max-width */
}
.group-container {
    background: linear-gradient(to bottom right, #464748, #57595b); /* Gradient background */
    border: 1px solid #666; /* Darker border */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); /* Box shadow */
    padding: 25px;
    margin-bottom: 30px; /* Increased space between containers */
    border-radius: 10px; /* Rounded corners */
}

.group-header {
    color: #d3d1cd; /* Lighter color for contrast */
    font-weight: bold;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #777; /* Subtle bottom border */
    font-size: 1.2em; /* Larger font size */
}

.group-body {
    color: #e0e0e0; /* Slightly lighter text color */
    font-family: 'Arial', sans-serif; /* Modern font */
}
.cube-icon {
    width: 20px; /* Adjust size as needed */
    height: 20px; /* Adjust size as needed */
    margin-right: 10px;
}
#scenarioSelectionModal .modal-body .list-group {
    max-height: 400px; /* Adjust this value based on your needs */
    overflow-y: auto; /* Enables vertical scrolling */
}
@media (max-width: 768px) {
  .modal-lg {
    max-width: 90%; /* Adjust based on preference */
  }
}

.investment-box {
    fill: #eee; /* Light background for the boxes */
    stroke: #666; /* Dark border for the boxes */
}

.investment-text {
    fill: #000; /* Black text color */
    font-size: 12px; /* Adjust as needed */
}

svg {
    display: block;
    margin: 0 auto; /* Center the SVG in its container */
    overflow: visible;
}

path.connection {
    stroke: #333;
    stroke-width: 2;
    fill: none;
}

#investmentImpactVisualization {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
}


/* Adjustments may be needed based on the exact layout and spacing */
.custom-main-content .container {
    width: 100%; /* Ensure the container fills the custom-main-content */
    max-width: none; /* Override Bootstrap's max-width for containers if necessary */
}
.top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 100px; /* Align with the end of the sidebar */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}

.page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.5rem; /* Adjust size as needed */
}

@media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
     .sub-menu {
        left: 0;
        width: 100px; /* Adjust for smaller screens */
    }

.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
    width: 80%; /* 80% of the available width to the right */
    height: 80vh; /* 80% of the viewport height */
    position: absolute; /* Positioning relative to its nearest positioned ancestor */
    left: 350px; /* This should be directly to the right of the sub-menu */
    top: 0; /* Align with the top of the viewport */
    overflow: auto; /* Add scroll for overflow content */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

.tab-content.active {
    display: block; /* Only the active tab is displayed */
}



    .custom-main-content {
        margin-left: 100px; /* Adjust based on the sub-menu width on smaller screens */
    }
}
/* Sub-menu styles */
.sub-menu {
    position: fixed; /* Fixed position to stay in view */
    top: 0; /* Align with the top of the viewport */
    left: 10vw; /* Position the sub-menu right next to the sidebar */
    width: 7vw; /* Width of the sub-menu */
    height: 100vh; /* Full viewport height */
    background-color: #333; /* Sub-menu background color */
    color: #fff; /* Text color */
    padding: 1vw ; /* Padding */
    box-sizing: border-box; /* Include padding in width calculation */
    font-size: 0.8rem;
}

.sub-menu ul {
    list-style: none; /* Remove default list styling */
    padding: 0; /* Remove default padding */
    margin: 0; /* Remove default margin */
}

.sub-menu li a {
    color: #d3d1cd; /* Link color */
    text-decoration: none; /* Remove underline */
    display: block; /* Make the links fill the container */
    padding: 10px 0; /* Padding for touch targets */
    transition: background-color 0.3s; /* Smooth transition for hover effect */
}

.sub-menu li a:hover, .sub-menu li a.active {
    background-color: #57595b; /* Hover/active background color */
}
.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
}

.tab-content.active {
    display: block; /* Only the active tab is displayed */
}
.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
    width: 80%; /* 80% of the available width */
    height: 80vh; /* 80% of the viewport height */
    position: absolute; /* Positioning relative to its nearest positioned ancestor */
    left: 350px; /* Adjust based on the total width of the main sidebar and sub-menu */
    top: 0; /* Align with the top of the viewport */
    overflow: auto; /* Add scroll for overflow content */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

#attack_tree {
    display: flex; /* Use flexbox for centering */
    justify-content: left; /* Center horizontally */
    align-items: center; /* Center vertically */
    overflow: initial;
    background-color: #253349; /* Match the image's background color */
    height: 100%; !important; /* Adjust based on your layout needs */
}

.swal2-custom-border {
    border: 2px solid #ddd; /* Lighter border */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Shadow */
}

.nav-link.disabled {
    pointer-events: none; /* Prevent clicking */
    opacity: 0.5; /* Visual feedback that the link is disabled */
}
.nav-sidebar .nav-link img {
    width: 1.25em; /* Scales with the font size */
    height: 1.25em; /* Scales with the font size */
}
/* Larger icons for tablets */
@media (min-width: 768px) {
    .nav-sidebar .nav-link img {
    width: 1.5em;
    height: 1.5em;
    }
}
/* Even larger icons for desktops */
@media (min-width: 992px) {
    .nav-sidebar .nav-link img {
    width: 1.75em;
    height: 1.75em;
    }
}
.switch {
  position: relative;
  display: block;
  width: 60px;
  height: 34px;
    margin: 0;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider1 {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider1:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider1 {
  background-color: #2196F3;
}

input:focus + .slider1 {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider1:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider1.round {
  border-radius: 34px;
}

.slider1.round:before {
  border-radius: 50%;
}
/* Custom CSS for Select2 dropdown items */
.select2-results__option {
    color: black !important; /* Ensure the color applies over default Select2 styles */
}
.white-text {
    color: white !important; /* !important ensures the style applies over any existing styles */
}
</style>
</head>
<body style="background-color: #464748">
<script>
anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");
let isProgrammaticChange = false;
let tab2Changed= false;


fetch('https://restcountries.com/v3.1/all')
    .then(response => response.json())
    .then(data => {
        // Sort the countries alphabetically
        data.sort((a, b) => a.name.common.localeCompare(b.name.common));

        // Add a blank option as the default
        $('#countrySelector').append(new Option('', ''));

        // Populate the dropdown
        data.forEach(country => {
            const countryName = country.name.common;
            $('#countrySelector').append(new Option(countryName, countryName));
        });
    })
    .then(() => {
        $('#countrySelector').select2({
            placeholder: "Select a country", // This will display the placeholder text
            allowClear: true // This allows users to clear the selected value
        });
    })
    .catch(error => {
        console.error("There was an error fetching the country list:", error);
    });

document.addEventListener("DOMContentLoaded", function() {
    const links = document.querySelectorAll('.sub-menu a');
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab) currentTab.classList.remove('active');
            const newTab = document.getElementById(this.getAttribute('data-tab'));
            newTab.classList.add('active');

            // Update active state for links
            document.querySelector('.sub-menu a.active')?.classList.remove('active');
            this.classList.add('active');
        });
    });
});
</script>
<div class="container-fluid">

    <div class="row">
        {% include 'menu_bar.html' %}
        <!-- Main content area, including sub-menu and tabs -->
        <div class="col-md-9 col-lg-10">
            <!-- Top Strip -->
            <div class="top-strip">
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3">
                    <h1 class="page-title">Scenario Builder@AnzenOT (Beta)</h1>
                    </div>
                    <div class="col-md-1">
                        <button id="newScenarioBtn" class="btn nav-link">New Scenario</button>
<script>
document.getElementById('newScenarioBtn').addEventListener('click', function() {
                                swal.fire({
                                    title: "Are you sure?",
                                    html: "Any unsaved changed data will be lost. Proceed?",
                                    iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">',
                                    imageWidth: 150, // Adjust as necessary
                                    imageHeight: 150, // Adjust as necessary
                                    background: '#000', // Black background
                                    color: '#fff', // Set text color to white
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Yes',
                                    cancelButtonText: 'Cancel',
                                    customClass: {
                                        popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                                    }
                                })
                                .then((result) => {
                                    if (result.isConfirmed) {
                                        // User pressed "Yes", clear the content
                                        document.getElementById('txtScenario').value = ''; // Clear Scenario tab content
                                        document.getElementById('txtConsequences').value = ''; // Clear Consequences tab content
                                        document.getElementById('txtBestCase').value = ''; // Clear Event Costs tab content
                                        document.getElementById('txtMostLikelyCase').value = '';
                                        document.getElementById('txtWorstCase').value = '';

                                        $('#selIndustry').val('').trigger('change');
                                        $('#selFacilityType').val('').trigger('change');
                                        $('#selOrganizationSize').val('').trigger('change');
                                        $('#selRegulatoryEnvironment').val('').trigger('change');
                                        $('#selThreats').val('').trigger('change');
                                        $('#selVectors').val('').trigger('change');
                                        document.getElementById('targetComponent').value = '';
                                        document.getElementById('attackEffect').value = '';
                                        document.getElementById('targetSystem').value = '';
                                        document.getElementById('impact').value = '';
                                        document.getElementById('motivation').value = '';
                                        document.getElementById('hdnIncidents').value = '';

                                        $('#monthly_cost_chart').empty();
                                        $('#bia_groups').empty();
                                        $('#investmentImpactVisualization').empty();
                                        $('#attack_tree').empty();
                                        $('#related_incidents').html('');

                                        document.getElementById('analyzeConsequencesCheckbox').checked = false;
                                        document.getElementById('analyzeAttackTreeCheckbox').checked = false;
                                        document.getElementById('analyzeScenarioCheckbox').checked = false;
                                        document.getElementById('analyzeCostsCheckbox').checked = false;
                                        document.getElementById('analyzeToolsCheckbox').checked = false;
                                        document.getElementById('analyzeIncidentsCheckbox').checked = false;
                                        // Add more lines as needed for other inputs you wish to clear

                                        swal.fire({
                                            title: "Data is cleared. Create new scenario!",
                                            imageUrl: '/static/images/anzen_owl.png',
                                            imageWidth: 150, // Adjust as necessary
                                            imageHeight: 150, // Adjust as necessary
                                            background: '#000', // Black background
                                            color: '#fff', // Set text color to white
                                            customClass: {
                                                popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                                            }
                                        });
                                        document.querySelector('a[data-tab="tab2"]').click();
                                    } else {
                                        // User pressed "Cancel", do nothing

                                    }
                                });
                            });

function abbreviateValue(value) {
    var newValue = value;
    if (value >= 1000 && value < 1000000) {
        newValue = "$" + (value / 1000).toFixed(1) + "k"; // Thousands
    } else if (value >= 1000000) {
        newValue = "$" + (value / 1000000).toFixed(1) + "m"; // Millions
    } else {
        newValue = "$" + value; // Less than 1000
    }
    return newValue;
}

function adjustScaleForContainer(svgElement, container) {
    const svgRect = svgElement.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    // Find the scaling factor needed to fit the SVG within the container
    const scaleX = containerRect.width / svgRect.width;
    const scaleY = containerRect.height / svgRect.height;
    const scale = Math.min(scaleX, scaleY, 1); // Ensure scale is not more than 1

    return scale;
}

function convertSVGToPNG(svgElement, scale = 0.5) {
    var xmlSerializer = new XMLSerializer();
    var svgString = xmlSerializer.serializeToString(svgElement);

    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');

    var devicePixelRatio = window.devicePixelRatio || 1;
    // No need to adjust scale here since we're fitting the image to the container
    canvas.width = svgElement.getBoundingClientRect().width * devicePixelRatio;
    canvas.height = svgElement.getBoundingClientRect().height * devicePixelRatio;

    // Adjust the drawing scale for device pixel ratio to enhance clarity
    ctx.scale(devicePixelRatio, devicePixelRatio);

    var DOMURL = window.URL || window.webkitURL || window;
    var img = new Image();
    var svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
    var url = DOMURL.createObjectURL(svgBlob);

    img.onload = function () {
        ctx.drawImage(img, 0, 0);
        DOMURL.revokeObjectURL(url);

        var imgURI = canvas.toDataURL('image/png');

        var container = document.getElementById('attack_tree');
        if (container) {
            container.innerHTML = ''; // Clear previous content

            var pngImage = new Image();
            pngImage.src = imgURI;
            // Ensure the image fits within the container
            pngImage.style.maxWidth = '100%';
            pngImage.style.maxHeight = '100%';
            pngImage.style.objectFit = 'contain'; // Image will be scaled to maintain its aspect ratio

            container.appendChild(pngImage);
        } else {
            console.error('Container for the PNG image not found.');
        }
    };

    img.src = url;
}
function drawAttackTree(data) {

        //$('#tab9').addClass('active').show();
        document.querySelector('a[data-tab="tab9"]').click();
        var container = document.getElementById('attack_tree');
        var containerWidth = container.clientWidth * 1.2;
        var svgWidth = containerWidth * 0.7;
        var margin = { top: 20, right: 120, bottom: 20, left: 150 };
        var width = svgWidth - margin.left - margin.right;
        var height = 800; // Increased height for better resolution

        d3.select(container).selectAll("svg").remove();

        var svg = d3.select(container).append("svg")
            .attr("width", "100%")
            .attr("viewBox", "0 0 " + svgWidth + " " + height)
            .attr("height", height)
            .style("display", "block")
            .style("margin", "auto")
            .style("background-color", "#253349C0") // Set the background color
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var i = 0,
            duration = 750,
            root;

    var treemap = d3.tree()
        .size([height, width - margin.left - margin.right])
        .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2); });

    root = d3.hierarchy(data, function(d) { return d.children; });
    root.x0 = height / 2;
    root.y0 = 0;

    // Color-blind-friendly color scale
    var colorScale = d3.scaleOrdinal(["#88CCEE", "#DDCC77", "#CC6677", "#882255", "#44AA99", "#117733", "#999933", "#AA4499"]);

    update(root);

    function update(source) {
        var treeData = treemap(root);

        var nodes = treeData.descendants(),
            links = treeData.descendants().slice(1);

        nodes.forEach(function(d) { d.y = d.depth * 180 });

        var node = svg.selectAll('g.node')
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeEnter.append('circle')
            .attr('r', 10)
            .style("stroke", "black")
            .style("stroke-width", 1.5)
            .style("fill", function(d) { return colorScale(d.depth); });

        nodeEnter.append('text')
            .style("fill", "#FFFFFF") // Set label color to white
            .style("font-size", "0.8em")
            .style("font-weight", "bold")
            .attr("transform", "rotate(-10)")
            .attr("dy", ".30em")
            .attr("x", function(d) { return d.children ? -13 - this.getComputedTextLength() : 13; })
            .attr("text-anchor", function(d) { return d.children ? "end" : "start"; })
            .text(function(d) { return d.data.name; });

        var link = svg.selectAll('path.link')
            .data(links, function(d) { return d.id; });

        link.enter().insert('path', "g")
            .attr("class", "link")
            .style("stroke", "#96C5ECC0") // Set line color
            .style("stroke-width", 2)
            .style("fill", "none")
            // Removed the arrow marker reference
            .attr('d', function(d) {
                return "M" + d.y + "," + d.x
                    + "C" + (d.y + d.parent.y) / 2 + "," + d.x
                    + " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
                    + " " + d.parent.y + "," + d.parent.x;
            });
    }

            sessionStorage.setItem('attackTreeDrawn', 'true');
            var svgElement = container.querySelector('svg');
            const scale = adjustScaleForContainer(svgElement, document.getElementById('attack_tree'));
            // Pass it to the convertSVGToPNG function
            //convertSVGToPNG(svgElement, 0.5); // Adjust the scale as needed
            var attackTreeDiv = document.getElementById('attack_tree')


        }

function createCostChart(containerId, costArray) {
    var data = [];
    for (let i = 0; i < costArray.length; i++) {
        data.push({x: `Month ${i + 1}`, value: costArray[i]});
    }

    // Ensure the chart library is ready before creating the chart
    anychart.onDocumentReady(function() {
        // Clear the container before creating a new chart
        document.getElementById(containerId).innerHTML = '';

        var chart = anychart.column();
        chart.data(data);

        // Set the chart title
        chart.title("Monthly Cost Estimates");

        // Customize the X-axis labels
        var xAxis = chart.xAxis();
        xAxis.title("Month");
        xAxis.labels()
            .rotation(-70) // Angle the labels
            .fontSize(10); // Smaller font size

        // Customize the Y-axis
        var yAxis = chart.yAxis();
        yAxis.title("Cost in USD");

        var series = chart.getSeries(0);
        series.labels(true);
        series.labels()
            .position("above")
            .anchor("centerBottom")
            .fontSize(10)
            .format(function() {
                return abbreviateValue(this.value);
            });

        // Optionally disable credits if needed
        var credits = chart.credits();
        credits.enabled(false);

        // Draw the chart in the specified container
        chart.container(containerId);
        chart.draw();
    });
}
function loadScenarioDetails(scenarioId) {
    document.getElementById('analyzeConsequencesCheckbox').checked = false;
    document.getElementById('analyzeAttackTreeCheckbox').checked = false;
    document.getElementById('analyzeScenarioCheckbox').checked = false;
    document.getElementById('analyzeCostsCheckbox').checked = false;
    document.getElementById('analyzeToolsCheckbox').checked = false;
    document.getElementById('analyzeIncidentsCheckbox').checked = false;
    document.getElementById('hdnIncidents').value = '';

    $.ajax({
        url: `/OTRisk/retrieve_scenario_builder_v2/${scenarioId}`,
        type: "GET",
        success: function(response) {
    $('#monthly_cost_chart').empty();
    $('#bia_groups').empty();
    $('#investmentImpactVisualization').empty();
    $('#attack_tree').empty();
    $('#related_incidents').html('');

    $('#txtScenario').val(response.scenario_description);
    $('#txtConsequences').val(response.consequences);
    var costs = response.costs;
    $('#txtBestCase').val(costs.bestCase);
    $('#txtMostLikelyCase').val(costs.mostLikelyCase);
    $('#txtWorstCase').val(costs.worstCase);
    var decodedText = atob(response.investment_projection);
    $('#txthdninvestmentstring').val(response.investment_projection);
    $('#selIndustry').val(response.industry).trigger('change');
    $('#selFacilityType').val(response.facility).trigger('change');
    $('#countrySelector').val(response.country).trigger('change');
    $('#selOrganizationSize').val(response.org).trigger('change');
    $('#selRegulatoryEnvironment').val(response.regs).trigger('change');
    $('#selThreats').val(response.attacker);
    $('#selVectors').val(response.vector);
    $('#targetComponent').val(response.target);
    $('#attackEffect').val(response.effect);
    $('#targetSystem').val(response.network);
    $('#impact').val(response.impact);
    $('#motivation').val(response.motivation);
    $('#hdnIncidents').val(response.incidents);

    renderInvestmentImpact(decodedText);

    var costArray = response.cost_projection.split('|').map(Number);
    createCostChart('monthly_cost_chart', costArray);

    $('#hdnAT').val(response.attack_tree_data);

    var jsonObject = JSON.parse(response.attack_tree_data);
    drawAttackTree(jsonObject);

    // Clear existing BIA groups content
    var biaGroupsContainer = document.getElementById('bia_groups');
    biaGroupsContainer.innerHTML = '';

    var factors = response.factors;
    var factorKeys = Object.keys(factors);
    var rows = [];

    factorKeys.forEach(function(factor, index) {
        if (index % 3 === 0) {
            var row = document.createElement('div');
            row.className = 'row';
            rows.push(row);
        }

        var groupContainer = document.createElement('div');
        groupContainer.className = 'group-container col-md-4';

        var groupHeader = document.createElement('div');
        groupHeader.className = 'group-header';
        var icon = document.createElement('img');
        var factorData = factors[factor];
        if (factorData.score > 7) {
            icon.src = "{% static 'images/redcube.png' %}";
        } else if (factorData.score > 4) {
            icon.src = "{% static 'images/yellow_cube.png' %}";
        } else {
            icon.src = "{% static 'images/green_cube.png' %}";
        }
        icon.className = 'cube-icon';
        icon.alt = 'cube_icon';
        groupHeader.appendChild(icon);
        var headerText = document.createTextNode(factor);
        groupHeader.appendChild(headerText);
        groupContainer.appendChild(groupHeader);

        var groupBody = document.createElement('div');
        groupBody.className = 'group-body';
        var scoreText = document.createElement('strong');
        scoreText.textContent = factorData.score + '/10. ';
        groupBody.appendChild(scoreText);
        var narrativeText = document.createTextNode(factorData.narrative);
        groupBody.appendChild(narrativeText);
        groupContainer.appendChild(groupBody);

        rows[rows.length - 1].appendChild(groupContainer);

        if ((index + 1) % 3 === 0 || index === factorKeys.length - 1) {
            biaGroupsContainer.appendChild(rows[rows.length - 1]);
        }
    });

    if (response.incidents) {
        var table = $('<table class="table table-striped white-text"><thead><tr><th>Title</th><th>Description</th><th>Date</th><th>URL</th></tr></thead><tbody></tbody></table>');
        $('#related_incidents').append(table);

        var incidents = response.incidents.split('\n\n');
        incidents.forEach(function(incident) {
            var parts = incident.split('|');
            if (parts.length === 4) {
                var row = $('<tr></tr>');
                parts.forEach(function(part, index) {
                    if (index === 3) {
                        var cell = $('<td class="white-text"></td>').html('<a href="' + part + '" target="_blank">Link</a>');
                    } else {
                        var cell = $('<td class="white-text"></td>').text(part);
                    }
                    row.append(cell);
                });
                table.find('tbody').append(row);
            }
        });
    } else {
        $('#related_incidents').html('<p>No related incidents data available.</p>');
    }

    Swal.fire({
        title: "Scenario loaded successfully",
        imageUrl: '/static/images/anzen_owl.png',
        imageWidth: 150,
        imageHeight: 150,
        background: '#000',
        color: '#fff',
        customClass: {
            popup: 'swal2-custom-border'
        }
    });
},

        error: function(xhr, status, error) {
        console.error('Error loading scenario:', error);
        }
        });
}

function fetchAndDisplayScenarios() {
$.ajax({
url: "/OTRisk/list_scenario_builders/", // Adjust the URL to your backend endpoint
type: "GET",
success: function(response) {
const scenarios = response.scenarios;
const scenarioList = $('#scenarioList');
scenarioList.empty(); // Clear existing items
scenarios.forEach(function(scenario) {
scenarioList.append(`
<li class="list-group-item d-flex align-items-center scenario-item" data-id="${scenario.id}">
<i class="bi bi-file-earmark-text mr-2"></i> ${scenario.scenario_name}
</li>
`);
});
$('.scenario-item').click(function() {
const scenarioId = $(this).data('id');
loadScenarioDetails(scenarioId); // Function to load selected scenario details
$('#scenarioSelectionModal').modal('hide');
});
$('#scenarioSelectionModal').modal('show');
},
error: function(xhr, status, error) {
console.error('Error fetching scenarios:', error);
}
});
}

</script>


                    </div>
                    <div class="col-md-1">
                    <button type="button" class="btn nav-link" onclick="fetchAndDisplayScenarios()">Load Scenario</button>
                    </div>

                    <div class="col-md-1">
                       <button id="saveScenarioBtn" class="btn nav-link">Save Scenario</button>
                        <script>
                        document.getElementById('saveScenarioBtn').addEventListener('click', function() {
                            var scenarioText = document.getElementById('txtScenario').value.trim();
                            var facility_type = document.getElementById('selFacilityType').value.trim();
                            var industry = document.getElementById('selIndustry').value.trim();
                            var threat_actor = document.getElementById('selThreats').value.trim();
                            var attack_vector = document.getElementById('selVectors').value.trim();

                            // Check for the presence of the necessary values
                            if (!scenarioText || !facility_type || !industry || !threat_actor || !attack_vector) {
                                // Inform the user that more information is needed
                                Swal.fire({
                                    title: 'Incomplete Data',
                                    text: 'Please provide a complete scenario, select a facility type, industry, threat actor, and attack vector before saving.',
                                    iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">',
                                    imageWidth: 150, // Adjust as necessary
                                    imageHeight: 150, // Adjust as necessary
                                    background: '#000', // Black background
                                    color: '#fff', // Set text color to white
                                    confirmButtonText: 'OK',
                                    customClass: {
                                        popup: 'swal2-custom-border'
                                    }
                                });
                                document.querySelector('a[data-tab="tab2"]').click();
                                return; // Exit the function early
                            }


                            Swal.fire({
                                title: 'Please enter a name for this scenario:',
                                input: 'text',
                                iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">',
                                imageWidth: 150, // Adjust as necessary
                                imageHeight: 150, // Adjust as necessary
                                background: '#000', // Black background
                                color: '#fff', // Set text color to white
                                inputAttributes: {
                                    autocapitalize: 'off'
                                },
                                showCancelButton: true,
                                confirmButtonText: 'Save',
                                showLoaderOnConfirm: true,
                                customClass: {
                                    popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                                },
                                preConfirm: (scenarioName) => {
                                    if (!scenarioName) {
                                        Swal.showValidationMessage(`Please enter a scenario name.`);
                                    }
                                    return scenarioName; // You might want to call saveScenario(scenarioName) here or handle it outside.
                                },
                                allowOutsideClick: () => !Swal.isLoading()
                            }).then((result) => {
                                if (result.isConfirmed && result.value) {
                                    saveScenario(result.value);
                                }
                            });
                        });
                        </script>


                    </div>
                    <div class="col-md-5"></div>
                </div>
               <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-8">
                        <div class="progress" style="display:none;" id="loadingProgressBar">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBarInner"></div>
                        </div>
                        <span id="progressBarMessage" style="display:block; text-align:center; margin-top:5px;"></span> <!-- Adjust styling as needed -->
                    </div>
                    <div class="col-md-2"></div>
                </div>
                <br>
            </div>
        <div class="sub-menu">
            <br><br><br><br><br><br><br><br><br><br>
        <ul>
            <li><a href="#" data-tab="tab1">Instructions</a></li>
            <li><a href="#" data-tab="tab2">Parameters</a></li>
            <li><a href="#" data-tab="tab3">Tools & Software</a></li>
            <li><a href="#" data-tab="tab4" id="scenarioTabLink">Scenario</a></li>

            <li><a href="#" data-tab="tab5">Consequences</a></li>
            <li><a href="#" data-tab="tab6">Event Costs</a></li>
            <li><a href="#" data-tab="tab7">Business Impact</a></li>
            <li><a href="#" data-tab="tab8">Tools/Software Analysis</a></li>
            <li><a href="#" data-tab="tab9">Attack Tree</a></li>
            <li><a href="#" data-tab="tab10">Related Incidents</a></li>
        </ul>
    </div>


    <div class="custom-main-content" >

    <div id="checklistContainer">
         <div class="form-group">
        <div>
            <input type="checkbox" id="analyzeConsequencesCheckbox" class="custom-checkbox" disabled> Analyze Consequences
        </div>
        <div>
            <input type="checkbox" id="analyzeAttackTreeCheckbox" class="custom-checkbox" disabled> Generate Attack Tree
        </div>
        <div>
            <input type="checkbox" id="analyzeScenarioCheckbox" class="custom-checkbox" disabled> Business Impact Analysis
        </div>
        <div>
            <input type="checkbox" id="analyzeCostsCheckbox" class="custom-checkbox" disabled> Estimate Event Costs
        </div>
        <div>
            <input type="checkbox" id="analyzeToolsCheckbox" class="custom-checkbox" disabled> Analyze Tools & Software
        </div>
        <div>
            <input type="checkbox" id="analyzeIncidentsCheckbox" class="custom-checkbox" disabled> Find Related Incidents

        </div>
         </div>
    </div>

    <div class="tab-content active" id="tab1">
        <h2>Instructions</h2>
        <div class="form-group">
            <label id="instructions">

                <p>
                <h5>1. Parameters.</h5> Input and select parameters relevant to the scenario. The industry sector, type of facility, and country are mandatory fields.
                </p>
                <p>
                <h5>2. Tools and Software.</h5> Enter information about OT security tools and software that have been purchased or are planned.
                </p>
                <p>
                <h5>3. Scenario.</h5> Changing any of the parameters in step 1 will automatically update the text in the scenario box. You can use the generated text or edit and update the scenario text with more relevant information. The more specific and detailed the scenario text, the better the results.
                </p>
                <p>When the scenario text is complete, click the "Execute Analysis" link in the top menu to activate the scenario builder.</p>
                <p>
                <h5>4. Consequences.</h5> After the scenario builder has completed execution, the assumed immediate consequences of the scenario will be listed in the tab.
                </p>
                <p>
                <h5>New Scenario.</h5> Clicking this link clears any scenario information currently displayed on the screen. A warning message will be displayed stating that "Any unsaved data will be lost". Click Cancel to stop to operation. Click Yes to continue and clear the current scenario data.
                </p>
                <p>
                <h5>Load Scenario.</h5> Click this link to load previously saved scenarios.
                </p>
                <p>
                <h5>Execute Analysis.</h5> Click this link to run the Scenario Builder AI and generate the analysis objects.
                </p>
                <p>
                <h5>Save Scenario.</h5> Click this link to store the existing scenario and the associated objects that are generated with it.
                </p>
            </label>
        </div>
    </div>

    <div class="tab-content " id="tab2">
        <h2>Scenario Parameters</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group form-sim" >
                    <label>Enter details about the facility</label>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="selIndustry" style="color:black"><img src="{% static 'images/icon_industry.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;" > Industry</label>
                                <select class="form-control" name="selIndustry" id="selIndustry" style="color:black; width:100%">
                                    <option value=""> -- Select Industry -- </option>
                                    {% for industry in industries %}
                                    <option value="{{ industry.Industry }}"
                                            {% if current_pha_header.Industry == industry.Industry %}selected{% endif %}>
                                        {{ industry.Industry }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="selFacilityType" style="color:black"><img src="{% static 'images/function.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Facility Type</label>
                                <select class="form-control" name="selFacilityType" id="selFacilityType" style="color:black; width:100%">
                                    <option value=""> -- Select Facility Type -- </option>
                                    {% for facilities in facilities %}
                                        <option value="{{ facilities.FacilityType }}"
                                        {% if current_pha_header.FacilityType == facilities.FacilityType %}selected{% endif %}>
                                        {{  facilities.FacilityType }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="countrySelector" style="color:black"><img src="{% static 'images/icon_world.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Country</label>
                                <select class="form-control" id="countrySelector" name="countrySelector" style="color:black; width:100%"></select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="selOrganizationSize" style="color:black"><img src="{% static 'images/icon_group.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Organization Size</label>
                                <select class="form-control" id="selOrganizationSize" name="selOrganizationSize" style="color:black; width:100%">
                                    <option value=""> -- Select Organization Size -- </option>
                                    <option value="Small, 50-200 employees">Small, 50-200 employees</option>
                                    <option value="Medium-sized, 200-1000 employees">Medium-sized, 200-1000 employees</option>
                                    <option value="Large, over 1000 employees">Large, over 1000 employees</option>
                                    <option value="Multinational corporation">Multinational corporation</option>
                                </select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                                <div class="card-body">
                                    <label for="selRegulatoryEnvironment" style="color:black"><img src="{% static 'images/icon_regulation.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Regulatory Environment</label>
                                    <select class="form-control" id="selRegulatoryEnvironment" name="selRegulatoryEnvironment" style="color:black; width:100%">
                                        <option value=""> -- Select Regulatory Environment -- </option>
                                        <option value="Strict Regulation">Strict Regulation</option>
                                        <option value="Moderate Regulation">Moderate Regulation</option>
                                        <option value="Minimal Regulation">Minimal Regulation</option>
                                        <option value="International Standards Compliance">International Standards Compliance</option>
                                        <option value="Self-Regulated">Self-Regulated</option>
                                    </select>
                                </div>
                            </div>
                    </div>
            </div>
            <div class="col-md-6">
                <div class="form-group form-sim">
                <form id="scenarioForm">
                    <label>Enter details about the attack</label>
                    <div class="card mb-2 shadow-sm">
                        <div class="card-body">
                            <label for="selThreats" style="color: black">Attacker/Bad Actor:</label>
                            <select class="form-control" name="selThreats" id="selThreats" >
                                <option value=""> -- Select Attacker -- </option>
                                {% for threats in threats %}
                                <option value="{{ threats.ThreatSource }}">

                                    {{ threats.ThreatSource }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="card mb-2 shadow-sm">
                        <div class="card-body">
                            <label for="selVectors" style="color: black">Attack Vector:</label>
                            <select class="form-control" name="selVectors" id="selVectors" >
                                <option value="" > -- Select Attack Vector -- </option>
                                {% for attack_vectors in attack_vectors %}
                                <option value="{{ attack_vectors.ThreatAction }}" >

                                    {{ attack_vectors.ThreatAction }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                <div class="form-group">
                    <label for="targetComponent" style="color: white">Target Component/Device:</label>
                    <input type="text" class="form-control" id="targetComponent" name="targetComponent" style="width: 100%">

                    <label for="attackEffect">Effect of Attack:</label>
                    <input type="text" class="form-control" id="attackEffect" name="attackEffect" style="width: 100%">

                    <label for="targetSystem">Target System/Network:</label>
                    <input type="text" class="form-control" id="targetSystem" name="targetSystem" style="width: 100%">

                    <label for="impact">Potential Impact:</label>
                    <input type="text" class="form-control" id="impact" name="impact" style="width: 100%">

                    <label for="motivation" title="Guidewords are parameters that, when used in combination with the other parameters, are used to describe the deviation from normal operations. ">Guidewords:</label>
                    <input type="text" class="form-control" id="motivation" name="motivation" style="width: 100%">
                </div>
                <br>

                <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                    <label class="switch-label">Active Operations</label>
                    <label class="switch">
                    <input for="active_ops" type="checkbox" id="active_ops" name="active_ops">
                    <span class="slider1 round"></span>
                    </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                    <label class="switch-label">Cyber Insurance Cover</label>
                    <label class="switch">
                    <input for="cyber_insurance" type="checkbox" id="cyber_insurance" name="cyber_insurance">
                    <span class="slider1 round"></span>
                    </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                    <label class="switch-label">Business Continuity Plan</label>
                    <label class="switch">
                    <input for="bc_plan" type="checkbox" id="bc_plan" name="bc_plan">
                    <span class="slider1 round"></span>
                    </label>
                    </div>
                </div>
                </div>

        </form>
            </div>
            </div>

        </div>
    <script>
$(document).ready(function() {

    // Listen for any change event within #tab2
    $('#tab2').find('input, select, textarea').change(function() {
        tab2Changed = true;
    });
});
</script>

    </div>

    <!-- Tab 2 Content -->
    <div class="tab-content" id="tab3">
        <h2>Tools & Software</h2>
        <div class="form-group">
            <label style="color:white">List purchases that have been, or are planned to be, made for OT Cybersecurity risk mitigation</label>
            <div class="table-responsive">
            <script>
                $(document).ready(function() {
  $("#addRow").click(function() {
    var newRow = `<tr>

      <td><input type="text" name="vendor_name[]" class="form-control" /></td>
      <td><input type="text" name="product_name[]" class="form-control" /></td>
      <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
      <td><input type="date" name="date[]" class="form-control" /></td>
      <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
    </tr>`;
    $("#investmentTable tbody").append(newRow);
  });

  $(document).on('click', '.removeRow', function() {
    $(this).closest('tr').remove();
  });
});
            </script>
          <table class="table" id="investmentTable">
            <colgroup>

                  <col span="1" style="width: 25%;"> <!-- Vendor Name -->
                  <col span="1" style="width: 25%;"> <!-- Product Name -->
                  <col span="1" style="width: 15%;"> <!-- Cost -->
                  <col span="1" style="width: 15%;"> <!-- Date -->
                  <col span="1" style="width: 10%;"> <!-- Action -->
                </colgroup>
            <thead>
              <tr>

                <th>Vendor Name</th>
                <th>Product Name</th>
                <th>Cost</th>
                <th>Date</th> <!-- New Date Column -->
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr>

                <td><input type="text" name="vendor_name[]" class="form-control" /></td>
                <td><input type="text" name="product_name[]" class="form-control" /></td>
                <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
                <td><input type="date" name="date[]" class="form-control" /></td> <!-- New Date Input -->
                <td><button class="btn btn-danger removeRow">Remove</button></td>
              </tr>
            </tbody>

          </table>
          <button type="button" class="btn btn-primary" id="addRow">Add Row</button>

          </div>
        </div>
    </div>

    <!-- Tab 3 Content -->
    <div class="tab-content" id="tab4">
        <h2>Scenario</h2>
        <div class="card-body">
            <div id="spinner" class="spinner-border" role="status" style="display: none;">
            <span class="sr-only">Loading...</span>
            </div>
            <div class="form-group">
            <label for="txtScenario">Review and edit the scenario text then click "Execute Analysis"</label>
            <textarea id="txtScenario" class='form-control' rows=11 placeholder='Enter a detailed cybersecurity scenario or click "Parameters" in the menu to use the scenario builder. Then click the "Execute Analysis" link to run the scenario' style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; background-color: white"></textarea>
            <br>
                <div class="row">
                <div class="col-md-2">
                    <a href="#" id="undoScenario" style="display:none; cursor: pointer; color:#ffffff">Undo</a>
                </div>
                <div class="col-md-8"></div>
                <div class="col-md-2">
                    <button id="analyzeScenarioBtn" class="btn nav-link" type="button" style="font-weight: bold; color:#ffffff"><i class="bi bi-file-play"></i> Execute Analysis</button>
                    <div id="spinnerContainer" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<script>

// Ensure DOM is fully loaded before executing the script
document.addEventListener('DOMContentLoaded', function() {
var txtScenarioElement = document.getElementById('id_txtScenario');
if (txtScenarioElement) {
    txtScenarioElement.addEventListener('input', function() {
        provideSuggestions(this.value);
    });
}
});

$(document).ready(function() {

// Attach change listeners to all inputs and selects within Tab 1
$('#tab2 input, #tab2 select').change(function() {

    if (isProgrammaticChange) { // Check if change is not programmatic

        tab2Changed = true;
    }
});

$('.sub-menu a').click(function(e) {
    e.preventDefault();

    // Remove 'active' class from all tabs
    $('.tab-content').removeClass('active');

    // Add 'active' class to clicked tab
    var tabId = $(this).attr('data-tab');
    $('#' + tabId).addClass('active');
    var currentScenarioText = $('#txtScenario').val();
    // Check if the Scenario tab was clicked
    if ($(this).attr('id') === 'scenarioTabLink') {
         if (tab2Changed) {

             // Proceed with AJAX call only if changes were made in Tab 1
                document.getElementById('spinner').style.display = 'block';
                var formData = {
                    'attacker': $('#selThreats').val(),
                    'attackVector': $('#selVectors').val(),
                    'targetComponent': $('#targetComponent').val(),
                    'attackEffect': $('#attackEffect').val(),
                    'targetSystem': $('#targetSystem').val(),
                    'impact': $('#impact').val(),
                    'motivation': $('#motivation').val(),
                    'facility_type': $('#selFacilityType').val(),
                    'industry': $('#selIndustry').val(),
                    'regulations': $('#selRegulatoryEnvironment').val(),
                    'active_ops': $('#active_ops').is(':checked'),
                    'cyber_insurance': $('#cyber_insurance').is(':checked'),
                    'bc_plan': $('#bc_plan').is(':checked'),
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                };
                $('#undoScenario').show().off('click').on('click', function() {
                // Restore the scenario text and hide the "undo" link
                $('#txtScenario').val(currentScenarioText);
                $(this).hide();
                return false;
            });
                $.ajax({
                    url: "{% url 'OTRisk:generate_scenario_description_v2' %}",
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.scenario_description) {
                            $('#txtScenario').val(response.scenario_description);
                        } else {
                            $('#txtScenario').val('No scenario description available.');
                        }
                        $('#scenarioBuilderModal').modal('hide');
                    },
                    error: function(xhr, status, error) {
                        console.error('Error generating scenario:', error);
                    },
                    complete: function() {
                        // Hide the spinner and reset the flag
                        document.getElementById('spinner').style.display = 'none';
                        tab2Changed = false;
                    }
                });
        } else {
            document.getElementById('spinner').style.display = 'none';
        }

        tab2Changed = false;
    }
});
});

</script>
                </div>


    </div>

    <!-- Tab 4 Content -->
    <div class="tab-content" id="tab5">
        <h2>Consequences</h2>
        <div class="form-group">
        <div class="card mb-2 shadow-sm">
                <div class="card-body">
                    <label for="txtConsequences" class="d-flex align-items-center clickable-label"  ><img src="{% static 'images/scenario.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Consequences</label>
                    <textarea id="txtConsequences" class='form-control' rows=11 placeholder='' style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; background-color: white"></textarea>
                </div>
            </div>

        </div>

    </div>

    <div class="tab-content" id="tab6">
        <h2>Event Costs</h2>
        <div class="form-group">
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                    <label for="txtBestCase">Best Case $</label>
                    <input type="text" id="txtBestCase" class="form-control" style="border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; ">
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <label for="txtMostLikelyCase">Most Likely Case $$</label>
                    <input type="text" id="txtMostLikelyCase" class="form-control" style="border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; ">
                </div>
            </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <label for="txtWorstCase">Worst Case $$$</label>
                    <input type="text" id="txtWorstCase" class="form-control" style="border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; ">
                </div>
            </div>
            </div>
        </div>
            </div>
         <div class="group-container">
                <div class="group-header">
                     Twelve-Month Projection
                </div>
                <div class="group-body">
                    <div id="monthly_cost_chart" style="height:300px"></div>
                    <input type="hidden" id="scenario_12month_costs" name="scenario_12month_costs">
                </div>
            </div>
    </div>
    <!-- Tab 5 Content -->
    <div class="tab-content" id="tab7">
        <h2>Business Impact</h2>
        <div class="form-group">
        <span id="bia_groups"></span>
        </div>
    </div>

    <!-- Tab 6 Content -->
    <div class="tab-content" id="tab8">
        <h2>Tools & Software Analysis</h2>
        <div class="form-group">
            <div id="investmentImpactVisualization"></div>
        </div>
    </div>

    <div class="tab-content" id="tab9">
        <h2>Attack Tree</h2>
        <div class="form-group">
            <div id="attack_tree" style="width:100%;"></div>
        </div>
    </div>
    <div class="tab-content" id="tab10">
        <h2>Related Incidents</h2>
        <div class="form-group">
            <span id="related_incidents"></span>
            <input type="hidden" id="hdnIncidents">
        </div>
    </div>
</div>
</div>

<script>
    $(document).ready(function() {
        // Initialize Select2 for all dropdowns
        $('#selIndustry').select2();
         $('#selVectors').select2({
            placeholder: "Select an Attack Vector",
            allowClear: true,
            width: '100%',
            dropdownCssClass: 'custom-dropdown-font-color' // Your custom class here
        });
        $('#selThreats').select2({
            placeholder: "Select an Attack Vector",
            allowClear: true,
            width: '100%', // This helps ensure Select2 uses the full width of its container
            dropdownCssClass: 'custom-dropdown-font-color'

        });
        // $('#selAssetValue').select2();
        $('#selFacilityType').select2();
        $('#selOrganizationSize').select2();
        // $('#selOperationalImpact').select2();
        // $('#selSecurityMeasures').select2();
        $('#selRegulatoryEnvironment').select2();
        // Add more initialization if needed
    });
</script>


<input type="hidden" id="hdnAT" name="hdnAT">

<div class="row" style="visibility: hidden">
    <div class="col-md-1"></div>

    <div class="col-md-10">
        <div class="form-group">
        <span id="table_scenario"></span>
            </div>
    </div>
    <div class="col-md-1"></div>
</div>


<!-- Scenario Selection Modal -->
<div class="modal fade" id="scenarioSelectionModal" tabindex="-1" role="dialog" aria-labelledby="scenarioSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scenarioSelectionModalLabel">Select Scenario</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Search scenario..." aria-label="Search scenario">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
          </div>
        </div>
        <ul id="scenarioList" class="list-group">
          <!-- Dynamically populated list items will go here -->
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Open</button>
      </div>
    </div>
  </div>
</div>
</div>

<input type="hidden" id="txthdninvestmentstring" name="txthdninvestmentstring">

 <script>
function updateProgressBar(percent, message) {
    $('#progressBarInner').css('width', percent + '%').attr('aria-valuenow', percent);
    $('#progressBarMessage').text(message);
}

function renderInvestmentImpact(investmentImpactText) {
        $('#tab8').addClass('active').show();

    var bulletPoints = investmentImpactText.split('\n').filter(bp => bp.trim().length > 0);
    // Clear previous content
    $("#investmentImpactVisualization").empty();

    // Create a container for the visualization
    var container = d3.select("#investmentImpactVisualization")
        .style("display", "flex")
        .style("justify-content", "space-evenly")
        .style("align-items", "flex-start") // Align items at the start to manage varying heights
        .style("flex-wrap", "wrap") // Allow boxes to wrap in the container
        .style("padding", "20px")
        .style("gap", "20px") // Space between boxes
        .style("background-color", "#f0f0f0");

    bulletPoints.forEach(function(bp, index) {
        var box = container.append("div")
            .style("border", "2px solid #007BFF") // A vibrant, color-blind friendly border color
            .style("border-radius", "10px")
            .style("padding", "20px")
            .style("margin-bottom", "20px") // Margin at the bottom for spacing
            .style("background-color", "#ffffff") // White background for contrast
            .style("box-shadow", "0 8px 16px rgba(0,0,0,0.15)") // Deeper shadow for a sleek look
            .style("display", "flex")
            .style("flex-direction", "column")
            .style("justify-content", "space-between") // Distribute space evenly inside the box
            .style("align-items", "center")
            .style("text-align", "center") // Center align the text
            .attr("class", "investment-box") // Add a class for further manipulation
            .style("min-width", "240px") // Minimum width for each box
            .style("max-width", "300px") // Maximum width to ensure consistency
            .append("p")
            .text(bp)
            .style("margin-top", "10px") // Margin at the top inside the box
            .style("margin-bottom", "10px") // Margin at the bottom inside the box
            .style("font-size", "16px") // Enhanced font size for readability
            .style("color", "#333333") // Darker text color for better contrast
            .style("word-wrap", "break-word"); // Ensure text wraps within the box
    });

    // After all boxes are created, adjust their height to match the tallest box
    var maxHeight = d3.max(container.selectAll(".investment-box").nodes(), function(box) {
        return box.getBoundingClientRect().height;
    });

    // Set the container height to accommodate the tallest box with some padding
    container.selectAll(".investment-box").style("height", maxHeight + "px");
    document.querySelector('a[data-tab="tab4"]').click();
}

function collectInvestments() {
    var investments = [];
    $('#investmentTable tbody tr').each(function() {
        investments.push({
            vendor_name: $(this).find('input[name="vendor_name[]"]').val(),
            product_name: $(this).find('input[name="product_name[]"]').val(),
            cost: $(this).find('input[name="cost[]"]').val(),
            date: $(this).find('input[name="date[]"]').val()
        });
    });
    return investments;
}

document.getElementById('analyzeScenarioBtn').addEventListener('click', function() {
    var scenarioDetails = {
        scenarioText: document.getElementById('txtScenario').value,
        facility_type: document.getElementById('selFacilityType').value,
        industry: document.getElementById('selIndustry').value,
        organization_size: document.getElementById('selOrganizationSize').value,
        regulatory_environment: document.getElementById('selRegulatoryEnvironment').value,
        country: document.getElementById('countrySelector').value,
        threat_actor: document.getElementById('selThreats').value,
        attack_vector: document.getElementById('selVectors').value,
        target: document.getElementById('targetComponent').value,
        effect: document.getElementById('attackEffect').value,
        network: document.getElementById('targetSystem').value,
        impact: document.getElementById('impact').value,
        motivation: document.getElementById('motivation').value,
        investments: collectInvestments()
    };

    // Check for the presence of the necessary values
    if (!scenarioDetails.scenarioText || !scenarioDetails.facility_type || !scenarioDetails.industry || !scenarioDetails.threat_actor || !scenarioDetails.attack_vector) {
        // Inform the user that more information is needed
        swal.fire({
            title: 'Incomplete Data',
            text: 'Please provide a minimum of a scenario description, facility type, industry, threat actor, and attack vector before proceeding.',
            iconHtml: '<img src="/static/images/anzen_owl.png" width="100px" alt="">',
            imageWidth: 150, // Adjust as necessary
            imageHeight: 150, // Adjust as necessary
            background: '#000', // Black background
            color: '#fff', // Set text color to white
            confirmButtonText: 'OK',
            customClass: {
                popup: 'swal2-custom-border'
            }
        });
        document.querySelector('a[data-tab="tab2"]').click();
        return; // Exit the function early
    }

    swal.fire({
        title: 'Are you sure?',
        html: "The scenario analysis can take up to 2 minutes to complete. Do not navigate away from the page or click any links while execution is in progress. Continue?",
        iconHtml: '<img src="/static/images/anzen_owl.png" width="100px" alt="">',
        imageWidth: 150,
        imageHeight: 150,
        background: '#000',
        color: '#fff',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, proceed',
        cancelButtonText: 'Cancel',
        customClass: {
            popup: 'swal2-custom-border'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('analyzeConsequencesCheckbox').checked = false;
            document.getElementById('analyzeAttackTreeCheckbox').checked = false;
            document.getElementById('analyzeScenarioCheckbox').checked = false;
            document.getElementById('analyzeCostsCheckbox').checked = false;
            document.getElementById('analyzeToolsCheckbox').checked = false;
            document.getElementById('analyzeIncidentsCheckbox').checked = false;
            $('#loadingProgressBar').show();

            spinnerContainer.style.display = 'block';
            let progress = 0;
            const progressBarInterval = setInterval(() => {
                if (progress < 90) { // Avoid completing 100% using the interval
                    progress += 1;
                    updateProgressBar(progress, 'Processing...');
                }
            }, 600);

Promise.all([
                analyzeScenario(scenarioDetails),
                generateAttackTree(scenarioDetails),
                analyzeConsequences(scenarioDetails),
                relatedIncidents(scenarioDetails)
            ]).then(responses => {
                // Ensure this runs only after all promises are resolved
                clearInterval(progressBarInterval); // Stop the gradual progress
                updateProgressBar(100, 'All analyses completed.');

                // Schedule hiding the progress bar after a brief moment to show completion
                setTimeout(() => {
                    $('#loadingProgressBar').hide();
                    $('.sub-menu a, .nav-link').css({
                        'pointer-events': '',
                        'color': '' // Restore original styles
                    });
                }, 1000); // Hide after 1 second to let user see completion

            }).catch(error => {
                clearInterval(progressBarInterval); // Stop the progress on error
                console.error('An error occurred:', error);
                $('#loadingProgressBar').hide();
                $('.sub-menu a, .nav-link').css({
                    'pointer-events': '',
                    'color': '' // Restore original styles on error
                });
            });
        }
    });
});

function analyzeScenario(scenarioDetails) {
    return new Promise((resolve, reject) => {
        // AJAX request for analyzing the scenario
        $.ajax({
            url: "/OTRisk/analyze_sim_scenario_v2/", // Replace with the correct URL mapped in your Django urls.py
            type: 'POST',
            headers: {
                "X-CSRFToken": getCsrfToken() // Include CSRF token from cookies
            },
            data: {
                'scenario': scenarioDetails.scenarioText,
                'industry': scenarioDetails.industry,
                'facility_type': scenarioDetails.facility_type,
                'investment_data': JSON.stringify(scenarioDetails.investments), // Assuming investments is an array of objects
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val() // Correct way to get CSRF token value
            },
            timeout: 300000,
            success: function(response) {

                updateProgressBar(80, 'Scenario analysis completed...');

                // Resetting submenu and nav-link classes without assuming their initial styles
                $('.sub-menu a').css('pointer-events', '').removeClass('disabled-link');
                $('.nav-link').removeClass('disabled');

                document.getElementById('analyzeScenarioCheckbox').checked = true;
                document.getElementById('analyzeToolsCheckbox').checked = true;
                 updateUIWithResults(response);



                resolve(response); // Resolve the promise with the AJAX response for chaining
            },
            error: function(xhr, status, error) {
                reject(error); // Reject the promise on error
            }
        });
    });
}

function generateAttackTree(scenarioDetails) {
    return new Promise((resolve, reject) => {

        // AJAX request for generating the attack tree
        $.ajax({
            url: "/OTRisk/generate_sim_attack_tree_v2/", // Ensure the URL is correctly mapped in your Django urls.py
            type: 'POST',
            headers: {
                "X-CSRFToken": getCsrfToken() // Include CSRF token from cookies
            },
            data: {
                'scenario': scenarioDetails.scenarioText, // Assuming this is the correct key for your backend
                'threat_actor': scenarioDetails.threat_actor,
                'attack_vector': scenarioDetails.attack_vector,
                'compliance': scenarioDetails.regulatory_environment,
                'facility_type': scenarioDetails.facility_type,
                'industry': scenarioDetails.industry,
                'targeted_system': scenarioDetails.target,
                'attack_effect': scenarioDetails.effect,
                'impact': scenarioDetails.impact,
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val() // Correct way to include CSRF token
            },
            success: function(attackTreeResponse) {

                updateProgressBar(45, 'Attack tree generation completed... Preparing for consequence analysis.');

                if (attackTreeResponse && !attackTreeResponse.error) {
                    var attackTreeJson = JSON.stringify(attackTreeResponse);
                    document.getElementById('hdnAT').value = attackTreeJson;
                    drawAttackTree(attackTreeResponse);
                    document.getElementById('analyzeAttackTreeCheckbox').checked = true;
                } else {
                    console.error('Attack tree data not available or invalid response:', attackTreeResponse.error || "Unknown error");
                }

                resolve(attackTreeResponse); // Proceed to the next promise in the chain
            },
            error: function(xhr, status, error) {
                console.error('Error while fetching attack tree:', error);
                reject(error); // Propagate the error to be handled by the catch block
            }
        });
    });
}

function analyzeConsequences(scenarioDetails) {
    return new Promise((resolve, reject) => {

        // AJAX request to analyze the consequences
        $.ajax({
            url: "/OTRisk/analyze_sim_consequences_v2/", // Ensure the URL matches your Django urls.py
            type: 'POST',
            headers: {
                "X-CSRFToken": getCsrfToken() // Include CSRF token from cookies
            },
            data: {
                'scenario': scenarioDetails.scenarioText,
                'industry': scenarioDetails.industry,
                'facility_type': scenarioDetails.facility_type,
                'organization_size': scenarioDetails.organization_size,
                'regulatory_environment': scenarioDetails.regulatory_environment,
                'country': scenarioDetails.country,
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val() // Correct way to include CSRF token
            },
            success: function(consequenceResponse) {

                updateProgressBar(15, 'Consequence analysis completed...');

                // Update the UI based on the response
                if (consequenceResponse && consequenceResponse.consequence && consequenceResponse.consequence.trim()) {
                    document.getElementById('txtConsequences').value = consequenceResponse.consequence;
                } else {
                    document.getElementById('txtConsequences').value = 'No consequence analysis available.';
                }
                document.getElementById('analyzeConsequencesCheckbox').checked = true;
                // Populate cost estimates
                document.getElementById('txtBestCase').value = consequenceResponse.best_case_cost || 'N/A';
                document.getElementById('txtMostLikelyCase').value = consequenceResponse.most_likely_case_cost || 'N/A';
                document.getElementById('txtWorstCase').value = consequenceResponse.worst_case_cost || 'N/A';

                // Handle 12-month cost projection if available
                if (consequenceResponse.projection) {
                    document.getElementById('scenario_12month_costs').value = consequenceResponse.projection;
                    var costArray = consequenceResponse.projection.split('|').map(Number);
                    createCostChart('monthly_cost_chart', costArray);
                }
                document.getElementById('analyzeCostsCheckbox').checked = true;
                resolve(consequenceResponse); // Resolve the promise with the consequence analysis response
            },
            error: function(xhr, status, error) {
                console.error('Error fetching consequence analysis:', error);
                reject(error); // Reject the promise on error
            }
        });
    });
}

function relatedIncidents(scenarioDetails) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: "/OTRisk/related_incidents/",  // Adjust the URL as needed
            type: "POST",
            headers: {
                "X-CSRFToken": getCsrfToken()  // Ensure CSRF token is included
            },
            data: {
                scenario: scenarioDetails.scenarioText,  // Send scenario text for analysis
                // Include any additional data as needed
            },
            success: function(response) {

                updateProgressBar(60, 'Research incidents completed. Finalizing...');
                if (response.generated_summary && response.generated_summary !== 'No related incidents found.') {
                    // Clear previous contents
                    $('#related_incidents').empty();
                    document.getElementById('analyzeIncidentsCheckbox').checked = true;
                    document.getElementById('hdnIncidents').value = response.generated_summary;

                    // Create a table and append it to the 'related_incidents' container
                    var table = $('<table class="table table-striped white-text"><thead><tr><th>Title</th><th>Description</th><th>Date</th><th>URL</th></tr></thead><tbody></tbody></table>');
                    $('#related_incidents').append(table);

                    // Splitting the generated_summary by lines to get individual incidents
                    var incidents = response.generated_summary.split('\n');
                    incidents.forEach(function(incident) {
                        // Splitting each incident into components
                        var parts = incident.split('|');
                        if(parts.length === 4) { // Ensure we have all required parts
                            var row = $('<tr></tr>');
                            parts.forEach(function(part, index) {
                                if(index === 3) { // URL part
                                    var cell = $('<td class="white-text"></td>').html('<a href="' + part + '" target="_blank">Link</a>');
                                } else {
                                    var cell = $('<td class="white-text"></td>').text(part);
                                }
                                row.append(cell);
                            });
                            table.append(row);
                        }
                    });
                } else {
                    document.getElementById('related_incidents').innerHTML = 'No related incidents found.';
                }
                resolve(response);
            },
            error: function(xhr, status, error) {
                $('#related_incidents').text('An error occurred while fetching related incidents.');
                reject(error);
            }
        });
    });
}


function updateUIWithResults(data) {

    document.getElementById('spinnerContainer').style.display = 'none';
    // Update the consequences table
    var tableContainer = document.getElementById('table_scenario');
    var biaGroupsContainer = document.getElementById('bia_groups');
    var investmentImpactInput = document.getElementById('txthdninvestmentstring');

    if (!tableContainer || !biaGroupsContainer || !investmentImpactInput) {
        // If any of the elements are not found, silently return without updating the UI or logging errors
        return;
    }

    clearTable(tableContainer); // Clear existing table if present
    createConsequencesTable(tableContainer, data.consequence);
    biaGroupsContainer.innerHTML = '';


    data.consequence.forEach(function(consequence, index) {
        // Assuming you have a function to create and append each consequence group
        appendConsequenceGroup(biaGroupsContainer, consequence, index);
    });

    // Handle investment impact data
    if (data.investment_impact && data.investment_impact.trim() !== '') {
        // Directly display the investment impact data without encoding/decoding
        document.getElementById('txthdninvestmentstring').value = btoa(data.investment_impact);

        renderInvestmentImpact(data.investment_impact); // Directly pass the raw data
    } else {
        document.getElementById('spinnerContainer').style.display = 'none';
        // Handle the case where investment impact data is not available
    }

}

function appendConsequenceGroup(container, consequence, index) {

    // Ensure the container exists
    if (!container) {
        console.error('Container not found');
        return;
    }

    // Extract numeric score from the string (e.g., "8/10" -> 8)
    const scoreValue = parseInt(consequence.score.split('/')[0], 10);

    // Create a new row for every 3 items or if there are no rows yet
    let row;
    if (index % 3 === 0 || container.children.length === 0) {
        row = document.createElement('div');
        row.className = 'row';
        container.appendChild(row);
    } else {
        // Use the last row if it exists
        row = container.lastElementChild;
    }

    // Create the group container
    var groupContainer = document.createElement('div');
    groupContainer.className = 'group-container col-md-4';

    // Create the group header
    var groupHeader = document.createElement('div');
    groupHeader.className = 'group-header';
    var icon = document.createElement('img');

    // Set icon source based on scoreValue
    if (scoreValue > 7) {
        icon.src = "{% static 'images/redcube.png' %}";
    } else if (scoreValue > 4) {
        icon.src = "{% static 'images/yellow_cube.png' %}";
    } else {
        icon.src = "{% static 'images/green_cube.png' %}";
    }

    icon.className = 'cube-icon';
    icon.alt = 'cube_icon'; // Adjust the alt text as needed

    groupHeader.appendChild(icon);
    var headerText = document.createTextNode(consequence.factor);

    groupHeader.appendChild(headerText);
    groupContainer.appendChild(groupHeader);

    // Create the group body
    var groupBody = document.createElement('div');
    groupBody.className = 'group-body';
    groupBody.textContent = `${consequence.score} - ${consequence.narrative}`;
    groupContainer.appendChild(groupBody);

    // Append the group container to the row
    row.appendChild(groupContainer);
}

function clearTable(tableContainer) {
    while (tableContainer.firstChild) {
        tableContainer.removeChild(tableContainer.firstChild);
    }
}

function createConsequencesTable(tableContainer, consequences) {
    // Ensure the tableContainer is correctly identified
    if (!tableContainer) {

        return;
    }

    var table = document.createElement('table');
    table.id = 'consequencesTable';
    table.className = 'display dataTable';
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    ['Factor', 'Score', 'Narrative'].forEach(function(header) {
        var th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');
    consequences.forEach(function(consequence) {
        var row = document.createElement('tr');
        Object.keys(consequence).forEach(function(key) {
            var cell = document.createElement('td');
            cell.textContent = consequence[key];
            row.appendChild(cell);
        });
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    tableContainer.appendChild(table);

    // Re-initialize DataTables on the new table, if necessary
    $(table).DataTable({
        searching: false,
        paging: false,
        info: false
    });
}

$(document).ready(function() {
document.addEventListener('DOMContentLoaded', (event) => {
    var btn = document.getElementById('myBtn');
    if (btn) {
        btn.onclick = function() {
            var modal = document.getElementById('scenarioBuilderModal');
            if (modal) {
                modal.style.display = "block";
            } else {
                console.error("Modal element not found");
            }
        };
    } else {
        console.error("Button element not found");
    }
});
});

function saveScenario(scenarioName) {
    var scenarioData = {
    name: scenarioName,
    scenario: document.getElementById('txtScenario').value,
    attackTree: document.getElementById('hdnAT').value,
    consequences: document.getElementById('txtConsequences').value,
    tableData: extractTableData(), // Add this line
    bestCaseCost: document.getElementById('txtBestCase').value,
    mostLikelyCaseCost: document.getElementById('txtMostLikelyCase').value,
    worstCaseCost: document.getElementById('txtWorstCase').value,
    cost_projection: document.getElementById('scenario_12month_costs').value,
    investment_projection: document.getElementById('txthdninvestmentstring').value,
    industry: document.getElementById('selIndustry').value,
    facility: document.getElementById('selFacilityType').value,
    country: document.getElementById('countrySelector').value,
    org: document.getElementById('selOrganizationSize').value,
    regs: document.getElementById('selRegulatoryEnvironment').value,
    attacker: document.getElementById('selThreats').value,
    vector: document.getElementById('selVectors').value,
    target: document.getElementById('targetComponent').value,
    effect: document.getElementById('attackEffect').value,
    network: document.getElementById('targetSystem').value,
    impact: document.getElementById('impact').value,
    motivation: document.getElementById('motivation').value,
    incidents: document.getElementById('hdnIncidents').value,
    };

    $.ajax({
    url: "{% url 'OTRisk:save_scenario_builder' %}",
    type: 'POST',
    data: scenarioData,
    headers: {
        'X-CSRFToken': getCsrfToken()  // Include CSRF token
    },
    success: function(response) {
         Swal.fire({
                    title: "Scenario saved successfully",
                    imageUrl: '/static/images/anzen_owl.png', // Make sure the path is correct
                    imageWidth: 150, // Adjust as necessary
                    imageHeight: 150, // Adjust as necessary
                    background: '#000', // Black background
                    color: '#fff', // Set text color to white
                    customClass: {
                        popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                    }
                }
         )
    },
    error: function(xhr, status, error) {
        console.error('Error saving scenario:', error);
    }
    });
}

function extractTableData() {
    var tableData = [];
    $('#consequencesTable tbody tr').each(function() {
        var row = $(this).find('td').map(function() {
            return $(this).text();
        }).get();
        if (row.length > 0) {
            tableData.push({
                factor: row[0],
                score: row[1],
                narrative: row[2]
            });
        }
    });
    return tableData;
}

function getCsrfToken() {
    var name = 'csrftoken';
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

$(document).ready(function() {
    // Close button inside the modal header
    $('.close').click(function() {
        $('#scenarioSelectionModal').modal('hide');
    });

    // Close button in the modal footer
    $('#scenarioSelectionModal .btn-secondary').click(function() {
        $('#scenarioSelectionModal').modal('hide');
    });
});

$(document).ready(function() {
    $('a[data-tab]').click(function(e) {
        e.preventDefault(); // Prevent the default anchor behavior

        var selectedTab = $(this).attr('data-tab'); // Get the data-tab attribute of the clicked link

        $('.tab-content').hide(); // Hide all tab content
        $('#' + selectedTab).show(); // Show the selected tab content

        $('a[data-tab]').removeClass('active'); // Remove 'active' class from all tab links
        $(this).addClass('active'); // Add 'active' class to the clicked tab link
    });

    // Optionally, trigger click on the first tab to show it by default
    $('a[data-tab]').first().trigger('click');
});

</script>
</div>
</body>
</html>
