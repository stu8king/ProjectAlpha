<div id="vulnerabilityTableContainer">
<h4 align="center">Vulnerabilities</h4>
    <table class="table">
        <!-- Table header -->
        <thead>
            <tr>
                <th style="width: 13%">Title</th>
                <th style="width: 13%">Asset Name</th>
                <th style="width: 13%">Asset Type</th>
                <th style="width: 11%">CVE</th>
                <th style="width: 40%">CVE Detail</th>
                <th style="width: 10%">Action</th>
            </tr>
        </thead>
        <!-- Table body -->
        <tbody>
            {% for vulnerability in vulnerabilities %}
            <tr>
                <td>{{ vulnerability.description }}</td>
                <td>{{ vulnerability.asset_name }}</td>
                <td>{{ vulnerability.asset_type }}</td>
                <td>{{ vulnerability.cve }}</td>
                <td>{{ vulnerability.cve_detail }}</td>
                <td> <input type="hidden" name="vulnerability_id" value="{{ vulnerability.id }}">
                    <a href="#" class="edit-row">Edit</a>
                    <a href="#" class="delete-row">Delete</a>
                </td>
            </tr>
            {% endfor %}

        </tbody>
    </table>
</div>

<button id="add-row" class="btn btn-primary" type="button">Add Row</button>
<!-- Include Select2 library -->

<script>
$(document).ready(function () {
    // Initialize Select2 for existing elements
    $('.asset-type-field').select2({
        width: '100%', // Set the width to 100% for the dropdown
        dropdownAutoWidth: true, // Adjusts the dropdown width to match the content
        // Add any additional options you need for Select2 here
    });

    $('#add-row').on('click', function () {
        // Add a new row when the "Add Row" button is clicked
        var newRow = '<tr class="unsaved-row">' +
            '<td><textarea name="new_description" class="form-control description-field" style="resize: none"></textarea></td>' +
            '<td><textarea name="new_asset_name" class="form-control asset-name-field" style="resize: none"></textarea></td>' +
            '<td>' +
            '<select name="new_asset_type" class="select2 asset-type-field">' +
            '{% for asset_type in asset_types %}' +
            '<option value="{{ asset_type.id }}" data-id="{{ asset_type.id }}">{{ asset_type.AssetType }}</option>' +
            '{% endfor %}' +
            '</select>' +
            '</td>' +
            '<td><textarea name="new_cve" class="form-control cve-field" style="resize: none;" maxlength="13">CVE-</textarea>' +
            '<button type="button" class="btn btn-info fetch-cve">Fetch CVE Details</button>' +  // Button to fetch CVE details
            '</td>' +
            '<td><textarea name="cve_details" class="form-control cve-details-field" style="resize: none" readonly></textarea></td>' +  // Readonly textarea for CVE details
            '<td>' +
            '<a href="#" class="save-row" data-action="save">Save</a>' +
            '<a href="#" class="cancel-row">Cancel</a>' +
            '</td>' +
            '</tr>';
        $('#vulnerabilityTableContainer tbody').append(newRow);

        // Initialize Select2 for the new row's asset_type dropdown
        $('#vulnerabilityTableContainer tbody tr:last .asset-type-field').select2({
            width: '100%', // Set the width to 100% for the dropdown
            dropdownAutoWidth: true, // Adjusts the dropdown width to match the content
            // Add any additional options you need for Select2 here
        });
    });

    // Handle saving the new row
    $('#vulnerabilityTableContainer').on('click', '.save-row', function () {
        var newRow = $(this).closest('tr');
        var description = newRow.find('[name="new_description"]').val();
        var assetName = newRow.find('[name="new_asset_name"]').val();
        // var assetType = newRow.find('[name="new_asset_type"]').val();
        var cve = newRow.find('[name="new_cve"]').val();
        var cve_detail = newRow.find('[name="cve_details"]').val();
        var scenarioId = $('#hdnScenario').val();


        var savedAssetTypeSelect = newRow.find('[name="new_asset_type"]');
        var assetType = savedAssetTypeSelect.find('option:selected').val();

        $.ajax({
            type: 'POST',
            url: '/OTRisk/add_vulnerability/' + scenarioId + '/', // Replace with your URL for adding a new record
            data: {
                description: description,
                asset_name: assetName,
                asset_type: assetType,
                cve: cve,
                cve_detail: cve_detail,
                scenario_id: scenarioId,
                action: 'save'
            },
            success: function () {
                newRow.find('td:eq(0)').text(description);
                newRow.find('td:eq(1)').text(assetName);
                newRow.find('td:eq(2)').text(assetType);
                newRow.find('td:eq(3)').text(cve);
                newRow.find('td:eq(4)').text(cve_detail);
                newRow.find('td:eq(5)').html('<a href="#" class="edit-row">Edit</a> <a href="#" class="delete-row">Delete</a>');
            },
        });
    });


    $('#vulnerabilityTableContainer').on('click', '.fetch-cve', function() {
        var currentRow = $(this).closest('tr');
        var cve = currentRow.find('[name="new_cve"]').val();  // Getting the value of the CVE input field

        // Make sure the CVE field isn't empty
        if (!cve.trim()) {
            alert("Please enter a CVE number.");
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/OTRisk/get_cve_details/',  // URL of your Django view that handles CVE fetching
            data: {
                cve_number: cve,  // Send the CVE number to your Django view
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()  // Don't forget CSRF token if needed
            },
            success: function(data) {
                // Check if there was an error or if data was returned successfully
                if (data.error) {
                    alert(data.error);
                } else {
                    // If successful, set the data in the cve_details textarea
                    var cveDetails = "Description: " + data.description + "\nPublished Date: " + data.published_date + "\nLast Modified Date: " + data.last_modified_date;
                    currentRow.find('[name="cve_details"]').val(cveDetails);
                }
            },
            error: function() {
                alert('Error fetching data. Please try again.');
            }
        });
    });


    // Handle editing rows (implement edit logic)// Handle editing rows (implement edit logic)
$('#vulnerabilityTableContainer').on('click', '.edit-row', function () {
    event.preventDefault();
    var row = $(this).closest('tr');
    var vulnerabilityId = row.find('input[name="vulnerability_id"]').val();
    var description = row.find('td:eq(0)').text();
    var assetName = row.find('td:eq(1)').text();
    var assetType = row.find('td:eq(2)').text();
    var cve = row.find('td:eq(3)').text();
    var cve_detail = row.find('td:eq(4)').text();


    // Replace the row's content with input fields for editing
    row.html('<td><textarea name="edited_description" class="form-control description-field" style="resize: none">' + description + '</textarea></td>' +
             '<td><textarea name="edited_asset_name" class="form-control asset-name-field" style="resize: none">' + assetName + '</textarea></td>' +
             '<td><select name="edited_asset_type" class="select2 asset-type-field"></select></td>' +
             '<td><textarea name="edited_cve" class="form-control cve-field" style="resize: none">' + cve + '</textarea>' +
            '<button type="button" name="edit_cve" class="btn btn-info fetch-cve" style="resize: none">Fetch CVE Details</button></td>' +  // Button to fetch CVE details
            '<td><textarea name="edited_cve_detail" class="form-control cve_detail-field" style="resize: none">' + cve_detail + '</textarea></td>' +
             '<td>' +
             '<a href="#" class="update-row">Update</a> <a href="#" class="cancel-edit">Cancel</a>' +
             '</td>');

    // Initialize Select2 for the asset_type dropdown in edit mode
    var assetTypeSelect = row.find('select[name="edited_asset_type"]');
    assetTypeSelect.append('<option value="' + assetType + '">' + assetType + '</option>');
    assetTypeSelect.val(assetType).trigger('change');

    assetTypeSelect.select2({
        width: '100%',
        dropdownAutoWidth: true,
        // Add any additional options you need for Select2 here
    });

    // Populate the asset_type dropdown with options from the database
    // You can use an AJAX call to fetch data from the server and populate the dropdown
    // Example:
    $.ajax({
        url: '/OTRisk/get_asset_types/', // Replace with your URL for fetching asset types
        success: function (data) {
            $.each(data.asset_types, function (index, assetTypeData) {
                var option = new Option(assetTypeData.AssetType, assetTypeData.id);
                assetTypeSelect.append(option);
            });

            // Set the selected option based on the original asset type
            assetTypeSelect.val(assetType).trigger('change');

        }
    });

    // Handle canceling the edit operation
    row.on('click', '.cancel-edit', function () {
        // Restore the row's original content
        row.html('<td>' + description + '</td>' +
                 '<td>' + assetName + '</td>' +
                 '<td>' + assetType + '</td>' +
                 '<td>' + cve + '</td>' +
                '<td>' + cve_detail + '</td>' +
                 '<td><a href="#" class="edit-row">Edit</a> <a href="#" class="delete-row">Delete</a></td>');
    });

    // Handle updating the row
    row.on('click', '.update-row', function () {
        event.preventDefault();
        var editedDescription = row.find('[name="edited_description"]').val();
        var editedAssetName = row.find('[name="edited_asset_name"]').val();
        var editedAssetTypeText = row.find('[name="edited_asset_type"] option:selected').text(); // Get the text value
        var editedCVE = row.find('[name="edited_cve"]').val();
        var editedCVE_detail = row.find('[name="edited_cve_detail"]').val();
        let scenarioId = $('#hdnScenario').val();
        var editedAssetTypeSelect = row.find('[name="edited_asset_type"]');
        var editedAssetTypeId = editedAssetTypeSelect.find('option:selected').val();

        // Implement logic to send updated data to the server and update the record
        // You can use an AJAX request to send data to the server and update the database
        $.ajax({
            type: 'POST',
            url: '/OTRisk/add_vulnerability/' + scenarioId + '/', // Replace with your URL for updating a record
            data: {
                vulnerability_id: vulnerabilityId,
                description: editedDescription,
                asset_name: editedAssetName,
                asset_type: editedAssetTypeId,
                cve: editedCVE,
                cve_detail: editedCVE_detail,
                action: 'edit'
            },
            success: function () {
                // Update the row's content with the edited data
                row.html('<td>' + editedDescription + '</td>' +
                         '<td>' + editedAssetName + '</td>' +
                         '<td>' + assetTypeSelect.find('option:selected').text() + '</td>' + // Display the selected option text
                         '<td>' + editedCVE + '</td>' +
                        '<td>' + editedCVE_detail + '</td>' +
                         '<td><a href="#" class="edit-row">Edit</a> <a href="#" class="delete-row">Delete</a></td>');
            },
        });
    });
});


    // Handle deleting rows (implement delete logic)
    $('#vulnerabilityTableContainer').on('click', '.delete-row', function () {
        // Implement delete logic here
        $(this).closest('tr').remove();
    });

    // Handle canceling the edit operation
    $('#vulnerabilityTableContainer').on('click', '.cancel-edit', function () {
        var row = $(this).closest('tr');

        // Implement logic to fetch the original data from the database
        var originalDescription = ''; // Fetch the original description from the database
        var originalAssetType = ''; // Fetch the original asset type from the database

        // Set the row's content based on the original data
        row.html(
            '<td>' + originalDescription + '</td>' +
            '<td>' + originalAssetType + '</td>' +
            '<td><a href="#" class="edit-row">Edit</a> <a href="#" class="delete-row">Delete</a></td>'
        );
    });
});

function clearVulnerabilityTable() {
    // Find the table body and remove all rows except the first one (header row)
    $('#vulnerabilityTableContainer tbody tr').remove();
}
</script>
