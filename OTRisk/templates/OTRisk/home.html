{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>CyberPHA Manager</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
     {% load bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link href="{% static 'css/otriskstyle.css' %}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.11.3/datatables.min.css"/>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>


    <title>Cybersecurity Business</title>
    <style>

    .navbar-scroll .nav-link,
    .navbar-scroll .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #262626;
    }

    /* Color of the navbar BEFORE scroll */
    .navbar-scroll {
      background-color: #FFC017;
    }

    /* Color of the links AFTER scroll */
    .navbar-scrolled .nav-link,
    .navbar-scrolled .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #262626;
    }
        .highlight-row:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }


        /* Corporate, Professional, User-friendly Table Style */
table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid #ddd;
  font-size: 14px;
}

table th,
table td {
  padding: 8px;
  text-align: left;
}

table th {
  background-color: #f5f5f5;
}

table tr:nth-child(even) {
  background-color: #f9f9f9;
}

table tr:hover {
  background-color: #f5f5f5;
  cursor: pointer;
}

table th:hover {
  background-color: #f5f5f5;
  cursor: pointer;
}

/* DataTables Styling */
.dataTables_wrapper .dataTables_paginate .paginate_button {
  color: #333 !important;
  font-weight: 500;
  border: 1px solid #ddd;
  padding: 6px 10px;
  margin: 0 2px;
  background-color: #fff;
  transition: background-color 0.3s ease;
  display: inline-block;
}

.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
  background-color: #f5f5f5;
  cursor: pointer;
}


.dataTables_wrapper .dataTables_paginate .paginate_button.current {
  background-color: #e9ecef;
  border-color: #ddd;
  color: #333 !important;
  font-weight: 500;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover {
  background-color: #fff;
}

.dataTables_wrapper .dataTables_paginate .pagination {
  display: flex;
  justify-content: center;
}

.dataTables_wrapper .dataTables_paginate .pagination .paginate_button {
  margin: 0 2px;
}

.dataTables_wrapper .dataTables_paginate .pagination .paginate_button:first-child {
  margin-left: 0;
}

.dataTables_wrapper .dataTables_paginate .pagination .paginate_button:last-child {
  margin-right: 0;
}

.dataTables_wrapper .dataTables_filter input[type="search"] {
  padding: 4px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.dataTables_wrapper .dataTables_filter input[type="search"]:focus {
  outline: none;
  box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
}

        /* Pie Chart Styling */
#risk-score-chart {
  max-width: 400px;
  width: 100%;
  height: auto;
  margin: auto;
}
#safety-score-chart {
  max-width: 400px;
  width: 100%;
  height: auto;
  margin: auto;
}
#data-score-chart {
  max-width: 400px;
  width: 100%;
  height: auto;
  margin: auto;
}
.item3 {
  text-align: center;
  padding: 20px;
}
.chart-container {
  position: relative;
  height: 400px;
  flex: 1;
  max-width: calc(33.333% - 10px); /* Adjust this value as needed */
  box-sizing: border-box;
    background-color: #484848;
}

.scrollable-table {
    max-height: 400px;
    overflow-y: auto;
    display: block;
}
    .small-font {
        font-size: 0.8rem; /* adjust as needed */
        }
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-scroll fixed-top shadow-0 border-bottom border-dark">
  <div class="container-fluid">
      <a class="navbar-brand" href="#"><h3><p class="text-monospace">iOTa</p></h3></a>
    <button class="navbar-toggler" type="button" data-mdb-toggle="collapse"
      data-mdb-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
      aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <!-- <a class="nav-link" href="{% url 'OTRisk:risk_assessment' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a> -->
            <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> CyberPHA
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="{% url 'OTRisk:cyber_pha_manager' %}"> CyberPHA Manager</a></li>
                <li><a class="dropdown-item" href="{% url 'OTRisk:walkdown' %}"> Site Walkdown</a></li>
                <li><a class="dropdown-item" href="#">Workshop</a></li>
              </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:site_walkdown' %}"><i class="bi bi-building"></i> Site Walkdown</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:walkdown' %}" tabindex="-1" ><i class="bi bi-kanban"></i> New Walkdown</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Reports</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" tabindex="-1" ><i class="bi bi-ui-checks-grid"></i> Admin</a>
      </li>
        <li class="nav-item">
          <a class="nav-link" href="#"><i class="bi bi-person-fill"></i> User: {{ user.first_name }}</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<div class="row">
    <br><br><br><br>
</div>


<!--NCSC UK table -->

<div class="row">
    <div class="col-md-4">
        <h6>National Cyber Security Center (UK)</h6>
            <div class="table-responsive scrollable-table">
                <table id="ncsc-table" class="table table-hover table-bordered overflow-auto small-font
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Link</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in ncsc_items %}
                        <tr>
                            <td>{{ item.title }}</td>
                            <td><a href="{{ item.link }}" target="_blank">Link</a></td>
                            <td>{{ item.description|safe }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    </div>
    <div class="col-md-4">
        <!--threatpost table -->
        <h6>Threatpost Articles</h6>
        <div class="table-responsive scrollable-table">
            <table id="threatpost-table" class="table table-hover table-bordered overflow-auto small-font" >
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Link</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in threatpost_items %}
                    <tr>
                        <td>{{ item.title }}</td>
                        <td><a href="{{ item.link }}" target="_blank">Link</a></td>
                        <td>{{ item.description|safe }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
<div class="col-md-4">
        <div class="table-responsive scrollable-table">
        <!-- cisa table -->
            <table id="data-table" class="table table-hover table-bordered overflow-auto small-font">
                <thead>
                       <tr>
                        <th>Title</th>
                        <th>Link</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.title }}</td>
                        <td><a href="{{ item.link }}" target="_blank">Link</a></td>
                        <td>{{ item.description|safe }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="row">

    <div class="col-md-6">
        <div class="table-responsive scrollable-table">
<!-- cisa table -->
            <table id="data-table" class="table table-hover table-bordered overflow-auto">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Date</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody>
                    {% for iss_item in iss_items %}
                    <tr>
                        <td>{{ iss_items.title }}</td>
                        <td>{{ iss_items.incidentdate }}</td>
                        <td>{{ iss_items.link|safe }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>






<div class="container">

    <div class="item2">
        <table id="worksheet-table" class="table table-striped">
            <thead>
            <tr>
                <th>RA Worksheet ID</th>
                <th>Status</th>
                <th>Assessment Date</th>
                <th>Trigger</th>
                <th>Business Unit</th>
                <th>Threat Score</th>
                <th>Risk Score</th>
                <th>Vuln Score</th>
                <th>Reputation Impact</th>
                <th>Operational Impact</th>
                <th>Financial Impact</th>
                <th>Safety Impact</th>
                <th>Data Impact</th>
                <th>Supply Chain Impact</th>
            </tr>
            </thead>
            <tbody>
            {% for worksheet in worksheet_data %}
            <tr class="highlight-row" data-id="{{ worksheet.id }}">
                <td>{{ worksheet.id }}</td>
                <td>{{ worksheet.status_flag }}</td>
                <td>{{ worksheet.ra_date }}</td>
                <td>{{ worksheet.ra_trigger }}</td>
                <td>{{ worksheet.business_unit }}</td>
                <td>{{ worksheet.avg_threat_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_risk_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_vuln_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_reputation_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_operation_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_financial_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_safety_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_data_score|default_if_none:"0"|floatformat:0 }}</td>
                <td>{{ worksheet.avg_supply_chain_score|default_if_none:"0"|floatformat:0 }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<br><br><br><br>

<div style="display: flex;justify-content: space-between; grid-column: 2 / span 2;">

    <div class="chart-container">
    <canvas id="risk-score-chart"></canvas>
    </div>

    <div class="chart-container" >
    <canvas id="safety-score-chart"></canvas>
    </div>

   <div class="chart-container" >
   <canvas id="data-score-chart"></canvas>
   </div>

</div>
<div class="item5">

</div>

<script>
  var riskScores = {
    low: 0,
    lowMedium: 0,
    medium: 0,
    mediumHigh: 0,
    high: 0
  };
  var safetyScores = {
    low: 0,
    lowMedium: 0,
    medium: 0,
    mediumHigh: 0,
    high: 0
  };
  var dataScores = {
    low: 0,
    lowMedium: 0,
    medium: 0,
    mediumHigh: 0,
    high: 0
  };

  {% for worksheet in worksheet_data %}
  var riskScore = {{ worksheet.avg_risk_score|default_if_none:"0" }};
  var safetyscore = {{ worksheet.avg_safety_score|default_if_none:"0" }};
  var dataScore = {{ worksheet.avg_data_score|default_if_none:"0" }};

      if (riskScore < 20) {
        riskScores.low += 1;
      } else if (riskScore >= 20 && riskScore < 40) {
        riskScores.lowMedium += 1;
      } else if (riskScore >= 40 && riskScore < 60) {
        riskScores.medium += 1;
      } else if (riskScore >= 60 && riskScore < 80) {
        riskScores.mediumHigh += 1;
      } else {
        riskScores.high += 1;
      }


      if (safetyscore < 20) {
        safetyScores.low += 1;
      } else if (safetyscore >= 20 && safetyscore < 40) {
        safetyScores.lowMedium += 1;
      } else if (safetyscore >= 40 && safetyscore < 60) {
        safetyScores.medium += 1;
      } else if (safetyscore >= 60 && safetyscore < 80) {
        safetyScores.mediumHigh += 1;
      } else {
        safetyScores.high += 1;
      }

        if (dataScore < 20) {
        dataScores.low += 1;
      } else if (dataScore >= 20 && dataScore < 40) {
        dataScores.lowMedium += 1;
      } else if (dataScore >= 40 && dataScore < 60) {
        dataScores.medium += 1;
      } else if (dataScore >= 60 && dataScore < 80) {
        dataScores.mediumHigh += 1;
      } else {
        dataScores.high += 1;
      }

  {% endfor %}

    var ctx = document.getElementById('risk-score-chart').getContext('2d');

    var riskScoreChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Low Risk', 'Low/Medium Risk', 'Medium Risk', 'Medium/High Risk', 'High Risk'],
        datasets: [{
          data: [riskScores.low, riskScores.lowMedium, riskScores.medium, riskScores.mediumHigh, riskScores.high],
          backgroundColor: ['#6AB187', '#B3C100', '#DBAE58', '#EA6A47', '#AC3E31']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right',
            align: 'middle'
          },
            title: {
              display: true,
                text: 'Overall Risk Status',
                color: 'white',
                fontsize: 16
            },
          tooltip: {
            enabled: true
          },
          datalabels: {
              color: '#fff',
              font: {
                  size: 14,
                  weight: 'bold',
                  anchor: 'end'
              }
          },
           formatter: function (value, context) {
              var dataset = context.chart.data.datasets[0];
              var total = dataset.data.reduce(function (previousValue, currentValue) {
                return previousValue + currentValue;
              });
              var percentage = Math.round((value / total) * 100);
              return value + ' (' + percentage + '%)';
            },

        },

    onClick: function (event, elements) {
      var segment = riskScoreChart.getElementAtEvent(event)[0];
      if (segment) {
        // Handle segment selection here
      }
    }
  }
});
var ctx2 = document.getElementById('safety-score-chart').getContext('2d');
var safetyScoreChart = new Chart(ctx2, {
      type: 'pie',
      data: {
        labels: ['Low Impact', 'Low Medium Impact', 'Medium Impact', 'Medium/High Impact', 'High Impact'],
        datasets: [{
          data: [safetyScores.low, safetyScores.lowMedium, safetyScores.medium, safetyScores.mediumHigh, safetyScores.high],
          backgroundColor: ['#6AB187', '#B3C100', '#DBAE58', '#EA6A47', '#AC3E31']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right',
            align: 'middle'
          },
            title: {
              display: true,
                text: 'Safety Impact',
                color: 'white',
                fontsize: 16
            },
          tooltip: {
            enabled: false
          },
          datalabels: {
        formatter: function (value, context) {
          var dataset = context.chart.data.datasets[0];
          var total = dataset.data.reduce(function (previousValue, currentValue) {
            return previousValue + currentValue;
          });
          var percentage = Math.round((value / total) * 100);
          return value + ' (' + percentage + '%)';
        },
        color: '#fff',
        font: {
          size: 14,
          weight: 'bold'
        }
      }
    },

    onClick: function (event, elements) {
      var segment = safetyScoreChart.getElementAtEvent(event)[0];
      if (segment) {
        // Handle segment selection here
      }
    }
  }
});

var ctx3 = document.getElementById('data-score-chart').getContext('2d');
var dataScoreChart = new Chart(ctx3, {
      type: 'pie',
      data: {
        labels: ['Low Impact', 'Low Medium Impact', 'Medium Impact', 'Medium/High Impact', 'High Impact'],
        datasets: [{
          data: [dataScores.low, dataScores.lowMedium, dataScores.medium, dataScores.mediumHigh, dataScores.high],
          backgroundColor: ['#6AB187', '#B3C100', '#DBAE58', '#EA6A47', '#AC3E31']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right',
            align: 'middle'
          },
            title: {
              display: true,
                text: 'Data Impact',
                color: 'white',
                fontsize: 16
            },
          tooltip: {
            enabled: false
          },
          datalabels: {
        formatter: function (value, context) {
          var dataset = context.chart.data.datasets[0];
          var total = dataset.data.reduce(function (previousValue, currentValue) {
            return previousValue + currentValue;
          });
          var percentage = Math.round((value / total) * 100);
          return value + ' (' + percentage + '%)';
        },
        color: '#fff',
        font: {
          size: 14,
          weight: 'bold'
        }
      }
    },

    onClick: function (event, elements) {
      var segment = dataScoreChart.getElementAtEvent(event)[0];
      if (segment) {
        // Handle segment selection here
      }
    }
  }
});

</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/v/bs4/dt-1.11.3/datatables.min.js"></script>
<script>
    $(document).ready(function () {
        $('#worksheet-table').DataTable();
    });
</script>

</body>
</html>


