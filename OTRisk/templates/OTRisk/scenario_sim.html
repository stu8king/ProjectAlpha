{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/anzen_owl.png' %}" type="image/x-icon">
<!-- FontAwesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<!-- Bootstrap CSS -->
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

<!-- jQuery (Full version, required for Bootstrap and jQuery UI) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- Popper.js (Required for Bootstrap) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- SweetAlert -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<!-- D3.js -->
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<!-- AnyChart -->
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-linear-gauge.min.js"></script>

<!-- Custom JS -->
<script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">

{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

<style>
    #checklistContainer {
    color: white; /* White text color */
}

/* Style for the text next to checkboxes */
#checklistContainer div {
    font-size: 0.8em; /* Smaller font size */
}
    .custom-checkbox {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 1em;
    height: 1em;
    border: 1px solid #000; /* Black border */
    border-radius: 0.15em;
    outline: none;
    cursor: pointer;
    position: relative;
}

.custom-checkbox:checked {
    background-color: #000; /* Black background when checked */
}

.custom-checkbox:checked:after {
    content: '';
    position: absolute;
    top: 0.15em;
    left: 0.45em;
    width: 0.2em;
    height: 0.6em;
    border: solid white;
    border-width: 0 0.15em 0.15em 0;
    transform: rotate(45deg);
}
/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0,0.4);
  padding-top: 60px;
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}


    .form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}


     body {
        background-color: #464748;
        color: #d3d1cd;
    }
    .sidebar {
        height: 100vh;
        background-color: #2D2E30; /* Darker shade for sidebar */
        padding: 20px 0;
        width: 200px; /* Reduced width */
    }
    .sidebar-logo {
        padding: 10px 15px;
        text-align: center;
    }
    .nav-sidebar {
        display: flex;
        flex-direction: column;
        padding-left: 0;
        list-style: none;
    }
    .nav-sidebar .nav-item {
        padding: 5px 10px;
        /* border-bottom: 1px solid  #fac330; /* Light orange line */
        margin: 0 10%;
    }
    .nav-sidebar .nav-link {
        color: #d3d1cd;
        border-radius: 0;
        transition: color 0.3s ease-in-out;
        font-size: 0.8em;
    }
    .nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
        background-color: #3A5F5F;
        color: #E0E0E0;
    }
    /* Enhance dropdown menu */
    .dropdown-menu {
        background-color: #d3d1cd;
        border: none;
    }
    .dropdown-item:hover, .dropdown-item:focus {
        background-color: #fac330; /* Light orange background for hovered dropdown items */
        color: #2D2E30;
    }
    .content {
        padding: 20px;
    }
.custom-main-content {
    position: relative; /* Needed for absolute positioning of tabs */
    margin-left: 10px; /* Adjust to account for both sidebars */
    width: calc(100% - 350px); /* Adjust based on the total width of the sidebars */
    min-height: 100vh; /* Ensure it fills the viewport height */
}


@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: calc(100% - 200px);
        max-width: calc(90vw - 200px);
        margin-left: 100px;
    }
}
.form-sim .form-control {
    max-width: 100%; /* Ensures select does not exceed container width */
    width: auto; /* Optional: Ensures select width is based on content up to max-width */
}
.group-container {
    background: linear-gradient(to bottom right, #464748, #57595b); /* Gradient background */
    border: 1px solid #666; /* Darker border */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); /* Box shadow */
    padding: 25px;
    margin-bottom: 30px; /* Increased space between containers */
    border-radius: 10px; /* Rounded corners */
}

.group-header {
    color: #d3d1cd; /* Lighter color for contrast */
    font-weight: bold;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #777; /* Subtle bottom border */
    font-size: 1.2em; /* Larger font size */
}

.group-body {
    color: #e0e0e0; /* Slightly lighter text color */
    font-family: 'Arial', sans-serif; /* Modern font */
}
.cube-icon {
    width: 20px; /* Adjust size as needed */
    height: 20px; /* Adjust size as needed */
    margin-right: 10px;
}
#scenarioSelectionModal .modal-body .list-group {
    max-height: 400px; /* Adjust this value based on your needs */
    overflow-y: auto; /* Enables vertical scrolling */
}
@media (max-width: 768px) {
  .modal-lg {
    max-width: 90%; /* Adjust based on preference */
  }
}

.investment-box {
    fill: #eee; /* Light background for the boxes */
    stroke: #666; /* Dark border for the boxes */
}

.investment-text {
    fill: #000; /* Black text color */
    font-size: 12px; /* Adjust as needed */
}

svg {
    display: block;
    margin: 0 auto; /* Center the SVG in its container */
    overflow: visible;
}

path.connection {
    stroke: #333;
    stroke-width: 2;
    fill: none;
}

#investmentImpactVisualization {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
}


/* Adjustments may be needed based on the exact layout and spacing */
.custom-main-content .container {
    width: 100%; /* Ensure the container fills the custom-main-content */
    max-width: none; /* Override Bootstrap's max-width for containers if necessary */
}
.top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 100px; /* Align with the end of the sidebar */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}

.page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.5rem; /* Adjust size as needed */
}

@media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
     .sub-menu {
        left: 0;
        width: 100px; /* Adjust for smaller screens */
    }

.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
    width: 80%; /* 80% of the available width to the right */
    height: 80vh; /* 80% of the viewport height */
    position: absolute; /* Positioning relative to its nearest positioned ancestor */
    left: 350px; /* This should be directly to the right of the sub-menu */
    top: 0; /* Align with the top of the viewport */
    overflow: auto; /* Add scroll for overflow content */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

.tab-content.active {
    display: block; /* Only the active tab is displayed */
}



    .custom-main-content {
        margin-left: 100px; /* Adjust based on the sub-menu width on smaller screens */
    }
}
/* Sub-menu styles */
.sub-menu {
    position: fixed; /* Fixed position to stay in view */
    top: 0; /* Align with the top of the viewport */
    left: 200px; /* Adjust based on the width of the main sidebar */
    width: 150px; /* Width of the sub-menu */
    height: 100vh; /* Full viewport height */
    background-color: #333; /* Sub-menu background color */
    color: #fff; /* Text color */
    padding: 20px 10px; /* Padding */
    box-sizing: border-box; /* Include padding in width calculation */
}

.sub-menu ul {
    list-style: none; /* Remove default list styling */
    padding: 0; /* Remove default padding */
    margin: 0; /* Remove default margin */
}

.sub-menu li a {
    color: #d3d1cd; /* Link color */
    text-decoration: none; /* Remove underline */
    display: block; /* Make the links fill the container */
    padding: 10px 0; /* Padding for touch targets */
    transition: background-color 0.3s; /* Smooth transition for hover effect */
}

.sub-menu li a:hover, .sub-menu li a.active {
    background-color: #57595b; /* Hover/active background color */
}
.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
}

.tab-content.active {
    display: block; /* Only the active tab is displayed */
}
.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
    width: 80%; /* 80% of the available width */
    height: 80vh; /* 80% of the viewport height */
    position: absolute; /* Positioning relative to its nearest positioned ancestor */
    left: 350px; /* Adjust based on the total width of the main sidebar and sub-menu */
    top: 0; /* Align with the top of the viewport */
    overflow: auto; /* Add scroll for overflow content */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}


</style>
</head>
<body style="background-color: #464748">
<script>

anychart.licenseKey("{{ anychart_key }}");



fetch('https://restcountries.com/v3.1/all')
    .then(response => response.json())
    .then(data => {
        // Sort the countries alphabetically
        data.sort((a, b) => a.name.common.localeCompare(b.name.common));

        // Add a blank option as the default
        $('#countrySelector').append(new Option('', ''));

        // Populate the dropdown
        data.forEach(country => {
            const countryName = country.name.common;
            $('#countrySelector').append(new Option(countryName, countryName));
        });
    })
    .then(() => {
        $('#countrySelector').select2({
            placeholder: "Select a country", // This will display the placeholder text
            allowClear: true // This allows users to clear the selected value
        });
    })
    .catch(error => {
        console.error("There was an error fetching the country list:", error);
    });

document.addEventListener("DOMContentLoaded", function() {
    const links = document.querySelectorAll('.sub-menu a');
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab) currentTab.classList.remove('active');
            const newTab = document.getElementById(this.getAttribute('data-tab'));
            newTab.classList.add('active');

            // Update active state for links
            document.querySelector('.sub-menu a.active')?.classList.remove('active');
            this.classList.add('active');
        });
    });
});
</script>
<div class="container-fluid">

    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebarMenu">
                <div class="sidebar-sticky">
                    <div class="sidebar-logo">
                        <img src="{% static 'images/anzen_owl.png' %}" class="img-fluid" alt="Logo">
                    </div>
                    <ul class="nav flex-column nav-sidebar">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'OTRisk:dashboardhome' %}">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'OTRisk:qraw' %}">QRAW</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}">CyberPHA</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:scenario_sim' %}">Scenario Builder</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:ra_actions_view_default' %}">Actions</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:risk_register' %}">Risk Register</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:list_frameworks' %}">Assessments</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Admin
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">

                                <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:setup_org' %}">Set Defaults</a>
                                </li>
                            <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:cybersecurity_defaults_view' %}">Cyber Insurance</a>

                                </li>

                                {% if user.is_staff %}
                                <!-- Links visible only to superusers -->
                                <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:admin_users' %}">Admin Users</a>
                                </li>
                                <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:upload_questionnaire' %}">Upload Questionnaires</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:user_admin' %}">User Administration</a>
                                </li>
                                <li>
                                    <a class="dropdown-item"  style="font-size: 12px;" href="{% url 'OTRisk:organization_form' %}">Manage Organizations</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a>
                                </li>
                                {% endif %}
                            </ul>
                         </li>
                    <li class="nav-item menu-item">
                        <a class="nav-link" href="{% url 'accounts:profile' %}">
                        <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
                        </a>
                        </li>
                        <li class="nav-item menu-item">
                        <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="nav-link" style="background:none; border:none; padding:0; margin:0; color:inherit;">Logout</button>
                    </form>

                        </li>
                        </ul>
                </div>
            </nav>
        <!-- Main content area, including sub-menu and tabs -->
        <div class="col-md-9 col-lg-10">
            <!-- Top Strip -->
            <div class="top-strip">
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3">
                    <h1 class="page-title">Scenario Builder@AnzenOT (Beta)</h1>
                    </div>
                    <div class="col-md-1">
                        <button id="newScenarioBtn" class="btn nav-link">New Scenario</button>
                        <script>
                            document.getElementById('newScenarioBtn').addEventListener('click', function() {
                                swal({
                                    title: "Are you sure?",
                                    text: "Any unsaved changed data will be lost. Proceed?",
                                    icon: "warning",
                                    buttons: true,
                                    dangerMode: true,
                                    buttons: ["Cancel", "Yes"]
                                })
                                .then((willDelete) => {
                                    if (willDelete) {
                                        // User pressed "Yes", clear the content
                                        document.getElementById('txtScenario').value = ''; // Clear Scenario tab content
                                        document.getElementById('txtConsequences').value = ''; // Clear Consequences tab content
                                        document.getElementById('txtBestCase').value = ''; // Clear Event Costs tab content
                                        document.getElementById('txtMostLikelyCase').value = '';
                                        document.getElementById('txtWorstCase').value = '';
                                        // Add more lines as needed for other inputs you wish to clear

                                        swal("The data has been cleared!", {
                                            icon: "success",
                                        });
                                    } else {
                                        // User pressed "Cancel", do nothing
                                        swal("Your data is safe!");
                                    }
                                });
                            });
                            </script>


                    </div>
                    <div class="col-md-1">
                    <button type="button" class="btn nav-link" onclick="fetchAndDisplayScenarios()">Load Scenario</button>
                    </div>
                    <div class="col-md-1">
                        <button id="analyzeScenarioBtn" class="btn nav-link" type="button">Execute Analysis>></button>
                        <div id="spinnerContainer" style="display: none;">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                       <button id="saveScenarioBtn" class="btn nav-link">Save Scenario</button>
                        <script>
                            document.getElementById('saveScenarioBtn').addEventListener('click', function() {
                            var scenarioName = prompt("Please enter a name for this scenario:");
                            if (scenarioName) {
                                saveScenario(scenarioName);
                            }
                        });

                        </script>

                    </div>
                    <div class="col-md-4"></div>
                </div>
            </div>
        <div class="sub-menu">
            <br><br><br><br><br><br><br><br><br><br>
        <ul>
            <li><a href="#" data-tab="tab1">Instructions</a></li>
            <li><a href="#" data-tab="tab2">Parameters</a></li>
            <li><a href="#" data-tab="tab3">Tools & Software</a></li>
            <li><a href="#" data-tab="tab4" id="scenarioTabLink">Scenario</a></li>

            <li><a href="#" data-tab="tab5">Consequences</a></li>
            <li><a href="#" data-tab="tab6">Event Costs</a></li>
            <li><a href="#" data-tab="tab7">Business Impact</a></li>
            <li><a href="#" data-tab="tab8">Tools/Software Analysis</a></li>
            <li><a href="#" data-tab="tab9">Attack Tree</a></li>
        </ul>
    </div>


    <div class="custom-main-content" >

    <div id="checklistContainer">
        <div>
            <input type="checkbox" id="analyzeConsequencesCheckbox" class="custom-checkbox" disabled> Analyze Consequences
        </div>
        <div>
            <input type="checkbox" id="generateAttackTreeCheckbox" class="custom-checkbox" disabled> Generate Attack Tree
        </div>
        <div>
            <input type="checkbox" id="analyzeScenarioCheckbox" class="custom-checkbox" disabled> Business Impact Analysis
        </div>
    </div>

    <div class="tab-content active" id="tab1">
        <h2>Instructions</h2>
        <div class="form-group">
            <label id="instructions">

                <p>
                <h5>1. Parameters.</h5> Input and select parameters relevant to the scenario. The industry sector, type of facility, and country are mandatory fields.
                </p>
                <p>
                <h5>2. Tools and Software.</h5> Enter information about OT security tools and software that have been purchased or are planned.
                </p>
                <p>
                <h5>3. Scenario.</h5> Changing any of the parameters in step 1 will automatically update the text in the scenario box. You can use the generated text or edit and update the scenario text with more relevant information. The more specific and detailed the scenario text, the better the results.
                </p>
                <p>When the scenario text is complete, click the "Execute Analysis" link in the top menu to activate the scenario builder.</p>
                <p>
                <h5>4. Consequences.</h5> After the scenario builder has completed execution, the assumed immediate consequences of the scenario will be listed in the tab.
                </p>
                <p>
                <h5>New Scenario.</h5> Clicking this link clears any scenario information currently displayed on the screen. A warning message will be displayed stating that "Any unsaved data will be lost". Click Cancel to stop to operation. Click Yes to continue and clear the current scenario data.
                </p>
                <p>
                <h5>Load Scenario.</h5> Click this link to load previously saved scenarios.
                </p>
                <p>
                <h5>Execute Analysis.</h5> Click this link to run the Scenario Builder AI and generate the analysis objects.
                </p>
                <p>
                <h5>Save Scenario.</h5> Click this link to store the existing scenario and the associated objects that are generated with it.
                </p>
            </label>
        </div>
    </div>

    <div class="tab-content " id="tab2">
        <h2>Scenario Parameters</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group form-sim" >
                    <label>Enter parameters for the scenario</label>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="selIndustry" style="color:black"><img src="{% static 'images/icon_industry.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;" > Industry</label>
                                <select class="form-control" name="selIndustry" id="selIndustry" style="color:black">
                                    <option value=""> -- Select Industry -- </option>
                                    {% for industry in industries %}
                                    <option value="{{ industry.Industry }}"
                                            {% if current_pha_header.Industry == industry.Industry %}selected{% endif %}>
                                        {{ industry.Industry }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="selFacilityType" style="color:black"><img src="{% static 'images/function.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Facility Type</label>
                                <select class="form-control" name="selFacilityType" id="selFacilityType">
                                    <option value=""> -- Select Facility Type -- </option>
                                    {% for facilities in facilities %}
                                        <option value="{{ facilities.FacilityType }}"
                                        {% if current_pha_header.FacilityType == facilities.FacilityType %}selected{% endif %}>
                                        {{  facilities.FacilityType }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="countrySelector" style="color:black"><img src="{% static 'images/icon_world.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Country</label>
                                <select class="form-control" id="countrySelector" name="countrySelector" ></select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                            <div class="card-body">
                                <label for="selOrganizationSize" style="color:black"><img src="{% static 'images/icon_group.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Organization Size</label>
                                <select class="form-control" id="selOrganizationSize" name="selOrganizationSize">
                                    <option value=""> -- Select Organization Size -- </option>
                                    <option value="Small, 50-200 employees">Small, 50-200 employees</option>
                                    <option value="Medium-sized, 200-1000 employees">Medium-sized, 200-1000 employees</option>
                                    <option value="Large, over 1000 employees">Large, over 1000 employees</option>
                                    <option value="Multinational corporation">Multinational corporation</option>
                                </select>
                            </div>
                        </div>
                        <div class="card mb-2 shadow-sm">
                                <div class="card-body">
                                    <label for="selRegulatoryEnvironment" style="color:black"><img src="{% static 'images/icon_regulation.png' %}" alt="" class="align-bottom" style="max-height: 1.5rem; margin-left: 5px;"> Regulatory Environment</label>
                                    <select class="form-control" id="selRegulatoryEnvironment" name="selRegulatoryEnvironment">
                                        <option value=""> -- Select Regulatory Environment -- </option>
                                        <option value="Strict Regulation">Strict Regulation</option>
                                        <option value="Moderate Regulation">Moderate Regulation</option>
                                        <option value="Minimal Regulation">Minimal Regulation</option>
                                        <option value="International Standards Compliance">International Standards Compliance</option>
                                        <option value="Self-Regulated">Self-Regulated</option>
                                    </select>
                                </div>
                            </div>
                    </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                <form id="scenarioForm">

                    <label for="selThreats" style="color: white">Attacker/Bad Actor:</label>
                    <select class="form-control" name="selThreats" id="selThreats" >
                        <option value=""> -- Select Attacker -- </option>
                        {% for threats in threats %}
                        <option value="{{ threats.ThreatSource }}">

                            {{ threats.ThreatSource }}
                        </option>
                        {% endfor %}
                    </select>

                    <label for="selVectors" style="color: white">Attack Vector:</label>
                    <select class="form-control" name="selVectors" id="selVectors" >
                        <option value=""> -- Select Attack Vector -- </option>
                        {% for attack_vectors in attack_vectors %}
                        <option value="{{ attack_vectors.ThreatAction }}">

                            {{ attack_vectors.ThreatAction }}
                        </option>
                        {% endfor %}
                    </select>

            <label for="targetComponent" style="color: white">Target Component/Device:</label>
            <input type="text" class="form-control" id="targetComponent" name="targetComponent" >

            <label for="attackEffect">Effect of Attack:</label>
            <input type="text" class="form-control" id="attackEffect" name="attackEffect">

            <label for="targetSystem">Target System/Network:</label>
            <input type="text" class="form-control" id="targetSystem" name="targetSystem">

            <label for="impact">Potential Impact:</label>
            <input type="text" class="form-control" id="impact" name="impact">

            <label for="motivation">Attack Motivation:</label>
            <input type="text" class="form-control" id="motivation" name="motivation">

        </form>
            </div>
            </div>

        </div>
    </div>

    <!-- Tab 2 Content -->
    <div class="tab-content" id="tab3">
        <h2>Tools & Software</h2>
        <div class="form-group">
            <label style="color:white">List purchases that have been, or are planned to be, made for OT Cybersecurity risk mitigation</label>
            <div class="table-responsive">

          <table class="table" id="investmentTable">
            <colgroup>
                  <col span="1" style="width: 10%;"> <!-- Type -->
                  <col span="1" style="width: 25%;"> <!-- Vendor Name -->
                  <col span="1" style="width: 25%;"> <!-- Product Name -->
                  <col span="1" style="width: 15%;"> <!-- Cost -->
                  <col span="1" style="width: 15%;"> <!-- Date -->
                  <col span="1" style="width: 10%;"> <!-- Action -->
                </colgroup>
            <thead>
              <tr>
                <th>Type</th>
                <th>Vendor Name</th>
                <th>Product Name</th>
                <th>Cost</th>
                <th>Date</th> <!-- New Date Column -->
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr>

                <td><select name="investment_type[]" class="form-control">
                    <option value="Software">Software</option>
                    <option value="Appliance">Appliance</option>
                    </select>
                </td>

                <td><input type="text" name="vendor_name[]" class="form-control" /></td>
                <td><input type="text" name="product_name[]" class="form-control" /></td>
                <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
                <td><input type="date" name="date[]" class="form-control" /></td> <!-- New Date Input -->
                <td><button class="btn btn-danger removeRow">Remove</button></td>
              </tr>
            </tbody>

          </table>
          <button type="button" class="btn btn-primary" id="addRow">Add Row</button>

          </div>
        </div>
    </div>

    <!-- Tab 3 Content -->
    <div class="tab-content" id="tab4">
        <h2>Scenario</h2>
        <div class="card-body">
            <div id="spinner" class="spinner-border" role="status" style="display: none;">
            <span class="sr-only">Loading...</span>
            </div>
            <div class="form-group">
            <label for="txtScenario">Review and edit the scenario text then click "Execute Analysis"</label>
            <textarea id="txtScenario" class='form-control' rows=11 placeholder='Enter a detailed cybersecurity scenario or click the button above to use the scenario builder...' style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; background-color: white"></textarea>
            </div>
                <script>

                // Ensure DOM is fully loaded before executing the script
                document.addEventListener('DOMContentLoaded', function() {
                var txtScenarioElement = document.getElementById('id_txtScenario');
                if (txtScenarioElement) {
                    txtScenarioElement.addEventListener('input', function() {
                        provideSuggestions(this.value);
                    });
                }

                function provideSuggestions(inputText) {
                    var lowerCaseInputText = inputText.toLowerCase(); // Convert input text to lower case
                    var suggestionsDiv = document.getElementById('suggestions');
                    suggestionsDiv.innerHTML = ""; // Clear current suggestions

                    // Function to add suggestion messages
                    function addSuggestion(message) {
                        suggestionsDiv.innerHTML += "<p>" + message + "</p>";
                    }

                    // Check for various keywords and add suggestions
                    if (lowerCaseInputText.includes("malware")) {
                        addSuggestion("Consider describing the type of malware and its impact on the device.");
                    }
                    if (lowerCaseInputText.includes("plc")) {
                        addSuggestion("Include the vendor and name of the PLC if known.");
                    }
                    if (lowerCaseInputText.includes("erp")) {
                        addSuggestion("Include the name and version of the ERP system.");
                    }
                    if (lowerCaseInputText.includes("scada")) {
                        addSuggestion("Include the name and version of the SCADA system if known.");
                    }
                    if (lowerCaseInputText.includes("temperature")) {
                        addSuggestion("Include relevant temperature ranges or tolerances.");
                    }
                    if (lowerCaseInputText.includes("pressure")) {
                        addSuggestion("Include relevant pressure tolerances and ranges.");
                    }
                    if (lowerCaseInputText.includes("software")) {
                        addSuggestion("Include name and version of software if known.");
                    }
                    if (lowerCaseInputText.includes("windows")) {
                        addSuggestion("Include the version of Windows.");
                    }
                    if (lowerCaseInputText.includes("unix")) {
                        addSuggestion("Include the version of Unix.");
                    }
                    if (lowerCaseInputText.includes("sensor")) {
                        addSuggestion("Include the type of sensor and the parameters that it monitors.");
                    }
                    if (lowerCaseInputText.includes("protocol")) {
                        addSuggestion("Include information aboput the protocol used and the endpoints that are connected.");
                    }
                }


                });

    </script>
                </div>


    </div>

    <!-- Tab 4 Content -->
    <div class="tab-content" id="tab5">
        <h2>Consequences</h2>
        <div class="form-group">
        <div class="card mb-2 shadow-sm">
                <div class="card-body">
                    <label for="txtConsequences" class="d-flex align-items-center clickable-label"  ><img src="{% static 'images/scenario.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Consequences</label>
                    <textarea id="txtConsequences" class='form-control' rows=11 placeholder='' style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; background-color: white"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab6">
        <h2>Event Costs</h2>
        <div class="form-group">
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                    <label for="txtBestCase">Best Case $</label>
                    <input type="text" id="txtBestCase" class="form-control" style="border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; ">
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <label for="txtMostLikelyCase">Most Likely Case $$</label>
                    <input type="text" id="txtMostLikelyCase" class="form-control" style="border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; ">
                </div>
            </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <label for="txtWorstCase">Worst Case $$$</label>
                    <input type="text" id="txtWorstCase" class="form-control" style="border: 3px #97979A; border-radius: 10px; box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5); padding: 20px; ">
                </div>
            </div>
            </div>
        </div>
            </div>
         <div class="group-container">
                <div class="group-header">
                     Twelve-Month Projection
                </div>
                <div class="group-body">
                    <div id="monthly_cost_chart" style="height:300px"></div>
                    <input type="hidden" id="scenario_12month_costs" name="scenario_12month_costs">
                </div>
            </div>
    </div>
    <!-- Tab 5 Content -->
    <div class="tab-content" id="tab7">
        <h2>Business Impact</h2>
        <div class="form-group">
        <span id="bia_groups"></span>
        </div>
    </div>

    <!-- Tab 6 Content -->
    <div class="tab-content" id="tab8">
        <h2>Tools & Software Analysis</h2>
        <div class="form-group">
            <div id="investmentImpactVisualization"></div>
        </div>
    </div>

    <div class="tab-content" id="tab9">
        <h2>Attack Tree</h2>
        <div class="form-group">
            <div id="attack_tree" style="width:100%"></div>
        </div>
    </div>
</div>
</div>





<script>
    $(document).ready(function() {
        // Initialize Select2 for all dropdowns
        $('#selIndustry').select2();
        // $('#selAssetValue').select2();
        $('#selFacilityType').select2();
        $('#selOrganizationSize').select2();
        // $('#selOperationalImpact').select2();
        // $('#selSecurityMeasures').select2();
        $('#selRegulatoryEnvironment').select2();
        // Add more initialization if needed
    });
</script>


<input type="hidden" id="hdnAT" name="hdnAT">

<div class="row" style="visibility: hidden">
    <div class="col-md-1"></div>

    <div class="col-md-10">
        <div class="form-group">
        <span id="table_scenario"></span>
            </div>
    </div>
    <div class="col-md-1"></div>
</div>
<!-- Modal -->
<div class="modal fade" id="scenarioBuilderModal" tabindex="-1" role="dialog" aria-labelledby="scenarioBuilderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scenarioBuilderModalLabel">OT Cybersecurity Scenario Builder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

      </div>
      <div class="modal-body">
        <form id="scenarioForm">
          <div class="form-group">
            <label for="selThreats" style="color: white">Attacker/Bad Actor:</label>
            <select class="form-control" name="selThreats" id="selThreats" >
                <option value=""> -- Select Attacker -- </option>
                {% for threats in threats %}
                <option value="{{ threats.ThreatSource }}">

                    {{ threats.ThreatSource }}
                </option>
                {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="selVectors" style="color: white">Attack Vector:</label>
            <select class="form-control" name="selVectors" id="selVectors" >
                <option value=""> -- Select Attack Vector -- </option>
                {% for attack_vectors in attack_vectors %}
                <option value="{{ attack_vectors.ThreatAction }}">

                    {{ attack_vectors.ThreatAction }}
                </option>
                {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="targetComponent" style="color: white">Target Component/Device:</label>
            <input type="text" class="form-control" id="targetComponent" name="targetComponent" >
          </div>
          <div class="form-group">
            <label for="attackEffect">Effect of Attack:</label>
            <input type="text" class="form-control" id="attackEffect" name="attackEffect">
          </div>
          <div class="form-group">
            <label for="targetSystem">Target System/Network:</label>
            <input type="text" class="form-control" id="targetSystem" name="targetSystem">
          </div>
          <div class="form-group">
            <label for="impact">Potential Impact:</label>
            <input type="text" class="form-control" id="impact" name="impact">
          </div>
          <div class="form-group">
            <label for="motivation">Attack Motivation:</label>
            <input type="text" class="form-control" id="motivation" name="motivation">
          </div>

        </form>
      </div>
      <div class="modal-footer">


      </div>
    </div>
  </div>
</div>

<!-- Scenario Selection Modal -->
<div class="modal fade" id="scenarioSelectionModal" tabindex="-1" role="dialog" aria-labelledby="scenarioSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scenarioSelectionModalLabel">Select Scenario</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Search scenario..." aria-label="Search scenario">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
          </div>
        </div>
        <ul id="scenarioList" class="list-group">
          <!-- Dynamically populated list items will go here -->
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Open</button>
      </div>
    </div>
  </div>
</div>

    </div>
<input type="hidden" id="txthdninvestmentstring" name="txthdninvestmentstring">

 <script>
    function renderInvestmentImpact(investmentImpactText) {
        $('#tab8').addClass('active').show();
    var bulletPoints = investmentImpactText.split('\n').filter(bp => bp.trim().length > 0);

    // Clear previous content
    $("#investmentImpactVisualization").empty();

    // Create a container for the visualization
    var container = d3.select("#investmentImpactVisualization")
        .style("display", "flex")
        .style("justify-content", "space-evenly")
        .style("align-items", "flex-start") // Align items at the start to manage varying heights
        .style("flex-wrap", "wrap") // Allow boxes to wrap in the container
        .style("padding", "20px")
        .style("gap", "20px") // Space between boxes
        .style("background-color", "#f0f0f0");

    bulletPoints.forEach(function(bp, index) {
        var box = container.append("div")
            .style("border", "2px solid #007BFF") // A vibrant, color-blind friendly border color
            .style("border-radius", "10px")
            .style("padding", "20px")
            .style("margin-bottom", "20px") // Margin at the bottom for spacing
            .style("background-color", "#ffffff") // White background for contrast
            .style("box-shadow", "0 8px 16px rgba(0,0,0,0.15)") // Deeper shadow for a sleek look
            .style("display", "flex")
            .style("flex-direction", "column")
            .style("justify-content", "space-between") // Distribute space evenly inside the box
            .style("align-items", "center")
            .style("text-align", "center") // Center align the text
            .attr("class", "investment-box") // Add a class for further manipulation
            .style("min-width", "240px") // Minimum width for each box
            .style("max-width", "300px") // Maximum width to ensure consistency
            .append("p")
            .text(bp)
            .style("margin-top", "10px") // Margin at the top inside the box
            .style("margin-bottom", "10px") // Margin at the bottom inside the box
            .style("font-size", "16px") // Enhanced font size for readability
            .style("color", "#333333") // Darker text color for better contrast
            .style("word-wrap", "break-word"); // Ensure text wraps within the box
    });

    // After all boxes are created, adjust their height to match the tallest box
    var maxHeight = d3.max(container.selectAll(".investment-box").nodes(), function(box) {
        return box.getBoundingClientRect().height;
    });

    // Set the container height to accommodate the tallest box with some padding
    container.selectAll(".investment-box").style("height", maxHeight + "px");
    document.querySelector('a[data-tab="tab4"]').click();
}



function analyzeScenario(scenarioText, industry, facility_type, investments) {

    return new Promise(function(resolve, reject) {
        $.ajax({
            url: "{% url 'OTRisk:analyze_sim_scenario' %}",
            type: 'POST',
            data: {
                'scenario': scenarioText,
                'industry': industry,
                'facility_type': facility_type,
                'investments': JSON.stringify(investments),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                document.getElementById('analyzeScenarioCheckbox').checked = true;
                console.log("Scenario analysis initiated. Polling for results...");
                resolve(response);
            },
            error: function(xhr, status, error) {
                console.error('Error analyzing scenario:', error);
                reject(error);
            }
        });
    });
}
function generateAttackTree(scenarioText) {
    return new Promise(function(resolve, reject) {
    $.ajax({
            url: "{% url 'OTRisk:generate_sim_attack_tree' %}",
            type: 'POST',
            data: {
                'scenario': scenarioText,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(attackTreeResponse) {
                document.getElementById('generateAttackTreeCheckbox').checked = true;
                if (attackTreeResponse && !attackTreeResponse.error) {
                    var attackTreeJson = JSON.stringify(attackTreeResponse);
                    document.getElementById('hdnAT').value = attackTreeJson;
                    drawAttackTree(attackTreeResponse);
                    resolve(attackTreeResponse);
                } else {
                    console.error('Attack tree data not available or invalid response');
                    reject('Attack tree data not available or invalid response');
                }

            },
            error: function(xhr, status, error) {
                console.error('Error fetching attack tree:', error);
                reject(error);
            }
        });
    });
}

function analyzeConsequences(scenarioText, industry, facility_type, organization_size, regulatory_environment, country) {
return new Promise(function(resolve, reject) {
    $.ajax({
            url: "{% url 'OTRisk:analyze_sim_consequences' %}",
            type: 'POST',
            data: {
                'scenario': scenarioText,
                'industry': industry,
                'facility_type': facility_type,
                'organization_size': organization_size,
                'regulatory_environment': regulatory_environment,
                'country': country,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(consequenceResponse) {
                document.getElementById('analyzeConsequencesCheckbox').checked = true;
                if (consequenceResponse.consequence && consequenceResponse.consequence.trim()) {
                    document.getElementById('txtConsequences').value = consequenceResponse.consequence;
                    resolve(consequenceResponse);
                } else {
                    document.getElementById('txtConsequences').value = 'No consequence analysis available.';
                    reject('No consequence analysis available.');
                }

                document.getElementById('txtBestCase').value = consequenceResponse.best_case_cost;
                document.getElementById('txtMostLikelyCase').value = consequenceResponse.most_likely_case_cost;
                document.getElementById('txtWorstCase').value = consequenceResponse.worst_case_cost;
                document.getElementById('scenario_12month_costs').value = consequenceResponse.projection;

                var costArray = consequenceResponse.projection.split('|').map(Number);
                createCostChart('monthly_cost_chart', costArray);

            },
            error: function(xhr, status, error) {
                spinnerContainer.style.display = 'none';
                button.disabled = false;
                console.error('Error fetching consequence analysis:', error);
                reject(error);
            }
        });
});
}

var pollingInterval;

document.getElementById('analyzeScenarioBtn').addEventListener('click', function() {
    // Disable submenu links and change their color to a lighter shade
    $('.sub-menu a').css({
        'pointer-events': 'none',
        'color': '#000000' // Example of a lighter color (light gray)
    }).addClass('disabled-link');

    var scenarioText = document.getElementById('txtScenario').value;
    let facility_type = document.getElementById('selFacilityType').value;
    let industry = document.getElementById('selIndustry').value;
    let organization_size = document.getElementById('selOrganizationSize').value;
    let regulatory_environment = document.getElementById('selRegulatoryEnvironment').value;
    let country = document.getElementById('countrySelector').value;
    let investments = [];
    $('#investmentTable tbody tr').each(function() {
        let investment = {
            type: $(this).find('select[name="investment_type[]"]').val(),
            vendor_name: $(this).find('input[name="vendor_name[]"]').val(),
            product_name: $(this).find('input[name="product_name[]"]').val(),
            cost: $(this).find('input[name="cost[]"]').val(),
            date: $(this).find('input[name="date[]"]').val()
        };
        investments.push(investment);
    });
    var button = this;
    var spinnerContainer = document.getElementById('spinnerContainer');
    button.disabled = true;
    spinnerContainer.style.display = 'block'; // Show the spinner

    $.ajax({
        url: "/OTRisk/cleanup_scenariobuilder/", // Update this URL to your cleanup endpoint
        type: "GET", // or "POST" if you're sending data
        beforeSend: function(xhr) {
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}"); // Add CSRF token header if needed
        },
        success: function(response) {

            //var analyzeScenarioPromise = analyzeScenario(scenarioText, industry, facility_type, investments);
            var generateAttackTreePromise = generateAttackTree(scenarioText);
            var analyzeConsequencesPromise = analyzeConsequences(scenarioText, industry, facility_type, organization_size, regulatory_environment, country);
            Promise.all([ generateAttackTreePromise, analyzeConsequencesPromise])
                .then(function() {
                    spinnerContainer.style.display = 'none'; // Hide the spinner
                    button.disabled = false;

                })
                .catch(function(error) {
                    console.error('An error occurred:', error);
                    spinnerContainer.style.display = 'none'; // Hide the spinner
                    button.disabled = false;
                });
                if (window.pollingInterval) clearInterval(window.pollingInterval);

                    // Start the analysis scenario
                    $.ajax({
                        url: "{% url 'OTRisk:analyze_sim_scenario' %}",
                        type: 'POST',
                        data: {
                            'scenario': scenarioText,
                            'industry': industry,
                            'facility_type': facility_type,
                            'investments': JSON.stringify(investments),
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            document.getElementById('analyzeScenarioCheckbox').checked = true;

                            // Polling function
                            function pollForResults() {
                                $.ajax({
                                    url: '/OTRisk/get_analysis_result/', // Update this URL to your result checking endpoint
                                    type: "GET",
                                    xhrFields: {
                                        withCredentials: true
                                    },
                                    success: function(response) {
                                        if (response.status === 'success') {
                                            clearInterval(window.pollingInterval); // Stop polling

                                            updateUIWithResults(response.data); // Update your UI with the results
                                            // Re-enable submenu links and restore their original color here
                                            $('.sub-menu a').css({
                                                'pointer-events': '',
                                                'color': '' // Assuming you want to revert to the stylesheet-defined color
                                            }).removeClass('disabled-link');

                                        } else {
                                            spinnerContainer.style.display = 'block';
                                        }
                                    },
                                    error: function(xhr, status, error) {

                                        clearInterval(window.pollingInterval); // Consider stopping or retrying polling
                                    }
                                });
                            }

                            // Start polling for results every 5 seconds
                            window.pollingInterval = setInterval(pollForResults, 5000);
                        },
                        error: function(xhr, status, error) {
                            spinnerContainer.style.display = 'none';
                            button.disabled = false;
                            alert('Error: ' + error);
                        }
                    });
                },
                error: function(xhr, status, error) {
            // Handle error from cleanup_scenariobuilder
            console.error('Cleanup error:', error);
            spinnerContainer.style.display = 'none';
            button.disabled = false;
        }
    });
});




function appendConsequenceGroup(container, consequence, index) {
    // Ensure the container exists
    if (!container) {
        console.error('Container not found');
        return;
    }

    // Create a new row for every 3 items or if there are no rows yet
    let row;
    if (index % 3 === 0 || container.children.length === 0) {
        row = document.createElement('div');
        row.className = 'row';
        container.appendChild(row);
    } else {
        // Use the last row if it exists
        row = container.lastElementChild;
    }

    // Create the group container
    var groupContainer = document.createElement('div');
    groupContainer.className = 'group-container col-md-4';

    // Create the group header
    var groupHeader = document.createElement('div');
    groupHeader.className = 'group-header';
    var icon = document.createElement('img');
    // Ensure the path to the image is correct
    icon.src = "/static/images/green_cube.png"; // Adjust the path as needed
    icon.className = 'cube-icon';
    icon.alt = 'green_cube';
    groupHeader.appendChild(icon);
    var headerText = document.createTextNode(consequence.factor);
    groupHeader.appendChild(headerText);
    groupContainer.appendChild(groupHeader);

    // Create the group body
    var groupBody = document.createElement('div');
    groupBody.className = 'group-body';
    groupBody.textContent = `${consequence.score} - ${consequence.narrative}`;
    groupContainer.appendChild(groupBody);

    // Append the group container to the row
    row.appendChild(groupContainer);
}

function updateUIWithResults(data) {
    document.getElementById('spinnerContainer').style.display = 'none';
    // Update the consequences table
    var tableContainer = document.getElementById('table_scenario');
    var biaGroupsContainer = document.getElementById('bia_groups');
    var investmentImpactInput = document.getElementById('txthdninvestmentstring');

    if (!tableContainer || !biaGroupsContainer || !investmentImpactInput) {
        // If any of the elements are not found, silently return without updating the UI or logging errors
        return;
    }

    clearTable(tableContainer); // Clear existing table if present
    createConsequencesTable(tableContainer, data.consequences);
    biaGroupsContainer.innerHTML = '';


    data.consequences.forEach(function(consequence, index) {
        // Assuming you have a function to create and append each consequence group
        appendConsequenceGroup(biaGroupsContainer, consequence, index);
    });

    // Handle investment impact data
    if (data.investment_impact && data.investment_impact.trim() !== '') {
        // Directly display the investment impact data without encoding/decoding
        document.getElementById('txthdninvestmentstring').value = btoa(data.investment_impact);

        renderInvestmentImpact(data.investment_impact); // Directly pass the raw data
    } else {
        document.getElementById('spinnerContainer').style.display = 'none';
        // Handle the case where investment impact data is not available
    }

}

function clearTable(tableContainer) {
    while (tableContainer.firstChild) {
        tableContainer.removeChild(tableContainer.firstChild);
    }
}

function createConsequencesTable(tableContainer, consequences) {
    // Ensure the tableContainer is correctly identified
    if (!tableContainer) {

        return;
    }

    var table = document.createElement('table');
    table.id = 'consequencesTable';
    table.className = 'display dataTable';
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    ['Factor', 'Score', 'Narrative'].forEach(function(header) {
        var th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');
    consequences.forEach(function(consequence) {
        var row = document.createElement('tr');
        Object.keys(consequence).forEach(function(key) {
            var cell = document.createElement('td');
            cell.textContent = consequence[key];
            row.appendChild(cell);
        });
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    tableContainer.appendChild(table);

    // Re-initialize DataTables on the new table, if necessary
    $(table).DataTable({
        searching: false,
        paging: false,
        info: false
    });
}


function fetchAndDisplayScenarios() {
    $.ajax({
        url: "/OTRisk/list_scenario_builders/", // Adjust the URL to your backend endpoint
        type: "GET",
        success: function(response) {
            const scenarios = response.scenarios;
            const scenarioList = $('#scenarioList');
            scenarioList.empty(); // Clear existing items
            scenarios.forEach(function(scenario) {
                 scenarioList.append(`
                  <li class="list-group-item d-flex align-items-center scenario-item" data-id="${scenario.id}">
                    <i class="bi bi-file-earmark-text mr-2"></i> ${scenario.scenario_name}
                  </li>
                `);
            });
            $('.scenario-item').click(function() {
                const scenarioId = $(this).data('id');
                loadScenarioDetails(scenarioId); // Function to load selected scenario details
                $('#scenarioSelectionModal').modal('hide');
            });
            $('#scenarioSelectionModal').modal('show');
        },
        error: function(xhr, status, error) {
            console.error('Error fetching scenarios:', error);
        }
    });
}

function loadScenarioDetails(scenarioId) {
    isProgrammaticChange = true;
    $.ajax({
        url: `/OTRisk/retrieve_scenario_builder/${scenarioId}`, // Adjust the URL to your backend endpoint
        type: "GET",
        success: function(response) {

            $('#txtScenario').val(response.scenario_description);
            $('#txtConsequences').val(response.consequences);
            var costs = response.costs;
            $('#txtBestCase').val(costs.bestCase); // Set best case cost
            $('#txtMostLikelyCase').val(costs.mostLikelyCase); // Set most likely case cost
            $('#txtWorstCase').val(costs.worstCase); // Set worst case cost
            var decodedText = atob(response.investment_projection);
            $('#txthdninvestmentstring').val(response.investment_projection);
            $('#selIndustry').val(response.industry).trigger('change');
            $('#selFacilityType').val(response.facility).trigger('change');
            $('#countrySelector').val(response.country).trigger('change');
            $('#selOrganizationSize').val(response.org).trigger('change');
            $('#selRegulatoryEnvironment').val(response.regs).trigger('change');
            $('#selThreats').val(response.attacker);
            $('#selVectors').val(response.vector);
            $('#targetComponent').val(response.target);
            $('#attackEffect').val(response.effect);
            $('#targetSystem').val(response.network);
            $('#impact').val(response.impact);
            $('#motivation').val(response.motivation);
        renderInvestmentImpact(decodedText);

            var costArray = response.cost_projection.split('|').map(Number);
            createCostChart('monthly_cost_chart', costArray);

            $('#hdnAT').val(response.attack_tree_data);

            var jsonObject = JSON.parse(response.attack_tree_data);
            drawAttackTree(jsonObject);

            // Clear existing BIA groups content
            var biaGroupsContainer = document.getElementById('bia_groups');
            biaGroupsContainer.innerHTML = '';

            var factors = response.factors; // Assuming this is the object structure as described
            var factorKeys = Object.keys(factors); // Get all factor names as an array
            var rows = []; // To keep track of the rows of BIA groups

            factorKeys.forEach(function(factor, index) {
                // Create a new row every 3 items
                if (index % 3 === 0) {
                    var row = document.createElement('div');
                    row.className = 'row';
                    rows.push(row);
                }

                // Create the group container
                var groupContainer = document.createElement('div');
                groupContainer.className = 'group-container col-md-4';

                // Create the group header
                var groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                var icon = document.createElement('img');
                icon.src = "{% static 'images/green_cube.png' %}"; // Adjust the path as needed
                icon.className = 'cube-icon';
                icon.alt = 'green_cube';
                groupHeader.appendChild(icon);
                var headerText = document.createTextNode(factor); // factor is the key from factors object
                groupHeader.appendChild(headerText);
                groupContainer.appendChild(groupHeader);

                // Create the group body
                var groupBody = document.createElement('div');
                groupBody.className = 'group-body';
                var factorData = factors[factor]; // Get the data for this factor
                groupBody.textContent = factorData.score + '. ' + factorData.narrative;
                groupContainer.appendChild(groupBody);

                // Add the group container to the current row
                rows[rows.length - 1].appendChild(groupContainer);

                // Add the row to the biaGroupsContainer if it's full (3 items) or if it's the last item
                if ((index + 1) % 3 === 0 || index === factorKeys.length - 1) {
                    biaGroupsContainer.appendChild(rows[rows.length - 1]);
                }
            });
            // Populate table data, costs, and other fields similarly

            alert('Scenario loaded successfully');

        },
        error: function(xhr, status, error) {
            console.error('Error loading scenario:', error);
        }
    });
}


function drawAttackTree(data) {

    $('#tab9').addClass('active').show();
    var container = document.getElementById('attack_tree');
    var containerWidth = container.clientWidth;
    var svgWidth = containerWidth * 0.8;
    var margin = { top: 20, right: 120, bottom: 20, left: 280 };
    var width = svgWidth - margin.left - margin.right;
    var height = 800; // Increased height for better resolution

    d3.select(container).selectAll("svg").remove();

    var svg = d3.select(container).append("svg")
        .attr("width", "100%")
        .attr("viewBox", "0 0 " + svgWidth + " " + height)
        .attr("height", height)
        .style("display", "block")
        .style("margin", "auto")
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Define the arrow marker
    svg.append("svg:defs").selectAll("marker")
        .data(["end"])
        .enter().append("svg:marker")
        .attr("id", String)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 25)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");

    var i = 0,
        duration = 750,
        root;

    var treemap = d3.tree()
        .size([height, width - margin.left - margin.right])
        .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2); });

    root = d3.hierarchy(data, function(d) { return d.children; });
    root.x0 = height / 2;
    root.y0 = 0;

    // Color-blind-friendly color scale
    var colorScale = d3.scaleOrdinal(["#88CCEE", "#DDCC77", "#CC6677", "#882255", "#44AA99", "#117733", "#999933", "#AA4499"]);

    update(root);

    function update(source) {
        var treeData = treemap(root);

        var nodes = treeData.descendants(),
            links = treeData.descendants().slice(1);

        nodes.forEach(function(d) { d.y = d.depth * 180 });

        var node = svg.selectAll('g.node')
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeEnter.append('circle')
            .attr('r', 10)
            .style("stroke", "black")
            .style("stroke-width", 1.5)
            .style("fill", function(d) { return colorScale(d.depth); });

        nodeEnter.append('text')
            .style("fill", "darkgray")
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .attr("transform", "rotate(-10)")
            .attr("dy", ".35em")
            .attr("x", function(d) { return d.children ? -13 - this.getComputedTextLength() : 13; })
            .attr("text-anchor", function(d) { return d.children ? "end" : "start"; })
            .text(function(d) { return d.data.name; });

        var link = svg.selectAll('path.link')
            .data(links, function(d) { return d.id; });

        link.enter().insert('path', "g")
            .attr("class", "link")
            .style("stroke", function(d) { return colorScale(d.depth); })
            .style("stroke-width", 2)
            .style("fill", "none")
            .attr("marker-end", "url(#end)") // Add the arrow marker
            .attr('d', function(d) {
                return "M" + d.y + "," + d.x
                    + "C" + (d.y + d.parent.y) / 2 + "," + d.x
                    + " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
                    + " " + d.parent.y + "," + d.parent.x;
            });
    }

    // Add border and shadow to the container
    var attackTreeDiv = document.getElementById('attack_tree');
    attackTreeDiv.style.display = 'block';
    attackTreeDiv.style.border = '1px solid #ccc';
    attackTreeDiv.style.boxShadow = '0px 0px 10px rgba(0, 0, 0, 0.5)';
    sessionStorage.setItem('attackTreeDrawn', 'true');
    document.querySelector('a[data-tab="tab4"]').click();

    // Add export button functionality (if feasible)
    var exportButton = document.getElementById('exportButton');
    if (exportButton) {
        exportButton.addEventListener('click', function() {
            var svgData = new XMLSerializer().serializeToString(document.querySelector('svg'));
            var svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
            var svgUrl = URL.createObjectURL(svgBlob);
            var downloadLink = document.createElement("a");
            downloadLink.href = svgUrl;
            downloadLink.download = "attack_tree.svg";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });
    }
}




$(document).ready(function() {
document.addEventListener('DOMContentLoaded', (event) => {
    var btn = document.getElementById('myBtn');
    if (btn) {
        btn.onclick = function() {
            var modal = document.getElementById('scenarioBuilderModal');
            if (modal) {
                modal.style.display = "block";
            } else {
                console.error("Modal element not found");
            }
        };
    } else {
        console.error("Button element not found");
    }
});
});

$(document).ready(function() {
    var tab2Changed = false; // Flag to track changes in Tab 1
    var isProgrammaticChange = false;

    // Attach change listeners to all inputs and selects within Tab 1
    $('#tab2 input, #tab2 select').change(function() {
        if (!isProgrammaticChange) { // Check if change is not programmatic
            tab2Changed = true;
        }
    });

    $('.sub-menu a').click(function(e) {
        e.preventDefault();

        // Remove 'active' class from all tabs
        $('.tab-content').removeClass('active');

        // Add 'active' class to clicked tab
        var tabId = $(this).attr('data-tab');
        $('#' + tabId).addClass('active');

        // Check if the Scenario tab was clicked
        if ($(this).attr('id') === 'scenarioTabLink') {
            if (!tab2Changed) {
                // If no changes were made in Tab 1, do not execute the AJAX call

                document.getElementById('spinner').style.display = 'none'; // Ensure spinner is hidden
                return; // Exit the function early
            }

            // Proceed with AJAX call only if changes were made in Tab 1
            document.getElementById('spinner').style.display = 'block';
            var formData = {
                'attacker': $('#selThreats').val(),
                'attackVector': $('#selVectors').val(),
                'targetComponent': $('#targetComponent').val(),
                'attackEffect': $('#attackEffect').val(),
                'targetSystem': $('#targetSystem').val(),
                'impact': $('#impact').val(),
                'motivation': $('#motivation').val(),
                'facility_type': $('#selFacilityType').val(),
                'industry': $('#selIndustry').val(),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            };

            $.ajax({
                url: "{% url 'OTRisk:generate_scenario_description' %}",
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.scenario_description) {
                        $('#txtScenario').val(response.scenario_description);
                    } else {
                        $('#txtScenario').val('No scenario description available.');
                    }
                    $('#scenarioBuilderModal').modal('hide');
                },
                error: function(xhr, status, error) {
                    console.error('Error generating scenario:', error);
                },
                complete: function() {
                    // Hide the spinner and reset the flag
                    document.getElementById('spinner').style.display = 'none';
                    tab2Changed = false;
                }
            });
        }
    });
});


function saveScenario(scenarioName) {
    var scenarioData = {
    name: scenarioName,
    scenario: document.getElementById('txtScenario').value,
    attackTree: document.getElementById('hdnAT').value,
    consequences: document.getElementById('txtConsequences').value,
    tableData: extractTableData(), // Add this line
    bestCaseCost: document.getElementById('txtBestCase').value,
    mostLikelyCaseCost: document.getElementById('txtMostLikelyCase').value,
    worstCaseCost: document.getElementById('txtWorstCase').value,
    cost_projection: document.getElementById('scenario_12month_costs').value,
    investment_projection: document.getElementById('txthdninvestmentstring').value,
    industry: document.getElementById('selIndustry').value,
    facility: document.getElementById('selFacilityType').value,
    country: document.getElementById('countrySelector').value,
    org: document.getElementById('selOrganizationSize').value,
    regs: document.getElementById('selRegulatoryEnvironment').value,
    attacker: document.getElementById('selThreats').value,
    vector: document.getElementById('selVectors').value,
    target: document.getElementById('targetComponent').value,
    effect: document.getElementById('attackEffect').value,
    network: document.getElementById('targetSystem').value,
    impact: document.getElementById('impact').value,
    motivation: document.getElementById('motivation').value,
    };

    $.ajax({
    url: "{% url 'OTRisk:save_scenario_builder' %}",
    type: 'POST',
    data: scenarioData,
    headers: {
        'X-CSRFToken': getCsrfToken()  // Include CSRF token
    },
    success: function(response) {
        alert('Scenario saved successfully');
    },
    error: function(xhr, status, error) {
        console.error('Error saving scenario:', error);
    }
    });
}

function extractTableData() {
    var tableData = [];
    $('#consequencesTable tbody tr').each(function() {
        var row = $(this).find('td').map(function() {
            return $(this).text();
        }).get();
        if (row.length > 0) {
            tableData.push({
                factor: row[0],
                score: row[1],
                narrative: row[2]
            });
        }
    });
    return tableData;
}

function getCsrfToken() {
    var name = 'csrftoken';
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function abbreviateValue(value) {
    var newValue = value;
    if (value >= 1000 && value < 1000000) {
        newValue = "$" + (value / 1000).toFixed(1) + "k"; // Thousands
    } else if (value >= 1000000) {
        newValue = "$" + (value / 1000000).toFixed(1) + "m"; // Millions
    } else {
        newValue = "$" + value; // Less than 1000
    }
    return newValue;
}

function createCostChart(containerId, costArray) {
    var data = [];
    for (let i = 0; i < costArray.length; i++) {
        data.push({x: `Month ${i + 1}`, value: costArray[i]});
    }

    // Ensure the chart library is ready before creating the chart
    anychart.onDocumentReady(function() {
        // Clear the container before creating a new chart
        document.getElementById(containerId).innerHTML = '';

        var chart = anychart.column();
        chart.data(data);

        // Set the chart title
        chart.title("Monthly Cost Estimates");

        // Customize the X-axis labels
        var xAxis = chart.xAxis();
        xAxis.title("Month");
        xAxis.labels()
            .rotation(-70) // Angle the labels
            .fontSize(10); // Smaller font size

        // Customize the Y-axis
        var yAxis = chart.yAxis();
        yAxis.title("Cost in USD");

        var series = chart.getSeries(0);
        series.labels(true);
        series.labels()
            .position("above")
            .anchor("centerBottom")
            .fontSize(10)
            .format(function() {
                return abbreviateValue(this.value);
            });

        // Optionally disable credits if needed
        var credits = chart.credits();
        credits.enabled(false);

        // Draw the chart in the specified container
        chart.container(containerId);
        chart.draw();
    });
}

$(document).ready(function() {
    // Close button inside the modal header
    $('.close').click(function() {
        $('#scenarioSelectionModal').modal('hide');
    });

    // Close button in the modal footer
    $('#scenarioSelectionModal .btn-secondary').click(function() {
        $('#scenarioSelectionModal').modal('hide');
    });
});


$(document).ready(function() {
  $("#addRow").click(function() {
    var newRow = `<tr>
      <td><select name="investment_type[]" class="form-control">
        <option value="Software">Software</option>
        <option value="Hardware">Hardware</option>
        <option value="People">People</option>
      </select></td>
      <td><input type="text" name="vendor_name[]" class="form-control" /></td>
      <td><input type="text" name="product_name[]" class="form-control" /></td>
      <td><input type="number" name="cost[]" class="form-control" step="0.01" /></td>
      <td><input type="date" name="date[]" class="form-control" /></td>
      <td><button type="button" class="btn btn-danger removeRow">Remove</button></td>
    </tr>`;
    $("#investmentTable tbody").append(newRow);
  });

  $(document).on('click', '.removeRow', function() {
    $(this).closest('tr').remove();
  });
});
</script>

</body>
</html>
