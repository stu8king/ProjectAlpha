{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>AnzenOT - CyberPHA and OT Risk Management</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">

    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9z71m0_5oIR2tg4ygvOt61jCL-IgxlBI"></script>

    <!-- Bootstrap JS -->
    <script src="{% static 'bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>

    <script src="{% static 'anychart/dist/js/anychart-bundle.min.js' %}"></script>
    <script src="{% static 'anychart/dist/js/anychart-heatmap.min.js' %}"></script>
    <script src="{% static 'anychart/dist/js/anychart-sunburst.min.js' %}"></script>
    <script src="{% static 'anychart/dist/js/anychart-pie.min.js' %}"></script>
    <script src="{% static 'anychart/dist/js/anychart-cartesian.min.js' %}"></script>
    <script src="{% static 'anychart/dist/js/anychart-radar.min.js' %}"></script>
    <script src="{% static 'anychart/dist/js/anychart-circular-gauge.min.js' %}"></script>

     <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-linear-gauge.min.js" type="text/javascript"></script>

     {% load django_bootstrap5 %}
     {% bootstrap_css %}
     {% bootstrap_javascript %}
<style>
 .form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}

@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: calc(100% - 200px);
        max-width: calc(90vw - 200px);
        margin-left: 100px;
    }
}

.custom-main-content {
position: relative; /* Adjust if necessary */
width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
max-width: calc(90vw - 200px); /* 90% of the viewport width minus sidebar width */
margin-left: 200px; /* Push content to the right of the sidebar */
}
.top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 100px; /* Align with the end of the sidebar */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}

.page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.5rem; /* Adjust size as needed */
}

@media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
}

body {
background-color: #464748;
color: #d3d1cd;
}
    .sidebar {
        height: 100vh;
        background-color: #2D2E30; /* Darker shade for sidebar */
        padding: 20px 0;
        width: 200px; /* Reduced width */
    }
    .sidebar-logo {
        padding: 10px 15px;
        text-align: center;
    }
    .nav-sidebar {
        display: flex;
        flex-direction: column;
        padding-left: 0;
        list-style: none;
    }
    .nav-sidebar .nav-item {
        padding: 5px 10px;
        /* border-bottom: 1px solid  #fac330; /* Light orange line */
        margin: 0 10%;
    }
    .nav-sidebar .nav-link {
        color: #d3d1cd;
        border-radius: 0;
        transition: color 0.3s ease-in-out;
        font-size: 0.8em;
    }
    .nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
        background-color: #3A5F5F;
        color: #E0E0E0;
    }

.nav-link:hover, .dropdown-item {
    color: #E0E0E0; /* Light grey text on hover */
}

.dropdown-menu {
        background-color: #d3d1cd;
        border: none;
    }

.dropdown-item {
    color: #FFFFFF; /* White text for clear visibility */
}

.dropdown-item:hover, .dropdown-item:focus {
        background-color: #fac330; /* Light orange background for hovered dropdown items */
        color: #2D2E30;
    }
    .col-md-2 {
        place-items: center;
    }


.scenario-item {
    width: 100%;
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}


.scenario-link {
    display: block;
    width: 100%; /* Set width to 100% */
    padding: 5px;
    margin: 0; /* Remove any default margins */
    border: 0px solid transparent;
    border-right: none; /* Remove the right border */
    background-color: white;
    transition: background-color 0.3s, border-color 0.3s; /* Smooth transition for color changes */
    text-decoration: none; /* Remove underline from link */
    color: black; /* Set link text color */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}



.scenario-link.highlighted {
    border-color: black;
    background-color: #5E6266;
    color: white;
}


.equal-card .card-body {
    flex: 1; /* This will make sure the content takes up all available space */
}


#action_table th, #action_table td {
    border: 1px solid #ddd;
    padding: 8px;
}

#action_table th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #f2f2f2;
    color: black;
    border-bottom: 3px solid #ddd;
}

#action_table tr:hover {
    background-color: #f5f5f5;
}

                        /* 3D shading effect */
                        #action_table {
                            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
                        }
                        .nav-sidebar .nav-link img {
    width: 1.25em; /* Scales with the font size */
    height: 1.25em; /* Scales with the font size */
}
/* Larger icons for tablets */
@media (min-width: 768px) {
    .nav-sidebar .nav-link img {
    width: 1.5em;
    height: 1.5em;
    }
}
/* Even larger icons for desktops */
@media (min-width: 992px) {
    .nav-sidebar .nav-link img {
    width: 1.75em;
    height: 1.75em;
    }
}
                    </style>
</head>
<body style="background-color: #464748">
<script>anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");</script>

<div class="container-fluid">
<div class="row">
    <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebarMenu">
            <div class="sidebar-sticky">
                <div class="sidebar-logo">
                    <img src="{% static 'images/anzen_owl.png' %}" class="img-fluid" alt="Logo">
                </div>
                <ul class="nav flex-column nav-sidebar">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'OTRisk:dashboardhome' %}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'OTRisk:qraw' %}">QRAW</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}">CyberPHA</a>
                    </li>
                    <li class="nav-item menu-item">
                        <a class="nav-link" href="{% url 'OTRisk:scenario_sim' %}">Scenario Builder</a>
                    </li>
                    <li class="nav-item menu-item">
                        <a class="nav-link" href="{% url 'OTRisk:ra_actions_view_default' %}">Actions</a>
                    </li>
                    <li class="nav-item menu-item">
                        <a class="nav-link" href="{% url 'OTRisk:risk_register' %}">Risk Register</a>
                    </li>
                    <li class="nav-item menu-item">
                        <a class="nav-link" href="{% url 'OTRisk:list_frameworks' %}">Assessments</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Admin
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">

                            <li>
                                <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:setup_org' %}">Set Defaults</a>
                            </li>
                        <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:cybersecurity_defaults_view' %}">Cyber Insurance</a>

                                </li>

                            {% if user.is_staff %}
                            <!-- Links visible only to superusers -->
                            <li>
                                <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:admin_users' %}">Admin Users</a>
                            </li>
                            <li>
                                <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:upload_questionnaire' %}">Upload Questionnaires</a>
                            </li>
                            <li>
                                <a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:user_admin' %}">User Administration</a>
                            </li>
                            <li>
                                <a class="dropdown-item"  style="font-size: 12px;" href="{% url 'OTRisk:organization_form' %}">Manage Organizations</a>
                            </li>
                            <li>
                                <a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a>
                            </li>
                            {% endif %}
                        </ul>
                     </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'accounts:profile' %}">
                    <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
                    </a>
                    </li>
                    <li class="nav-item menu-item">
                    <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="nav-link" style="background:none; border:none; padding:0; margin:0; color:inherit;">Logout</button>
                </form>

                    </li>
                    </ul>
            </div>
    </nav>
    <main role="main" class="col-md-10 ml-sm-auto col-lg-12  custom-main-content" >
    <div class="top-strip">
        <h1 class="page-title">QRAW Report@AnzenOT (Beta)</h1>
    </div>

    <div class="row">
        <div class="col-md-12" id="pha_header"></div>
        <div class="row">
        <div class="col-md-12">
            <p>
            <H4 style="color: white; display: inline-block;">QRAW Title: {{ qraw_header.RATitle }}</H4>
        </div>
    </div>
    <div class="row"  style="font-size: 10px">
            <div class="col-md-4">
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-6" style="font-size: 14px; color: white">
                            <b>Facility Type:</b> {{ qraw_header.BusinessUnitType }}<br>
                            <b>Industry:</b> {{ qraw_header.industry }}<br>
                            <b>Business Unit:</b> {{ qraw_header.BusinessUnit }}<br>
                            <b>Date:</b> {{ qraw_header.RADate }}<br>

                        </div>
                        <div class="col-md-6" style="font-size: 14px; color: white">
                            <b>Trigger: </b>{{ qraw_header.RATrigger }}<br>
                            <b>Risk Assessor: </b>{{ qraw_header.AssessorName }}<br>
                            <b>Status:</b> {{ qraw_header.StatusFlag }}<br>


                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-4">
                            <label style="color:white">Estimated Event Costs</label>
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                            <div class="card-body">
                            <img src="{% static 'images/bestcase.png' %}" alt="" style="height: 2em; vertical-align: middle; color: #3B6BF9"> Best Case<br>
                            <h4>{{ total_cost_impact_low }}</h4>
                            </div>
                            </div>

                </div>
                        <div class="col-md-4">
                            <label style="color:white">Estimated Event Costs</label>
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                <img src="{% static 'images/mostlikely.png' %}" alt="" style="height: 2em; vertical-align: middle;"> Median<br>
                                <h4>{{ total_cost_impact }}</h4>
                                </div>
                                </div>

                </div>
                        <div class="col-md-4">
                            <label style="color:white">Estimated Event Costs</label>
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                <img src="{% static 'images/worstcase.png' %}" alt="" style="height: 2em; vertical-align: middle;"> Worst Case<br>
                                <h4>{{ total_cost_impact_high }}</h4>

                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2"></div>

    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="form-group">

            <div id="risk_score_container" style="width: 100%; height: 350px;"></div>

            </div>
        </div>
        <div class="col-md-5">
            <div class="form-group">
            <div id="bia_container" style="width: 100%; height: 350px;"></div>
            </div>
        </div>
        <div class="col-md-2"></div>
    </div>


</div> <!-- BIA Summary and profile -->
<br>
<div class="row">
    <div class="col-md-3" style="padding-right: 0; padding-left: 0">
        <u><b>Scenario's</b></u><br><br>
        {% for scenario in qraw_scenarios %}
            <div class="scenario-item">
                <a href="#" data-id="{{ scenario.ID }}" class="scenario-link">{{ forloop.counter }}. {{ scenario.ScenarioDescription }}</a>
            </div>
        {% endfor %}
    </div>
    <script>
    $(document).ready(function() {
        $('.scenario-link').on('click', function(e) {
            e.preventDefault(); // Prevents the default action of the link

            // Remove highlighted class from all links
            $('.scenario-link').removeClass('highlighted');

            // Add highlighted class to the clicked link
            $(this).addClass('highlighted');

            var scenarioId = $(this).data("id");  // Get the ID of the clicked scenario

            // Fetch the details of the scenario (assuming you have an endpoint to do this)
            $.ajax({
                url: `/OTRisk/get_qraw_scenario_report_details/?id=${scenarioId}`,
                method: "GET",
                success: function(data) {
                    // Generate the radar chart using the fetched data
                    generateRadarChart(data);
                    generateRiskBarChart(data);
                    writeScenarioData(data);

                },
                error: function(error) {
                    console.error("Error fetching scenario data:", error);
                }
            });
        });

        // Automatically click on the first scenario link
        $('.scenario-link').first().trigger('click');
    });


    </script>
    <div class="col-8" style="padding-left: 0; background-color: #5E6266">
        <br>
        <div class="col-md-1"></div>
        <div class="col-md-12">
        <div class="form-group">
        <div class="row">
            <div class="col-md-6">
                <b>Scenario Consequences</b>
                <div id="scenario_consequences" ></div><br>
                <div id="radarChartContainer" style="width: 100%; height: 400px;"></div><br>
                <b>Damage Estimate</b>
                <div id="scenario_damage" ></div><br>
            </div>
            <div class="col-md-6">
                <b>Recommendations</b>
                <div id="exec_summary" ></div>
             </div>
        </div>
        </div>
        <div class="form-group">
            <div class="row">
                <div class="col-md-3"></div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="riskContainer" style="width: 85%; height: 350px;"></div>
                    </div>

                </div>
                <div class="col-md-3"></div>
            </div>
        </div>
    </div>

    </div>
    <div class="col-md-1"></div>
</div>


</main>
</div>
</div>
<script>
anychart.onDocumentReady(function() {
    // Create data for AnyChart
    var data = [];

    // Add the normalized scores to the data
    data.push({
        "x": "Vulnerability",
        "value": {{ overall_vulnerability_score }},
        "fill": getColor({{ overall_vulnerability_score }})
    });
    data.push({
        "x": "Threat",
        "value": {{ overall_threat_score }},
        "fill": getColor({{ overall_threat_score }})
    });
    data.push({
        "x": "Inherent Risk",
        "value": {{ overall_inherent_risk_score }},
        "fill": getColor({{ overall_inherent_risk_score }})
    });
    data.push({
        "x": "Residual Risk",
        "value": {{ overall_residual_risk_score }},
        "fill": getColor({{ overall_residual_risk_score }})
    });

    // Create a chart
    var chart = anychart.bar3d();

    // Add data to the chart
    chart.data(data);
    var credits = chart.credits();
    credits.enabled(false);
    // Set chart title
    chart.title("QRAW Risk Summary");
    chart.palette(anychart.palettes.provence);
    chart.yScale().minimum(0).maximum(10);

    // Draw the chart
    chart.container("risk_score_container");
    chart.draw();
    });

anychart.onDocumentReady(function() {
    // Create data for AnyChart
    var data = [];
    {% for field, avg_value in impact_summary.items %}
        data.push({
            "x": "{{ field }}",
            "value": {{ avg_value }},
            "fill": getColor({{ avg_value }})
        });
    {% endfor %}

    // Create a chart
    var chart = anychart.column3d();

    // Add data to the chart
    chart.data(data);
    var credits = chart.credits();
    credits.enabled(false);
    chart.xAxis().labels().rotation(-45);

    chart.title("Business Impact Summary");
    chart.palette(anychart.palettes.provence);
    chart.yScale().minimum(0).maximum(10);

    // Draw the chart
    chart.container("bia_container");
    chart.draw();
});

    $(document).ready(function() {
    $(".scenario-link").click(function(e) {
        e.preventDefault();  // Prevent the default link behavior

        var scenarioId = $(this).data("id");  // Get the ID of the clicked scenario

        // Fetch the details of the scenario (assuming you have an endpoint to do this)
        $.ajax({
            url: `/OTRisk/get_qraw_scenario_report_details/?id=${scenarioId}`,
             method: "GET",
            success: function(data) {
                // Generate the radar chart using the fetched data
                generateRadarChart(data);
                generateRiskBarChart(data);
                writeScenarioData(data);

            },
            error: function(error) {
                console.error("Error fetching scenario data:", error);
            }
        });
    });
});

    function writeScenarioData(data) {

        var consequencesText = data.consequences;
        var exec_summary = data.executive_summary;
        var scenario_damage = data.scenario_damage;

        // Split the text into an array of bullet points
        // Assuming each bullet point starts with '-'
        var bulletPoints = consequencesText.split('-').filter(function(point) {
            return point.trim() !== '';  // Filter out any empty strings resulting from the split
        });

        // Create an HTML list item for each bullet point
        var formattedHtml = bulletPoints.map(function(point) {
            return '<li>' + point.trim() + '</li>';  // Trim whitespace and add <li> tags
        }).join('');  // Join all list items into a single string

        // Wrap the list items in a <ul> tag
        formattedHtml = '<ul>' + formattedHtml + '</ul>';

        // Set the formatted HTML as the content of the scenario_consequences element
        document.getElementById('scenario_consequences').innerHTML = formattedHtml;

        document.getElementById('exec_summary').innerText = exec_summary;
        document.getElementById('scenario_damage').innerText = scenario_damage;


    }

function setSliderColor(slider) {

    let value = slider.value;
    let color;
    if (value <= 30) {
        color = "red";
    } else if (value <= 60) {
        color = "orange";
    } else if (value <= 80) {
        color = "yellow";
    } else {
        color = "green";
    }
    slider.style.setProperty("--thumb-color", color);  // Set the color variable
}
function generateRadarChart(data) {
    anychart.onDocumentReady(function() {

        $('#radarChartContainer').empty();

        var chart = anychart.radar();

        var seriesData = [
            {x: "Safety", value: data.impactSafety},
            {x: "Production", value: data.impactProduction},
            {x: "Finance", value: data.impactFinance},
            {x: "Reputation", value: data.impactReputation},
            {x: "Environment", value: data.impactEnvironment},
            {x: "Regulation", value: data.impactRegulation},
            {x: "Data", value: data.impactData},
            {x: "Supply", value: data.impactSupply}
        ];

        var credits = chart.credits();
        credits.enabled(false);
        chart.line(seriesData);
        chart.background().fill("#5e6266");
        chart.yScale().minimum(0).maximum(10);
        chart.xGrid().palette(["gray 0.05", "gray 0.1"]);
        chart.yGrid().palette(["gray 0.05", "gray 0.1"]);
        var title = chart.title();
        title.text("Business Impact Analysis");
        title.orientation("top");
        title.align("center");
        title.enabled(true);
        title.fontColor("#FFFFFF")
        chart.xAxis().labels().fontColor("#FFFFFF");

        // Set y-axis labels style to white
        chart.yAxis().labels().fontColor("#FFFFFF");
        chart.container('radarChartContainer');
        chart.draw();
    });
}

function generateRiskBarChart(data) {

    anychart.onDocumentReady(function() {
        $('#riskContainer').empty();
        // Create data for the bar chart
        var barData = [
            {x: "Vulnerability Score", value: data.vulnerability_score, fill: getColor(data.vulnerability_score)},
            {x: "Threat Score", value: data.threat_score, fill: getColor(data.threat_score)},
            {x: "Inherent Risk Score", value: data.inherent_risk_score, fill: getColor(data.inherent_risk_score)},
            {x: "Residual Risk", value: data.residual_risk, fill: getColor(data.residual_risk)}
        ];

        // Create the bar chart
        var chart = anychart.bar3d();
        chart.data(barData);
        var credits = chart.credits();
        credits.enabled(false);
        var title = chart.title();
        title.text("Scenario Risk Analysis Summary")
             .fontColor("#FFFFFF"); // Set title color to white

        // Set x-axis labels style to white
        chart.xAxis().labels().fontColor("#FFFFFF");

        // Set y-axis labels style to white
        chart.yAxis().labels().fontColor("#FFFFFF");

        chart.background().fill("#5e6266");
        chart.yScale().minimum(0).maximum(10);

        chart.container("riskContainer");
        chart.draw();
    });
}

function getColor(value) {
    let color;
    if (value <= 3) {
        color = "green";
    } else if (value <= 6) {
        color = "yellow";
    } else if (value <= 8) {
        color = "orange";
    } else {
        color = "red";
    }
    return color;
}
</script>




</body>
</html>