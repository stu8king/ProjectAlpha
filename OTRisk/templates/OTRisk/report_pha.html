{% load static %}
<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
    <title>iOTa.....industrial OT assessor</title>
 <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
     <!-- Bootstrap Select JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $('select').selectpicker();
    </script>
    {% load django_bootstrap5 %}
     {% bootstrap_css %}
     {% bootstrap_javascript %}

    <style>
        .custom-btn {
                width: 150px;  /* Adjust this value as needed */
                height: 50px;  /* Adjust this value as needed */
            }


        #headertable tbody tr:hover {
        background-color: #f5f5f5; /* Change this to the color you want */
        }

       .navbar-scroll .nav-link,
        .navbar-scroll .navbar-toggler-icon,
        .navbar-scroll .navbar-brand {
          color: #ffffff;
        }

        /* Color of the navbar BEFORE scroll */
        .navbar-scroll {
          background-color: #000000;
            text-decoration-color: #FFFFFF;
        }


        /* Color of the links AFTER scroll */
        .navbar-scrolled .nav-link,
        .navbar-scrolled .navbar-toggler-icon,
        .navbar-scroll .navbar-brand {
          color: #262626;
        }

        .navbar-logo {
        position: absolute;
        top: 5px; /* Adjust this as needed */
        left: 5px; /* Adjust this as needed */
        height: 100px; /* Adjust this as needed */
        z-index: 10;
        }
        

    .small-font {
        font-size: 0.8rem; /* adjust as needed */
   }

        .spinner {
        border: 16px solid #f3f3f3;
        border-top: 16px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        display: none; /* Initially hidden */
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .selectable-row:hover {
    cursor: pointer;
    background-color: #f5f5f5;  /* Optional: to give a slight background change on hover */
}

    .table-wrapper {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Shadow effect */
    border: 1px solid #e0e0e0; /* Border around the card */
    border-radius: 5px; /* Rounded corners */
    padding: 20px; /* Some spacing inside the card */
    margin-bottom: 20px; /* Space below the card */
    background-color: #fff; /* White background */
}

#reportDetails {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    background-color: #f9f9f9;
}

#reportDetails h2 {
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

#reportDetails .row {
    margin-bottom: 10px;
}

.scenario canvas {
    margin: 20px 0;
}

    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-scroll fixed-top shadow-0 border-bottom border-dark rounded">
  <div class="container-fluid d-flex justify-content-between">
   <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}"><img src="/static/images/logo1-2.jpg" style="height: 140px; width: 140px" class="navbar-logo" alt="">  </a>
      <h4 class="my-auto text-center flex-grow-1"><font color="white">CyberPHA Reports</font></h4>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}"><i class="bi bi-journal-text"></i> CyberPHA</a>
        </li>
          <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:ra_actions_view' %}" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Actions</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-file-earmark-easel"></i> Reports
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports' %}" >QRAW Reports</a></li>
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports_pha' %}">CyberPHA Reports</a></li>
              </ul>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_scenario' %}">Scenario Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_consequence' %}">Consequence Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:admin_users' %}">Admin Users</a></li>
                  {% if user.is_staff %}
                    <!-- Links visible only to superusers -->
                    <li><a class="dropdown-item" href="{% url 'OTRisk:user_admin' %}">User Administration</a></li>
                      <li><a class="dropdown-item" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a></li>
                    {% endif %}

              </ul>

        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:profile' %}">
                <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
            </a>
        </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </li>
      </ul>
    </div>
  </div>

</nav>

<div class="row">
    <div class="col-md-1 bg-black"> </div>
    <div class="col-md-10 bg-black">
    <div id="headertableWrapper" class="table-wrapper">
        <table id="headertable" class="table table-striped table-bordered small-font">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Site</th>
                <th>Type</th>
                <th>Unit</th>
                <th>Zone</th>
                <th>Leader</th>
                <th>Date</th>
                <!-- Add more <th> elements for each field in the RAWorksheet model -->
            </tr>
        </thead>
        <tbody>
            {% for pha_reports in pha_reports %}
                <tr data-id="{{ pha_reports.ID }}" class="selectable-row">
                    <td>{{ pha_reports.ID }}</td>
                    <td>{{ pha_reports.title }}</td>
                    <td>{{ pha_reports.FacilityName }}</td>
                    <td>{{ pha_reports.FacilityType }}</td>
                    <td>{{ pha_reports.AssessmentUnit }}</td>
                    <td>{{ pha_reports.AssessmentZone }}</td>
                    <td>{{ pha_reports.PHALeader }}</td>
                    <td>{{ pha_reports.AssessmentStartDate|date:"m/d/Y" }}</td>
                    <!-- Add more <td> elements for each field in the RAWorksheet model -->
                </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
    </div> <!-- table view of existing risk assessments -->
    <div class="col-md-1 bg-black"></div>
</div>
<div class="row">
    <div class="col-md-1 bg-black"></div>
            <div id="reportSection" class="col-md-10 table-wrapper small-font" >
                <div id="reportDetails">
                    <h2>Report: <span id="reportTitle"></span></h2>
                    <div class="row">
                    <div class="col-md-3">
                        <strong>Title:</strong> <span id="reportTitle"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Facility:</strong> <span id="FacilityName"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Facility Type:</strong> <span id="FacilityType"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Unit:</strong> <span id="AssessmentUnit"></span>
                    </div>
                </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                        Facility Safety Summary
                                    </div>
                                    <div class="card-body">
                                        <span id="safetySummary"></span>
                                        <p class="card-text">Overall impact on safety from all scenarios.</p>
                                    </div>
                                </div>
                            </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                        Facility Chemicals Summary
                                    </div>
                                    <div class="card-body">
                                        <span id="chemicalSummary"></span>
                                        <p class="card-text">Overall impact on danger-to-life from all scenarios.</p>
                                    </div>
                                </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                        Facility Physical Security Summary
                                    </div>
                                    <div class="card-body">
                                       <span id="physicalSummary"></span>
                                        <p class="card-text">Overall impact on the environment from all scenarios.</p>
                                    </div>
                                </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                        Facility Other Information
                                    </div>
                                    <div class="card-body">
                                        <span id="otherSummary"></span>
                                        <p class="card-text">Overall impact on the environment from all scenarios.</p>
                                    </div>
                                </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                        Business Impact Analysis
                                    </div>
                                    <div class="card-body">
                                        <canvas id="impactChart"></canvas>

                                    </div>
                                </div>
                        </div>

                    </div>

                    <div id="scenarioCount">Number of Scenarios: <span></span></div>
                    <div id="scenariosContainer"></div>

                </div>
            </div>
    <div class="col-md-1 bg-black"></div>
</div>
<script>

    function displayReportData(data) {
        // Populate the report details
        $('#reportTitle').text(data.cyberPHAHeader.title);
        $('#reportDate').text(data.cyberPHAHeader.AssessmentStartDate);
        $('#FacilityName').text(data.cyberPHAHeader.FacilityName);
        $('#FacilityType').text(data.cyberPHAHeader.FacilityType);
        $('#AssessmentUnit').text(data.cyberPHAHeader.AssessmentUnit);

        let formattedText = data.cyberPHAHeader.safetySummary.replace(/\n/g, '<br>');
        $('#safetySummary').html(formattedText);

        formattedText = data.cyberPHAHeader.chemicalSummary.replace(/\n/g, '<br>');
        $('#chemicalSummary').html(formattedText);

        formattedText = data.cyberPHAHeader.physicalSummary.replace(/\n/g, '<br>');
        $('#physicalSummary').html(formattedText);

        formattedText = data.cyberPHAHeader.otherSummary.replace(/\n/g, '<br>');
        $('#otherSummary').html(formattedText);


        $('#scenariosContainer').empty();
        // Loop through each scenario and append to the container
        $.each(data.scenarios, function (index, scenario) {
            var scenarioHtml = `
            <div class="scenario">

                <h3>Scenario ${index + 1}</h3>
                <div class="row">
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header">
                                Scenario:
                            </div>
                            <div class="card-body">
                                <p class="card-text">${ scenario.Scenario }</p>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="col-md-1"></div>
                                <div class="card">
                                    <div class="card-header">
                                        Overall Risk Status:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.RRa }</p>
                                    </div>
                                </div>
                            </div> <!-- This closing tag was moved up -->
                        </div>
                        <div class="row">
                            <div class="col-md-1">
                                <div class="card">
                                    <div class="card-header">
                                        UEL:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.UEL }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="card">
                                    <div class="card-header">
                                        RRU:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.RRU }</p>
                                    </div>
                                </div>
                            </div>
                             <div class="col-md-1"></div>
                            <div class="col-md-1">
                                <div class="card">
                                    <div class="card-header">
                                        Sm:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.SM }</p>
                                    </div>
                                </div>

                            </div>
                            <div class="col-md-1">
                                <div class="card">
                                    <div class="card-header">
                                        MEL:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.MEL }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="card">
                                    <div class="card-header">
                                        RRm:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.RRM }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1"></div>
                            <div class="col-md-1">
                                <div class="card">
                                    <div class="card-header">
                                        SA:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.SA }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="card">
                                    <div class="card-header">
                                        MELA:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.MELA }</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-1"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-2">
                                <div class="card">
                                    <div class="card-header">
                                        ARO:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.aro }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card">
                                    <div class="card-header">
                                        SLE:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ Number(scenario.sle).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }) }</p>

                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card">
                                    <div class="card-header">
                                        ALE:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ Number(scenario.ale).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }) }</p>

                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6"></div>
                        </div>
                        <div class="row">

                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Safety Impact: ${ scenario.impactSafety }/10
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifySafety }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Danger-to-life Impact: ${ scenario.impactLife }/10
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifyLife }</p>
                                    </div>
                                </div>
                            </div>
                             <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Environment Impact: ${ scenario.impactEnvironment }/10
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifyEnvironment }</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Production Impact: ${ scenario.impactProduction }/10
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifyProduction }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Financial Impact: ${ scenario.impactFinance }/10
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifyFinancial }</p>
                                    </div>
                                </div>
                            </div>
                             <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Reputation Impact: ${ scenario.impactReputation }/10
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifyReputation }</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Supply Chain Impact:
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifyReputation }</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        Data Impact: ${ scenario.impactData }/10
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${ scenario.justifyData }</p>
                                    </div>
                                </div>
                            </div>
                             <div class="col-md-4">

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        Alignment with Standards
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${
                                            scenario.recommendations && typeof scenario.recommendations === 'string'
                                                ? scenario.recommendations.replace(/\n/g, '<br>')
                                                : ''
                                        }</p>
                                    </div>
                                </div> <!-- Missing closing div tag for the card -->
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        Recommended Controls
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${
                                            scenario.control_recommendations && typeof scenario.control_recommendations === 'string'
                                                ? scenario.control_recommendations.replace(/\n/g, '<br>')
                                                : ''
                                        }</p>
                                    </div>
                                </div> <!-- Missing closing div tag for the card -->
                            </div>
                        </div> <!-- Closing div tag for the row -->
                    </div>

                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                Scenario Chart
                            </div>
                            <div class="card-body">
                                <canvas id="scenarioChart${index}" width="150" height="150"></canvas>
                            </div>
                        </div>
                    </div>


                <!-- ... -->
            </div>
        `;

            $('#scenariosContainer').append(scenarioHtml);

            // Generate radar chart for the scenario
            var ctx = document.getElementById(`scenarioChart${index}`).getContext('2d');
            var chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Safety', 'Danger', 'Operations', 'Finance', 'Reputation', 'Environment', 'Regulation', 'Data'],
                    datasets: [{
                        label: 'Scenario Scores',
                        data: [
                            scenario.impactSafety,
                            scenario.impactDanger,
                            scenario.impactProduction,
                            scenario.impactFinance,
                            scenario.impactReputation,
                            scenario.impactEnvironment,
                            scenario.impactRegulation,
                            scenario.impactData
                        ],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scale: {
                        ticks: {
                            beginAtZero: true,
                            max: 10 // Assuming scores are out of 100, adjust if needed
                        }
                    }
                }
            });
        });
    }


$(document).ready(function() {
$('#headertable tbody tr').on('click', function() {
    var pha_id = $(this).attr('data-ID');

    $.ajax({
        url: '/OTRisk/pha_report/' + pha_id, // Replace with the actual path to your rawreport function
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            // Handle the returned data and display it underneath the rawtable
            displayReportData(data);
            displayBarChart(data);
        },
        error: function(error) {
            console.error("Error fetching report data:", error);
        }
    });
});
});

$(document).ready(function(){

    $('#headertable').dataTable({
        "pageLength": 5,
        "lengthChange": false
    });

});

function displayBarChart(data) {
    var ctx = document.getElementById('impactChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Safety', 'Danger', 'Environment', 'Production', 'Finance', 'Data', 'Reputation', 'Regulation'],
            datasets: [{
                label: 'Impact Average',
                data: [
                    data.average_impact_safety,
                    data.average_impact_danger,
                    data.average_impact_environment,
                    data.average_impact_production,
                    data.average_impact_finance,
                    data.average_impact_data,
                    data.average_impact_reputation,
                    data.average_impact_regulation
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    min: 0,  // Set minimum value for y-axis
                    max: 10  // Set maximum value for y-axis
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}
</script>
</body>
</html>