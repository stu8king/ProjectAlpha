{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html>
<head>
    <title>AnzenOT - GRC for OT</title>
    <link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Load jQuery (only one version) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap and related scripts -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- SweetAlert -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<!-- AnyChart -->
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-base.min.js"></script>
<link href="https://cdn.anychart.com/releases/8.10.0/css/anychart-ui.min.css" rel="stylesheet" type="text/css">
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-exports.min.js"></script>

<script src="https://cdn.anychart.com/releases/v8/themes/light_provence.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-graph.min.js"></script>

 <script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
    {% load django_bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}

    <title>Assess CyberPHA</title>
    <style>
 .form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}
@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: calc(100% - 200px);
        max-width: calc(90vw - 200px);
        margin-left: 100px;
    }
}
 .top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 100px; /* Align with the end of the sidebar */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}
 @media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
}
 .page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.5rem; /* Adjust size as needed */
}


.scenario-item {
    width: 100%;
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

  .sidebar {
        height: 100vh;
        background-color: #2D2E30; /* Darker shade for sidebar */
        padding: 20px 0;
        width: 200px; /* Reduced width */
    }
    .sidebar-logo {
        padding: 10px 15px;
        text-align: center;
    }
    .nav-sidebar {
        display: flex;
        flex-direction: column;
        padding-left: 0;
        list-style: none;
    }
    .nav-sidebar .nav-item {
        padding: 5px 10px;
        /* border-bottom: 1px solid  #fac330; /* Light orange line */
        margin: 0 10%;
    }
    .nav-sidebar .nav-link {
        color: #d3d1cd;
        border-radius: 0;
        transition: color 0.3s ease-in-out;
        font-size: 0.8em;
    }
    .nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
        background-color: #3A5F5F;
        color: #E0E0E0;
    }

.nav-link:hover, .dropdown-item {
    color: #E0E0E0; /* Light grey text on hover */
}

.dropdown-menu {
        background-color: #d3d1cd;
        border: none;
    }

.dropdown-item {
    color: #FFFFFF; /* White text for clear visibility */
}

.dropdown-item:hover, .dropdown-item:focus {
        background-color: #fac330; /* Light orange background for hovered dropdown items */
        color: #2D2E30;
    }
.scenario-link {
    display: block;
    width: 100%; /* Set width to 100% */
    padding: 5px;
    margin: 0; /* Remove any default margins */
    border: 0px solid transparent;
    border-right: none; /* Remove the right border */
    background-color: white;
    transition: background-color 0.3s, border-color 0.3s; /* Smooth transition for color changes */
    text-decoration: none; /* Remove underline from link */
    color: black; /* Set link text color */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}



.scenario-link.highlighted {
    border-color: black;
    background-color: #5E6266;
    color: white;
}

body {
background-color: #464748;
color: #d3d1cd;
}

.scrollable-content {
    max-height: 300px;
    overflow-y: auto;
}



.equal-card .card-body {
    flex: 1; /* This will make sure the content takes up all available space */
}



            #action_table {
                border-collapse: collapse;
                width: 100%;
                background-color: #fff8e8;
            }

    #action_table th, #action_table td {
        border: 1px solid #ddd;
        padding: 8px;
    }

    #action_table th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #f2f2f2;
        color: black;
        border-bottom: 3px solid #ddd;
    }

    #action_table tr:hover {
        background-color: #f5f5f5;
    }

    /* 3D shading effect */
    #action_table {
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
    }
    .nav-sidebar .nav-link img {
    width: 1.25em; /* Scales with the font size */
    height: 1.25em; /* Scales with the font size */
}
/* Larger icons for tablets */
@media (min-width: 768px) {
    .nav-sidebar .nav-link img {
    width: 1.5em;
    height: 1.5em;
    }
}
/* Even larger icons for desktops */
@media (min-width: 992px) {
    .nav-sidebar .nav-link img {
    width: 1.75em;
    height: 1.75em;
    }
}
</style>


</head>
<body>
<script>
    anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");

</script>
<div class="container-fluid">
<div class="row">
{% include 'menu_bar.html' %}
<main role="main" class="col-md-10 ml-sm-auto col-lg-12  custom-main-content" >
<div class="top-strip">
    <h1 class="page-title">Snapshots@AnzenOT (Beta)</h1>
</div>
<div class="row">
    <div class="col-md-11" id="pha_header"></div>
    <br>
    <div class="row" >

<div class="col-md-1"></div>
<div class="col-md-11 ">
<div class="form-group">

<div class="row">
<div class="col-md-12">
<H4>CyberPHA Scenario Snapshots for {{ header_record.FacilityName }}</H4>
</div>
</div>
<div class="row">
<div class="col-md-6">
<div class="form-group">
<div class="row" >
    <div class="col-md-6">

        <p><b>Facility Type:</b> {{ header_record.FacilityType }}</p>
        <p><b>Industry:</b> {{ header_record.Industry }}</p>
        <p><b>Assessment Leader:</b> {{ header_record.PHALeader }}</p>
        <p><b>FacilityName:</b> {{ header_record.FacilityName }}</p>
    </div>
    <div class="col-md-6">
        <p><b>Unit:</b> {{ header_record.AssessmentUnit }}</p>
        <p><b>Zone:</b> {{ header_record.AssessmentZone }}</p>
        <p><b>Start:</b> {{ header_record.AssessmentStartDate|date:"j F Y" }}</p>
         <p><b>Finish:</b> {{ header_record.AssessmentEndDate|date:"j F Y" }}</p>
    </div>
</div>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
    <div class="row" >
        <div class="col-md-12">
            <p><b>Scenario:</b> {{ scenario_record.Scenario }}</p>
        </div>
    </div>
    <div class="row" >
        <div class="col-md-3">
            <p><b>Consequence/s:</b> </p>
        </div>
        <div class="col-md-9">
         <ol>
            {% for consequence in validated_consequences %}
                <li>{{ consequence.consequence_text }}</li>
            {% empty %}
                <li>No validated consequences.</li>
            {% endfor %}
        </ol>

</div>

</div>
</div>
</div>
</div>
</div>
</div>
</div>

</div>

<div class="row">
<div class="col-md-1 "  >



</div>
<div class="col-md-10 ">
<br>
<label id="snapshot_title"> Risk assessment saved on {{ scenario_record.timestamp|date:"j F Y" }} /
{% for snapshot in snapshots %}
<b>Snapshot {{ forloop.counter }}:</b> {{ snapshot.snapshot_date|date:"j F Y" }}/
{% endfor %} </label>
<br>
</div>
<div class="col-md-1 "  ></div>
</div>

<div class="row">
<div class="col-md-1 "  >
<div class="form-group">

<h6>Delete Snapshots</h6>
<table id="snapshotlist" class="table table-hover table-bordered small small-font overflow-auto compact" style="background-color: white;">
<thead>
<tr>
<th>No.</th>
<th>Date</th>
<th style="display:none;"></th> <!-- Hide this header -->
</tr>
</thead>
<tbody>
{% for snapshot in snapshots %}
<tr>
<td>{{ forloop.counter }}:</td>
<td>{{ snapshot.snapshot_date|date:"m/d/y" }}</td>
<td style="display:none;"></td> <!-- Hide this cell -->
</tr>
<tr>
<!-- Span the cell across all columns -->
<td colspan="3" class="text-center">
<button class="btn btn-danger btn-sm" onclick="deleteSnapshot({{ snapshot.ID }}, {{ scenario_record.ID }})">Delete</button>
</td>
</tr>
{% endfor %}
</tbody>
</table>
<script>
function deleteSnapshot(snapshotId, scenarioId) {
// Confirm before deletion
if (!confirm('Are you sure you want to delete this snapshot?')) {
return;
}

// AJAX call to delete the snapshot
$.ajax({
url: `/OTRisk/delete_snapshot/${snapshotId}/${scenarioId}/`,
type: 'POST',
headers: {
'X-CSRFToken': getCsrfToken() // Ensure you have a function to get the CSRF token
},
success: function(response) {
// Handle success - perhaps reload the page or remove the row from the table
location.reload();
},
error: function(error) {
// Handle error
alert('Error occurred while deleting the snapshot');
}
});
}

// Function to get CSRF token from the cookie
function getCsrfToken() {
const name = 'csrftoken';
let cookieValue = null;
if (document.cookie && document.cookie !== '') {
const cookies = document.cookie.split(';');
for (let i = 0; i < cookies.length; i++) {
const cookie = cookies[i].trim();
if (cookie.substring(0, name.length + 1) === (name + '=')) {
cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
break;
}
}
}
return cookieValue;
}


</script>

</div>
</div>
<div class="col-md-11 ">
<div class="form-group">

<!-- Containers for the line charts -->
<div class="row">
<div class="col-md-12">
<script>
anychart.onDocumentReady(function() {
var scenarioValue1 = {{ scenario_record.impactFinance }};
var snapshotsValues1 = [{% for snapshot in snapshots %}{{ snapshot.impactFinance }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data1 = [scenarioValue1].concat(snapshotsValues1);
var scenarioValue2 = {{ scenario_record.impactReputation }};
var snapshotsValues2 = [{% for snapshot in snapshots %}{{ snapshot.impactReputation }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data2 = [scenarioValue2].concat(snapshotsValues2);
var scenarioValue3 = {{ scenario_record.impactSafety }};
var snapshotsValues3= [{% for snapshot in snapshots %}{{ snapshot.impactSafety }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data3 = [scenarioValue3].concat(snapshotsValues3);
var scenarioValue4 = {{ scenario_record.impactDanger }};
var snapshotsValues4= [{% for snapshot in snapshots %}{{ snapshot.impactDanger }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data4 = [scenarioValue4].concat(snapshotsValues4);
var scenarioValue5 = {{ scenario_record.impactProduction }};
var snapshotsValues5= [{% for snapshot in snapshots %}{{ snapshot.impactProduction }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data5 = [scenarioValue5].concat(snapshotsValues5);
var scenarioValue6 = {{ scenario_record.impactReputation }};
var snapshotsValues6= [{% for snapshot in snapshots %}{{ snapshot.impactReputation }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data6 = [scenarioValue6].concat(snapshotsValues6);
var scenarioValue7 = {{ scenario_record.impactEnvironment }};
var snapshotsValues7= [{% for snapshot in snapshots %}{{ snapshot.impactEnvironment }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data7 = [scenarioValue7].concat(snapshotsValues7);
var scenarioValue8 = {{ scenario_record.impactRegulation }};
var snapshotsValues8= [{% for snapshot in snapshots %}{{ snapshot.impactRegulation }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data8 = [scenarioValue8].concat(snapshotsValues8);
var scenarioValue9 = {{ scenario_record.impactData }};
var snapshotsValues9= [{% for snapshot in snapshots %}{{ snapshot.impactData }}{% if not forloop.last %},{% endif %}{% endfor %}];
var data9 = [scenarioValue9].concat(snapshotsValues9);

var chart = anychart.line();
var credits = chart.credits();
credits.enabled(false);
chart.animation(true);
chart.padding([10, 180, 5, 20]);
chart.title('Business Impact Analysis');

chart.yScale().minimum(0).maximum(10);

chart.yScale().ticks().set([2, 4, 6, 8, 10]);

chart.xAxis().title('Snapshots');

var line;
line = chart.line(data1).name('Finance');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data2).name('Reputation');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data3).name('Safety');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data4).name('Danger-to-Life');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data5).name('Production');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data6).name('Reputation');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data7).name('Environment');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data8).name('Regulatory');
line.hovered().markers().enabled(true).type('circle').size(4);

line = chart.line(data9).name('Data/IP');
line.hovered().markers().enabled(true).type('circle').size(4);

chart.rangeMarker(0).from(0).to(3).fill('#e0f2f1 0.4');
chart.rangeMarker(1).from(3).to(6).fill('#b2dfdb 0.4');
chart.rangeMarker(2).from(6).to(8).fill('#80cbc4 0.4');
chart.rangeMarker(3).from(8).to(10).fill('#4db6ac 0.4');

chart
.textMarker(0)
.value(2)
.fontColor('#263238')
.align('right')
.anchor('left-center')
.offsetX(10)
.useHtml(true)
.text('BIA = Low');

chart
.textMarker(1)
.value(5)
.fontColor('#263238')
.align('right')
.anchor('left-center')
.offsetX(10)
.useHtml(true)
.text('BIA = Medium');

chart
.textMarker(2)
.value(7)
.fontColor('#263238')
.align('right')
.anchor('left-center')
.offsetX(10)
.useHtml(true)
.text('BIA = High');

chart
.textMarker(3)
.value(10)
.fontColor('#263238')
.align('right')
.anchor('left-center')
.offsetX(10)
.useHtml(true)
.text('BIA = Very High');

chart.legend().enabled(true).fontSize(13).padding([0, 0, 15, 0]);
chart.container('biaContainer');
chart.draw();
});
</script>
<div class="form-group">
<div id="biaContainer" style="width: 100%; height: 400px;"></div>
</div>
</div>
<br>
<div class="row">
<div class="col-md-6">
<script>
anychart.onDocumentReady(function() {

anychart.theme('lightProvence');
// Create a dataset
var dataSet = anychart.data.set([
['Scenario Record', {{ scenario_record.sle_low }}, {{ scenario_record.sle }}, {{ scenario_record.sle_high }}],
{% for snapshot in snapshots %}
['Snapshot {{ forloop.counter }}', {{ snapshot.sle_low }}, {{ snapshot.sle }}, {{ snapshot.sle_high }}],
{% endfor %}
]);

// Map the data for the series
var firstSeriesData = dataSet.mapAs({ x: 0, value: 1 });
var secondSeriesData = dataSet.mapAs({ x: 0, value: 2 });
var thirdSeriesData = dataSet.mapAs({ x: 0, value: 3 });

// Create a column chart instance
var chart = anychart.column();
var credits = chart.credits();
credits.enabled(false);
// Stack values on y scale
chart.yScale().stackMode('value');
chart.yAxis().labels().format("${%Value}{groupsSeparator: ,}");

// Enable horizontal grid lines
var yGrid = chart.yGrid();
yGrid.enabled(true);
yGrid.stroke({ color: "#e0e0e0", thickness: 1, dash: "5 2" });

// Disable vertical grid lines if needed
chart.xGrid().enabled(false);


// Function to configure label, padding, and color settings for all series
var setupSeries = function(series, name, color, hoveredColor) {
series.name(name).stroke('2 #fff 1').fill(color);
series.hovered().stroke('1 #fff 1').fill(hoveredColor);
};

// Create the series with the mapped data
setupSeries(chart.column(thirdSeriesData), 'Worst Case', '#dc7466', '#e77244');
setupSeries(chart.column(secondSeriesData), 'Likely Case', '#c0ba4d', '#e5d178');
setupSeries(chart.column(firstSeriesData), 'Best Case', '#78f90e', '#41df0c');


// Turn on the legend
chart.legend().enabled(true).fontSize(16).padding([10, 0, 0, 0]);

// Set the union tooltip
chart.tooltip().displayMode('union');

// Customize the tooltip
chart.tooltip().titleFormat(function() {
return this.x + ' - ' + this.points[0].getStat('categoryYSum');
});

// Set the chart title and adjust it
chart.title('Event Cost Overview');
chart.title().fontSize(20).fontColor('#2b2b2b').padding([5, 0, 0, 0]);

chart.container('costContainer');
chart.draw();
});
</script>
<div class="form-group">

<div id="costContainer" style="width: 100%; height: 400px;"></div>
</div>

</div>
<div class="col-md-6">
<script>
anychart.onDocumentReady(function() {
var scenarioValue1 = parseInt("{{ scenario_record.probability|slice:":-1" }}", 10);
var snapshotsValues1 = [{% for snapshot in snapshots %}parseInt("{{ snapshot.probability|slice:":-1" }}", 10){% if not forloop.last %},{% endif %}{% endfor %}];
var data1 = [scenarioValue1].concat(snapshotsValues1);

var scenarioValue2 = parseInt("{{ scenario_record.control_effectiveness }}", 10);
var snapshotsValues2 = [{% for snapshot in snapshots %}parseInt("{{ snapshot.control_effectiveness }}", 10){% if not forloop.last %},{% endif %}{% endfor %}];
var data2 = [scenarioValue2].concat(snapshotsValues2);

var chart = anychart.column();  // Changed to column chart
var credits = chart.credits();
credits.enabled(false);
chart.animation(true);
chart.padding([10, 120, 5, 20]);
chart.title('Probability of Attack Success');

chart.yScale().minimum(0).maximum(100);

chart.xAxis().title('Snapshots');
chart.yAxis().title('Probability %');

var columnSeries = chart.column(data1);
columnSeries.name('Probability').fill('#1c92d3');

var lineSeries = chart.line(data2);
lineSeries.name('Control Effectiveness').stroke({color: "#FF5733", thickness: 2});  // Setting the color and thickness of the line


chart.legend().enabled(true).fontSize(13).fontColor('#000').padding([0, 0, 15, 0]);
chart.container('probContainer');
chart.draw();
});
</script>
<div class="form-group">

<div id="probContainer" style="width: 100%; height: 400px;"></div>

</div>
</div>



</div>


</div>
</div>
</div>

</div>
</div>

</div>




</body>
</html>