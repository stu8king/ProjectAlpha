{% load static %}
<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>



    <script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
    {% load django_bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}

    <title>Assess CyberPHA</title>
    <style>
      .green-circle {
    display: inline-block;
    width: 12px;
    height: 12px;
    background-color: green;
    border-radius: 50%;
    margin-right: 5px;
}

.orange-circle {
    display: inline-block;
    width: 12px;
    height: 12px;
    background-color: orange;
    border-radius: 50%;
    margin-right: 5px;
}

.red-circle {
    display: inline-block;
    width: 12px;
    height: 12px;
    background-color: red;
    border-radius: 50%;
    margin-right: 5px;
}
    input[type="range"][orient="vertical"] {
    writing-mode: bt-lr; /* IE */
    -webkit-appearance: slider-vertical;
    width: 8px;
    height: 150px;
    margin: 10px auto; /* Center the range input */
}

.control-group {
    margin: 20px 0;
    text-align: center; /* Center the label */
}

.range-container {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center the range input and span vertically */
}


    .small-font {
        font-size: 0.8rem; /* adjust as needed */
   }

    .navbar-scroll .nav-link,
    .navbar-scroll .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #ffffff;
    }

    /* Color of the navbar BEFORE scroll */
    .navbar-scroll {
      background-color: #000000;
        text-decoration-color: #FFFFFF;
    }


    /* Color of the links AFTER scroll */
    .navbar-scrolled .nav-link,
    .navbar-scrolled .navbar-toggler-icon,
    .navbar-scroll .navbar-brand {
      color: #262626;
    }

    .navbar-logo {
    position: absolute;
    top: 5px; /* Adjust this as needed */
    left: 5; /* Adjust this as needed */
    height: 100px; /* Adjust this as needed */
    z-index: 10;
}
        .table-wrap {
          height: 200px;
          overflow-y: auto;
        }

        .small-font {
        font-size: 0.8rem; /* adjust as needed */
        }

    .clickable-label:hover {
        cursor: pointer;
    }

    /* Add a box shadow to the slider thumb */
    input[type="range"]::-webkit-slider-thumb {
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

thead {
  background: linear-gradient(#606062, #28262b);
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  cursor: pointer;
    color: white;
}

    .disabled-label {
        color: #aaa; /* This is a light gray color to represent a disabled label */
        cursor: not-allowed;
    }

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 15px;
  background: #b0acac;
  outline: none;
  border: 3px solid rgba(77, 127, 192, 0.75);
  border-radius: 4px;
}


/* for chrome/safari */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 15px;
  height: 40px;
  background: rgba(77, 127, 192, 0.75);
  cursor: pointer;
  border: 3px solid rgba(77, 127, 192, 0.75);
  border-radius: 4px;
}

/* for firefox */
.slider::-moz-range-thumb {
  width: 20px;
  height: 60px;
  background: #000;
  cursor: pointer;
  border: 5px solid lawngreen;
  border-radius: 4px;
}
    </style>
    <script>


      // Initialize sliders when the page loads
      window.onload = function() {
        initSlider("range_safety", "safetyrange");
        initSlider("range_life", "liferange");
        initSlider("range_production", "productionrange");
        initSlider("range_finance", "financerange");
        initSlider("range_reputation", "reputationrange");
        initSlider("range_environment", "environmentrange");
        initSlider("range_regulatory", "regulatoryrange");
        initSlider("range_data", "datarange");
        initSlider("range_supply", "supplyrange");
        sessionStorage.setItem("ls", "0");

        // init other sliders...
      };

      $(function () {
          $('[data-bs-toggle="tooltip"]').tooltip()
        })
</script>


</head>
<body>

<nav class="navbar navbar-expand-lg navbar-scroll fixed-top shadow-0 border-bottom border-dark rounded">
  <div class="container-fluid d-flex justify-content-between">
   <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}"><img src="/static/images/logo1-2.jpg" style="height: 140px; width: 140px" class="navbar-logo" alt="">  </a>
      <h4 class="my-auto text-center flex-grow-1"><font color="white">CyberPHA</font></h4>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-journal-text"></i> Risk Assessment</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}"><i class="bi bi-journal-text"></i> CyberPHA</a>
        </li>
          <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:ra_actions_view' %}" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Actions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'OTRisk:risk_register' %}" tabindex="-1" ><i class="bi-file-earmark-easel"></i> Risk Register</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-file-earmark-easel"></i> Reports
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports' %}" >QRAW Reports</a></li>
                  <li><a class="dropdown-item" href="{% url 'OTRisk:reports_pha' %}">CyberPHA Reports</a></li>
              </ul>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-diagram-3"></i> Admin
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_scenario' %}">Scenario Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:add_consequence' %}">Consequence Manager</a></li>
                  <li><a  class="dropdown-item" href="{% url 'OTRisk:admin_users' %}">Admin Users</a></li>
                  {% if user.is_staff %}
                    <!-- Links visible only to superusers -->
                    <li><a class="dropdown-item" href="{% url 'OTRisk:user_admin' %}">User Administration</a></li>
                      <li><a class="dropdown-item" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a></li>
                    {% endif %}

              </ul>

        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:profile' %}">
                <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
            </a>
        </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </li>
      </ul>
    </div>
  </div>

</nav>

<form id="cyberpha-form">
{% csrf_token %}

<div class="row" style="height: 10px; padding-top: 20px; background-color: black">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " ></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->
<div class="row" style="height: 10px; padding-top: 20px; background-color: black">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: white" ></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->

<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: white">
    <figure class="text-center">

    <h4><br><br>CyberPHA Scenario Analysis - <span id="facilityName"></span></h4>
        <h6>Risk weightings set to <span id="facilityName2" class="text-decoration-underline text-body-emphasis" data-bs-toggle="tooltip" data-bs-placement="top" title="If the incorrect industry is displayed, return to the 'CyberPHA Manager' screen and select the 'Edit' button for this assessment from the table. Select the correct industry in the Assessment Setup form and save the record before re-selecting it to return to this screen"></span> industry</h6>


    </figure>
    <script>

        document.getElementById('facilityName').textContent = sessionStorage.getItem('sessionFacility');
        document.getElementById('facilityName2').textContent = sessionStorage.getItem('sessionIndustry');


     </script>
    </div>
    <div class="col-md-1" style="background-color: black"></div>
</div>
<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->

<div class="row" style="height: 300px">
    <div class="col-md-1" style="background-color: black">

    </div>
    <div class="col-md-10 " style="background-color: white; padding: 20px">
        <div class="table-wrap rounded-3" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white; height: 250px">
            <table id="userscenarioList" class="table table-hover table-bordered small small-font overflow-auto" style="background-color: white;">
                <thead>
                    <tr>
                        <th rowspan="2">ID</th>
                        <th rowspan="2" style="width: 40%">Scenario</th>
                        <th colspan="9">Impact Assessment Scores (Max = 10)</th>
                        <th rowspan="2">Threat</th>
                        <th rowspan="2">Risk</th>
                        <th rowspan="2"></th>
                    </tr>
                    <tr>
                        <th>Sfty</th>
                        <th>Dgr</th>
                        <th>Env</th>
                        <th>Sup</th>
                        <th>Fin</th>
                        <th>Ops</th>
                        <th>Data</th>
                        <th>Regs</th>
                        <th>Rep</th>
                    </tr>
                </thead>

                <tbody id="userscenarioListBody">
                  {% for saved_scenarios in saved_scenarios %}
                  <tr onclick="fillScenario({{ saved_scenarios.ID}})">
                    <td>{{ saved_scenarios.ID }}</td>
                    <td>{{ saved_scenarios.Scenario }}</td>
                    <td>
                        {% if saved_scenarios.impactSafety < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactSafety >= 4 and saved_scenarios.impactSafety < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactSafety >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactSafety }}
                    </td>

                    <td>
                        {% if saved_scenarios.impactDanger < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactDanger  >= 4 and saved_scenarios.impactDanger  < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactDanger  >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactDanger  }}
                    </td>
                    <td>
                        {% if saved_scenarios.impactEnvironment < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactEnvironment  >= 4 and saved_scenarios.impactEnvironment  < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactEnvironment  >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactEnvironment  }}
                    </td>
                  <td>
                      {% if saved_scenarios.impactSupply < 4 %}
                          <span class="green-circle"></span>
                      {% elif saved_scenarios.impactSupply >= 4 and saved_scenarios.impactSupply < 8 %}
                          <span class="orange-circle"></span>
                      {% elif saved_scenarios.impactSupply >= 8 %}
                          <span class="red-circle"></span>
                      {% endif %}
                      {{ saved_scenarios.impactSupply }}
                  </td>

                    <td>
                        {% if saved_scenarios.impactFinance < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactFinance >= 4 and saved_scenarios.impactFinance < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactFinance >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactFinance }}
                    </td>
                    <td>
                        {% if saved_scenarios.impactProduction < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactProduction >= 4 and saved_scenarios.impactProduction < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactProduction >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactProduction }}
                    </td>
                    <td>
                        {% if saved_scenarios.impactData < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactData >= 4 and saved_scenarios.impactData < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactData >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactData }}
                    </td>
                    <td>
                        {% if saved_scenarios.impactRegulation < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactRegulation >= 4 and saved_scenarios.impactRegulation < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactRegulation >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactRegulation }}
                    </td>
                    <td>
                        {% if saved_scenarios.impactReputation < 4 %}
                            <span class="green-circle"></span>
                        {% elif saved_scenarios.impactReputation >= 4 and saved_scenarios.impactReputation < 8 %}
                            <span class="orange-circle"></span>
                        {% elif saved_scenarios.impactReputation >= 8 %}
                            <span class="red-circle"></span>
                        {% endif %}
                        {{ saved_scenarios.impactReputation }}
                    </td>


                    <td>{{ saved_scenarios.ThreatClass }}</td>
                    <td>{{ saved_scenarios.RiskCategory }}</td>
                    <td>
                        <a href="{% url 'OTRisk:deletescenario' saved_scenarios.ID saved_scenarios.CyberPHA.ID %}"
                           class="btn btn-danger"
                           onclick="return checkDeleteCondition();">Del</a>

                        <script>
                            function checkDeleteCondition() {
                                var lsValue = sessionStorage.getItem("ls");
                                if (lsValue === "1") {
                                    swal("iOTa Scenario Manager", "Changes cannot be made to this scenario because it has been added to the risk register");
                                    return false; // Prevent the default action (i.e., following the link)
                                }
                                return confirm('Are you sure you want to delete this record? (Note that if you proceed, the record will be virtually deleted and can be recovered if necessary)');
                            }
                        </script>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
                <script>


                    // Function to load the vulnerability table component
                    function loadVulnerabilityTable(scenarioId) {
                        // Load the vulnerability table into the specified div container
                        $('#vulnerabilityTableContainer').load('/OTRisk/scenario_vulnerability/' + scenarioId + '/', function () {
                            // Initialize select2 for the asset_type field
                            $('.select2').select2();

                            // Handle form submission asynchronously (if needed)
                            $('#vulnerability-form').on('submit', function (e) {
                                e.preventDefault();
                                $.ajax({
                                    type: 'POST',
                                    url: $(this).attr('action'),
                                    data: $(this).serialize(),
                                    success: function () {
                                        // Refresh the table
                                        loadVulnerabilityTable(scenarioId);
                                    },
                                });
                            });
                        });
                    }
            </script>

        </div>
    </div>
    <div class="col-md-1" style="background-color: black"></div>
</div> <!-- list of user entered scenarios -->




<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->

<!-- put the buttons in here -->
<div class="row small-font" >
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-2" style="background-color: darkgray"></div>
    <div class="col-md-2" style="background-color: darkgray"> <button type="button" id="addScenarioBtn" class="form-control  btn-link" onclick="resetformcontrols()" style="background-color: #0C6EFC; color: white;">New Scenario</button></div>
    <div class="col-md-2" style="background-color: darkgray"><button type="button" class="form-control btn-link" data-bs-toggle="modal" style="background-color: #0C6EFC; color: white;" onclick="processFormData()">Save Scenario</button></div>
    <div class="col-md-2" style="background-color: darkgray">
        <button class="form-control" type="button" id="actionBtn" onclick="showRAActionsModal()" style="background-color: #0C6EFC; color: white;">Add Remediation Action</button>

        <script>
            function showRAActionsModal() {
                var phaid = sessionStorage.getItem('activeCyberPHA');  // Get the value from session storage

                if (phaid === null || phaid === "") {
                    alert("Please select a CyberPHA assessment from the table first before creating an action item.");
                } else {
                    $('#RAActionsModal').modal('show');  // Show the modal if rawid has a value
                }
            }
        </script>
    </div>

    <div class="col-md-2" style="background-color: darkgray"></div>
    <div class="col-md-1" style="background-color: black"></div>
</div>

<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->
<div class="row small-font" >
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10">
        <div class="row" style="background-color: white">
            <p></p>
            <h5><p class="form-container" style="text-align: center; color: #494949">Scenario Selection</p></h5>
        </div>
        <div class ="row" style="background-color: white">
            <div class="col-md-6 d-flex justify-content-center">
                <br><br>
                <div class="table-wrap border border-black rounded p-3" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white;">
                    <table id="scenarioList" class="table table-hover table-bordered small small-font overflow-auto" style="width: 100%; background-color: white">
                        <thead>
                            <tr>
                                <th>Scenario</th>
                            </tr>
                        </thead>
                        <tbody id="scenarioListBody" >
                            {% for scenario in scenarios %}
                            <tr onclick="selectScenario(this)">
                                <td>{{ scenario.Scenario }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <script>
                    $(document).ready(function() {
                        $('#scenarioList').DataTable();
                    });
                </script>
            </div>
            <div class="col-md-6">
                <div class="row  rounded p-3">
                    <textarea id="txtScenario" name="txtScenario" class="form-control" rows="6" placeholder="Select a scenario from the table or enter your own...." style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white"></textarea>
                </div>
            </div>
        </div>

    </div>
    <div class="col-md-1" style="background-color: black"></div>
</div> <!-- scenario list table -->

<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: white; box-shadow: 0px 10px 10px rgba(0, 0, 0, 0.5);"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->
<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->

<div class="row small-font">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10">
        <div class="row" style="background-color: white">
            <p></p>
            <h5><p class="form-container" style="text-align: center; color: #494949">Consequence Selection</p></h5>
        </div>
        <div class ="row" style="background-color: white">
            <div class="col-md-6 d-flex justify-content-center">
                <br><br>
                <div class="table-wrap border border-black rounded p-3" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white;">
                    <table id="consequenceListTable" class="table table-hover table-bordered small small-font overflow-auto" style="width:100%">
                        <thead>
                            <tr>
                                <th>Consequence</th>
                            </tr>
                        </thead>
                        <tbody id="consequenceListTableBody">
                            {% for consequenceList in consequenceList %}
                            <tr onclick="selectConsequence('{{ consequenceList.Consequence }}')">
                                <td>{{ consequenceList.Consequence }}</td>
                              </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <script>
                    $(document).ready(function() {
                        $('#consequenceListTable').DataTable();
                    });
                </script>
            </div>
            <div class="col-md-6">
                <div class="row  rounded p-3">
                    <textarea id="txtConsequence" name="txtConsequence" class="form-control" rows="6" placeholder="Select up to three consequences from the table or enter your own...." style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-1" style="background-color: black"></div>
</div> <!-- consequence list table -->

<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: white; box-shadow: 0px 10px 10px rgba(0, 0, 0, 0.5);"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->

<div class="row" style="height: 10px;">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10" style="background-color: darkgray"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- grey stripe -->

    <input type="hidden" id="hdnID" name="hdnID" >
<input type="hidden" id="hdnScenario" name="hdnScenario" value = {{ scenarioID }}>
<input type="hidden" id="hdnCountry" name="hdnCountry">
<script>

    document.getElementById('hdnCountry').value = sessionStorage.getItem('sessionCountry');

</script>



<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->

<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: white; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->

<!-- vulnerability assessment table -->
<div class="row" >
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10">
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div id="vulnerabilityTableContainer" ></div>
            </div>
        </div>
    </div>
    <!-- Your container content here -->

    <div class="col-md-1" style="background-color: black"></div>
</div>
<div class="row" >
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-5 " style="background-color: white">
    <p></p>
        <label class="form-label" for="threat-intelligence">Threat Source</label>
        <select class="form-control" name="threat-intelligence" id="threat-intelligence" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 10px; background-color: white">
            <option value="">-- Select a threat source --</option>
            {% for threat_intelligence in threat_intelligence %}
                <option value="{{ threat_intelligence.ThreatDescription }}">{{ threat_intelligence.ThreatDescription }}</option>
            {% endfor %}
        </select>
        <br>

        <label  style="display: none">Threat Action</label>
        <select  name="threatactions" id="threatactions" style="display: none;">
        <option value="">Select a threat action</option>

    </select>


    </div>
    <div class="col-md-5 " style="background-color: white" >
    <p></p>
        <label class="form-label" for="risk-category">Risk Category</label>
            <select class="form-control" name="risk-category" id="risk-category" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding:10px; background-color: white">
              <option value="">Select a risk category</option>
              {% for risk_category in risk_categories %}
                <option value="{{ risk_category.CategoryName }}">{{ risk_category.CategoryName }}</option>
              {% endfor %}
            </select>
        <br>
        <label  for="mitigation-measure" style="display: none;">Current Controls</label>
        <select   name="mitigation-measure" id="mitigation-measure"  style="display: none;">
            <option value="">-- Select Controls --</option>

        </select>
    </div>
    <div class="col-md-1 " style="background-color: black"></div>
</div>
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: white; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->

<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->


<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-5" style="background-color: white">
        <p></p>
        <h4 style="display: inline;">Impact Analysis</h4> <span>(click labels to add descriptions)</span>

         <!--slider for safety rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"> <label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#safetyModal" data-modal-id="safetyModal" data-textarea-id="txtsafetyJustify">Safety</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>

                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_safety" name="range_safety" onchange="initSlider('range_safety', 'safetyrange');">
                    </div>
                    <div class="col-3"><label id="safetyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></div>
                </div>
            </div>
        </div>
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <!--slider for Life rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#lifeModal" data-bs-placement="top" data-modal-id="lifeModal" data-textarea-id="txtlifeJustify">Life</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_life" name="range_life" onchange="initSlider('range_life', 'liferange');">
                    </div>
                    <div class="col-3"><h6><label id="liferange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Production impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label for="range_production" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#productionModal" data-bs-placement="top" data-modal-id="productionModal" data-textarea-id="txtproductionJustify">Production</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_production" name="range_production" onchange="initSlider('range_production', 'productionrange');">
                    </div>
                    <div class="col-3"><h6><label id="productionrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                 <!--slider for financial rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#financeModal" data-bs-placement="top" data-modal-id="financeModal" data-textarea-id="txtfinanceJustify">Financial</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_finance" name="range_finance" onchange="initSlider('range_finance', 'financerange');">
                    </div>
                    <div class="col-3"><h6><label id="financerange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for reputation rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#reputationModal" data-bs-placement="top" data-modal-id="reputationModal" data-textarea-id="txtreputationJustify">Reputation</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_reputation" name="range_reputation" onchange="initSlider('range_reputation', 'reputationrange');">
                    </div>
                    <div class="col-3"><h6><label id="reputationrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for environment impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#environmentModal" data-bs-placement="top" data-modal-id="environmentModal" data-textarea-id="txtenvironmentJustify">Environment</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_environment" name="range_environment" onchange="initSlider('range_environment', 'environmentrange');">
                    </div>
                    <div class="col-3"><h6><label id="environmentrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for regulatory impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#regulatoryModal" data-bs-placement="top" data-modal-id="regulatoryModal" data-textarea-id="txtregulatoryJustify">Regulatory</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_regulatory" name="range_regulatory" onchange="initSlider('range_regulatory', 'regulatoryrange');">
                    </div>
                    <div class="col-3"><h6><label id="regulatoryrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for data impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label for="range_data" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#dataModal" data-bs-placement="top" data-modal-id="dataModal" data-textarea-id="txtdataJustify">Data/IP</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_data" name="range_data" onchange="initSlider('range_data', 'datarange');">
                    </div>
                    <div class="col-3"><h6><label id="datarange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label for="range_supply" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#supplyModal" data-bs-placement="top" data-modal-id="supplyModal" data-textarea-id="txtsupplyJustify">Supply Chain</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_supply" name="range_supply" onchange="initSlider('range_supply', 'supplyrange');">
                    </div>
                    <div class="col-3"><h6><label id="supplyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-5" style="background-color: white">
    <p></p>
        <h4>Assessment - Unmitigated Risk</h4>
        <h6>(Risk exposure without current controls)</h6>
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#uelModal" data-bs-placement="top" >Unmitigated Event Likelihood (UEL)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="uel_range" name="uel_range" onchange="initSlider('uel_range','range_uel');">
                    </div>
                    <div class="col-3"><h6><label id="range_uel" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for MEL - Mitigated Exposure Level-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Residual Risk Unmitigated (RRu)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="rru_range" name="rru_range" onchange="initSlider('rru_range','range_rru');">
                    </div>
                    <div class="col-3"><h6><label id="range_rru" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>


        <h4>Assessment - Mitigated Risk</h4>
        <h6>(Risk exposure with current controls)</h6>
                <!--slider for UEL - likelihood without controls-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Severity Mitigated (Sm)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="SMrange" name="SMrange" onchange="initSlider('SMrange','range_SM');">
                    </div>
                    <div class="col-3"><h6><label id="range_SM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for MEL - Mitigated Exposure Level-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Mitigated Exposure (MEL)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="MELrange" name="MELrange" onchange="initSlider('MELrange','range_MEL');">
                    </div>
                    <div class="col-3"><h6><label id="range_MEL" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for MEL - Mitigated Exposure Level-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Residual Risk (RRm)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="RRMrange" name="RRMrange" onchange="initSlider('RRMrange','range_RRM');">
                    </div>
                    <div class="col-3"><h6><label id="range_RRM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <input type="checkbox" id="risk_register" name="risk_register">
                <label for="risk_register">Lock Scenario and Add to Risk Register</label>
            </div>
        </div>

    <div class="row">
        <div class=col-md-6>
            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                <div class="card-body">
                        <label class="form-label" for="selStandards">Standards</label>
                        <select class="form-control" name="selStandards" id="selStandards" title="Select which standards to align with for recommendations">
                        <option value="">-- Select Standard --</option>
                        {% for standardslist in standardslist %}
                            <option value="{{ standardslist.standard }}">{{ standardslist.standard}}</option>
                        {% endfor %}
                        </select>
                </div>
            </div>
        </div>
        <div class=col-md-6>
            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                <div class="card-body">
                    <input type="checkbox" id="risk_snapshot" name="risk_snapshot">
                    <label for="risk_snapshot">Create Snapshot</label>

                </div>
            </div>
            <button id="risk-assessment-btn" type="button" class="form-control btn-dark" style="background-color: dodgerblue; color: white">Assess Scenario</button><br>
            <div id="loadingSpinner" class="spinner-border" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <script>
             // AJAX function call on button click
            $(document).ready(function () {
                $("#risk-assessment-btn").click(function () {
                    // Call the function to assess the risk
                    assessScenario();
                });
            });
            </script>
        </div>
    </div>

    </div>
     <div class="col-md-1" style="background-color: black"></div>
</div>

<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->

<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: white; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->
<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-8">
        <div class="row">
            <div class="col-md-2">
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                <div class="card-body">
                    <label for="control_effectiveness" class="small-font">Control Effectiveness</label>
                    <input type="text" id="control_effectiveness" name="control_effectiveness" class="form-control text-center" readonly>
                    <input type="hidden" id="hdn_control_effectiveness" name="hdn_control_effectiveness">
                    <br>
                    <label for="txtProbability" class="small-font">Attack Success Probability</label>
                    <input type="text" id="txtProbability" name="txtProbability" class="form-control text-center" readonly>
                    <br>
                    <label for="txtLikelihood" class="small-font">Risk Likelihood</label>
                    <input type="text" id="txtLikelihood" name="txtLikelihood" class="form-control text-center" readonly>
                    <input type="hidden" id="hdnLikelihood" name="hdnLikelihood">
                    <br>
                    <label for="txtResidualRisk" class="small-font">Residual Risk</label>
                    <input type="text" id="txtResidualRisk" name="txtResidualRisk" class="form-control text-center" readonly>
                </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                <div class="card-body">
                    <label>Estimated Incident Costs</label><br><br>
                    <label for="txtEventCosts_low" class="small-font">Low (Best Case)</label>
                    <input type="text" id="txtEventCosts_low" name="txtEventCosts_low" class="form-control text-center" readonly>
                    <br>
                    <label for="txtEventCosts" class="small-font">Medium (Expected Case)</label>
                    <input type="text" id="txtEventCosts" name="txtEventCosts" class="form-control text-center" readonly>
                    <br>
                    <label for="txtEventCosts_high" class="small-font">High (Worst Case)</label>
                    <input type="text" id="txtEventCosts_high" name="txtEventCosts_high" class="form-control text-center" readonly>
                </div>
                </div>
            </div>
            <div class="col-md-8">
                <label for="txtScenarioAnalysis" class="small-font">Recommendations will align with selected standards:</label>
                <textarea id="txtScenarioAnalysis" name="txtScenarioAnalysis" class="form-control border border-danger small-font" rows="15"  style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white"></textarea>
            </div>
        </div>

    </div>
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div>

<div class="row">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-5" style="background-color: white">
        <div class="row  rounded p-3 ">

        </div>

    </div>
    <div class="col-md-5" style="background-color: white">
        <div class="row  rounded p-3 ">

        </div>

    </div>
     <div class="col-md-1" style="background-color: black"></div>
</div>
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: white; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- white stripe -->
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: black"></div>
</div> <!-- dark grey stripe -->

<div class="row" hidden="hidden">
    <div class="col-md-1" style="background-color: black"></div>
    <div class="col-md-5" style="background-color: white">
        <h4>Adjusted Risk (After Action)</h4>
                <!--slider for Severity level (Sa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Severity Adjusted(Sa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="SArange" name="SArange" onchange="initSlider('SArange','range_SA');">
                    </div>
                    <div class="col-3"><h6><label id="range_SA" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Mitigated Exposure (MELa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Mitigated Exposure (MELa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="MELarange" name="MELarange" onchange="initSlider('MELarange','range_MELa');">
                    </div>
                    <div class="col-3"><h6><label id="range_MELa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Residual Risk (RRa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Residual Risk (RRa)</label></div>
                    <div class="col-7"><input type="text" id="txtRRa" name="txtRRa" class="form-control">
                      <!-- <input type="range" min="1" max="10" value="1" class="slider" id="RRarange" name="RRarange" onchange="initSlider('RRarange','range_RRa');"> -->
                    </div>
                    <div class="col-3"><h6><label id="range_RRa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>

    </div>
     <div class="col-md-5" style="background-color: white">
        <h4>Quantitative Assessment</h4>
         <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Annualized Rate of Occurrence (ARO):</label></div>
                    <div class="col-7">
                      <input type="range" class="slider" id="aro" name="aro" min="0" max="12" step="1" oninput="updatearoOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="aro" id="aroOutput">0</output></h6></div>
                </div>
             </div>
         </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Event Costs (SLE): </label></div>
                    <div class="col-7">
                        <input type="text" class="slider" id="sle" name="sle" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white">
                        <input type="hidden" id="hdn_sle" name="hdn_sle">
                    </div>

                </div>

            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="form-group">
                    <label for="ale">Annualized Loss Expectancy (ALE):</label>
                    <output id="ale" name="ale">$0</output>
                </div>
            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Cost of Countermeasures:</label></div>
                    <div class="col-7">
                        <input type="range" class="slider" id="countermeasureCostsRange" name="countermeasureCostsRange" min="0" max="1000000" step="1000" oninput="updateCountermeasureCostsOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="countermeasureCostsRange" id="countermeasureCostsOutput">$0</output></h6></div>
                </div>
            </div>
        </div>

          <div class="card mb-3 shadow-sm" style="visibility: hidden"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Security Level (SL)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="sl_range" name="sl_range" onchange="initSlider('sl_range','range_sl');">
                    </div>
                    <div class="col-3"><h6><label id="range_sl" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
         <script>
            function updatearoOutput(value) {
                document.getElementById('aroOutput').textContent = value;

                // Get the value from the hdn_sle field
                let sleValue = parseFloat(document.getElementById('hdn_sle').value);

                // Multiply the sleValue by the provided value
                let result = sleValue * value;

                // Format the result as a US$ amount with no decimal point
                let formattedResult = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(result);

                // Display the formatted result (or set it to any desired element)
                document.getElementById('ale').textContent = formattedResult;

                // Uncomment the next line if you want to call the calculateALE function
                // calculateALE();
            }

            function updateCountermeasureCostsOutput(value) {
              document.getElementById('countermeasureCostsOutput').textContent = value;
            }

            $(document).ready(function() {
              $('#sle').on('input', function() {
                var cost = parseInt($(this).val()).toLocaleString();
                $('#eventCostsOutput').text('$' + cost);
                //calculateALE();
              });

              function calculateALE() {
                var aro = parseInt($('#aro').val());
                var eventCosts = parseInt($('#sle').val());
                var sle = eventCosts;
                var aro = aro;
                var ale = sle * aro;
                $('#ale').text('$' + ale.toLocaleString());
              }
            });
          </script>
    </div>
     <div class="col-md-1" style="background-color: black"></div>
</div>

<script>

      function initSlider(sliderId, outputId) {
        var slider = document.getElementById(sliderId);
        var output = document.getElementById(outputId);

        // Display the default slider value
        output.innerHTML = getSeverityLabel(slider.value);

        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
          output.innerHTML = getSeverityLabel(this.value);
          //calculateRiskScore();
        };
      }

      function getSeverityLabel(value) {
        switch (parseInt(value)) {
          case 1:
            case 2:
            return "Low";
          case 3:
            case 4:
            return "Low/Medium";
          case 5:
            case 6:
            return "Medium";
          case 7:
            case 8:
            return "Medium/High";
          case 9:
            case 10:
            return "High";
          default:
            return "";
        }
      }

      // Initialize sliders
      // initSlider("range_severity", "severityrange");
      // Add more sliders as needed
      // initSlider("another_slider_id", "another_output_id");





        //scoring functions for the gauge controls
    function calculateRiskScore() {

    var severity = parseInt(document.getElementById("range_severity").value);
      var severityWeight = parseInt(document.getElementById("S_Weight").value);
      var frequency = parseInt(document.getElementById("range_frequency").value);
      var frequencyWeight = parseInt(document.getElementById("F_Weight").value);
      var exposure = parseInt(document.getElementById("range_exposure").value);
      var exposureWeight = parseInt(document.getElementById("E_Weight").value);
      var resilience = parseInt(document.getElementById("range_resilience").value);
      var resilienceWeight = parseInt(document.getElementById("R_Weight").value);

      // Calculate the raw score
      var rawScore = (severity * severityWeight) + (frequency * frequencyWeight) + (exposure * exposureWeight) + (resilience * resilienceWeight);

      // Normalize the score between 1 and 10
      var minScore = 0; // Update this if a minimum possible score is defined
      var maxScore = 200; // Update this if a maximum possible score is defined
      var normalizedScore = (rawScore - minScore) / (maxScore - minScore) * 9 + 1;

      // Round the normalized score to two decimal places
      normalizedScore = Math.round(normalizedScore * 100) / 100;

      // Generate the corresponding rating based on the normalized score
      var rating;
      if (normalizedScore <= 2) {
        rating = "Low";
      } else if (normalizedScore <= 4) {
        rating = "Low/Medium";
      } else if (normalizedScore <= 6) {
        rating = "Medium";
      } else if (normalizedScore <= 8) {
        rating = "Medium/High";
      } else {
        rating = "High";
      }

    }

        function calculateUnmitigatedRisk() {

          // Calculate unmitigated risk
            var likelihood = parseInt(document.getElementById("range_UEL").value);
            var severity = parseInt(document.getElementById("range_Unmitigated").value);
            var slt = parseInt(document.getElementById("range_SLT").value);

          const unmitigatedRisk = likelihood * severity;

          // Normalize the unmitigated risk to a score between 0 and 10
          const normalizedScore = (unmitigatedRisk - 1) / 4 * 10;
          // Compare the normalized score with Safety Level Target (SL-T)
          if (normalizedScore <= slt) {
            return 'Low risk';
          } else if (normalizedScore > slt && normalizedScore <= 2 * slt) {
            return 'Medium risk';
          } else {
            return 'High risk';
          }


        }


          // Function to save or update CyberPHA data
        function getCyberPHAReport() {
            const cyberPHAID = sessionStorage.getItem('activeCyberPHA');

            // Create a form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'OTRisk:phascenarioreport' %}";

            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = getCookie('csrftoken');
            form.appendChild(csrfInput);

            // Add cyberPHAID
            const cyberPHAIDInput = document.createElement('input');
            cyberPHAIDInput.type = 'hidden';
            cyberPHAIDInput.name = 'cyberPHAID';
            cyberPHAIDInput.value = cyberPHAID;
            form.appendChild(cyberPHAIDInput);

            // Append the form to body and submit
            document.body.appendChild(form);
            form.submit();
        }



        // Function to save or update CyberPHA data
        function saveOrUpdateCyberPHA(formData) {
          // Get the CSRF token from the cookie
          const csrftoken = getCookie('csrftoken');

          // Create a new XMLHttpRequest object
          const xhr = new XMLHttpRequest();

          // Set up the request
          xhr.open('POST', "{% url 'OTRisk:save_or_update_cyberpha' %}", true);

          xhr.setRequestHeader('X-CSRFToken', csrftoken);


          // Define the callback function for when the request is completed
          xhr.onload = function() {
            if (xhr.status === 200) {
              location.reload()
              // Optionally, perform any additional actions or show a success message
            } else {
              console.error('Failed to save or update CyberPHA data');
              // Optionally, handle the error or show an error message
            }
          };

          // Send the request with the form data
          xhr.send(formData);
          $('#confirmationModal').modal('hide');

        }


        function getCookie(name) {
          const cookieValue = document.cookie
            .split(';')
            .map(cookie => cookie.trim())
            .find(cookie => cookie.startsWith(name + '='));

          if (cookieValue) {
            return cookieValue.split('=')[1];
          }

          return null;
        }

          // Event listener for form submission
          function processFormData() {
              // Check the value of the local session variable named "ls"
              var lsValue = sessionStorage.getItem("ls");
              var riskSnapshotCheckbox = document.getElementById('risk_snapshot');

              if (lsValue === "1") {
                  if (riskSnapshotCheckbox.checked) {
                      swal({
                          title: "iOTa Scenario Manager",
                          text: "The version of this scenario saved to the risk register cannot be changed. You are about to create a snapshot version of the scenario. Do you want to proceed?",
                          icon: "warning",
                          buttons: true,
                          dangerMode: true,
                      })
                          .then((willProceed) => {
                              if (willProceed) {
                                  continueProcessing(true); // Continue with the rest of the function without asking for scenario data save confirmation
                              }
                          });
                  } else {
                      swal("iOTa Scenario Manager", "Changes cannot be made to this scenario because it has been added to the risk register");
                      return; // Exit the function
                  }
              } else {
                  continueProcessing(false); // Continue with the rest of the function and ask for scenario data save confirmation
              }

              function continueProcessing(skipConfirmation) {
                  if (!skipConfirmation) {
                      // Prompt the user for confirmation
                      var isConfirmed = window.confirm("Are you sure you want to save the scenario data?");

                      // If the user clicked "Cancel", exit the function
                      if (!isConfirmed) {
                          return;
                      }
                  }

                  $('#loadingSpinner').show();
                  // Get the values of the form fields
                  const scenario = document.getElementById('txtScenario').value;
                  const consequence = document.getElementById('txtConsequence').value
                  const threatSource = document.getElementById('threat-intelligence').value;
                  const threatactions = document.getElementById('threatactions');
                  let selectedThreatOptions = Array.from(threatactions.selectedOptions).map(option => option.value);
                  const mitigationMeasures = document.getElementById('mitigation-measure');
                  let selectedMitigationOptions = Array.from(mitigationMeasures.selectedOptions).map(option => option.value);
                  const riskCategory = document.getElementById('risk-category').value;
                  const safety = document.getElementById('range_safety').value;
                  const life = document.getElementById('range_life').value;
                  const production = document.getElementById('range_production').value;
                  const financial = document.getElementById('range_finance').value;
                  const reputation = document.getElementById('range_reputation').value;
                  const environment = document.getElementById('range_environment').value;
                  const regulatory = document.getElementById('range_regulatory').value;
                  const supply = document.getElementById('range_supply').value;
                  const data = document.getElementById('range_data').value;
                  const sm = document.getElementById('SMrange').value;
                  const mel = document.getElementById('MELrange').value;
                  const rrm = document.getElementById('RRMrange').value;
                  const sa = document.getElementById('SArange').value;
                  const mela = document.getElementById('MELarange').value;
                  const uel = document.getElementById('uel_range').value;
                  const uel_threat = document.getElementById('uel_threat').value;
                  const uel_vuln = document.getElementById('uel_vuln').value;
                  const uel_exposure = document.getElementById('uel_exposure').value;
                  const rru = document.getElementById('rru_range').value;
                  const sl = document.getElementById('sl_range').value;
                  const cyberpha = sessionStorage.getItem('activeCyberPHA')
                  const recommendations = document.getElementById('txtScenarioAnalysis').value
                  const likelihood = document.getElementById('hdnLikelihood').value
                  const rra = document.getElementById('txtResidualRisk').value
                  const justifySafety = document.getElementById('txtsafetyJustify').value
                  const justifyLife = document.getElementById('txtlifeJustify').value
                  const justifyProduction = document.getElementById('txtproductionJustify').value
                  const justifyFinance = document.getElementById('txtfinanceJustify').value
                  const justifyReputation = document.getElementById('txtreputationJustify').value
                  const justifyEnvironment = document.getElementById('txtenvironmentJustify').value
                  const justifyRegulation = document.getElementById('txtregulatoryJustify').value
                  const justifySupply = document.getElementById('txtsupplyJustify').value
                  const dataRegulation = document.getElementById('txtdataJustify').value
                  //const sle =  document.getElementById('hdn_sle').value
                  const aleValue = document.getElementById('ale').value;
                  let ale = parseInt(aleValue.replace(/[^0-9]/g, ''), 10);
                  const probability = document.getElementById('txtProbability').value;
                  const control_effectiveness = document.getElementById('hdn_control_effectiveness').value;
                  const sle_low = document.getElementById('txtEventCosts_low').value;
                  const sle_high = document.getElementById('txtEventCosts_high').value;
                  const sle_median = document.getElementById('txtEventCosts').value;
                  const standards = document.getElementById('selStandards').value;
                  const aro = document.getElementById('aro').value;
                  const risk_register = document.getElementById('risk_register').checked;
                  const sis_outage = document.getElementById('sisOutageYes').checked;
                  const sis_compromise = document.getElementById('sisIntegrityYes').checked;
                  const safety_hazard = document.getElementById('hazardNature').value;
                  // Check if the "yes" option was selected for outage
                  const outageSelector = document.getElementById('outageYes'); // Replace 'outageSelectorId' with the actual ID of your Yes/No selector
                  const outage = outageSelector.value === "yes" ? "yes" : "no";
                  // If outage is "yes", get the values for outageDuration and outageCost
                  let outageDuration = 0;
                  let outageCost = 0;
                  if (outage === "yes") {
                      outageDuration = parseInt(document.getElementById('outageDuration').value, 10); // Replace 'outageDurationId' with the actual ID of your outage duration input
                      outageCost = parseInt(document.getElementById('outageCost').value, 10); // Replace 'outageCostId' with the actual ID of your outage cost input
                  }
                  var sid = sessionStorage.getItem('sid');
                    if (!sid) {
                        sid = 0;
                    }
                  // Create a FormData object
                  const formData = new FormData();
                  formData.append('scenarioID', sid);
                  formData.append('sis_outage', sis_outage);
                  formData.append('sis_compromise', sis_compromise);
                  formData.append('safety_hazard', safety_hazard);
                  formData.append('scenario', scenario);
                  formData.append('consequence', consequence);
                  formData.append('threatSource', threatSource);
                  formData.append('threatAction', selectedThreatOptions);
                  formData.append('mitigationMeasures', selectedMitigationOptions);
                  formData.append('riskCategory', riskCategory);
                  formData.append('safety', safety);
                  formData.append('life', life);
                  formData.append('production', production);
                  formData.append('financial', financial);
                  formData.append('reputation', reputation);
                  formData.append('environment', environment);
                  formData.append('regulatory', regulatory);
                  formData.append('data', data);
                  formData.append('supply', supply);
                  formData.append('sm', sm);
                  formData.append('mel', mel);
                  formData.append('rrm', rrm);
                  formData.append('sa', sa);
                  formData.append('mela', mela);
                  formData.append('rra', rra);
                  formData.append('aro', aro);
                  formData.append('uel', uel);
                  formData.append('uel_threat', uel_threat);
                  formData.append('uel_vuln', uel_vuln);
                  formData.append('uel_exposure', uel_exposure);
                  formData.append('rru', rru);
                  formData.append('sl', sl);
                  formData.append('recommendations', recommendations)
                  formData.append('cyberpha', cyberpha);
                  formData.append('justifySafety', justifySafety);
                  formData.append('justifyLife', justifyLife);
                  formData.append('justifyProduction', justifyProduction);
                  formData.append('justifyFinance', justifyFinance);
                  formData.append('justifyReputation', justifyReputation);
                  formData.append('justifyEnvironment', justifyEnvironment);
                  formData.append('justifyRegulation', justifyRegulation);
                  formData.append('dataRegulation', dataRegulation);
                  formData.append('justifySupply', justifySupply);
                  formData.append('sle_low', sle_low);
                  formData.append('sle_median', sle_median);
                  formData.append('sle_high', sle_high);
                  formData.append('ale', ale);
                  formData.append('outage', outage);
                  formData.append('outageDuration', outageDuration);
                  formData.append('outageCost', outageCost);
                  formData.append('probability', probability);
                  formData.append('control_effectiveness', control_effectiveness);
                  formData.append('standards', standards);
                  formData.append('risk_register', risk_register);
                  formData.append('likelihood', likelihood);
                    // Check if snapshot should be created
                  let snapshot = 0
                  const riskSnapshotCheckbox = document.getElementById('risk_snapshot');
                  if (riskSnapshotCheckbox.checked) {
                        snapshot = 1;
                    }
                  formData.append('snapshot', snapshot);
                  // Call the saveOrUpdateCyberPHA function
                  saveOrUpdateCyberPHA(formData);

                  $('#loadingSpinner').hide();
              }
          }
    </script>

<div class="modal fade" id="safetyModal" tabindex="-1" aria-labelledby="safetyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="safetyModal_Label">Justification for Safety Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- Drop-down select control for the nature of the safety hazard -->
        <label for="hazardNature">Nature of Safety Hazard:</label>
        <select id="hazardNature" name="hazardNature" class="form-control mb-3">
            <option value="">-- Select Hazard --</option>
          <option value="Chemical">Chemical</option>
          <option value="Electrical">Electrical</option>
          <option value="Mechanical">Mechanical</option>
          <option value="Radiation">Radiation</option>
        </select>

        <!-- Yes/no option for SIS Outage -->
        <div class="mb-3">
          <label>SIS Outage:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageYes" value="yes">
            <label class="form-check-label" for="sisOutageYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageNo" value="no">
            <label class="form-check-label" for="sisOutageNo">No</label>
          </div>
        </div>

        <!-- Yes/no option for SIS Integrity Compromise -->
        <div class="mb-3">
          <label>SIS Integrity Compromise:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrityYes" id="sisIntegrityYes" value="yes">
            <label class="form-check-label" for="sisIntegrityYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrityNo" id="sisIntegrityNo" value="no">
            <label class="form-check-label" for="sisIntegrityNo">No</label>
          </div>
        </div>

        <!-- Textarea for justification -->
        <label for="txtsafetyJustify">Justification:</label>
        <textarea id="txtsafetyJustify" name="txtsafetyJustify" class="form-control mb-3" rows="3" style="resize: none"></textarea>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="lifeModal" tabindex="-1" aria-labelledby="lifeModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="lifeModal_Label">Justification for Danger-to-Life Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtlifeJustify" name="txtlifeJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="productionModal" tabindex="-1" aria-labelledby="productionModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productionModal_Label">Justification for Production Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtproductionJustify" name="txtproductionJustify" class="form-control" rows="3" style="resize: none"></textarea>

        <!-- 1. Yes/No selector -->
        <div class="mt-3">
          <label>Is there going to be an outage expected?</label><br>
          <input type="radio" id="outageYes" name="outage" value="yes" onclick="toggleOutageControls(true)">
          <label for="outageYes">Yes</label><br>
          <input type="radio" id="outageNo" name="outage" value="no" onclick="toggleOutageControls(false)">
          <label for="outageNo">No</label>
        </div>

        <!-- 2. Number input for length of time -->
        <div class="mt-3" id="outageDurationDiv" style="display: none;">
          <label for="outageDuration">Estimate length of time of the outage (hours):</label>
          <input type="number" id="outageDuration" name="outageDuration" class="form-control" min="1">
        </div>

        <!-- 3. Text input for cost per hour -->
        <div class="mt-3" id="outageCostDiv" style="display: none;">
          <label for="outageCost">Cost per hour of outage (if known): </label>
          <input type="text" id="outageCost" name="outageCost" class="form-control">
        </div>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleOutageControls(isVisible) {
    const durationDiv = document.getElementById('outageDurationDiv');
    const costDiv = document.getElementById('outageCostDiv');
    if (isVisible) {
      durationDiv.style.display = 'block';
      costDiv.style.display = 'block';
    } else {
      durationDiv.style.display = 'none';
      costDiv.style.display = 'none';
    }
  }
</script>

<div class="modal fade" id="financeModal" tabindex="-1" aria-labelledby="financeModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="financeModal_Label">Justification for Financial Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtfinanceJustify" name="txtfinanceJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="reputationModal" tabindex="-1" aria-labelledby="reputationModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reputationModal_Label">Justification for Reputation Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtreputationJustify" name="txtreputationJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="environmentModal" tabindex="-1" aria-labelledby="environmentModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="environmentModal_Label">Justification for Environment Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtenvironmentJustify" name="txtenvironmentJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="regulatoryModal" tabindex="-1" aria-labelledby="regulatoryModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="regulatoryModal_Label">Justification for Regulatory Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtregulatoryJustify" name="txtregulatoryJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModal_Label">Justification for Data Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtdataJustify" name="txtdataJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="supplyModal" tabindex="-1" aria-labelledby="supplyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="supplyModal_Label">Justification for Supply Chain Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtsupplyJustify" name="txtsupplyJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="uelModal" tabindex="-1" aria-labelledby="uelModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uelModal_Label">UEL Assessment</h5>
        <!-- Threat Capability -->
        <div class="control-group">
          <label for="threatCapability">Threat Capability:</label>
          <div class="range-container">
            <input type="range" id="uel_threat" name="uel_threat" min="1" max="10" step="1" orient="vertical">
            <span id="threatLabel">Low Skills</span>
          </div>
        </div>

        <!-- Vulnerability Presence -->
        <div class="control-group">
          <label for="vulnerabilityPresence">Vulnerability Presence:</label>
          <div class="range-container">
            <input type="range" id="uel_vuln" name="uel_vuln" min="0" max="10" step="1" orient="vertical">
            <span id="vulnerabilityLabel">No Vulnerabilities</span>
          </div>
        </div>

        <!-- System Exposure -->
        <div class="control-group">
          <label for="systemExposure">System Exposure:</label>
          <div class="range-container">
            <input type="range" id="uel_exposure" name="uel_exposure" min="0" max="10" step="1" orient="vertical">
            <span id="exposureLabel">No Exposure</span>
          </div>
        </div>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
    // Function to update labels based on range values
    function updateLabels() {
        // Threat Capability
        let threatValue = $('#uel_threat').val();
        let threatLabel = "Low Skills";
        if (threatValue <= 3) threatLabel = "Low Skills";
        else if (threatValue <= 5) threatLabel = "Moderate Skills";
        else if (threatValue <= 7) threatLabel = "Advanced Skills";
        else if (threatValue <= 9) threatLabel = "Expert";
        else threatLabel = "Highly Skilled";
        $('#threatLabel').text(threatLabel);

        // Vulnerability Presence
        let vulnerabilityValue = $('#uel_vuln').val();
        let vulnerabilityLabel = "No Vulnerabilities";
        if (vulnerabilityValue <= 3) vulnerabilityLabel = "Minor Vulnerabilities";
        else if (vulnerabilityValue <= 5) vulnerabilityLabel = "Some Vulnerabilities";
        else if (vulnerabilityValue <= 7) vulnerabilityLabel = "Major Vulnerabilities";
        else if (vulnerabilityValue <= 9) vulnerabilityLabel = "Critical Vulnerabilities";
        else vulnerabilityLabel = "Easily Exploitable Vulnerabilities";
        $('#vulnerabilityLabel').text(vulnerabilityLabel);

        // System Exposure
        let exposureValue = $('#uel_exposure').val();
        let exposureLabel = "No Exposure";
        if (exposureValue <= 3) exposureLabel = "Minimal Exposure";
        else if (exposureValue <= 5) exposureLabel = "Moderate Exposure";
        else if (exposureValue <= 7) exposureLabel = "Significant Exposure";
        else if (exposureValue <= 9) exposureLabel = "High Exposure";
        else exposureLabel = "Unrestricted External Exposure";
        $('#exposureLabel').text(exposureLabel);
    }

    // Function to compute and set the overall UEL score
    function computeAndSetUEL() {
        let threatValue = parseInt($('#uel_threat').val());
        let vulnerabilityValue = parseInt($('#uel_vuln').val());
        let exposureValue = parseInt($('#uel_exposure').val());

        // Compute the average
        let overallUEL = Math.round((threatValue + vulnerabilityValue + exposureValue) / 3);

        // Set the value to the uel_range control
        $('#uel_range').val(overallUEL);
    }

    // Event listeners for the range controls
    $('#uel_threat, #uel_vuln, #uel_exposure').on('input', function() {
        updateLabels();
        computeAndSetUEL();
        initSlider('uel_range','range_uel');
    });
});


</script>
</form>

<!-- RAActionsModal.html -->
<div class="modal fade" id="RAActionsModal" tabindex="-1" aria-labelledby="RAActionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="RAActionsModalLabel">Mitigate Risk:</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
            <form id="raActionsForm">
                {% csrf_token %}
                <input type="hidden" name="hdnphaID" id="hdnphaID">
                <input type="hidden" name="hdntxtModalRAW" id="hdntxtModalRAW" value="0">

                <!-- Action Title -->
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionTitle" class="form-label">Headline</label>
                            <input type="text" class="form-control" id="actionTitle" name="actionTitle" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionOwner" class="form-label">Risk Owner</label>
                                    <input type="text" class="form-control" id="actionOwner" name="actionOwner" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDate" class="form-label">Action Date</label>
                                    <input type="date" class="form-control" id="actionDate" name="actionDate" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionEffort" class="form-label">Effort Level:</label>
                                    <Select class="form-control" id="actionEffort" name="actionEffort">
                                            <option value="">-- Select Costs --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                                </div>
                            </div>
                        </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDifficulty" class="form-label">Difficulty Level</label>
                                    <Select class="form-control" id="actionDifficulty" name="actionDifficulty">
                                            <option value="">-- Select Costs --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>

                                </div>
                            </div>
                        </div>
                    </div>
                    </div>


                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionCost" class="form-label">Estimated Cost</label>
                                    <Select class="form-control" id="actionCost" name="actionCost">
                                            <option value="">-- Select Costs --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionAffinity" class="form-label">Risk Mitigation</label>
                                    <Select class="form-control" id="actionAffinity" name="actionAffinity">
                                            <option value="">-- Select Costs --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionStatus" class="form-label">Status</label>
                                    <input type="text" class="form-control" id="actionStatus" name="actionStatus" readonly value="Open">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionDescription" class="form-label">Description</label>
                            <textarea id="actionDescription" name="actionDescription" class="form-control" rows="3" style="resize: none"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionPriority" class="form-label">Urgency</label>
                                        <select class="form-control" id="actionPriority" name="actionPriority">
                                            <option value="0">-- Select Urgency --</option>
                                            <option value="1">Low</option>
                                            <option value="2">Medium</option>
                                            <option value="3">High</option>
                                            <option value="4">Critical</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDueDate" class="form-label">Target Date</label>
                                    <input type="date" class="form-control" id="actionDueDate" name="actionDueDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Assets -->
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionAssets" class="form-label">Action Assets</label>
                            <textarea id="actionAssets" name="actionAssets" class="form-control" rows="3" style="resize: none"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageSIS" class="form-label">Safety (SIS) Outage:</label>
                                        <select class="form-control" id="outageSIS" name="outageSIS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageICS" class="form-label">Control System (SCADA/ICS) Outage:</label>
                                        <select class="form-control" id="outageICS" name="outageICS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageEMS" class="form-label">Environmental (EMS) Outage:</label>
                                        <select class="form-control" id="outageEMS" name="outageEMS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageIT" class="form-label">IT Outage:</label>
                                        <select class="form-control" id="outageIT" name="outageIT">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outagePS" class="form-label">Physical Security Outage:</label>
                                        <select class="form-control" id="outagePS" name="outagePS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageWWW" class="form-label">Internet Outage:</label>
                                        <select class="form-control" id="outageWWW" name="outageWWW">
                                            <option value="0">-- Select Option --</option>
                                            <option value="1">Yes</option>
                                            <option value="2">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitRAActionForm();">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </form>
        </div>
        <!-- ... (rest of the modal code) ... -->

    </div>
  </div>
</div>
<script>
    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });

    function submitRAActionForm() {
        $.ajax({
            type: "POST",
            url: "{% url 'OTRisk:save_ra_action' %}",
            data: $("#raActionsForm").serialize(),
            success: function(response) {
                if (response.status == "success") {
                    $("#RAActionsModal").modal('hide');
                    // Optionally, show a success message or perform other actions.
                } else {
                    alert("Error saving data!");
                }
            }
        });
    }
</script>




    <script>

        // Function to add a new scenario row to the table
        function addScenarioRow() {
            try {
                var scenarioCount = document.querySelectorAll('#scenarioTable tbody tr').length + 1;
                var row = document.createElement('tr');
                row.id = 'scenarioRow' + scenarioCount;

                // Create table cells for each field
                var assessmentNameCell = document.createElement('td');
                var scenarioCell = document.createElement('td');
                var controlObjectiveCell = document.createElement('td');
                var riskCategoryCell = document.createElement('td');
                var mitigationMeasuresCell = document.createElement('td');
                var likelihoodCell = document.createElement('td');
                var impactCell = document.createElement('td');
                var riskLevelCell = document.createElement('td');

                // Create form elements for each field
                var assessmentNameInput = document.createElement('input');
                assessmentNameInput.type = 'text';
                assessmentNameInput.name = 'assessment_name';
                assessmentNameCell.appendChild(assessmentNameInput);

                var scenarioInput = document.createElement('input');
                scenarioInput.type = 'text';
                scenarioInput.name = 'scenarios[' + scenarioCount + '][scenario]';
                scenarioCell.appendChild(scenarioInput);

                var controlObjectiveSelect = document.createElement('select');
                controlObjectiveSelect.name = 'scenarios[' + scenarioCount + '][control_objective]';
                // Populate control objectives dynamically

                var riskCategorySelect = document.createElement('select');
                riskCategorySelect.name = 'scenarios[' + scenarioCount + '][CategoryName]';
                // Populate risk categories dynamically


                var mitigationMeasuresSelect = document.createElement('select');
                mitigationMeasuresSelect.name = 'scenarios[' + scenarioCount + '][mitigation_measures]';
                // Populate mitigation measures dynamically

                var likelihoodInput = document.createElement('input');
                likelihoodInput.type = 'number';
                likelihoodInput.name = 'scenarios[' + scenarioCount + '][likelihood]';
                likelihoodCell.appendChild(likelihoodInput);

                var impactInput = document.createElement('input');
                impactInput.type = 'number';
                impactInput.name = 'scenarios[' + scenarioCount + '][impact]';
                impactCell.appendChild(impactInput);

                var riskLevelInput = document.createElement('input');
                riskLevelInput.type = 'text';
                riskLevelInput.name = 'scenarios[' + scenarioCount + '][risk_level]';
                riskLevelInput.disabled = true;
                riskLevelCell.appendChild(riskLevelInput);

                // Append form elements to the cells
                assessmentNameCell.appendChild(assessmentNameInput);
                scenarioCell.appendChild(scenarioInput);
                controlObjectiveCell.appendChild(controlObjectiveSelect);
                riskCategoryCell.appendChild(riskCategorySelect);
                mitigationMeasuresCell.appendChild(mitigationMeasuresSelect);
                likelihoodCell.appendChild(likelihoodInput);
                impactCell.appendChild(impactInput);
                riskLevelCell.appendChild(riskLevelInput);

                // Append cells to the row
                row.appendChild(assessmentNameCell);
                row.appendChild(scenarioCell);
                row.appendChild(controlObjectiveCell);
                row.appendChild(riskCategoryCell);
                row.appendChild(mitigationMeasuresCell);
                row.appendChild(likelihoodCell);
                row.appendChild(impactCell);
                row.appendChild(riskLevelCell);

                // Append row to the table
                document.getElementById('scenarioTable').appendChild(row);
            } catch (error) {

            }
        }

        // Event listener for adding a new scenario row
        document.getElementById('addScenarioBtn').addEventListener('click', function() {
            addScenarioRow();
        });



        // Function to fetch and populate the mitigation measures dynamically
        function populateMitigationMeasures(controlObjectiveSelect) {
            fetch('/OTRisk/get_mitigation_measures/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(measure => {
                        let option = document.createElement('option');
                        option.value = measure;
                        option.text = measure;
                        controlObjectiveSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.log('Error fetching mitigation measures:', error);
                });
        }

        // Event listener to populate the mitigation measures when the control objective is selected
        document.addEventListener('change', function(event) {
            const element = event.target;
            if (element.tagName === 'SELECT' && element.name.includes('control_objective')) {
                const controlObjectiveSelect = element;
                const mitigationMeasuresSelect = controlObjectiveSelect.closest('tr').querySelector('select[name$="[mitigation_measures]"]');
                // Clear previous options
                while (mitigationMeasuresSelect.firstChild) {
                    mitigationMeasuresSelect.removeChild(mitigationMeasuresSelect.firstChild);
                }
                // Populate mitigation measures based on selected control objective
                populateMitigationMeasures(mitigationMeasuresSelect);
            }
        });

        $(".slider")

        $(document).ready(function() {


          });

         // AJAX function to call the Django view
        function assessScenario() {
            $('#loadingSpinner').show();
            let cpha = sessionStorage.getItem('activeCyberPHA');
            let scenario = document.getElementById('txtScenario').value;
            let consequence = document.getElementById('txtConsequence').value
            let threatsource = document.getElementById('threat-intelligence').value;
            let threatactions = document.getElementById('threatactions');
            let selectedThreatOptions = Array.from(threatactions.selectedOptions).map(option => option.value);
            let mitigationMeasures = document.getElementById('mitigation-measure');
            let selectedMitigationOptions = Array.from(mitigationMeasures.selectedOptions).map(option => option.value);
            let riskCategory = document.getElementById('risk-category').value;
            let safety = document.getElementById('range_safety').value;
            let life = document.getElementById('range_life').value;
            let production = document.getElementById('range_production').value;
            let financial = document.getElementById('range_finance').value;
            let reputation = document.getElementById('range_reputation').value;
            let environment = document.getElementById('range_environment').value;
            let regulatory = document.getElementById('range_regulatory').value;
            let data = document.getElementById('range_data').value;
            let supply = document.getElementById('range_supply').value;
            let sm = document.getElementById('SMrange').value;
            let mel = document.getElementById('MELrange').value;
            let rrm = document.getElementById('RRMrange').value;
            let sa = document.getElementById('SArange').value;
            let mela = document.getElementById('MELarange').value;
            let industry = sessionStorage.getItem('sessionIndustry')
            let facilityType = sessionStorage.getItem('sessionFacilityType')
            let standards = document.getElementById('selStandards').value;
            let country = document.getElementById('hdnCountry').value;
            let uel = document.getElementById('uel_range').value

            // Make the AJAX call to the Django view using a separate endpoint for risk assessment
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:scenario_analysis' %}",  // URL for the Django view
                data: {
                    // Pass the impact scores and scenario information as parameters
                    industry: industry,
                    facility_type: facilityType,
                    scenario: scenario,
                    consequence: consequence,
                    threatsource: threatsource,
                    selectedThreatOptions: selectedThreatOptions,
                    selectedMitigationOptions: selectedMitigationOptions,
                    safety: safety,
                    life: life,
                    production: production,
                    reputation: reputation,
                    environment: environment,
                    regulatory: regulatory,
                    data: data,
                    sm: sm,
                    mel: mel,
                    rrm: sa,
                    standards: standards,
                    supply: supply,
                    country: country,
                    uel: uel,
                    financial: financial,
                    cpha: cpha
                },
                success: function (response) {

                   //document.getElementById('SArange').value = response.adjustedSeverity;
                   //document.getElementById('MELarange').value = response.adjustedExposure;
                   document.getElementById('txtRRa').value = response.adjustedRR
                   document.getElementById('hdnLikelihood').value = response.likelihood;
                   document.getElementById('txtLikelihood').value = response.likelihood +'%';
                   document.getElementById('txtScenarioAnalysis').value = response.recommendations;
                   let costsString = response.costs;
                   let costsArray = costsString.split('|');
                   let sle_low = costsArray.length > 0 && costsArray[0] ? `$${parseInt(costsArray[0]).toLocaleString()}` : "$0";
                   let sle_medium = costsArray.length > 1 && costsArray[1] ? `$${parseInt(costsArray[1]).toLocaleString()}` : "$0";
                   let sle_high = costsArray.length > 2 && costsArray[2] ? `$${parseInt(costsArray[2]).toLocaleString()}` : "$0";
                    document.getElementById('txtEventCosts').value = sle_medium;
                    document.getElementById('txtEventCosts_low').value = sle_low;
                    document.getElementById('txtEventCosts_high').value = sle_high;

                    // Remove any non-numeric characters (like commas and dollar signs) and parse the value as a float
                    //let costsFloat = parseFloat(costsString.replace(/[^0-9.-]+/g, ""));

                    // Format the float value as a currency string
                    //let formattedCosts = new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(costsFloat);

                    // Set the formatted string value to the 'sle' field
                    //document.getElementById('sle').value = formattedCosts;

                    // Set the float value to the hidden 'hdn_sle' field
                    //document.getElementById('hdn_sle').value = costsFloat;
                    document.getElementById('txtProbability').value = response.probability;

                    document.getElementById('hdn_control_effectiveness').value = response.control_effectiveness;

                    var controlEffectivenessPercentage = response.control_effectiveness;

                    // Define the text values based on the percentage range
                    var textValue = "";
                    if (controlEffectivenessPercentage < 25) {
                        textValue = "Low";
                    } else if (controlEffectivenessPercentage < 50) {
                        textValue = "Low/Medium";
                    } else if (controlEffectivenessPercentage < 75) {
                        textValue = "Medium";
                    } else if (controlEffectivenessPercentage < 90) {
                        textValue = "Medium/High";
                    } else {
                        textValue = "High";
                    }

                    // Set the value of the 'control_effectiveness' text control
                    document.getElementById('control_effectiveness').value = textValue;
                    //document.getElementById('txtEventCosts').value = formattedCosts;
                    document.getElementById('txtResidualRisk').value = response.adjustedRR

                     $('#loadingSpinner').hide();

                },
                error: function (xhr, status, error) {
                    // Handle any errors that occur during the AJAX call
                    console.error(error);
                    $('#loadingSpinner').hide();
                },
            });
        }

document.getElementById('hdnphaID').value = sessionStorage.getItem('activeCyberPHA');

document.addEventListener("DOMContentLoaded", function() {
    // Function to update the indicator
    function updateIndicator(textarea, indicator) {
        if (textarea.value.trim() !== "") {
            indicator.style.display = "inline";
        } else {
            indicator.style.display = "none";
        }
    }

    // Get all labels with the data-modal-id attribute
    const labels = document.querySelectorAll('[data-modal-id]');

    labels.forEach(label => {
        const modalId = label.getAttribute('data-modal-id');
        const textareaId = label.getAttribute('data-textarea-id');
        const textarea = document.getElementById(textareaId);
        const indicator = label.nextElementSibling; // Assuming the indicator is the next sibling of the label

        // Check on modal close
        $('#' + modalId).on('hidden.bs.modal', function (e) {
            updateIndicator(textarea, indicator);
        });

        // Check on textarea change

        textarea.addEventListener('input', function() {
            console.log(textarea);
            console.log(indicator);
            updateIndicator(textarea, indicator);
        });
    });
});


function resetformcontrols() {
  swal({
    title: "New Scenario",
    text: "Are you sure you want to begin a new scenario and reset the form? All unsaved changes will be lost.",
    icon: "warning",
    buttons: ["No", "Yes"],
    dangerMode: true,
  }).then((isConfirmed) => {
    if (isConfirmed) {
      // Reset form fields here
      document.getElementById('txtScenario').value = '';
      document.getElementById('txtConsequence').value = '';
      document.getElementById('threat-intelligence').value = '';
      document.getElementById('risk-category').value = '';
      document.getElementById('range_safety').value = 0;
      document.getElementById('range_life').value = 0;
      document.getElementById('range_production').value = 0;
      document.getElementById('range_finance').value = 0;
      document.getElementById('range_reputation').value = 0;
      document.getElementById('range_environment').value = 0;
      document.getElementById('range_regulatory').value = 0;
      document.getElementById('range_data').value = 0;
      document.getElementById('range_supply').value = 0;
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtsafetyJustify').value = '';
      document.getElementById('hazardNature').value = '';
      document.getElementById('sisOutageYes').checked = false;
      document.getElementById('sisOutageNo').checked = true;
      document.getElementById('sisIntegrityYes').checked = false;
      document.getElementById('sisIntegrityNo').checked = true;
      document.getElementById('txtlifeJustify').value = '';
      document.getElementById('txtproductionJustify').value = '';
      document.getElementById('txtfinanceJustify').value = '';
      document.getElementById('txtreputationJustify').value = '';
      document.getElementById('txtenvironmentJustify').value = '';
      document.getElementById('txtregulatoryJustify').value = '';
      document.getElementById('txtdataJustify').value = '';
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtScenarioAnalysis').value = 0;
      document.getElementById('txtLikelihood').value = 0;
      document.getElementById('hdnLikelihood').value = 0;
      document.getElementById('txtRRa').value = 0;
      document.getElementById('txtProbability').value = '';
      document.getElementById('control_effectiveness').value = '';
      document.getElementById('hdn_control_effectiveness').value = '';
      document.getElementById('txtEventCosts_low').value = '';
      document.getElementById('txtEventCosts').value = '';
      document.getElementById('txtEventCosts_high').value = '';
      document.getElementById('txtResidualRisk').value = '';
      sessionStorage.setItem('ls', '0');

      try {
        clearVulnerabilityTable();
      } catch (error) {
        console.error('Error clearing vulnerability table:', error);
      }
    }
  });
}


 function fillScenario(scenarioId) {
     sessionStorage.setItem('sid', scenarioId);
    $('#threatactions').val([]);
    $('#threatactions').trigger('change');

    // Send a GET request to the getSingleScenario view
    $.get("{% url 'OTRisk:getSingleScenario' %}", { id: scenarioId }, function(data) {
         if (data.risk_register === true) {
            sessionStorage.setItem("ls", "1");
            $('#risk_register').prop('checked', true);
        } else {
            sessionStorage.setItem("ls", "0");
            $('#risk_register').prop('checked', false);
        }
        // Fill the form fields with the returned data
        $('#txtScenario').val(data.Scenario);
        $('#txtConsequence').val(data.Consequence);
        $('#threat-intelligence').val(data.ThreatClass);
        $('#selStandards').val(data.standards);
        // Split the Countermeasures string into an array and set the selected values of the dropdown

        $('#mitigation-measure').empty(); // Clear existing options
        $('#mitigation-measure').append($('<option>', { // Add the default option
            value: "",
            text: "-- Select Controls --"
        }));
        $.each(data.all_mitigation_measures, function(index, value) {
            $('#mitigation-measure').append($('<option>', {
                value: value,
                text: value
            }));
        });


        var threatactionsArray = data.ThreatAction.split(',');
        $('#threatactions').val(threatactionsArray);
        $('#threatactions').trigger('change');

         $('#risk-category').val(data.RiskCategory);
         $('#range_safety').val(data.impactSafety);
         $('#range_life').val(data.impactDanger);
         $('#range_production').val(data.impactProduction);
         $('#range_finance').val(data.impactFinance);
         $('#range_reputation').val(data.impactReputation);
         $('#range_environment').val(data.impactEnvironment);
         $('#range_regulation').val(data.impactRegulation);
         $('#range_data').val(data.impactData);
         // $('#selStandards').val(data.RiskCategory);

        $('#txtScenarioAnalysis').val(data.recommendations);
        $('#SMrange').val(data.SM);
        $('#MELrange').val(data.MEL);
        $('#RRMrange').val(data.RRM);
        $('#SArange').val(data.SA);
        $('#MELarange').val(data.MELA);
        $('#uel_range').val(data.UEL);
        $('#uel_vuln').val(data.uel_vuln);
        $('#uel_exposure').val(data.uel_exposure);
        $('#uel_threat').val(data.uel_threat);

        $('#sle').val(data.sle);


        let costs = parseFloat(data.sle); // Assuming response.costs is a string representation of a number
        let formattedCosts = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs);

        document.getElementById('sle').value = formattedCosts;
        document.getElementById('txtEventCosts').value= formattedCosts;
        let costs_low = parseFloat(data.sle_low); // Assuming response.costs is a string representation of a number
        let formattedCosts_low = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_low);
        document.getElementById('txtEventCosts_low').value= formattedCosts_low;
        let costs_high = parseFloat(data.sle_high); // Assuming response.costs is a string representation of a number
        let formattedCosts_high = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_high);
        document.getElementById('txtEventCosts_high').value= formattedCosts_high;

        document.getElementById('txtResidualRisk').value= data.RRa;
        document.getElementById('txtProbability').value= data.probability;
        document.getElementById('hdn_control_effectiveness').value= data.control_effectiveness;
        // Define the text values based on the percentage range
                    var textValue = "";
                    if (data.control_effectiveness < 25) {
                        textValue = "Low";
                    } else if (data.control_effectiveness < 50) {
                        textValue = "Low/Medium";
                    } else if (data.control_effectiveness < 75) {
                        textValue = "Medium";
                    } else if (data.control_effectiveness < 90) {
                        textValue = "Medium/High";
                    } else {
                        textValue = "High";
                    }

                    // Set the value of the 'control_effectiveness' text control
                    document.getElementById('control_effectiveness').value = textValue;
        document.getElementById('hdnScenario').value = scenarioId;

         $('#txtRRa').val(data.RRa);
         $('#hdnLikelihood').val(data.likelihood);
        $('#txtLikelihood').val(data.likelihood + '%');
        $('#txtdataJustify').val(data.justifyData);
        $('#txtregulatoryJustify').val(data.justifyRegulation);
        $('#txtenvironmentJustify').val(data.justifyEnvironment);
        $('#txtreputationJustify').val(data.justifyReputation);
        $('#txtfinanceJustify').val(data.justifyFinancial);
        $('#txtproductionJustify').val(data.justifyProduction);
        $('#txtlifeJustify').val(data.justifyLife);
        $('#txtsafetyJustify').val(data.justifySafety)
        $('#hazardNature').val(data.safety_hazard)
        if (data.sis_compromise) {
          $('#sisIntegrityYes').prop('checked', true);
        } else {
          $('#sisIntegrityNo').prop('checked', true);
        }
        if (data.sis_outage) {
          $('#sisOutageYes').prop('checked', true);
        } else {
          $('#sisOutageNo').prop('checked', true);
        }

        loadVulnerabilityTable(scenarioId);

         });

    }
</script>





</body>
</html>
