{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>

<title>AnzenOT - GRC for OT</title>
<link rel="stylesheet" type="text/css" href="{%  static 'css/phascenariomgr.css' %}">

<link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">
<script src="https://d3js.org/d3.v6.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Load jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-linear-gauge.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/> <!-- FontAwesome CDN -->
 <link rel="stylesheet" href="{% static 'tooltipster/dist/css/tooltipster.bundle.min.css' %}">
<script type="text/javascript" src="{% static 'tooltipster/dist/js/tooltipster.bundle.min.js' %}"></script>

<script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
<script src="{% static 'js/phascenariomgr_texttips.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/info_block.css' %}">

{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
<style>
.custom-textarea {
        transform: scale(0.85);
        width: 100%;

    }
.modal-body {
    padding: 20px; /* Increased padding for more space */

}

.modal-header {
    background-color: #65c8d0; /* Blue background for the header */
    color: #000; /* White text color */
    border-bottom: 2px solid #0056b3; /* Darker blue border at the bottom */
    border-top-left-radius: 8px; /* Rounded top left corner */
    border-top-right-radius: 8px; /* Rounded top right corner */
}
/* Modal Background */
.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
    border-color: #000;
  width: 80%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);

}
/* Modal Header */
.modal-header {
    background-color: #65c8d0; /* Blue background for the header */
    color: #000; /* White text color */
    border-bottom: 2px solid #0056b3; /* Darker blue border at the bottom */
    border-top-left-radius: 8px; /* Rounded top left corner */
    border-top-right-radius: 8px; /* Rounded top right corner */
}
.modal-title {
    font-weight: bold;
}

/* Close Button */
.btn-close {
    filter: invert(1); /* Invert color for better visibility on dark backgrounds */
}
/* Modal Body */

/* Form Controls Enhancement */
.form-control {
    border-radius: 5px; /* Rounded corners for form inputs */
    border: 1px solid #ced4da; /* Subtle border color */
}
/* Buttons */
.btn-primary {
    background-color: #65c8d0; /* Slightly darker blue for primary buttons */
    border-color: #65c8d0;
}
.btn-secondary {
    background-color: #6c757d; /* Dark gray for secondary buttons */
    border-color: #6c757d;
}
.btn-primary:hover, .btn-secondary:hover {
    opacity: 0.85; /* Slight opacity change on hover for feedback */
}
/* Custom Card inside Modal */
.card.mb-3.shadow-sm {
    background-color: #f8f9fa; /* Lighter background for cards */
    border: none; /* Remove border */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
}
.card-body {
    padding: 15px; /* Adjust padding */
}
.card-header {
    background-color: #65c8d0;
    color: white;
    font-size: 1.25rem;
}
.card-title {
    font-size: 1.1rem;
    font-weight: bold;
}
.card-text, #rationalePoints {
    font-size: 0.95rem;
    color: #464748;
}
#rationalePoints li {
    margin-bottom: 0.5rem;
}
/* Adjustments for range inputs */
input[type="range"].custom-range {
    cursor: pointer; /* Change cursor to pointer for better UX */
}
/* Enhancements for select dropdown */
.select.form-control {
    appearance: none; /* Remove default browser appearance */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"><path d="M7.247 14.86l-4.95-4.95.703-.703L7.95 13.457l5.997-5.996.703.703-5.95 5.95a.5.5 0 0 1-.703 0z"/></svg>'); /* Custom dropdown arrow */
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}
/* Ensure the modal stands out */
.modal-backdrop.show {
    opacity: 0.75; /* Darker backdrop for better focus on the modal */
}
.recommendation-box {
    margin: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    background-color: #f9f9f9;
}
.recommendation-text {
    font-size: 14px;
    margin-bottom: 5px;
    color: #000;
}
.nist-reference {
    font-size: 12px;
    text-align: right;
    color: #666;
}
.form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}
body {
        background-color: #464748;
        color: #d3d1cd;
    }
.sidebar {
    display: flex;
    height: 100vh;
    background-color: #2D2E30; /* Darker shade for sidebar */
    padding: 1vw;
    width: 10vw; /* Sidebar width */
    border-right: 0.5px solid #65c8d0; /* Added right border */
    box-shadow: 1px 0 3px rgba(0, 0, 0, 0.1);
}

.sidebar-logo {
    padding: 1vw;
    text-align: center;
}
.nav-sidebar {
    display: flex;
    flex-direction: column;
    padding-left: 0;
    list-style: none;
}
.nav-sidebar .nav-item {
    padding: 0.1vw;
    /* border-bottom: 1px solid  #fac330; /* Light orange line */
    margin: 0 10%;
    gap: 1rem;
}
.nav-sidebar .nav-link {
    color: #d3d1cd;
    border-radius: 0;
    transition: color 0.3s ease-in-out;
    font-size: 0.7rem;
}
.nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
    background-color: #3A5F5F;
    color: #E0E0E0;
}
    /* Enhance dropdown menu */
.dropdown-menu {
    background-color: #d3d1cd;
    border: none;
}
.dropdown-item:hover, .dropdown-item:focus {
    background-color: #fac330; /* Light orange background for hovered dropdown items */
    color: #2D2E30;
}
.content {
    padding: 20px;
}
.custom-main-content {

    min-height: 100vh; /* Ensure it fills the viewport height */
}


@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: 100%;

        margin-left: 4vw;
    }
}

/* Adjustments for when the container is minimized */
.minimized .content, .minimized .controls button:not(#maximizeBtn) {
    display: none;
}

.minimized #maximizeBtn {
    display: block;
}
svg {
    display: block;
    margin: 0 auto; /* Center the SVG in its container */
    overflow: visible;
}
.custom-main-content .container {
    width: 100%; /* Ensure the container fills the custom-main-content */
    max-width: none; /* Override Bootstrap's max-width for containers if necessary */
}
.top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 100px; /* Align with the end of the sidebar */
    width: calc(100% - 200px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}
.page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.5rem; /* Adjust size as needed */
}
@media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
     .sub-menu {
        left: 0;
        width: 100px; /* Adjust for smaller screens */
    }

    .custom-main-content {
        margin-left: 4vw;
    }
}
/* Sub-menu styles */
.sub-menu {
    position: fixed; /* Fixed position to stay in view */
    top: 0; /* Align with the top of the viewport */
    left: 10vw; /* Position the sub-menu right next to the sidebar */
    width: 5vw; /* Width of the sub-menu */
    height: 100vh; /* Full viewport height */
    /* background-color: #333; /* Sub-menu background color */
    color: #fff; /* Text color */
    padding: 0.5vw ; /* Padding */
    box-sizing: border-box; /* Include padding in width calculation */
    font-size: 0.8rem;
}
.sub-menu ul {
    list-style: none; /* Remove default list styling */
    padding: 0; /* Remove default padding */
    margin: 0; /* Remove default margin */
}

.sub-menu li a {
    color: #d3d1cd; /* Link color */
    text-decoration: none; /* Remove underline */
    display: block; /* Make the links fill the container */
    padding: 10px 0; /* Padding for touch targets */
    transition: background-color 0.3s; /* Smooth transition for hover effect */
}
.sub-menu li a:hover, .sub-menu li a.active {
    background-color: #57595b; /* Hover/active background color */
}



.top-strip .btn {
    margin-right: 10px; /* Spacing between buttons */
}

.page-title {

    text-decoration: none;
}

.page-title:hover {
    text-decoration: underline;
}


/* Style for the compliance_map table only */
#compliance_map {
    border-collapse: separate;
    border-spacing: 0 15px; /* Creates space between rows */
    margin: 20px; /* Adds some space around the table for aesthetics */
}

#compliance_map thead th {
    background-color: #004085; /* Dark blue background for headers */
    color: #fff; /* White text for contrast */
    text-align: left;
    font-size: 16px; /* Slightly larger font size for headers */
    padding: 10px; /* Padding inside header cells */
}

#compliance_map tbody tr {
    background-color: #f8f9fa; /* Light background for each row */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Shadow for depth */
    border-radius: 5px; /* Rounded corners for each row */
    margin-bottom: 15px; /* Space between rows */
}

#compliance_map td {
    padding: 10px; /* Padding inside each cell */
    vertical-align: middle; /* Aligns content in the middle vertically */
    border-top: 0; /* Removes the top border from cells */
}

#compliance_map a {
    color: #007bff; /* Color for links to make them stand out */
    text-decoration: none; /* Removes underline from links */
}

#compliance_map a:hover {
    text-decoration: underline; /* Adds underline on hover for links */
}


.nav-link.disabled {
    pointer-events: none; /* Prevent clicking */
    opacity: 0.5; /* Visual feedback that the link is disabled */
}
.swal2-custom-border {
    border: 2px solid #ddd; /* Lighter border */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Shadow */
}
.nav-sidebar .nav-link img {
    width: 1.25em; /* Scales with the font size */
    height: 1.25em; /* Scales with the font size */
}
/* Larger icons for tablets */
@media (min-width: 768px) {
    .nav-sidebar .nav-link img {
    width: 1.5em;
    height: 1.5em;
    }
}
/* Even larger icons for desktops */
@media (min-width: 992px) {
    .nav-sidebar .nav-link img {
    width: 1.75em;
    height: 1.75em;
    }
}
 #sl-a {
        color: black; /* Sets font color to black */
        line-height: 1.5; /* Adds some line spacing */
        padding: 5px; /* Adds padding around the text for better readability */
    }
    .justification {
        margin-top: 10px; /* Adds space between the Security Level and Justification */
        display: block; /* Ensures it starts on a new line */
    }
            .btn-custom {
            width: 95%;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            color: #000;
            background-color: #65c8d0;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .btn-custom:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn-custom:active {
            background-color: #004085;
            transform: translateY(1px);
        }

        .btn-custom i {
            margin-right: 8px;
        }

#bia, #observations, #physical, #outcomes, #finance, #compliance, #attacktree, #recs {
        display: none;
    }
.switch {
  position: relative;
  display: inline-block;
  width: 3rem;
  height: 1.4rem;
}
.switch-container {
  text-align: center;
  margin-bottom: 15px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider1 {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 1rem;
}

.slider1:before {
  position: absolute;
  content: "";
  height: 1rem;
  width: 1rem;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider1 {
  background-color: #65c8d0;
}

input:checked + .slider1:before {
  transform: translateX(26px);
}

/* Show/Hide label */
.switch-label {
  display: block;
  margin-left:5px;
  font-size: 10px;
  color: #fff;
}
.select2-container--default .select2-results__option {
        color: black; /* Change font color of options to black */
    }
    .summary {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .summary h2 {
            margin-top: 0;
            font-size: 24px;
            color: #333;
        }
        .summary p {
            margin: 10px 0;
            font-size: 16px;
            color: #666;
        }

.tab-list {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #f1f1f1;
}
.tab-content {
    border: 0.5px solid #65c8d0;
    border-radius: 10px;
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);
    background-color: #464748;
    padding: 20px;
}
/* Individual tab links */
.tab-link {
    float: left;
    padding: 14px 16px;
    text-align: center;
    cursor: pointer;
    color: #0b2c4a;
    background-color: #e9e9e9; /* Light gray background */
    border-right: 1px solid #bbb;
}

/* Hover effects for tabs */
.tab-link:hover {
    background-color: #ddd; /* Darker shade on hover */
    color: #666;
}

/* Styles for the active tab */
.tab-link.current {
    background-color: #666; /* Dark background for active tab */
    color: white; /* White text color for contrast */
}

/* Tab content sections */
.tab-content {
    display: none; /* Hidden by default */
    padding: 20px;
    border-top: none;
    background-color: #464748; /* White background for the content */
}

/* Current tab content is visible */
.tab-content.current {
    display: block;
}
.tab-content {
    background-color: #464748;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    font-family: Arial, sans-serif;
}

.form-label {
    font-size: 16px;
    color: #333;
    display: block;
    margin-bottom: 10px;
}

.custom-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: #ddd;
    outline: none;
    opacity: 0.7;
    transition: opacity .2s;
}

.custom-slider:hover {
    opacity: 1;
}

.custom-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #007aff;
    cursor: pointer;
    transition: background .3s ease-in-out;
}

.custom-slider::-webkit-slider-thumb:hover {
    background: #0056b3;
}

.slider-labels {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
}

.slider-labels span {
    font-size: 12px;
    color: #666;
}
#summary-container {
    display: none; /* Hidden initially */
}

.pyramid {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.pyramid-block {
    width: 80%;
    background-color: #4a90e2;
    color: white;
    text-align: center;
    padding: 10px;
    margin: 5px 0;
    position: relative;
    clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 10% 100%);
    border-radius: 15px; /* Add rounded corners */
}

#events-block {
    width: 100%;
    background-color: #4a90e2;
}

#breaches-block {
    width: 85%;
    background-color: #7baaf7;
}

#incidents-block {
    width: 70%;
    background-color: #4a90e2;
}

#critical-incidents-block {
    width: 55%;
    background-color: #ee5d5d;
}

.pyramid-block span {
    display: block;
}

</style>
<script>
    sessionStorage.setItem("sid", 0);
     function getSeverityLabel(value) {
        switch (parseInt(value)) {
          case 1:
            case 2:
            return "Low";
          case 3:
            case 4:
            return "Low/Medium";
          case 5:
            case 6:
            return "Medium";
          case 7:
            case 8:
            return "Medium/High";
          case 9:
            case 10:
            return "High";
          default:
            return "";
        }
      }
    function initSlider(sliderId, outputId) {

        var slider = document.getElementById(sliderId);
        var output = document.getElementById(outputId);

        // Display the default slider value
        output.innerHTML = getSeverityLabel(slider.value);

        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
          output.innerHTML = getSeverityLabel(this.value);

        };
      }
// Initialize sliders when the page loads
window.onload = function() {
initSlider("range_safety", "safetyrange");
initSlider("range_life", "liferange");
initSlider("range_production", "productionrange");
initSlider("range_finance", "financerange");
initSlider("range_reputation", "reputationrange");
initSlider("range_environment", "environmentrange");
initSlider("range_regulatory", "regulatoryrange");
initSlider("range_data", "datarange");
initSlider("range_supply", "supplyrange");

sessionStorage.setItem('attackTreeDrawn', 'false');
sessionStorage.setItem("ls", "0");
};

$(function () {
  $('[data-bs-toggle="tooltip"]').tooltip()
})


</script>

</head>
<body style="background-color: #464748">
<form id="cyberpha-form">
{% csrf_token %}
<script>
function generate_playbook() {
    var data = {
        scenario: $('#id_txtScenario').val(),
        recommendations: document.getElementById("hdnRecommendations").value,
        compliance_map: document.getElementById('compliance_map_text').value,
        cyberphaid: sessionStorage.getItem('activeCyberPHA'),
        scenarioid: sessionStorage.getItem('sid')
    };

    // Ensure all required fields are filled
    if (!data.scenario || !data.recommendations || !data.compliance_map || !data.cyberphaid) {
        Swal.fire({
            icon: 'error',
            title: 'Missing Data',
            text: 'Please ensure all scenario details are filled in before generating the playbook.'
        });
        return;
    }

    Swal.fire({
        title: 'Generate Playbook?',
        text: "Do you want to generate a playbook for the current scenario? This will take a few moments. Do not navigate away from this screen or click other links while the operation is in progress.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
             Swal.fire({
                title: 'Generating Playbook',
                text: 'Please wait while the playbook is being generated...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            $.ajax({
                type: "POST",
                url: "/OTRisk/generate_scenario_playbook/",
                contentType: "application/json",
                data: JSON.stringify(data),
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob) {
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = "scenario_playbook.pdf";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.open(url);
                    Swal.fire({
                        icon: 'success',
                        title: 'Playbook Generated',
                        text: 'The playbook has been successfully generated.'
                    });
                },
                error: function(xhr, status, error) {
                    console.log('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while generating the playbook. Please try again.'
                    });
                }
            });
        }
    });
}

function generateScenarioReport() {
    // Get the values from the input fields
    var scenario = $('#id_txtScenario').val();
    var likelihood = document.getElementById('hdnLikelihood').value;
    var adjustedRR = document.getElementById('txtRRa').value;
    var costs_low = document.getElementById('txtEventCosts_low').value;
    var costs = document.getElementById('txtEventCosts').value;
    var costs_high = document.getElementById('txtEventCosts_high').value;
    var probability = document.getElementById('txtProbability').value;
    var frequency = document.getElementById('frequency').value;
    var biaScore = document.getElementById('hdn_bia_score').value;
    var projection = document.getElementById('scenario_12month_costs').value;
    var cost_projection_justification = document.getElementById('cost_projection_justification').value;
    var recommendations = document.getElementById("hdnRecommendations").value;
    var select_level = document.getElementById('security_level').value;
    var scenario_compliance_data = document.getElementById('compliance_map_text').value;
    var rationale_recommendation = document.getElementById('hdnrationale_recommendation').value;
    var rationale_rationale = document.getElementById('hdnrationale_Rationale').value;
    var CyberPHAID = sessionStorage.getItem('activeCyberPHA');

    // Check if all required fields are populated
    if (!scenario || !likelihood || !adjustedRR || !costs_low || !costs || !costs_high ||
        !probability || !frequency || !biaScore || !projection || !cost_projection_justification ||
        !recommendations || !select_level || !scenario_compliance_data ||
        !rationale_recommendation || !rationale_rationale || !CyberPHAID) {
        Swal.fire({
            icon: 'error',
            title: 'Incomplete Scenario',
            text: 'Only completed scenarios can be printed.'
        });
        return;
    }

    // Confirm with the user if they want to generate the PDF report
    Swal.fire({
        title: 'Generate PDF Report?',
        text: "Do you want to generate a PDF report for the current scenario?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, generate it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            // Proceed with generating the report
            var data = {
                scenario: scenario,
                likelihood: likelihood,
                adjustedRR: adjustedRR,
                costs: costs_low + '|' + costs + '|' + costs_high,
                probability: probability,
                frequency: frequency,
                biaScore: biaScore,
                projection: projection,
                cost_projection_justification: cost_projection_justification,
                control_effectiveness: 0,
                recommendations: recommendations,
                select_level: select_level,
                scenario_compliance_data: scenario_compliance_data,
                rationale: JSON.stringify({
                    "Recommendation": rationale_recommendation,
                    "Rationale": rationale_rationale
                }),
                CyberPHAID: CyberPHAID,
                asset: 'N/A',
                asset_purpose: 'N/A'
            };

            $.ajax({
                type: "GET",
                url: "/OTRisk/scenario_analysis_report/",
                data: data,
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob) {
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = "scenario_analysis_report.pdf";
                    link.click();
                    window.open(link.href);
                },
                error: function(xhr, status, error) {
                    console.log('Error: ' + error);
                }
            });
        }
    });
}

anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");


</script>

<div class="container-fluid" >
    <div class="row" >
        {% include 'menu_bar.html' %}
        <div id="notificationMessage" class="notification-message" style="display: none;"></div>
        <div class="col-md-9 col-lg-10">
            <div class="top-strip">
                <div class="row" >

                    <div class="col-md-3">
                        <a class="page-title" style="color: #d3d1cd" href="#" id="cyberPHALink"><span id="facilityName"></span></a>

                        <span id="user_role" class="text-decoration-underline text-body-emphasis"></span>
                          <script>
                            $(document).ready(function() {
                            // Get the activeCyberPHA value from the session storage
                            let activeCyberPHA = sessionStorage.getItem('activeCyberPHA');

                            if (activeCyberPHA) {
                                let linkUrl = `/OTRisk/iotaphamanager/${activeCyberPHA}/`;  // Modify the URL path as needed
                                $('#cyberPHALink').attr('href', linkUrl);
                            } else {
                                window.location.href = "{% url 'OTRisk:iotaphamanager' %}";
                            }
                        });
                        document.getElementById('facilityName').textContent = sessionStorage.getItem('sessionFacility');


                        </script>

                    </div>

                    <div class="col-md-1" > <button type="button" id="addScenarioBtn" class="btn btn-custom nav-link" onclick="resetformcontrols()" style="transform:scale(0.8)" > New</button></div>

                    <div class="col-md-1" ><button type="button" class="btn btn-custom nav-link" data-bs-toggle="modal"  onclick="processFormData()" style="transform:scale(0.8)" > Save</button></div>

                    <div class="col-md-1" ><button type="button" class="btn btn-custom nav-link" data-bs-toggle="modal"  data-bs-target="#scenarioSelectModal" style="transform:scale(0.8)" >Load</button></div>
                    <div class="col-md-1">
                        <button id="risk-assessment-btn" type="button" class="btn btn-custom nav-link" style="transform:scale(0.8)" >
                             Assess  </button><br>

                            <script>
                            $(document).ready(function () {
                            $("#risk-assessment-btn").click(function () {
                               if (document.getElementById('id_txtScenario').value == '')
                                   {return;}
                                // Display the SweetAlert dialog
                                swal.fire({
                                    title: "Scenario KPIs",
                                    html: "Scenario KPIs can take up to a minute or longer to calculate. Proceed?",
                                    iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                                    imageWidth: 150, // Adjust as necessary
                                    imageHeight: 150, // Adjust as necessary
                                    background: '#000', // Black background
                                    color: '#fff', // Set text color to white
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Yes',
                                    cancelButtonText: 'Cancel',
                                    customClass: {
                                        popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                                    }
                                })
                                .then((result) => {
                                    if (result.isConfirmed) {

                                        // If the user clicks "Proceed", call the assessScenario function
                                        assessScenario();
                                    } else {
                                        // If the user clicks "Cancel", do nothing
                                        swal.fire({
                                            title: "AnzenOT Scenario Manager",
                                            text: "Operation Cancelled",
                                            icon: "error" // Assuming you want to show an error icon
                                        });
                                    }
                                });
                            });
                        });
                            </script>
                    </div>
                    <div class="col-md-1" ><button type="button" class="btn btn-custom nav-link"  onclick="generateScenarioReport()" style="transform:scale(0.8)" >Print</button></div>
                    <div class="col-md-1" ><button type="button" class="btn btn-custom nav-link"  onclick="generate_playbook()" style="transform:scale(0.8)" >Playbook</button></div>

                    <div class="col-md-1">
                        <div class="form-group" style="transform:scale(0.8)" >
                        <label for="risk_register">Risk Register</label>
                        <input type="checkbox" id="risk_register" name="risk_register">
                            </div>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var riskRegisterCheckbox = document.getElementById('risk_register');

                            riskRegisterCheckbox.addEventListener('change', function() {
                                if (!riskRegisterCheckbox.checked) {
                                    // Re-check the checkbox if it was unchecked
                                    riskRegisterCheckbox.checked = true;
                                }
                            });
                        });
                        </script>
                    <div class="col-md-1">
                        <div class="form-group" style="transform:scale(0.8)" >
                        <label for="risk_snapshot">Create Snapshot</label>
                        <input type="checkbox" id="risk_snapshot" name="risk_snapshot">
                        </div>
                    </div>

                </div>
            </div>
            <div id="notificationMessage" class="notification-message" style="display: none;"></div>
            <div class="text-label" style="padding-left: 250px; ">
                <label id="echo_scenario" class="form-group"  style="word-wrap: normal;width: 98%; visibility: hidden"></label><br>
                <div class="progress" style="display:none;" id="loadingProgressBar">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBarInner"></div>
                </div>
                <span id="progressBarMessage" style="display:block; text-align:center; margin-top:5px;"></span> <!-- Adjust styling as needed -->
            </div>

            <div class="sub-menu sub-menu-container small-font">
            <br><br><br><br><br><br><br><br><br><br><br><br>
             <div id="block_selector">
             <a href="#" id="organizeBlocks"  style="display: block; color: white; margin-top: 10px; align-self: center">Organize</a>
             <br>


        <div class="switch-container">
            <span class="switch-label">Business Impact</span>
            <label class="switch">
                <input type="checkbox" data-block-id="bia">
                <span class="slider1"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Walkdown Observations</span>
            <label class="switch">
                <input type="checkbox" data-block-id="observations">
                <span class="slider1"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Physical Security</span>
            <label class="switch">
                <input type="checkbox" data-block-id="physical">
                <span class="slider1"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Risk Outcomes</span>
            <label class="switch">
                <input type="checkbox" data-block-id="outcomes">
                <span class="slider1"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Finance Outcomes</span>
            <label class="switch">
                <input type="checkbox" data-block-id="finance">
                <span class="slider1"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Compliance</span>
            <label class="switch">
                <input type="checkbox" data-block-id="compliance">
                <span class="slider1"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Attack Tree</span>
            <label class="switch">
                <input type="checkbox" data-block-id="attacktree">
                <span class="slider1"></span>
            </label>
        </div>
        <div class="switch-container">
            <span class="switch-label">Recommendations</span>
            <label class="switch">
                <input type="checkbox" data-block-id="recs">
                <span class="slider1"></span>
            </label>
        </div>
    </div>

    </div>
            <script>
function updateEchoScenario() {
    var activeTab = $('.tab-link.active').attr('data-tab');
    var txtScenario = $('#id_txtScenario').val();

    // Check if activeTab is defined before trying to replace or parse it
    if (activeTab && txtScenario) {
        var activeTabIndex = parseInt(activeTab.replace('tab', ''));
        // Further checks to ensure activeTabIndex falls within the required range
        if (activeTabIndex >= 3 && activeTabIndex <= 10) {
            // Update the echo_scenario label with the content of the id_txtScenario textbox
            $('#echo_scenario').text(txtScenario).css('visibility', 'visible');
        } else {
            // Clear the echo_scenario label if the activeTabIndex is not within the range
            $('#echo_scenario').text('').css('visibility', 'hidden');
        }
    } else {
        // Clear the echo_scenario label if activeTab or txtScenario is not defined
        $('#echo_scenario').text('').css('visibility', 'hidden');
    }
}



$(document).ready(function() {

    // Event listener for changes in the id_txtScenario textbox
    $('#id_txtScenario').on('input', function() {
        // Update the echo_scenario label if one of the tabs from tab3 to tab10 is active
        updateEchoScenario();
    });

    // Initial update in case the page loads with a specific tab active
    updateEchoScenario();
});
</script>

            <div class="custom-main-content" >
                <div id="block_container" >
                    <div class="row" id="block_rows">
                        <div class="col-md-6" id="block_row_left">
                            <div class="flex-row" >

                            <div class="col-md-12 flex-col" id="block1">
                            <div class="info-block" id="list">
                        <div class="block-header" id="scenario-list">
                            Scenario List
                            <button type="button" class="toggle-body">+</button>
                        </div>
                        <div class="block-body">
                            <div class="block-body-content" id="block1-content" style="align-items: center; align-content: center">
                                <span id="facilityNameTable"></span>
                                <script>document.getElementById('facilityNameTable').textContent = sessionStorage.getItem('sessionFacility');</script>
                                <br>
                                <div class="row" style="background-color: #464748; width: 95%">
                                    <div class="col-md-12 " style="padding: 20px; background-color: #464748">
                                        <table id="userscenarioList" class="table table-hover table-bordered overflow-auto" >
                                            <thead>
                                            <tr>
                                                <th rowspan="2" style="width: 8%; display: none">ID</th>
                                                <th rowspan="2" style="width: 30%">Scenario</th><th rowspan="2">Threat</th>
                                                <th rowspan="2">Risk</th>
                                                <th rowspan="2">Updated</th>
                                                <th rowspan="2"></th>
                                            </tr>
                                            </thead>
                                            <tbody id="userscenarioListBody" style="font-size: 10px">
                                                {% for saved_scenarios in saved_scenarios %}
                                                <tr onclick="fillScenario({{ saved_scenarios.ID}}); ">
                                                    <td style="display:none">
                                                        {{ saved_scenarios.formatted_id }}
                                                    </td>
                                                    <td>{{ saved_scenarios.Scenario|truncatewords:50 }}</td>
                                                    <td>{{ saved_scenarios.ThreatClass }}</td>
                                                    <td>{{ saved_scenarios.RiskCategory }}</td>
                                                     <td>
                                                         <div>{{ saved_scenarios.updater_name }}</div><div> {{ saved_scenarios.last_update }}</div>
                                                     </td>
                                                     <td>
                                                        <a href="{% url 'OTRisk:deletescenario' saved_scenarios.ID saved_scenarios.CyberPHA.ID %}"
                                                           class="btn btn-danger"
                                                           onclick="return checkDeleteCondition();">Del</a>
                                                         <script>
                                                            function checkDeleteCondition() {
                                                                var lsValue = sessionStorage.getItem("ls");
                                                                if (lsValue === "1") {
                                                                    swal.fire("AnzenOT Scenario Manager", "Changes cannot be made to this scenario because it has been added to the risk register");
                                                                    return false; // Prevent the default action (i.e., following the link)
                                                                }
                                                                return confirm('Are you sure you want to delete this record? (Note that if you proceed, the record will be virtually deleted and can be recovered if necessary)');
                                                            }
                                                        </script>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <script>
                                        // Function to handle row click and highlighting
                                        function highlightRow(row) {
                                            // Remove highlighting from any previously clicked row
                                            $("#userscenarioListBody tr").removeClass('highlighted');
                                            // Add highlighting to the current clicked row
                                            $(row).addClass('highlighted');

                                            }
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>

                            </div>

                            <div class="flex-row">
                                <div class="col-md-12 flex-col" id="block3" >
                                    <div class="info-block" id="bia">
                                        <div class="block-header">
                                        Business Impact
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block3-content" style="align-items: center; align-content: center">
                                             <div class="row" style="width:95%">

                                                <div class="col">
                                                <div class="form-group">
                                                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                                    <div class="card-body">
                                                        <div class="slider-container d-flex align-items-center">
                                                            <div class="col-3">
                                                                <label class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#safetyModal" data-modal-id="safetyModal" data-textarea-id="txtsafetyJustify"><img src="{% static 'images/safety.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Safety</label><span id="textIndicator" style="display: none;" spellcheck="true"><i class="bi bi-journal-text"></i></span>
                                                            </div>
                                                            <div class="col-6">
                                                              <input type="range" min="1" max="10" value="1" class="slider" id="range_safety" name="range_safety" onchange="initSlider('range_safety', 'safetyrange');">
                                                            </div>
                                                            <div class="col-3"><label id="safetyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></div>
                                                        </div>
                                                    </div>
                                                </div>
                                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                            <div class="card-body">
                                                <!--slider for Life rating -->
                                                <div class="slider-container d-flex align-items-center">
                                                    <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#lifeModal" data-bs-placement="top" data-modal-id="lifeModal" data-textarea-id="txtlifeJustify"><img src="{% static 'images/danger.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Life</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                    <div class="col-6">
                                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_life" name="range_life" onchange="initSlider('range_life', 'liferange');">
                                                    </div>
                                                    <div class="col-3"><h6><label id="liferange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--slider for Production impact rating -->
                                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                            <div class="card-body">
                                                <div class="slider-container d-flex align-items-center">
                                                    <div class="col-3"><label for="range_production" class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#productionModal" data-bs-placement="top" data-modal-id="productionModal" data-textarea-id="txtproductionJustify"><img src="{% static 'images/production.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Production</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                    <div class="col-6">
                                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_production" name="range_production" onchange="initSlider('range_production', 'productionrange');">
                                                    </div>
                                                    <div class="col-3"><h6><label id="productionrange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                                </div>
                                            </div>
                                        </div>
                                         <!--slider for financial rating -->
                                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                            <div class="card-body">
                                                <div class="slider-container d-flex align-items-center">
                                                    <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#financeModal" data-bs-placement="top" data-modal-id="financeModal" data-textarea-id="txtfinanceJustify"><img src="{% static 'images/finance.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Financial</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                    <div class="col-6">
                                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_finance" name="range_finance" onchange="initSlider('range_finance', 'financerange');">
                                                    </div>
                                                    <div class="col-3"><h6><label id="financerange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--slider for reputation rating -->
                                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                            <div class="card-body">
                                                <div class="slider-container d-flex align-items-center">
                                                    <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#reputationModal" data-bs-placement="top" data-modal-id="reputationModal" data-textarea-id="txtreputationJustify"><img src="{% static 'images/reputation.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Reputation</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                    <div class="col-6">
                                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_reputation" name="range_reputation" onchange="initSlider('range_reputation', 'reputationrange');">
                                                    </div>
                                                    <div class="col-3"><h6><label id="reputationrange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                        <div class="card-body">
                                            <div class="slider-container d-flex align-items-center">
                                                <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#environmentModal" data-bs-placement="top" data-modal-id="environmentModal" data-textarea-id="txtenvironmentJustify"><img src="{% static 'images/environment.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Environment</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                <div class="col-6">
                                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_environment" name="range_environment" onchange="initSlider('range_environment', 'environmentrange');">
                                                </div>
                                                <div class="col-3"><h6><label id="environmentrange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--slider for regulatory impact rating -->
                                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                        <div class="card-body">
                                            <div class="slider-container d-flex align-items-center">
                                                <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#regulatoryModal" data-bs-placement="top" data-modal-id="regulatoryModal" data-textarea-id="txtregulatoryJustify"><img src="{% static 'images/regulation.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Regulatory</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                <div class="col-6">
                                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_regulatory" name="range_regulatory" onchange="initSlider('range_regulatory', 'regulatoryrange');">
                                                </div>
                                                <div class="col-3"><h6><label id="regulatoryrange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--slider for data impact rating -->
                                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                        <div class="card-body">
                                            <div class="slider-container d-flex align-items-center">
                                                <div class="col-3"><label for="range_data" class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#dataModal" data-bs-placement="top" data-modal-id="dataModal" data-textarea-id="txtdataJustify"><img src="{% static 'images/data.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Data/IP</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                <div class="col-6">
                                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_data" name="range_data" onchange="initSlider('range_data', 'datarange');">
                                                </div>
                                                <div class="col-3"><h6><label id="datarange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                        <div class="card-body">
                                            <div class="slider-container d-flex align-items-center">
                                                <div class="col-3"><label for="range_supply" class="small-font d-flex align-items-center clickable-label" style="color: #000" data-bs-toggle="modal" data-bs-target="#supplyModal" data-bs-placement="top" data-modal-id="supplyModal" data-textarea-id="txtsupplyJustify"><img src="{% static 'images/supply.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Supply Chain</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                                <div class="col-6">
                                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_supply" name="range_supply" onchange="initSlider('range_supply', 'supplyrange');">
                                                </div>
                                                <div class="col-3"><h6><label id="supplyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font " style="color: black"></label></h6></div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>


                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="flex-row">
                                <div class="col-md-12 flex-col" id="block5">
                                    <div class="info-block" id="physical">
                                        <div class="block-header">
                                        Physical Controls
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block5-content" style="align-items: center; align-content: center">
                                             <div class="card mb-3 shadow-sm">
                                    <div class="card-body">

                                        <div id="tablePhysicalControls" class="mb-2">
                                            <button id="addRowBtn" class="btn btn-primary btn-sm" type="button">Add Row</button>
                                        </div>

                                        <table class="table table-bordered small-font" id="table_safeguards">
                                            <thead>
                                                <tr>
                                                    <th>Safeguard</th>
                                                    <th>Safeguard Type</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Rows will be added here dynamically -->
                                            </tbody>
                                        </table>
                                        <script>
                                            $(document).ready(function() {
                                                $("#addRowBtn").click(function() {

                                                    var newRow = `<tr>
                                                        <td><textarea class="form-control" maxlength="100"></textarea></td>
                                                        <td><textarea class="form-control" maxlength="100"></textarea></td>
                                                        <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
                                                    </tr>`;
                                                    $("#table_safeguards tbody").append(newRow);
                                                });

                                                // Event delegation to handle dynamically added elements
                                                $("#table_safeguards").on("click", ".deleteRowBtn", function() {
                                                    $(this).closest("tr").remove();
                                                });
                                            });
                                            </script>
                                            <input type="hidden" id="hdnrationale_recommendation">
                                            <input type="hidden" id="hdnrationale_Rationale">
                                    </div>
                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="flex-row">
                                <div class="col-md-12 flex-col" id="block7">
                                    <div class="info-block" id="finance">
                                        <div class="block-header">
                                        Financial Outcomes
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block7-content" style="align-items: center; align-content: center">
                                                <h2>Financial Analysis</h2>
                                                <div class="row" style="width:98%">
                            <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                                <div class="card mb-3 shadow-sm w-100 elegant-card">
                                    <div class="card-body">
                                        <label for="txtEventCosts_low" class="label-title">SLE Low</label>
                                        <input type="text" id="txtEventCosts_low" name="txtEventCosts_low" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>

                                        <label for="txt_ale_low" class="label-title">ALE Low</label>
                                        <input type="text" id="txt_ale_low" name="txt_ale_low" class="form-control text-center elegant-input"  style="font-size: 20px; color: #0a53be" readonly>
                                    </div>
                                </div>
                            </div>


                            <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                                <div class="card mb-3 shadow-sm w-100 elegant-card">
                                    <div class="card-body">
                                        <label for="txtEventCosts" class="label-title">SLE Medium</label>
                                        <input type="text" id="txtEventCosts" name="txtEventCosts" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                                        <label for="txt_ale_low" class="label-title">ALE Medium</label>
                                        <input type="text" id="txt_ale_median" name="txt_ale_median" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                                <div class="card mb-3 shadow-sm w-100 elegant-card">
                                    <div class="card-body">
                                        <label for="txtEventCosts_high" class="label-title">SLE High</label>
                                        <input type="text" id="txtEventCosts_high" name="txtEventCosts_high" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                                        <label for="txt_ale_high" class="label-title">ALE High</label>
                                        <input type="text" id="txt_ale_high" name="txt_ale_high" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                                                <div class="row" style="width:98%">
                                                <div class="col">
                                                    <div class="group-container">
                                                        <div class="group-header">
                                                             Twelve-Month Projection
                                                        </div>
                                                        <div class="group-body">
                                                            <div id="monthly_cost_chart" style="height:300px"></div>
                                                            <input type="hidden" id="scenario_12month_costs" name="scenario_12month_costs">
                                                        </div>

                                                    </div>
                                                    </div>
                                                </div>
                                                <br>
                                                <div class="row" style="width:98%">
                                                <div class="col-lg-10 col-md-10 col-sm-10 flex-fill d-flex">
                                                    <div class="card mb-3 shadow-sm w-100 elegant-card">
                                                        <div class="card-body">
                                                            <textarea id="cost_projection_justification" class="form-control" rows="7" readonly style="resize: none"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="flex-row">
                                <div class="col-md-12 flex-col" id="block9">
                                    <div class="info-block" id="attacktree">
                                        <div class="block-header">
                                        Attack Tree
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block9-content" style="align-items: center; align-content: center">
                                                   <div id="attack_tree" style="width:95%; background-color: #253349C0"></div>
                                                        <button id="exportAttackTreeBtn" type="button" class="btn btn-primary" style="display: none">Export as Image</button>
                                                    <script>


                                   document.getElementById('exportAttackTreeBtn').addEventListener('click', exportAsImage); // Attach export function

                                    function exportAsImage() {
                                        // converts the attack tree to a png file
                                        // Create a new canvas element
                                        var canvas = document.createElement("canvas");
                                        var context = canvas.getContext("2d");

                                        // Get the SVG element and its dimensions
                                        var svg = document.querySelector("svg");
                                        var svgSize = svg.getBoundingClientRect();
                                        canvas.width = svgSize.width;
                                        canvas.height = svgSize.height;

                                        // Convert SVG to a data URL
                                        var img = new Image();
                                        var serializer = new XMLSerializer();
                                        var svgStr = serializer.serializeToString(svg);
                                        img.src = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svgStr)));

                                        img.onload = function() {
                                            // Draw the image onto the canvas
                                            context.fillStyle = "#ffffff";  // Set fill style to white color
                                            context.fillRect(0, 0, canvas.width, canvas.height);  // Fill the canvas with white

                                            context.drawImage(img, 0, 0);

                                            // Convert canvas to an image and download it
                                            var dataURL = canvas.toDataURL("image/png");
                                            var link = document.createElement("a");
                                            link.download = "attack-tree.png";
                                            link.href = dataURL;
                                            link.click();
                                        };
                                    }
                                </script>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="col-md-6" id="block_row_right">
                            <div class="flex-row" >
                                <div class="col-md-12 flex-col" id="block2">
                                    <div class="info-block" id="scenarios">
                                            <div class="block-header" id="scenario-detail">
                                                Scenario Detail
                                                <button type="button" class="toggle-body">+</button>
                                            </div>
                                            <div class="block-body">
                                                <ul class="tab-list">
                                                    <li class="tab-link current" data-tab="tab-1">1. Configure</li>
                                                    <li class="tab-link" data-tab="tab-2">2. Assets</li>
                                                    <li class="tab-link" data-tab="tab-3">3. Scenario</li>
                                                    <li class="tab-link" data-tab="tab-4">4. Consequences</li>
                                                </ul>
                                                <br>
                                                <div id="tab-1" class="tab-content current">
                                                <br>
                                                    <div id="txtRiskRegister"></div>
                                                    <div class="row" style="width:97%">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                <label for="threat-intelligence" id="bad-actor-label">Attacker/Bad Actor:</label>
                                                <select class="form-control small-font" name="threat-intelligence" id="threat-intelligence" style="width: 100%;">
                                                    <option value="">-- Select a threat source --</option>
                                                    {% for threatsource in threatsources %}
                                                        <option value="{{ threatsource.ThreatSource }}">{{ threatsource.ThreatSource }}</option>
                                                    {% endfor %}
                                                </select>
                                                <script>
                                                $(document).ready(function() {
                                                    $('#threat-intelligence').select2({
                                                        placeholder: 'Select a threat actor',
                                                        allowClear: true
                                                    });
                                                });
                                                </script>
                                                <br>
                                                <label for="selVectors" id="attack-vector-label" style="color: white">Attack Vector:</label>
                                                 <!-- store in the threat agent field -->
                                                    <select class="form-control" name="selVectors" id="selVectors" style="width:100%">
                                                    <option value=""> -- Select Attack Vector -- </option>
                                                    {% for threataction in threatactions %}
                                                    <option value="{{ threataction.ThreatAction }}">
                                                        {{ threataction.ThreatAction }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <script>
                                                $(document).ready(function() {
                                                    $('#selVectors').select2({
                                                        placeholder: 'Select attack vector',
                                                        allowClear: true
                                                    });
                                                });
                                                </script>
                                                <br>
                                                <label for="risk-category" id="risk-category-label" style="color: white">Risk Category</label>
                                                <select class="form-control small-font" name="risk-category" id="risk-category" style="width:100%">
                                                    <option value="">Select a risk category</option>
                                                    {% for risk_category in risk_categories %}
                                                    <option value="{{ risk_category.CategoryName }}">{{ risk_category.CategoryName }}</option>
                                                    {% endfor %}
                                                </select>
                                                <script>
                                                $(document).ready(function() {
                                                    $('#risk-category').select2({
                                                        placeholder: 'Select risk category',
                                                        allowClear: true
                                                    });
                                                });
                                                </script>

                                                    <br><br>
                                                    <div class="form-group">
                                                        <label class="switch-label"><h6>Internet Exposed IP Address</h6></label>
                                                        <label class="switch">
                                                        <input for="exposed_system" type="checkbox" id="exposed_system" name="exposed_system">
                                                        <span class="slider1 round"></span>
                                                        </label>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="switch-label"><h6>Default/Weak Credentials</h6></label>
                                                        <label for="weak_credentials" class="switch">
                                                        <input type="checkbox" id="weak_credentials" name="weak_credentials">
                                                        <span class="slider1 round"></span>
                                                        </label>
                                                    </div>
                                                        <div id="scenarioStatus">
                                                        <label for="scenarioStatusSelect" class="form-label">Scenario Status</label>
                                                        <select class="form-select" id="scenarioStatusSelect" name="scenario_status">
                                                            <option value="0">---Select Scenario Status---</option>
                                                            {% for status, status_display in scenario_status %}
                                                            <option value="{{ status }}">{{ status_display }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        </div>
                                                    </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label for="malware-select" id="malware-select-label">Select Malware:</label>
                                                                    <select id="malware-select" class="form-control" style="width: 100%;">
                                                                        <option></option>
                                                                        {% for mal in malware %}
                                                                            <option value="{{ mal.id }}">{{ mal.name }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                    <script>
                                                                    $(document).ready(function() {
                                                                        $('#malware-select').select2({
                                                                            placeholder: 'Select a malware',
                                                                            allowClear: true
                                                                        });
                                                                    });
                                                                    </script>
                                                            </div>
                                                            <div class="form-group">
                                                                    <script>

                                                                </script>
                                                                    <!-- Asset Criticality -->
                                                                    <label for="assetCriticalityDial" class="form-label" style="color:white">Asset Criticality:</label>
                                                                    <input type="range" class="custom-slider" id="assetCriticalityDial" min="1" max="4" step="1">
                                                                    <div id="assetCriticalityLabels" class="slider-labels">
                                                                        <span>Low</span><span>Medium</span><span>High</span><span>Critical</span>
                                                                    </div>


                                                                    <!-- Incident Complexity -->
                                                                    <label for="incidentComplexityDial" class="form-label" style="color:white">Incident Complexity:</label>
                                                                    <input type="range" class="custom-slider" id="incidentComplexityDial" min="1" max="4" step="1">
                                                                    <div id="incidentComplexityLabels" class="slider-labels">
                                                                        <span>Simple</span><span>Moderate</span><span>Complex</span><span>Very Complex</span>
                                                                    </div>

                                                                    <!-- Detection Time -->
                                                                    <label for="detectionTimeDial" class="form-label" style="color:white">Detection Time:</label>
                                                                    <input type="range" class="custom-slider" id="detectionTimeDial" min="1" max="4" step="1">
                                                                    <div id="detectionTimeLabels" class="slider-labels">
                                                                        <span>Fast</span><span>Moderate</span><span>Slow</span><span>Very Slow</span>
                                                                    </div>

                                                                    <!-- Response Time -->
                                                                    <label for="responseTimeDial" class="form-label" style="color:white">Response Time:</label>
                                                                    <input type="range" class="custom-slider" id="responseTimeDial" min="1" max="4" step="1">
                                                                    <div id="responseTimeLabels" class="slider-labels">
                                                                        <span>Fast</span><span>Moderate</span><span>Slow</span><span>Very Slow</span>
                                                                    </div>
                                                                </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                    // Add all sliders' event listeners
                                        document.querySelectorAll('.custom-slider').forEach(slider => {
                                            slider.oninput = function() {
                                                let labels = this.nextElementSibling.children;
                                                for (let i = 0; i < labels.length; i++) {
                                                    labels[i].style.color = i === this.value - 1 ? '#1e1e1f' : '#666';
                                                }
                                            }
                                        });

                                                </script>
                                                                                        </div>
                                                <div id="tab-2" class="tab-content">

                                                <div class="form-group" id="noconnect_asset_group" style="display: {% if assets_data or darktrace_assets_data %}none{% endif %};">
                                                <div class="row">
                                                    <div class="col">
                                                        <label for="noconnect_asset">Targeted Asset (Vendor and Model)</label>
                                                        <input type="text" class="form-control" id="noconnect_asset" name="noconnect_asset" style="width: 100%">

                                                        <label for="asset_purpose">Asset Purpose:</label>
                                                        <input type="text" class="form-control" id="noconnectasset_purpose" name="noconnectasset_purpose" style="width: 100%">
                                                    </div>
                                                </div>
                                            </div>

                                                <!--form group for Exalens assets - will only display if there is an Exalens connector -->
                                               <div class="form-group" id="exalens_asset_group" style="display: {% if not assets_data %}none{% endif %};">
                                                    <div class="row">
                                                        <div class="col">
                                                            <label for="asset_select">Select Asset</label><img src="{% static 'images/exalenslogo.png' %}" alt="" class="align-middle" style="max-height: 1rem; margin-left: 1em">
                                                            <br>
                                                            <select id="asset_select" name="asset_select" class="form-control select2-asset" style="width: 100%;">
                                                                {% for asset in assets_data %}
                                                                <option value="{{ asset.ip }}">{{ asset.mac_vendor }} - {{ asset.model }} - {{ asset.ip }}</option>
                                                                {% endfor %}
                                                            </select>

                                                            <label for="asset_purpose">Asset Purpose:</label>
                                                            <input type="text" class="form-control" id="asset_purpose" name="asset_purpose" style="width: 100%; ">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-group" id="darktrace_asset_group" style="display: {% if not darktrace_assets_data %}none{% endif %};">

                                                    <div class="row">
                                                        <div class="col">
                                                            <label for="darktrace_asset_select" id="darktrace-asset-label">Select Asset</label><img src="{% static 'images/darktrace_logo.png' %}" alt="" class="align-middle" style="max-height: 1rem; margin-left: 1em">
                                                             <p>   </p>
                                                             <script>
                                                                $(document).ready(function() {
                                                                    $('#darktrace_asset_select').select2({
                                                                        width: '95%' // or you can use 'style' as well to set this
                                                                    });
                                                                });

                                                                </script>

                                                            <select id="darktrace_asset_select" name="darktrace_asset_select" class="form-control select2-asset" style="width: 100%">
                                                                {% for darktrace_asset in darktrace_assets_data %}
                                                                <option value="{{ darktrace_asset.ip_address }}">{{ darktrace_asset.asset_type }} - {{ darktrace_asset.hostname }} - {{ darktrace_asset.ip_address }}</option>
                                                                {% endfor %}
                                                            </select>
                                                            <br><p></p>
                                                            <label for="darktrace_asset_purpose">Asset Purpose:</label>
                                                            <input type="text" class="form-control" id="darktrace_asset_purpose" name="darktrace_asset_purpose" style="width: 100%; ">
                                                        </div>
                                                        <div id="summary-container">
                                                                <div class="tab-handle"></div>
                                                                <div id="summary-content">
                                                                    <div class="summary">
                                                                        <h2 id="summary-title"></h2>
                                                                        <div class="pyramid">
                                                                            <div class="pyramid-block" id="events-block">
                                                                                <span>Events</span>
                                                                                <span id="summary-events"></span>
                                                                            </div>
                                                                            <div class="pyramid-block" id="breaches-block">
                                                                                <span>Breaches</span>
                                                                                <span id="summary-breaches"></span>
                                                                            </div>
                                                                            <div class="pyramid-block" id="incidents-block">
                                                                                <span>Incidents</span>
                                                                                <span id="summary-incidents"></span>
                                                                            </div>
                                                                            <div class="pyramid-block" id="critical-incidents-block">
                                                                                <span>Critical Incidents</span>
                                                                                <span id="summary-critical-incidents"></span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                    </div>
                                                </div>

                                            <script>
                                            $(document).ready(function() {

                                                 $('#summary-container').hide();

                                                var assetSelect = $('#asset_select');
                                                var darktrace_assetSelect = $('#darktrace_asset_select');
                                                sessionStorage.setItem('tpconnection', 0);
                                                if (assetSelect.children('option').length === 0) {
                                                    $('#exalens_asset_group').hide();
                                                } else {
                                                    $('#exalens_asset_group').show();
                                                    sessionStorage.setItem('tpconnection', 1);
                                                }

                                                if (darktrace_assetSelect.children('option').length === 0) {
                                                    $('#darktrace_asset_group').hide();
                                                } else {
                                                    $('#darktrace_asset_group').show();
                                                    sessionStorage.setItem('tpconnection', 2);

                                                }
                                                 $('#darktrace_asset_select').on('change', function() {
                                                    var targetAssetIp = $(this).val();
                                                    fetchAssetSummary(targetAssetIp);
                                                });

                                                $('.tab-handle').on('click', function() {
                                                    $('#summary-container').toggleClass('show');
                                                });

                                                function fetchAssetSummary(targetAssetIp) {
                                                    $.ajax({
                                                        url: `/OTRisk/asset_summary_info?ip=${targetAssetIp}`,
                                                        method: 'GET',
                                                        success: function(data) {
                                                            $('#summary-title').text(`Asset: ${data.ip_address} (${data.asset_type})`);
                                                            $('#summary-hostname').text(`Hostname: ${data.hostname}`);
                                                            $('#summary-events').text(data.total_events);
                                                            $('#summary-breaches').text(data.breach_count);
                                                            $('#summary-incidents').text(data.incident_count);
                                                            $('#summary-critical-incidents').text(data.critical_incident_count);


                                                            // Make the tab visible
                                                            $('#summary-container').show();
                                                        },
                                                        error: function(error) {
                                                            console.error('Error fetching asset summary:', error);
                                                        }
                                                    });
                                                }

                                            });
                                            </script>
                                                </div>
                                                <div id="tab-3" class="tab-content">
                                                    <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-md-2"><label for="txtScenario"><h6>Scenario</h6></label></div>
                                                        <div class="col-md-10"><a href="#" id="generateScenarioText" style="color:white">Generate Scenario</a></div>
                                                        <script>
                                                            $(document).ready(function() {
                                                                $('#generateScenarioText').click(function(event) {
                                                                    event.preventDefault(); // Prevent the default link behavior
                                                                    var phaID = document.getElementById('hdnphaID').value;
                                                                    var attack_vector = document.getElementById('selVectors').value;
                                                                    var attacker = document.getElementById('threat-intelligence').value;
                                                                    var targetAsset, targetAssetPurpose;
                                                                    var malware = document.getElementById('malware-select').value;
                                                                    var connectionFlag = 0;
                                                                    var tpConnection;
                                                                    tpConnection = sessionStorage.getItem('tpconnection');
                                                                    if (tpConnection == 0) {
                                                                        targetAsset = document.getElementById('noconnect_asset').value;
                                                                        targetAssetPurpose = document.getElementById('noconnectasset_purpose').value;
                                                                        connectionFlag = 0; // no external connections
                                                                    } else if (tpConnection == 2) {
                                                                        connectionFlag = 1; //darktrace connection
                                                                        targetAsset = document.getElementById('darktrace_asset_select').value;
                                                                        targetAssetPurpose = document.getElementById('darktrace_asset_purpose').value;
                                                                    } else {
                                                                        connectionFlag = 2; // exalens connection
                                                                        targetAsset = document.getElementById('asset_select').value;
                                                                        targetAssetPurpose = document.getElementById('asset_purpose').value;
                                                                    }
                                                                    Swal.fire({
                                                                        title: 'Generating Scenario...',
                                                                        text: 'Please wait while the scenario is being generated.',
                                                                        allowOutsideClick: false,
                                                                        didOpen: () => {
                                                                            Swal.showLoading()
                                                                        }
                                                                    });

                                                                    $.ajax({
                                                                        url: '/OTRisk/generate_cyberpha_scenario_description/',
                                                                        type: 'POST',
                                                                        data: {
                                                                            cyberPHA_ID: phaID,
                                                                            attackVector: attack_vector,
                                                                            attacker: attacker,
                                                                            targetAsset: targetAsset,
                                                                            targetAssetPurpose: targetAssetPurpose,
                                                                            connectionFlag: connectionFlag,
                                                                            malware: malware,
                                                                            csrfmiddlewaretoken: '{{ csrf_token }}'  // Ensure CSRF token is included for POST request
                                                                        },
                                                                        success: function(response) {
                                                                            $('#id_txtScenario').val(response.scenario_description);
                                                                            $('#analyzeScenarioBtn').prop('disabled', false);

                                                                            analyzeScenario(response.scenario_description, phaID, attacker, attack_vector);
                                                                            Swal.close();
                                                                            },

                                                                        error: function(error) {
                                                                            Swal.close(); // Close the SweetAlert2 progress dialog
                                                                            Swal.fire({
                                                                                icon: 'error',
                                                                                title: 'Error',
                                                                                text: 'An error occurred while generating the scenario.',
                                                                            });
                                                                        }
                                                                    });
                                                                });
                                                            });
                                                            </script>
                                                    </div>

                                                    <!-- Render the textarea without the label -->
                                                    {{ scenario_form.txtScenario|add_class:"custom-textarea" }}

                                                    {% if scenario_form.txtScenario.errors %}
                                                        <!-- Custom error handling or styling can be done here -->
                                                    {% endif %}
                                                    <script>

                                                    document.addEventListener('DOMContentLoaded', function() {
                                                            // Adjust the ID here to match the generated ID by Django
                                                            var txtScenarioElement = document.getElementById('id_txtScenario');
                                                            var analyzeScenarioBtn = document.getElementById('analyzeScenarioBtn');

                                                            // Enable the button when the user types in the textarea
                                                            if (txtScenarioElement) {
                                                                txtScenarioElement.addEventListener('input', function() {
                                                                    //reset the attacktreedrawn variable becuase if the scenario has changed then the attack tree needs to be redrawn
                                                                    sessionStorage.setItem('attackTreeDrawn', 'false');
                                                                    analyzeScenarioBtn.disabled = this.value.trim() === ''; // Enable only if there's text
                                                                });
                                                            }

                                                            // Add click event listener to the button
                                                            analyzeScenarioBtn.addEventListener('click', function() {
                                                                // Your existing AJAX call or any other logic here

                                                                // Immediately disable the button after it's clicked
                                                                this.disabled = true;

                                                                // Optionally, clear the textarea or perform other actions
                                                                // txtScenarioElement.value = ''; // Uncomment if you want to clear the textarea
                                                            });
                                                      });

                                                    </script>
                                                </div>
                                                </div>

                                                <div id="tab-4" class="tab-content">
                                                    <div class="form-group" >
                                                        <div class="row">
                                                            <div class="col-md-5">
                                                                <label for="consequenceTable"><h6>Consequences</h6></label>
                                                            </div>
                                                            <div class="col-md-5">
                                                                <button id="analyzeScenarioBtn" class="btn btn-primary" type="button" disabled>Update >>
                                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;" id="loadingSpinner2"></span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col">
                                                                <br>
                                                                <table id="consequenceTable" class="table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Consequence</th>
                                                                        <th>Validate</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody style="transform: scale(0.85);">
                                                                    <!-- Rows will be added here dynamically -->
                                                                </tbody>
                                                                </table>
                                                                <br> <br><br>
                                                                <button id="addRowButton" class="btn btn-primary">Add Row</button>
                                                                <script>
                                                                document.getElementById('addRowButton').addEventListener('click', function() {
                                                                    var tableBody = document.getElementById('consequenceTable').getElementsByTagName('tbody')[0];
                                                                    var newRow = tableBody.insertRow();

                                                                    var consequenceCell = newRow.insertCell(0);
                                                                    var validateCell = newRow.insertCell(1);

                                                                    // Prompt the user to enter the consequence text
                                                                    var consequenceText = prompt("Enter consequence:");

                                                                    if (consequenceText) {
                                                                        consequenceCell.innerHTML = consequenceText;
                                                                    } else {
                                                                        consequenceCell.innerHTML = "User entered consequence"; // Default text if user cancels prompt
                                                                    }

                                                                    var index = tableBody.rows.length - 1; // Get the index of the new row

                                                                    // Create and check the validation checkbox
                                                                    validateCell.innerHTML = '<input type="checkbox" id="validate' + index + '" checked>';
                                                                });
                                                            </script>
                                                            </div>
                                                        </div>
                                                    <br><br>
                                                </div>
                                                </div>
                                            </div>
                                        </div>

                                </div>
                            </div>
                            <div class="flex-row" >
                            <div class="col-md-12 flex-col" id="block4">
                                    <div class="info-block" id="observations">
                                        <div class="block-header">
                                        Walk-down observations
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block4-content" >
                                            <div class="card mb-3 shadow-sm" style="width:95%">
                                            <div class="card-body">
                                                <div id="tableVulns" class="mb-2">
                                                    <button id="addObRowBtn" class="btn btn-primary btn-sm" type="button">Add Row</button>
                                                </div>
                                                <table class="table table-bordered small-font" id="table_vulns">
                                                    <thead>
                                                        <tr>
                                                            <th>Observation</th>

                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                        <tbody>
                                                            <!-- Rows will be added here dynamically -->
                                                        </tbody>
                                                    </table>
                                        <script>
                                            $(document).ready(function() {
                                                $("#addObRowBtn").click(function() {
                                                    var newRow = `<tr>
                                                        <td><textarea class="form-control" maxlength="100"></textarea></td>

                                                        <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
                                                    </tr>`;
                                                    $("#table_vulns tbody").append(newRow);
                                                });

                                                // Event delegation to handle dynamically added elements
                                                $("#table_vulns").on("click", ".deleteRowBtn", function() {
                                                    $(this).closest("tr").remove();
                                                });
                                            });
                                            </script>

                                    </div>
                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <div class="flex-row" >
                            <div class="col-md-12 flex-col" id="block6">
                                    <div class="info-block" id="outcomes">
                                        <div class="block-header">
                                        Risk Outcomes
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block6-content" style="align-items: center; align-content: center">
                                                 <div class="row d-flex h-30" style="width:98%">
                                                    <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                                                        <div class="card mb-3 shadow-sm w-100">
                                                            <div class="card-body">
                                                                <label for="control_effectiveness" class="small-font" style="color: #000">Control Effectiveness (%)</label>
                                                                <div id="gaugeContainer" style="width: 100%; "></div>
                                                                <input type="hidden" id="hdn_control_effectiveness" name="hdn_control_effectiveness">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                                                        <div class="card mb-3 shadow-sm w-100">
                                                            <div class="card-body">
                                                                <label for="txtBIAScore" class="small-font" style="color: #000">BIA Score</label>
                                                                <div id="gaugeBIAContainer" style="width: 100%; "></div>
                                                                <input type="hidden" id="hdn_bia_score" name="hdn_bia_score">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                                                        <div class="card mb-3 shadow-sm w-100">
                                                        <div class="card-body">
                                                            <label for="txtProbability" class="small-font" style="color: #000">Estimated Attack Success Probability (%)</label>
                                                                <div id="gaugeProbContainer" style="width: 100%; "></div>
                                                        </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                                                        <div class="card mb-3 shadow-sm w-100">
                                                        <div class="card-body">
                                                            <label for="txtLikelihood" class="small-font" style="color: #000">Estimated Risk Likelihood (%)</label>
                                                                <div id="gaugeLikelihoodContainer" style="width: 100%; "></div>

                                                                <input type="hidden" id="hdnLikelihood" name="hdnLikelihood">
                                                        </div>
                                                        </div>
                                                    </div>
                            </div>
                             <div class="row d-flex h-30" style="width:98%">
                                 <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                                    <div class="card mb-3 shadow-sm w-100">
                                        <div class="card-body" >
                                            <div id="sl-a"></div>
                                            <input type="hidden" name="security_level" id="security_level">
                                        </div>
                                    </div>
                                 </div>
                                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                                    <div class="card mb-3 shadow-sm w-100">
                                        <div class="card-body" >
                                            <label for="frequency" class="small-font" style="color: #000" title="Loss Event Frequency (LEF) as defined by the Open FAIR Body of Knowledge as: The probable frequency, within a given timeframe, that a threat agent will SUCCESSFULLY act against an asset">Estimated Loss Event Frequency (LEF)</label>
                                            <div id="gaugeFrequency" style="width: 100%;  margin-top: 0; padding-top: 0"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                                    <div class="card mb-3 shadow-sm w-100">
                                        <div class="card-body">
                                            <label for="txtResidualRisk" class="small-font" style="margin-bottom: 0; color: #000" title="The FAIR (Factor Analysis of Information Risk) methodology, which is used to quantify and manage risk, defines residual risk as the amount of risk that remains after controls are applied. In simpler terms, residual risk is what is left over after you've done everything reasonably possible to mitigate or reduce the primary risks.">Estimated Residual Risk</label>
                                            <div id="gaugeResidualRisk" style="width: 100%; margin-top: 0; padding-top: 0"></div>

                                            </div>
                                    </div>
                                </div>

                            </div>
                             <div class="row" style="width:98%">
                                <div class="col-lg-12">
                                    <div class="card mb-3 shadow-sm">
                                        <div class="card-header">
                                            Risk Outcome Explanation
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title" id="recommendationTitle" style="color: #007bff">Recommendation</h5>
                                            <p class="card-text" id="recommendationText"></p>
                                            <h5 class="card-title" id="rationaleTitle" style="color: #007bff">Rationale</h5>
                                            <ul id="rationalePoints"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                    </div>


                                        </div>
                                    </div>
                                </div>
                                </div>
                                <div class="flex-row" >
                            <div class="col-md-12 flex-col" id="block8">
                                    <div class="info-block" id="compliance">
                                        <div class="block-header">
                                        Compliance Map
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block8-content" style="align-items: center; align-content: center">
                                                <div class="form-group" style="width:95%">
                                    <table id="compliance_map" class=" table-hover small small-font overflow-auto compact" style="width:95%">
                                        <thead>
                                            <tr>
                                                <th style="width: 33%">Compliance Concern</th>
                                                <th style="width: 33%">Compliance Reference</th>
                                                <th style="width: 33%">URL</th>
                                            </tr>
                                        </thead>
                                        <tbody style="color: black">
                                                <!-- Rows will be added dynamically by JavaScript -->
                                         </tbody>
                                    </table>
                                    <textarea id="compliance_map_text" name="compliance_map_text" rows="1" width="1%" readonly style="resize: none; visibility: hidden"></textarea>

                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <div class="flex-row" >
                                    <div class="col-md-12 flex-col" id="block10">
                                    <div class="info-block" id="recs">
                                        <div class="block-header">
                                        Recommendations
                                        <button type="button" class="toggle-body">+</button>
                                        </div>
                                        <div class="block-body">
                                            <div class="block-body-content" id="block10-content"  style="align-items: center; align-content: center">
                                                      <div class="form-group" style="width: 95%">
                                                     <span id="span_recommendations" ></span>
                                                     <input type="hidden" id="hdnRecommendations" name="hdnRecommendations">
                                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>

                                <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                var tabs = document.querySelectorAll('.tab-link');
                                var contents = document.querySelectorAll('.tab-content');

                                tabs.forEach(function(tab) {
                                    tab.addEventListener('click', function() {
                                        var tabId = this.getAttribute('data-tab');

                                        tabs.forEach(function(t) {
                                            t.classList.remove('current');
                                        });
                                        contents.forEach(function(content) {
                                            content.classList.remove('current');
                                        });

                                        document.getElementById(tabId).classList.add('current');
                                        this.classList.add('current');
                                    });
                                });

                                var toggleButtons = document.querySelectorAll('.toggle-body');
                                toggleButtons.forEach(function(btn) {
                                    btn.addEventListener('click', function() {
                                        var blockBody = this.parentNode.nextElementSibling;
                                        blockBody.style.display = blockBody.style.display === 'none' ? 'block' : 'none';
                                    });
                                });
                            });


                            </script>
                        </div>
                    </div>
                </div>
           </div>



        <input type="hidden" id="hdnID" name="hdnID" >
        <input type="hidden" id="hdnScenario" name="hdnScenario" value = {{ scenarioID }}>
        <input type="hidden" id="hdnCountry" name="hdnCountry">
        <textarea id="attack_tree_text" name="attack_tree_text" style="visibility: hidden"></textarea>
        <script>

            document.getElementById('hdnCountry').value = sessionStorage.getItem('sessionCountry');

        </script>






</div>
<input type="text" id="frequency" name="frequency" class="form-control text-center" style="font-size: 20px; color: #0a53be; visibility: hidden"  readonly>



<div class="row" hidden="hidden">
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-5" style="background-color: white">
        <h5>Adjusted Risk (After Action)</h5>
                <!--slider for Severity level (Sa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " style="color: #000">Severity Adjusted(Sa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="SArange" name="SArange" onchange="initSlider('SArange','range_SA');">
                    </div>
                    <div class="col-3"><h6><label id="range_SA" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Mitigated Exposure (MELa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center" style="color: #000">Mitigated Exposure (MELa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="MELarange" name="MELarange" onchange="initSlider('MELarange','range_MELa');">
                    </div>
                    <div class="col-3"><h6><label id="range_MELa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Residual Risk (RRa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " style="color: #000">Residual Risk (RRa)</label></div>
                    <div class="col-7"><input type="text" id="txtRRa" name="txtRRa" class="form-control">
                      <!-- <input type="range" min="1" max="10" value="1" class="slider" id="RRarange" name="RRarange" onchange="initSlider('RRarange','range_RRa');"> -->
                    </div>
                    <div class="col-3"><h6><label id="range_RRa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>

    </div>
     <div class="col-md-5" style="background-color: white">
        <h5>Quantitative Assessment</h5>
         <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Annualized Rate of Occurrence (ARO):</label></div>
                    <div class="col-7">
                      <input type="range" class="slider" id="aro" name="aro" min="0" max="12" step="1" oninput="updatearoOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="aro" id="aroOutput">0</output></h6></div>
                </div>
             </div>
         </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Event Costs (SLE): </label></div>
                    <div class="col-7">
                        <input type="text" class="slider" id="sle" name="sle" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white">
                        <input type="hidden" id="hdn_sle" name="hdn_sle">
                    </div>

                </div>

            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="form-group">
                    <label for="ale">Annualized Loss Expectancy (ALE):</label>
                    <output id="ale" name="ale">$0</output>
                </div>
            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Cost of Countermeasures:</label></div>
                    <div class="col-7">
                        <input type="range" class="slider" id="countermeasureCostsRange" name="countermeasureCostsRange" min="0" max="1000000" step="1000" oninput="updateCountermeasureCostsOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="countermeasureCostsRange" id="countermeasureCostsOutput">$0</output></h6></div>
                </div>
            </div>
        </div>

          <div class="card mb-3 shadow-sm" style="visibility: hidden"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Security Level (SL)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="sl_range" name="sl_range" onchange="initSlider('sl_range','range_sl');">
                    </div>
                    <div class="col-3"><h6><label id="range_sl" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
         <script>
            function updatearoOutput(value) {
                document.getElementById('aroOutput').textContent = value;

                // Get the value from the hdn_sle field
                let sleValue = parseFloat(document.getElementById('hdn_sle').value);

                // Multiply the sleValue by the provided value
                let result = sleValue * value;

                // Format the result as a US$ amount with no decimal point
                let formattedResult = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(result);

                // Display the formatted result (or set it to any desired element)
                document.getElementById('ale').textContent = formattedResult;

                // Uncomment the next line if you want to call the calculateALE function
                // calculateALE();
            }

            function updateCountermeasureCostsOutput(value) {
              document.getElementById('countermeasureCostsOutput').textContent = value;
            }

            $(document).ready(function() {
              $('#sle').on('input', function() {
                var cost = parseInt($(this).val()).toLocaleString();
                $('#eventCostsOutput').text('$' + cost);
                //calculateALE();
              });

              function calculateALE() {
                var aro = parseInt($('#aro').val());
                var eventCosts = parseInt($('#sle').val());
                var sle = eventCosts;
                var aro = aro;
                var ale = sle * aro;
                $('#ale').text('$' + ale.toLocaleString());
              }
            });
          </script>
    </div>
     <div class="col-md-1" style="background-color: white"></div>
</div>

<script>

        // Function to save or update CyberPHA data
        function saveOrUpdateCyberPHA(formData) {
          // Get the CSRF token from the cookie
          const csrftoken = getCookie('csrftoken');

          // Create a new XMLHttpRequest object
          const xhr = new XMLHttpRequest();

          // Set up the request
          xhr.open('POST', "{% url 'OTRisk:save_or_update_cyberpha' %}", true);

          xhr.setRequestHeader('X-CSRFToken', csrftoken);


          // Define the callback function for when the request is completed
          xhr.onload = function() {
            if (xhr.status === 200) {
              location.reload()
              // Optionally, perform any additional actions or show a success message
            } else {
              console.error('Failed to save or update CyberPHA data');
              // Optionally, handle the error or show an error message
            }
          };

          // Send the request with the form data
          xhr.send(formData);


          showNotification('Scenario saved successfully: ' + response.message);
          $('#confirmationModal').modal('hide');


        }


        function getCookie(name) {
          const cookieValue = document.cookie
            .split(';')
            .map(cookie => cookie.trim())
            .find(cookie => cookie.startsWith(name + '='));

          if (cookieValue) {
            return cookieValue.split('=')[1];
          }

          return null;
        }

          // Event listener for form submission
          function processFormData() {
              // Check the value of the local session variable named "ls"

              var lsValue = sessionStorage.getItem("ls");
              var riskSnapshotCheckbox = document.getElementById('risk_snapshot');

              if (lsValue === "1") {
                  if (riskSnapshotCheckbox.checked) {
                      swal.fire({
                          title: "AnzenOT Scenario Manager",
                            html: "The version of this scenario saved to the risk register cannot be changed. You are about to create a snapshot version of the scenario. Do you want to proceed?",
                            iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                            showCancelButton: true, // Show the cancel button
                            confirmButtonText: 'OK', // Text for the confirm button
                            cancelButtonText: 'Cancel',
                            focusConfirm: false // Focus on the confirm button by default
                      })
                          .then((result) => {
                              if (result.isConfirmed) {
                                  continueProcessing(true); // Continue with the rest of the function without asking for scenario data save confirmation
                              }
                          });
                  } else {
                      swal.fire({
                        title: "AnzenOT Scenario Manager",
                        text: "Changes cannot be made to this scenario because it has been added to the risk register",
                        icon: "error" // Assuming you want to show an error icon
                    });
                      return; // Exit the function
                  }
              } else {
                  continueProcessing(false); // Continue with the rest of the function and ask for scenario data save confirmation
              }



              function continueProcessing(skipConfirmation) {
                  if (!skipConfirmation) {
                      // Prompt the user for confirmation
                      var isConfirmed = window.confirm("Are you sure you want to save the scenario data?");

                      // If the user clicked "Cancel", exit the function
                      if (!isConfirmed) {
                          return;
                      }
                  }

                  $('#loadingSpinner').show();
                  // Get the values of the form fields
                  const scenario = document.getElementById('id_txtScenario').value;
                  const exposed_system = document.getElementById('exposed_system').checked
                  const weak_credentials = document.getElementById('weak_credentials').checked
                  // const consequence = document.getElementById('txtConsequence').value
                  const threatSource = document.getElementById('threat-intelligence').value;
                  const threatAgent = document.getElementById('selVectors').value;
                  const riskCategory = document.getElementById('risk-category').value;
                  const safety = document.getElementById('range_safety').value;
                  const life = document.getElementById('range_life').value;
                  const production = document.getElementById('range_production').value;
                  const financial = document.getElementById('range_finance').value;
                  const reputation = document.getElementById('range_reputation').value;
                  const environment = document.getElementById('range_environment').value;
                  const regulatory = document.getElementById('range_regulatory').value;
                  const supply = document.getElementById('range_supply').value;
                  const data = document.getElementById('range_data').value;

                  //const sl_a = document.getElementById('selSL').value;

                  const cyberpha = sessionStorage.getItem('activeCyberPHA')
                  const recommendations = document.getElementById('hdnRecommendations').value;
                  const likelihood = document.getElementById('hdnLikelihood').value
                  const rra = document.getElementById('txtResidualRisk').value
                  const justifySafety = document.getElementById('txtsafetyJustify').value
                  const justifyLife = document.getElementById('txtlifeJustify').value
                  const justifyProduction = document.getElementById('txtproductionJustify').value
                  const justifyFinance = document.getElementById('txtfinanceJustify').value
                  const justifyReputation = document.getElementById('txtreputationJustify').value
                  const justifyEnvironment = document.getElementById('txtenvironmentJustify').value
                  const env_contaminant = document.getElementById('env_contaminant').value
                  const env_ecosystem = document.getElementById('env_ecosystem').value
                  const env_contamination = document.getElementById('env_contamination').value
                  const env_population = document.getElementById('env_population').value
                  const env_wildlife = document.getElementById('env_wildlife').value
                  const justifyRegulation = document.getElementById('txtregulatoryJustify').value
                  const justifySupply = document.getElementById('txtsupplyJustify').value
                  const dataRegulation = document.getElementById('txtdataJustify').value
                  const security_level = document.getElementById('security_level').value
                  //const sle =  document.getElementById('hdn_sle').value
                  const aleValue = document.getElementById('ale').value;
                  let ale = parseInt(aleValue.replace(/[^0-9]/g, ''), 10);
                  const probability = document.getElementById('txtProbability').value;
                  const control_effectiveness = document.getElementById('hdn_control_effectiveness').value;
                  const bia_score = document.getElementById('hdn_bia_score').value;
                  const sle_low = document.getElementById('txtEventCosts_low').value;
                  const sle_high = document.getElementById('txtEventCosts_high').value;
                  const sle_median = document.getElementById('txtEventCosts').value;
                  const ale_low = document.getElementById('txt_ale_low').value;
                  const ale_high = document.getElementById('txt_ale_high').value;
                  const ale_median = document.getElementById('txt_ale_median').value;
                  const frequency = document.getElementById('frequency').value;
                  //const standards = document.getElementById('selStandards').value;
                  const aro = document.getElementById('aro').value;
                  const risk_register = document.getElementById('risk_register').checked;
                  const sis_outage = document.getElementById('sisOutageYes').checked;
                  const sis_compromise = document.getElementById('sisIntegrityYes').checked;
                  const safety_hazard = document.getElementById('hazardNature').value;
                  const dangerScope = document.getElementById('dangerScope').value;
                  // Check if the "yes" option was selected for outage
                  const outageSelector = document.getElementById('outageYes');
                  const outage = outageSelector.value === "yes" ? "yes" : "no";
                  const compliance_map = document.getElementById('compliance_map_text').value;
                  const attack_tree_text = document.getElementById('attack_tree_text').value;
                  const scenario_status = document.getElementById('scenarioStatusSelect').value;
                  const cost_projection = document.getElementById('scenario_12month_costs').value;
                  const rationale_recommendation = document.getElementById('hdnrationale_recommendation').value;
                  const rationale_Rationale = document.getElementById('hdnrationale_Rationale').value;
                  const cost_projection_justification = document.getElementById('cost_projection_justification').value;
                  const malware = document.getElementById('malware-select').value;
                  const asset_critical = document.getElementById('assetCriticalityDial').value
                  const incident_complexity = document.getElementById('incidentComplexityDial').value
                  const detection_time= document.getElementById('detectionTimeDial').value
                  const response_time= document.getElementById('responseTimeDial').value

                  // If outage is "yes", get the values for outageDuration and outageCost
                  let outageDuration = 0;
                  let outageCost = 0;
                  if (outage === "yes") {
                      outageDuration = parseInt(document.getElementById('outageDuration').value, 10);
                      outageCost = parseInt(document.getElementById('outageCost').value, 10);
                  }
                  var sid = sessionStorage.getItem('sid');
                  if (!sid) {
                      sid = 0;
                  }
                  // Add the consequences table
                  const table = document.getElementById('consequenceTable');
                  const rows = table.getElementsByTagName('tbody')[0].rows;
                  let validatedConsequenceExists = false;
                  for (let i = 0; i < rows.length; i++) {
                      const isChecked = rows[i].cells[1].getElementsByTagName('input')[0].checked;
                      if (isChecked) {
                          validatedConsequenceExists = true;
                          break;
                      }
                  }
                let asset_name = '';
                let asset_purpose = '';

                if (document.getElementById('exalens_asset_group').style.display !== 'none') {
                    const assetSelect = document.getElementById('asset_select');
                    const selectedAsset = assetSelect.options[assetSelect.selectedIndex].text;
                    asset_name = selectedAsset;
                    asset_purpose = document.getElementById('asset_purpose').value;
                } else if (document.getElementById('darktrace_asset_group').style.display !== 'none') {
                    const assetSelect = document.getElementById('darktrace_asset_select');
                    const selectedAsset = assetSelect.options[assetSelect.selectedIndex].text;
                    asset_name = selectedAsset;
                    asset_purpose = document.getElementById('darktrace_asset_purpose').value;
                } else {
                    asset_name = document.getElementById('noconnect_asset').value;
                    asset_purpose = document.getElementById('noconnectasset_purpose').value;
                }

                  if (rows.length === 0 || !validatedConsequenceExists) {
                      alert("No consequences have been added or validated. Please add and validate consequences before proceeding.");
                      return; // Exit the function
                  }
                  // Create a FormData object
                  const formData = new FormData();
                  formData.append('scenarioID', sid);
                  formData.append('sis_outage', sis_outage);
                  formData.append('sis_compromise', sis_compromise);
                  formData.append('safety_hazard', safety_hazard);
                  formData.append('dangerScope', dangerScope);
                  formData.append('scenario', scenario);
                  formData.append('exposed_system', exposed_system);
                  formData.append('weak_credentials', weak_credentials);
                  // formData.append('consequence', consequence);
                  formData.append('threatSource', threatSource);
                  formData.append('threatAgent', threatAgent);
                  formData.append('riskCategory', riskCategory);
                  formData.append('safety', safety);
                  formData.append('life', life);
                  formData.append('production', production);
                  formData.append('financial', financial);
                  formData.append('reputation', reputation);
                  formData.append('environment', environment);
                  formData.append('env_contaminant', env_contaminant);
                  formData.append('env_ecosystem', env_ecosystem);
                  formData.append('env_contamination', env_contamination);
                  formData.append('env_population', env_population);
                  formData.append('env_wildlife', env_wildlife);
                  formData.append('regulatory', regulatory);
                  formData.append('data', data);
                  formData.append('supply', supply);

                  formData.append('recommendations', recommendations)
                  formData.append('cyberpha', cyberpha);
                  formData.append('justifySafety', justifySafety);
                  formData.append('justifyLife', justifyLife);
                  formData.append('justifyProduction', justifyProduction);
                  formData.append('justifyFinance', justifyFinance);
                  formData.append('justifyReputation', justifyReputation);
                  formData.append('justifyEnvironment', justifyEnvironment);
                  formData.append('justifyRegulation', justifyRegulation);
                  formData.append('dataRegulation', dataRegulation);
                  formData.append('justifySupply', justifySupply);
                  formData.append('sle_low', sle_low);
                  formData.append('sle_median', sle_median);
                  formData.append('sle_high', sle_high);
                  formData.append('ale_low', ale_low);
                  formData.append('ale_median', ale_median);
                  formData.append('ale_high', ale_high);
                  formData.append('frequency', frequency);
                  formData.append('ale', ale);
                  formData.append('outage', outage);
                  formData.append('outageDuration', outageDuration);
                  formData.append('outageCost', outageCost);
                  formData.append('probability', probability);
                  formData.append('control_effectiveness', control_effectiveness);
                  // formData.append('standards', standards);
                  formData.append('risk_register', risk_register);
                  formData.append('likelihood', likelihood);
                  formData.append('security_level', security_level);
                  formData.append('ai_bia_score', bia_score);
                  formData.append('compliance_map', compliance_map);
                  formData.append('attack_tree_text', attack_tree_text);
                  formData.append('scenario_status', scenario_status);
                  formData.append('cost_projection', cost_projection);
                  formData.append('rationale_recommendation', rationale_recommendation);
                  formData.append('rationale_Rationale', rationale_Rationale);
                  formData.append('cost_projection_justification', cost_projection_justification);
                  formData.append('asset_name', asset_name);
                  formData.append('asset_purpose', asset_purpose);
                  formData.append('malware', malware);
                  formData.append('asset_critical', asset_critical);
                  formData.append('detection_time', detection_time);
                  formData.append('incident_complexity', incident_complexity);
                  formData.append('response_time', response_time);

                  // Check if snapshot should be created
                  let snapshot = 0
                  const riskSnapshotCheckbox = document.getElementById('risk_snapshot');
                  if (riskSnapshotCheckbox.checked) {
                      snapshot = 1;
                  }
                  formData.append('snapshot', snapshot);
                  for (let i = 0; i < rows.length; i++) {
                      const row = rows[i];
                      const isChecked = row.cells[1].getElementsByTagName('input')[0].checked;
                      if (isChecked) {
                          const consequenceText = row.cells[0].innerText;
                          formData.append('validated_consequences', consequenceText);
                      }
                  }
                  // Check for safeguards in the table and add them to formData
                  const safeguardsTable = document.getElementById('table_safeguards');
                  const safeguard_rows = safeguardsTable.getElementsByTagName('tbody')[0].rows;
                  let safeguardsAdded = false;

                  for (let i = 0; i < safeguard_rows.length; i++) {
                      const safeguardDescription = safeguard_rows[i].cells[0].getElementsByTagName('textarea')[0].value.trim();
                      const safeguardType = safeguard_rows[i].cells[1].getElementsByTagName('textarea')[0].value.trim();

                      // Ignore empty rows
                      if (safeguardDescription || safeguardType) {
                          formData.append(`safeguards[${i}][description]`, safeguardDescription);
                          formData.append(`safeguards[${i}][type]`, safeguardType);
                          safeguardsAdded = true;
                      }
                  }

                  // If no safeguards were added (table was empty or all rows were empty), add a dummy row
                  if (!safeguardsAdded) {
                      formData.append('safeguards[0][description]', 'No physical safeguards defined');
                      formData.append('safeguards[0][type]', 'N/A');
                  }


                  const vulnTable = document.getElementById('table_vulns');
                  const vuln_rows = vulnTable.getElementsByTagName('tbody')[0].rows;
                  let vulnsAdded = false;

                  for (let i = 0; i < vuln_rows.length; i++) {
                      const vulnDescription = vuln_rows[i].cells[0].getElementsByTagName('textarea')[0].value.trim();

                      if (vulnDescription) {
                          formData.append(`vuln[${i}][description]`, vulnDescription);

                          vulnsAdded = true;
                      }
                  }

                        if (!vulnsAdded) {
                              formData.append('vuln[0][description]', 'No observations defined');
                          }

                  // Call the saveOrUpdateCyberPHA function
                  saveOrUpdateCyberPHA(formData);

                  $('#loadingSpinner').hide();
                  processFormData


                          }
                      }
    </script>

<div class="modal fade custom-modal" id="safetyModal" tabindex="-1" aria-labelledby="safetyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="safetyModal_Label">Justification for Safety Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
        <!-- Drop-down select control for the nature of the safety hazard -->
        <label for="hazardNature">Nature of Safety Hazard:</label>
        <select id="hazardNature" name="hazardNature" class="form-control mb-3">
            <option value="">-- Select Hazard --</option>
          <option value="Chemical">Chemical</option>
          <option value="Electrical">Electrical</option>
          <option value="Mechanical">Mechanical</option>
          <option value="Radiation">Radiation</option>
        </select>

        <!-- Yes/no option for SIS Outage -->
        <div class="mb-3">
          <label>SIS Outage:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageYes" value="yes">
            <label class="form-check-label" for="sisOutageYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageNo" value="no">
            <label class="form-check-label" for="sisOutageNo">No</label>
          </div>
        </div>

        <!-- Yes/no option for SIS Integrity Compromise -->
        <div class="mb-3">
          <label>SIS Integrity Compromise:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrity" id="sisIntegrityYes" value="yes">
            <label class="form-check-label" for="sisIntegrityYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrity" id="sisIntegrityNo" value="no">
            <label class="form-check-label" for="sisIntegrityNo">No</label>
          </div>
        </div>

        <!-- Textarea for justification -->
        <label for="txtsafetyJustify">Justification:</label>
        <textarea id="txtsafetyJustify" name="txtsafetyJustify" class="form-control mb-3" rows="3" style="resize: none"></textarea>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
          </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="lifeModal" tabindex="-1" aria-labelledby="lifeModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="lifeModal_Label">Justification for Danger-to-Life Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div class="form-group">
        <textarea id="txtlifeJustify" name="txtlifeJustify" class="form-control" rows="3" style="resize: none"></textarea>
           <!-- Drop-down select control for the nature of the safety hazard -->
        <label for="dangerScope">Scope of Danger:</label>
        <select id="dangerScope" name="dangerScope" class="form-control mb-3">
            <option value="">-- Select Scope --</option>
            <option value="N/A">N/A</option>
            <option value="Facility">Facility</option>
            <option value="External">External</option>
            <option value="Both">Both</option>
        </select>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
          </div>
    </div>
  </div>
</div>



<div class="modal fade custom-modal" id="productionModal" tabindex="-1" aria-labelledby="productionModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productionModal_Label">Justification for Production Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div class="form-group">
        <textarea id="txtproductionJustify" name="txtproductionJustify" class="form-control" rows="3" style="resize: none"></textarea>

        <!-- 1. Yes/No selector -->
        <div class="mt-3">
          <label>Production Outage?</label><br>
          <input type="radio" id="outageYes" name="outage" value="yes" onclick="toggleOutageControls(true)">
          <label for="outageYes">Yes</label><br>
          <input type="radio" id="outageNo" name="outage" value="no" checked onclick="toggleOutageControls(false)">
          <label for="outageNo">No</label>
        </div>

        <!-- 2. Number input for length of time -->
        <div class="mt-3" id="outageDurationDiv" style="display: none;">
          <label for="outageDuration">Estimate length of time of the outage (hours):</label>
          <input type="number" id="outageDuration" name="outageDuration" class="form-control" min="1">

        </div>

        <!-- 3. Text input for cost per hour -->
        <div class="mt-3" id="outageCostDiv" style="display: none;">
          <label for="outageCost">Cost per hour of outage (if known): </label>
          <input type="text" id="outageCost" name="outageCost" class="form-control">
        </div>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
          </div>
    </div>
  </div>
</div>

<script>
  function toggleOutageControls(isVisible) {
    const durationDiv = document.getElementById('outageDurationDiv');
    const costDiv = document.getElementById('outageCostDiv');
    if (isVisible) {
      durationDiv.style.display = 'block';
      costDiv.style.display = 'block';
    } else {
      durationDiv.style.display = 'none';
      costDiv.style.display = 'none';
    }
  }
</script>

<div class="modal fade custom-modal" id="financeModal" tabindex="-1" aria-labelledby="financeModal" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="financeModal_Label">Justification for Financial Impact Rating</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                <!-- Existing Justification Textarea -->
                <textarea id="txtfinanceJustify" name="txtfinanceJustify" class="form-control" rows="3" style="resize: none"></textarea>

                <!-- Additional Financial Fields -->
                <div class="form-group mt-3">
                    <label for="lostProductionUnits" style="color: #000000">Lost Production Units:</label>
                    <input type="number" id="lostProductionUnits" name="lostProductionUnits" class="form-control" placeholder="Enter lost units" />

                    <label for="wastedLabourCosts" style="color: #000000">Wasted Labour Costs:</label>
                    <input type="number" id="wastedLabourCosts" name="wastedLabourCosts" class="form-control" placeholder="Enter amount" />

                    <label for="lostInventory" style="color: #000000">Lost Inventory:</label>
                    <input type="number" id="lostInventory" name="lostInventory" class="form-control" placeholder="Enter value" />

                    <!-- Add more fields as needed -->
                </div>

                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
            </div>
                </div>
        </div>
    </div>
</div>

<div class="modal fade custom-modal" id="reputationModal" tabindex="-1" aria-labelledby="reputationModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reputationModal_Label">Justification for Reputation Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div class="form-group">
        <textarea id="txtreputationJustify" name="txtreputationJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
          </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="environmentModal" tabindex="-1" aria-labelledby="environmentModal" aria-hidden="true" >
  <div class="modal-dialog modal-xl" >
    <div class="modal-content" style="background-color: darkgray; ">
      <div class="modal-header">
        <h5 class="modal-title" id="environmentModal_Label">Justification for Environment Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div class="form-group">
        <textarea id="txtenvironmentJustify" name="txtenvironmentJustify" class="form-control" rows="3" style="resize: none"></textarea>
                <!-- Dropdown for the type of contaminants -->
        <label for="env_contaminant">Type of Contaminants:</label>
        <select id="env_contaminant" name="env_contaminant" class="form-control mb-3">
          <option value="">-- Select Contaminant Type --</option>
          <option value="N/A">N/A</option>
          <option value="Chemical">Chemical</option>
          <option value="Biological">Biological</option>
          <option value="Radiological">Radiological</option>
          <option value="Physical">Physical</option>
        </select>
          <!-- Dropdown for the affected ecosystem -->
        <label for="env_ecosystem">Affected Ecosystem:</label>
        <select id="env_ecosystem" name="env_ecosystem" class="form-control mb-3">
          <option value="">-- Select Ecosystem --</option>
          <option value="N/A">N/A</option>
          <option value="Aquatic">Aquatic</option>
          <option value="Urban">Urban</option>
          <option value="Agricultural">Agricultural</option>
        </select>
          <!-- Dropdown for the extent of the contamination -->
        <label for="env_contamination">Extent of Contamination:</label>
        <select id="env_contamination" name="env_contamination" class="form-control mb-3">
          <option value="">-- Select Extent --</option>
            <option value="N/A">N/A</option>
          <option value="Localised">Localised</option>
          <option value="WideArea">Wide Area</option>
        </select>
          <!-- Dropdown for effect on local residential population -->
        <label for="env_population">Effect on Local Residential Population:</label>
        <select id="env_population" name="env_population" class="form-control mb-3">
          <option value="">-- Select Effect --</option>
            <option value="N/A">N/A</option>
          <option value="Harmless">Harmless</option>
          <option value="Harmful">Harmful</option>
          <option value="Deadly">Deadly</option>
        </select>

        <!-- Dropdown for effect on local wildlife -->
        <label for="env_wildlife">Effect on Local Wildlife:</label>
        <select id="env_wildlife" name="env_wildlife" class="form-control mb-3">
            <option value="">-- Select Effect --</option>
            <option value="N/A">N/A</option>
            <option value="Harmless">Harmless</option>
            <option value="Harmful">Harmful</option>
            <option value="Deadly">Deadly</option>
        </select>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="regulatoryModal" tabindex="-1" aria-labelledby="regulatoryModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">

        <h5 class="modal-title" id="regulatoryModal_Label">Justification for Regulatory Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div class="form-group">
        <textarea id="txtregulatoryJustify" name="txtregulatoryJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade custom-modal" id="dataModal" tabindex="-1" aria-labelledby="dataModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModal_Label">Justification for Data Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div class="form-group">
        <textarea id="txtdataJustify" name="txtdataJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="supplyModal" tabindex="-1" aria-labelledby="supplyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="supplyModal_Label">Justification for Supply Chain Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div class="form-group">
        <textarea id="txtsupplyJustify" name="txtsupplyJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
      </div>
    </div>
  </div>
</div>


</div>
</div>
</div>
</form>

<!-- RAActionsModal.html -->
<div class="modal fade" id="RAActionsModal" tabindex="-1" aria-labelledby="RAActionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="RAActionsModalLabel" style="color: white">Action:</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
            <form id="raActionsForm">
                {% csrf_token %}
                <input type="hidden" name="hdnphaID" id="hdnphaID">
                <input type="hidden" name="hdntxtModalRAW" id="hdntxtModalRAW" value="0">

                <!-- Action Title -->
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionTitle" class="form-label">Headline</label>
                            <input type="text" class="form-control" id="actionTitle" name="actionTitle" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionOwner" class="form-label">Risk Owner</label>
                                    <input type="text" class="form-control" id="actionOwner" name="actionOwner" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDate" class="form-label">Action Date</label>
                                    <input type="date" class="form-control" id="actionDate" name="actionDate" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionEffort" class="form-label">Effort Level:</label>
                                    <Select class="form-control" id="actionEffort" name="actionEffort">
                                            <option value="">-- Select Effort --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                                </div>
                            </div>
                        </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDifficulty" class="form-label">Difficulty Level</label>
                                    <Select class="form-control" id="actionDifficulty" name="actionDifficulty">
                                            <option value="">-- Select Difficulty --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>

                                </div>
                            </div>
                        </div>
                    </div>
                    </div>


                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionCost" class="form-label">Estimated Cost</label>
                                    <Select class="form-control" id="actionCost" name="actionCost">
                                            <option value="">-- Select Costs --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionAffinity" class="form-label">Risk Mitigation</label>
                                    <Select class="form-control" id="actionAffinity" name="actionAffinity">
                                            <option value="">-- Select Level --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionStatus" class="form-label">Status</label>
                                    <input type="text" class="form-control" id="actionStatus" name="actionStatus" readonly value="Open">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionDescription" class="form-label">Description</label>
                            <textarea id="actionDescription" name="actionDescription" class="form-control" rows="3" style="resize: none"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionPriority" class="form-label">Urgency</label>
                                        <select class="form-control" id="actionPriority" name="actionPriority">
                                            <option value="0">-- Select Urgency --</option>
                                            <option value="1">Low</option>
                                            <option value="2">Medium</option>
                                            <option value="3">High</option>
                                            <option value="4">Critical</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDueDate" class="form-label">Target Date</label>
                                    <input type="date" class="form-control" id="actionDueDate" name="actionDueDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageSIS" class="form-label">Safety (SIS) Outage:</label>
                                        <select class="form-control" id="outageSIS" name="outageSIS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageICS" class="form-label">Control System (SCADA/ICS) Outage:</label>
                                        <select class="form-control" id="outageICS" name="outageICS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageEMS" class="form-label">Environmental (EMS) Outage:</label>
                                        <select class="form-control" id="outageEMS" name="outageEMS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageIT" class="form-label">IT Outage:</label>
                                        <select class="form-control" id="outageIT" name="outageIT">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outagePS" class="form-label">Physical Security Outage:</label>
                                        <select class="form-control" id="outagePS" name="outagePS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageWWW" class="form-label">Internet Outage:</label>
                                        <select class="form-control" id="outageWWW" name="outageWWW">
                                            <option value="0">-- Select Option --</option>
                                            <option value="1">Yes</option>
                                            <option value="2">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitRAActionForm();">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </form>
        </div>
        <!-- ... (rest of the modal code) ... -->

    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="scenarioSelectModal" tabindex="-1" aria-labelledby="scenarioSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scenarioSelectModalLabel">Select a Scenario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="file-explorer">
          <ul id="scenarioList" class="list-group">
            <!-- Scenario items will be populated here -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    // Function to populate the scenario list in the modal
function populateScenarioList() {
  $.ajax({
    url: '/OTRisk/get_saved_scenario_builders',
    type: 'GET',
    success: function(response) {
      var scenarioList = $('#scenarioList');
      scenarioList.empty();

      response.forEach(function(scenario) {
        var listItem = $(`
          <li class="list-group-item list-group-item-action" data-id="${scenario.id}">
            <span class="file-icon"><i class="fas fa-file-alt"></i></span>
            <span class="file-name">${scenario.scenario_name}</span>
          </li>
        `);
        listItem.on('click', function() {
          retrieveScenario($(this).data('id'));
          $('#scenarioSelectModal').modal('hide');
        });
        scenarioList.append(listItem);
      });
    },
    error: function(error) {
      console.error('Error fetching scenarios:', error);
    }
  });
}



// Function to retrieve and display a selected scenario
function retrieveScenario(scenarioId) {
  clearScenario();
  $.ajax({
    url: '/OTRisk/retrieve_scenario_builder/' + scenarioId,
    type: 'GET',
    success: function(response) {
        clearScenario();
      $('#id_txtScenario').val(response.scenario_description);
      $('#attack_tree_text').val(response.attack_tree_data);
      $('#threat-intelligence').val(response.attacker);
      $('#selVectors').val(response.vector);
        // Check if data.attack_tree_text is defined, not null, and not an empty string
        if (response.attack_tree_data && response.attack_tree_data.trim() !== '') {

            var jsonStringFromDatabase = response.attack_tree_data;
            var jsonObject = JSON.parse(jsonStringFromDatabase);
            drawAttackTree(jsonObject);
        }


      if (response.factors['Environmental consequences']) {
        $('#range_environment').val(response.factors['Environmental consequences'].score);
        $('#txtenvironmentJustify').val(response.factors['Environmental consequences'].narrative);
      }
       if (response.factors['Data']) {
        $('#range_data').val(response.factors['Data'].score);
        $('#txtdataJustify').val(response.factors['Data'].narrative);
      }
      if (response.factors['Danger-to-life']) {
        $('#range_life').val(response.factors['Danger-to-life'].score);
        $('#txtlifeJustify').val(response.factors['Danger-to-life'].narrative);
      }
      if (response.factors['Financials']) {
        $('#range_finance').val(response.factors['Financials'].score);
        $('#txtfinanceJustify').val(response.factors['Financials'].narrative);
      }
      if (response.factors['Operations']) {
        $('#range_production').val(response.factors['Operations'].score);
        $('#txtproductionJustify').val(response.factors['Operations'].narrative);
      }
      if (response.factors['Regulations']) {
        $('#range_regulatory').val(response.factors['Regulations'].score);
        $('#txtregulatoryJustify').val(response.factors['Regulations'].narrative);
      }
      if (response.factors['Reputation']) {
        $('#range_reputation').val(response.factors['Reputation'].score);
        $('#txtreputationJustify').val(response.factors['Reputation'].narrative);
      }
      if (response.factors['Safety']) {
        $('#range_safety').val(response.factors['Safety'].score);
        $('#txtsafetyJustify').val(response.factors['Safety'].narrative);
      }
      if (response.factors['Supply chain']) {
        $('#range_supply').val(response.factors['Supply chain'].score);
        $('#txtsupplyJustify').val(response.factors['Supply chain'].narrative);
      }

       // Populate the consequences table
      var tableBody = $('#consequenceTable tbody');
      tableBody.empty(); // Clear existing rows

      var consequencesArray = response.consequences.split('\n');
      consequencesArray.forEach(function(consequence) {
        if (consequence.trim() !== '') {
          var row = `<tr><td>${consequence}</td><td><input type="checkbox" checked></td></tr>`;
          tableBody.append(row);
        }
      });

    },
    error: function(error) {
      console.error('Error retrieving scenario:', error);
    }
  });
}

// Call populateScenarioList when the modal is about to be shown
$('#scenarioSelectModal').on('show.bs.modal', function (e) {
  populateScenarioList();
});

</script>


<script>
    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });

    function submitRAActionForm() {
    // Show SweetAlert in-progress modal
    Swal.fire({
        title: 'Saving...',
        text: 'Please wait while the action is being saved.',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading()
        }
    });

    $.ajax({
        type: "POST",
        url: "{% url 'OTRisk:save_ra_action' %}",
        data: $("#raActionsForm").serialize(),
        success: function(response) {
            Swal.close(); // Close the in-progress modal
            if (response.status == "success") {
                $("#RAActionsModal").modal('hide');
                Swal.fire({
                    icon: 'success',
                    title: 'Action saved',
                    text: 'Your action has been successfully saved.'
                });
                // Remove the "Add Action Item" button
                const recIndex = $("#actionTitle").data("rec-index");
                $(`#recBox${recIndex} .add-action-item-btn`).remove();

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error saving data!'
                });
            }
        },
        error: function() {
            Swal.close(); // Close the in-progress modal
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An unexpected error occurred. Please try again.'
            });
        }
    });
}

</script>




    <script>

    function showNotification(message, isError = false) {
        var notificationDiv = document.getElementById('notificationMessage');
        notificationDiv.innerHTML = message;
        notificationDiv.style.display = 'block';
        notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

        // Automatically hide the notification after some time
        setTimeout(function() {
            notificationDiv.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }


        // Function to add a new scenario row to the table
        function addScenarioRow() {
            try {
                var scenarioCount = document.querySelectorAll('#scenarioTable tbody tr').length + 1;
                var row = document.createElement('tr');
                row.id = 'scenarioRow' + scenarioCount;

                // Create table cells for each field
                var assessmentNameCell = document.createElement('td');
                var scenarioCell = document.createElement('td');
                var controlObjectiveCell = document.createElement('td');
                var riskCategoryCell = document.createElement('td');
                var mitigationMeasuresCell = document.createElement('td');
                var likelihoodCell = document.createElement('td');
                var impactCell = document.createElement('td');
                var riskLevelCell = document.createElement('td');

                // Create form elements for each field
                var assessmentNameInput = document.createElement('input');
                assessmentNameInput.type = 'text';
                assessmentNameInput.name = 'assessment_name';
                assessmentNameCell.appendChild(assessmentNameInput);

                var scenarioInput = document.createElement('input');
                scenarioInput.type = 'text';
                scenarioInput.name = 'scenarios[' + scenarioCount + '][scenario]';
                scenarioCell.appendChild(scenarioInput);

                var controlObjectiveSelect = document.createElement('select');
                controlObjectiveSelect.name = 'scenarios[' + scenarioCount + '][control_objective]';
                // Populate control objectives dynamically

                var riskCategorySelect = document.createElement('select');
                riskCategorySelect.name = 'scenarios[' + scenarioCount + '][CategoryName]';
                // Populate risk categories dynamically



                var likelihoodInput = document.createElement('input');
                likelihoodInput.type = 'number';
                likelihoodInput.name = 'scenarios[' + scenarioCount + '][likelihood]';
                likelihoodCell.appendChild(likelihoodInput);

                var impactInput = document.createElement('input');
                impactInput.type = 'number';
                impactInput.name = 'scenarios[' + scenarioCount + '][impact]';
                impactCell.appendChild(impactInput);

                var riskLevelInput = document.createElement('input');
                riskLevelInput.type = 'text';
                riskLevelInput.name = 'scenarios[' + scenarioCount + '][risk_level]';
                riskLevelInput.disabled = true;
                riskLevelCell.appendChild(riskLevelInput);

                // Append form elements to the cells
                assessmentNameCell.appendChild(assessmentNameInput);
                scenarioCell.appendChild(scenarioInput);
                controlObjectiveCell.appendChild(controlObjectiveSelect);
                riskCategoryCell.appendChild(riskCategorySelect);
                mitigationMeasuresCell.appendChild(mitigationMeasuresSelect);
                likelihoodCell.appendChild(likelihoodInput);
                impactCell.appendChild(impactInput);
                riskLevelCell.appendChild(riskLevelInput);

                // Append cells to the row
                row.appendChild(assessmentNameCell);
                row.appendChild(scenarioCell);
                row.appendChild(controlObjectiveCell);
                row.appendChild(riskCategoryCell);
                row.appendChild(mitigationMeasuresCell);
                row.appendChild(likelihoodCell);
                row.appendChild(impactCell);
                row.appendChild(riskLevelCell);

                // Append row to the table
                document.getElementById('scenarioTable').appendChild(row);
            } catch (error) {

            }
        }

        // Event listener for adding a new scenario row
        document.getElementById('addScenarioBtn').addEventListener('click', function() {
            addScenarioRow();
        });

        function formatRationaleText(rationaleText) {
            return rationaleText.split('\n').map(line => line.replace(/^\s*-\s*/, '')).join('\n');
        }

        $(".slider")

        $(document).ready(function() {


          });

         // AJAX function to call the Django view

    function isValidURL(string) {
    try {
        new URL(string);
    } catch (_) {
        return false;
    }
    return true;
}
        function assessScenario(forceResubmit = false) {
            $('#loadingProgressBar').show();
            $('#progressBarInner').css('width', '0%').attr('aria-valuenow', 0);
            $('#progressBarMessage').text('').show(); // Initialize and show message


         let progress = 0;
    let progressBarInterval = setInterval(function() {
        progress++;
        if (progress <= 99) { // Increment progress until 99%
            $('#progressBarInner').css('width', progress + '%').attr('aria-valuenow', progress);

            // Update progress bar message based on current progress
            if (progress === 10) {
                $('#progressBarMessage').text('Calculating risk outcomes...');
            } else if (progress === 20) {
                $('#progressBarMessage').text('Preparing financial analysis...');
            } else if (progress === 35) {
                $('#progressBarMessage').text('Creating compliance map...');
            } else if (progress === 60) {
                $('#progressBarMessage').text('Writing recommendations...');
            }
        }
    }, 1000); // Update progress every second

            let cpha = sessionStorage.getItem('activeCyberPHA');
            let scenario = document.getElementById('id_txtScenario').value;
            let malware = document.getElementById('malware-select').value;
            let exposed_system = document.getElementById('exposed_system').checked;
            let weak_credentials = document.getElementById('weak_credentials').checked;
            // let consequence = document.getElementById('txtConsequence').value
            let threatsource = document.getElementById('threat-intelligence').value;
            let riskCategory = document.getElementById('risk-category').value;
            let safety = document.getElementById('range_safety').value;
            let life = document.getElementById('range_life').value;
            let production = document.getElementById('range_production').value;
            let financial = document.getElementById('range_finance').value;
            let reputation = document.getElementById('range_reputation').value;
            let environment = document.getElementById('range_environment').value;
            let regulatory = document.getElementById('range_regulatory').value;
            let data = document.getElementById('range_data').value;
            let supply = document.getElementById('range_supply').value;

            let industry = sessionStorage.getItem('sessionIndustry')
            let facilityType = sessionStorage.getItem('sessionFacilityType')
            // let standards = document.getElementById('selStandards').value;
            let country = document.getElementById('hdnCountry').value;

            let safety_hazard = document.getElementById('hazardNature').value;
            let production_outage = document.getElementById('outageYes').value;
            let production_outage_length = document.getElementById('outageDuration').value;
            // Gather validated consequences
            const table = document.getElementById('consequenceTable');
            const rows = table.getElementsByTagName('tbody')[0].rows;
            let validatedConsequences = [];
            let validatedConsequenceExists = false;
            let safetyJustification = document.getElementById('txtsafetyJustify').value;
            let supplychainJustification = document.getElementById('txtsupplyJustify').value;
            let environmentJustification = document.getElementById('txtenvironmentJustify').value;
            let dangerJustification = document.getElementById('txtlifeJustify').value;
            var targetAsset, targetAssetPurpose;
            var partner_connection;
            var tpConnection;
            tpConnection = sessionStorage.getItem('tpconnection');

            if (tpConnection == 0) {

                targetAsset = document.getElementById('noconnect_asset').value;
                targetAssetPurpose = document.getElementById('noconnectasset_purpose').value;
                partner_connection = 0;
            } else if (tpConnection == 2) {

                targetAsset = document.getElementById('darktrace_asset_select').value;
                targetAssetPurpose = document.getElementById('darktrace_asset_purpose').value;
                partner_connection = 1;
            } else {

                targetAsset = document.getElementById('asset_select').value;
                targetAssetPurpose = document.getElementById('asset_purpose').value;
                partner_connection = 2;
            }

             // Gather Physical Safeguards from the table
            let physicalSafeguards = [];
            $("#table_safeguards tbody tr").each(function() {
                let safeguard = $(this).find("td:first textarea").val(); // Assuming the first column contains a textarea
                if (safeguard) {
                    physicalSafeguards.push(safeguard.trim());
                }
            });

            // Format the physical safeguards into a string
            let physicalSafeguardsStr = "Physical security controls. Control:" + physicalSafeguards.join(". Control: ")

            let observations = [];
            $("#table_vulns tbody tr").each(function() {
                let observation = $(this).find("td:first textarea").val(); // Assuming the first column contains a textarea
                if (observation) {
                    observations.push(observation.trim());
                }
            });

            // Format the physical safeguards into a string
            let observationsStr = "Vulnerability and risk observations made . Observation:" + observations.join(". Observation: ")



            for (let i = 0; i < rows.length; i++) {
                const isChecked = rows[i].cells[1].getElementsByTagName('input')[0].checked;
                if (isChecked) {
                    validatedConsequences.push(rows[i].cells[0].innerText);
                    validatedConsequenceExists = true;
                }
            }

            // Check if no consequences have been validated
            if (!validatedConsequenceExists) {
                alert("No consequences have been validated. Please validate at least one consequence before proceeding.");
                clearInterval(progressBarInterval); // Cancel the progress bar action
                $('#loadingProgressBar').hide(); // Hide the progress bar
                return; // Exit the function
            }

            // Convert the array of consequences to a string for sending in the AJAX request
            let validatedConsequencesStr = validatedConsequences.join(';');
            // Make the AJAX call to the Django view using the determined URL
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:scenario_analysis' %}",
                data: {
                    // Pass the impact scores and scenario information as parameters
                    force_resubmit: forceResubmit,
                    industry: industry,
                    facility_type: facilityType,
                    scenario: scenario,
                    exposed_system: exposed_system,
                    weak_credentials: weak_credentials,
                    threatsource: threatsource,
                    safety: safety,
                    life: life,
                    production: production,
                    reputation: reputation,
                    environment: environment,
                    regulatory: regulatory,
                    data: data,
                    supply: supply,
                    country: country,
                    financial: financial,
                    cpha: cpha,
                    safety_hazard: safety_hazard,
                    production_outage: production_outage,
                    production_outage_length: production_outage_length,
                    validated_consequences: validatedConsequencesStr,
                    physical_safeguards: physicalSafeguardsStr,
                    observations: observationsStr,
                    safetyJustification: safetyJustification,
                    supplychainJustification: supplychainJustification,
                    environmentJustification: environmentJustification,
                    dangerJustification: dangerJustification,
                    targetAsset: targetAsset,
                    targetAssetPurpose: targetAssetPurpose,
                    partner_connection: partner_connection,
                    malware: malware,
                },
                success: function (response) {
                    // On success, set progress to 100% and hide the progress bar
                    clearInterval(progressBarInterval);
                    $('#progressBarInner').css('width', '100%').attr('aria-valuenow', 100);
                    $('#progressBarMessage').text('Complete!').show();
                    setTimeout(function() { // Briefly show 100% before hiding
                        $('#loadingProgressBar').hide();
                        $('#progressBarMessage').hide();

                    }, 500); // Adjust delay as needed

                    if (response.message === 'Scenario parameters have not changed.') {
                        // Display a SweetAlert notification
                        swal.fire({
                            title: "Duplicate Submission",
                            html: "You are submitting a scenario with the same parameters as one previously analyzed. Do you wish to proceed?",
                            iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                            imageWidth: 150, // Adjust as necessary
                            imageHeight: 150, // Adjust as necessary
                            background: '#000', // Black background
                            color: '#fff', // Set text color to white
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes',
                            cancelButtonText: 'Cancel',
                            customClass: {
                                popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // If the user chooses to proceed, call assessScenario again with forceResubmit = true
                                assessScenario(true);
                            }
                        });
                    } else {
                        $('#loadingSpinner').hide();

                        document.getElementById('txtRRa').value = response.adjustedRR;
                        document.getElementById('hdnLikelihood').value = response.likelihood;
                        document.getElementById('txtLikelihood').value = response.likelihood + '%';

                        let costsString = response.costs;
                        let costsArray = costsString.split('|');
                        let sle_low = costsArray.length > 0 && costsArray[0] ? `$${parseInt(costsArray[0]).toLocaleString()}` : "$0";
                        let sle_medium = costsArray.length > 1 && costsArray[1] ? `$${parseInt(costsArray[1]).toLocaleString()}` : "$0";
                        let sle_high = costsArray.length > 2 && costsArray[2] ? `$${parseInt(costsArray[2]).toLocaleString()}` : "$0";
                        document.getElementById('txtEventCosts').value = sle_medium;
                        document.getElementById('txtEventCosts_low').value = sle_low;
                        document.getElementById('txtEventCosts_high').value = sle_high;
                        document.getElementById('hdnrationale_recommendation').value = response.rationale.Recommendation;
                        document.getElementById('hdnrationale_Rationale').value = response.rationale.Rationale;
                         $("#recommendationTitle").text("Recommendation");
                        $("#recommendationText").text(response.rationale.Recommendation);

                        $("#rationaleTitle").text("Rationale");
                        // $("#rationalePoints").html("<li>" + response.rationale.Rationale.replace(/\n/g, "</li><li>") + "</li>");
                        let formattedRationale = formatRationaleText(response.rationale.Rationale);
                         $("#rationalePoints").html("<li>" + formattedRationale.replace(/\n/g, "</li><li>") + "</li>");

                        document.getElementById('frequency').value = response.frequency;
                        document.getElementById('txtProbability').value = response.probability;


                        document.getElementById('security_level').value = response.select_level;
                         if (response['select_level']) {
                            let sl_a_value = response['select_level'];
                            let parts = sl_a_value.split(", Justification: ");
                            if (parts.length === 2) {
                                let levelPart = parts[0].split("Level: ")[1];
                                let justificationPart = parts[1];

                                // Update the #sl-a content using new structure with line breaks and classes
                                $('#sl-a').html(`<span>Security Level: ${levelPart}</span><span class="justification">Justification: ${justificationPart}</span>`);
                            } else {
                                $('#sl-a').text("Invalid format for security level data");
                            }
                        } else {
                            $('#sl-a').text("No data available for security level");
                        }


                        document.getElementById('hdn_control_effectiveness').value = response.control_effectiveness;
                        displayRecommendations(response.recommendations);


                        document.getElementById("hdnRecommendations").value = response.recommendations;
                        document.getElementById('hdn_bia_score').value = response.biaScore;
                        var formattedText = response.cost_projection_justification.replace(/\. /g, ".\n\n");;
                        document.getElementById('cost_projection_justification').value = formattedText;

                        let ale_low = parseFloat(costsArray[0]) * parseFloat(response.frequency);

                        // Format ALE as currency
                        let formatter = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 0, // No decimal places
                            maximumFractionDigits: 0  // No decimal places
                        });

                        let formattedAleLow = formatter.format(ale_low);


                        let ale_median = parseFloat(costsArray[1]) * parseFloat(response.frequency);

                        let formattedAleMedian = formatter.format(ale_median);


                        let ale_high = parseFloat(costsArray[2]) * parseFloat(response.frequency);

                        let formattedAleHigh = formatter.format(ale_high);

                        // Set the formatted value
                        document.getElementById('txt_ale_high').value = formattedAleHigh;
                        document.getElementById('txt_ale_median').value = formattedAleMedian;
                        document.getElementById('txt_ale_low').value = formattedAleLow;

                        document.getElementById('scenario_12month_costs').value = response.projection;

                        var costArray = response.projection.split('|').map(Number);
                        createCostChart('monthly_cost_chart', costArray);

                        var controlEffectivenessPercentage = response.control_effectiveness;
                        clearContainer('gaugeProbContainer');
                        clearContainer('gaugeContainer');
                        clearContainer('gaugeLikelihoodContainer');
                        clearContainer('gaugeResidualRisk');
                        clearContainer('gaugeFrequency');
                        clearContainer('gaugeBIAContainer');

                        createEffectivenessGauge(controlEffectivenessPercentage);
                        createProbGauge(response.probability);
                        createBIAGauge(response.biaScore);
                        createFrequencyGauge(response.frequency);
                        createLikelihoodGauge(response.likelihood);
                        // Define the text values based on the percentage range
                        var textValue = "";
                        if (controlEffectivenessPercentage < 25) {
                            textValue = "Low";
                        } else if (controlEffectivenessPercentage < 50) {
                            textValue = "Low/Medium";
                        } else if (controlEffectivenessPercentage < 75) {
                            textValue = "Medium";
                        } else if (controlEffectivenessPercentage < 90) {
                            textValue = "Medium/High";
                        } else {
                            textValue = "High";
                        }

                        document.getElementById('compliance_map_text').value = response.scenario_compliance_data;
                        // Destroy existing DataTable instance if it exists
                        if ($.fn.DataTable.isDataTable('#compliance_map')) {
                            $('#compliance_map').DataTable().destroy();
                        }
                        var compliance_map = response.scenario_compliance_data;

                        // Check if the DataTable is already initialized
                        var isDataTable = $.fn.DataTable.isDataTable('#compliance_map');
                        var dataTable;

                        if (isDataTable) {
                            // If already a DataTable, clear and destroy it
                            dataTable = $('#compliance_map').DataTable();
                            dataTable.clear().destroy();
                        } else {
                            // Clear the table body if it's not a DataTable
                            $('#compliance_map tbody').empty();
                        }
                        // Split the response into individual lines
                        var lines = compliance_map.split('||');
                        lines.forEach(function (line) {
                            if (line.trim() !== '') {
                                // Split each line into fields
                                var fields = line.split(' > ');

                                // Create a new row in the table
                                // Check if all fields exist and then create a new row in the table
                                if (fields.length === 3) {
                                    var newRow = '<tr>' +
                                        '<td>' + (fields[0] ? fields[0].trim() : '') + '</td>' +
                                        '<td>' + (fields[1] ? fields[1].trim() : '') + '</td>' +
                                        '<td>' + (fields[2] ? '<a href="' + fields[2].trim() + '" target="_blank">' + fields[2].trim() + '</a>' : '') + '</td>' +
                                        '</tr>';
                                    $('#compliance_map tbody').append(newRow);
                                }
                            }
                        });
                        // Set the value of the 'control_effectiveness' text control
                        document.getElementById('control_effectiveness').value = textValue;
                        //document.getElementById('txtEventCosts').value = formattedCosts;
                        document.getElementById('txtResidualRisk').value = response.adjustedRR

                        createResidualRiskGauge(response.adjustedRR);

                        $('#compliance_map').DataTable({
                            "paging": false,  // Enable pagination
                            "pageLength": 10,  // Set the number of rows per page
                            "searching": false,  // Disable the search box
                            "lengthChange": false,  // Disable the page length selection control
                            "info": false
                        });
                        var pdfBase64 = response.pdf;

                        // Convert base64 to binary
                        var binary = atob(pdfBase64.replace(/\s/g, ''));
                        var len = binary.length;
                        var buffer = new ArrayBuffer(len);
                        var view = new Uint8Array(buffer);
                        for (var i = 0; i < len; i++) {
                            view[i] = binary.charCodeAt(i);
                        }

                        // Create a blob from the binary data
                        var blob = new Blob([view], { type: 'application/pdf' });

                        // Create a URL for the blob
                        var url = URL.createObjectURL(blob);

                        // Open the URL in a new window
                        window.open(url, '_blank');
                        }
                },
                error: function (xhr, status, error) {

                    // Handle any errors that occur during the AJAX call
                    if (xhr.status === 403) {

                        swal.fire({
                            title: 'Allowance Exceeded',
                            html: 'You have used up all of your allocated scenario risk analysis allowance. Please contact your administrator or AnzenOT at <a href="mailto:support@anzenot.com">support@anzenot.com</a> to increase your allowance.',
                            iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                            customClass: {
                                    popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
                                },
                            imageWidth: 150, // Adjust as necessary
                            imageHeight: 150, // Adjust as necessary
                            background: '#000', // Black background
                            color: '#fff', // Set text color to white
                            confirmButtonText: 'Ok',
                            confirmButtonColor: '#3085d6',
                        });
                    } else {
                        // Handle other errors
                    }
                    clearInterval(progressBarInterval);
                    $('#loadingProgressBar').hide();
                    $('#progressBarMessage').hide();

                },
            });
        }

document.getElementById('hdnphaID').value = sessionStorage.getItem('activeCyberPHA');

document.addEventListener("DOMContentLoaded", function() {
    // Function to update the indicator
    function updateIndicator(textarea, indicator) {
        if (textarea.value.trim() !== "") {
            indicator.style.display = "inline";
        } else {
            indicator.style.display = "none";
        }
    }

    // Get all labels with the data-modal-id attribute
    const labels = document.querySelectorAll('[data-modal-id]');

    labels.forEach(label => {
        const modalId = label.getAttribute('data-modal-id');
        const textareaId = label.getAttribute('data-textarea-id');
        const textarea = document.getElementById(textareaId);
        const indicator = label.nextElementSibling; // Assuming the indicator is the next sibling of the label

        // Check on modal close
        $('#' + modalId).on('hidden.bs.modal', function (e) {
            updateIndicator(textarea, indicator);
        });

        // Check on textarea change

        textarea.addEventListener('input', function() {

            updateIndicator(textarea, indicator);
        });
    });
});

function displayRecommendations(recommendations) {
    try {
        $("#span_recommendations").empty();
        let recommendationsArray = recommendations.split('\n').filter(r => r.trim() !== '');
        recommendationsArray.forEach((rec, index) => {
            let parts = rec.split('[');
            let recommendationText = parts[0].trim();
            let nistReference = parts[1].replace(']', '').trim();
            // Extract the body text using regex
            let bodyTextMatch = recommendationText.match(/^\d+\.\s*(.*?)\s*\(\d+%?\)$/);
            let bodyText = bodyTextMatch ? bodyTextMatch[1] : recommendationText;

            let boxHtml = `
                <div class="recommendation-box" id="recBox${index}">
                    <div class="recommendation-text" style="transform: scale(0.9)">${recommendationText}</div>
                    <div class="nist-reference" style="transform: scale(0.9)">${nistReference}</div>
                    <button class="btn btn-primary add-action-item-btn" data-bs-toggle="modal" data-bs-target="#RAActionsModal" data-recommendation="${bodyText}" style="transform: scale(0.8)">Add Action Item</button>
                </div>
            `;

            $("#span_recommendations").append(boxHtml);
        });

        // Add event listener for the "Add Action Item" buttons
        $(".add-action-item-btn").on("click", function() {
            let recommendationText = $(this).data("recommendation");
             let recIndex = $(this).data("rec-index");
            $("#actionTitle").val(recommendationText).data("rec-index", recIndex);
            $("#actionDescription").val(recommendationText);
             // Get the current date in mm/dd/yyyy format
            let currentDate = new Date();
            let year = currentDate.getFullYear();
            let month = String(currentDate.getMonth() + 1).padStart(2, '0');
            let day = String(currentDate.getDate()).padStart(2, '0');
            let formattedDate = `${year}-${month}-${day}`;
            $("#actionDate").val(formattedDate);
        });
    } catch (error) {
        // Optionally, you can display a user-friendly error message on the UI as well
        $("#span_recommendations").append(`<div class="error-message">Error displaying recommendations. Please try again later.</div>`);
    }
}





function createActionItem(recBoxId) {

    $(".custom-context-menu").hide();
}

    function createEffectivenessGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["red", "orange", "yellow", "green"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeContainer').draw();
}

function createBIAGauge(score){

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeBIAContainer').draw();

}

 function createProbGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeProbContainer').draw();

}


 function createLikelihoodGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeLikelihoodContainer').draw();
}

function createResidualRiskGauge(rating) {
    // Translate the rating to a numerical value
    var score;
    switch (rating) {
        case "Low":
            score = 10;
            break;
        case "Low/Medium":
            score = 33;
            break;
        case "Medium":
            score = 50;
            break;
        case "Medium/High":
            score = 66;
            break;
        case "High":
            score = 90;
            break;
        default:
            return;
    }

    var data = [score];
    // set the gauge type
   var gauge = anychart.gauges.linear();
   gauge.layout('vertical'); // Set the layout to horizontal
        var credits = gauge.credits();
    credits.enabled(false);
   // set the data for the gauge
   gauge.data(data);

   var scaleBarColorScale = anychart.scales.ordinalColor().ranges(
  [
    {
      from: 0,
      to: 25,

        color: ['#CAD70b', '#2AD62A']
    },
    {
      from: 25,
      to: 50,

        color: ['#FFD700', '#CAD70b']
    },
    {
      from: 50,
      to: 75,
      color: ['#EB7A02', '#FFD700']
    },
    {
      from: 75,
      to: 100,
       color: ['#D81E05', '#EB7A02']
    }
  ]
);
var scaleBar = gauge.scaleBar(0);

   // set the height and offset of the Scale Bar (both as percentages of the gauge height)
   scaleBar.width('15%');
   scaleBar.offset('10%');

   // use the color scale (defined earlier) as the color scale of the Scale Bar
   scaleBar.colorScale(scaleBarColorScale);

   // add a marker pointer
   var marker = gauge.marker(0);
    marker.width(7.5);
   // set the offset of the pointer as a percentage of the gauge width
   marker.offset('27%');

   // set the marker type
   marker.type('triangle-left');
   // set the color of the marker to black
   marker.color('black');
    // set the zIndex of the marker
   marker.zIndex(10);

   // Adjust label positioning to place it inside the column next to the pointer
    var label = gauge.label();

    label.text(data.toString())
         .position({x: '50%', y: '95%'})
         .anchor('centerBottom')
         .offsetX('50%') // Adjust this value to position the label next to the marker
         .offsetY(-15) // Manually adjust based on the gauge's scale and layout
         .hAlign('center')
         .zIndex(20);
   // configure the scale
   var scale = gauge.scale();
   scale.minimum(0);
   scale.maximum(100);
   scale.ticks().interval(10);

    var axis = gauge.axis();
    axis.minorTicks(true)
    axis.minorTicks().stroke('#cecece');
    axis.width('1%');
    axis.offset('5%');
    axis.orientation('left');

    // format axis labels
    axis.labels().format(function() {
        if (this.value == 0) return "Low";
        else if (this.value == 50) return "Medium";
        else if (this.value == 100) return "High";
        else return "";  // This will hide other labels
    });
    gauge.width('100%');


    gauge.height('95%'); // Set height for vertical layout
    gauge.layout();
    gauge.padding([15, 0, 0, 15]); // Adjust padding for vertical layout


    // Draw the chart
    gauge.container('gaugeResidualRisk').draw();
}

function createFrequencyGauge(rating) {

    var data = rating;
    var gauge = anychart.gauges.linear();
    gauge.layout('vertical');

    var credits = gauge.credits();
    credits.enabled(false);

    gauge.data(data);

    var scaleBarColorScale = anychart.scales.ordinalColor().ranges([
        { from: 0, to: 1, color: ['#CAD70b', '#2AD62A'] },
        { from: 1, to: 3, color: ['#FFD700', '#CAD70b'] },
        { from: 3, to: 4, color: ['#EB7A02', '#FFD700'] },
        { from: 4, to: 5, color: ['#D81E05', '#EB7A02'] }
    ]);

    var scaleBar = gauge.scaleBar(0);
    scaleBar.width('15%');
    scaleBar.offset('10%');
    scaleBar.colorScale(scaleBarColorScale);

    var marker = gauge.marker(0);
    marker.width(7.5);
    marker.offset('27%');
    marker.type('triangle-left');
    marker.color('black');
    marker.zIndex(10);

    // Adjust label positioning to place it inside the column next to the pointer
    var label = gauge.label();

    label.text(data.toString())
         .position({x: '50%', y: '95%'})
         .anchor('centerBottom')
         .offsetX('50%') // Adjust this value to position the label next to the marker
         .offsetY(-15) // Manually adjust based on the gauge's scale and layout
         .hAlign('center')
         .zIndex(20);

    var scale = gauge.scale();
    scale.minimum(0);
    scale.maximum(5);
    scale.ticks().interval(0.5);

    var axis = gauge.axis();
    axis.minorTicks(true);
    axis.minorTicks().stroke('#cecece');
    axis.width('1%');
    axis.offset('5%');
    axis.orientation('left');

    axis.labels().format(function() {
        if (this.value % 0.5 === 0) {
            return this.value.toFixed(1);
        }
        return "";
    });

    gauge.height('95%');
    gauge.layout();
    gauge.padding([15, 0, 0, 15]);

    gauge.container('gaugeFrequency').draw();
}

function closeScenarioList() {
        var scenarioDetailsBlock = $(".info-block:contains('Scenario List')");
        var blockBody = scenarioDetailsBlock.find(".block-body");
        blockBody.hide();
        scenarioDetailsBlock.find(".toggle-body").text("+");
        scenarioDetailsBlock.css('z-index', --zIndexCounter);
    }

function expandScenarioDetails() {
        var scenarioDetailsBlock = $(".info-block:contains('Scenario Detail')");
        var blockBody = scenarioDetailsBlock.find(".block-body");
        blockBody.show();
        scenarioDetailsBlock.find(".toggle-body").text("-");
        scenarioDetailsBlock.css('z-index', ++zIndexCounter);
        closeScenarioList();
    }



function resetformcontrols() {
  swal.fire({
    title: "New Scenario",
    html: "Are you sure you want to begin a new scenario and reset the form? All unsaved changes will be lost.",
    iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">',
    imageWidth: 150, // Adjust as necessary
    imageHeight: 150, // Adjust as necessary
    background: '#000', // Black background
    color: '#fff', // Set text color to white
    showCancelButton: true, // Show the cancel button
    confirmButtonText: 'Yes', // Text for the confirm button
    cancelButtonText: 'No', // Text for the cancel button
    focusConfirm: false, // Focus on the confirm button by default
    reverseButtons: true, // Reverse the button positions (if you want "No" to the right of "Yes"
    customClass: {
            popup: 'swal2-custom-border' // Apply custom class to the popup/dialog
        }
}).then((result) => {
    if (result.isConfirmed) {
      // Reset form fields here
      sessionStorage.setItem('attackTreeDrawn', 'false');

      document.getElementById('exportAttackTreeBtn').style.display = 'none';

      document.getElementById('id_txtScenario').value = '';
      document.getElementById('exposed_system').checked = false;
      document.getElementById('weak_credentials').checked = false;
      // document.getElementById('txtConsequence').value = '';
      document.getElementById('threat-intelligence').value = '';
      document.getElementById('risk-category').value = '';
      document.getElementById('range_safety').value = 0;
      document.getElementById('range_life').value = 0;
      document.getElementById('range_production').value = 0;
      document.getElementById('range_finance').value = 0;
      document.getElementById('range_reputation').value = 0;
      document.getElementById('range_environment').value = 0;
      document.getElementById('range_regulatory').value = 0;
      document.getElementById('range_data').value = 0;
      document.getElementById('range_supply').value = 0;

      document.getElementById('txtsafetyJustify').value = '';
      document.getElementById('hazardNature').value = '';
      document.getElementById('dangerScope').value = '';
      document.getElementById('sisOutageYes').checked = false;
      document.getElementById('sisOutageNo').checked = true;
      document.getElementById('sisIntegrityYes').checked = false;
      document.getElementById('sisIntegrityNo').checked = true;
      document.getElementById('txtlifeJustify').value = '';
      document.getElementById('txtproductionJustify').value = '';
      document.getElementById('txtfinanceJustify').value = '';
      document.getElementById('txtreputationJustify').value = '';
      document.getElementById('txtenvironmentJustify').value = '';
      document.getElementById('txtregulatoryJustify').value = '';
      document.getElementById('txtdataJustify').value = '';


      document.getElementById('txtLikelihood').value = 0;
      document.getElementById('hdnLikelihood').value = 0;
      document.getElementById('txtRRa').value = 0;
      document.getElementById('txtProbability').value = '';
      document.getElementById('control_effectiveness').value = '';
      document.getElementById('hdn_control_effectiveness').value = '';
      document.getElementById('hdn_bia_score').value = '';

      document.getElementById('txtEventCosts_low').value = '';
      document.getElementById('txtEventCosts').value = '';
      document.getElementById('txtEventCosts_high').value = '';
      document.getElementById('txt_ale_low').value = '';
      document.getElementById('txt_ale_median').value = '';
      document.getElementById('txt_ale_high').value = '';
      document.getElementById('frequency').value = '';
      document.getElementById('txtResidualRisk').value = '';
      document.getElementById('risk_register').checked = false;
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows
      // document.getElementById('has_controls').value = 0;
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');
     $('#table_safeguards tbody').empty();
      sessionStorage.setItem('ls', '0');
      sessionStorage.setItem('sid', 0);

        expandScenarioDetails();



    }
  });
}

function clearScenario(){
         sessionStorage.setItem('attackTreeDrawn', 'false');

      document.getElementById('exportAttackTreeBtn').style.display = 'none';

      document.getElementById('id_txtScenario').value = '';
      document.getElementById('exposed_system').checked = false;
      document.getElementById('weak_credentials').checked = false;
      // document.getElementById('txtConsequence').value = '';
      document.getElementById('threat-intelligence').value = '';
      document.getElementById('risk-category').value = '';
      document.getElementById('range_safety').value = 0;
      document.getElementById('range_life').value = 0;
      document.getElementById('range_production').value = 0;
      document.getElementById('range_finance').value = 0;
      document.getElementById('range_reputation').value = 0;
      document.getElementById('range_environment').value = 0;
      document.getElementById('range_regulatory').value = 0;
      document.getElementById('range_data').value = 0;
      document.getElementById('range_supply').value = 0;

      document.getElementById('txtsafetyJustify').value = '';
      document.getElementById('hazardNature').value = '';
      document.getElementById('dangerScope').value = '';
      document.getElementById('sisOutageYes').checked = false;
      document.getElementById('sisOutageNo').checked = true;
      document.getElementById('sisIntegrityYes').checked = false;
      document.getElementById('sisIntegrityNo').checked = true;
      document.getElementById('txtlifeJustify').value = '';
      document.getElementById('txtproductionJustify').value = '';
      document.getElementById('txtfinanceJustify').value = '';
      document.getElementById('txtreputationJustify').value = '';
      document.getElementById('txtenvironmentJustify').value = '';
      document.getElementById('txtregulatoryJustify').value = '';
      document.getElementById('txtdataJustify').value = '';


      document.getElementById('txtLikelihood').value = 0;
      document.getElementById('hdnLikelihood').value = 0;
      document.getElementById('txtRRa').value = 0;
      document.getElementById('txtProbability').value = '';
      document.getElementById('control_effectiveness').value = '';
      document.getElementById('hdn_control_effectiveness').value = '';
      document.getElementById('hdn_bia_score').value = '';

      document.getElementById('txtEventCosts_low').value = '';
      document.getElementById('txtEventCosts').value = '';
      document.getElementById('txtEventCosts_high').value = '';
      document.getElementById('txt_ale_low').value = '';
      document.getElementById('txt_ale_median').value = '';
      document.getElementById('txt_ale_high').value = '';
      document.getElementById('frequency').value = '';
      document.getElementById('txtResidualRisk').value = '';
      document.getElementById('risk_register').checked = false;
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows
      // document.getElementById('has_controls').value = 0;
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');
    $('#table_safeguards tbody').empty();
      sessionStorage.setItem('ls', '0');
      sessionStorage.setItem('sid', 0);


}

 function fillScenario(scenarioId) {
    clearScenario();

    sessionStorage.setItem('sid', scenarioId);

    sessionStorage.setItem('attackTreeDrawn', 'false');

    document.getElementById('exportAttackTreeBtn').style.display = 'none';


    var container = document.getElementById('attack_tree');
    container.innerHTML = '';
    // Send a GET request to the getSingleScenario view
    $.get("{% url 'OTRisk:getSingleScenario' %}", { id: scenarioId }, function(data) {

         if (data.risk_register === true) {
            sessionStorage.setItem("ls", "1");
            $('#risk_register').prop('checked', true);
             $('#txtRiskRegister').text('WARNING: This scenario was added to the risk register. Changes may  be saved as a snapshot but will not affect the saved scenario. ').css('color', 'red');
        } else {
            sessionStorage.setItem("ls", "0");
            $('#risk_register').prop('checked', false);
            $('#txtRiskRegister').text('');
        }
        // Fill the form fields with the returned data
        $('#id_txtScenario').val(data.Scenario);

        $('#exposed_system').prop('checked', data.exposed_system);
        $('#weak_credentials').prop('checked', data.weak_credentials);
        $('#selVectors').val(data.ThreatAgent);
        $('#selVectors').val(data.ThreatAgent).trigger('change');
        //$('#txtConsequence').val(data.Consequence);
        $('#threat-intelligence').val(data.ThreatClass);
        $('#threat-intelligence').val(data.ThreatClass).trigger('change');

        if (data.malware) {
        $('#malware-select').val(data.malware.id);
        $('#malware-select').val(data.malware.id).trigger('change');
            } else {
                $('#malware-select').val(null).trigger('change');
            }


         $('#risk-category').val(data.RiskCategory);
        $('#risk-category').val(data.RiskCategory).trigger('change');

         $('#range_safety').val(data.impactSafety);
         $('#range_life').val(data.impactDanger);
         $('#range_production').val(data.impactProduction);
         $('#range_finance').val(data.impactFinance);
         $('#range_reputation').val(data.impactReputation);

         $('#range_environment').val(data.impactEnvironment);
         $('#range_regulation').val(data.impactRegulation);
         $('#range_data').val(data.impactData);
        $('#range_supply').val(data.impactSupply);

         $('#scenarioStatusSelect').val(data.scenario_status);

         $('#env_contaminant').val(data.env_contaminant);
         $('#env_ecosystem').val(data.env_ecosystem);
         $('#env_contamination').val(data.env_contamination);
         $('#env_population').val(data.env_population);
         $('#env_wildlife').val(data.env_wildlife);

         $('#assetCriticalityDial').val(data.asset_critical);
         $('#incidentComplexityDial').val(data.incident_complexity);
         $('#detectionTimeDial').val(data.detection_time);
         $('#responseTimeDial').val(data.response_time);


         if (document.getElementById('exalens_asset_group').style.display !== 'none') {
            const assetSelect = document.getElementById('asset_select');
            const assetOptions = Array.from(assetSelect.options);
            const selectedAsset = assetOptions.find(option => option.text === data.asset_name);

            if (selectedAsset) {
                assetSelect.value = selectedAsset.value;
            }
            $('#asset_purpose').val(data.asset_purpose);
        } else if (document.getElementById('darktrace_asset_group').style.display !== 'none') {
            const assetSelect = document.getElementById('darktrace_asset_select');
            const assetOptions = Array.from(assetSelect.options);
            const selectedAsset = assetOptions.find(option => option.text === data.asset_name);

            if (selectedAsset) {
                assetSelect.value = selectedAsset.value;
                  $('#darktrace_asset_select').trigger('change');
            }
            $('#darktrace_asset_purpose').val(data.asset_purpose);
        } else {
            $('#noconnect_asset').val(data.asset_name);
            $('#noconnectasset_purpose').val(data.asset_purpose);
        }

        $('#hdnRecommendations').val(data.recommendations);
        savedRecommendations = data.recommendations;
        if (savedRecommendations) {
            displayRecommendations(savedRecommendations);
        }


        document.getElementById('security_level').value = data.sl_a;
         if (data['sl_a']) {
            let sl_a_value = data['sl_a'];
            let parts = sl_a_value.split(", Justification: ");
            if (parts.length === 2) {
                let levelPart = parts[0].split("Level: ")[1];
                let justificationPart = parts[1];

                // Update the #sl-a content using new structure with line breaks and classes
                $('#sl-a').html(`<span>Security Level: ${levelPart}</span><span class="justification">Justification: ${justificationPart}</span>`);
            } else {
                $('#sl-a').text("Invalid format for security level data");
            }
        } else {
            $('#sl-a').text("No data available for security level");
        }

        $('#frequency').val(data.frequency);
        $('#has_controls').val(data.has_controls);
        document.getElementById('user_role').textContent = data.user_role;

        $('#sle').val(data.sle);

        $('#compliance_map_text').val(data.compliance_map);

        try {
            var formattedText = data.cost_justification.replace(/\. /g, ".\n\n");
            // Set the formatted text with line breaks to the textarea
            $('#cost_projection_justification').val(formattedText);
        }
        catch (e)
            {}

        $('#attack_tree_text').val(data.attack_tree_text || '');  // Set to empty string if undefined or null

        // Check if data.attack_tree_text is defined, not null, and not an empty string
        if (data.attack_tree_text && data.attack_tree_text.trim() !== '') {

            var jsonStringFromDatabase = data.attack_tree_text;
            var jsonObject = JSON.parse(jsonStringFromDatabase);

            $("input[type=checkbox][data-block-id='attacktree']").prop('checked', true).trigger('change');
            var atBlock = $(".info-block:contains('Attack Tree')");
            var blockBody = atBlock.find(".block-body");
            blockBody.show();
            atBlock.find(".toggle-body").text("-");
            atBlock.css('z-index', ++zIndexCounter);

            drawAttackTree(jsonObject);
            $("input[type=checkbox][data-block-id='attacktree']").prop('checked', false).trigger('change');

        }



        if ($.fn.DataTable.isDataTable('#compliance_map')) {
                        $('#compliance_map').DataTable().destroy();
                    }
        var compliance_map = data.compliance_map;

        if (data.cost_projection !== null) {
            document.getElementById('scenario_12month_costs').value = data.cost_projection;

            var costArray = data.cost_projection.split('|').map(Number);
            createCostChart('monthly_cost_chart', costArray);
        }

        // Check if the DataTable is already initialized
        var isDataTable = $.fn.DataTable.isDataTable('#compliance_map');
        var dataTable;

        if (isDataTable) {
            // If already a DataTable, clear and destroy it
            dataTable = $('#compliance_map').DataTable();
            dataTable.clear().destroy();
        } else {
            // Clear the table body if it's not a DataTable
            $('#compliance_map tbody').empty();
        }
        // Split the response into individual lines
        var lines = compliance_map.split('||');
        lines.forEach(function(line) {
            if (line.trim() !== '') {
                // Split each line into fields
                var fields = line.split(' > ');

                // Create a new row in the table
                // Check if all fields exist and then create a new row in the table
            if (fields.length === 3) {
                var newRow = '<tr>' +
                    '<td>' + (fields[0] ? fields[0].trim() : '') + '</td>' +
                    '<td>' + (fields[1] ? fields[1].trim() : '') + '</td>' +
                    '<td>' + (fields[2] ? '<a href="' + fields[2].trim() + '" target="_blank">' + fields[2].trim() + '</a>' : '') + '</td>' +
                    '</tr>';
                $('#compliance_map tbody').append(newRow);
            }
            }
        });

        $('#compliance_map').DataTable({
                "paging": false,  // Enable pagination
                "pageLength": 10,  // Set the number of rows per page
                "searching": false,  // Disable the search box
                "lengthChange": false,  // Disable the page length selection control
                "info": false
            });
        let costs = parseFloat(data.sle); // Assuming response.costs is a string representation of a number
        let formattedCosts = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs);

        document.getElementById('sle').value = formattedCosts;
        document.getElementById('txtEventCosts').value= formattedCosts;
        let costs_low = parseFloat(data.sle_low); // Assuming response.costs is a string representation of a number
        let formattedCosts_low = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_low);
        document.getElementById('txtEventCosts_low').value= formattedCosts_low;
        let costs_high = parseFloat(data.sle_high); // Assuming response.costs is a string representation of a number
        let formattedCosts_high = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_high);
        document.getElementById('txtEventCosts_high').value= formattedCosts_high;
        let ale_costs_high = parseFloat(data.ale_high); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_high = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_high);
        document.getElementById('txt_ale_high').value= ale_formattedCosts_high;
        let ale_costs_low = parseFloat(data.ale_low); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_low = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_low);
        document.getElementById('txt_ale_low').value= ale_formattedCosts_low;
        let ale_costs_median = parseFloat(data.ale_median); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_median = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_median);
        document.getElementById('txt_ale_median').value= ale_formattedCosts_median;

        document.getElementById('txtResidualRisk').value= data.RRa;
        document.getElementById('txtProbability').value= data.probability;
        document.getElementById('hdn_control_effectiveness').value= data.control_effectiveness;
        document.getElementById('hdn_bia_score').value= data.ai_bia_score;
        document.getElementById('hdnrationale_recommendation').value = data.risk_recommendation;
        document.getElementById('hdnrationale_Rationale').value = data.risk_rationale;

        $("#recommendationTitle").text("Recommendation");
        $("#recommendationText").text(data.risk_recommendation);
        $("#rationaleTitle").text("Rationale");
         try {
             //$("#rationalePoints").html("<li>" + data.risk_rationale.replace(/\n/g, "</li><li>") + "</li>");
              let formattedRationale = formatRationaleText(data.risk_rationale);
              $("#rationalePoints").html("<li>" + formattedRationale.replace(/\n/g, "</li><li>") + "</li>");
         }
         catch (e)
         {}

         // Populate the scenario_consequences table
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows

        data.Consequences.forEach(function(consequence) {
            var checked = consequence.is_validated ? 'checked' : '';
            var row = `<tr>
                <td>${consequence.consequence_text}</td>
                <td><input type="checkbox" ${checked}></td>
            </tr>`;
            tableBody.append(row);
        });

    $('#table_vulns tbody').empty();
    if (data.observations && data.observations.length > 0) {
        data.observations.forEach(function(observation) {
            var newRow = `<tr>
                <td><textarea class="form-control" maxlength="250">${observation.observation_description}</textarea></td>
                <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
            </tr>`;
            $('#table_vulns tbody').append(newRow);
        });
    } else {
         var newRow = `<tr>
            <td><textarea class="form-control" maxlength="100">No observations made</textarea></td>

            <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
        </tr>`;
        $('#table_vulns tbody').append(newRow);
    }
        // Clear existing rows in the safeguards table
    $('#table_safeguards tbody').empty();

    // Check if there are safeguards in the response
    if (data.safeguards && data.safeguards.length > 0) {
        // Iterate over each safeguard and append it to the table
        data.safeguards.forEach(function(safeguard) {
            var newRow = `<tr>
                <td><textarea class="form-control" maxlength="100">${safeguard.safeguard_description}</textarea></td>
                <td><textarea class="form-control" maxlength="100">${safeguard.safeguard_type}</textarea></td>
                <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
            </tr>`;
            $('#table_safeguards tbody').append(newRow);
        });
    } else {
        // If no safeguards, add a dummy row indicating this
        var newRow = `<tr>
            <td><textarea class="form-control" maxlength="100">No physical safeguards defined</textarea></td>
            <td><textarea class="form-control" maxlength="100">No physical safeguards defined</textarea></td>
            <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
        </tr>`;
        $('#table_safeguards tbody').append(newRow);
    }
        // Define the text values based on the percentage range
                    var textValue = "";
                    if (data.control_effectiveness < 25) {
                        textValue = "Low";
                    } else if (data.control_effectiveness < 50) {
                        textValue = "Low/Medium";
                    } else if (data.control_effectiveness < 75) {
                        textValue = "Medium";
                    } else if (data.control_effectiveness < 90) {
                        textValue = "Medium/High";
                    } else {
                        textValue = "High";
                    }
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');

         createEffectivenessGauge(data.control_effectiveness);
         createProbGauge(data.probability);
         createLikelihoodGauge(data.likelihood);
         createBIAGauge(data.ai_bia_score);
         createResidualRiskGauge(data.RRa);
         createFrequencyGauge(data.frequency);

        // Set the value of the 'control_effectiveness' text control
        document.getElementById('control_effectiveness').value = textValue;
        document.getElementById('hdnScenario').value = scenarioId;

         $('#txtRRa').val(data.RRa);
         $('#hdnLikelihood').val(data.likelihood);
        $('#txtLikelihood').val(data.likelihood + '%');
        $('#txtdataJustify').val(data.justifyData);
        $('#txtregulatoryJustify').val(data.justifyRegulation);
        $('#txtenvironmentJustify').val(data.justifyEnvironment);
        $('#txtreputationJustify').val(data.justifyReputation);
        $('#txtfinanceJustify').val(data.justifyFinancial);
        $('#txtproductionJustify').val(data.justifyProduction);
        $('#txtlifeJustify').val(data.justifyLife);
        $('#txtsafetyJustify').val(data.justifySafety);
        $('#hazardNature').val(data.safety_hazard);
        $('#dangerScope').val(data.dangerScope);
        if (data.sis_compromise) {
          $('#sisIntegrityYes').prop('checked', true);
        } else {
          $('#sisIntegrityNo').prop('checked', true);
        }

        if (data.sis_outage) {
            $('#sisOutageYes').prop('checked', true);

            } else {
            $('#sisOutageNo').prop('checked', true);

        }

        if (data.prodOutage) {
            $('#outageYes').prop('checked', true);
            toggleOutageControls(true);
            } else {
            $('#outageNo').prop('checked', true);
            toggleOutageControls(false);
        }
        $('#outageDuration').val(data.prodOutageDuration);
        $('#outageCost').val(data.prodOutageCost);


        if (data.user_role === 'Scenario Moderator') {
            disableScenarioControls();
        }
         });

        expandScenarioDetails();

    }

    function abbreviateValue(value) {
    var newValue = value;
    if (value >= 1000 && value < 1000000) {
        newValue = "$" + (value / 1000).toFixed(1) + "k"; // Thousands
    } else if (value >= 1000000) {
        newValue = "$" + (value / 1000000).toFixed(1) + "m"; // Millions
    } else {
        newValue = "$" + value; // Less than 1000
    }
    return newValue;
}

    function createCostChart(containerId, costArray) {
    var data = [];
    for (let i = 0; i < costArray.length; i++) {
        data.push({x: `Month ${i + 1}`, value: costArray[i]});
    }

    // Ensure the chart library is ready before creating the chart
    anychart.onDocumentReady(function() {
        // Clear the container before creating a new chart
        document.getElementById(containerId).innerHTML = '';

        // Create a line chart
        var chart = anychart.line();
        chart.data(data);

        // Set the chart title
        chart.title("Monthly Cost Estimates");

        // Customize the X-axis labels
        var xAxis = chart.xAxis();
        xAxis.title("Month");
        xAxis.labels()
            .rotation(-70) // Angle the labels
            .fontSize(10); // Smaller font size

        // Customize the Y-axis
        var yAxis = chart.yAxis();
        yAxis.title("Cost in USD");

        // Configure the line series
        var series = chart.line(data);
        series.hovered().markers()
              .enabled(true)       // Enable markers on hover
              .type('circle')      // Marker type as circle
              .size(4);            // Marker size
        series.markers()
              .enabled(true)       // Enable markers for all points
              .type('circle')      // Marker type as circle
              .size(3);            // Marker size

        series.labels(true);
        series.labels()
            .position("above")
            .anchor("centerBottom")
            .fontSize(10)
            .format(function() {
                return abbreviateValue(this.value);
            });

        // Optionally disable credits if needed
        var credits = chart.credits();
        credits.enabled(false);

        // Draw the chart in the specified container
        chart.container(containerId);
        chart.draw();
    });
}


    function disableScenarioControls() {
    // Disable all input, textarea, button, and select elements except those specified
    $('input, textarea, button, select').not('#scenarioStatusSelect, button[onclick="processFormData()"]').prop('disabled', true);

    // Additionally, hide or disable other elements as needed
    // For example, to hide specific buttons:
    // $('#someButtonId').hide();
    // Or to disable specific buttons:
    // $('#someButtonId').prop('disabled', true);
}



function clearContainer(containerId) {
    var container = document.getElementById(containerId);
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
}

$(document).ready(function() {
    // Check if there are any rows in the table
    var rows = $("#userscenarioListBody tr");
    if (rows.length > 0) {
        // If there are rows, trigger a click on the first one
        //rows.first().click();
    }
});



</script>


<input type="text" id="control_effectiveness" name="control_effectiveness" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtProbability" name="txtProbability" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtLikelihood" name="txtLikelihood" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtResidualRisk" name="txtResidualRisk" class="form-control text-center" readonly style="visibility: hidden">

<!-- Action Assets -->
                <div class="mb-3" style="visibility: hidden">>
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="row justify-content-center" style="visibility: hidden">
                                <div class="col-md-12">
                                <p class="justify-content-center">Expected Risk Mitigation from Action</p>
                                </div>
                            </div>
                            <div class="row justify-content-center" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="safetyMitigation">Safety: <span id="safetyMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="safetyMitigation" name="safetyMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="lifeMitigation">Life: <span id="lifeMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="lifeMitigation" name="lifeMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="productionMitigation">Production: <span id="productionMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="productionMitigation" name="productionMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="financeMitigation">Finance: <span id="financeMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="financeMitigation" name="financeMitigation" min="0" max="100" value="0">
                                </div>

                                <div class="col-md-4">
                                    <label for="reputationMitigation">Reputation: <span id="reputationMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="reputationMitigation" name="reputationMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="environmentMitigation">Environment: <span id="environmentMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="environmentMitigation" name="environmentMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="regulationMitigation">Regulation: <span id="regulationMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="regulationMitigation" name="regulationMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="dataMitigation">Data: <span id="dataMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="dataMitigation" name="dataMitigation" min="0" max="100" value="0">
                                </div>

                                <div class="col-md-4">
                                    <label for="supplyMitigation">Supply: <span id="supplyMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="supplyMitigation" name="supplyMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="threatMitigation">Threat: <span id="threatMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="threatMitigation" name="threatMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="vulnerabilityMitigation">Vulnerability: <span id="vulnerabilityMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="vulnerabilityMitigation" name="vulnerabilityMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <script>
                            document.addEventListener('DOMContentLoaded', (event) => {
                              // This function updates the span displaying the value of the slider
                              function updateSliderValue(slider) {
                                const valueDisplayId = slider.id + 'Value';
                                const valueDisplay = document.getElementById(valueDisplayId);
                                if (valueDisplay) {
                                  valueDisplay.textContent = slider.value + '%'; // Add the '%' symbol
                                } else {
                                  // console.error('No element found with id:', valueDisplayId);
                                }
                              }

                              // Get all range inputs on the form
                              const sliders = document.querySelectorAll('input[type="range"]');

                              // Initialize the display values and add event listeners to each slider
                              sliders.forEach(slider => {
                                updateSliderValue(slider); // Initialize the display value
                                slider.addEventListener('input', () => updateSliderValue(slider));
                              });
                            });

                            </script>
                        </div>

                    </div>
                </div>
<script src="{% static "js/block_manager.js" %}"></script>
<script>

                function convertSVGToPNG(svgElement, scale = 1) {
                                        var xmlSerializer = new XMLSerializer();
                                        var svgString = xmlSerializer.serializeToString(svgElement);

                                        var canvas = document.createElement('canvas');
                                        canvas.width = svgElement.getBoundingClientRect().width * scale;
                                        canvas.height = svgElement.getBoundingClientRect().height * scale;
                                        var ctx = canvas.getContext('2d');
                                        ctx.scale(scale, scale); // Apply scaling

                                        var DOMURL = window.URL || window.webkitURL || window;
                                        var img = new Image();
                                        var svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
                                        var url = DOMURL.createObjectURL(svgBlob);

                                        img.onload = function () {
                                            ctx.drawImage(img, 0, 0);
                                            DOMURL.revokeObjectURL(url);

                                            var imgURI = canvas.toDataURL('image/png');

                                            // Hide the SVG
                                            svgElement.style.display = 'none';

                                            // Target the container
                                            var container = document.getElementById('attack_tree');
                                            if (container) {
                                                // Clear previous content
                                                container.innerHTML = '';

                                                // Apply styles to center the image within the container
                                                container.style.display = 'flex';
                                                container.style.justifyContent = 'center';
                                                container.style.alignItems = 'center';
                                                container.style.height = '100%'; // Ensure the container has a defined height

                                                // Create an img element for the PNG image
                                                var pngImage = new Image();
                                                pngImage.src = imgURI;
                                                pngImage.style.maxWidth = '100%'; // Ensure the image scales within the container
                                                pngImage.style.maxHeight = '100%';

                                                // Append the image to the container
                                                container.appendChild(pngImage);
                                            } else {
                                                console.error('Container for the PNG image not found.');
                                            }
                                        };

                                        img.src = url;
                                }

function convertSVGToPNG(svgElement, containerId) {
    var container = document.getElementById(containerId);
    var containerWidth = container.clientWidth;
    var containerHeight = container.clientHeight;

    // Serialize the SVG element to a string
    var xmlSerializer = new XMLSerializer();
    var svgString = xmlSerializer.serializeToString(svgElement.node());

    // Create a Blob from the SVG string
    var svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    var DOMURL = window.URL || window.webkitURL || window;
    var url = DOMURL.createObjectURL(svgBlob);

    // Create an Image element to load the SVG blob
    var img = new Image();
    img.onload = function () {
        // Render at higher resolution
        var scale = 3; // Increase scale for higher resolution

        // Create a canvas element to draw the scaled SVG onto
        var canvas = document.createElement('canvas');
        canvas.width = img.width * scale; // Scale the canvas width
        canvas.height = img.height * scale; // Scale the canvas height
        var ctx = canvas.getContext('2d');

        // Draw the SVG image onto the canvas at the scaled size
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Convert the canvas to a PNG data URL
        var imgURI = canvas.toDataURL('image/png');

        // Set up the PNG image for insertion into the container
        var pngImage = new Image();
        pngImage.src = imgURI;
        pngImage.style.width = '100%'; // Make the image take up the full container width
        pngImage.style.height = 'auto'; // Auto-adjust the height to maintain aspect ratio

        // Clear the container and append the scaled PNG image
        container.innerHTML = '';
        container.appendChild(pngImage);

        // Clean up by revoking the object URL
        DOMURL.revokeObjectURL(url);
    };

    img.src = url;
}

function drawAttackTree(data) {
    var container = document.getElementById('attack_tree');
    var containerWidth = container.clientWidth;
    var containerHeight = container.clientHeight;
    var svgWidth = containerWidth;
    var svgHeight = 800; // Initial height for the SVG canvas

    d3.select(container).selectAll("svg").remove();

    var svg = d3.select(container).append("svg")
        .attr("width", "100%")
        .attr("viewBox", "0 0 " + svgWidth + " " + svgHeight)
        .attr("height", svgHeight)
        .style("display", "block")
        .style("margin", "auto")
        .style("background-color", "#253349C0") // Set the background color
        .append("g")
        .attr("transform", "translate(85,0) scale(0.8)"); // Move right by translating and then scale to 80%

    var i = 0,
        duration = 750,
        root;

    var treemap = d3.tree()
        .size([svgHeight / 0.8, svgWidth / 0.8]) // Adjust size for scaling
        .separation(function (a, b) { return (a.parent == b.parent ? 1 : 2); });

    root = d3.hierarchy(data, function (d) { return d.children; });
    root.x0 = svgHeight / 2;
    root.y0 = 0;

    // Color-blind-friendly color scale
    var colorScale = d3.scaleOrdinal(["#88CCEE", "#DDCC77", "#CC6677", "#882255", "#44AA99", "#117733", "#999933", "#AA4499"]);

    update(root);

    function update(source) {
        var treeData = treemap(root);

        var nodes = treeData.descendants(),
            links = treeData.descendants().slice(1);

        nodes.forEach(function (d) { d.y = d.depth * 180 });

        var node = svg.selectAll('g.node')
            .data(nodes, function (d) { return d.id || (d.id = ++i); });

        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", function (d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeEnter.append('circle')
            .attr('r', 10)
            .style("stroke", "black")
            .style("stroke-width", 1.5)
            .style("fill", function (d) { return colorScale(d.depth); });

        nodeEnter.append('text')
            .style("fill", "#FFFFFF") // Set label color to white
            .style("font-size", "0.8em")
            .style("font-weight", "bold")
            .attr("transform", "rotate(-10)")
            .attr("dy", ".30em")
            .attr("x", function (d) { return d.children ? -13 - this.getComputedTextLength() : 13; })
            .attr("text-anchor", function (d) { return d.children ? "end" : "start"; })
            .text(function (d) { return d.data.name; });

        var link = svg.selectAll('path.link')
            .data(links, function (d) { return d.id; });

        link.enter().insert('path', "g")
            .attr("class", "link")
            .style("stroke", "#96C5ECC0") // Set line color
            .style("stroke-width", 2)
            .style("fill", "none")
            .attr('d', function (d) {
                return "M" + d.y + "," + d.x
                    + "C" + (d.y + d.parent.y) / 2 + "," + d.x
                    + " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
                    + " " + d.parent.y + "," + d.parent.x;
            });
    }

    // After drawing the SVG, convert it to PNG and scale appropriately
    convertSVGToPNG(d3.select(container).select('svg'), 'attack_tree');
}

          function analyzeScenario(scenarioText, phaID, attacker, attack_vector) {
        var attackTreeDrawn = sessionStorage.getItem('attackTreeDrawn');
        var exposed_system = document.getElementById('exposed_system').checked;
        var weak_credentials = document.getElementById('weak_credentials').checked;
        var riskCategory = document.getElementById('risk-category').value;
        var malware = document.getElementById('malware-select').value;

        $('#loadingProgressBar').show();
        $('#progressBarInner').css('width', '0%').attr('aria-valuenow', 0);
        $('#progressBarMessage').text('').show(); // Initialize and show message

        let progress = 0;
        let progressBarInterval = setInterval(function() {
            progress += 2; // Increment progress by 10% every second
            if (progress <= 100) {
                $('#progressBarInner').css('width', progress + '%').attr('aria-valuenow', progress);

                // Update progress bar message based on current progress
                if (progress === 6) {
                    $('#progressBarMessage').text('Analysing consequences...');
                } else if (progress === 42) {
                    $('#progressBarMessage').text('Drawing attack tree...');
                }
            } else {
                clearInterval(progressBarInterval); // Clear interval if progress exceeds 100%
            }
        }, 1000); // Update progress every second

        $.ajax({
            url: "{% url 'OTRisk:analyze_scenario' %}",
            type: 'POST',
            data: {
                'scenario': scenarioText,
                'phaID': phaID,
                'attackTreeDrawn': attackTreeDrawn,
                'attacker': attacker,
                'riskCategory': riskCategory,
                'attack_vector': attack_vector,
                'exposed_system': exposed_system,
                'weak_credentials': weak_credentials,
                'malware': malware,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                clearInterval(progressBarInterval);
                $('#loadingProgressBar').hide();
                $('#progressBarMessage').hide();
                var biaData = JSON.parse(response.biaData);

                // Update each range slider with the corresponding value from the JSON response
                $('#range_safety').val(biaData.safety).change();
                $('#range_life').val(biaData.danger_to_life).change();
                $('#range_production').val(biaData.operations).change();
                $('#range_finance').val(biaData.finance).change();
                $('#range_reputation').val(biaData.reputation).change();
                $('#range_environment').val(biaData.environment).change();
                $('#range_regulation').val(biaData.regulatory_compliance).change();
                $('#range_data').val(biaData.data).change();
                $('#range_supply').val(biaData.supply_chain).change();
                var tableBody = document.getElementById('consequenceTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = ''; // Clear existing rows

                response.consequence.forEach(function(item, index) {
                    var row = tableBody.insertRow();
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);

                    cell1.innerHTML = item;
                    cell2.innerHTML = '<input type="checkbox" id="validate' + index + '" checked>';
                });


                if (sessionStorage.getItem('attackTreeDrawn') === 'false') {
                    var attackTreeData = response.attack_tree;

                    // Check if the attackTreeData does not contain the error key
                    if (!attackTreeData.error) {
                        document.getElementById('attack_tree_text').value = JSON.stringify(attackTreeData);

                        drawAttackTree(attackTreeData);
                    } else {
                        // Handle the error case, e.g., display a message to the user
                        console.error(attackTreeData.error);
                        // Optionally, display the error message to the user in a user-friendly manner
                    }
                }
                Swal.close();

            },
            error: function(xhr, status, error) {
                clearInterval(progressBarInterval);
                $('#loadingProgressBar').hide();
                $('#progressBarMessage').hide();
                Swal.close();
                // Parse the responseText to JSON if it is in JSON format
                var response = xhr.responseText;
                try {
                    var jsonResponse = JSON.parse(response);
                    if (jsonResponse.error) {
                        alert('Error: ' + jsonResponse.error);
                    } else {
                        alert('An error occurred: ' + response);
                    }
                } catch(e) {
                    // If responseText is not JSON, display it directly
                    alert('An error occurred: ' + response);
                }
            }
        });
    }
        </script>
</body>
</html>
