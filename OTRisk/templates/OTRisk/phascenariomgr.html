{% load static %}
<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>

<title>AnzenOT - GRC for OT</title>
<link rel="stylesheet" type="text/css" href="{%  static 'css/phascenariomgr.css' %}">

<link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">
<script src="https://d3js.org/d3.v6.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Load jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-linear-gauge.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/> <!-- FontAwesome CDN -->

<script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

<script>

     function getSeverityLabel(value) {
        switch (parseInt(value)) {
          case 1:
            case 2:
            return "Low";
          case 3:
            case 4:
            return "Low/Medium";
          case 5:
            case 6:
            return "Medium";
          case 7:
            case 8:
            return "Medium/High";
          case 9:
            case 10:
            return "High";
          default:
            return "";
        }
      }
    function initSlider(sliderId, outputId) {
        var slider = document.getElementById(sliderId);
        var output = document.getElementById(outputId);

        // Display the default slider value
        output.innerHTML = getSeverityLabel(slider.value);

        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
          output.innerHTML = getSeverityLabel(this.value);

        };
      }
// Initialize sliders when the page loads
window.onload = function() {
initSlider("range_safety", "safetyrange");
initSlider("range_life", "liferange");
initSlider("range_production", "productionrange");
initSlider("range_finance", "financerange");
initSlider("range_reputation", "reputationrange");
initSlider("range_environment", "environmentrange");
initSlider("range_regulatory", "regulatoryrange");
initSlider("range_data", "datarange");
initSlider("range_supply", "supplyrange");
initSlider('range_uel','uel_range');
initSlider('rru_range','range_rru');
initSlider('SMrange','range_SM');
initSlider('MELrange','range_MEL');
initSlider('RRMrange','range_RRM');

initSlider('uel_threat','threatLabel');
initSlider('uel_vuln','vulnerabilityLabel');
initSlider('uel_exposure','exposureLabel');

sessionStorage.setItem('attackTreeDrawn', 'false');
sessionStorage.setItem("ls", "0");
};

$(function () {
  $('[data-bs-toggle="tooltip"]').tooltip()
})
</script>
<style>
/* Modal Background */
.modal-content {
    background-color: #ffffff; /* Light background for the modal */
    border-radius: 8px; /* Rounded corners for the modal */
    border: 1px solid #dee2e6; /* Subtle border around the modal */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Shadow for depth */
}

/* Modal Header */
.modal-header {
    background-color: #007bff; /* Blue background for the header */
    color: #ffffff; /* White text color */
    border-bottom: 2px solid #0056b3; /* Darker blue border at the bottom */
    border-top-left-radius: 8px; /* Rounded top left corner */
    border-top-right-radius: 8px; /* Rounded top right corner */
}

/* Modal Title */
.modal-title {
    font-weight: bold;
}

/* Close Button */
.btn-close {
    filter: invert(1); /* Invert color for better visibility on dark backgrounds */
}

/* Modal Body */
.modal-body {
    padding: 20px; /* Increased padding for more space */
}

/* Form Controls Enhancement */
.form-control {
    border-radius: 5px; /* Rounded corners for form inputs */
    border: 1px solid #ced4da; /* Subtle border color */
}

/* Buttons */
.btn-primary {
    background-color: #0069d9; /* Slightly darker blue for primary buttons */
    border-color: #0062cc;
}

.btn-secondary {
    background-color: #6c757d; /* Dark gray for secondary buttons */
    border-color: #6c757d;
}

.btn-primary:hover, .btn-secondary:hover {
    opacity: 0.85; /* Slight opacity change on hover for feedback */
}

/* Custom Card inside Modal */
.card.mb-3.shadow-sm {
    background-color: #f8f9fa; /* Lighter background for cards */
    border: none; /* Remove border */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
}

.card-body {
    padding: 15px; /* Adjust padding */
}
.card-header {
    background-color: #007bff;
    color: white;
    font-size: 1.25rem;
}

.card-title {
    font-size: 1.1rem;
    font-weight: bold;
}

.card-text, #rationalePoints {
    font-size: 0.95rem;
    color: #464748;
}

#rationalePoints li {
    margin-bottom: 0.5rem;
}


/* Adjustments for range inputs */
input[type="range"].custom-range {
    cursor: pointer; /* Change cursor to pointer for better UX */
}

/* Enhancements for select dropdown */
.select.form-control {
    appearance: none; /* Remove default browser appearance */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"><path d="M7.247 14.86l-4.95-4.95.703-.703L7.95 13.457l5.997-5.996.703.703-5.95 5.95a.5.5 0 0 1-.703 0z"/></svg>'); /* Custom dropdown arrow */
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}

/* Ensure the modal stands out */
.modal-backdrop.show {
    opacity: 0.75; /* Darker backdrop for better focus on the modal */
}

.recommendation-box {
    margin: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    background-color: #f9f9f9;
}

.recommendation-text {
    font-size: 14px;
    margin-bottom: 5px;
    color: #000;
}

.nist-reference {
    font-size: 12px;
    text-align: right;
    color: #666;
}

    .form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}


     body {
        background-color: #464748;
        color: #d3d1cd;
    }
    .sidebar {
        height: 100vh;
        background-color: #2D2E30; /* Darker shade for sidebar */
        padding: 20px 0;
        width: 220px; /* Reduced width */
    }
    .sidebar-logo {
        padding: 10px 15px;
        text-align: center;
    }
    .nav-sidebar {
        display: flex;
        flex-direction: column;
        padding-left: 0;
        list-style: none;
    }
    .nav-sidebar .nav-item {
        padding: 5px 10px;
        /* border-bottom: 1px solid  #fac330; /* Light orange line */
        margin: 0 10%;
    }
    .nav-sidebar .nav-link {
        color: #d3d1cd;
        border-radius: 0;
        transition: color 0.3s ease-in-out;
        font-size: 0.8em;
    }
    .nav-sidebar .nav-link:hover, .nav-sidebar .nav-link.active {
        background-color: #3A5F5F;
        color: #E0E0E0;
    }
    /* Enhance dropdown menu */
    .dropdown-menu {
        background-color: #d3d1cd;
        border: none;
    }
    .dropdown-item:hover, .dropdown-item:focus {
        background-color: #fac330; /* Light orange background for hovered dropdown items */
        color: #2D2E30;
    }
    .content {
        padding: 20px;
    }
.custom-main-content {
    position: relative; /* Needed for absolute positioning of tabs */
    margin-left: 10px; /* Adjust to account for both sidebars */
    width: calc(100% - 350px); /* Adjust based on the total width of the sidebars */
    min-height: 100vh; /* Ensure it fills the viewport height */
}


@media (min-width: 992px) { /* Adjusting for Bootstrap's large devices breakpoint */
    .custom-main-content {
        width: calc(100% - 200px);
        max-width: calc(90vw - 200px);
        margin-left: 100px;
    }
}

/* Add this to your CSS file */
.docked-container {
    position: fixed;
    top: 0; /* Adjust based on your navbar height */
    right: 0; /* Adjust if necessary */
    width: 250px; /* Adjust based on your needs */
    height: 60px; /* Adjust based on your navbar height */
    z-index: 1030; /* Ensure it's above the navbar */
    display: none; /* Initially hidden */
}

.floating-container {
    position: fixed;
    width: 50%; /* Initial width when floating */
    display: none; /* Initially hidden */
    z-index: 1040; /* Ensure it's above other content */
}

/* Adjustments for when the container is minimized */
.minimized .content, .minimized .controls button:not(#maximizeBtn) {
    display: none;
}

.minimized #maximizeBtn {
    display: block;
}
svg {
    display: block;
    margin: 0 auto; /* Center the SVG in its container */
    overflow: visible;
}
.custom-main-content .container {
    width: 100%; /* Ensure the container fills the custom-main-content */
    max-width: none; /* Override Bootstrap's max-width for containers if necessary */
}
.top-strip {
    background-color: #464748; /* Same as body background for seamless integration */
    color: #d3d1cd; /* Text color */
    padding: 10px 20px; /* Adjust as needed */
    padding-left: 80px; /* Align with the end of the sidebar */
    width: calc(100% - 100px); /* Adjust based on the actual sidebar width */
    box-sizing: border-box;
}
.page-title {
    margin: 0; /* Remove default margins */
    font-size: 1.2rem; /* Adjust size as needed */
}
@media (max-width: 992px) {
    .top-strip {
        padding-left: 0;
        width: 100%;
    }
     .sub-menu {
        left: 0;
        width: 100px; /* Adjust for smaller screens */
    }

.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
    width: 80%; /* 80% of the available width to the right */
    height: 80vh; /* 80% of the viewport height */
    position: absolute; /* Positioning relative to its nearest positioned ancestor */
    left: 350px; /* This should be directly to the right of the sub-menu */
    top: 0; /* Align with the top of the viewport */
    overflow: auto; /* Add scroll for overflow content */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

.tab-content.active {
    display: block; /* Only the active tab is displayed */
}
    .custom-main-content {
        margin-left: 100px; /* Adjust based on the sub-menu width on smaller screens */
    }
}
/* Sub-menu styles */
.sub-menu {
    position: fixed; /* Fixed position to stay in view */
    top: 0; /* Align with the top of the viewport */
    left: 200px; /* Adjust based on the width of the main sidebar */
    width: 150px; /* Width of the sub-menu */
    height: 100vh; /* Full viewport height */
    background-color: #333; /* Sub-menu background color */
    color: #fff; /* Text color */
    padding: 20px 10px; /* Padding */
    box-sizing: border-box; /* Include padding in width calculation */
}
.sub-menu ul {
    list-style: none; /* Remove default list styling */
    padding: 0; /* Remove default padding */
    margin: 0; /* Remove default margin */
}

.sub-menu li a {
    color: #d3d1cd; /* Link color */
    text-decoration: none; /* Remove underline */
    display: block; /* Make the links fill the container */
    padding: 10px 0; /* Padding for touch targets */
    transition: background-color 0.3s; /* Smooth transition for hover effect */
}
.sub-menu li a:hover, .sub-menu li a.active {
    background-color: #57595b; /* Hover/active background color */
}
.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
}
.tab-content.active {
    display: block; /* Only the active tab is displayed */
}
.tab-content {
    display: none; /* Hide all tab content by default */
    padding: 20px; /* Padding around content */
    border: 1px solid #666; /* Border for definition */
    margin-top: 20px; /* Space from the top */
    width: 95%; /* 80% of the available width */
    /* height: 80vh; /* 80% of the viewport height */
    position: absolute; /* Positioning relative to its nearest positioned ancestor */
    left: 150px; /* Adjust based on the total width of the main sidebar and sub-menu */
    top: 0; /* Align with the top of the viewport */
    overflow: auto; /* Add scroll for overflow content */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

.tab-content.active {
    display: block; /* Only the active tab is displayed */
}

.top-strip {

    padding: 10px 0;
}

.top-strip .btn {
    margin-right: 10px; /* Spacing between buttons */
}

.page-title {

    text-decoration: none;
}

.page-title:hover {
    text-decoration: underline;
}


/* Style for the compliance_map table only */
#compliance_map {
    border-collapse: separate;
    border-spacing: 0 15px; /* Creates space between rows */
    margin: 20px; /* Adds some space around the table for aesthetics */
}

#compliance_map thead th {
    background-color: #004085; /* Dark blue background for headers */
    color: #fff; /* White text for contrast */
    text-align: left;
    font-size: 16px; /* Slightly larger font size for headers */
    padding: 10px; /* Padding inside header cells */
}

#compliance_map tbody tr {
    background-color: #f8f9fa; /* Light background for each row */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Shadow for depth */
    border-radius: 5px; /* Rounded corners for each row */
    margin-bottom: 15px; /* Space between rows */
}

#compliance_map td {
    padding: 10px; /* Padding inside each cell */
    vertical-align: middle; /* Aligns content in the middle vertically */
    border-top: 0; /* Removes the top border from cells */
}

#compliance_map a {
    color: #007bff; /* Color for links to make them stand out */
    text-decoration: none; /* Removes underline from links */
}

#compliance_map a:hover {
    text-decoration: underline; /* Adds underline on hover for links */
}
.tab-link.disabled {
    pointer-events: none; /* Prevent clicking */
    opacity: 0.5; /* Visual feedback that the link is disabled */
}


</style>
</head>
<body style="background-color: #464748">
<form id="cyberpha-form">
{% csrf_token %}
<script>
anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");
const links = document.querySelectorAll('.sub-menu a');

document.addEventListener("DOMContentLoaded", function() {
    const links = document.querySelectorAll('.sub-menu a');
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab) currentTab.classList.remove('active');
            const newTab = document.getElementById(this.getAttribute('data-tab'));
            newTab.classList.add('active');

            // Update active state for links
            document.querySelector('.sub-menu a.active')?.classList.remove('active');
            this.classList.add('active');
        });
    });
});
</script>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebarMenu">
                <div class="sidebar-sticky " >
                    <div class="sidebar-logo">
                        <img src="{% static 'images/anzen_owl.png' %}" class="img-fluid" alt="Logo">
                    </div>
                    <ul class="nav flex-column nav-sidebar">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'OTRisk:dashboardhome' %}">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'OTRisk:qraw' %}">QRAW</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}">CyberPHA</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:scenario_sim' %}">Scenario Builder</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:ra_actions_view_default' %}">Actions</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:risk_register' %}">Risk Register</a>
                        </li>
                        <li class="nav-item menu-item">
                            <a class="nav-link" href="{% url 'OTRisk:list_frameworks' %}">Assessments</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Admin
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">

                                <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:setup_org' %}">Set Defaults</a>
                                </li>
                            <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:cybersecurity_defaults_view' %}">Cyber Insurance</a>

                                </li>

                                {% if user.is_staff %}
                                <!-- Links visible only to superusers -->
                                 <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:admin_users' %}">Admin Users</a>
                                </li>
                                <li>
                                    <a  class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:upload_questionnaire' %}">Upload Questionnaires</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:user_admin' %}">User Administration</a>
                                </li>
                                <li>
                                    <a class="dropdown-item"  style="font-size: 12px;" href="{% url 'OTRisk:organization_form' %}">Manage Organizations</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" style="font-size: 12px;" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a>
                                </li>
                                {% endif %}
                            </ul>
                         </li>
                    <li class="nav-item menu-item">
                        <a class="nav-link" href="{% url 'accounts:profile' %}">
                        <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
                        </a>
                        </li>
                        <li class="nav-item menu-item">
                        <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="nav-link" style="background:none; border:none; padding:0; margin:0; color:inherit;">Logout</button>
                    </form>

                        </li>
                        </ul>
                </div>
            </nav>
            <div id="notificationMessage" class="notification-message" style="display: none;"></div>

            <div class="col-md-9 col-lg-10 position-relative">

                <div id="notificationMessage" class="notification-message" style="display: none;"></div>

                <div class="top-strip">
                <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-4">
                        <a class="page-title" style="color: #d3d1cd" href="#" id="cyberPHALink">CyberPHA Scenario Analysis - <span id="facilityName"></span></a>
                        <h6 style="visibility: hidden">Industry set to: <span id="facilityName2" class="text-decoration-underline text-body-emphasis" data-bs-toggle="tooltip" data-bs-placement="top" title="If the incorrect industry is displayed, return to the 'CyberPHA Manager' screen and select the 'Edit' button for this assessment from the table. Select the correct industry in the Assessment Setup form and save the record before re-selecting it to return to this screen"></span> </h6>
                            <h6 style="visibility: hidden"> <span id="user_role" class="text-decoration-underline text-body-emphasis"></span></h6>
                          <script>
                            $(document).ready(function() {
                            // Get the activeCyberPHA value from the session storage
                            let activeCyberPHA = sessionStorage.getItem('activeCyberPHA');

                            if (activeCyberPHA) {
                                let linkUrl = `/OTRisk/iotaphamanager/${activeCyberPHA}/`;  // Modify the URL path as needed
                                $('#cyberPHALink').attr('href', linkUrl);
                            } else {
                                window.location.href = "{% url 'OTRisk:iotaphamanager' %}";
                            }
                        });
                        document.getElementById('facilityName').textContent = sessionStorage.getItem('sessionFacility');

                        document.getElementById('facilityName2').textContent = sessionStorage.getItem('sessionIndustry');

                        </script>

                    </div>
                    <div class="col-md-1" > <button type="button" id="addScenarioBtn" class="btn nav-link" onclick="resetformcontrols()" ><i class="bi bi-folder-plus"></i> New</button></div>
                    <div class="col-md-1" ><button type="button" class="btn nav-link" data-bs-toggle="modal"  onclick="processFormData()"><i class="bi bi-box-arrow-down"></i> Save</button></div>
                    <div class="col-md-1" >
                        <button class="btn nav-link" type="button" id="actionBtn" onclick="showRAActionsModal()" ><i class="bi bi-person-plus"></i> Action</button>

                        <script>
                            function showRAActionsModal() {
                                var phaid = sessionStorage.getItem('activeCyberPHA');  // Get the value from session storage

                                if (phaid === null || phaid === "") {
                                    alert("Please select a CyberPHA assessment from the table first before creating an action item.");
                                } else {
                                    $('#RAActionsModal').modal('show');  // Show the modal if rawid has a value
                                }
                            }
                        </script>
                    </div>
                    <div class="col-md-1" ><button type="button" class="btn nav-link" data-bs-toggle="modal"  data-bs-target="#scenarioSelectModal"><i class="bi bi-box-arrow-down"></i> Load</button></div>
                    <div class="col-md-1">
                <button id="risk-assessment-btn" type="button" class="btn nav-link" ><i class="bi bi-bullseye"></i>
                    KPIs </button><br>

                            <script>
                            $(document).ready(function () {
                            $("#risk-assessment-btn").click(function () {
                                // Display the SweetAlert dialog
                                swal.fire({
                                    title: "Scenario KPIs",
                                    html: "Scenario KPIs can take up to a minute or longer to calculate. Proceed?",
                                    iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                                    showCancelButton: true, // Show the cancel button
                                    confirmButtonText: 'OK', // Text for the confirm button
                                    cancelButtonText: 'Cancel',
                                    focusConfirm: false // Focus on the confirm button by default
                                })
                                .then((result) => {
                                    if (result.isConfirmed) {
                                        // If the user clicks "Proceed", call the assessScenario function
                                        assessScenario();
                                    } else {
                                        // If the user clicks "Cancel", do nothing
                                        swal.fire({
                                            title: "AnzenOT Scenario Manager",
                                            text: "Operation Cancelled",
                                            icon: "error" // Assuming you want to show an error icon
                                        });
                                    }
                                });
                            });
                        });
                            </script>
                </div>
                    <div class="col-md-1">
                        <div class="form-group">
                        <label for="risk_register">Risk Register</label>
                        <input type="checkbox" id="risk_register" name="risk_register">
                            </div>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var riskRegisterCheckbox = document.getElementById('risk_register');

                            riskRegisterCheckbox.addEventListener('change', function() {
                                if (!riskRegisterCheckbox.checked) {
                                    // Re-check the checkbox if it was unchecked
                                    riskRegisterCheckbox.checked = true;
                                }
                            });
                        });
                        </script>


                    <div class="col-md-1">
                        <div class="form-group">
                        <label for="risk_snapshot">Create Snapshot</label>
                        <input type="checkbox" id="risk_snapshot" name="risk_snapshot">
                        </div>
                    </div>
                    <div class="col-md-1">
                    </div>
                </div>

                </div>

            <div class="text-label" style="padding-left: 250px; font-size: 20px;">
                <label id="echo_scenario" class="form-group"  style="word-wrap: normal;font-size: small; width: 50%; "></label><br>
                <div class="progress" style="display:none;" id="loadingProgressBar">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBarInner"></div>
                </div>
                <span id="progressBarMessage" style="display:block; text-align:center; margin-top:5px;"></span> <!-- Adjust styling as needed -->


                </div>
                <div class="sub-menu sub-menu-container small-font">
            <br><br><br><br><br><br><br><br><br><br><br><br>
            Click the tab headings
        <ul>
            <li><a href="#" data-tab="tab1" class="tab-link">Scenario Table</a></li>
            <li><a href="#" data-tab="tab2" class="tab-link">Scenario Detail</a></li>
            <li><a href="#" data-tab="tab3" class="tab-link">Scenario Parameters</a></li>
            <li><a href="#" data-tab="tab4" class="tab-link">Business Impact Assessment</a></li>

            <li><a href="#" data-tab="tab5" class="tab-link">Physical Safeguards</a></li>
            <li><a href="#" data-tab="tab6" class="tab-link">Risk Outcomes</a></li>
            <li><a href="#" data-tab="tab7" class="tab-link">Financial Analysis</a></li>
            <li><a href="#" data-tab="tab8" class="tab-link">Compliance Map</a></li>
            <li><a href="#" data-tab="tab9" class="tab-link">Attack Tree</a></li>
            <li><a href="#" data-tab="tab10" class="tab-link" >Recommendations</a></li>
        </ul>
    </div>

<script>
function updateEchoScenario() {
        var activeTab = $('.tab-link.active').attr('data-tab');
        // Check if the active tab is between tab3 and tab10
        if (activeTab && parseInt(activeTab.replace('tab', '')) > 2) {
            // Update the echo_scenario label with the content of the id_txtScenario textbox
            $('#echo_scenario').text($('#id_txtScenario').val());
        } else {
            // Clear the echo_scenario label
            $('#echo_scenario').text('');
        }
    }


$(document).ready(function() {
    $('.tab-link').click(function(e) {
        e.preventDefault(); // Prevent the default link behavior

        var currentTab = $(this).attr('data-tab');

        $('.tab-content').hide(); // Hide all tab contents
        $('#' + currentTab).show(); // Show the current tab content

        $('.tab-link').removeClass('active'); // Remove 'active' class from all tab links
        $(this).addClass('active'); // Add 'active' class to the clicked tab link

        updateEchoScenario();
    });

    // Event listener for changes in the id_txtScenario textbox
    $('#id_txtScenario').on('input', function() {
        // Update the echo_scenario label if one of the tabs from tab3 to tab10 is active
        updateEchoScenario();
    });

    // Initial update in case the page loads with a specific tab active
    updateEchoScenario();
});
</script>



         <div class="custom-main-content" >
        <div class="tab-content active" id="tab1">
            <span id="facilityNameTable"></span> <h2>Scenario Table</h2>
            <script>document.getElementById('facilityNameTable').textContent = sessionStorage.getItem('sessionFacility');</script>
            <br>
            <div class="form-group" style="background-color: #464748">
            <div class="row" style="background-color: #464748">
            <div class="col-md-12 " style="padding: 20px; background-color: #464748">

                    <table id="userscenarioList" class="table table-hover table-bordered overflow-auto" >
                        <thead>
                            <tr>
                                <th rowspan="2" style="width: 8%">ID</th>
                                <th rowspan="2" style="width: 30%">Scenario</th>
                                <th colspan="9">Impact Assessment Scores (Max = 10)</th>
                                <th rowspan="2">Threat</th>
                                <th rowspan="2">Risk</th>
                                <th rowspan="2"></th>
                            </tr>
                            <tr>
                                <th>Sfty</th>
                                <th>Dgr</th>
                                <th>Env</th>
                                <th>Sup</th>
                                <th>Fin</th>
                                <th>Ops</th>
                                <th>Data</th>
                                <th>Regs</th>
                                <th>Rep</th>
                            </tr>
                        </thead>

                        <tbody id="userscenarioListBody" style="font-size: 10px">
                          {% for saved_scenarios in saved_scenarios %}
                          <tr onclick="fillScenario({{ saved_scenarios.ID}}); ">
                            <td>
                                {{ saved_scenarios.formatted_id }}
                            </td>
                            <td>{{ saved_scenarios.Scenario }}</td>
                            <td>
                                {% if saved_scenarios.impactSafety < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactSafety >= 4 and saved_scenarios.impactSafety < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactSafety >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactSafety }}
                            </td>

                            <td>
                                {% if saved_scenarios.impactDanger < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactDanger  >= 4 and saved_scenarios.impactDanger  < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactDanger  >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactDanger  }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactEnvironment < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactEnvironment  >= 4 and saved_scenarios.impactEnvironment  < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactEnvironment  >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactEnvironment  }}
                            </td>
                          <td>
                              {% if saved_scenarios.impactSupply < 4 %}
                                  <span class="green-circle"></span>
                              {% elif saved_scenarios.impactSupply >= 4 and saved_scenarios.impactSupply < 8 %}
                                  <span class="orange-circle"></span>
                              {% elif saved_scenarios.impactSupply >= 8 %}
                                  <span class="red-circle"></span>
                              {% endif %}
                              {{ saved_scenarios.impactSupply }}
                          </td>

                            <td>
                                {% if saved_scenarios.impactFinance < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactFinance >= 4 and saved_scenarios.impactFinance < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactFinance >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactFinance }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactProduction < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactProduction >= 4 and saved_scenarios.impactProduction < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactProduction >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactProduction }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactData < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactData >= 4 and saved_scenarios.impactData < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactData >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactData }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactRegulation < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactRegulation >= 4 and saved_scenarios.impactRegulation < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactRegulation >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactRegulation }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactReputation < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactReputation >= 4 and saved_scenarios.impactReputation < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactReputation >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactReputation }}
                            </td>


                            <td>{{ saved_scenarios.ThreatClass }}</td>
                            <td>{{ saved_scenarios.RiskCategory }}</td>
                            <td>
                                <a href="{% url 'OTRisk:deletescenario' saved_scenarios.ID saved_scenarios.CyberPHA.ID %}"
                                   class="btn btn-danger"
                                   onclick="return checkDeleteCondition();">Del</a>

                                <script>
                                    function checkDeleteCondition() {
                                        var lsValue = sessionStorage.getItem("ls");
                                        if (lsValue === "1") {
                                            swal.fire("AnzenOT Scenario Manager", "Changes cannot be made to this scenario because it has been added to the risk register");
                                            return false; // Prevent the default action (i.e., following the link)
                                        }
                                        return confirm('Are you sure you want to delete this record? (Note that if you proceed, the record will be virtually deleted and can be recovered if necessary)');
                                    }
                                </script>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    <script>
                        // Function to handle row click and highlighting
                        function highlightRow(row) {
                            // Remove highlighting from any previously clicked row
                            $("#userscenarioListBody tr").removeClass('highlighted');
                            // Add highlighting to the current clicked row
                            $(row).addClass('highlighted');

                        }

                            // Function to load the vulnerability table component
                            function loadVulnerabilityTable(scenarioId) {
                                // Load the vulnerability table into the specified div container
                                $('#vulnerabilityTableContainer').load('/OTRisk/scenario_vulnerability/' + scenarioId + '/', function () {
                                    // Initialize select2 for the asset_type field
                                    $('.select2').select2();

                                    // Handle form submission asynchronously (if needed)
                                    $('#vulnerability-form').on('submit', function (e) {
                                        e.preventDefault();
                                        $.ajax({
                                            type: 'POST',
                                            url: $(this).attr('action'),
                                            data: $(this).serialize(),
                                            success: function () {
                                                // Refresh the table
                                                loadVulnerabilityTable(scenarioId);
                                            },
                                        });
                                    });
                                });
                            }
                    </script>

            </div>
            </div>
        </div>
        </div>

         <div class="tab-content" id="tab2">

                <h2>Scenario Detail</h2>
                <div class="form-group">
                    <label for="txtScenario"><h6>Scenario</h6></label>
                        <!-- Render the textarea without the label -->
                        {{ scenario_form.txtScenario }}
                        {% if scenario_form.txtScenario.errors %}
                            <!-- Custom error handling or styling can be done here -->
                        {% endif %}


                    <script>

                    document.addEventListener('DOMContentLoaded', function() {
                            // Adjust the ID here to match the generated ID by Django
                            var txtScenarioElement = document.getElementById('id_txtScenario');
                            var analyzeScenarioBtn = document.getElementById('analyzeScenarioBtn');

                            // Enable the button when the user types in the textarea
                            if (txtScenarioElement) {
                                txtScenarioElement.addEventListener('input', function() {
                                    analyzeScenarioBtn.disabled = this.value.trim() === ''; // Enable only if there's text
                                });
                            }

                            // Add click event listener to the button
                            analyzeScenarioBtn.addEventListener('click', function() {
                                // Your existing AJAX call or any other logic here

                                // Immediately disable the button after it's clicked
                                this.disabled = true;

                                // Optionally, clear the textarea or perform other actions
                                // txtScenarioElement.value = ''; // Uncomment if you want to clear the textarea
                            });
                      });

                    </script>
                </div>

                <button id="analyzeScenarioBtn" class="btn btn-primary" type="button" disabled>Update consequence/s >>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;" id="loadingSpinner2"></span>
                </button>
                <script>

                function convertSVGToPNG(svgElement, scale = 1) {
                                        var xmlSerializer = new XMLSerializer();
                                        var svgString = xmlSerializer.serializeToString(svgElement);

                                        var canvas = document.createElement('canvas');
                                        canvas.width = svgElement.getBoundingClientRect().width * scale;
                                        canvas.height = svgElement.getBoundingClientRect().height * scale;
                                        var ctx = canvas.getContext('2d');
                                        ctx.scale(scale, scale); // Apply scaling

                                        var DOMURL = window.URL || window.webkitURL || window;
                                        var img = new Image();
                                        var svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
                                        var url = DOMURL.createObjectURL(svgBlob);

                                        img.onload = function () {
                                            ctx.drawImage(img, 0, 0);
                                            DOMURL.revokeObjectURL(url);

                                            var imgURI = canvas.toDataURL('image/png');

                                            // Hide the SVG
                                            svgElement.style.display = 'none';

                                            // Target the container
                                            var container = document.getElementById('attack_tree');
                                            if (container) {
                                                // Clear previous content
                                                container.innerHTML = '';

                                                // Apply styles to center the image within the container
                                                container.style.display = 'flex';
                                                container.style.justifyContent = 'center';
                                                container.style.alignItems = 'center';
                                                container.style.height = '100%'; // Ensure the container has a defined height

                                                // Create an img element for the PNG image
                                                var pngImage = new Image();
                                                pngImage.src = imgURI;
                                                pngImage.style.maxWidth = '100%'; // Ensure the image scales within the container
                                                pngImage.style.maxHeight = '100%';

                                                // Append the image to the container
                                                container.appendChild(pngImage);
                                            } else {
                                                console.error('Container for the PNG image not found.');
                                            }
                                        };

                                        img.src = url;
                                }



            function drawAttackTree(data) {
                $('#tab9').addClass('active').show();
                var container = document.getElementById('attack_tree');
                var containerWidth = container.clientWidth;
                var svgWidth = containerWidth * 0.8;
                var margin = { top: 20, right: 120, bottom: 20, left: 280 };
                var width = svgWidth - margin.left - margin.right;
                var height = 800; // Increased height for better resolution

                d3.select(container).selectAll("svg").remove();

                var svg = d3.select(container).append("svg")
                    .attr("width", "100%")
                    .attr("viewBox", "0 0 " + svgWidth + " " + height)
                    .attr("height", height)
                    .style("display", "block")
                    .style("margin", "auto")
                    .style("background-color", "#253349C0") // Set the background color
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var i = 0,
        duration = 750,
        root;

    var treemap = d3.tree()
        .size([height, width - margin.left - margin.right])
        .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2); });

    root = d3.hierarchy(data, function(d) { return d.children; });
    root.x0 = height / 2;
    root.y0 = 0;

    // Color-blind-friendly color scale
    var colorScale = d3.scaleOrdinal(["#88CCEE", "#DDCC77", "#CC6677", "#882255", "#44AA99", "#117733", "#999933", "#AA4499"]);

    update(root);

    function update(source) {
        var treeData = treemap(root);

        var nodes = treeData.descendants(),
            links = treeData.descendants().slice(1);

        nodes.forEach(function(d) { d.y = d.depth * 180 });

        var node = svg.selectAll('g.node')
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeEnter.append('circle')
            .attr('r', 10)
            .style("stroke", "black")
            .style("stroke-width", 1.5)
            .style("fill", function(d) { return colorScale(d.depth); });

        nodeEnter.append('text')
            .style("fill", "#FFFFFF") // Set label color to white
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .attr("transform", "rotate(-10)")
            .attr("dy", ".35em")
            .attr("x", function(d) { return d.children ? -13 - this.getComputedTextLength() : 13; })
            .attr("text-anchor", function(d) { return d.children ? "end" : "start"; })
            .text(function(d) { return d.data.name; });

        var link = svg.selectAll('path.link')
            .data(links, function(d) { return d.id; });

        link.enter().insert('path', "g")
            .attr("class", "link")
            .style("stroke", "#96C5ECC0") // Set line color
            .style("stroke-width", 2)
            .style("fill", "none")
            // Removed the arrow marker reference
            .attr('d', function(d) {
                return "M" + d.y + "," + d.x
                    + "C" + (d.y + d.parent.y) / 2 + "," + d.x
                    + " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
                    + " " + d.parent.y + "," + d.parent.x;
            });
    }

            // Add border and shadow to the container
            var attackTreeDiv = document.getElementById('attack_tree');
            attackTreeDiv.style.display = 'block';
            attackTreeDiv.style.border = '1px solid #ccc';
            attackTreeDiv.style.boxShadow = '0px 0px 10px rgba(0, 0, 0, 0.5)';
            sessionStorage.setItem('attackTreeDrawn', 'true');
            var svgElement = container.querySelector('svg');
            // Pass it to the convertSVGToPNG function
            convertSVGToPNG(svgElement, 0.8); // Adjust the scale as needed
            var attackTreeDiv = document.getElementById('attack_tree')
            $('.tab-content').removeClass('active').hide();
             $('#tab2').addClass('active').show();
            // Add export button functionality (if feasible)
            var exportButton = document.getElementById('exportButton');
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    var svgData = new XMLSerializer().serializeToString(document.querySelector('svg'));
                    var svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
                    var svgUrl = URL.createObjectURL(svgBlob);
                    var downloadLink = document.createElement("a");
                    downloadLink.href = svgUrl;
                    downloadLink.download = "attack_tree.svg";
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                });
            }
        }


                document.getElementById('analyzeScenarioBtn').addEventListener('click', function() {
                var scenarioText = document.getElementById('id_txtScenario').value;
                var phaID = document.getElementById('hdnphaID').value;
                var attackTreeDrawn = sessionStorage.getItem('attackTreeDrawn');
                var button = this;
                $('#loadingProgressBar').show();
                $('#progressBarInner').css('width', '0%').attr('aria-valuenow', 0);
                $('#progressBarMessage').text('').show(); // Initialize and show message
                button.disabled = true;
                 $('.tab-link').addClass('disabled');
                let progress = 0;
                    let progressBarInterval = setInterval(function() {
                        progress += 3; // Increment progress by 10% every second
                        if (progress <= 100) {
                            $('#progressBarInner').css('width', progress + '%').attr('aria-valuenow', progress);

                            // Update progress bar message based on current progress
                            if (progress === 6) {
                                $('#progressBarMessage').text('Analysing consequences...');
                            } else if (progress === 40) {
                                $('#progressBarMessage').text('Drawing attack tree...');
                            }
                        } else {
                            clearInterval(progressBarInterval); // Clear interval if progress exceeds 100%
                        }
                    }, 1000); // Update progress every second
                $.ajax({
                    url: "{% url 'OTRisk:analyze_scenario' %}",
                    type: 'POST',
                    data: {
                        'scenario': scenarioText,
                        'phaID': phaID,
                        'attackTreeDrawn': attackTreeDrawn, // this variable is set to indicate that an attack tree is already drawn for this scenario so another one wont be processed
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        clearInterval(progressBarInterval);
                        $('#loadingProgressBar').hide();
                        $('#progressBarMessage').hide();
                         $('.tab-link').removeClass('disabled');
                        button.disabled = false;

                        var tableBody = document.getElementById('consequenceTable').getElementsByTagName('tbody')[0];
                        tableBody.innerHTML = ''; // Clear existing rows

                        response.consequence.forEach(function(item, index) {
                            var row = tableBody.insertRow();
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);

                            cell1.innerHTML = item;
                            cell2.innerHTML = '<input type="checkbox" id="validate' + index + '">';
                        });

                        if (sessionStorage.getItem('attackTreeDrawn') === 'false') {
                            document.getElementById('attack_tree_text').value = JSON.stringify(response.attack_tree);

                            drawAttackTree(response.attack_tree);
                        }


                    },
                    error: function(xhr, status, error) {
                        clearInterval(progressBarInterval);
                        $('#loadingProgressBar').hide();
                        $('#progressBarMessage').hide();
                         $('.tab-link').removeClass('disabled');
                        button.disabled = false;

                        // Parse the responseText to JSON if it is in JSON format
                        var response = xhr.responseText;
                        try {
                            var jsonResponse = JSON.parse(response);
                            if (jsonResponse.error) {
                                alert('Error: ' + jsonResponse.error);
                            } else {
                                alert('An error occurred: ' + response);
                            }
                        } catch(e) {
                            // If responseText is not JSON, display it directly
                            alert('An error occurred: ' + response);
                        }
                    }
                });
            });
        </script>
             <p></p>
                <div class="form-group">
                <label for="consequenceTable"><h6>Consequences</h6></label>

                <table id="consequenceTable" class="table">
                    <thead>
                        <tr>
                            <th>Consequence</th>
                            <th>Validate</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be added here dynamically -->
                    </tbody>
                </table>
                </div>





        </div>
         <div class="tab-content " id="tab3">
            <h2>Scenario Parameters</h2>

            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                    <label class="form-label" for="threat-intelligence"><h6>Threat Source</h6></label>
                    <select class="form-control small-font" name="threat-intelligence" id="threat-intelligence" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 5px; background-color: white">
                        <option value="">-- Select a threat source --</option>
                        {% for threat_intelligence in threat_intelligence %}
                            <option value="{{ threat_intelligence.ThreatDescription }}">{{ threat_intelligence.ThreatDescription }}</option>
                        {% endfor %}
                    </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                    <label class="form-label" for="risk-category"><h6>Risk Category</h6></label>
                <select class="form-control small-font" name="risk-category" id="risk-category" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding:5px; background-color: white">
                  <option value="">Select a risk category</option>
                  {% for risk_category in risk_categories %}
                    <option value="{{ risk_category.CategoryName }}">{{ risk_category.CategoryName }}</option>
                  {% endfor %}
                </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                    <label class="switch-label"><h6>Internet Exposed IP Address</h6></label>
                    <label class="switch">
                    <input for="exposed_system" type="checkbox" id="exposed_system" name="exposed_system">
                    <span class="slider1 round"></span>
                    </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                    <label class="switch-label"><h6>Default/Weak Credentials</h6></label>
                    <label for="weak_credentials" class="switch">
                    <input type="checkbox" id="weak_credentials" name="weak_credentials">
                    <span class="slider1 round"></span>
                    </label>
                    </div>
                </div>
                <div class="col-md-6">


        </div>
                </div>



         <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                <h5>Unmitigated Risk</h5>
                <h6>(Risk exposure without current controls)</h6>
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <div class="slider-container d-flex align-items-center">
                            <div class="col-3">
                                <label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#uelModal" data-bs-placement="top" style="color: #464748">Unmitigated Event Likelihood (UEL)</label></div>
                            <div class="col-6">
                              <input type="range" min="1" max="10" value="1" class="slider" id="uel_range" name="uel_range" onchange="initSlider('uel_range','range_uel');">
                            </div>
                            <div class="col-3"><h6><label id="range_uel" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-3">
                        <label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#rruModal" data-bs-placement="top" style="color: #464748">Residual Risk Unmitigated (RRu)</label>
                    </div>
                    <div class="col-6">
                      <input type="range" min="1" max="10" value="1" class="slider" id="rru_range" name="rru_range" onchange="initSlider('rru_range','range_rru');">
                    </div>
                    <div class="col-3"><h6><label id="range_rru" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                    <div class="form-group">
                <label for="selSL" class="small-font d-flex align-items-center " >Security Level Achieved (SL-A)</label>

                <select class="form-control small-font" name="selSL" id="selSL" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 5px; background-color: white">
                    <option value=""> -- Select SL-A -- </option>
                    {% for value, description in SECURITY_LEVELS %}
                        <option value="{{ value }}">
                            {{ description }}</option>
                    {% endfor %}
                </select>

            </div>
                 </div>
            </div>
             <div class="col-md-6">
                <div class="form-group">
                <h5>Assessment - Mitigated Risk</h5>
                <h6>(Risk exposure with current controls)</h6>
                        <!--slider for UEL - likelihood without controls-->
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                    <div class="card-body">
                        <div class="slider-container d-flex align-items-center">
                            <div class="col-3"><label class="small-font d-flex align-items-center " ><img src="{% static 'images/sm.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px; color: #464748">&nbsp;&nbsp;Severity Mitigated (Sm)</label></div>
                            <div class="col-6">
                              <input type="range" min="1" max="10" value="1" class="slider_reversed" id="SMrange" name="SMrange" onchange="initSlider('SMrange','range_SM');">
                            </div>
                            <div class="col-3"><h6><label id="range_SM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                        </div>
                    </div>
                </div>
                <!--slider for MEL - Mitigated Exposure Level-->
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                    <div class="card-body">
                        <div class="slider-container d-flex align-items-center">
                            <div class="col-3"><label class="small-font d-flex align-items-center " ><img src="{% static 'images/mel.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px; color: #464748">&nbsp;&nbsp;Mitigated Exposure (MEL)</label></div>
                            <div class="col-6">
                              <input type="range" min="1" max="10" value="1" class="slider_reversed" id="MELrange" name="MELrange" onchange="initSlider('MELrange','range_MEL');">
                            </div>
                            <div class="col-3"><h6><label id="range_MEL" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                        </div>
                    </div>
                </div>
                <!--slider for MEL - Mitigated Exposure Level-->
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                    <div class="card-body">
                        <div class="slider-container d-flex align-items-center">
                            <div class="col-3"><label class="small-font d-flex align-items-center " ><img src="{% static 'images/rrm.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px; color: #464748">&nbsp;&nbsp;Residual Risk (RRm)</label></div>
                            <div class="col-6">
                              <input type="range" min="1" max="10" value="1" class="slider" id="RRMrange" name="RRMrange" onchange="initSlider('RRMrange','range_RRM');">
                            </div>
                            <div class="col-3"><h6><label id="range_RRM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                        </div>
                    </div>
        </div>
        </div>
            </div>
         </div>

                    <div id="scenarioStatus">
                            <label for="scenarioStatusSelect" class="form-label">Scenario Status</label>
                            <select class="form-select" id="scenarioStatusSelect" name="scenario_status">
                                <option value="0">---Select Scenario Status---</option>
                                {% for status, status_display in scenario_status %}
                                <option value="{{ status }}">{{ status_display }}</option>
                                {% endfor %}
                            </select>

                    </div>
        </div>

         <div class="tab-content " id="tab4">
            <h2>Business Impact Assessment</h2>
            <div class="row">

                <div class="col-md-6">
                    <div class="form-group">
                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="slider-container d-flex align-items-center">
                                <div class="col-3">
                                    <label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#safetyModal" data-modal-id="safetyModal" data-textarea-id="txtsafetyJustify"><img src="{% static 'images/safety.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Safety</label><span id="textIndicator" style="display: none;" spellcheck="true"><i class="bi bi-journal-text"></i></span>
                                </div>
                                <div class="col-6">
                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_safety" name="range_safety" onchange="initSlider('range_safety', 'safetyrange');">
                                </div>
                                <div class="col-3"><label id="safetyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></div>
                            </div>
                        </div>
                    </div>
                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                            <div class="card-body">
                                <!--slider for Life rating -->
                                <div class="slider-container d-flex align-items-center">
                                    <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#lifeModal" data-bs-placement="top" data-modal-id="lifeModal" data-textarea-id="txtlifeJustify"><img src="{% static 'images/danger.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Life</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                    <div class="col-6">
                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_life" name="range_life" onchange="initSlider('range_life', 'liferange');">
                                    </div>
                                    <div class="col-3"><h6><label id="liferange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                                </div>
                            </div>
                        </div>
                        <!--slider for Production impact rating -->
                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                            <div class="card-body">
                                <div class="slider-container d-flex align-items-center">
                                    <div class="col-3"><label for="range_production" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#productionModal" data-bs-placement="top" data-modal-id="productionModal" data-textarea-id="txtproductionJustify"><img src="{% static 'images/production.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Production</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                    <div class="col-6">
                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_production" name="range_production" onchange="initSlider('range_production', 'productionrange');">
                                    </div>
                                    <div class="col-3"><h6><label id="productionrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                                </div>
                            </div>
                        </div>
                         <!--slider for financial rating -->
                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                            <div class="card-body">
                                <div class="slider-container d-flex align-items-center">
                                    <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#financeModal" data-bs-placement="top" data-modal-id="financeModal" data-textarea-id="txtfinanceJustify"><img src="{% static 'images/finance.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Financial</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                    <div class="col-6">
                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_finance" name="range_finance" onchange="initSlider('range_finance', 'financerange');">
                                    </div>
                                    <div class="col-3"><h6><label id="financerange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                                </div>
                            </div>
                        </div>
                        <!--slider for reputation rating -->
                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                            <div class="card-body">
                                <div class="slider-container d-flex align-items-center">
                                    <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#reputationModal" data-bs-placement="top" data-modal-id="reputationModal" data-textarea-id="txtreputationJustify"><img src="{% static 'images/reputation.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Reputation</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                    <div class="col-6">
                                      <input type="range" min="1" max="10" value="1" class="slider" id="range_reputation" name="range_reputation" onchange="initSlider('range_reputation', 'reputationrange');">
                                    </div>
                                    <div class="col-3"><h6><label id="reputationrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                        <div class="form-group">
                        <!--slider for environment impact rating -->
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="slider-container d-flex align-items-center">
                                <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#environmentModal" data-bs-placement="top" data-modal-id="environmentModal" data-textarea-id="txtenvironmentJustify"><img src="{% static 'images/environment.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Environment</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                <div class="col-6">
                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_environment" name="range_environment" onchange="initSlider('range_environment', 'environmentrange');">
                                </div>
                                <div class="col-3"><h6><label id="environmentrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                            </div>
                        </div>
                    </div>
                    <!--slider for regulatory impact rating -->
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="slider-container d-flex align-items-center">
                                <div class="col-3"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#regulatoryModal" data-bs-placement="top" data-modal-id="regulatoryModal" data-textarea-id="txtregulatoryJustify"><img src="{% static 'images/regulation.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Regulatory</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                <div class="col-6">
                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_regulatory" name="range_regulatory" onchange="initSlider('range_regulatory', 'regulatoryrange');">
                                </div>
                                <div class="col-3"><h6><label id="regulatoryrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                            </div>
                        </div>
                    </div>
                    <!--slider for data impact rating -->
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="slider-container d-flex align-items-center">
                                <div class="col-3"><label for="range_data" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#dataModal" data-bs-placement="top" data-modal-id="dataModal" data-textarea-id="txtdataJustify"><img src="{% static 'images/data.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Data/IP</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                <div class="col-6">
                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_data" name="range_data" onchange="initSlider('range_data', 'datarange');">
                                </div>
                                <div class="col-3"><h6><label id="datarange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="slider-container d-flex align-items-center">
                                <div class="col-3"><label for="range_supply" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#supplyModal" data-bs-placement="top" data-modal-id="supplyModal" data-textarea-id="txtsupplyJustify"><img src="{% static 'images/supply.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Supply Chain</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                                <div class="col-6">
                                  <input type="range" min="1" max="10" value="1" class="slider" id="range_supply" name="range_supply" onchange="initSlider('range_supply', 'supplyrange');">
                                </div>
                                <div class="col-3"><h6><label id="supplyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

            </div>
             <div class="row">
                 <div class="col-md-6 small-font" >
                 <p>
                    1 - Negligible Impact: Minimal impact that is easily absorbed by routine operations. No significant action required, and any effects are quickly mitigated with standard procedures.
                  </p>
                   <p>
                    2 - Minor Impact: Slight disruptions that may require minimal intervention. Impact is largely contained and does not significantly affect performance or safety.
                    </p>
                   <p>
                    3 - Low Impact: Noticeable but manageable disruptions to operations or processes. May require some adjustments to workflow or minor remedial actions to mitigate.
                    </p>
                   <p>
                    4 - Moderate Low Impact: Moderate disruptions with potential to affect operational efficiency. Requires active management to mitigate risks and prevent escalation. Minor safety or environmental concerns may be present.
                    </p>
                   <p>
                    5 - Moderate Impact: Clear impact on operations or safety, requiring significant attention to manage and mitigate. May lead to temporary reductions in production or efficiency. Environmental or reputational impacts are noticeable but controllable.
                    </p>
                 </div>
                 <div class="col-md-6 small-font">
                     <p>
                     6 - Moderate High Impact: Substantial disruptions with immediate need for intervention. Production or operations may be significantly hindered. Safety or environmental risks are elevated, requiring urgent attention.
                    </p>
                   <p>
                    7 - High Impact: Major impact on operations, safety, or environment. Production may be halted or severely reduced. Immediate and comprehensive response required to manage significant risks.
                    </p>
                   <p>
                    8 - Severe Impact: Critical disruptions to operations with long-term implications. Safety and environmental risks are high, potentially leading to lasting damage to reputation and supply chain.
                    </p>
                   <p>
                    9 - Critical Impact: Near-total disruption of operations. Safety and environmental hazards present severe risks to personnel and surroundings. Recovery requires extensive resources and time.
                    </p>
                   <p>
                    10 - Catastrophic Impact: Complete shutdown of operations. Critical safety and environmental emergencies with widespread repercussions. Long-term recovery uncertain, with profound effects on reputation and viability.
                   </p>
                 </div>
             </div>


        </div>

         <div class="tab-content " id="tab5">
            <h2>Physical Safeguards</h2>
               <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title" >Physical Safeguards</h5>
                        <div id="tablePhysicalControls" class="mb-2">
                            <button id="addRowBtn" class="btn btn-primary btn-sm" type="button">Add Row</button>
                        </div>
                        <table class="table table-bordered small-font" id="table_safeguards">
                            <thead>
                                <tr>
                                    <th>Safeguard</th>
                                    <th>Safeguard Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be added here dynamically -->
                            </tbody>
                        </table>
                        <script>
                            $(document).ready(function() {
                                $("#addRowBtn").click(function() {
                                    var newRow = `<tr>
                                        <td><textarea class="form-control" maxlength="100"></textarea></td>
                                        <td><textarea class="form-control" maxlength="100"></textarea></td>
                                        <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
                                    </tr>`;
                                    $("#table_safeguards tbody").append(newRow);
                                });

                                // Event delegation to handle dynamically added elements
                                $("#table_safeguards").on("click", ".deleteRowBtn", function() {
                                    $(this).closest("tr").remove();
                                });
                            });
                            </script>
                            <input type="hidden" id="hdnrationale_recommendation">
                            <input type="hidden" id="hdnrationale_Rationale">
                    </div>
                </div>

        </div>
         <div class="tab-content " id="tab6">
            <h2>Risk Outcomes</h2>
             <div class="row d-flex h-30">
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                        <div class="card-body">
                            <label for="control_effectiveness" class="small-font">Control Effectiveness (%)</label>
                            <div id="gaugeContainer" style="width: 100%; "></div>
                            <input type="hidden" id="hdn_control_effectiveness" name="hdn_control_effectiveness">
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                    <div class="card-body">
                        <label for="txtBIAScore" class="small-font">BIA Score</label>
                            <div id="gaugeBIAContainer" style="width: 100%; "></div>
                        <input type="hidden" id="hdn_bia_score" name="hdn_bia_score">

                    </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                    <div class="card-body">
                        <label for="txtProbability" class="small-font">Estimated Attack Success Probability (%)</label>
                            <div id="gaugeProbContainer" style="width: 100%; "></div>
                    </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                    <div class="card-body">
                        <label for="txtLikelihood" class="small-font">Estimated Risk Likelihood (%)</label>
                            <div id="gaugeLikelihoodContainer" style="width: 100%; "></div>

                            <input type="hidden" id="hdnLikelihood" name="hdnLikelihood">
                    </div>
                    </div>
                </div>
            </div>
             <div class="row d-flex h-30">
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                        <div class="card-body" >
                            <label for="frequency" class="small-font">Estimated Frequency</label>
                            <div id="gaugeFrequency" style="width: 100%;  margin-top: 0; padding-top: 0"></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                        <div class="card-body">
                            <label for="txtResidualRisk" class="small-font" style="margin-bottom: 0;">Estimated Residual Risk</label>
                            <div id="gaugeResidualRisk" style="width: 100%; margin-top: 0; padding-top: 0"></div>

                            </div>
                    </div>
                </div>

            </div>
             <div class="row">
                <div class="col-lg-12">
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header">
                            Cybersecurity Risk Assessment Recommendation
                        </div>
                        <div class="card-body">
                            <h5 class="card-title" id="recommendationTitle">Recommendation</h5>
                            <p class="card-text" id="recommendationText"></p>
                            <h5 class="card-title" id="rationaleTitle">Rationale</h5>
                            <ul id="rationalePoints"></ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="tab-content " id="tab7">
            <h2>Financial Analysis</h2>
            <div class="row">
                <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100 elegant-card">
                        <div class="card-body">
                            <label for="txtEventCosts_low" class="label-title">SLE Low</label>
                            <input type="text" id="txtEventCosts_low" name="txtEventCosts_low" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>

                            <label for="txt_ale_low" class="label-title">ALE Low</label>
                            <input type="text" id="txt_ale_low" name="txt_ale_low" class="form-control text-center elegant-input"  style="font-size: 20px; color: #0a53be" readonly>
                        </div>
                    </div>
                </div>


                <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100 elegant-card">
                        <div class="card-body">
                            <label for="txtEventCosts" class="label-title">SLE Medium</label>
                            <input type="text" id="txtEventCosts" name="txtEventCosts" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                            <label for="txt_ale_low" class="label-title">ALE Medium</label>
                            <input type="text" id="txt_ale_median" name="txt_ale_median" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100 elegant-card">
                        <div class="card-body">
                            <label for="txtEventCosts_high" class="label-title">SLE High</label>
                            <input type="text" id="txtEventCosts_high" name="txtEventCosts_high" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                            <label for="txt_ale_high" class="label-title">ALE High</label>
                            <input type="text" id="txt_ale_high" name="txt_ale_high" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                        </div>
                    </div>
                </div>
            </div>



            <div class="group-container">
                <div class="group-header">
                     Twelve-Month Projection
                </div>
                <div class="group-body">
                    <div id="monthly_cost_chart" style="height:300px"></div>
                    <input type="hidden" id="scenario_12month_costs" name="scenario_12month_costs">
                </div>
                </div>

        </div>
        <div class="tab-content " id="tab8">
            <h2>Compliance Map</h2>


                <div class="form-group">
                    <table id="compliance_map" class=" table-hover small small-font overflow-auto compact" style="width:95%">
                        <thead>
                            <tr>
                                <th style="width: 33%">Compliance Concern</th>
                                <th style="width: 33%">Compliance Reference</th>
                                <th style="width: 33%">URL</th>
                            </tr>
                        </thead>
                        <tbody style="color: black">
                                <!-- Rows will be added dynamically by JavaScript -->
                         </tbody>
                    </table>
                    <textarea id="compliance_map" name="compliance_map" rows="1" width="1%" readonly style="resize: none; visibility: hidden"></textarea>

                </div>

        </div>

         <div class="tab-content " id="tab9">
            <h2>Attack Tree</h2>
             <div id="attack_tree" style="width:100%; background-color: #253349C0"></div>

                <button id="exportAttackTreeBtn" type="button" class="btn btn-primary" style="display: none">Export as Image</button>
                    <script>


                   document.getElementById('exportAttackTreeBtn').addEventListener('click', exportAsImage); // Attach export function

                    function exportAsImage() {
                        // converts the attack tree to a png file
                        // Create a new canvas element
                        var canvas = document.createElement("canvas");
                        var context = canvas.getContext("2d");

                        // Get the SVG element and its dimensions
                        var svg = document.querySelector("svg");
                        var svgSize = svg.getBoundingClientRect();
                        canvas.width = svgSize.width;
                        canvas.height = svgSize.height;

                        // Convert SVG to a data URL
                        var img = new Image();
                        var serializer = new XMLSerializer();
                        var svgStr = serializer.serializeToString(svg);
                        img.src = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svgStr)));

                        img.onload = function() {
                            // Draw the image onto the canvas
                            context.fillStyle = "#ffffff";  // Set fill style to white color
                            context.fillRect(0, 0, canvas.width, canvas.height);  // Fill the canvas with white

                            context.drawImage(img, 0, 0);

                            // Convert canvas to an image and download it
                            var dataURL = canvas.toDataURL("image/png");
                            var link = document.createElement("a");
                            link.download = "attack-tree.png";
                            link.href = dataURL;
                            link.click();
                        };
                    }
                </script>
        </div>
         <div class="tab-content " id="tab10">
            <h2>Recommendations</h2>
             <div class="form-group">
                 <span id="span_recommendations"></span>
                 <input type="hidden" id="hdnRecommendations" name="hdnRecommendations">
             </div>
        </div>
         </div>
        </div>
    </div>

        <input type="hidden" id="hdnID" name="hdnID" >
        <input type="hidden" id="hdnScenario" name="hdnScenario" value = {{ scenarioID }}>
        <input type="hidden" id="hdnCountry" name="hdnCountry">
        <textarea id="attack_tree_text" name="attack_tree_text" style="visibility: hidden"></textarea>
        <script>

            document.getElementById('hdnCountry').value = sessionStorage.getItem('sessionCountry');

        </script>


<!-- vulnerability assessment table -->
<div class="row" style="visibility: hidden">
    <div class="col-md-1" style="justify-content: center; align-items: center; height: 100%;">
        <div style="text-align: center;">Vulnerabilities</div>
        <div><h2><i class="bi bi-arrow-right"></i></h2></div>
    </div>
    <div class="col-md-10">
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div id="vulnerabilityTableContainer" ></div>
            </div>
        </div>
    </div>
    <div class="col-md-1"></div>
</div>




</div>
<input type="text" id="frequency" name="frequency" class="form-control text-center" style="font-size: 20px; color: #0a53be; visibility: hidden"  readonly>



<div class="row" hidden="hidden">
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-5" style="background-color: white">
        <h5>Adjusted Risk (After Action)</h5>
                <!--slider for Severity level (Sa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Severity Adjusted(Sa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="SArange" name="SArange" onchange="initSlider('SArange','range_SA');">
                    </div>
                    <div class="col-3"><h6><label id="range_SA" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Mitigated Exposure (MELa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Mitigated Exposure (MELa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="MELarange" name="MELarange" onchange="initSlider('MELarange','range_MELa');">
                    </div>
                    <div class="col-3"><h6><label id="range_MELa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Residual Risk (RRa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Residual Risk (RRa)</label></div>
                    <div class="col-7"><input type="text" id="txtRRa" name="txtRRa" class="form-control">
                      <!-- <input type="range" min="1" max="10" value="1" class="slider" id="RRarange" name="RRarange" onchange="initSlider('RRarange','range_RRa');"> -->
                    </div>
                    <div class="col-3"><h6><label id="range_RRa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>

    </div>
     <div class="col-md-5" style="background-color: white">
        <h5>Quantitative Assessment</h5>
         <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Annualized Rate of Occurrence (ARO):</label></div>
                    <div class="col-7">
                      <input type="range" class="slider" id="aro" name="aro" min="0" max="12" step="1" oninput="updatearoOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="aro" id="aroOutput">0</output></h6></div>
                </div>
             </div>
         </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Event Costs (SLE): </label></div>
                    <div class="col-7">
                        <input type="text" class="slider" id="sle" name="sle" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white">
                        <input type="hidden" id="hdn_sle" name="hdn_sle">
                    </div>

                </div>

            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="form-group">
                    <label for="ale">Annualized Loss Expectancy (ALE):</label>
                    <output id="ale" name="ale">$0</output>
                </div>
            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Cost of Countermeasures:</label></div>
                    <div class="col-7">
                        <input type="range" class="slider" id="countermeasureCostsRange" name="countermeasureCostsRange" min="0" max="1000000" step="1000" oninput="updateCountermeasureCostsOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="countermeasureCostsRange" id="countermeasureCostsOutput">$0</output></h6></div>
                </div>
            </div>
        </div>

          <div class="card mb-3 shadow-sm" style="visibility: hidden"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Security Level (SL)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="sl_range" name="sl_range" onchange="initSlider('sl_range','range_sl');">
                    </div>
                    <div class="col-3"><h6><label id="range_sl" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
         <script>
            function updatearoOutput(value) {
                document.getElementById('aroOutput').textContent = value;

                // Get the value from the hdn_sle field
                let sleValue = parseFloat(document.getElementById('hdn_sle').value);

                // Multiply the sleValue by the provided value
                let result = sleValue * value;

                // Format the result as a US$ amount with no decimal point
                let formattedResult = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(result);

                // Display the formatted result (or set it to any desired element)
                document.getElementById('ale').textContent = formattedResult;

                // Uncomment the next line if you want to call the calculateALE function
                // calculateALE();
            }

            function updateCountermeasureCostsOutput(value) {
              document.getElementById('countermeasureCostsOutput').textContent = value;
            }

            $(document).ready(function() {
              $('#sle').on('input', function() {
                var cost = parseInt($(this).val()).toLocaleString();
                $('#eventCostsOutput').text('$' + cost);
                //calculateALE();
              });

              function calculateALE() {
                var aro = parseInt($('#aro').val());
                var eventCosts = parseInt($('#sle').val());
                var sle = eventCosts;
                var aro = aro;
                var ale = sle * aro;
                $('#ale').text('$' + ale.toLocaleString());
              }
            });
          </script>
    </div>
     <div class="col-md-1" style="background-color: white"></div>
</div>

<script>

        // Function to save or update CyberPHA data
        function saveOrUpdateCyberPHA(formData) {
          // Get the CSRF token from the cookie
          const csrftoken = getCookie('csrftoken');

          // Create a new XMLHttpRequest object
          const xhr = new XMLHttpRequest();

          // Set up the request
          xhr.open('POST', "{% url 'OTRisk:save_or_update_cyberpha' %}", true);

          xhr.setRequestHeader('X-CSRFToken', csrftoken);


          // Define the callback function for when the request is completed
          xhr.onload = function() {
            if (xhr.status === 200) {
              location.reload()
              // Optionally, perform any additional actions or show a success message
            } else {
              console.error('Failed to save or update CyberPHA data');
              // Optionally, handle the error or show an error message
            }
          };

          // Send the request with the form data
          xhr.send(formData);


          showNotification('Scenario saved successfully: ' + response.message);
          $('#confirmationModal').modal('hide');


        }


        function getCookie(name) {
          const cookieValue = document.cookie
            .split(';')
            .map(cookie => cookie.trim())
            .find(cookie => cookie.startsWith(name + '='));

          if (cookieValue) {
            return cookieValue.split('=')[1];
          }

          return null;
        }

          // Event listener for form submission
          function processFormData() {
              // Check the value of the local session variable named "ls"

              var lsValue = sessionStorage.getItem("ls");
              var riskSnapshotCheckbox = document.getElementById('risk_snapshot');

              if (lsValue === "1") {
                  if (riskSnapshotCheckbox.checked) {
                      swal.fire({
                          title: "AnzenOT Scenario Manager",
                            html: "The version of this scenario saved to the risk register cannot be changed. You are about to create a snapshot version of the scenario. Do you want to proceed?",
                            iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                            showCancelButton: true, // Show the cancel button
                            confirmButtonText: 'OK', // Text for the confirm button
                            cancelButtonText: 'Cancel',
                            focusConfirm: false // Focus on the confirm button by default
                      })
                          .then((result) => {
                              if (result.isConfirmed) {
                                  continueProcessing(true); // Continue with the rest of the function without asking for scenario data save confirmation
                              }
                          });
                  } else {
                      swal.fire({
                        title: "AnzenOT Scenario Manager",
                        text: "Changes cannot be made to this scenario because it has been added to the risk register",
                        icon: "error" // Assuming you want to show an error icon
                    });
                      return; // Exit the function
                  }
              } else {
                  continueProcessing(false); // Continue with the rest of the function and ask for scenario data save confirmation
              }



              function continueProcessing(skipConfirmation) {
                  if (!skipConfirmation) {
                      // Prompt the user for confirmation
                      var isConfirmed = window.confirm("Are you sure you want to save the scenario data?");

                      // If the user clicked "Cancel", exit the function
                      if (!isConfirmed) {
                          return;
                      }
                  }

                  $('#loadingSpinner').show();
                  // Get the values of the form fields
                  const scenario = document.getElementById('id_txtScenario').value;
                  const exposed_system = document.getElementById('exposed_system').checked
                  const weak_credentials = document.getElementById('weak_credentials').checked
                  // const consequence = document.getElementById('txtConsequence').value
                  const threatSource = document.getElementById('threat-intelligence').value;
                  const riskCategory = document.getElementById('risk-category').value;
                  const safety = document.getElementById('range_safety').value;
                  const life = document.getElementById('range_life').value;
                  const production = document.getElementById('range_production').value;
                  const financial = document.getElementById('range_finance').value;
                  const reputation = document.getElementById('range_reputation').value;
                  const environment = document.getElementById('range_environment').value;
                  const regulatory = document.getElementById('range_regulatory').value;
                  const supply = document.getElementById('range_supply').value;
                  const data = document.getElementById('range_data').value;
                  const sm = document.getElementById('SMrange').value;
                  const mel = document.getElementById('MELrange').value;
                  const rrm = document.getElementById('RRMrange').value;
                  const sl_a = document.getElementById('selSL').value;
                  const sa = document.getElementById('SArange').value;
                  const mela = document.getElementById('MELarange').value;
                  const uel = document.getElementById('uel_range').value;
                  const uel_threat = document.getElementById('uel_threat').value;
                  const uel_vuln = document.getElementById('uel_vuln').value;
                  const uel_exposure = document.getElementById('uel_exposure').value;
                  const rru = document.getElementById('rru_range').value;
                  const sl = document.getElementById('sl_range').value;
                  const cyberpha = sessionStorage.getItem('activeCyberPHA')
                  const recommendations = document.getElementById('hdnRecommendations').value;
                  const likelihood = document.getElementById('hdnLikelihood').value
                  const rra = document.getElementById('txtResidualRisk').value
                  const justifySafety = document.getElementById('txtsafetyJustify').value
                  const justifyLife = document.getElementById('txtlifeJustify').value
                  const justifyProduction = document.getElementById('txtproductionJustify').value
                  const justifyFinance = document.getElementById('txtfinanceJustify').value
                  const justifyReputation = document.getElementById('txtreputationJustify').value
                  const justifyEnvironment = document.getElementById('txtenvironmentJustify').value
                  const env_contaminant = document.getElementById('env_contaminant').value
                  const env_ecosystem = document.getElementById('env_ecosystem').value
                  const env_contamination = document.getElementById('env_contamination').value
                  const env_population = document.getElementById('env_population').value
                  const env_wildlife = document.getElementById('env_wildlife').value
                    const justifyRegulation = document.getElementById('txtregulatoryJustify').value
                  const justifySupply = document.getElementById('txtsupplyJustify').value
                  const dataRegulation = document.getElementById('txtdataJustify').value
                  //const sle =  document.getElementById('hdn_sle').value
                  const aleValue = document.getElementById('ale').value;
                  let ale = parseInt(aleValue.replace(/[^0-9]/g, ''), 10);
                  const probability = document.getElementById('txtProbability').value;
                  const control_effectiveness = document.getElementById('hdn_control_effectiveness').value;
                  const bia_score = document.getElementById('hdn_bia_score').value;
                  const sle_low = document.getElementById('txtEventCosts_low').value;
                  const sle_high = document.getElementById('txtEventCosts_high').value;
                  const sle_median = document.getElementById('txtEventCosts').value;
                  const ale_low = document.getElementById('txt_ale_low').value;
                  const ale_high = document.getElementById('txt_ale_high').value;
                  const ale_median = document.getElementById('txt_ale_median').value;
                  const frequency = document.getElementById('frequency').value;
                  //const standards = document.getElementById('selStandards').value;
                  const aro = document.getElementById('aro').value;
                  const risk_register = document.getElementById('risk_register').checked;
                  const sis_outage = document.getElementById('sisOutageYes').checked;
                  const sis_compromise = document.getElementById('sisIntegrityYes').checked;
                  const safety_hazard = document.getElementById('hazardNature').value;
                  const dangerScope = document.getElementById('dangerScope').value;
                  // Check if the "yes" option was selected for outage
                  const outageSelector = document.getElementById('outageYes');
                  const outage = outageSelector.value === "yes" ? "yes" : "no";
                  const compliance_map = document.getElementById('compliance_map').value;
                  const attack_tree_text = document.getElementById('attack_tree_text').value;
                  const scenario_status = document.getElementById('scenarioStatusSelect').value;
                  const cost_projection = document.getElementById('scenario_12month_costs').value;
                  const rationale_recommendation = document.getElementById('hdnrationale_recommendation').value;
                  const rationale_Rationale = document.getElementById('hdnrationale_Rationale').value;
                  // If outage is "yes", get the values for outageDuration and outageCost
                  let outageDuration = 0;
                  let outageCost = 0;
                  if (outage === "yes") {
                      outageDuration = parseInt(document.getElementById('outageDuration').value, 10);
                      outageCost = parseInt(document.getElementById('outageCost').value, 10);
                  }
                  var sid = sessionStorage.getItem('sid');
                    if (!sid) {
                        sid = 0;
                    }
                  // Add the consequences table
                  const table = document.getElementById('consequenceTable');
                  const rows = table.getElementsByTagName('tbody')[0].rows;
                  let validatedConsequenceExists = false;
                    for (let i = 0; i < rows.length; i++) {
                        const isChecked = rows[i].cells[1].getElementsByTagName('input')[0].checked;
                        if (isChecked) {
                            validatedConsequenceExists = true;
                            break;
                        }
                    }

                    if (rows.length === 0 || !validatedConsequenceExists) {
                        alert("No consequences have been added or validated. Please add and validate consequences before proceeding.");
                        return; // Exit the function
                    }
                  // Create a FormData object
                  const formData = new FormData();
                  formData.append('scenarioID', sid);
                  formData.append('sis_outage', sis_outage);
                  formData.append('sis_compromise', sis_compromise);
                  formData.append('safety_hazard', safety_hazard);
                  formData.append('dangerScope', dangerScope);
                  formData.append('scenario', scenario);
                  formData.append('exposed_system',exposed_system);
                  formData.append('weak_credentials',weak_credentials);
                  // formData.append('consequence', consequence);
                  formData.append('threatSource', threatSource);
                  formData.append('riskCategory', riskCategory);
                  formData.append('safety', safety);
                  formData.append('life', life);
                  formData.append('production', production);
                  formData.append('financial', financial);
                  formData.append('reputation', reputation);
                  formData.append('environment', environment);
                  formData.append('env_contaminant', env_contaminant);
                  formData.append('env_ecosystem', env_ecosystem);
                  formData.append('env_contamination', env_contamination);
                  formData.append('env_population', env_population);
                  formData.append('env_wildlife', env_wildlife);
                  formData.append('regulatory', regulatory);
                  formData.append('data', data);
                  formData.append('supply', supply);
                  formData.append('sm', sm);
                  formData.append('mel', mel);
                  formData.append('rrm', rrm);
                  formData.append('sa', sa);
                  formData.append('mela', mela);
                  formData.append('rra', rra);
                  formData.append('aro', aro);
                  formData.append('uel', uel);
                  formData.append('uel_threat', uel_threat);
                  formData.append('uel_vuln', uel_vuln);
                  formData.append('uel_exposure', uel_exposure);
                  formData.append('rru', rru);
                  formData.append('sl', sl);
                  formData.append('recommendations', recommendations)
                  formData.append('cyberpha', cyberpha);
                  formData.append('justifySafety', justifySafety);
                  formData.append('justifyLife', justifyLife);
                  formData.append('justifyProduction', justifyProduction);
                  formData.append('justifyFinance', justifyFinance);
                  formData.append('justifyReputation', justifyReputation);
                  formData.append('justifyEnvironment', justifyEnvironment);
                  formData.append('justifyRegulation', justifyRegulation);
                  formData.append('dataRegulation', dataRegulation);
                  formData.append('justifySupply', justifySupply);
                  formData.append('sle_low', sle_low);
                  formData.append('sle_median', sle_median);
                  formData.append('sle_high', sle_high);
                  formData.append('ale_low', ale_low);
                  formData.append('ale_median', ale_median);
                  formData.append('ale_high', ale_high);
                  formData.append('frequency', frequency);
                  formData.append('ale', ale);
                  formData.append('outage', outage);
                  formData.append('outageDuration', outageDuration);
                  formData.append('outageCost', outageCost);
                  formData.append('probability', probability);
                  formData.append('control_effectiveness', control_effectiveness);
                  //formData.append('standards', standards);
                  formData.append('risk_register', risk_register);
                  formData.append('likelihood', likelihood);
                  formData.append('sl_a', sl_a);
                  formData.append('ai_bia_score', bia_score);
                  formData.append('compliance_map', compliance_map);
                  formData.append('attack_tree_text', attack_tree_text);
                  formData.append('scenario_status', scenario_status);
                  formData.append('cost_projection', cost_projection);
                  formData.append('rationale_recommendation', rationale_recommendation);
                  formData.append('rationale_Rationale', rationale_Rationale);

                    // Check if snapshot should be created
                  let snapshot = 0
                  const riskSnapshotCheckbox = document.getElementById('risk_snapshot');
                  if (riskSnapshotCheckbox.checked) {
                        snapshot = 1;
                    }
                  formData.append('snapshot', snapshot);
                  for (let i = 0; i < rows.length; i++) {
                      const row = rows[i];
                      const isChecked = row.cells[1].getElementsByTagName('input')[0].checked;
                      if (isChecked) {
                          const consequenceText = row.cells[0].innerText;
                          formData.append('validated_consequences', consequenceText);
                      }
                  }
                  // Check for safeguards in the table and add them to formData
                    const safeguardsTable = document.getElementById('table_safeguards');
                    const safeguard_rows = safeguardsTable.getElementsByTagName('tbody')[0].rows;
                    let safeguardsAdded = false;

                    for (let i = 0; i < safeguard_rows.length; i++) {
                        const safeguardDescription = safeguard_rows[i].cells[0].getElementsByTagName('textarea')[0].value.trim();
                        const safeguardType = safeguard_rows[i].cells[1].getElementsByTagName('textarea')[0].value.trim();

                        // Ignore empty rows
                        if (safeguardDescription || safeguardType) {
                            formData.append(`safeguards[${i}][description]`, safeguardDescription);
                            formData.append(`safeguards[${i}][type]`, safeguardType);
                            safeguardsAdded = true;
                        }
                    }

                    // If no safeguards were added (table was empty or all rows were empty), add a dummy row
                    if (!safeguardsAdded) {
                        formData.append('safeguards[0][description]', 'No physical safeguards defined');
                        formData.append('safeguards[0][type]', 'N/A');
                    }
                  // Call the saveOrUpdateCyberPHA function
                  saveOrUpdateCyberPHA(formData);

                  $('#loadingSpinner').hide();
                  processFormData


                          }
                      }
    </script>

<div class="modal fade custom-modal" id="safetyModal" tabindex="-1" aria-labelledby="safetyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="safetyModal_Label">Justification for Safety Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- Drop-down select control for the nature of the safety hazard -->
        <label for="hazardNature">Nature of Safety Hazard:</label>
        <select id="hazardNature" name="hazardNature" class="form-control mb-3">
            <option value="">-- Select Hazard --</option>
          <option value="Chemical">Chemical</option>
          <option value="Electrical">Electrical</option>
          <option value="Mechanical">Mechanical</option>
          <option value="Radiation">Radiation</option>
        </select>

        <!-- Yes/no option for SIS Outage -->
        <div class="mb-3">
          <label>SIS Outage:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageYes" value="yes">
            <label class="form-check-label" for="sisOutageYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageNo" value="no">
            <label class="form-check-label" for="sisOutageNo">No</label>
          </div>
        </div>

        <!-- Yes/no option for SIS Integrity Compromise -->
        <div class="mb-3">
          <label>SIS Integrity Compromise:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrity" id="sisIntegrityYes" value="yes">
            <label class="form-check-label" for="sisIntegrityYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrity" id="sisIntegrityNo" value="no">
            <label class="form-check-label" for="sisIntegrityNo">No</label>
          </div>
        </div>

        <!-- Textarea for justification -->
        <label for="txtsafetyJustify">Justification:</label>
        <textarea id="txtsafetyJustify" name="txtsafetyJustify" class="form-control mb-3" rows="3" style="resize: none"></textarea>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="lifeModal" tabindex="-1" aria-labelledby="lifeModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="lifeModal_Label">Justification for Danger-to-Life Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtlifeJustify" name="txtlifeJustify" class="form-control" rows="3" style="resize: none"></textarea>
           <!-- Drop-down select control for the nature of the safety hazard -->
        <label for="dangerScope">Scope of Danger:</label>
        <select id="dangerScope" name="dangerScope" class="form-control mb-3">
            <option value="">-- Select Scope --</option>
            <option value="N/A">N/A</option>
            <option value="Facility">Facility</option>
            <option value="External">External</option>
            <option value="Both">Both</option>
        </select>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<div class="modal fade custom-modal" id="productionModal" tabindex="-1" aria-labelledby="productionModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productionModal_Label">Justification for Production Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtproductionJustify" name="txtproductionJustify" class="form-control" rows="3" style="resize: none"></textarea>

        <!-- 1. Yes/No selector -->
        <div class="mt-3">
          <label>Production Outage?</label><br>
          <input type="radio" id="outageYes" name="outage" value="yes" onclick="toggleOutageControls(true)">
          <label for="outageYes">Yes</label><br>
          <input type="radio" id="outageNo" name="outage" value="no" checked onclick="toggleOutageControls(false)">
          <label for="outageNo">No</label>
        </div>

        <!-- 2. Number input for length of time -->
        <div class="mt-3" id="outageDurationDiv" style="display: none;">
          <label for="outageDuration">Estimate length of time of the outage (hours):</label>
          <input type="number" id="outageDuration" name="outageDuration" class="form-control" min="1">
        </div>

        <!-- 3. Text input for cost per hour -->
        <div class="mt-3" id="outageCostDiv" style="display: none;">
          <label for="outageCost">Cost per hour of outage (if known): </label>
          <input type="text" id="outageCost" name="outageCost" class="form-control">
        </div>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleOutageControls(isVisible) {
    const durationDiv = document.getElementById('outageDurationDiv');
    const costDiv = document.getElementById('outageCostDiv');
    if (isVisible) {
      durationDiv.style.display = 'block';
      costDiv.style.display = 'block';
    } else {
      durationDiv.style.display = 'none';
      costDiv.style.display = 'none';
    }
  }
</script>

<div class="modal fade custom-modal" id="financeModal" tabindex="-1" aria-labelledby="financeModal" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="financeModal_Label">Justification for Financial Impact Rating</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Existing Justification Textarea -->
                <textarea id="txtfinanceJustify" name="txtfinanceJustify" class="form-control" rows="3" style="resize: none"></textarea>

                <!-- Additional Financial Fields -->
                <div class="form-group mt-3">
                    <label for="lostProductionUnits" style="color: #000000">Lost Production Units:</label>
                    <input type="number" id="lostProductionUnits" name="lostProductionUnits" class="form-control" placeholder="Enter lost units" />

                    <label for="wastedLabourCosts" style="color: #000000">Wasted Labour Costs:</label>
                    <input type="number" id="wastedLabourCosts" name="wastedLabourCosts" class="form-control" placeholder="Enter amount" />

                    <label for="lostInventory" style="color: #000000">Lost Inventory:</label>
                    <input type="number" id="lostInventory" name="lostInventory" class="form-control" placeholder="Enter value" />

                    <!-- Add more fields as needed -->
                </div>

                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade custom-modal" id="reputationModal" tabindex="-1" aria-labelledby="reputationModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reputationModal_Label">Justification for Reputation Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtreputationJustify" name="txtreputationJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="environmentModal" tabindex="-1" aria-labelledby="environmentModal" aria-hidden="true" >
  <div class="modal-dialog modal-xl" >
    <div class="modal-content" style="background-color: darkgray; ">
      <div class="modal-header">
        <h5 class="modal-title" id="environmentModal_Label">Justification for Environment Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtenvironmentJustify" name="txtenvironmentJustify" class="form-control" rows="3" style="resize: none"></textarea>
                <!-- Dropdown for the type of contaminants -->
        <label for="env_contaminant">Type of Contaminants:</label>
        <select id="env_contaminant" name="env_contaminant" class="form-control mb-3">
          <option value="">-- Select Contaminant Type --</option>
          <option value="N/A">N/A</option>
          <option value="Chemical">Chemical</option>
          <option value="Biological">Biological</option>
          <option value="Radiological">Radiological</option>
          <option value="Physical">Physical</option>
        </select>
          <!-- Dropdown for the affected ecosystem -->
        <label for="env_ecosystem">Affected Ecosystem:</label>
        <select id="env_ecosystem" name="env_ecosystem" class="form-control mb-3">
          <option value="">-- Select Ecosystem --</option>
          <option value="N/A">N/A</option>
          <option value="Aquatic">Aquatic</option>
          <option value="Urban">Urban</option>
          <option value="Agricultural">Agricultural</option>
        </select>
          <!-- Dropdown for the extent of the contamination -->
        <label for="env_contamination">Extent of Contamination:</label>
        <select id="env_contamination" name="env_contamination" class="form-control mb-3">
          <option value="">-- Select Extent --</option>
            <option value="N/A">N/A</option>
          <option value="Localised">Localised</option>
          <option value="WideArea">Wide Area</option>
        </select>
          <!-- Dropdown for effect on local residential population -->
        <label for="env_population">Effect on Local Residential Population:</label>
        <select id="env_population" name="env_population" class="form-control mb-3">
          <option value="">-- Select Effect --</option>
            <option value="N/A">N/A</option>
          <option value="Harmless">Harmless</option>
          <option value="Harmful">Harmful</option>
          <option value="Deadly">Deadly</option>
        </select>

        <!-- Dropdown for effect on local wildlife -->
        <label for="env_wildlife">Effect on Local Wildlife:</label>
        <select id="env_wildlife" name="env_wildlife" class="form-control mb-3">
            <option value="">-- Select Effect --</option>
            <option value="N/A">N/A</option>
            <option value="Harmless">Harmless</option>
            <option value="Harmful">Harmful</option>
            <option value="Deadly">Deadly</option>
        </select>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="regulatoryModal" tabindex="-1" aria-labelledby="regulatoryModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="regulatoryModal_Label">Justification for Regulatory Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtregulatoryJustify" name="txtregulatoryJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade custom-modal" id="dataModal" tabindex="-1" aria-labelledby="dataModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModal_Label">Justification for Data Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtdataJustify" name="txtdataJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="supplyModal" tabindex="-1" aria-labelledby="supplyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="supplyModal_Label">Justification for Supply Chain Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtsupplyJustify" name="txtsupplyJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade custom-modal" id="uelModal" tabindex="-1" aria-labelledby="uelModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uelModal_Label">UEL Assessment</h5>
      </div>
          <div class="row">
              <div class="col-md-2"></div>
              <div class="col-md-8">
                <!-- Threat Capability -->
                <div class="control-group">
                <label for="uel_threat" style="font-size: 16; font-weight: bold">Threat Capability:</label>
                <div class="range-container">
                <input type="range" id="uel_threat" name="uel_threat" min="1" max="10" step="1" class="slider">
                <span id="threatLabel">Low Skills</span>
                </div>
                </div>

                <div class="control-group">
                <label for="uel_vuln"  style="font-size: 16; font-weight: bold">Vulnerability Presence:</label>
                <div class="range-container">
                <input type="range" id="uel_vuln" name="uel_vuln" min="0" max="10" step="1" class="slider">
                <span id="vulnerabilityLabel">No Vulnerabilities</span>
                </div>
                </div>

                <!-- System Exposure -->
                <div class="control-group">
                <label for="uel_exposure"  style="font-size: 16; font-weight: bold">System Exposure:</label>
                <div class="range-container">
                <input type="range" id="uel_exposure" name="uel_exposure" min="0" max="10" step="1" class="slider">
                <span id="exposureLabel">No Exposure</span>
                </div>
                </div>
                <!-- Button centered -->
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
                </div>
                  <br>
              </div>
              <div class="col-md-2"></div>
          </div>
    </div>
  </div>
</div>
    <div class="modal fade custom-modal" id="rruModal" tabindex="-1" aria-labelledby="rruModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rruModal_Label">RRU Assessment</h5>
      </div>
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <!-- Threat Capability -->
                <div class="control-group">
                <label for="rru_threat" style="font-size: 16; font-weight: bold">Threat Likelihood:</label>
                <div class="range-container">
                <input type="range" id="rru_threat" name="rru_threat" min="1" max="10" step="1" class="slider">
                <span id="rru_threat_Label">Low Skills</span>
                </div>
                </div>

                <!-- Vulnerability Presence -->
                <div class="control-group">
                <label for="rru_vuln" style="font-size: 16; font-weight: bold">Vulnerability Severity:</label>
                <div class="range-container">
                <input type="range" id="rru_vuln" name="rru_vuln" min="0" max="10" step="1" class="slider">
                <span id="rru_vuln_Label">No Vulnerabilities</span>
                </div>
                </div>

                <!-- System Exposure -->
                <div class="control-group">
                <label for="rru_event" style="font-size: 16; font-weight: bold">Event Magnitude:</label>
                <div class="range-container">
                <input type="range" id="rru_event" name="rru_event" min="0" max="10" step="1" class="slider">
                <span id="rru_exposure_Label">No Event</span>
                </div>
                </div>

                <div class="d-flex justify-content-center">
                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
                </div>
                <br>
            </div>
            <div class="col-md-2"></div>
        </div>


    </div>
</div>
    </div>
<script>
$(document).ready(function() {
    // Function to update labels based on range values
    function updateLabels() {
        // Threat Capability
        let threatValue = $('#uel_threat').val();
        let threatLabel = "Low Skills";
        if (threatValue <= 3) threatLabel = "Low Skills";
        else if (threatValue <= 5) threatLabel = "Moderate Skills";
        else if (threatValue <= 7) threatLabel = "Advanced Skills";
        else if (threatValue <= 9) threatLabel = "Expert";
        else threatLabel = "Highly Skilled";
        $('#threatLabel').text(threatLabel);

        // Vulnerability Presence
        let vulnerabilityValue = $('#uel_vuln').val();
        let vulnerabilityLabel = "No Vulnerabilities";
        if (vulnerabilityValue <= 3) vulnerabilityLabel = "Minor Vulnerabilities";
        else if (vulnerabilityValue <= 5) vulnerabilityLabel = "Some Vulnerabilities";
        else if (vulnerabilityValue <= 7) vulnerabilityLabel = "Major Vulnerabilities";
        else if (vulnerabilityValue <= 9) vulnerabilityLabel = "Critical Vulnerabilities";
        else vulnerabilityLabel = "Easily Exploitable Vulnerabilities";
        $('#vulnerabilityLabel').text(vulnerabilityLabel);

        // System Exposure
        let exposureValue = $('#uel_exposure').val();
        let exposureLabel = "No Exposure";
        if (exposureValue <= 3) exposureLabel = "Minimal Exposure";
        else if (exposureValue <= 5) exposureLabel = "Moderate Exposure";
        else if (exposureValue <= 7) exposureLabel = "Significant Exposure";
        else if (exposureValue <= 9) exposureLabel = "High Exposure";
        else exposureLabel = "Unrestricted External Exposure";
        $('#exposureLabel').text(exposureLabel);
    }

    // Function to compute and set the overall UEL score
    function computeAndSetUEL() {
        let threatValue = parseInt($('#uel_threat').val());
        let vulnerabilityValue = parseInt($('#uel_vuln').val());
        let exposureValue = parseInt($('#uel_exposure').val());

        // Compute the average
        let overallUEL = Math.round((threatValue + vulnerabilityValue + exposureValue) / 3);

        // Set the value to the uel_range control
        $('#uel_range').val(overallUEL);
    }

    // Event listeners for the range controls
    $('#uel_threat, #uel_vuln, #uel_exposure').on('input', function() {
        updateLabels();
        computeAndSetUEL();
        initSlider('uel_range','range_uel');
    });
});

$(document).ready(function() {
    // Function to update labels based on range values
    function updateLabels() {
        // Threat Capability
        let rru_threat_Value = $('#rru_threat').val();
        let rru_threat_Label = "Low Likelihood";
        if (rru_threat_Value <= 3) rru_threat_Label = "Low Likelihood";
        else if (rru_threat_Value <= 5) rru_threat_Label = "Moderate Likelihood";
        else if (rru_threat_Value <= 7) rru_threat_Label = "High Likelihood";
        else if (rru_threat_Value <= 9) rru_threat_Label = "Very High Likelihood";
        else rru_threat_Label = "Very High Likelihood";
        $('#rru_threat_Label').text(rru_threat_Label);

        // Vulnerability Presence
        let rru_vuln = $('#rru_vuln').val();
        let rru_vuln_Label = "No Vulnerabilities";
        if (rru_vuln <= 3) rru_vuln_Label = "Minor Vulnerabilities";
        else if (rru_vuln <= 5) rru_vuln_Label = "Some Vulnerabilities";
        else if (rru_vuln <= 7) rru_vuln_Label = "Major Vulnerabilities";
        else if (rru_vuln <= 9) rru_vuln_Label = "Critical Vulnerabilities";
        else rru_vuln_Label = "Easily Exploitable Vulnerabilities";
        $('#rru_vuln_Label').text(rru_vuln_Label);

        // System Exposure
        let rru_exposure_Value = $('#rru_event').val();
        let rru_exposure_Label = "No Consequence";
        if (rru_exposure_Value <= 3) rru_exposure_Label = "Minimal Consequence";
        else if (rru_exposure_Value <= 5) rru_exposure_Label = "Moderate Consequence";
        else if (rru_exposure_Value <= 7) rru_exposure_Label = "Significant Consequence";
        else if (rru_exposure_Value <= 9) rru_exposure_Label = "High Consequence";
        else rru_exposure_Label = "Critical Consequence";
        $('#rru_exposure_Label').text(rru_exposure_Label);
    }

    // Function to compute and set the overall rru score
    function computeAndSetrru() {
        let rru_threat_Value = parseInt($('#rru_threat').val());
        let rru_vuln_Value = parseInt($('#rru_vuln').val());
        let rru_exposure_Value = parseInt($('#rru_event').val());

        // Compute the average
        let overallrru = Math.round((rru_threat_Value + rru_vuln_Value + rru_exposure_Value) / 3);
        // Set the value to the rru_range control
        $('#rru_range').val(overallrru);
    }

    // Event listeners for the range controls
    $('#rru_threat, #rru_vuln, #rru_event').on('input', function() {
        updateLabels();
        computeAndSetrru();
        initSlider('rru_range','range_rru');
    });
});

</script>
</form>

<!-- RAActionsModal.html -->
<div class="modal fade" id="RAActionsModal" tabindex="-1" aria-labelledby="RAActionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="RAActionsModalLabel" style="color: white">Action:</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
            <form id="raActionsForm">
                {% csrf_token %}
                <input type="hidden" name="hdnphaID" id="hdnphaID">
                <input type="hidden" name="hdntxtModalRAW" id="hdntxtModalRAW" value="0">

                <!-- Action Title -->
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionTitle" class="form-label">Headline</label>
                            <input type="text" class="form-control" id="actionTitle" name="actionTitle" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionOwner" class="form-label">Risk Owner</label>
                                    <input type="text" class="form-control" id="actionOwner" name="actionOwner" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDate" class="form-label">Action Date</label>
                                    <input type="date" class="form-control" id="actionDate" name="actionDate" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionEffort" class="form-label">Effort Level:</label>
                                    <Select class="form-control" id="actionEffort" name="actionEffort">
                                            <option value="">-- Select Effort --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                                </div>
                            </div>
                        </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDifficulty" class="form-label">Difficulty Level</label>
                                    <Select class="form-control" id="actionDifficulty" name="actionDifficulty">
                                            <option value="">-- Select Difficulty --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>

                                </div>
                            </div>
                        </div>
                    </div>
                    </div>


                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionCost" class="form-label">Estimated Cost</label>
                                    <Select class="form-control" id="actionCost" name="actionCost">
                                            <option value="">-- Select Costs --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionAffinity" class="form-label">Risk Mitigation</label>
                                    <Select class="form-control" id="actionAffinity" name="actionAffinity">
                                            <option value="">-- Select Level --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionStatus" class="form-label">Status</label>
                                    <input type="text" class="form-control" id="actionStatus" name="actionStatus" readonly value="Open">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionDescription" class="form-label">Description</label>
                            <textarea id="actionDescription" name="actionDescription" class="form-control" rows="3" style="resize: none"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionPriority" class="form-label">Urgency</label>
                                        <select class="form-control" id="actionPriority" name="actionPriority">
                                            <option value="0">-- Select Urgency --</option>
                                            <option value="1">Low</option>
                                            <option value="2">Medium</option>
                                            <option value="3">High</option>
                                            <option value="4">Critical</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDueDate" class="form-label">Target Date</label>
                                    <input type="date" class="form-control" id="actionDueDate" name="actionDueDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageSIS" class="form-label">Safety (SIS) Outage:</label>
                                        <select class="form-control" id="outageSIS" name="outageSIS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageICS" class="form-label">Control System (SCADA/ICS) Outage:</label>
                                        <select class="form-control" id="outageICS" name="outageICS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageEMS" class="form-label">Environmental (EMS) Outage:</label>
                                        <select class="form-control" id="outageEMS" name="outageEMS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageIT" class="form-label">IT Outage:</label>
                                        <select class="form-control" id="outageIT" name="outageIT">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outagePS" class="form-label">Physical Security Outage:</label>
                                        <select class="form-control" id="outagePS" name="outagePS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageWWW" class="form-label">Internet Outage:</label>
                                        <select class="form-control" id="outageWWW" name="outageWWW">
                                            <option value="0">-- Select Option --</option>
                                            <option value="1">Yes</option>
                                            <option value="2">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitRAActionForm();">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </form>
        </div>
        <!-- ... (rest of the modal code) ... -->

    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="scenarioSelectModal" tabindex="-1" aria-labelledby="scenarioSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scenarioSelectModalLabel">Select a Scenario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="file-explorer">
          <ul id="scenarioList" class="list-group">
            <!-- Scenario items will be populated here -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    // Function to populate the scenario list in the modal
function populateScenarioList() {
  $.ajax({
    url: '/OTRisk/get_saved_scenario_builders',
    type: 'GET',
    success: function(response) {
      var scenarioList = $('#scenarioList');
      scenarioList.empty();

      response.forEach(function(scenario) {
        var listItem = $(`
          <li class="list-group-item list-group-item-action" data-id="${scenario.id}">
            <span class="file-icon"><i class="fas fa-file-alt"></i></span>
            <span class="file-name">${scenario.scenario_name}</span>
          </li>
        `);
        listItem.on('click', function() {
          retrieveScenario($(this).data('id'));
          $('#scenarioSelectModal').modal('hide');
        });
        scenarioList.append(listItem);
      });
    },
    error: function(error) {
      console.error('Error fetching scenarios:', error);
    }
  });
}



// Function to retrieve and display a selected scenario
function retrieveScenario(scenarioId) {
  clearScenario();
  $.ajax({
    url: '/OTRisk/retrieve_scenario_builder/' + scenarioId,
    type: 'GET',
    success: function(response) {
        clearScenario();
      $('#id_txtScenario').val(response.scenario_description);
      $('#attack_tree_text').val(response.attack_tree_data);

        // Check if data.attack_tree_text is defined, not null, and not an empty string
        if (response.attack_tree_data && response.attack_tree_data.trim() !== '') {

            var jsonStringFromDatabase = response.attack_tree_data;
            var jsonObject = JSON.parse(jsonStringFromDatabase);
            drawAttackTree(jsonObject);
        }


      if (response.factors['Environmental consequences']) {
        $('#range_environment').val(response.factors['Environmental consequences'].score);
        $('#txtenvironmentJustify').val(response.factors['Environmental consequences'].narrative);
      }
       if (response.factors['Data']) {
        $('#range_data').val(response.factors['Data'].score);
        $('#txtdataJustify').val(response.factors['Data'].narrative);
      }
      if (response.factors['Danger-to-life']) {
        $('#range_life').val(response.factors['Danger-to-life'].score);
        $('#txtlifeJustify').val(response.factors['Danger-to-life'].narrative);
      }
      if (response.factors['Financials']) {
        $('#range_finance').val(response.factors['Financials'].score);
        $('#txtfinanceJustify').val(response.factors['Financials'].narrative);
      }
      if (response.factors['Operations']) {
        $('#range_production').val(response.factors['Operations'].score);
        $('#txtproductionJustify').val(response.factors['Operations'].narrative);
      }
      if (response.factors['Regulations']) {
        $('#range_regulatory').val(response.factors['Regulations'].score);
        $('#txtregulatoryJustify').val(response.factors['Regulations'].narrative);
      }
      if (response.factors['Reputation']) {
        $('#range_reputation').val(response.factors['Reputation'].score);
        $('#txtreputationJustify').val(response.factors['Reputation'].narrative);
      }
      if (response.factors['Safety']) {
        $('#range_safety').val(response.factors['Safety'].score);
        $('#txtsafetyJustify').val(response.factors['Safety'].narrative);
      }
      if (response.factors['Supply chain']) {
        $('#range_supply').val(response.factors['Supply chain'].score);
        $('#txtsupplyJustify').val(response.factors['Supply chain'].narrative);
      }

       // Populate the consequences table
      var tableBody = $('#consequenceTable tbody');
      tableBody.empty(); // Clear existing rows

      var consequencesArray = response.consequences.split('\n');
      consequencesArray.forEach(function(consequence) {
        if (consequence.trim() !== '') {
          var row = `<tr><td>${consequence}</td><td><input type="checkbox" checked></td></tr>`;
          tableBody.append(row);
        }
      });

    },
    error: function(error) {
      console.error('Error retrieving scenario:', error);
    }
  });
}

// Call populateScenarioList when the modal is about to be shown
$('#scenarioSelectModal').on('show.bs.modal', function (e) {
  populateScenarioList();
});

</script>


<script>
    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });

    function submitRAActionForm() {
        $.ajax({
            type: "POST",
            url: "{% url 'OTRisk:save_ra_action' %}",
            data: $("#raActionsForm").serialize(),
            success: function(response) {
                if (response.status == "success") {
                    $("#RAActionsModal").modal('hide');
                    // Optionally, show a success message or perform other actions.
                } else {
                    alert("Error saving data!");
                }
            }
        });
    }
</script>




    <script>

    function showNotification(message, isError = false) {
        var notificationDiv = document.getElementById('notificationMessage');
        notificationDiv.innerHTML = message;
        notificationDiv.style.display = 'block';
        notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

        // Automatically hide the notification after some time
        setTimeout(function() {
            notificationDiv.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }


        // Function to add a new scenario row to the table
        function addScenarioRow() {
            try {
                var scenarioCount = document.querySelectorAll('#scenarioTable tbody tr').length + 1;
                var row = document.createElement('tr');
                row.id = 'scenarioRow' + scenarioCount;

                // Create table cells for each field
                var assessmentNameCell = document.createElement('td');
                var scenarioCell = document.createElement('td');
                var controlObjectiveCell = document.createElement('td');
                var riskCategoryCell = document.createElement('td');
                var mitigationMeasuresCell = document.createElement('td');
                var likelihoodCell = document.createElement('td');
                var impactCell = document.createElement('td');
                var riskLevelCell = document.createElement('td');

                // Create form elements for each field
                var assessmentNameInput = document.createElement('input');
                assessmentNameInput.type = 'text';
                assessmentNameInput.name = 'assessment_name';
                assessmentNameCell.appendChild(assessmentNameInput);

                var scenarioInput = document.createElement('input');
                scenarioInput.type = 'text';
                scenarioInput.name = 'scenarios[' + scenarioCount + '][scenario]';
                scenarioCell.appendChild(scenarioInput);

                var controlObjectiveSelect = document.createElement('select');
                controlObjectiveSelect.name = 'scenarios[' + scenarioCount + '][control_objective]';
                // Populate control objectives dynamically

                var riskCategorySelect = document.createElement('select');
                riskCategorySelect.name = 'scenarios[' + scenarioCount + '][CategoryName]';
                // Populate risk categories dynamically


                var mitigationMeasuresSelect = document.createElement('select');
                mitigationMeasuresSelect.name = 'scenarios[' + scenarioCount + '][mitigation_measures]';
                // Populate mitigation measures dynamically

                var likelihoodInput = document.createElement('input');
                likelihoodInput.type = 'number';
                likelihoodInput.name = 'scenarios[' + scenarioCount + '][likelihood]';
                likelihoodCell.appendChild(likelihoodInput);

                var impactInput = document.createElement('input');
                impactInput.type = 'number';
                impactInput.name = 'scenarios[' + scenarioCount + '][impact]';
                impactCell.appendChild(impactInput);

                var riskLevelInput = document.createElement('input');
                riskLevelInput.type = 'text';
                riskLevelInput.name = 'scenarios[' + scenarioCount + '][risk_level]';
                riskLevelInput.disabled = true;
                riskLevelCell.appendChild(riskLevelInput);

                // Append form elements to the cells
                assessmentNameCell.appendChild(assessmentNameInput);
                scenarioCell.appendChild(scenarioInput);
                controlObjectiveCell.appendChild(controlObjectiveSelect);
                riskCategoryCell.appendChild(riskCategorySelect);
                mitigationMeasuresCell.appendChild(mitigationMeasuresSelect);
                likelihoodCell.appendChild(likelihoodInput);
                impactCell.appendChild(impactInput);
                riskLevelCell.appendChild(riskLevelInput);

                // Append cells to the row
                row.appendChild(assessmentNameCell);
                row.appendChild(scenarioCell);
                row.appendChild(controlObjectiveCell);
                row.appendChild(riskCategoryCell);
                row.appendChild(mitigationMeasuresCell);
                row.appendChild(likelihoodCell);
                row.appendChild(impactCell);
                row.appendChild(riskLevelCell);

                // Append row to the table
                document.getElementById('scenarioTable').appendChild(row);
            } catch (error) {

            }
        }

        // Event listener for adding a new scenario row
        document.getElementById('addScenarioBtn').addEventListener('click', function() {
            addScenarioRow();
        });



        // Function to fetch and populate the mitigation measures dynamically
        function populateMitigationMeasures(controlObjectiveSelect) {
            fetch('/OTRisk/get_mitigation_measures/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(measure => {
                        let option = document.createElement('option');
                        option.value = measure;
                        option.text = measure;
                        controlObjectiveSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.log('Error fetching mitigation measures:', error);
                });
        }

        // Event listener to populate the mitigation measures when the control objective is selected
        document.addEventListener('change', function(event) {
            const element = event.target;
            if (element.tagName === 'SELECT' && element.name.includes('control_objective')) {
                const controlObjectiveSelect = element;
                const mitigationMeasuresSelect = controlObjectiveSelect.closest('tr').querySelector('select[name$="[mitigation_measures]"]');
                // Clear previous options
                while (mitigationMeasuresSelect.firstChild) {
                    mitigationMeasuresSelect.removeChild(mitigationMeasuresSelect.firstChild);
                }
                // Populate mitigation measures based on selected control objective
                populateMitigationMeasures(mitigationMeasuresSelect);
            }
        });

        $(".slider")

        $(document).ready(function() {


          });

         // AJAX function to call the Django view

    function isValidURL(string) {
    try {
        new URL(string);
    } catch (_) {
        return false;
    }
    return true;
}
        function assessScenario(forceResubmit = false) {
            $('#loadingProgressBar').show();
            $('#progressBarInner').css('width', '0%').attr('aria-valuenow', 0);
            $('#progressBarMessage').text('').show(); // Initialize and show message

            // Disable tab links
            $('.tab-link').addClass('disabled');

         let progress = 0;
    let progressBarInterval = setInterval(function() {
        progress++;
        if (progress <= 99) { // Increment progress until 99%
            $('#progressBarInner').css('width', progress + '%').attr('aria-valuenow', progress);

            // Update progress bar message based on current progress
            if (progress === 10) {
                $('#progressBarMessage').text('Calculating risk outcomes...');
            } else if (progress === 20) {
                $('#progressBarMessage').text('Preparing financial analysis...');
            } else if (progress === 35) {
                $('#progressBarMessage').text('Creating compliance map...');
            } else if (progress === 60) {
                $('#progressBarMessage').text('Writing recommendations...');
            }
        }
    }, 1000); // Update progress every second

            let cpha = sessionStorage.getItem('activeCyberPHA');
            let scenario = document.getElementById('id_txtScenario').value;
            let exposed_system = document.getElementById('exposed_system').checked;
            let weak_credentials = document.getElementById('weak_credentials').checked;
            // let consequence = document.getElementById('txtConsequence').value
            let threatsource = document.getElementById('threat-intelligence').value;
            let riskCategory = document.getElementById('risk-category').value;
            let safety = document.getElementById('range_safety').value;
            let life = document.getElementById('range_life').value;
            let production = document.getElementById('range_production').value;
            let financial = document.getElementById('range_finance').value;
            let reputation = document.getElementById('range_reputation').value;
            let environment = document.getElementById('range_environment').value;
            let regulatory = document.getElementById('range_regulatory').value;
            let data = document.getElementById('range_data').value;
            let supply = document.getElementById('range_supply').value;
            let sm = document.getElementById('SMrange').value;
            let mel = document.getElementById('MELrange').value;
            let rrm = document.getElementById('RRMrange').value;
            let sa = document.getElementById('SArange').value;
            let sl_a = document.getElementById('selSL').value;
            let mela = document.getElementById('MELarange').value;
            let industry = sessionStorage.getItem('sessionIndustry')
            let facilityType = sessionStorage.getItem('sessionFacilityType')
            // let standards = document.getElementById('selStandards').value;
            let country = document.getElementById('hdnCountry').value;
            let uel = document.getElementById('uel_range').value;
            let safety_hazard = document.getElementById('hazardNature').value;
            let production_outage = document.getElementById('outageYes').value;
            let production_outage_length = document.getElementById('outageDuration').value;
            // Gather validated consequences
            const table = document.getElementById('consequenceTable');
            const rows = table.getElementsByTagName('tbody')[0].rows;
            let validatedConsequences = [];
            let validatedConsequenceExists = false;

             // Gather Physical Safeguards from the table
            let physicalSafeguards = [];
            $("#table_safeguards tbody tr").each(function() {
                let safeguard = $(this).find("td:first textarea").val(); // Assuming the first column contains a textarea
                if (safeguard) {
                    physicalSafeguards.push(safeguard.trim());
                }
            });

            // Format the physical safeguards into a string
            let physicalSafeguardsStr = "Physical security controls. Control:" + physicalSafeguards.join(". Control: ")

            for (let i = 0; i < rows.length; i++) {
                const isChecked = rows[i].cells[1].getElementsByTagName('input')[0].checked;
                if (isChecked) {
                    validatedConsequences.push(rows[i].cells[0].innerText);
                    validatedConsequenceExists = true;
                }
            }

            // Check if no consequences have been validated
            if (!validatedConsequenceExists) {
                alert("No consequences have been validated. Please validate at least one consequence before proceeding.");
                $('#loadingSpinner').hide();
                return; // Exit the function
            }

            // Convert the array of consequences to a string for sending in the AJAX request
            let validatedConsequencesStr = validatedConsequences.join(';');
            // Make the AJAX call to the Django view using the determined URL
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:scenario_analysis' %}",
                data: {
                    // Pass the impact scores and scenario information as parameters
                    force_resubmit: forceResubmit,
                    industry: industry,
                    facility_type: facilityType,
                    scenario: scenario,
                    exposed_system: exposed_system,
                    weak_credentials: weak_credentials,
                    threatsource: threatsource,
                    safety: safety,
                    life: life,
                    production: production,
                    reputation: reputation,
                    environment: environment,
                    regulatory: regulatory,
                    data: data,
                    sm: sm,
                    mel: mel,
                    rrm: sa,
                    supply: supply,
                    country: country,
                    uel: uel,
                    financial: financial,
                    cpha: cpha,
                    sl_a: sl_a,
                    safety_hazard: safety_hazard,
                    production_outage: production_outage,
                    production_outage_length: production_outage_length,
                    validated_consequences: validatedConsequencesStr,
                    physical_safeguards: physicalSafeguardsStr
                },
                success: function (response) {
                    // On success, set progress to 100% and hide the progress bar
                    clearInterval(progressBarInterval);
                    $('#progressBarInner').css('width', '100%').attr('aria-valuenow', 100);
                    $('#progressBarMessage').text('Complete!').show();
                    setTimeout(function() { // Briefly show 100% before hiding
                        $('#loadingProgressBar').hide();
                        $('#progressBarMessage').hide();
                    }, 500); // Adjust delay as needed
                     $('.tab-link').removeClass('disabled');
                    if (response.message === 'Scenario parameters have not changed.') {
                        // Display a SweetAlert notification
                        swal.fire({
                            title: "Duplicate Submission",
                            html: "You are submitting a scenario with the same parameters as one previously analyzed. Do you wish to proceed?",
                            iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                            showCancelButton: true, // Show the cancel button
                            confirmButtonText: 'OK', // Text for the confirm button
                            cancelButtonText: 'Cancel',
                            focusConfirm: false
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // If the user chooses to proceed, call assessScenario again with forceResubmit = true
                                assessScenario(true);
                            }
                        });
                    } else {
                        $('#loadingSpinner').hide();
                        console.log(response);
                        document.getElementById('txtRRa').value = response.adjustedRR;
                        document.getElementById('hdnLikelihood').value = response.likelihood;
                        document.getElementById('txtLikelihood').value = response.likelihood + '%';

                        let costsString = response.costs;
                        let costsArray = costsString.split('|');
                        let sle_low = costsArray.length > 0 && costsArray[0] ? `$${parseInt(costsArray[0]).toLocaleString()}` : "$0";
                        let sle_medium = costsArray.length > 1 && costsArray[1] ? `$${parseInt(costsArray[1]).toLocaleString()}` : "$0";
                        let sle_high = costsArray.length > 2 && costsArray[2] ? `$${parseInt(costsArray[2]).toLocaleString()}` : "$0";
                        document.getElementById('txtEventCosts').value = sle_medium;
                        document.getElementById('txtEventCosts_low').value = sle_low;
                        document.getElementById('txtEventCosts_high').value = sle_high;
                        document.getElementById('hdnrationale_recommendation').value = response.rationale.Recommendation;
                        document.getElementById('hdnrationale_Rationale').value = response.rationale.Rationale;
                         $("#recommendationTitle").text("Recommendation");
                        $("#recommendationText").text(response.rationale.Recommendation);
                        $("#rationaleTitle").text("Rationale");
                        $("#rationalePoints").html("<li>" + response.rationale.Rationale.replace(/\n/g, "</li><li>") + "</li>");

                        document.getElementById('frequency').value = response.frequency;
                        document.getElementById('txtProbability').value = response.probability;

                        document.getElementById('hdn_control_effectiveness').value = response.control_effectiveness;
                        displayRecommendations(response.recommendations);


                        document.getElementById("hdnRecommendations").value = response.recommendations;
                        document.getElementById('hdn_bia_score').value = response.biaScore;

                        let ale_low = parseFloat(costsArray[0]) * parseFloat(response.frequency);

                        // Format ALE as currency
                        let formatter = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 0, // No decimal places
                            maximumFractionDigits: 0  // No decimal places
                        });

                        let formattedAleLow = formatter.format(ale_low);


                        let ale_median = parseFloat(costsArray[1]) * parseFloat(response.frequency);

                        let formattedAleMedian = formatter.format(ale_median);


                        let ale_high = parseFloat(costsArray[2]) * parseFloat(response.frequency);

                        let formattedAleHigh = formatter.format(ale_high);

                        // Set the formatted value
                        document.getElementById('txt_ale_high').value = formattedAleHigh;
                        document.getElementById('txt_ale_median').value = formattedAleMedian;
                        document.getElementById('txt_ale_low').value = formattedAleLow;

                        document.getElementById('scenario_12month_costs').value = response.projection;

                        var costArray = response.projection.split('|').map(Number);
                        createCostChart('monthly_cost_chart', costArray);

                        var controlEffectivenessPercentage = response.control_effectiveness;
                        clearContainer('gaugeProbContainer');
                        clearContainer('gaugeContainer');
                        clearContainer('gaugeLikelihoodContainer');
                        clearContainer('gaugeResidualRisk');
                        clearContainer('gaugeFrequency');
                        clearContainer('gaugeBIAContainer');

                        createEffectivenessGauge(controlEffectivenessPercentage);
                        createProbGauge(response.probability);
                        createBIAGauge(response.biaScore);
                        createFrequencyGauge(response.frequency);
                        createLikelihoodGauge(response.likelihood);
                        // Define the text values based on the percentage range
                        var textValue = "";
                        if (controlEffectivenessPercentage < 25) {
                            textValue = "Low";
                        } else if (controlEffectivenessPercentage < 50) {
                            textValue = "Low/Medium";
                        } else if (controlEffectivenessPercentage < 75) {
                            textValue = "Medium";
                        } else if (controlEffectivenessPercentage < 90) {
                            textValue = "Medium/High";
                        } else {
                            textValue = "High";
                        }

                        document.getElementById('compliance_map').value = response.scenario_compliance_data;
                        // Destroy existing DataTable instance if it exists
                        if ($.fn.DataTable.isDataTable('#compliance_map')) {
                            $('#compliance_map').DataTable().destroy();
                        }
                        var compliance_map = response.scenario_compliance_data;

                        // Check if the DataTable is already initialized
                        var isDataTable = $.fn.DataTable.isDataTable('#compliance_map');
                        var dataTable;

                        if (isDataTable) {
                            // If already a DataTable, clear and destroy it
                            dataTable = $('#compliance_map').DataTable();
                            dataTable.clear().destroy();
                        } else {
                            // Clear the table body if it's not a DataTable
                            $('#compliance_map tbody').empty();
                        }
                        // Split the response into individual lines
                        var lines = compliance_map.split('||');
                        lines.forEach(function (line) {
                            if (line.trim() !== '') {
                                // Split each line into fields
                                var fields = line.split(' > ');

                                // Create a new row in the table
                                // Check if all fields exist and then create a new row in the table
                                if (fields.length === 3) {
                                    var newRow = '<tr>' +
                                        '<td>' + (fields[0] ? fields[0].trim() : '') + '</td>' +
                                        '<td>' + (fields[1] ? fields[1].trim() : '') + '</td>' +
                                        '<td>' + (fields[2] ? '<a href="' + fields[2].trim() + '" target="_blank">' + fields[2].trim() + '</a>' : '') + '</td>' +
                                        '</tr>';
                                    $('#compliance_map tbody').append(newRow);
                                }
                            }
                        });
                        // Set the value of the 'control_effectiveness' text control
                        document.getElementById('control_effectiveness').value = textValue;
                        //document.getElementById('txtEventCosts').value = formattedCosts;
                        document.getElementById('txtResidualRisk').value = response.adjustedRR

                        createResidualRiskGauge(response.adjustedRR);

                        $('#compliance_map').DataTable({
                            "paging": false,  // Enable pagination
                            "pageLength": 10,  // Set the number of rows per page
                            "searching": false,  // Disable the search box
                            "lengthChange": false,  // Disable the page length selection control
                            "info": false
                        });
                    }
                },
                error: function (xhr, status, error) {

                    // Handle any errors that occur during the AJAX call
                    if (xhr.status === 403) {

                        swal.fire({
                            title: 'Allowance Exceeded',
                            html: 'You have used up all of your allocated scenario risk analysis allowance. Please contact your administrator or AnzenOT at <a href="mailto:support@anzenot.com">support@anzenot.com</a> to increase your allowance.',
                            iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
                            customClass: {
                                icon: 'no-border' // This class removes the default icon border and background
                            },
                            confirmButtonText: 'Ok',
                            confirmButtonColor: '#3085d6',
                        });
                    } else {
                        // Handle other errors
                    }
                    clearInterval(progressBarInterval);
                    $('#loadingProgressBar').hide();
                    $('#progressBarMessage').hide();
                     $('.tab-link').removeClass('disabled');
                },
            });
        }

document.getElementById('hdnphaID').value = sessionStorage.getItem('activeCyberPHA');

document.addEventListener("DOMContentLoaded", function() {
    // Function to update the indicator
    function updateIndicator(textarea, indicator) {
        if (textarea.value.trim() !== "") {
            indicator.style.display = "inline";
        } else {
            indicator.style.display = "none";
        }
    }

    // Get all labels with the data-modal-id attribute
    const labels = document.querySelectorAll('[data-modal-id]');

    labels.forEach(label => {
        const modalId = label.getAttribute('data-modal-id');
        const textareaId = label.getAttribute('data-textarea-id');
        const textarea = document.getElementById(textareaId);
        const indicator = label.nextElementSibling; // Assuming the indicator is the next sibling of the label

        // Check on modal close
        $('#' + modalId).on('hidden.bs.modal', function (e) {
            updateIndicator(textarea, indicator);
        });

        // Check on textarea change

        textarea.addEventListener('input', function() {
            console.log(textarea);
            console.log(indicator);
            updateIndicator(textarea, indicator);
        });
    });
});

function displayRecommendations(recommendations) {

    try {
        $("#span_recommendations").empty();
        let recommendationsArray = recommendations.split('\n').filter(r => r.trim() !== '');
        recommendationsArray.forEach((rec, index) => {
            let parts = rec.split('[');
            let recommendationText = parts[0].trim();
            let nistReference = parts[1].replace(']', '').trim();

            let boxHtml = `
                <div class="recommendation-box" id="recBox${index}">
                    <div class="recommendation-text">${recommendationText}</div>
                    <div class="nist-reference">${nistReference}</div>
                </div>
            `;

            $("#span_recommendations").append(boxHtml);
        });
    } catch (error){
    // Optionally, you can display a user-friendly error message on the UI as well
    $("#span_recommendations").append(`<div class="error-message">Error displaying recommendations. Please try again later.</div>`);
}
}




function createActionItem(recBoxId) {
    console.log(`Create action item for ${recBoxId}`);
    $(".custom-context-menu").hide();
}

    function createEffectivenessGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["red", "orange", "yellow", "green"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeContainer').draw();
}

function createBIAGauge(score){

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeBIAContainer').draw();

}

 function createProbGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeProbContainer').draw();

}


 function createLikelihoodGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeLikelihoodContainer').draw();
}

function createResidualRiskGauge(rating) {
    // Translate the rating to a numerical value
    var score;
    switch (rating) {
        case "Low":
            score = 10;
            break;
        case "Low/Medium":
            score = 33;
            break;
        case "Medium":
            score = 50;
            break;
        case "Medium/High":
            score = 66;
            break;
        case "High":
            score = 90;
            break;
        default:
            return;
    }

    var data = [score];
    // set the gauge type
   var gauge = anychart.gauges.linear();
   gauge.layout('vertical'); // Set the layout to horizontal
        var credits = gauge.credits();
    credits.enabled(false);
   // set the data for the gauge
   gauge.data(data);

   var scaleBarColorScale = anychart.scales.ordinalColor().ranges(
  [
    {
      from: 0,
      to: 25,

        color: ['#CAD70b', '#2AD62A']
    },
    {
      from: 25,
      to: 50,

        color: ['#FFD700', '#CAD70b']
    },
    {
      from: 50,
      to: 75,
      color: ['#EB7A02', '#FFD700']
    },
    {
      from: 75,
      to: 100,
       color: ['#D81E05', '#EB7A02']
    }
  ]
);
var scaleBar = gauge.scaleBar(0);

   // set the height and offset of the Scale Bar (both as percentages of the gauge height)
   scaleBar.width('15%');
   scaleBar.offset('10%');

   // use the color scale (defined earlier) as the color scale of the Scale Bar
   scaleBar.colorScale(scaleBarColorScale);

   // add a marker pointer
   var marker = gauge.marker(0);
    marker.width(7.5);
   // set the offset of the pointer as a percentage of the gauge width
   marker.offset('27%');

   // set the marker type
   marker.type('triangle-left');
   // set the color of the marker to black
   marker.color('black');
    // set the zIndex of the marker
   marker.zIndex(10);

   // Adjust label positioning to place it inside the column next to the pointer
    var label = gauge.label();

    label.text(data.toString())
         .position({x: '50%', y: '95%'})
         .anchor('centerBottom')
         .offsetX('50%') // Adjust this value to position the label next to the marker
         .offsetY(-15) // Manually adjust based on the gauge's scale and layout
         .hAlign('center')
         .zIndex(20);
   // configure the scale
   var scale = gauge.scale();
   scale.minimum(0);
   scale.maximum(100);
   scale.ticks().interval(10);

    var axis = gauge.axis();
    axis.minorTicks(true)
    axis.minorTicks().stroke('#cecece');
    axis.width('1%');
    axis.offset('5%');
    axis.orientation('left');

    // format axis labels
    axis.labels().format(function() {
        if (this.value == 0) return "Low";
        else if (this.value == 50) return "Medium";
        else if (this.value == 100) return "High";
        else return "";  // This will hide other labels
    });
    gauge.width('100%');


    gauge.height('95%'); // Set height for vertical layout
    gauge.layout();
    gauge.padding([15, 0, 0, 15]); // Adjust padding for vertical layout


    // Draw the chart
    gauge.container('gaugeResidualRisk').draw();
}

function createFrequencyGauge(rating) {

    var data = rating;
    var gauge = anychart.gauges.linear();
    gauge.layout('vertical');

    var credits = gauge.credits();
    credits.enabled(false);

    gauge.data(data);

    var scaleBarColorScale = anychart.scales.ordinalColor().ranges([
        { from: 0, to: 1, color: ['#CAD70b', '#2AD62A'] },
        { from: 1, to: 3, color: ['#FFD700', '#CAD70b'] },
        { from: 3, to: 4, color: ['#EB7A02', '#FFD700'] },
        { from: 4, to: 5, color: ['#D81E05', '#EB7A02'] }
    ]);

    var scaleBar = gauge.scaleBar(0);
    scaleBar.width('15%');
    scaleBar.offset('10%');
    scaleBar.colorScale(scaleBarColorScale);

    var marker = gauge.marker(0);
    marker.width(7.5);
    marker.offset('27%');
    marker.type('triangle-left');
    marker.color('black');
    marker.zIndex(10);

    // Adjust label positioning to place it inside the column next to the pointer
    var label = gauge.label();

    label.text(data.toString())
         .position({x: '50%', y: '95%'})
         .anchor('centerBottom')
         .offsetX('50%') // Adjust this value to position the label next to the marker
         .offsetY(-15) // Manually adjust based on the gauge's scale and layout
         .hAlign('center')
         .zIndex(20);

    var scale = gauge.scale();
    scale.minimum(0);
    scale.maximum(5);
    scale.ticks().interval(0.5);

    var axis = gauge.axis();
    axis.minorTicks(true);
    axis.minorTicks().stroke('#cecece');
    axis.width('1%');
    axis.offset('5%');
    axis.orientation('left');

    axis.labels().format(function() {
        if (this.value % 0.5 === 0) {
            return this.value.toFixed(1);
        }
        return "";
    });

    gauge.height('95%');
    gauge.layout();
    gauge.padding([15, 0, 0, 15]);

    gauge.container('gaugeFrequency').draw();
}





function resetformcontrols() {
  swal.fire({
    title: "New Scenario",
    html: "Are you sure you want to begin a new scenario and reset the form? All unsaved changes will be lost.",
    iconHtml: '<img src="/static/images/anzen_owl.png" width="100px">', // Custom image as icon
    showCancelButton: true, // Show the cancel button
    confirmButtonText: 'Yes', // Text for the confirm button
    cancelButtonText: 'No', // Text for the cancel button
    focusConfirm: false, // Focus on the confirm button by default
    reverseButtons: true, // Reverse the button positions (if you want "No" to the right of "Yes"

}).then((result) => {
    if (result.isConfirmed) {
      // Reset form fields here
      sessionStorage.setItem('attackTreeDrawn', 'false');

      document.getElementById('exportAttackTreeBtn').style.display = 'none';

      document.getElementById('id_txtScenario').value = '';
      document.getElementById('exposed_system').checked = false;
      document.getElementById('weak_credentials').checked = false;
      // document.getElementById('txtConsequence').value = '';
      document.getElementById('threat-intelligence').value = '';
      document.getElementById('risk-category').value = '';
      document.getElementById('range_safety').value = 0;
      document.getElementById('range_life').value = 0;
      document.getElementById('range_production').value = 0;
      document.getElementById('range_finance').value = 0;
      document.getElementById('range_reputation').value = 0;
      document.getElementById('range_environment').value = 0;
      document.getElementById('range_regulatory').value = 0;
      document.getElementById('range_data').value = 0;
      document.getElementById('range_supply').value = 0;
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('selSL').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtsafetyJustify').value = '';
      document.getElementById('hazardNature').value = '';
      document.getElementById('dangerScope').value = '';
      document.getElementById('sisOutageYes').checked = false;
      document.getElementById('sisOutageNo').checked = true;
      document.getElementById('sisIntegrityYes').checked = false;
      document.getElementById('sisIntegrityNo').checked = true;
      document.getElementById('txtlifeJustify').value = '';
      document.getElementById('txtproductionJustify').value = '';
      document.getElementById('txtfinanceJustify').value = '';
      document.getElementById('txtreputationJustify').value = '';
      document.getElementById('txtenvironmentJustify').value = '';
      document.getElementById('txtregulatoryJustify').value = '';
      document.getElementById('txtdataJustify').value = '';
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;

      document.getElementById('txtLikelihood').value = 0;
      document.getElementById('hdnLikelihood').value = 0;
      document.getElementById('txtRRa').value = 0;
      document.getElementById('txtProbability').value = '';
      document.getElementById('control_effectiveness').value = '';
      document.getElementById('hdn_control_effectiveness').value = '';
      document.getElementById('hdn_bia_score').value = '';

      document.getElementById('txtEventCosts_low').value = '';
      document.getElementById('txtEventCosts').value = '';
      document.getElementById('txtEventCosts_high').value = '';
      document.getElementById('txt_ale_low').value = '';
      document.getElementById('txt_ale_median').value = '';
      document.getElementById('txt_ale_high').value = '';
      document.getElementById('frequency').value = '';
      document.getElementById('txtResidualRisk').value = '';
      document.getElementById('risk_register').checked = false;
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows
      // document.getElementById('has_controls').value = 0;
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');
     $('#table_safeguards tbody').empty();
      sessionStorage.setItem('ls', '0');
      sessionStorage.setItem('sid', 0);
        $('.tab-content').removeClass('active').hide();
        $('#tab2').addClass('active').show();
        document.querySelector('a[data-tab="tab2"]').click();

    }
  });
}

function clearScenario(){
         sessionStorage.setItem('attackTreeDrawn', 'false');

      document.getElementById('exportAttackTreeBtn').style.display = 'none';

      document.getElementById('id_txtScenario').value = '';
      document.getElementById('exposed_system').checked = false;
      document.getElementById('weak_credentials').checked = false;
      // document.getElementById('txtConsequence').value = '';
      document.getElementById('threat-intelligence').value = '';
      document.getElementById('risk-category').value = '';
      document.getElementById('range_safety').value = 0;
      document.getElementById('range_life').value = 0;
      document.getElementById('range_production').value = 0;
      document.getElementById('range_finance').value = 0;
      document.getElementById('range_reputation').value = 0;
      document.getElementById('range_environment').value = 0;
      document.getElementById('range_regulatory').value = 0;
      document.getElementById('range_data').value = 0;
      document.getElementById('range_supply').value = 0;
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('selSL').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtsafetyJustify').value = '';
      document.getElementById('hazardNature').value = '';
      document.getElementById('dangerScope').value = '';
      document.getElementById('sisOutageYes').checked = false;
      document.getElementById('sisOutageNo').checked = true;
      document.getElementById('sisIntegrityYes').checked = false;
      document.getElementById('sisIntegrityNo').checked = true;
      document.getElementById('txtlifeJustify').value = '';
      document.getElementById('txtproductionJustify').value = '';
      document.getElementById('txtfinanceJustify').value = '';
      document.getElementById('txtreputationJustify').value = '';
      document.getElementById('txtenvironmentJustify').value = '';
      document.getElementById('txtregulatoryJustify').value = '';
      document.getElementById('txtdataJustify').value = '';
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;

      document.getElementById('txtLikelihood').value = 0;
      document.getElementById('hdnLikelihood').value = 0;
      document.getElementById('txtRRa').value = 0;
      document.getElementById('txtProbability').value = '';
      document.getElementById('control_effectiveness').value = '';
      document.getElementById('hdn_control_effectiveness').value = '';
      document.getElementById('hdn_bia_score').value = '';

      document.getElementById('txtEventCosts_low').value = '';
      document.getElementById('txtEventCosts').value = '';
      document.getElementById('txtEventCosts_high').value = '';
      document.getElementById('txt_ale_low').value = '';
      document.getElementById('txt_ale_median').value = '';
      document.getElementById('txt_ale_high').value = '';
      document.getElementById('frequency').value = '';
      document.getElementById('txtResidualRisk').value = '';
      document.getElementById('risk_register').checked = false;
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows
      // document.getElementById('has_controls').value = 0;
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');
    $('#table_safeguards tbody').empty();
      sessionStorage.setItem('ls', '0');
      sessionStorage.setItem('sid', 0);


}

 function fillScenario(scenarioId) {
    clearScenario();
    sessionStorage.setItem('sid', scenarioId);

    sessionStorage.setItem('attackTreeDrawn', 'false');

    document.getElementById('exportAttackTreeBtn').style.display = 'none';


    var container = document.getElementById('attack_tree');
    container.innerHTML = '';
    // Send a GET request to the getSingleScenario view
    $.get("{% url 'OTRisk:getSingleScenario' %}", { id: scenarioId }, function(data) {

         if (data.risk_register === true) {
            sessionStorage.setItem("ls", "1");
            $('#risk_register').prop('checked', true);
        } else {
            sessionStorage.setItem("ls", "0");
            $('#risk_register').prop('checked', false);
        }
        // Fill the form fields with the returned data
        $('#id_txtScenario').val(data.Scenario);

        $('#exposed_system').prop('checked', data.exposed_system);
        $('#weak_credentials').prop('checked', data.weak_credentials);

        //$('#txtConsequence').val(data.Consequence);
        $('#threat-intelligence').val(data.ThreatClass);
        //$('#selStandards').val(data.standards);


         $('#risk-category').val(data.RiskCategory);
         $('#risk-category').val(data.RiskCategory);

         $('.tab-link[data-tab="tab4"]').click();

         $('#range_safety').val(data.impactSafety);
         $('#range_life').val(data.impactDanger);
         $('#range_production').val(data.impactProduction);
         $('#range_finance').val(data.impactFinance);
         $('#range_reputation').val(data.impactReputation);

         $('#range_environment').val(data.impactEnvironment);
         $('#range_regulation').val(data.impactRegulation);
         $('#range_data').val(data.impactData);
        $('#range_supply').val(data.impactSupply);

         $('#scenarioStatusSelect').val(data.scenario_status);

         $('#env_contaminant').val(data.env_contaminant);
         $('#env_ecosystem').val(data.env_ecosystem);
         $('#env_contamination').val(data.env_contamination);
         $('#env_population').val(data.env_population);
         $('#env_wildlife').val(data.env_wildlife);

        $('.tab-link[data-tab="tab2"]').click();



         // $('#selStandards').val(data.RiskCategory);

        $('#hdnRecommendations').val(data.recommendations);
        savedRecommendations = data.recommendations;
        if (savedRecommendations) {
            displayRecommendations(savedRecommendations);
        }
        $('#SMrange').val(data.SM);
        $('#MELrange').val(data.MEL);
        $('#RRMrange').val(data.RRM);
        $('#selSL').val(data.sl_a);
        $('#SArange').val(data.SA);
        $('#MELarange').val(data.MELA);
        $('#uel_range').val(data.UEL);
        $('#uel_vuln').val(data.uel_vuln);
        $('#uel_exposure').val(data.uel_exposure);
        $('#uel_threat').val(data.uel_threat);
        $('#rru_range').val(data.RRU);
        $('#frequency').val(data.frequency);
        $('#has_controls').val(data.has_controls);
        document.getElementById('user_role').textContent = data.user_role;

        $('#sle').val(data.sle);

        $('#compliance_map').val(data.compliance_map);

        $('#attack_tree_text').val(data.attack_tree_text || '');  // Set to empty string if undefined or null

        // Check if data.attack_tree_text is defined, not null, and not an empty string
        if (data.attack_tree_text && data.attack_tree_text.trim() !== '') {

            var jsonStringFromDatabase = data.attack_tree_text;
            var jsonObject = JSON.parse(jsonStringFromDatabase);
            drawAttackTree(jsonObject);
        }



        if ($.fn.DataTable.isDataTable('#compliance_map')) {
                        $('#compliance_map').DataTable().destroy();
                    }
        var compliance_map = data.compliance_map;

        if (data.cost_projection !== null) {
            document.getElementById('scenario_12month_costs').value = data.cost_projection;

            var costArray = data.cost_projection.split('|').map(Number);
            createCostChart('monthly_cost_chart', costArray);
        }

        // Check if the DataTable is already initialized
        var isDataTable = $.fn.DataTable.isDataTable('#compliance_map');
        var dataTable;

        if (isDataTable) {
            // If already a DataTable, clear and destroy it
            dataTable = $('#compliance_map').DataTable();
            dataTable.clear().destroy();
        } else {
            // Clear the table body if it's not a DataTable
            $('#compliance_map tbody').empty();
        }
        // Split the response into individual lines
        var lines = compliance_map.split('||');
        lines.forEach(function(line) {
            if (line.trim() !== '') {
                // Split each line into fields
                var fields = line.split(' > ');

                // Create a new row in the table
                // Check if all fields exist and then create a new row in the table
            if (fields.length === 3) {
                var newRow = '<tr>' +
                    '<td>' + (fields[0] ? fields[0].trim() : '') + '</td>' +
                    '<td>' + (fields[1] ? fields[1].trim() : '') + '</td>' +
                    '<td>' + (fields[2] ? '<a href="' + fields[2].trim() + '" target="_blank">' + fields[2].trim() + '</a>' : '') + '</td>' +
                    '</tr>';
                $('#compliance_map tbody').append(newRow);
            }
            }
        });

        $('#compliance_map').DataTable({
                "paging": false,  // Enable pagination
                "pageLength": 10,  // Set the number of rows per page
                "searching": false,  // Disable the search box
                "lengthChange": false,  // Disable the page length selection control
                "info": false
            });
        let costs = parseFloat(data.sle); // Assuming response.costs is a string representation of a number
        let formattedCosts = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs);

        document.getElementById('sle').value = formattedCosts;
        document.getElementById('txtEventCosts').value= formattedCosts;
        let costs_low = parseFloat(data.sle_low); // Assuming response.costs is a string representation of a number
        let formattedCosts_low = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_low);
        document.getElementById('txtEventCosts_low').value= formattedCosts_low;
        let costs_high = parseFloat(data.sle_high); // Assuming response.costs is a string representation of a number
        let formattedCosts_high = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_high);
        document.getElementById('txtEventCosts_high').value= formattedCosts_high;
        let ale_costs_high = parseFloat(data.ale_high); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_high = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_high);
        document.getElementById('txt_ale_high').value= ale_formattedCosts_high;
        let ale_costs_low = parseFloat(data.ale_low); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_low = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_low);
        document.getElementById('txt_ale_low').value= ale_formattedCosts_low;
        let ale_costs_median = parseFloat(data.ale_median); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_median = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_median);
        document.getElementById('txt_ale_median').value= ale_formattedCosts_median;

        document.getElementById('txtResidualRisk').value= data.RRa;
        document.getElementById('txtProbability').value= data.probability;
        document.getElementById('hdn_control_effectiveness').value= data.control_effectiveness;
        document.getElementById('hdn_bia_score').value= data.ai_bia_score;
        document.getElementById('hdnrationale_recommendation').value = data.risk_recommendation;
        document.getElementById('hdnrationale_Rationale').value = data.risk_rationale;
         $("#recommendationTitle").text("Recommendation");
        $("#recommendationText").text(data.risk_recommendation);
        $("#rationaleTitle").text("Rationale");
        $("#rationalePoints").html("<li>" + data.risk_rationale.replace(/\n/g, "</li><li>") + "</li>");


         // Populate the scenario_consequences table
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows

        data.Consequences.forEach(function(consequence) {
            var checked = consequence.is_validated ? 'checked' : '';
            var row = `<tr>
                <td>${consequence.consequence_text}</td>
                <td><input type="checkbox" ${checked}></td>
            </tr>`;
            tableBody.append(row);
        });

        // Clear existing rows in the safeguards table
    $('#table_safeguards tbody').empty();

    // Check if there are safeguards in the response
    if (data.safeguards && data.safeguards.length > 0) {
        // Iterate over each safeguard and append it to the table
        data.safeguards.forEach(function(safeguard) {
            var newRow = `<tr>
                <td><textarea class="form-control" maxlength="100">${safeguard.safeguard_description}</textarea></td>
                <td><textarea class="form-control" maxlength="100">${safeguard.safeguard_type}</textarea></td>
                <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
            </tr>`;
            $('#table_safeguards tbody').append(newRow);
        });
    } else {
        // If no safeguards, add a dummy row indicating this
        var newRow = `<tr>
            <td><textarea class="form-control" maxlength="100">No physical safeguards defined</textarea></td>
            <td><textarea class="form-control" maxlength="100">No physical safeguards defined</textarea></td>
            <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
        </tr>`;
        $('#table_safeguards tbody').append(newRow);
    }
        // Define the text values based on the percentage range
                    var textValue = "";
                    if (data.control_effectiveness < 25) {
                        textValue = "Low";
                    } else if (data.control_effectiveness < 50) {
                        textValue = "Low/Medium";
                    } else if (data.control_effectiveness < 75) {
                        textValue = "Medium";
                    } else if (data.control_effectiveness < 90) {
                        textValue = "Medium/High";
                    } else {
                        textValue = "High";
                    }
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');

         createEffectivenessGauge(data.control_effectiveness);
         createProbGauge(data.probability);
         createLikelihoodGauge(data.likelihood);
         createBIAGauge(data.ai_bia_score);
         createResidualRiskGauge(data.RRa);
         createFrequencyGauge(data.frequency);

        // Set the value of the 'control_effectiveness' text control
        document.getElementById('control_effectiveness').value = textValue;
        document.getElementById('hdnScenario').value = scenarioId;

         $('#txtRRa').val(data.RRa);
         $('#hdnLikelihood').val(data.likelihood);
        $('#txtLikelihood').val(data.likelihood + '%');
        $('#txtdataJustify').val(data.justifyData);
        $('#txtregulatoryJustify').val(data.justifyRegulation);
        $('#txtenvironmentJustify').val(data.justifyEnvironment);
        $('#txtreputationJustify').val(data.justifyReputation);
        $('#txtfinanceJustify').val(data.justifyFinancial);
        $('#txtproductionJustify').val(data.justifyProduction);
        $('#txtlifeJustify').val(data.justifyLife);
        $('#txtsafetyJustify').val(data.justifySafety);
        $('#hazardNature').val(data.safety_hazard);
        $('#dangerScope').val(data.dangerScope);
        if (data.sis_compromise) {
          $('#sisIntegrityYes').prop('checked', true);
        } else {
          $('#sisIntegrityNo').prop('checked', true);
        }

        if (data.sis_outage) {
            $('#sisOutageYes').prop('checked', true);

            } else {
            $('#sisOutageNo').prop('checked', true);

        }

        if (data.prodOutage) {
            $('#outageYes').prop('checked', true);
            toggleOutageControls(true);
            } else {
            $('#outageNo').prop('checked', true);
            toggleOutageControls(false);
        }
        $('#outageDuration').val(data.prodOutageDuration);
        $('#outageCost').val(data.prodOutageCost);

        loadVulnerabilityTable(scenarioId);
        if (data.user_role === 'Scenario Moderator') {
            disableScenarioControls();
        }
         });


        $('.tab-content').removeClass('active').hide();
        $('#tab2').addClass('active').show();

    }

    function abbreviateValue(value) {
    var newValue = value;
    if (value >= 1000 && value < 1000000) {
        newValue = "$" + (value / 1000).toFixed(1) + "k"; // Thousands
    } else if (value >= 1000000) {
        newValue = "$" + (value / 1000000).toFixed(1) + "m"; // Millions
    } else {
        newValue = "$" + value; // Less than 1000
    }
    return newValue;
}

    function createCostChart(containerId, costArray) {
    var data = [];
    for (let i = 0; i < costArray.length; i++) {
        data.push({x: `Month ${i + 1}`, value: costArray[i]});
    }

    // Ensure the chart library is ready before creating the chart
    anychart.onDocumentReady(function() {
        // Clear the container before creating a new chart
        document.getElementById(containerId).innerHTML = '';

        var chart = anychart.column();
        chart.data(data);

        // Set the chart title
        chart.title("Monthly Cost Estimates");

        // Customize the X-axis labels
        var xAxis = chart.xAxis();
        xAxis.title("Month");
        xAxis.labels()
            .rotation(-70) // Angle the labels
            .fontSize(10); // Smaller font size

        // Customize the Y-axis
        var yAxis = chart.yAxis();
        yAxis.title("Cost in USD");

        var series = chart.getSeries(0);
        series.labels(true);
        series.labels()
            .position("above")
            .anchor("centerBottom")
            .fontSize(10)
            .format(function() {
                return abbreviateValue(this.value);
            });

        // Optionally disable credits if needed
        var credits = chart.credits();
        credits.enabled(false);

        // Draw the chart in the specified container
        chart.container(containerId);
        chart.draw();
    });
}

    function disableScenarioControls() {
    // Disable all input, textarea, button, and select elements except those specified
    $('input, textarea, button, select').not('#scenarioStatusSelect, button[onclick="processFormData()"]').prop('disabled', true);

    // Additionally, hide or disable other elements as needed
    // For example, to hide specific buttons:
    // $('#someButtonId').hide();
    // Or to disable specific buttons:
    // $('#someButtonId').prop('disabled', true);
}



function clearContainer(containerId) {
    var container = document.getElementById(containerId);
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
}

$(document).ready(function() {
    // Check if there are any rows in the table
    var rows = $("#userscenarioListBody tr");
    if (rows.length > 0) {
        // If there are rows, trigger a click on the first one
        //rows.first().click();
    }
});



</script>


<input type="text" id="control_effectiveness" name="control_effectiveness" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtProbability" name="txtProbability" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtLikelihood" name="txtLikelihood" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtResidualRisk" name="txtResidualRisk" class="form-control text-center" readonly style="visibility: hidden">

<!-- Action Assets -->
                <div class="mb-3" style="visibility: hidden">>
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="row justify-content-center" style="visibility: hidden">
                                <div class="col-md-12">
                                <p class="justify-content-center">Expected Risk Mitigation from Action</p>
                                </div>
                            </div>
                            <div class="row justify-content-center" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="safetyMitigation">Safety: <span id="safetyMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="safetyMitigation" name="safetyMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="lifeMitigation">Life: <span id="lifeMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="lifeMitigation" name="lifeMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="productionMitigation">Production: <span id="productionMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="productionMitigation" name="productionMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="financeMitigation">Finance: <span id="financeMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="financeMitigation" name="financeMitigation" min="0" max="100" value="0">
                                </div>

                                <div class="col-md-4">
                                    <label for="reputationMitigation">Reputation: <span id="reputationMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="reputationMitigation" name="reputationMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="environmentMitigation">Environment: <span id="environmentMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="environmentMitigation" name="environmentMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="regulationMitigation">Regulation: <span id="regulationMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="regulationMitigation" name="regulationMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="dataMitigation">Data: <span id="dataMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="dataMitigation" name="dataMitigation" min="0" max="100" value="0">
                                </div>

                                <div class="col-md-4">
                                    <label for="supplyMitigation">Supply: <span id="supplyMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="supplyMitigation" name="supplyMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4" style="visibility: hidden">
                                <div class="col-md-4">
                                    <label for="threatMitigation">Threat: <span id="threatMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="threatMitigation" name="threatMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="vulnerabilityMitigation">Vulnerability: <span id="vulnerabilityMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="vulnerabilityMitigation" name="vulnerabilityMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <script>
                            document.addEventListener('DOMContentLoaded', (event) => {
                              // This function updates the span displaying the value of the slider
                              function updateSliderValue(slider) {
                                const valueDisplayId = slider.id + 'Value';
                                const valueDisplay = document.getElementById(valueDisplayId);
                                if (valueDisplay) {
                                  valueDisplay.textContent = slider.value + '%'; // Add the '%' symbol
                                } else {
                                  // console.error('No element found with id:', valueDisplayId);
                                }
                              }

                              // Get all range inputs on the form
                              const sliders = document.querySelectorAll('input[type="range"]');

                              // Initialize the display values and add event listeners to each slider
                              sliders.forEach(slider => {
                                updateSliderValue(slider); // Initialize the display value
                                slider.addEventListener('input', () => updateSliderValue(slider));
                              });
                            });

                            </script>
                        </div>

                    </div>
                </div>


</body>
</html>
