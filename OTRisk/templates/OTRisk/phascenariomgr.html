{% load static %}
<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>

<title>AnzenOT - GRC for OT</title>
<link rel="stylesheet" type="text/css" href="{%  static 'css/phascenariomgr.css' %}">

<link rel="icon" href="{% static 'images/AnzenOTIconBlack.png' %}" type="image/x-icon">
<script src="https://d3js.org/d3.v6.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Load jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-bundle.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-circular-gauge.min.js" type="text/javascript"></script>
<script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-linear-gauge.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/> <!-- FontAwesome CDN -->

<script src="{% static 'OTRisk/assesscyberpha.js' %}"></script>
{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

<script>

     function getSeverityLabel(value) {
        switch (parseInt(value)) {
          case 1:
            case 2:
            return "Low";
          case 3:
            case 4:
            return "Low/Medium";
          case 5:
            case 6:
            return "Medium";
          case 7:
            case 8:
            return "Medium/High";
          case 9:
            case 10:
            return "High";
          default:
            return "";
        }
      }
    function initSlider(sliderId, outputId) {
        var slider = document.getElementById(sliderId);
        var output = document.getElementById(outputId);

        // Display the default slider value
        output.innerHTML = getSeverityLabel(slider.value);

        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
          output.innerHTML = getSeverityLabel(this.value);

        };
      }
// Initialize sliders when the page loads
window.onload = function() {
initSlider("range_safety", "safetyrange");
initSlider("range_life", "liferange");
initSlider("range_production", "productionrange");
initSlider("range_finance", "financerange");
initSlider("range_reputation", "reputationrange");
initSlider("range_environment", "environmentrange");
initSlider("range_regulatory", "regulatoryrange");
initSlider("range_data", "datarange");
initSlider("range_supply", "supplyrange");
initSlider('range_uel','uel_range');
initSlider('rru_range','range_rru');
initSlider('SMrange','range_SM');
initSlider('MELrange','range_MEL');
initSlider('RRMrange','range_RRM');

initSlider('uel_threat','threatLabel');
initSlider('uel_vuln','vulnerabilityLabel');
initSlider('uel_exposure','exposureLabel');

sessionStorage.setItem('attackTreeDrawn', 'false');
sessionStorage.setItem("ls", "0");
};

$(function () {
  $('[data-bs-toggle="tooltip"]').tooltip()
})
</script>
<style>
    .form-group {
    border: 1px solid #464748; /* Border color */
    box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* Outer shadow */
    background-color: #5E6266; /* Lighter shade of #464748 */
    padding: 15px; /* Optional: for internal spacing */
}
.navbar {
    background-color: #464748;
    border-bottom: 1px solid #000;
    height: 50px; /* Fixed height */
    position: relative;
}

.owl-logo {
    height: 60px; /* Set a fixed height for the image */
    width: auto; /* Maintain aspect ratio */
    position: relative;
    top: 50%; /* Center vertically in the navbar */
    transform: translateY(-30%); /* Adjust vertical position */
    margin-bottom: -20px; /* Negative margin to overlap */
}

.navbar-brand, .nav-link {
    color: #d3d1cd !important; /* White text for clear visibility on initial view */
}

.menu-item {
    border-right: 1px solid #4B6B6B; /* Subtle line between items */
    font-size: 14px; /* Adjust font size */
}

.menu-item:last-child {
    border-right: none; /* Remove border for the last item */
}

.menu-item:hover, .dropdown-item:hover {
    background-color: #3A5F5F; /* Slightly lighter grey on hover */
    color: #E0E0E0; /* Light grey text on hover */
}

.nav-link:hover, .dropdown-item {
    color: #E0E0E0; /* Light grey text on hover */
}

.dropdown-menu {
    background-color: #464748; /* Dark Slate Grey */
    border: none;
}

.dropdown-item {
    color: #FFFFFF; /* White text for clear visibility */
}

.dropdown-item:hover {
    background-color: #3A5F5F; /* Slightly lighter grey on hover */
    color: #E0E0E0;
}
</style>
</head>
<body style="background-color: #464748">
<script>
    anychart.licenseKey("iotarisk.com-f1ad231c-886c1b88");
</script>

<nav class="navbar navbar-expand-lg navbar-scroll shadow-0 border-bottom rounded">
    <div class="container-fluid d-flex justify-content-between">
        <a class="navbar-brand" href="{% url 'OTRisk:dashboardhome' %}">
            &nbsp; &nbsp; &nbsp; &nbsp;
            <img src="{% static 'images/anzen_owl.png' %}" class="owl-logo" style="width: 18%; height: 18%">
        </a>
        <h6 class="my-auto text-center flex-grow-1 navbar-brand"><img src="{% static 'images/anzen_noowl.png' %}" style="width: 15%; height: 15%" alt=""> Scenario Manager</h6>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:qraw' %}"><i class="bi bi-calculator"></i> QRAW</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:iotaphamanager' %}"><i class="bi bi-journal-text"></i> CyberPHA</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:scenario_sim' %}"><i class="bi bi-bricks"></i> Scenario Builder</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:ra_actions_view_default' %}"><i class="bi-file-earmark-easel"></i> Actions</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:risk_register' %}"><i class="bi-file-earmark-easel"></i> Risk Register</a>
                </li>
                <li class="nav-item menu-item">
                    <a class="nav-link" href="{% url 'OTRisk:list_frameworks' %}"><i class="bi-file-earmark-easel"></i> Assessments</a>
                </li>
    <li class="nav-item dropdown menu-item">
    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <i class="bi bi-diagram-3"></i> Admin
    </a>
    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
    <li><a class="dropdown-item" href="{% url 'OTRisk:admin_users' %}">Admin Users</a></li>
    {% if user.is_staff %}
    <li><a class="dropdown-item" href="{% url 'OTRisk:user_admin' %}">User Administration</a></li>
    <li><a class="dropdown-item" href="{% url 'OTRisk:execute_sql' %}">Execute SQL</a></li>
    {% endif %}
    </ul>
    </li>
    <li class="nav-item menu-item">
    <a class="nav-link" href="{% url 'accounts:profile' %}">
    <i class="bi bi-person-fill"></i> {{ user.first_name }} {{ user.last_name }} | {{ user.userprofile.organization.name }}
    </a>
    </li>
    <li class="nav-item menu-item">
    <a class="nav-link" href="{% url 'logout' %}">
    <i class="bi bi-box-arrow-right"></i> Logout
    </a>
    </li>
    </ul>
    </div>
    </div>
    </nav>

<form id="cyberpha-form">
{% csrf_token %}
<div id="notificationMessage" class="notification-message" style="display: none;"></div>
<div class="row" style="height: 10px; padding-top: 20px;">
    <div class="col-md-1" ></div>
    <div class="col-md-10 " ></div>
    <div class="col-md-1 " ></div>
</div>


<div class="row" style="background-color: #464748">
    <div class="col-md-1" ></div>
    <div class="col-md-10 sticky-top-container" style="background-color: #464748">
    <figure class="text-center">

    <h5>
    <a href="#" id="cyberPHALink" style="color:white">CyberPHA Scenario Analysis - <span id="facilityName"></span></a>
    </h5>

    <script>
        $(document).ready(function() {
        // Get the activeCyberPHA value from the session storage
        let activeCyberPHA = sessionStorage.getItem('activeCyberPHA');

        if (activeCyberPHA) {
            let linkUrl = `/OTRisk/iotaphamanager/${activeCyberPHA}/`;  // Modify the URL path as needed
            $('#cyberPHALink').attr('href', linkUrl);
        } else {
            window.location.href = "{% url 'OTRisk:iotaphamanager' %}";
        }
    });

    </script>
    <h6>Risk weightings set to <span id="facilityName2" class="text-decoration-underline text-body-emphasis" data-bs-toggle="tooltip" data-bs-placement="top" title="If the incorrect industry is displayed, return to the 'CyberPHA Manager' screen and select the 'Edit' button for this assessment from the table. Select the correct industry in the Assessment Setup form and save the record before re-selecting it to return to this screen"></span> industry</h6>
        <h6> <span id="user_role" class="text-decoration-underline text-body-emphasis"></span></h6>
    </figure>
    <script>

        document.getElementById('facilityName').textContent = sessionStorage.getItem('sessionFacility');
        document.getElementById('facilityName2').textContent = sessionStorage.getItem('sessionIndustry');


     </script>
    </div>
    <div class="col-md-1" ></div>
</div>


<div class="row" style="height: 300px">
    <div class="col-md-1" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
    </div>
    <div class="col-md-10" style="background-color: #464748">
        <div class="form-group" style="background-color: #464748">
            <div class="row" style="background-color: #464748">
            <div class="col-md-12 " style="padding: 20px; background-color: #464748">
                <div class="table-wrap rounded-3" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5); height: 250px">
                    <table id="userscenarioList" class="table table-hover table-bordered small small-font overflow-auto compact" >
                        <thead>
                            <tr>
                                <th rowspan="2" >ID</th>
                                <th rowspan="2" style="width: 40%">Scenario</th>
                                <th colspan="9">Impact Assessment Scores (Max = 10)</th>
                                <th rowspan="2">Threat</th>
                                <th rowspan="2">Risk</th>
                                <th rowspan="2"></th>
                            </tr>
                            <tr>
                                <th>Sfty</th>
                                <th>Dgr</th>
                                <th>Env</th>
                                <th>Sup</th>
                                <th>Fin</th>
                                <th>Ops</th>
                                <th>Data</th>
                                <th>Regs</th>
                                <th>Rep</th>
                            </tr>
                        </thead>

                        <tbody id="userscenarioListBody" style="font-size: 10px">
                          {% for saved_scenarios in saved_scenarios %}
                          <tr onclick="fillScenario({{ saved_scenarios.ID}}); highlightRow(this);">
                            <td>{{ saved_scenarios.ID }}</td>
                            <td>{{ saved_scenarios.Scenario }}</td>
                            <td>
                                {% if saved_scenarios.impactSafety < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactSafety >= 4 and saved_scenarios.impactSafety < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactSafety >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactSafety }}
                            </td>

                            <td>
                                {% if saved_scenarios.impactDanger < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactDanger  >= 4 and saved_scenarios.impactDanger  < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactDanger  >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactDanger  }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactEnvironment < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactEnvironment  >= 4 and saved_scenarios.impactEnvironment  < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactEnvironment  >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactEnvironment  }}
                            </td>
                          <td>
                              {% if saved_scenarios.impactSupply < 4 %}
                                  <span class="green-circle"></span>
                              {% elif saved_scenarios.impactSupply >= 4 and saved_scenarios.impactSupply < 8 %}
                                  <span class="orange-circle"></span>
                              {% elif saved_scenarios.impactSupply >= 8 %}
                                  <span class="red-circle"></span>
                              {% endif %}
                              {{ saved_scenarios.impactSupply }}
                          </td>

                            <td>
                                {% if saved_scenarios.impactFinance < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactFinance >= 4 and saved_scenarios.impactFinance < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactFinance >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactFinance }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactProduction < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactProduction >= 4 and saved_scenarios.impactProduction < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactProduction >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactProduction }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactData < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactData >= 4 and saved_scenarios.impactData < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactData >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactData }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactRegulation < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactRegulation >= 4 and saved_scenarios.impactRegulation < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactRegulation >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactRegulation }}
                            </td>
                            <td>
                                {% if saved_scenarios.impactReputation < 4 %}
                                    <span class="green-circle"></span>
                                {% elif saved_scenarios.impactReputation >= 4 and saved_scenarios.impactReputation < 8 %}
                                    <span class="orange-circle"></span>
                                {% elif saved_scenarios.impactReputation >= 8 %}
                                    <span class="red-circle"></span>
                                {% endif %}
                                {{ saved_scenarios.impactReputation }}
                            </td>


                            <td>{{ saved_scenarios.ThreatClass }}</td>
                            <td>{{ saved_scenarios.RiskCategory }}</td>
                            <td>
                                <a href="{% url 'OTRisk:deletescenario' saved_scenarios.ID saved_scenarios.CyberPHA.ID %}"
                                   class="btn btn-danger"
                                   onclick="return checkDeleteCondition();">Del</a>

                                <script>
                                    function checkDeleteCondition() {
                                        var lsValue = sessionStorage.getItem("ls");
                                        if (lsValue === "1") {
                                            swal("iOTa Scenario Manager", "Changes cannot be made to this scenario because it has been added to the risk register");
                                            return false; // Prevent the default action (i.e., following the link)
                                        }
                                        return confirm('Are you sure you want to delete this record? (Note that if you proceed, the record will be virtually deleted and can be recovered if necessary)');
                                    }
                                </script>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    <script>
                        // Function to handle row click and highlighting
                        function highlightRow(row) {
                            // Remove highlighting from any previously clicked row
                            $("#userscenarioListBody tr").removeClass('highlighted');
                            // Add highlighting to the current clicked row
                            $(row).addClass('highlighted');
                        }

                            // Function to load the vulnerability table component
                            function loadVulnerabilityTable(scenarioId) {
                                // Load the vulnerability table into the specified div container
                                $('#vulnerabilityTableContainer').load('/OTRisk/scenario_vulnerability/' + scenarioId + '/', function () {
                                    // Initialize select2 for the asset_type field
                                    $('.select2').select2();

                                    // Handle form submission asynchronously (if needed)
                                    $('#vulnerability-form').on('submit', function (e) {
                                        e.preventDefault();
                                        $.ajax({
                                            type: 'POST',
                                            url: $(this).attr('action'),
                                            data: $(this).serialize(),
                                            success: function () {
                                                // Refresh the table
                                                loadVulnerabilityTable(scenarioId);
                                            },
                                        });
                                    });
                                });
                            }
                    </script>
                 </div>
            </div>
            </div>
        </div>
    </div>
    <div class="col-md-1" ></div>
</div> <!-- list of user entered scenarios -->
<br><br>


<!-- put the buttons in here -->
<div class="row small-font" >
    <div class="col-md-2"></div>
    <div class="col-md-8">
        <div class="form-group">
            <div class="row">
            <div class="col-md-3" > <button type="button" id="addScenarioBtn" class="form-control" onclick="resetformcontrols()" ><i class="bi bi-folder-plus"></i> New Scenario</button></div>
            <div class="col-md-3" ><button type="button" class="form-control" data-bs-toggle="modal"  onclick="processFormData()"><i class="bi bi-box-arrow-down"></i> Save Scenario</button></div>
            <div class="col-md-3" >
                <button class="form-control" type="button" id="actionBtn" onclick="showRAActionsModal()" ><i class="bi bi-person-plus"></i> Add Action</button>

                <script>
                    function showRAActionsModal() {
                        var phaid = sessionStorage.getItem('activeCyberPHA');  // Get the value from session storage

                        if (phaid === null || phaid === "") {
                            alert("Please select a CyberPHA assessment from the table first before creating an action item.");
                        } else {
                            $('#RAActionsModal').modal('show');  // Show the modal if rawid has a value
                        }
                    }
                </script>
            </div>

            <div class="col-md-3" ><button type="button" class="form-control" data-bs-toggle="modal"  data-bs-target="#scenarioSelectModal"><i class="bi bi-box-arrow-down"></i> Load Scenario</button></div>
            </div>
        </div>
    </div>
    <div class="col-md-2" ></div>
</div>

<br>

<div class="row small-font">
    <div class="col-md-1" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">

    </div>

    <div class="col-md-10">
        <div class="row">
        </div>
        <div class="form-group">
        <div class ="row" style="border: 1px solid #000000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px; background-color: lightgrey">
            <div class="col-md-1 d-flex justify-content-center align-items-center"></div>
            <div class="col-md-3">
                <label for="txtScenario"><h6>Scenario</h6></label>
                <!-- <textarea id="txtScenario" name="txtScenario" class="form-control" rows="6" placeholder="Select a scenario from the table or enter your own...." style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white" spellcheck="true"></textarea> -->
                <div class="form-group">
                    <!-- Render the textarea without the label -->
                    {{ scenario_form.txtScenario }}
                    {% if scenario_form.txtScenario.errors %}
                        <!-- Custom error handling or styling can be done here -->
                    {% endif %}
                </div>
                <!-- Dynamic Suggestions -->
                <div id="suggestions"></div>
                <div id="educational-resources">
                    <a href="#" id="link-to-resource">Cybersecurity Scenario Guidelines</a>
                </div>
                <script>

                    // Ensure DOM is fully loaded before executing the script
                    document.addEventListener('DOMContentLoaded', function() {
                        var txtScenarioElement = document.getElementById('id_txtScenario');
                        if (txtScenarioElement) {
                            txtScenarioElement.addEventListener('input', function() {
                                provideSuggestions(this.value);
                            });
                        }

                        function provideSuggestions(inputText) {
                            var lowerCaseInputText = inputText.toLowerCase(); // Convert input text to lower case
                            var suggestionsDiv = document.getElementById('suggestions');
                            suggestionsDiv.innerHTML = ""; // Clear current suggestions

                            // Function to add suggestion messages
                            function addSuggestion(message) {
                                suggestionsDiv.innerHTML += "<p>" + message + "</p>";
                            }

                            // Check for various keywords and add suggestions
                            if (lowerCaseInputText.includes("malware")) {
                                addSuggestion("Consider describing the type of malware and its impact on the device.");
                            }
                            if (lowerCaseInputText.includes("plc")) {
                                addSuggestion("Include the vendor and name of the PLC if known.");
                            }
                            if (lowerCaseInputText.includes("erp")) {
                                addSuggestion("Include the name and version of the ERP system.");
                            }
                            if (lowerCaseInputText.includes("scada")) {
                                addSuggestion("Include the name and version of the SCADA system if known.");
                            }
                            if (lowerCaseInputText.includes("temperature")) {
                                addSuggestion("Include relevant temperature ranges or tolerances.");
                            }
                            if (lowerCaseInputText.includes("pressure")) {
                                addSuggestion("Include relevant pressure tolerances and ranges.");
                            }
                            if (lowerCaseInputText.includes("software")) {
                                addSuggestion("Include name and version of software if known.");
                            }
                            if (lowerCaseInputText.includes("windows")) {
                                addSuggestion("Include the version of Windows.");
                            }
                            if (lowerCaseInputText.includes("unix")) {
                                addSuggestion("Include the version of Unix.");
                            }
                            if (lowerCaseInputText.includes("sensor")) {
                                addSuggestion("Include the type of sensor and the parameters that it monitors.");
                            }
                            if (lowerCaseInputText.includes("protocol")) {
                                addSuggestion("Include information aboput the protocol used and the endpoints that are connected.");
                            }
                        }


                    });

                </script>
            </div>
            <div class="col-md-1 d-flex justify-content-center align-items-center">
                <button id="analyzeScenarioBtn" class="btn btn-primary" type="button">Get consequence/s >>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;" id="loadingSpinner2"></span>
                </button>
                <script>
                function drawAttackTree(data) {
    var container = document.getElementById('attack_tree');
    var containerWidth = container.clientWidth;
    var svgWidth = containerWidth * 0.8;
    var margin = { top: 20, right: 120, bottom: 20, left: 280 };
    var width = svgWidth - margin.left - margin.right;
    var height = 800; // Increased height for better resolution

    d3.select(container).selectAll("svg").remove();

    var svg = d3.select(container).append("svg")
        .attr("width", "100%")
        .attr("viewBox", "0 0 " + svgWidth + " " + height)
        .attr("height", height)
        .style("display", "block")
        .style("margin", "auto")
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Define the arrow marker
    svg.append("svg:defs").selectAll("marker")
        .data(["end"])
        .enter().append("svg:marker")
        .attr("id", String)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 25)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");

    var i = 0,
        duration = 750,
        root;

    var treemap = d3.tree()
        .size([height, width - margin.left - margin.right])
        .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2); });

    root = d3.hierarchy(data, function(d) { return d.children; });
    root.x0 = height / 2;
    root.y0 = 0;

    // Color-blind-friendly color scale
    var colorScale = d3.scaleOrdinal(["#88CCEE", "#DDCC77", "#CC6677", "#882255", "#44AA99", "#117733", "#999933", "#AA4499"]);

    update(root);

    function update(source) {
        var treeData = treemap(root);

        var nodes = treeData.descendants(),
            links = treeData.descendants().slice(1);

        nodes.forEach(function(d) { d.y = d.depth * 180 });

        var node = svg.selectAll('g.node')
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeEnter.append('circle')
            .attr('r', 10)
            .style("stroke", "black")
            .style("stroke-width", 1.5)
            .style("fill", function(d) { return colorScale(d.depth); });

        nodeEnter.append('text')
            .style("fill", "darkgray")
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .attr("transform", "rotate(-10)")
            .attr("dy", ".35em")
            .attr("x", function(d) { return d.children ? -13 - this.getComputedTextLength() : 13; })
            .attr("text-anchor", function(d) { return d.children ? "end" : "start"; })
            .text(function(d) { return d.data.name; });

        var link = svg.selectAll('path.link')
            .data(links, function(d) { return d.id; });

        link.enter().insert('path', "g")
            .attr("class", "link")
            .style("stroke", function(d) { return colorScale(d.depth); })
            .style("stroke-width", 2)
            .style("fill", "none")
            .attr("marker-end", "url(#end)") // Add the arrow marker
            .attr('d', function(d) {
                return "M" + d.y + "," + d.x
                    + "C" + (d.y + d.parent.y) / 2 + "," + d.x
                    + " " + (d.y + d.parent.y) / 2 + "," + d.parent.x
                    + " " + d.parent.y + "," + d.parent.x;
            });
    }

    // Add border and shadow to the container
    var attackTreeDiv = document.getElementById('attack_tree');
    attackTreeDiv.style.display = 'block';
    attackTreeDiv.style.border = '1px solid #ccc';
    attackTreeDiv.style.boxShadow = '0px 0px 10px rgba(0, 0, 0, 0.5)';
    sessionStorage.setItem('attackTreeDrawn', 'true');

    sessionStorage.setItem('attackTreeDrawn', 'true');
    var attackTreeDiv = document.getElementById('attack_tree')
    attackTreeDiv.style.display = 'none';

    document.getElementById('viewAttackTreeBtn').style.display = 'block';
    // Add export button functionality (if feasible)
    var exportButton = document.getElementById('exportButton');
    if (exportButton) {
        exportButton.addEventListener('click', function() {
            var svgData = new XMLSerializer().serializeToString(document.querySelector('svg'));
            var svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
            var svgUrl = URL.createObjectURL(svgBlob);
            var downloadLink = document.createElement("a");
            downloadLink.href = svgUrl;
            downloadLink.download = "attack_tree.svg";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });
    }
}


                document.getElementById('analyzeScenarioBtn').addEventListener('click', function() {
                var scenarioText = document.getElementById('id_txtScenario').value;
                var phaID = document.getElementById('hdnphaID').value;
                var attackTreeDrawn = sessionStorage.getItem('attackTreeDrawn');
                var button = this;
                var spinner = document.getElementById('loadingSpinner2');
                spinner.style.display = 'inline-block';
                button.disabled = true;

                $.ajax({
                    url: "{% url 'OTRisk:analyze_scenario' %}",
                    type: 'POST',
                    data: {
                        'scenario': scenarioText,
                        'phaID': phaID,
                        'attackTreeDrawn': attackTreeDrawn, // this variable is set to indicate that an attack tree is already drawn for this scenario so another one wont be processed
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        spinner.style.display = 'none';
                        button.disabled = false;

                        var tableBody = document.getElementById('consequenceTable').getElementsByTagName('tbody')[0];
                        tableBody.innerHTML = ''; // Clear existing rows

                        response.consequence.forEach(function(item, index) {
                            var row = tableBody.insertRow();
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);

                            cell1.innerHTML = item;
                            cell2.innerHTML = '<input type="checkbox" id="validate' + index + '">';
                        });

                        if (sessionStorage.getItem('attackTreeDrawn') === 'false') {
                            document.getElementById('attack_tree_text').value = JSON.stringify(response.attack_tree);

                            drawAttackTree(response.attack_tree);
                        }


                    },
                    error: function(xhr, status, error) {
                        spinner.style.display = 'none';
                        button.disabled = false;

                        // Parse the responseText to JSON if it is in JSON format
                        var response = xhr.responseText;
                        try {
                            var jsonResponse = JSON.parse(response);
                            if (jsonResponse.error) {
                                alert('Error: ' + jsonResponse.error);
                            } else {
                                alert('An error occurred: ' + response);
                            }
                        } catch(e) {
                            // If responseText is not JSON, display it directly
                            alert('An error occurred: ' + response);
                        }
                    }
                });
            });
        </script>
            </div>
            <div class="col-md-3 border-right">
                <label for="consequenceTable"><h6>Consequences</h6></label>
                <div class="form-group" style="padding: 20px; background-color: white; border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);">
                <table id="consequenceTable" class="table">
                    <thead>
                        <tr>
                            <th>Consequence</th>
                            <th>Validate</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be added here dynamically -->
                    </tbody>
                </table>

                </div>
            </div>

            <div class="col-md-3" style="margin-left: 50px">
                <label class="form-label" for="threat-intelligence"><h6>Threat Source</h6></label>
                <select class="form-control small-font" name="threat-intelligence" id="threat-intelligence" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 5px; background-color: white">
                    <option value="">-- Select a threat source --</option>
                    {% for threat_intelligence in threat_intelligence %}
                        <option value="{{ threat_intelligence.ThreatDescription }}">{{ threat_intelligence.ThreatDescription }}</option>
                    {% endfor %}
                </select>
                <br>
                <label class="form-label" for="risk-category"><h6>Risk Category</h6></label>
                <select class="form-control small-font" name="risk-category" id="risk-category" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding:5px; background-color: white">
                  <option value="">Select a risk category</option>
                  {% for risk_category in risk_categories %}
                    <option value="{{ risk_category.CategoryName }}">{{ risk_category.CategoryName }}</option>
                  {% endfor %}
                </select>
                <br>
                <div class="form-group">
                    <label class="switch-label"><h6>Internet Exposed IP Address</h6></label>
                    <label class="switch">
                    <input type="checkbox" id="exposed_system" name="exposed_system">
                    <span class="slider1 round"></span>
                    </label>
                    <br>
                    <label class="switch-label"><h6>Default/Weak Credentials</h6></label>
                    <label class="switch">
                    <input type="checkbox" id="weak_credentials" name="weak_credentials">
                    <span class="slider1 round"></span>
                    </label>
                </div>
            </div>
            <div class="col-md-1 d-flex justify-content-center align-items-center"></div>
            <div class="col-md-1" style="background-color: white"></div>
        </div> <!-- scenario list table -->
        </div>
        <div class="form-group">
            <div class="row">
            <div class="col-md-12 justify-content-center align-items-center">
                <!-- Button to View Attack Tree -->
                <div class="row">
                    <div class="col-md-2">
                    <button id="viewAttackTreeBtn" type="button" class="btn btn-link-like" style="display: none">View Attack Tree</button>
                    </div>
                    <div class="col-md-2">
                    <button id="closeAttackTreeBtn" type="button" class="btn btn-link-like" style="display: none;">Close Attack Tree</button>
                    </div>
                    <div class="col-md-8"></div>
                </div>

                <div id="attack_tree" style="width:100%"></div>

                <button id="exportAttackTreeBtn" type="button" class="btn btn-primary" style="display: none">Export as Image</button>
                    <script>
                    // Existing drawAttackTree function
                    // ...

                    // Function to toggle attack tree visibility
                    function toggleAttackTree() {
                        var attackTreeDiv = document.getElementById('attack_tree');
                        var viewBtn = document.getElementById('viewAttackTreeBtn');
                        var closeBtn = document.getElementById('closeAttackTreeBtn');
                        var printBtn = document.getElementById('exportAttackTreeBtn');

                        if (attackTreeDiv.style.display === 'none') {
                            attackTreeDiv.style.display = 'block';
                            viewBtn.style.display = 'none';
                            closeBtn.style.display = 'inline-block';
                            printBtn.style.display = 'inline-block';
                        } else {
                            attackTreeDiv.style.display = 'none';
                            viewBtn.style.display = 'inline-block';
                            closeBtn.style.display = 'none';
                            printBtn.style.display = 'none';
                        }
                    }

                    // Event listeners for the buttons
                    document.getElementById('viewAttackTreeBtn').addEventListener('click', toggleAttackTree);
                    document.getElementById('closeAttackTreeBtn').addEventListener('click', toggleAttackTree);
                    document.getElementById('exportAttackTreeBtn').addEventListener('click', exportAsImage); // Attach export function

                    function exportAsImage() {
                        // converts the attack tree to a png file
                        // Create a new canvas element
                        var canvas = document.createElement("canvas");
                        var context = canvas.getContext("2d");

                        // Get the SVG element and its dimensions
                        var svg = document.querySelector("svg");
                        var svgSize = svg.getBoundingClientRect();
                        canvas.width = svgSize.width;
                        canvas.height = svgSize.height;

                        // Convert SVG to a data URL
                        var img = new Image();
                        var serializer = new XMLSerializer();
                        var svgStr = serializer.serializeToString(svg);
                        img.src = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svgStr)));

                        img.onload = function() {
                            // Draw the image onto the canvas
                            context.fillStyle = "#ffffff";  // Set fill style to white color
                            context.fillRect(0, 0, canvas.width, canvas.height);  // Fill the canvas with white

                            context.drawImage(img, 0, 0);

                            // Convert canvas to an image and download it
                            var dataURL = canvas.toDataURL("image/png");
                            var link = document.createElement("a");
                            link.download = "attack-tree.png";
                            link.href = dataURL;
                            link.click();
                        };
                    }
                </script>

        </div>

        <input type="hidden" id="hdnID" name="hdnID" >
        <input type="hidden" id="hdnScenario" name="hdnScenario" value = {{ scenarioID }}>
        <input type="hidden" id="hdnCountry" name="hdnCountry">
        <textarea id="attack_tree_text" name="attack_tree_text" style="visibility: hidden"></textarea>
        <script>

            document.getElementById('hdnCountry').value = sessionStorage.getItem('sessionCountry');

        </script>

    </div>
        </div>
</div>



<div class="row" id="toggleRow">

     <button type="button" id="toggleButton" class="btn btn-link">
            <img src="{% static 'images/close.png' %}" id="toggleIcon" style="height:50px">
        </button>


    <div class="col-md-1" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">

    </div>
    <div class="col-md-5">
        <div class="form-group">
            <div class="row">
                <div class="col-md-12" >
        <p></p>
        <h5 style="display: inline; color: white">Impact Analysis</h5> <span style="color:white">(click labels to add descriptions)</span>
        <br>
         <!--slider for safety rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2">
                        <label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#safetyModal" data-modal-id="safetyModal" data-textarea-id="txtsafetyJustify"><img src="{% static 'images/safety.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Safety</label><span id="textIndicator" style="display: none;" spellcheck="true"><i class="bi bi-journal-text"></i></span>
                    </div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_safety" name="range_safety" onchange="initSlider('range_safety', 'safetyrange');">
                    </div>
                    <div class="col-3"><label id="safetyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></div>
                </div>
            </div>
        </div>
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <!--slider for Life rating -->
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#lifeModal" data-bs-placement="top" data-modal-id="lifeModal" data-textarea-id="txtlifeJustify"><img src="{% static 'images/danger.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Life</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_life" name="range_life" onchange="initSlider('range_life', 'liferange');">
                    </div>
                    <div class="col-3"><h6><label id="liferange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Production impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label for="range_production" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#productionModal" data-bs-placement="top" data-modal-id="productionModal" data-textarea-id="txtproductionJustify"><img src="{% static 'images/production.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Production</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_production" name="range_production" onchange="initSlider('range_production', 'productionrange');">
                    </div>
                    <div class="col-3"><h6><label id="productionrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                 <!--slider for financial rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#financeModal" data-bs-placement="top" data-modal-id="financeModal" data-textarea-id="txtfinanceJustify"><img src="{% static 'images/finance.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Financial</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_finance" name="range_finance" onchange="initSlider('range_finance', 'financerange');">
                    </div>
                    <div class="col-3"><h6><label id="financerange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for reputation rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#reputationModal" data-bs-placement="top" data-modal-id="reputationModal" data-textarea-id="txtreputationJustify"><img src="{% static 'images/reputation.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Reputation</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_reputation" name="range_reputation" onchange="initSlider('range_reputation', 'reputationrange');">
                    </div>
                    <div class="col-3"><h6><label id="reputationrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for environment impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#environmentModal" data-bs-placement="top" data-modal-id="environmentModal" data-textarea-id="txtenvironmentJustify"><img src="{% static 'images/environment.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Environment</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_environment" name="range_environment" onchange="initSlider('range_environment', 'environmentrange');">
                    </div>
                    <div class="col-3"><h6><label id="environmentrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for regulatory impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#regulatoryModal" data-bs-placement="top" data-modal-id="regulatoryModal" data-textarea-id="txtregulatoryJustify"><img src="{% static 'images/regulation.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Regulatory</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_regulatory" name="range_regulatory" onchange="initSlider('range_regulatory', 'regulatoryrange');">
                    </div>
                    <div class="col-3"><h6><label id="regulatoryrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for data impact rating -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label for="range_data" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#dataModal" data-bs-placement="top" data-modal-id="dataModal" data-textarea-id="txtdataJustify"><img src="{% static 'images/data.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;"> &nbsp;Data/IP</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_data" name="range_data" onchange="initSlider('range_data', 'datarange');">
                    </div>
                    <div class="col-3"><h6><label id="datarange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label for="range_supply" class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#supplyModal" data-bs-placement="top" data-modal-id="supplyModal" data-textarea-id="txtsupplyJustify"><img src="{% static 'images/supply.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp; Supply Chain</label><span id="textIndicator" style="display: none;"><i class="bi bi-journal-text"></i></span></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="range_supply" name="range_supply" onchange="initSlider('range_supply', 'supplyrange');">
                    </div>
                    <div class="col-3"><h6><label id="supplyrange" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
       <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
        <div class="card-body">
            <div id="scenarioStatus">
                <label for="scenarioStatusSelect" class="form-label">Scenario Status</label>
                <select class="form-select" id="scenarioStatusSelect" name="scenario_status">
                    <option value="0">---Select Scenario Status---</option>
                    {% for status, status_display in scenario_status %}
                    <option value="{{ status }}">{{ status_display }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
        <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title" >Physical Safeguards</h5>
                        <div id="tablePhysicalControls" class="mb-2">
                            <button id="addRowBtn" class="btn btn-primary btn-sm" type="button">Add Row</button>
                        </div>
                        <table class="table table-bordered small-font" id="table_safeguards">
                            <thead>
                                <tr>
                                    <th>Safeguard</th>
                                    <th>Safeguard Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be added here dynamically -->
                            </tbody>
                        </table>
                        <script>
                            $(document).ready(function() {
                                $("#addRowBtn").click(function() {
                                    var newRow = `<tr>
                                        <td><textarea class="form-control" maxlength="100"></textarea></td>
                                        <td><textarea class="form-control" maxlength="100"></textarea></td>
                                        <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
                                    </tr>`;
                                    $("#table_safeguards tbody").append(newRow);
                                });

                                // Event delegation to handle dynamically added elements
                                $("#table_safeguards").on("click", ".deleteRowBtn", function() {
                                    $(this).closest("tr").remove();
                                });
                            });
                            </script>

                    </div>
                </div>

    </div>
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="form-group">
            <div class="row">

            <div class="col-md-12 risk-assessment-container"  >
    <p></p>
         <div class="risk-section unmitigated-risk">
        <h5>Assessment - Unmitigated Risk</h5>
        <h6>(Risk exposure without current controls)</h6>
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-3">
                        <label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#uelModal" data-bs-placement="top" ><img src="{% static 'images/uel.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp;&nbsp;Unmitigated Event Likelihood (UEL)</label></div>
                    <div class="col-6">
                      <input type="range" min="1" max="10" value="1" class="slider" id="uel_range" name="uel_range" onchange="initSlider('uel_range','range_uel');">
                    </div>
                    <div class="col-3"><h6><label id="range_uel" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for MEL - Mitigated Exposure Level-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-3">
                        <label class="small-font d-flex align-items-center clickable-label" data-bs-toggle="modal" data-bs-target="#rruModal" data-bs-placement="top" ><img src="{% static 'images/rru.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp;&nbsp;Residual Risk Unmitigated (RRu)</label>
                    </div>
                    <div class="col-6">
                      <input type="range" min="1" max="10" value="1" class="slider" id="rru_range" name="rru_range" onchange="initSlider('rru_range','range_rru');">
                    </div>
                    <div class="col-3"><h6><label id="range_rru" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
         </div>

        <div class="risk-section mitigated-risk">
        <h5>Assessment - Mitigated Risk</h5>
        <h6>(Risk exposure with current controls)</h6>
                <!--slider for UEL - likelihood without controls-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-3"><label class="small-font d-flex align-items-center " ><img src="{% static 'images/sm.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp;&nbsp;Severity Mitigated (Sm)</label></div>
                    <div class="col-6">
                      <input type="range" min="1" max="10" value="1" class="slider_reversed" id="SMrange" name="SMrange" onchange="initSlider('SMrange','range_SM');">
                    </div>
                    <div class="col-3"><h6><label id="range_SM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for MEL - Mitigated Exposure Level-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-3"><label class="small-font d-flex align-items-center " ><img src="{% static 'images/mel.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp;&nbsp;Mitigated Exposure (MEL)</label></div>
                    <div class="col-6">
                      <input type="range" min="1" max="10" value="1" class="slider_reversed" id="MELrange" name="MELrange" onchange="initSlider('MELrange','range_MEL');">
                    </div>
                    <div class="col-3"><h6><label id="range_MEL" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for MEL - Mitigated Exposure Level-->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-3"><label class="small-font d-flex align-items-center " ><img src="{% static 'images/rrm.png' %}" alt="" class="align-bottom" style="max-height: 2rem; margin-left: 5px;">&nbsp;&nbsp;Residual Risk (RRm)</label></div>
                    <div class="col-6">
                      <input type="range" min="1" max="10" value="1" class="slider" id="RRMrange" name="RRMrange" onchange="initSlider('RRMrange','range_RRM');">
                    </div>
                    <div class="col-3"><h6><label id="range_RRM" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
        </div>
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Security Level Achieved (SL-A)</label></div>
                    <div class="col-7">
                        <select class="form-control small-font" name="selSL" id="selSL" style="border: 3px solid #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 5px; background-color: white">
                            <option value=""> -- Select SL-A -- </option>
                            {% for value, description in SECURITY_LEVELS %}
                                <option value="{{ value }}">
                                    {{ description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-3"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                    <div class="card-body">
                        <input type="checkbox" id="risk_register" name="risk_register">
                        <label for="risk_register">Lock Scenario and Add to Risk Register</label>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                <div class="card-body">
                    <input type="checkbox" id="risk_snapshot" name="risk_snapshot">
                    <label for="risk_snapshot">Create Snapshot</label>

                </div>
            </div>
            </div>
        </div>


    </div>
            </div>
        </div>
    </div>

     <div class="col-md-1"></div>
</div>
<br><br>
<div class="row small-font" >
            <div class="col-md-1"></div>
            <div class="col-md-2" ></div>

    <div class="col-md-6">
    <div class="form-group">
        <div class="row">
            <div class="col-md-4" > <button type="button" id="addScenarioBtn" class="form-control" onclick="resetformcontrols()" ><i class="bi bi-folder-plus"></i> New Scenario</button></div>
            <div class="col-md-4" ><button type="button" class="form-control" data-bs-toggle="modal"  onclick="processFormData()"><i class="bi bi-box-arrow-down"></i> Save Scenario</button></div>
            <div class="col-md-4" >
            <button class="form-control" type="button" id="actionBtn" onclick="showRAActionsModal()" ><i class="bi bi-person-plus"></i> Add Action</button>

            <script>
                function showRAActionsModal() {
                    var phaid = sessionStorage.getItem('activeCyberPHA');  // Get the value from session storage

                    if (phaid === null || phaid === "") {
                        alert("Please select a CyberPHA assessment from the table first before creating an action item.");
                    } else {
                        $('#RAActionsModal').modal('show');  // Show the modal if rawid has a value
                    }
                }
            </script>
            </div>
        </div>
    </div>
    </div>
            <div class="col-md-2" ></div>
            <div class="col-md-1"></div>
        </div> <!-- form control buttons -->
<!-- vulnerability assessment table -->
<div class="row" style="visibility: hidden">
    <div class="col-md-1" style="justify-content: center; align-items: center; height: 100%;">
        <div style="text-align: center;">Vulnerabilities</div>
        <div><h2><i class="bi bi-arrow-right"></i></h2></div>
    </div>
    <div class="col-md-10">
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div id="vulnerabilityTableContainer" ></div>
            </div>
        </div>
    </div>
    <div class="col-md-1"></div>
</div>



    <div class="floating-container" id="floatingContainer">
        <div class="controls" >
        <button id="minimizeBtn" type="button">Hide KPIs</button>
        <button id="maximizeBtn" style="display: none;" type="button">Show KPIs</button>
        </div>
        <div class="content" id="content">
        <div class="col-md-12" style="border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px; background-color: darkslategrey">
        <div class="row" style="height:5px"></div>
            <div class="col-md-12" style="padding: 5px; background-color: darkslategrey; display: flex; justify-content: center; align-items: center; color: white; height: 30px;">
                <div>
                    <h6>Scenario KPIs</h6>
                </div>
            </div>
            <div class="row d-flex h-30">
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                        <div class="card-body">
                            <label for="control_effectiveness" class="small-font">Control Effectiveness (%)</label>
                            <div id="gaugeContainer" style="width: 100%; "></div>
                            <input type="hidden" id="hdn_control_effectiveness" name="hdn_control_effectiveness">
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                    <div class="card-body">
                        <label for="txtBIAScore" class="small-font">BIA Score</label>
                            <div id="gaugeBIAContainer" style="width: 100%; "></div>
                        <input type="hidden" id="hdn_bia_score" name="hdn_bia_score">

                    </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                    <div class="card-body">
                        <label for="txtProbability" class="small-font">Estimated Attack Success Probability (%)</label>
                            <div id="gaugeProbContainer" style="width: 100%; "></div>
                    </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                    <div class="card-body">
                        <label for="txtLikelihood" class="small-font">Estimated Risk Likelihood (%)</label>
                            <div id="gaugeLikelihoodContainer" style="width: 100%; "></div>

                            <input type="hidden" id="hdnLikelihood" name="hdnLikelihood">
                    </div>
                    </div>
                </div>
            </div>
            <div class="row d-flex h-30">
                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                        <div class="card-body" >
                            <label for="frequency" class="small-font">Estimated Frequency</label>
                            <div id="gaugeFrequency" style="width: 100%;  margin-top: 0; padding-top: 0"></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-2 col-md-3 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100">
                        <div class="card-body">
                            <label for="txtResidualRisk" class="small-font" style="margin-bottom: 0;">Estimated Residual Risk</label>
                            <div id="gaugeResidualRisk" style="width: 100%; margin-top: 0; padding-top: 0"></div>

                            </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100 elegant-card">
                        <div class="card-body">
                            <label for="txtEventCosts_low" class="label-title">SLE Low</label>
                            <input type="text" id="txtEventCosts_low" name="txtEventCosts_low" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>

                            <label for="txt_ale_low" class="label-title">ALE Low</label>
                            <input type="text" id="txt_ale_low" name="txt_ale_low" class="form-control text-center elegant-input"  style="font-size: 20px; color: #0a53be" readonly>
                        </div>
                    </div>
                </div>


                <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100 elegant-card">
                        <div class="card-body">
                            <label for="txtEventCosts" class="label-title">SLE Medium</label>
                            <input type="text" id="txtEventCosts" name="txtEventCosts" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                            <label for="txt_ale_low" class="label-title">ALE Medium</label>
                            <input type="text" id="txt_ale_median" name="txt_ale_median" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-2 col-sm-4 flex-fill d-flex">
                    <div class="card mb-3 shadow-sm w-100 elegant-card">
                        <div class="card-body">
                            <label for="txtEventCosts_high" class="label-title">SLE High</label>
                            <input type="text" id="txtEventCosts_high" name="txtEventCosts_high" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                            <label for="txt_ale_high" class="label-title">ALE High</label>
                            <input type="text" id="txt_ale_high" name="txt_ale_high" class="form-control text-center elegant-input" style="font-size: 20px; color: #0a53be" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Compliance Mapping</h4>
                </div>
                <div class="card-body">
    <table id="compliance_map" class="table">
        <thead>
            <tr>
                <th style="width: 33%">Compliance Concern</th>
                <th style="width: 33%">Compliance Reference</th>
                <th style="width: 33%">URL</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be added dynamically by JavaScript -->
        </tbody>
    </table>
</div>

            </div>
        </div>
    </div>
</div>
<textarea id="compliance_map" name="compliance_map" rows="1" width="1%" readonly style="resize: none; visibility: hidden"></textarea>
            <div class="row d-flex h-30">
                <div class="col-md-1"></div>
                <div class="col-md-5">
                <button id="risk-assessment-btn" type="button" class="form-control btn-dark" style="background-color: dodgerblue; color: white">
                    Assess Scenario KPIs <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;" id="loadingSpinner"></span></button><br>

                            <script>
                             // AJAX function call on button click
                            $(document).ready(function () {
                                $("#risk-assessment-btn").click(function () {
                                    // Call the function to assess the risk
                                    assessScenario();
                                });
                            });
                            </script>
                </div>
                <div class="col-md-5" >
                <button type="button" class="form-control" data-bs-toggle="modal"  onclick="processFormData()"><i class="bi bi-box-arrow-down"></i> Save Scenario</button>
        </div>
                <div class="col-md-1"></div>
            </div>

        </div>

        </div>
</div>
<input type="text" id="frequency" name="frequency" class="form-control text-center" style="font-size: 20px; color: #0a53be; visibility: hidden"  readonly>
<script>

    document.addEventListener('DOMContentLoaded', (event) => {
    // minimizeFloatingContainer();

});

function minimizeFloatingContainer() {
    var floatingContainer = document.getElementById('floatingContainer');
    var content = document.getElementById('content');
    var minimizeBtn = document.getElementById('minimizeBtn');
    var maximizeBtn = document.getElementById('maximizeBtn');

    // Apply minimized class and adjust width
    floatingContainer.classList.add('minimized');
    floatingContainer.style.width = '20%';

    // Hide content and minimize button, show maximize button
    content.style.display = 'none';
    minimizeBtn.style.display = 'none';
    maximizeBtn.style.display = 'block';
}

document.getElementById('minimizeBtn').addEventListener('click', function() {
    document.getElementById('content').style.display = 'none';
    this.style.display = 'none';
    document.getElementById('maximizeBtn').style.display = 'block';
    floatingContainer.style.width = '20%';
});

document.getElementById('maximizeBtn').addEventListener('click', function() {
    document.getElementById('content').style.display = 'block';
    this.style.display = 'none';
    floatingContainer.style.width = '50%';
    document.getElementById('minimizeBtn').style.display = 'block';
});


makeDraggable(document.getElementById('floatingContainer')); // Assuming makeDraggable is the function for draggable functionality

    function makeDraggable(element) {
    var posX = 0, posY = 0, posInitX = 0, posInitY = 0;

    element.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        // Get the initial mouse cursor position at startup:
        posInitX = e.clientX;
        posInitY = e.clientY;
        document.onmouseup = closeDragElement;
        // Call a function whenever the cursor moves:
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        // Calculate the new cursor position:
        posX = posInitX - e.clientX;
        posY = posInitY - e.clientY;
        posInitX = e.clientX;
        posInitY = e.clientY;
        // Set the element's new position:
        element.style.top = (element.offsetTop - posY) + "px";
        element.style.left = (element.offsetLeft - posX) + "px";
    }

    function closeDragElement() {
        // Stop moving when mouse button is released:
        document.onmouseup = null;
        document.onmousemove = null;
    }
}

// Call this function with your floating container element
makeDraggable(document.getElementById("floatingContainer"));

</script>

    </div>

<div class="row" style="height: 10px">
    <div class="col"></div>
</div>





    <div class="col-md-1 " style="background-color: white"></div>
</div>
   <br>


<label for="txtScenarioAnalysis" class="small-font" style="visibility: hidden">Recommendations will align with selected standards:</label>
<textarea id="txtScenarioAnalysis" name="txtScenarioAnalysis" class="form-control border border-danger small-font" rows="15"  style="resize: none; border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white; visibility: hidden"></textarea>



<div class="row">
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-5" style="background-color: white">
        <div class="row  rounded p-3 ">

        </div>

    </div>
    <div class="col-md-5" style="background-color: white">
        <div class="row  rounded p-3 ">

        </div>

    </div>
     <div class="col-md-1" style="background-color: white"></div>
</div>
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-10 " style="background-color: white; height: 10px"></div>
    <div class="col-md-1 " style="background-color: white"></div>
</div> <!-- white stripe -->
<div class="row" style="height: 10px">
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-10 " style="background-color: darkgray; height: 10px"></div>
    <div class="col-md-1 " style="background-color: white"></div>
</div> <!-- dark grey stripe -->

<div class="row" hidden="hidden">
    <div class="col-md-1" style="background-color: white"></div>
    <div class="col-md-5" style="background-color: white">
        <h5>Adjusted Risk (After Action)</h5>
                <!--slider for Severity level (Sa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Severity Adjusted(Sa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="SArange" name="SArange" onchange="initSlider('SArange','range_SA');">
                    </div>
                    <div class="col-3"><h6><label id="range_SA" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Mitigated Exposure (MELa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Mitigated Exposure (MELa)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="MELarange" name="MELarange" onchange="initSlider('MELarange','range_MELa');">
                    </div>
                    <div class="col-3"><h6><label id="range_MELa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
                <!--slider for Residual Risk (RRa) -->
        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Residual Risk (RRa)</label></div>
                    <div class="col-7"><input type="text" id="txtRRa" name="txtRRa" class="form-control">
                      <!-- <input type="range" min="1" max="10" value="1" class="slider" id="RRarange" name="RRarange" onchange="initSlider('RRarange','range_RRa');"> -->
                    </div>
                    <div class="col-3"><h6><label id="range_RRa" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>

    </div>
     <div class="col-md-5" style="background-color: white">
        <h5>Quantitative Assessment</h5>
         <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Annualized Rate of Occurrence (ARO):</label></div>
                    <div class="col-7">
                      <input type="range" class="slider" id="aro" name="aro" min="0" max="12" step="1" oninput="updatearoOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="aro" id="aroOutput">0</output></h6></div>
                </div>
             </div>
         </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Event Costs (SLE): </label></div>
                    <div class="col-7">
                        <input type="text" class="slider" id="sle" name="sle" style="border: 3px #97979A; border-radius: 10px; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);  padding: 20px; background-color: white">
                        <input type="hidden" id="hdn_sle" name="hdn_sle">
                    </div>

                </div>

            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="form-group">
                    <label for="ale">Annualized Loss Expectancy (ALE):</label>
                    <output id="ale" name="ale">$0</output>
                </div>
            </div>
        </div>

        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
            <div class="card-body">

                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Cost of Countermeasures:</label></div>
                    <div class="col-7">
                        <input type="range" class="slider" id="countermeasureCostsRange" name="countermeasureCostsRange" min="0" max="1000000" step="1000" oninput="updateCountermeasureCostsOutput(this.value)">
                    </div>
                    <div class="col-3"><h6><output for="countermeasureCostsRange" id="countermeasureCostsOutput">$0</output></h6></div>
                </div>
            </div>
        </div>

          <div class="card mb-3 shadow-sm" style="visibility: hidden"> <!-- Bootstrap card with shadow -->
            <div class="card-body">
                <div class="slider-container d-flex align-items-center">
                    <div class="col-2"><label class="small-font d-flex align-items-center " >Security Level (SL)</label></div>
                    <div class="col-7">
                      <input type="range" min="1" max="10" value="1" class="slider" id="sl_range" name="sl_range" onchange="initSlider('sl_range','range_sl');">
                    </div>
                    <div class="col-3"><h6><label id="range_sl" class="form-label text-center d-flex align-items-center justify-content-center small-font "></label></h6></div>
                </div>
            </div>
        </div>
         <script>
            function updatearoOutput(value) {
                document.getElementById('aroOutput').textContent = value;

                // Get the value from the hdn_sle field
                let sleValue = parseFloat(document.getElementById('hdn_sle').value);

                // Multiply the sleValue by the provided value
                let result = sleValue * value;

                // Format the result as a US$ amount with no decimal point
                let formattedResult = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(result);

                // Display the formatted result (or set it to any desired element)
                document.getElementById('ale').textContent = formattedResult;

                // Uncomment the next line if you want to call the calculateALE function
                // calculateALE();
            }

            function updateCountermeasureCostsOutput(value) {
              document.getElementById('countermeasureCostsOutput').textContent = value;
            }

            $(document).ready(function() {
              $('#sle').on('input', function() {
                var cost = parseInt($(this).val()).toLocaleString();
                $('#eventCostsOutput').text('$' + cost);
                //calculateALE();
              });

              function calculateALE() {
                var aro = parseInt($('#aro').val());
                var eventCosts = parseInt($('#sle').val());
                var sle = eventCosts;
                var aro = aro;
                var ale = sle * aro;
                $('#ale').text('$' + ale.toLocaleString());
              }
            });
          </script>
    </div>
     <div class="col-md-1" style="background-color: white"></div>
</div>

<script>






        // Function to save or update CyberPHA data
        function saveOrUpdateCyberPHA(formData) {
          // Get the CSRF token from the cookie
          const csrftoken = getCookie('csrftoken');

          // Create a new XMLHttpRequest object
          const xhr = new XMLHttpRequest();

          // Set up the request
          xhr.open('POST', "{% url 'OTRisk:save_or_update_cyberpha' %}", true);

          xhr.setRequestHeader('X-CSRFToken', csrftoken);


          // Define the callback function for when the request is completed
          xhr.onload = function() {
            if (xhr.status === 200) {
              location.reload()
              // Optionally, perform any additional actions or show a success message
            } else {
              console.error('Failed to save or update CyberPHA data');
              // Optionally, handle the error or show an error message
            }
          };

          // Send the request with the form data
          xhr.send(formData);
          showNotification('Scenario saved successfully: ' + response.message);
          $('#confirmationModal').modal('hide');

        }


        function getCookie(name) {
          const cookieValue = document.cookie
            .split(';')
            .map(cookie => cookie.trim())
            .find(cookie => cookie.startsWith(name + '='));

          if (cookieValue) {
            return cookieValue.split('=')[1];
          }

          return null;
        }

          // Event listener for form submission
          function processFormData() {
              // Check the value of the local session variable named "ls"
              var lsValue = sessionStorage.getItem("ls");
              var riskSnapshotCheckbox = document.getElementById('risk_snapshot');

              if (lsValue === "1") {
                  if (riskSnapshotCheckbox.checked) {
                      swal({
                          title: "iOTa Scenario Manager",
                          text: "The version of this scenario saved to the risk register cannot be changed. You are about to create a snapshot version of the scenario. Do you want to proceed?",
                          icon: "warning",
                          buttons: true,
                          dangerMode: true,
                      })
                          .then((willProceed) => {
                              if (willProceed) {
                                  continueProcessing(true); // Continue with the rest of the function without asking for scenario data save confirmation
                              }
                          });
                  } else {
                      swal("iOTa Scenario Manager", "Changes cannot be made to this scenario because it has been added to the risk register");
                      return; // Exit the function
                  }
              } else {
                  continueProcessing(false); // Continue with the rest of the function and ask for scenario data save confirmation
              }



              function continueProcessing(skipConfirmation) {
                  if (!skipConfirmation) {
                      // Prompt the user for confirmation
                      var isConfirmed = window.confirm("Are you sure you want to save the scenario data?");

                      // If the user clicked "Cancel", exit the function
                      if (!isConfirmed) {
                          return;
                      }
                  }

                  $('#loadingSpinner').show();
                  // Get the values of the form fields
                  const scenario = document.getElementById('id_txtScenario').value;
                  const exposed_system = document.getElementById('exposed_system').checked
                  const weak_credentials = document.getElementById('weak_credentials').checked
                  // const consequence = document.getElementById('txtConsequence').value
                  const threatSource = document.getElementById('threat-intelligence').value;
                  const riskCategory = document.getElementById('risk-category').value;
                  const safety = document.getElementById('range_safety').value;
                  const life = document.getElementById('range_life').value;
                  const production = document.getElementById('range_production').value;
                  const financial = document.getElementById('range_finance').value;
                  const reputation = document.getElementById('range_reputation').value;
                  const environment = document.getElementById('range_environment').value;
                  const regulatory = document.getElementById('range_regulatory').value;
                  const supply = document.getElementById('range_supply').value;
                  const data = document.getElementById('range_data').value;
                  const sm = document.getElementById('SMrange').value;
                  const mel = document.getElementById('MELrange').value;
                  const rrm = document.getElementById('RRMrange').value;
                  const sl_a = document.getElementById('selSL').value;
                  const sa = document.getElementById('SArange').value;
                  const mela = document.getElementById('MELarange').value;
                  const uel = document.getElementById('uel_range').value;
                  const uel_threat = document.getElementById('uel_threat').value;
                  const uel_vuln = document.getElementById('uel_vuln').value;
                  const uel_exposure = document.getElementById('uel_exposure').value;
                  const rru = document.getElementById('rru_range').value;
                  const sl = document.getElementById('sl_range').value;
                  const cyberpha = sessionStorage.getItem('activeCyberPHA')
                  const recommendations = document.getElementById('txtScenarioAnalysis').valu
                  const likelihood = document.getElementById('hdnLikelihood').value
                  const rra = document.getElementById('txtResidualRisk').value
                  const justifySafety = document.getElementById('txtsafetyJustify').value
                  const justifyLife = document.getElementById('txtlifeJustify').value
                  const justifyProduction = document.getElementById('txtproductionJustify').value
                  const justifyFinance = document.getElementById('txtfinanceJustify').value
                  const justifyReputation = document.getElementById('txtreputationJustify').value
                  const justifyEnvironment = document.getElementById('txtenvironmentJustify').value
                  const env_contaminant = document.getElementById('env_contaminant').value
                  const env_ecosystem = document.getElementById('env_ecosystem').value
                  const env_contamination = document.getElementById('env_contamination').value
                  const env_population = document.getElementById('env_population').value
                  const env_wildlife = document.getElementById('env_wildlife').value
                    const justifyRegulation = document.getElementById('txtregulatoryJustify').value
                  const justifySupply = document.getElementById('txtsupplyJustify').value
                  const dataRegulation = document.getElementById('txtdataJustify').value
                  //const sle =  document.getElementById('hdn_sle').value
                  const aleValue = document.getElementById('ale').value;
                  let ale = parseInt(aleValue.replace(/[^0-9]/g, ''), 10);
                  const probability = document.getElementById('txtProbability').value;
                  const control_effectiveness = document.getElementById('hdn_control_effectiveness').value;
                  const bia_score = document.getElementById('hdn_bia_score').value;
                  const sle_low = document.getElementById('txtEventCosts_low').value;
                  const sle_high = document.getElementById('txtEventCosts_high').value;
                  const sle_median = document.getElementById('txtEventCosts').value;
                  const ale_low = document.getElementById('txt_ale_low').value;
                  const ale_high = document.getElementById('txt_ale_high').value;
                  const ale_median = document.getElementById('txt_ale_median').value;
                  const frequency = document.getElementById('frequency').value;
                  //const standards = document.getElementById('selStandards').value;
                  const aro = document.getElementById('aro').value;
                  const risk_register = document.getElementById('risk_register').checked;
                  const sis_outage = document.getElementById('sisOutageYes').checked;
                  const sis_compromise = document.getElementById('sisIntegrityYes').checked;
                  const safety_hazard = document.getElementById('hazardNature').value;
                  const dangerScope = document.getElementById('dangerScope').value;
                  // Check if the "yes" option was selected for outage
                  const outageSelector = document.getElementById('outageYes');
                  const outage = outageSelector.value === "yes" ? "yes" : "no";
                  const compliance_map = document.getElementById('compliance_map').value;
                  const attack_tree_text = document.getElementById('attack_tree_text').value;
                  const scenario_status = document.getElementById('scenarioStatusSelect').value;

                  // If outage is "yes", get the values for outageDuration and outageCost
                  let outageDuration = 0;
                  let outageCost = 0;
                  if (outage === "yes") {
                      outageDuration = parseInt(document.getElementById('outageDuration').value, 10);
                      outageCost = parseInt(document.getElementById('outageCost').value, 10);
                  }
                  var sid = sessionStorage.getItem('sid');
                    if (!sid) {
                        sid = 0;
                    }
                  // Add the consequences table
                  const table = document.getElementById('consequenceTable');
                  const rows = table.getElementsByTagName('tbody')[0].rows;
                  let validatedConsequenceExists = false;
                    for (let i = 0; i < rows.length; i++) {
                        const isChecked = rows[i].cells[1].getElementsByTagName('input')[0].checked;
                        if (isChecked) {
                            validatedConsequenceExists = true;
                            break;
                        }
                    }

                    if (rows.length === 0 || !validatedConsequenceExists) {
                        alert("No consequences have been added or validated. Please add and validate consequences before proceeding.");
                        return; // Exit the function
                    }
                  // Create a FormData object
                  const formData = new FormData();
                  formData.append('scenarioID', sid);
                  formData.append('sis_outage', sis_outage);
                  formData.append('sis_compromise', sis_compromise);
                  formData.append('safety_hazard', safety_hazard);
                  formData.append('dangerScope', dangerScope);
                  formData.append('scenario', scenario);
                  formData.append('exposed_system',exposed_system);
                  formData.append('weak_credentials',weak_credentials);
                  // formData.append('consequence', consequence);
                  formData.append('threatSource', threatSource);
                  formData.append('riskCategory', riskCategory);
                  formData.append('safety', safety);
                  formData.append('life', life);
                  formData.append('production', production);
                  formData.append('financial', financial);
                  formData.append('reputation', reputation);
                  formData.append('environment', environment);
                  formData.append('env_contaminant', env_contaminant);
                  formData.append('env_ecosystem', env_ecosystem);
                  formData.append('env_contamination', env_contamination);
                  formData.append('env_population', env_population);
                  formData.append('env_wildlife', env_wildlife);
                  formData.append('regulatory', regulatory);
                  formData.append('data', data);
                  formData.append('supply', supply);
                  formData.append('sm', sm);
                  formData.append('mel', mel);
                  formData.append('rrm', rrm);
                  formData.append('sa', sa);
                  formData.append('mela', mela);
                  formData.append('rra', rra);
                  formData.append('aro', aro);
                  formData.append('uel', uel);
                  formData.append('uel_threat', uel_threat);
                  formData.append('uel_vuln', uel_vuln);
                  formData.append('uel_exposure', uel_exposure);
                  formData.append('rru', rru);
                  formData.append('sl', sl);
                  formData.append('recommendations', recommendations)
                  formData.append('cyberpha', cyberpha);
                  formData.append('justifySafety', justifySafety);
                  formData.append('justifyLife', justifyLife);
                  formData.append('justifyProduction', justifyProduction);
                  formData.append('justifyFinance', justifyFinance);
                  formData.append('justifyReputation', justifyReputation);
                  formData.append('justifyEnvironment', justifyEnvironment);
                  formData.append('justifyRegulation', justifyRegulation);
                  formData.append('dataRegulation', dataRegulation);
                  formData.append('justifySupply', justifySupply);
                  formData.append('sle_low', sle_low);
                  formData.append('sle_median', sle_median);
                  formData.append('sle_high', sle_high);
                  formData.append('ale_low', ale_low);
                  formData.append('ale_median', ale_median);
                  formData.append('ale_high', ale_high);
                  formData.append('frequency', frequency);
                  formData.append('ale', ale);
                  formData.append('outage', outage);
                  formData.append('outageDuration', outageDuration);
                  formData.append('outageCost', outageCost);
                  formData.append('probability', probability);
                  formData.append('control_effectiveness', control_effectiveness);
                  //formData.append('standards', standards);
                  formData.append('risk_register', risk_register);
                  formData.append('likelihood', likelihood);
                  formData.append('sl_a', sl_a);
                  formData.append('ai_bia_score', bia_score);
                  formData.append('compliance_map', compliance_map);
                  formData.append('attack_tree_text', attack_tree_text);
                  formData.append('scenario_status', scenario_status);
                    // Check if snapshot should be created
                  let snapshot = 0
                  const riskSnapshotCheckbox = document.getElementById('risk_snapshot');
                  if (riskSnapshotCheckbox.checked) {
                        snapshot = 1;
                    }
                  formData.append('snapshot', snapshot);
                  for (let i = 0; i < rows.length; i++) {
                      const row = rows[i];
                      const isChecked = row.cells[1].getElementsByTagName('input')[0].checked;
                      if (isChecked) {
                          const consequenceText = row.cells[0].innerText;
                          formData.append('validated_consequences', consequenceText);
                      }
                  }
                  // Check for safeguards in the table and add them to formData
                    const safeguardsTable = document.getElementById('table_safeguards');
                    const safeguard_rows = safeguardsTable.getElementsByTagName('tbody')[0].rows;
                    let safeguardsAdded = false;

                    for (let i = 0; i < safeguard_rows.length; i++) {
                        const safeguardDescription = safeguard_rows[i].cells[0].getElementsByTagName('textarea')[0].value.trim();
                        const safeguardType = safeguard_rows[i].cells[1].getElementsByTagName('textarea')[0].value.trim();

                        // Ignore empty rows
                        if (safeguardDescription || safeguardType) {
                            formData.append(`safeguards[${i}][description]`, safeguardDescription);
                            formData.append(`safeguards[${i}][type]`, safeguardType);
                            safeguardsAdded = true;
                        }
                    }

                    // If no safeguards were added (table was empty or all rows were empty), add a dummy row
                    if (!safeguardsAdded) {
                        formData.append('safeguards[0][description]', 'No physical safeguards defined');
                        formData.append('safeguards[0][type]', 'N/A');
                    }
                  // Call the saveOrUpdateCyberPHA function
                  saveOrUpdateCyberPHA(formData);

                  $('#loadingSpinner').hide();
              }
          }
    </script>

<div class="modal fade custom-modal" id="safetyModal" tabindex="-1" aria-labelledby="safetyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="safetyModal_Label">Justification for Safety Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- Drop-down select control for the nature of the safety hazard -->
        <label for="hazardNature">Nature of Safety Hazard:</label>
        <select id="hazardNature" name="hazardNature" class="form-control mb-3">
            <option value="">-- Select Hazard --</option>
          <option value="Chemical">Chemical</option>
          <option value="Electrical">Electrical</option>
          <option value="Mechanical">Mechanical</option>
          <option value="Radiation">Radiation</option>
        </select>

        <!-- Yes/no option for SIS Outage -->
        <div class="mb-3">
          <label>SIS Outage:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageYes" value="yes">
            <label class="form-check-label" for="sisOutageYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisOutage" id="sisOutageNo" value="no">
            <label class="form-check-label" for="sisOutageNo">No</label>
          </div>
        </div>

        <!-- Yes/no option for SIS Integrity Compromise -->
        <div class="mb-3">
          <label>SIS Integrity Compromise:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrity" id="sisIntegrityYes" value="yes">
            <label class="form-check-label" for="sisIntegrityYes">Yes</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sisIntegrity" id="sisIntegrityNo" value="no">
            <label class="form-check-label" for="sisIntegrityNo">No</label>
          </div>
        </div>

        <!-- Textarea for justification -->
        <label for="txtsafetyJustify">Justification:</label>
        <textarea id="txtsafetyJustify" name="txtsafetyJustify" class="form-control mb-3" rows="3" style="resize: none"></textarea>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="lifeModal" tabindex="-1" aria-labelledby="lifeModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="lifeModal_Label">Justification for Danger-to-Life Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtlifeJustify" name="txtlifeJustify" class="form-control" rows="3" style="resize: none"></textarea>
           <!-- Drop-down select control for the nature of the safety hazard -->
        <label for="dangerScope">Scope of Danger:</label>
        <select id="dangerScope" name="dangerScope" class="form-control mb-3">
            <option value="">-- Select Scope --</option>
            <option value="N/A">N/A</option>
            <option value="Facility">Facility</option>
            <option value="External">External</option>
            <option value="Both">Both</option>
        </select>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<div class="modal fade custom-modal" id="productionModal" tabindex="-1" aria-labelledby="productionModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productionModal_Label">Justification for Production Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtproductionJustify" name="txtproductionJustify" class="form-control" rows="3" style="resize: none"></textarea>

        <!-- 1. Yes/No selector -->
        <div class="mt-3">
          <label>Production Outage?</label><br>
          <input type="radio" id="outageYes" name="outage" value="yes" onclick="toggleOutageControls(true)">
          <label for="outageYes">Yes</label><br>
          <input type="radio" id="outageNo" name="outage" value="no" checked onclick="toggleOutageControls(false)">
          <label for="outageNo">No</label>
        </div>

        <!-- 2. Number input for length of time -->
        <div class="mt-3" id="outageDurationDiv" style="display: none;">
          <label for="outageDuration">Estimate length of time of the outage (hours):</label>
          <input type="number" id="outageDuration" name="outageDuration" class="form-control" min="1">
        </div>

        <!-- 3. Text input for cost per hour -->
        <div class="mt-3" id="outageCostDiv" style="display: none;">
          <label for="outageCost">Cost per hour of outage (if known): </label>
          <input type="text" id="outageCost" name="outageCost" class="form-control">
        </div>

        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleOutageControls(isVisible) {
    const durationDiv = document.getElementById('outageDurationDiv');
    const costDiv = document.getElementById('outageCostDiv');
    if (isVisible) {
      durationDiv.style.display = 'block';
      costDiv.style.display = 'block';
    } else {
      durationDiv.style.display = 'none';
      costDiv.style.display = 'none';
    }
  }
</script>

<div class="modal fade custom-modal" id="financeModal" tabindex="-1" aria-labelledby="financeModal" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="financeModal_Label">Justification for Financial Impact Rating</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Existing Justification Textarea -->
                <textarea id="txtfinanceJustify" name="txtfinanceJustify" class="form-control" rows="3" style="resize: none"></textarea>

                <!-- Additional Financial Fields -->
                <div class="form-group mt-3">
                    <label for="lostProductionUnits" style="color: #000000">Lost Production Units:</label>
                    <input type="number" id="lostProductionUnits" name="lostProductionUnits" class="form-control" placeholder="Enter lost units" />

                    <label for="wastedLabourCosts" style="color: #000000">Wasted Labour Costs:</label>
                    <input type="number" id="wastedLabourCosts" name="wastedLabourCosts" class="form-control" placeholder="Enter amount" />

                    <label for="lostInventory" style="color: #000000">Lost Inventory:</label>
                    <input type="number" id="lostInventory" name="lostInventory" class="form-control" placeholder="Enter value" />

                    <!-- Add more fields as needed -->
                </div>

                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade custom-modal" id="reputationModal" tabindex="-1" aria-labelledby="reputationModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reputationModal_Label">Justification for Reputation Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtreputationJustify" name="txtreputationJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="environmentModal" tabindex="-1" aria-labelledby="environmentModal" aria-hidden="true" >
  <div class="modal-dialog modal-xl" >
    <div class="modal-content" style="background-color: darkgray; ">
      <div class="modal-header">
        <h5 class="modal-title" id="environmentModal_Label">Justification for Environment Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtenvironmentJustify" name="txtenvironmentJustify" class="form-control" rows="3" style="resize: none"></textarea>
                <!-- Dropdown for the type of contaminants -->
        <label for="env_contaminant">Type of Contaminants:</label>
        <select id="env_contaminant" name="env_contaminant" class="form-control mb-3">
          <option value="">-- Select Contaminant Type --</option>
          <option value="N/A">N/A</option>
          <option value="Chemical">Chemical</option>
          <option value="Biological">Biological</option>
          <option value="Radiological">Radiological</option>
          <option value="Physical">Physical</option>
        </select>
          <!-- Dropdown for the affected ecosystem -->
        <label for="env_ecosystem">Affected Ecosystem:</label>
        <select id="env_ecosystem" name="env_ecosystem" class="form-control mb-3">
          <option value="">-- Select Ecosystem --</option>
          <option value="N/A">N/A</option>
          <option value="Aquatic">Aquatic</option>
          <option value="Urban">Urban</option>
          <option value="Agricultural">Agricultural</option>
        </select>
          <!-- Dropdown for the extent of the contamination -->
        <label for="env_contamination">Extent of Contamination:</label>
        <select id="env_contamination" name="env_contamination" class="form-control mb-3">
          <option value="">-- Select Extent --</option>
            <option value="N/A">N/A</option>
          <option value="Localised">Localised</option>
          <option value="WideArea">Wide Area</option>
        </select>
          <!-- Dropdown for effect on local residential population -->
        <label for="env_population">Effect on Local Residential Population:</label>
        <select id="env_population" name="env_population" class="form-control mb-3">
          <option value="">-- Select Effect --</option>
            <option value="N/A">N/A</option>
          <option value="Harmless">Harmless</option>
          <option value="Harmful">Harmful</option>
          <option value="Deadly">Deadly</option>
        </select>

        <!-- Dropdown for effect on local wildlife -->
        <label for="env_wildlife">Effect on Local Wildlife:</label>
        <select id="env_wildlife" name="env_wildlife" class="form-control mb-3">
            <option value="">-- Select Effect --</option>
            <option value="N/A">N/A</option>
            <option value="Harmless">Harmless</option>
            <option value="Harmful">Harmful</option>
            <option value="Deadly">Deadly</option>
        </select>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="regulatoryModal" tabindex="-1" aria-labelledby="regulatoryModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="regulatoryModal_Label">Justification for Regulatory Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtregulatoryJustify" name="txtregulatoryJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade custom-modal" id="dataModal" tabindex="-1" aria-labelledby="dataModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModal_Label">Justification for Data Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtdataJustify" name="txtdataJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade custom-modal" id="supplyModal" tabindex="-1" aria-labelledby="supplyModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="supplyModal_Label">Justification for Supply Chain Impact Rating</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="txtsupplyJustify" name="txtsupplyJustify" class="form-control" rows="3" style="resize: none"></textarea>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade custom-modal" id="uelModal" tabindex="-1" aria-labelledby="uelModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uelModal_Label">UEL Assessment</h5>
      </div>
          <div class="row">
              <div class="col-md-2"></div>
              <div class="col-md-8">
                <!-- Threat Capability -->
                <div class="control-group">
                <label for="uel_threat" style="font-size: 16; font-weight: bold">Threat Capability:</label>
                <div class="range-container">
                <input type="range" id="uel_threat" name="uel_threat" min="1" max="10" step="1" class="slider">
                <span id="threatLabel">Low Skills</span>
                </div>
                </div>

                <div class="control-group">
                <label for="uel_vuln"  style="font-size: 16; font-weight: bold">Vulnerability Presence:</label>
                <div class="range-container">
                <input type="range" id="uel_vuln" name="uel_vuln" min="0" max="10" step="1" class="slider">
                <span id="vulnerabilityLabel">No Vulnerabilities</span>
                </div>
                </div>

                <!-- System Exposure -->
                <div class="control-group">
                <label for="uel_exposure"  style="font-size: 16; font-weight: bold">System Exposure:</label>
                <div class="range-container">
                <input type="range" id="uel_exposure" name="uel_exposure" min="0" max="10" step="1" class="slider">
                <span id="exposureLabel">No Exposure</span>
                </div>
                </div>
                <!-- Button centered -->
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
                </div>
                  <br>
              </div>
              <div class="col-md-2"></div>
          </div>
    </div>
  </div>
</div>
    <div class="modal fade custom-modal" id="rruModal" tabindex="-1" aria-labelledby="rruModal" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rruModal_Label">RRU Assessment</h5>
      </div>
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <!-- Threat Capability -->
                <div class="control-group">
                <label for="rru_threat" style="font-size: 16; font-weight: bold">Threat Likelihood:</label>
                <div class="range-container">
                <input type="range" id="rru_threat" name="rru_threat" min="1" max="10" step="1" class="slider">
                <span id="rru_threat_Label">Low Skills</span>
                </div>
                </div>

                <!-- Vulnerability Presence -->
                <div class="control-group">
                <label for="rru_vuln" style="font-size: 16; font-weight: bold">Vulnerability Severity:</label>
                <div class="range-container">
                <input type="range" id="rru_vuln" name="rru_vuln" min="0" max="10" step="1" class="slider">
                <span id="rru_vuln_Label">No Vulnerabilities</span>
                </div>
                </div>

                <!-- System Exposure -->
                <div class="control-group">
                <label for="rru_event" style="font-size: 16; font-weight: bold">Event Magnitude:</label>
                <div class="range-container">
                <input type="range" id="rru_event" name="rru_event" min="0" max="10" step="1" class="slider">
                <span id="rru_exposure_Label">No Event</span>
                </div>
                </div>

                <div class="d-flex justify-content-center">
                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
                </div>
                <br>
            </div>
            <div class="col-md-2"></div>
        </div>


    </div>
</div>
    </div>
<script>
$(document).ready(function() {
    // Function to update labels based on range values
    function updateLabels() {
        // Threat Capability
        let threatValue = $('#uel_threat').val();
        let threatLabel = "Low Skills";
        if (threatValue <= 3) threatLabel = "Low Skills";
        else if (threatValue <= 5) threatLabel = "Moderate Skills";
        else if (threatValue <= 7) threatLabel = "Advanced Skills";
        else if (threatValue <= 9) threatLabel = "Expert";
        else threatLabel = "Highly Skilled";
        $('#threatLabel').text(threatLabel);

        // Vulnerability Presence
        let vulnerabilityValue = $('#uel_vuln').val();
        let vulnerabilityLabel = "No Vulnerabilities";
        if (vulnerabilityValue <= 3) vulnerabilityLabel = "Minor Vulnerabilities";
        else if (vulnerabilityValue <= 5) vulnerabilityLabel = "Some Vulnerabilities";
        else if (vulnerabilityValue <= 7) vulnerabilityLabel = "Major Vulnerabilities";
        else if (vulnerabilityValue <= 9) vulnerabilityLabel = "Critical Vulnerabilities";
        else vulnerabilityLabel = "Easily Exploitable Vulnerabilities";
        $('#vulnerabilityLabel').text(vulnerabilityLabel);

        // System Exposure
        let exposureValue = $('#uel_exposure').val();
        let exposureLabel = "No Exposure";
        if (exposureValue <= 3) exposureLabel = "Minimal Exposure";
        else if (exposureValue <= 5) exposureLabel = "Moderate Exposure";
        else if (exposureValue <= 7) exposureLabel = "Significant Exposure";
        else if (exposureValue <= 9) exposureLabel = "High Exposure";
        else exposureLabel = "Unrestricted External Exposure";
        $('#exposureLabel').text(exposureLabel);
    }

    // Function to compute and set the overall UEL score
    function computeAndSetUEL() {
        let threatValue = parseInt($('#uel_threat').val());
        let vulnerabilityValue = parseInt($('#uel_vuln').val());
        let exposureValue = parseInt($('#uel_exposure').val());

        // Compute the average
        let overallUEL = Math.round((threatValue + vulnerabilityValue + exposureValue) / 3);

        // Set the value to the uel_range control
        $('#uel_range').val(overallUEL);
    }

    // Event listeners for the range controls
    $('#uel_threat, #uel_vuln, #uel_exposure').on('input', function() {
        updateLabels();
        computeAndSetUEL();
        initSlider('uel_range','range_uel');
    });
});

$(document).ready(function() {
    // Function to update labels based on range values
    function updateLabels() {
        // Threat Capability
        let rru_threat_Value = $('#rru_threat').val();
        let rru_threat_Label = "Low Likelihood";
        if (rru_threat_Value <= 3) rru_threat_Label = "Low Likelihood";
        else if (rru_threat_Value <= 5) rru_threat_Label = "Moderate Likelihood";
        else if (rru_threat_Value <= 7) rru_threat_Label = "High Likelihood";
        else if (rru_threat_Value <= 9) rru_threat_Label = "Very High Likelihood";
        else rru_threat_Label = "Very High Likelihood";
        $('#rru_threat_Label').text(rru_threat_Label);

        // Vulnerability Presence
        let rru_vuln = $('#rru_vuln').val();
        let rru_vuln_Label = "No Vulnerabilities";
        if (rru_vuln <= 3) rru_vuln_Label = "Minor Vulnerabilities";
        else if (rru_vuln <= 5) rru_vuln_Label = "Some Vulnerabilities";
        else if (rru_vuln <= 7) rru_vuln_Label = "Major Vulnerabilities";
        else if (rru_vuln <= 9) rru_vuln_Label = "Critical Vulnerabilities";
        else rru_vuln_Label = "Easily Exploitable Vulnerabilities";
        $('#rru_vuln_Label').text(rru_vuln_Label);

        // System Exposure
        let rru_exposure_Value = $('#rru_event').val();
        let rru_exposure_Label = "No Consequence";
        if (rru_exposure_Value <= 3) rru_exposure_Label = "Minimal Consequence";
        else if (rru_exposure_Value <= 5) rru_exposure_Label = "Moderate Consequence";
        else if (rru_exposure_Value <= 7) rru_exposure_Label = "Significant Consequence";
        else if (rru_exposure_Value <= 9) rru_exposure_Label = "High Consequence";
        else rru_exposure_Label = "Critical Consequence";
        $('#rru_exposure_Label').text(rru_exposure_Label);
    }

    // Function to compute and set the overall rru score
    function computeAndSetrru() {
        let rru_threat_Value = parseInt($('#rru_threat').val());
        let rru_vuln_Value = parseInt($('#rru_vuln').val());
        let rru_exposure_Value = parseInt($('#rru_event').val());

        // Compute the average
        let overallrru = Math.round((rru_threat_Value + rru_vuln_Value + rru_exposure_Value) / 3);
        // Set the value to the rru_range control
        $('#rru_range').val(overallrru);
    }

    // Event listeners for the range controls
    $('#rru_threat, #rru_vuln, #rru_event').on('input', function() {
        updateLabels();
        computeAndSetrru();
        initSlider('rru_range','range_rru');
    });
});

</script>
</form>

<!-- RAActionsModal.html -->
<div class="modal fade" id="RAActionsModal" tabindex="-1" aria-labelledby="RAActionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="RAActionsModalLabel" style="color: white">Action:</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
            <form id="raActionsForm">
                {% csrf_token %}
                <input type="hidden" name="hdnphaID" id="hdnphaID">
                <input type="hidden" name="hdntxtModalRAW" id="hdntxtModalRAW" value="0">

                <!-- Action Title -->
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionTitle" class="form-label">Headline</label>
                            <input type="text" class="form-control" id="actionTitle" name="actionTitle" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionOwner" class="form-label">Risk Owner</label>
                                    <input type="text" class="form-control" id="actionOwner" name="actionOwner" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDate" class="form-label">Action Date</label>
                                    <input type="date" class="form-control" id="actionDate" name="actionDate" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionEffort" class="form-label">Effort Level:</label>
                                    <Select class="form-control" id="actionEffort" name="actionEffort">
                                            <option value="">-- Select Effort --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                                </div>
                            </div>
                        </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDifficulty" class="form-label">Difficulty Level</label>
                                    <Select class="form-control" id="actionDifficulty" name="actionDifficulty">
                                            <option value="">-- Select Difficulty --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>

                                </div>
                            </div>
                        </div>
                    </div>
                    </div>


                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionCost" class="form-label">Estimated Cost</label>
                                    <Select class="form-control" id="actionCost" name="actionCost">
                                            <option value="">-- Select Costs --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionAffinity" class="form-label">Risk Mitigation</label>
                                    <Select class="form-control" id="actionAffinity" name="actionAffinity">
                                            <option value="">-- Select Level --</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Very High">Very High</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionStatus" class="form-label">Status</label>
                                    <input type="text" class="form-control" id="actionStatus" name="actionStatus" readonly value="Open">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <label for="actionDescription" class="form-label">Description</label>
                            <textarea id="actionDescription" name="actionDescription" class="form-control" rows="3" style="resize: none"></textarea>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionPriority" class="form-label">Urgency</label>
                                        <select class="form-control" id="actionPriority" name="actionPriority">
                                            <option value="0">-- Select Urgency --</option>
                                            <option value="1">Low</option>
                                            <option value="2">Medium</option>
                                            <option value="3">High</option>
                                            <option value="4">Critical</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="actionDueDate" class="form-label">Target Date</label>
                                    <input type="date" class="form-control" id="actionDueDate" name="actionDueDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Assets -->
                <div class="mb-3">
                    <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                        <div class="card-body">
                            <div class="row justify-content-center">
                                <div class="col-md-12">
                                <p class="justify-content-center">Expected Risk Mitigation from Action</p>
                                </div>
                            </div>
                            <div class="row justify-content-center">
                                <div class="col-md-4">
                                    <label for="safetyMitigation">Safety: <span id="safetyMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="safetyMitigation" name="safetyMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="lifeMitigation">Life: <span id="lifeMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="lifeMitigation" name="lifeMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="productionMitigation">Production: <span id="productionMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="productionMitigation" name="productionMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4">
                                <div class="col-md-4">
                                    <label for="financeMitigation">Finance: <span id="financeMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="financeMitigation" name="financeMitigation" min="0" max="100" value="0">
                                </div>

                                <div class="col-md-4">
                                    <label for="reputationMitigation">Reputation: <span id="reputationMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="reputationMitigation" name="reputationMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="environmentMitigation">Environment: <span id="environmentMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="environmentMitigation" name="environmentMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4">
                                <div class="col-md-4">
                                    <label for="regulationMitigation">Regulation: <span id="regulationMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="regulationMitigation" name="regulationMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="dataMitigation">Data: <span id="dataMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="dataMitigation" name="dataMitigation" min="0" max="100" value="0">
                                </div>

                                <div class="col-md-4">
                                    <label for="supplyMitigation">Supply: <span id="supplyMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="supplyMitigation" name="supplyMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="row justify-content-center mt-4">
                                <div class="col-md-4">
                                    <label for="threatMitigation">Threat: <span id="threatMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="threatMitigation" name="threatMitigation" min="0" max="100" value="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="vulnerabilityMitigation">Vulnerability: <span id="vulnerabilityMitigationValue"></span></label>
                                    <input type="range" class="form-control custom-range" id="vulnerabilityMitigation" name="vulnerabilityMitigation" min="0" max="100" value="0">
                                </div>
                            </div>
                            <script>
                            document.addEventListener('DOMContentLoaded', (event) => {
                              // This function updates the span displaying the value of the slider
                              function updateSliderValue(slider) {
                                const valueDisplayId = slider.id + 'Value';
                                const valueDisplay = document.getElementById(valueDisplayId);
                                if (valueDisplay) {
                                  valueDisplay.textContent = slider.value + '%'; // Add the '%' symbol
                                } else {
                                  // console.error('No element found with id:', valueDisplayId);
                                }
                              }

                              // Get all range inputs on the form
                              const sliders = document.querySelectorAll('input[type="range"]');

                              // Initialize the display values and add event listeners to each slider
                              sliders.forEach(slider => {
                                updateSliderValue(slider); // Initialize the display value
                                slider.addEventListener('input', () => updateSliderValue(slider));
                              });
                            });

                            </script>
                        </div>

                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageSIS" class="form-label">Safety (SIS) Outage:</label>
                                        <select class="form-control" id="outageSIS" name="outageSIS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageICS" class="form-label">Control System (SCADA/ICS) Outage:</label>
                                        <select class="form-control" id="outageICS" name="outageICS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageEMS" class="form-label">Environmental (EMS) Outage:</label>
                                        <select class="form-control" id="outageEMS" name="outageEMS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <!-- Action Owner -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageIT" class="form-label">IT Outage:</label>
                                        <select class="form-control" id="outageIT" name="outageIT">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outagePS" class="form-label">Physical Security Outage:</label>
                                        <select class="form-control" id="outagePS" name="outagePS">
                                            <option value="">-- Select Option --</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Action Date -->
                        <div class="mb-3">
                            <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                                <div class="card-body">
                                    <label for="outageWWW" class="form-label">Internet Outage:</label>
                                        <select class="form-control" id="outageWWW" name="outageWWW">
                                            <option value="0">-- Select Option --</option>
                                            <option value="1">Yes</option>
                                            <option value="2">No</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitRAActionForm();">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </form>
        </div>
        <!-- ... (rest of the modal code) ... -->

    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="scenarioSelectModal" tabindex="-1" aria-labelledby="scenarioSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scenarioSelectModalLabel">Select a Scenario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="file-explorer">
          <ul id="scenarioList" class="list-group">
            <!-- Scenario items will be populated here -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    // Function to populate the scenario list in the modal
function populateScenarioList() {
  $.ajax({
    url: '/OTRisk/get_saved_scenario_builders',
    type: 'GET',
    success: function(response) {
      var scenarioList = $('#scenarioList');
      scenarioList.empty();

      response.forEach(function(scenario) {
        var listItem = $(`
          <li class="list-group-item list-group-item-action" data-id="${scenario.id}">
            <span class="file-icon"><i class="fas fa-file-alt"></i></span>
            <span class="file-name">${scenario.scenario_name}</span>
          </li>
        `);
        listItem.on('click', function() {
          retrieveScenario($(this).data('id'));
          $('#scenarioSelectModal').modal('hide');
        });
        scenarioList.append(listItem);
      });
    },
    error: function(error) {
      console.error('Error fetching scenarios:', error);
    }
  });
}



// Function to retrieve and display a selected scenario
function retrieveScenario(scenarioId) {
  clearScenario();
  $.ajax({
    url: '/OTRisk/retrieve_scenario_builder/' + scenarioId,
    type: 'GET',
    success: function(response) {
        clearScenario();
      $('#id_txtScenario').val(response.scenario_description);
      $('#attack_tree_text').val(response.attack_tree_data);

        // Check if data.attack_tree_text is defined, not null, and not an empty string
        if (response.attack_tree_data && response.attack_tree_data.trim() !== '') {

            var jsonStringFromDatabase = response.attack_tree_data;
            var jsonObject = JSON.parse(jsonStringFromDatabase);
            drawAttackTree(jsonObject);
        }


      if (response.factors['Environmental consequences']) {
        $('#range_environment').val(response.factors['Environmental consequences'].score);
        $('#txtenvironmentJustify').val(response.factors['Environmental consequences'].narrative);
      }
       if (response.factors['Data']) {
        $('#range_data').val(response.factors['Data'].score);
        $('#txtdataJustify').val(response.factors['Data'].narrative);
      }
      if (response.factors['Danger-to-life']) {
        $('#range_life').val(response.factors['Danger-to-life'].score);
        $('#txtlifeJustify').val(response.factors['Danger-to-life'].narrative);
      }
      if (response.factors['Financials']) {
        $('#range_finance').val(response.factors['Financials'].score);
        $('#txtfinanceJustify').val(response.factors['Financials'].narrative);
      }
      if (response.factors['Operations']) {
        $('#range_production').val(response.factors['Operations'].score);
        $('#txtproductionJustify').val(response.factors['Operations'].narrative);
      }
      if (response.factors['Regulations']) {
        $('#range_regulatory').val(response.factors['Regulations'].score);
        $('#txtregulatoryJustify').val(response.factors['Regulations'].narrative);
      }
      if (response.factors['Reputation']) {
        $('#range_reputation').val(response.factors['Reputation'].score);
        $('#txtreputationJustify').val(response.factors['Reputation'].narrative);
      }
      if (response.factors['Safety']) {
        $('#range_safety').val(response.factors['Safety'].score);
        $('#txtsafetyJustify').val(response.factors['Safety'].narrative);
      }
      if (response.factors['Supply chain']) {
        $('#range_supply').val(response.factors['Supply chain'].score);
        $('#txtsupplyJustify').val(response.factors['Supply chain'].narrative);
      }

       // Populate the consequences table
      var tableBody = $('#consequenceTable tbody');
      tableBody.empty(); // Clear existing rows

      response.consequences.forEach(function(consequence) {
        if (consequence.trim() !== '') {
          var row = `<tr><td>${consequence}</td><td><input type="checkbox" checked></td></tr>`;
          tableBody.append(row);
        }
      });

    },
    error: function(error) {
      console.error('Error retrieving scenario:', error);
    }
  });
}

// Call populateScenarioList when the modal is about to be shown
$('#scenarioSelectModal').on('show.bs.modal', function (e) {
  populateScenarioList();
});

</script>


<script>
    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });

    function submitRAActionForm() {
        $.ajax({
            type: "POST",
            url: "{% url 'OTRisk:save_ra_action' %}",
            data: $("#raActionsForm").serialize(),
            success: function(response) {
                if (response.status == "success") {
                    $("#RAActionsModal").modal('hide');
                    // Optionally, show a success message or perform other actions.
                } else {
                    alert("Error saving data!");
                }
            }
        });
    }
</script>




    <script>

    function showNotification(message, isError = false) {
        var notificationDiv = document.getElementById('notificationMessage');
        notificationDiv.innerHTML = message;
        notificationDiv.style.display = 'block';
        notificationDiv.className = isError ? 'notification-message error' : 'notification-message';

        // Automatically hide the notification after some time
        setTimeout(function() {
            notificationDiv.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }


        // Function to add a new scenario row to the table
        function addScenarioRow() {
            try {
                var scenarioCount = document.querySelectorAll('#scenarioTable tbody tr').length + 1;
                var row = document.createElement('tr');
                row.id = 'scenarioRow' + scenarioCount;

                // Create table cells for each field
                var assessmentNameCell = document.createElement('td');
                var scenarioCell = document.createElement('td');
                var controlObjectiveCell = document.createElement('td');
                var riskCategoryCell = document.createElement('td');
                var mitigationMeasuresCell = document.createElement('td');
                var likelihoodCell = document.createElement('td');
                var impactCell = document.createElement('td');
                var riskLevelCell = document.createElement('td');

                // Create form elements for each field
                var assessmentNameInput = document.createElement('input');
                assessmentNameInput.type = 'text';
                assessmentNameInput.name = 'assessment_name';
                assessmentNameCell.appendChild(assessmentNameInput);

                var scenarioInput = document.createElement('input');
                scenarioInput.type = 'text';
                scenarioInput.name = 'scenarios[' + scenarioCount + '][scenario]';
                scenarioCell.appendChild(scenarioInput);

                var controlObjectiveSelect = document.createElement('select');
                controlObjectiveSelect.name = 'scenarios[' + scenarioCount + '][control_objective]';
                // Populate control objectives dynamically

                var riskCategorySelect = document.createElement('select');
                riskCategorySelect.name = 'scenarios[' + scenarioCount + '][CategoryName]';
                // Populate risk categories dynamically


                var mitigationMeasuresSelect = document.createElement('select');
                mitigationMeasuresSelect.name = 'scenarios[' + scenarioCount + '][mitigation_measures]';
                // Populate mitigation measures dynamically

                var likelihoodInput = document.createElement('input');
                likelihoodInput.type = 'number';
                likelihoodInput.name = 'scenarios[' + scenarioCount + '][likelihood]';
                likelihoodCell.appendChild(likelihoodInput);

                var impactInput = document.createElement('input');
                impactInput.type = 'number';
                impactInput.name = 'scenarios[' + scenarioCount + '][impact]';
                impactCell.appendChild(impactInput);

                var riskLevelInput = document.createElement('input');
                riskLevelInput.type = 'text';
                riskLevelInput.name = 'scenarios[' + scenarioCount + '][risk_level]';
                riskLevelInput.disabled = true;
                riskLevelCell.appendChild(riskLevelInput);

                // Append form elements to the cells
                assessmentNameCell.appendChild(assessmentNameInput);
                scenarioCell.appendChild(scenarioInput);
                controlObjectiveCell.appendChild(controlObjectiveSelect);
                riskCategoryCell.appendChild(riskCategorySelect);
                mitigationMeasuresCell.appendChild(mitigationMeasuresSelect);
                likelihoodCell.appendChild(likelihoodInput);
                impactCell.appendChild(impactInput);
                riskLevelCell.appendChild(riskLevelInput);

                // Append cells to the row
                row.appendChild(assessmentNameCell);
                row.appendChild(scenarioCell);
                row.appendChild(controlObjectiveCell);
                row.appendChild(riskCategoryCell);
                row.appendChild(mitigationMeasuresCell);
                row.appendChild(likelihoodCell);
                row.appendChild(impactCell);
                row.appendChild(riskLevelCell);

                // Append row to the table
                document.getElementById('scenarioTable').appendChild(row);
            } catch (error) {

            }
        }

        // Event listener for adding a new scenario row
        document.getElementById('addScenarioBtn').addEventListener('click', function() {
            addScenarioRow();
        });



        // Function to fetch and populate the mitigation measures dynamically
        function populateMitigationMeasures(controlObjectiveSelect) {
            fetch('/OTRisk/get_mitigation_measures/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(measure => {
                        let option = document.createElement('option');
                        option.value = measure;
                        option.text = measure;
                        controlObjectiveSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.log('Error fetching mitigation measures:', error);
                });
        }

        // Event listener to populate the mitigation measures when the control objective is selected
        document.addEventListener('change', function(event) {
            const element = event.target;
            if (element.tagName === 'SELECT' && element.name.includes('control_objective')) {
                const controlObjectiveSelect = element;
                const mitigationMeasuresSelect = controlObjectiveSelect.closest('tr').querySelector('select[name$="[mitigation_measures]"]');
                // Clear previous options
                while (mitigationMeasuresSelect.firstChild) {
                    mitigationMeasuresSelect.removeChild(mitigationMeasuresSelect.firstChild);
                }
                // Populate mitigation measures based on selected control objective
                populateMitigationMeasures(mitigationMeasuresSelect);
            }
        });

        $(".slider")

        $(document).ready(function() {


          });

         // AJAX function to call the Django view

    function isValidURL(string) {
    try {
        new URL(string);
    } catch (_) {
        return false;
    }
    return true;
}
        function assessScenario() {
            $('#loadingSpinner').show();

            let cpha = sessionStorage.getItem('activeCyberPHA');
            let scenario = document.getElementById('id_txtScenario').value;
            let exposed_system = document.getElementById('exposed_system').checked;
            let weak_credentials = document.getElementById('weak_credentials').checked;
            // let consequence = document.getElementById('txtConsequence').value
            let threatsource = document.getElementById('threat-intelligence').value;
            let riskCategory = document.getElementById('risk-category').value;
            let safety = document.getElementById('range_safety').value;
            let life = document.getElementById('range_life').value;
            let production = document.getElementById('range_production').value;
            let financial = document.getElementById('range_finance').value;
            let reputation = document.getElementById('range_reputation').value;
            let environment = document.getElementById('range_environment').value;
            let regulatory = document.getElementById('range_regulatory').value;
            let data = document.getElementById('range_data').value;
            let supply = document.getElementById('range_supply').value;
            let sm = document.getElementById('SMrange').value;
            let mel = document.getElementById('MELrange').value;
            let rrm = document.getElementById('RRMrange').value;
            let sa = document.getElementById('SArange').value;
            let sl_a = document.getElementById('selSL').value;
            let mela = document.getElementById('MELarange').value;
            let industry = sessionStorage.getItem('sessionIndustry')
            let facilityType = sessionStorage.getItem('sessionFacilityType')
            // let standards = document.getElementById('selStandards').value;
            let country = document.getElementById('hdnCountry').value;
            let uel = document.getElementById('uel_range').value;
            let safety_hazard = document.getElementById('hazardNature').value;
            let production_outage = document.getElementById('outageYes').value;
            let production_outage_length = document.getElementById('outageDuration').value;
            // Gather validated consequences
            const table = document.getElementById('consequenceTable');
            const rows = table.getElementsByTagName('tbody')[0].rows;
            let validatedConsequences = [];
            let validatedConsequenceExists = false;

            for (let i = 0; i < rows.length; i++) {
                const isChecked = rows[i].cells[1].getElementsByTagName('input')[0].checked;
                if (isChecked) {
                    validatedConsequences.push(rows[i].cells[0].innerText);
                    validatedConsequenceExists = true;
                }
            }

            // Check if no consequences have been validated
            if (!validatedConsequenceExists) {
                alert("No consequences have been validated. Please validate at least one consequence before proceeding.");
                $('#loadingSpinner').hide();
                return; // Exit the function
            }

            // Convert the array of consequences to a string for sending in the AJAX request
            let validatedConsequencesStr = validatedConsequences.join(';');
            // Make the AJAX call to the Django view using the determined URL
            $.ajax({
                type: "GET",
                url: "{% url 'OTRisk:scenario_analysis' %}",
                data: {
                    // Pass the impact scores and scenario information as parameters
                    industry: industry,
                    facility_type: facilityType,
                    scenario: scenario,
                    exposed_system: exposed_system,
                    weak_credentials: weak_credentials,
                    threatsource: threatsource,
                    safety: safety,
                    life: life,
                    production: production,
                    reputation: reputation,
                    environment: environment,
                    regulatory: regulatory,
                    data: data,
                    sm: sm,
                    mel: mel,
                    rrm: sa,
                    supply: supply,
                    country: country,
                    uel: uel,
                    financial: financial,
                    cpha: cpha,
                    sl_a: sl_a,
                    safety_hazard: safety_hazard,
                    production_outage: production_outage,
                    production_outage_length: production_outage_length,
                    validated_consequences: validatedConsequencesStr,
                },
                success: function (response) {
                    $('#loadingSpinner').hide();
                   //document.getElementById('SArange').value = response.adjustedSeverity;
                   //document.getElementById('MELarange').value = response.adjustedExposure;
                   document.getElementById('txtRRa').value = response.adjustedRR;
                   document.getElementById('hdnLikelihood').value = response.likelihood;
                   document.getElementById('txtLikelihood').value = response.likelihood +'%';
                   // document.getElementById('txtScenarioAnalysis').value = response.recommendations;
                   let costsString = response.costs;
                   let costsArray = costsString.split('|');
                   let sle_low = costsArray.length > 0 && costsArray[0] ? `$${parseInt(costsArray[0]).toLocaleString()}` : "$0";
                   let sle_medium = costsArray.length > 1 && costsArray[1] ? `$${parseInt(costsArray[1]).toLocaleString()}` : "$0";
                   let sle_high = costsArray.length > 2 && costsArray[2] ? `$${parseInt(costsArray[2]).toLocaleString()}` : "$0";
                    document.getElementById('txtEventCosts').value = sle_medium;
                    document.getElementById('txtEventCosts_low').value = sle_low;
                    document.getElementById('txtEventCosts_high').value = sle_high;

                    document.getElementById('frequency').value = response.frequency;
                    document.getElementById('txtProbability').value = response.probability;

                    document.getElementById('hdn_control_effectiveness').value = response.control_effectiveness;
                    document.getElementById('hdn_bia_score').value = response.biaScore;

                    let ale_low = parseFloat(costsArray[0]) * parseFloat(response.frequency);

                    // Format ALE as currency
                    let formatter = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0, // No decimal places
                        maximumFractionDigits: 0  // No decimal places
                    });

                    let formattedAleLow = formatter.format(ale_low);


                    let ale_median = parseFloat(costsArray[1]) * parseFloat(response.frequency);

                    let formattedAleMedian = formatter.format(ale_median);


                    let ale_high = parseFloat(costsArray[2]) * parseFloat(response.frequency);

                    let formattedAleHigh = formatter.format(ale_high);

                    // Set the formatted value
                    document.getElementById('txt_ale_high').value = formattedAleHigh;
                    document.getElementById('txt_ale_median').value = formattedAleMedian;
                    document.getElementById('txt_ale_low').value = formattedAleLow;

                    var controlEffectivenessPercentage = response.control_effectiveness;
                    clearContainer('gaugeProbContainer');
                    clearContainer('gaugeContainer');
                    clearContainer('gaugeLikelihoodContainer');
                    clearContainer('gaugeResidualRisk');
                     clearContainer('gaugeFrequency');
                     clearContainer('gaugeBIAContainer');

                    createEffectivenessGauge(controlEffectivenessPercentage);
                    createProbGauge(response.probability);
                    createBIAGauge(response.biaScore);
                    createFrequencyGauge(response.frequency);
                    createLikelihoodGauge(response.likelihood);
                    // Define the text values based on the percentage range
                    var textValue = "";
                    if (controlEffectivenessPercentage < 25) {
                        textValue = "Low";
                    } else if (controlEffectivenessPercentage < 50) {
                        textValue = "Low/Medium";
                    } else if (controlEffectivenessPercentage < 75) {
                        textValue = "Medium";
                    } else if (controlEffectivenessPercentage < 90) {
                        textValue = "Medium/High";
                    } else {
                        textValue = "High";
                    }

                    document.getElementById('compliance_map').value = response.scenario_compliance_data;
                    // Destroy existing DataTable instance if it exists
                    if ($.fn.DataTable.isDataTable('#compliance_map')) {
                        $('#compliance_map').DataTable().destroy();
                    }
                    var compliance_map = response.scenario_compliance_data;

                    // Check if the DataTable is already initialized
                    var isDataTable = $.fn.DataTable.isDataTable('#compliance_map');
                    var dataTable;

                    if (isDataTable) {
                        // If already a DataTable, clear and destroy it
                        dataTable = $('#compliance_map').DataTable();
                        dataTable.clear().destroy();
                    } else {
                        // Clear the table body if it's not a DataTable
                        $('#compliance_map tbody').empty();
                    }
                    // Split the response into individual lines
                    var lines = compliance_map.split('||');
                    lines.forEach(function(line) {
                        if (line.trim() !== '') {
                            // Split each line into fields
                            var fields = line.split(' > ');

                            // Create a new row in the table
                            // Check if all fields exist and then create a new row in the table
                        if (fields.length === 3) {
                            var newRow = '<tr>' +
                                '<td>' + (fields[0] ? fields[0].trim() : '') + '</td>' +
                                '<td>' + (fields[1] ? fields[1].trim() : '') + '</td>' +
                                '<td>' + (fields[2] ? '<a href="' + fields[2].trim() + '" target="_blank">' + fields[2].trim() + '</a>' : '') + '</td>' +
                                '</tr>';
                            $('#compliance_map tbody').append(newRow);
                        }
                        }
                    });
                    // Set the value of the 'control_effectiveness' text control
                    document.getElementById('control_effectiveness').value = textValue;
                    //document.getElementById('txtEventCosts').value = formattedCosts;
                    document.getElementById('txtResidualRisk').value = response.adjustedRR

                    createResidualRiskGauge(response.adjustedRR);

                    $('#compliance_map').DataTable({
                        "paging": true,  // Enable pagination
                        "pageLength": 5,  // Set the number of rows per page
                        "searching": false,  // Disable the search box
                        "lengthChange": false  // Disable the page length selection control
                    });

                },
                error: function (xhr, status, error) {
                    // Handle any errors that occur during the AJAX call

                    $('#loadingSpinner').hide();
                },
            });
        }

document.getElementById('hdnphaID').value = sessionStorage.getItem('activeCyberPHA');

document.addEventListener("DOMContentLoaded", function() {
    // Function to update the indicator
    function updateIndicator(textarea, indicator) {
        if (textarea.value.trim() !== "") {
            indicator.style.display = "inline";
        } else {
            indicator.style.display = "none";
        }
    }

    // Get all labels with the data-modal-id attribute
    const labels = document.querySelectorAll('[data-modal-id]');

    labels.forEach(label => {
        const modalId = label.getAttribute('data-modal-id');
        const textareaId = label.getAttribute('data-textarea-id');
        const textarea = document.getElementById(textareaId);
        const indicator = label.nextElementSibling; // Assuming the indicator is the next sibling of the label

        // Check on modal close
        $('#' + modalId).on('hidden.bs.modal', function (e) {
            updateIndicator(textarea, indicator);
        });

        // Check on textarea change

        textarea.addEventListener('input', function() {
            console.log(textarea);
            console.log(indicator);
            updateIndicator(textarea, indicator);
        });
    });
});

    function createEffectivenessGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["red", "orange", "yellow", "green"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeContainer').draw();
}

function createBIAGauge(score){

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeBIAContainer').draw();

}

 function createProbGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeProbContainer').draw();

}


 function createLikelihoodGauge(score) {

    //clearContainer('gaugeContainer');
    // Create data set with our score
    var dataSet = anychart.data.set([score]);

    // Create a circular gauge chart
    var gauge = anychart.gauges.circular();
    var credits = gauge.credits();
    credits.enabled(false);
    // Set gauge settings
    gauge.data(dataSet).padding('4%');
    gauge.startAngle(270);
    gauge.sweepAngle(180);

    // Set axis scale settings
    var scale = gauge.axis().scale();
    scale.minimum(0)
        .maximum(100)
        .ticks()
        .interval(10);

    var needle=gauge.needle();
    needle.enabled(true);
    needle.startRadius("10%");
    needle.endRadius("80%");

    // Set the look of the bar that presents data
    gauge.bar(0)
        .position('i')
        .fill('#F0673B .9')
        .stroke('#F0673B')
        .radius(65);

       gauge.range({
      from: 0,
      to: 100,
      fill: {keys: ["green", "yellow", "orange" , "red"]},
      position: "inside",
      radius: 100,
      endSize: "15%",
      startSize:"15%",
      zIndex: 10
  });
    // Draw the chart
    gauge.container('gaugeLikelihoodContainer').draw();
}

function createResidualRiskGauge(rating) {
    // Translate the rating to a numerical value
    var score;
    switch (rating) {
        case "Low":
            score = 10;
            break;
        case "Low/Medium":
            score = 33;
            break;
        case "Medium":
            score = 50;
            break;
        case "Medium/High":
            score = 66;
            break;
        case "High":
            score = 90;
            break;
        default:
            return;
    }

    var data = [score];
    // set the gauge type
   var gauge = anychart.gauges.linear();
   gauge.layout('vertical'); // Set the layout to horizontal
        var credits = gauge.credits();
    credits.enabled(false);
   // set the data for the gauge
   gauge.data(data);

   var scaleBarColorScale = anychart.scales.ordinalColor().ranges(
  [
    {
      from: 0,
      to: 25,

        color: ['#CAD70b', '#2AD62A']
    },
    {
      from: 25,
      to: 50,

        color: ['#FFD700', '#CAD70b']
    },
    {
      from: 50,
      to: 75,
      color: ['#EB7A02', '#FFD700']
    },
    {
      from: 75,
      to: 100,
       color: ['#D81E05', '#EB7A02']
    }
  ]
);
var scaleBar = gauge.scaleBar(0);

   // set the height and offset of the Scale Bar (both as percentages of the gauge height)
   scaleBar.width('15%');
   scaleBar.offset('10%');

   // use the color scale (defined earlier) as the color scale of the Scale Bar
   scaleBar.colorScale(scaleBarColorScale);

   // add a marker pointer
   var marker = gauge.marker(0);
    marker.width(15);
   // set the offset of the pointer as a percentage of the gauge width
   marker.offset('30%');

   // set the marker type
   marker.type('triangle-left');
   // set the color of the marker to black
   marker.color('black');
    // set the zIndex of the marker
   marker.zIndex(10);

   // configure the scale
   var scale = gauge.scale();
   scale.minimum(0);
   scale.maximum(100);
   scale.ticks().interval(10);

    var axis = gauge.axis();
    axis.minorTicks(true)
    axis.minorTicks().stroke('#cecece');
    axis.width('1%');
    axis.offset('5%');
    axis.orientation('left');

    // format axis labels
    axis.labels().format(function() {
        if (this.value == 0) return "Low";
        else if (this.value == 50) return "Medium";
        else if (this.value == 100) return "High";
        else return "";  // This will hide other labels
    });
    gauge.width('100%');


    gauge.height('95%'); // Set height for vertical layout
    gauge.layout();
    gauge.padding([15, 0, 0, 15]); // Adjust padding for vertical layout


    // Draw the chart
    gauge.container('gaugeResidualRisk').draw();
}

function createFrequencyGauge(rating) {

    var data = rating;
    var gauge = anychart.gauges.linear();
    gauge.layout('vertical'); // Set the layout to horizontal

    var credits = gauge.credits();
    credits.enabled(false);

    gauge.data(data);

    var scaleBarColorScale = anychart.scales.ordinalColor().ranges([
        { from: 0, to: 1, color: ['#CAD70b', '#2AD62A'] },
        { from: 1, to: 3, color: ['#FFD700', '#CAD70b'] },
        { from: 3, to: 4, color: ['#EB7A02', '#FFD700'] },
        { from: 4, to: 5, color: ['#D81E05', '#EB7A02'] }
    ]);

    var scaleBar = gauge.scaleBar(0);
    scaleBar.width('15%');
    scaleBar.offset('10%');
    scaleBar.colorScale(scaleBarColorScale);

    var marker = gauge.marker(0);
    marker.width(15);
    marker.offset('30%');
    marker.type('triangle-left');
    marker.color('black');
    marker.zIndex(10);

    var scale = gauge.scale();
    scale.minimum(0);
    scale.maximum(5);
    scale.ticks().interval(0.5); // Adjust tick interval

    var axis = gauge.axis();
    axis.minorTicks(true);
    axis.minorTicks().stroke('#cecece');
    axis.width('1%');
    axis.offset('5%');
    axis.orientation('left');

    // Format axis labels to show specific intervals
    axis.labels().format(function() {
        if (this.value % 0.5 === 0) {
            return this.value.toFixed(1);  // Show labels at 0.5 intervals
        }
        return "";  // Hide other labels
    });

    gauge.height('95%'); // Set height for vertical layout
    gauge.layout();
    gauge.padding([15, 0, 0, 15]); // Adjust padding for vertical layout

    gauge.container('gaugeFrequency').draw();
}


function resetformcontrols() {
  swal({
    title: "New Scenario",
    text: "Are you sure you want to begin a new scenario and reset the form? All unsaved changes will be lost.",
    icon: "warning",
    buttons: ["No", "Yes"],
    dangerMode: true,
  }).then((isConfirmed) => {
    if (isConfirmed) {
      // Reset form fields here
      sessionStorage.setItem('attackTreeDrawn', 'false');
      document.getElementById('viewAttackTreeBtn').style.display = 'none';
      document.getElementById('exportAttackTreeBtn').style.display = 'none';
      document.getElementById('closeAttackTreeBtn').style.display = 'none';
      document.getElementById('id_txtScenario').value = '';
      document.getElementById('exposed_system').checked = false;
      document.getElementById('weak_credentials').checked = false;
      // document.getElementById('txtConsequence').value = '';
      document.getElementById('threat-intelligence').value = '';
      document.getElementById('risk-category').value = '';
      document.getElementById('range_safety').value = 0;
      document.getElementById('range_life').value = 0;
      document.getElementById('range_production').value = 0;
      document.getElementById('range_finance').value = 0;
      document.getElementById('range_reputation').value = 0;
      document.getElementById('range_environment').value = 0;
      document.getElementById('range_regulatory').value = 0;
      document.getElementById('range_data').value = 0;
      document.getElementById('range_supply').value = 0;
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('selSL').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtsafetyJustify').value = '';
      document.getElementById('hazardNature').value = '';
      document.getElementById('dangerScope').value = '';
      document.getElementById('sisOutageYes').checked = false;
      document.getElementById('sisOutageNo').checked = true;
      document.getElementById('sisIntegrityYes').checked = false;
      document.getElementById('sisIntegrityNo').checked = true;
      document.getElementById('txtlifeJustify').value = '';
      document.getElementById('txtproductionJustify').value = '';
      document.getElementById('txtfinanceJustify').value = '';
      document.getElementById('txtreputationJustify').value = '';
      document.getElementById('txtenvironmentJustify').value = '';
      document.getElementById('txtregulatoryJustify').value = '';
      document.getElementById('txtdataJustify').value = '';
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtScenarioAnalysis').value = 0;
      document.getElementById('txtLikelihood').value = 0;
      document.getElementById('hdnLikelihood').value = 0;
      document.getElementById('txtRRa').value = 0;
      document.getElementById('txtProbability').value = '';
      document.getElementById('control_effectiveness').value = '';
      document.getElementById('hdn_control_effectiveness').value = '';
      document.getElementById('hdn_bia_score').value = '';

      document.getElementById('txtEventCosts_low').value = '';
      document.getElementById('txtEventCosts').value = '';
      document.getElementById('txtEventCosts_high').value = '';
      document.getElementById('txt_ale_low').value = '';
      document.getElementById('txt_ale_median').value = '';
      document.getElementById('txt_ale_high').value = '';
      document.getElementById('frequency').value = '';
      document.getElementById('txtResidualRisk').value = '';
      document.getElementById('risk_register').checked = false;
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows
      // document.getElementById('has_controls').value = 0;
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');

      sessionStorage.setItem('ls', '0');
      sessionStorage.setItem('sid', 0);


    }
  });
}

function clearScenario(){
         sessionStorage.setItem('attackTreeDrawn', 'false');
      document.getElementById('viewAttackTreeBtn').style.display = 'none';
      document.getElementById('exportAttackTreeBtn').style.display = 'none';
      document.getElementById('closeAttackTreeBtn').style.display = 'none';
      document.getElementById('id_txtScenario').value = '';
      document.getElementById('exposed_system').checked = false;
      document.getElementById('weak_credentials').checked = false;
      // document.getElementById('txtConsequence').value = '';
      document.getElementById('threat-intelligence').value = '';
      document.getElementById('risk-category').value = '';
      document.getElementById('range_safety').value = 0;
      document.getElementById('range_life').value = 0;
      document.getElementById('range_production').value = 0;
      document.getElementById('range_finance').value = 0;
      document.getElementById('range_reputation').value = 0;
      document.getElementById('range_environment').value = 0;
      document.getElementById('range_regulatory').value = 0;
      document.getElementById('range_data').value = 0;
      document.getElementById('range_supply').value = 0;
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('selSL').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtsafetyJustify').value = '';
      document.getElementById('hazardNature').value = '';
      document.getElementById('dangerScope').value = '';
      document.getElementById('sisOutageYes').checked = false;
      document.getElementById('sisOutageNo').checked = true;
      document.getElementById('sisIntegrityYes').checked = false;
      document.getElementById('sisIntegrityNo').checked = true;
      document.getElementById('txtlifeJustify').value = '';
      document.getElementById('txtproductionJustify').value = '';
      document.getElementById('txtfinanceJustify').value = '';
      document.getElementById('txtreputationJustify').value = '';
      document.getElementById('txtenvironmentJustify').value = '';
      document.getElementById('txtregulatoryJustify').value = '';
      document.getElementById('txtdataJustify').value = '';
      document.getElementById('SMrange').value = 0;
      document.getElementById('MELrange').value = 0;
      document.getElementById('RRMrange').value = 0;
      document.getElementById('SArange').value = 0;
      document.getElementById('MELarange').value = 0;
      document.getElementById('txtScenarioAnalysis').value = 0;
      document.getElementById('txtLikelihood').value = 0;
      document.getElementById('hdnLikelihood').value = 0;
      document.getElementById('txtRRa').value = 0;
      document.getElementById('txtProbability').value = '';
      document.getElementById('control_effectiveness').value = '';
      document.getElementById('hdn_control_effectiveness').value = '';
      document.getElementById('hdn_bia_score').value = '';

      document.getElementById('txtEventCosts_low').value = '';
      document.getElementById('txtEventCosts').value = '';
      document.getElementById('txtEventCosts_high').value = '';
      document.getElementById('txt_ale_low').value = '';
      document.getElementById('txt_ale_median').value = '';
      document.getElementById('txt_ale_high').value = '';
      document.getElementById('frequency').value = '';
      document.getElementById('txtResidualRisk').value = '';
      document.getElementById('risk_register').checked = false;
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows
      // document.getElementById('has_controls').value = 0;
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');

      sessionStorage.setItem('ls', '0');
      sessionStorage.setItem('sid', 0);


}

 function fillScenario(scenarioId) {
    sessionStorage.setItem('sid', scenarioId);

    sessionStorage.setItem('attackTreeDrawn', 'false');
    document.getElementById('viewAttackTreeBtn').style.display = 'none';
    document.getElementById('exportAttackTreeBtn').style.display = 'none';
    document.getElementById('closeAttackTreeBtn').style.display = 'none';

    var container = document.getElementById('attack_tree');
    container.innerHTML = '';
    // Send a GET request to the getSingleScenario view
    $.get("{% url 'OTRisk:getSingleScenario' %}", { id: scenarioId }, function(data) {

         if (data.risk_register === true) {
            sessionStorage.setItem("ls", "1");
            $('#risk_register').prop('checked', true);
        } else {
            sessionStorage.setItem("ls", "0");
            $('#risk_register').prop('checked', false);
        }
        // Fill the form fields with the returned data
        $('#id_txtScenario').val(data.Scenario);

        $('#exposed_system').prop('checked', data.exposed_system);
        $('#weak_credentials').prop('checked', data.weak_credentials);

        //$('#txtConsequence').val(data.Consequence);
        $('#threat-intelligence').val(data.ThreatClass);
        //$('#selStandards').val(data.standards);


         $('#risk-category').val(data.RiskCategory);
         $('#risk-category').val(data.RiskCategory);
         $('#range_safety').val(data.impactSafety);
         $('#range_life').val(data.impactDanger);
         $('#range_production').val(data.impactProduction);
         $('#range_finance').val(data.impactFinance);
         $('#range_reputation').val(data.impactReputation);
         $('#scenarioStatusSelect').val(data.scenario_status);

         $('#env_contaminant').val(data.env_contaminant);
         $('#env_ecosystem').val(data.env_ecosystem);
         $('#env_contamination').val(data.env_contamination);
         $('#env_population').val(data.env_population);
         $('#env_wildlife').val(data.env_wildlife);


         $('#range_regulation').val(data.impactRegulation);
         $('#range_data').val(data.impactData);
         // $('#selStandards').val(data.RiskCategory);

        $('#txtScenarioAnalysis').val(data.recommendations);
        $('#SMrange').val(data.SM);
        $('#MELrange').val(data.MEL);
        $('#RRMrange').val(data.RRM);
        $('#selSL').val(data.sl_a);
        $('#SArange').val(data.SA);
        $('#MELarange').val(data.MELA);
        $('#uel_range').val(data.UEL);
        $('#uel_vuln').val(data.uel_vuln);
        $('#uel_exposure').val(data.uel_exposure);
        $('#uel_threat').val(data.uel_threat);
        $('#rru_range').val(data.RRU);
        $('#frequency').val(data.frequency);
        $('#has_controls').val(data.has_controls);
        document.getElementById('user_role').textContent = data.user_role;

        $('#sle').val(data.sle);

        $('#compliance_map').val(data.compliance_map);

        $('#attack_tree_text').val(data.attack_tree_text || '');  // Set to empty string if undefined or null

        // Check if data.attack_tree_text is defined, not null, and not an empty string
        if (data.attack_tree_text && data.attack_tree_text.trim() !== '') {

            var jsonStringFromDatabase = data.attack_tree_text;
            var jsonObject = JSON.parse(jsonStringFromDatabase);
            drawAttackTree(jsonObject);
        }



        if ($.fn.DataTable.isDataTable('#compliance_map')) {
                        $('#compliance_map').DataTable().destroy();
                    }
        var compliance_map = data.compliance_map;

        // Check if the DataTable is already initialized
        var isDataTable = $.fn.DataTable.isDataTable('#compliance_map');
        var dataTable;

        if (isDataTable) {
            // If already a DataTable, clear and destroy it
            dataTable = $('#compliance_map').DataTable();
            dataTable.clear().destroy();
        } else {
            // Clear the table body if it's not a DataTable
            $('#compliance_map tbody').empty();
        }
        // Split the response into individual lines
        var lines = compliance_map.split('||');
        lines.forEach(function(line) {
            if (line.trim() !== '') {
                // Split each line into fields
                var fields = line.split(' > ');

                // Create a new row in the table
                // Check if all fields exist and then create a new row in the table
            if (fields.length === 3) {
                var newRow = '<tr>' +
                    '<td>' + (fields[0] ? fields[0].trim() : '') + '</td>' +
                    '<td>' + (fields[1] ? fields[1].trim() : '') + '</td>' +
                    '<td>' + (fields[2] ? '<a href="' + fields[2].trim() + '" target="_blank">' + fields[2].trim() + '</a>' : '') + '</td>' +
                    '</tr>';
                $('#compliance_map tbody').append(newRow);
            }
            }
        });

        $('#compliance_map').DataTable({
                "paging": true,  // Enable pagination
                "pageLength": 5,  // Set the number of rows per page
                "searching": false,  // Disable the search box
                "lengthChange": false  // Disable the page length selection control
            });
        let costs = parseFloat(data.sle); // Assuming response.costs is a string representation of a number
        let formattedCosts = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs);

        document.getElementById('sle').value = formattedCosts;
        document.getElementById('txtEventCosts').value= formattedCosts;
        let costs_low = parseFloat(data.sle_low); // Assuming response.costs is a string representation of a number
        let formattedCosts_low = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_low);
        document.getElementById('txtEventCosts_low').value= formattedCosts_low;
        let costs_high = parseFloat(data.sle_high); // Assuming response.costs is a string representation of a number
        let formattedCosts_high = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(costs_high);
        document.getElementById('txtEventCosts_high').value= formattedCosts_high;
        let ale_costs_high = parseFloat(data.ale_high); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_high = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_high);
        document.getElementById('txt_ale_high').value= ale_formattedCosts_high;
        let ale_costs_low = parseFloat(data.ale_low); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_low = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_low);
        document.getElementById('txt_ale_low').value= ale_formattedCosts_low;
        let ale_costs_median = parseFloat(data.ale_median); // Assuming response.costs is a string representation of a number
        let ale_formattedCosts_median = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(ale_costs_median);
        document.getElementById('txt_ale_median').value= ale_formattedCosts_median;

        document.getElementById('txtResidualRisk').value= data.RRa;
        document.getElementById('txtProbability').value= data.probability;
        document.getElementById('hdn_control_effectiveness').value= data.control_effectiveness;
         document.getElementById('hdn_bia_score').value= data.ai_bia_score;
         // Populate the scenario_consequences table
        var tableBody = $('#consequenceTable tbody');
        tableBody.empty(); // Clear existing rows

        data.Consequences.forEach(function(consequence) {
            var checked = consequence.is_validated ? 'checked' : '';
            var row = `<tr>
                <td>${consequence.consequence_text}</td>
                <td><input type="checkbox" ${checked}></td>
            </tr>`;
            tableBody.append(row);
        });

        // Clear existing rows in the safeguards table
    $('#table_safeguards tbody').empty();

    // Check if there are safeguards in the response
    if (data.safeguards && data.safeguards.length > 0) {
        // Iterate over each safeguard and append it to the table
        data.safeguards.forEach(function(safeguard) {
            var newRow = `<tr>
                <td><textarea class="form-control" maxlength="100">${safeguard.safeguard_description}</textarea></td>
                <td><textarea class="form-control" maxlength="100">${safeguard.safeguard_type}</textarea></td>
                <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
            </tr>`;
            $('#table_safeguards tbody').append(newRow);
        });
    } else {
        // If no safeguards, add a dummy row indicating this
        var newRow = `<tr>
            <td><textarea class="form-control" maxlength="100">No physical safeguards defined</textarea></td>
            <td><textarea class="form-control" maxlength="100">No physical safeguards defined</textarea></td>
            <td><button type="button" class="btn btn-danger btn-sm deleteRowBtn">Delete</button></td>
        </tr>`;
        $('#table_safeguards tbody').append(newRow);
    }
        // Define the text values based on the percentage range
                    var textValue = "";
                    if (data.control_effectiveness < 25) {
                        textValue = "Low";
                    } else if (data.control_effectiveness < 50) {
                        textValue = "Low/Medium";
                    } else if (data.control_effectiveness < 75) {
                        textValue = "Medium";
                    } else if (data.control_effectiveness < 90) {
                        textValue = "Medium/High";
                    } else {
                        textValue = "High";
                    }
        clearContainer('gaugeProbContainer');
        clearContainer('gaugeContainer');
        clearContainer('gaugeLikelihoodContainer');
        clearContainer('gaugeResidualRisk');
        clearContainer('gaugeFrequency');
        clearContainer('gaugeBIAContainer');

         createEffectivenessGauge(data.control_effectiveness);
         createProbGauge(data.probability);
         createLikelihoodGauge(data.likelihood);
         createBIAGauge(data.ai_bia_score);
         createResidualRiskGauge(data.RRa);
         createFrequencyGauge(data.frequency);

        // Set the value of the 'control_effectiveness' text control
        document.getElementById('control_effectiveness').value = textValue;
        document.getElementById('hdnScenario').value = scenarioId;

         $('#txtRRa').val(data.RRa);
         $('#hdnLikelihood').val(data.likelihood);
        $('#txtLikelihood').val(data.likelihood + '%');
        $('#txtdataJustify').val(data.justifyData);
        $('#txtregulatoryJustify').val(data.justifyRegulation);
        $('#txtenvironmentJustify').val(data.justifyEnvironment);
        $('#txtreputationJustify').val(data.justifyReputation);
        $('#txtfinanceJustify').val(data.justifyFinancial);
        $('#txtproductionJustify').val(data.justifyProduction);
        $('#txtlifeJustify').val(data.justifyLife);
        $('#txtsafetyJustify').val(data.justifySafety);
        $('#hazardNature').val(data.safety_hazard);
        $('#dangerScope').val(data.dangerScope);
        if (data.sis_compromise) {
          $('#sisIntegrityYes').prop('checked', true);
        } else {
          $('#sisIntegrityNo').prop('checked', true);
        }

        if (data.sis_outage) {
            $('#sisOutageYes').prop('checked', true);

            } else {
            $('#sisOutageNo').prop('checked', true);

        }

        if (data.prodOutage) {
            $('#outageYes').prop('checked', true);
            toggleOutageControls(true);
            } else {
            $('#outageNo').prop('checked', true);
            toggleOutageControls(false);
        }
        $('#outageDuration').val(data.prodOutageDuration);
        $('#outageCost').val(data.prodOutageCost);

        loadVulnerabilityTable(scenarioId);
        if (data.user_role === 'Scenario Moderator') {
            disableScenarioControls();
        }
         });

    }

    function disableScenarioControls() {
    // Disable all input, textarea, button, and select elements except those specified
    $('input, textarea, button, select').not('#scenarioStatusSelect, button[onclick="processFormData()"]').prop('disabled', true);

    // Additionally, hide or disable other elements as needed
    // For example, to hide specific buttons:
    // $('#someButtonId').hide();
    // Or to disable specific buttons:
    // $('#someButtonId').prop('disabled', true);
}
function updaterSliderColor(slider) {
    let value = parseInt(slider.value);
    let max = parseInt(slider.max);
    let hue;

    if (value <= max * 0.5) {
        // Transition from red (0) to yellow (60) for the first half
        hue = 60 * (value / (0.5 * max));
    } else {
        // Transition from yellow (60) to green (120) for the second half
        hue = 60 + 60 * ((value - 0.5 * max) / (0.5 * max));
    }

    slider.style.setProperty('--thumb-color', 'hsl(' + hue + ', 100%, 50%)');
}


function clearContainer(containerId) {
    var container = document.getElementById(containerId);
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
}


$(document).ready(function() {
            $('#toggleButton').on('click', function() {
                var isHidden = $('#toggleRow').children().not('#toggleButton').is(':hidden');
                $('#toggleRow').children().not('#toggleButton').toggle();
                if (isHidden) {
                    $('#toggleIcon').attr('src', '{% static 'images/close.png' %}');
                } else {
                    $('#toggleIcon').attr('src', '{% static 'images/open.png' %}');
                }
            });
        });


        $(document).ready(function() {
            $('#toggleButton2').on('click', function() {
                var isHidden = $('#ra_container').children().not('#toggleButton2').is(':hidden');
                $('#ra_container').children().not('#toggleButton2').toggle();
                if (isHidden) {
                    $('#toggleIcon2').attr('src', '{% static 'images/close.png' %}');
                } else {
                    $('#toggleIcon2').attr('src', '{% static 'images/open.png' %}');
                }
            });
        });

$(document).ready(function() {
    // Check if there are any rows in the table
    var rows = $("#userscenarioListBody tr");
    if (rows.length > 0) {
        // If there are rows, trigger a click on the first one
        rows.first().click();
    }
});


document.addEventListener('DOMContentLoaded', (event) => {
    document.getElementById('minimizeBtn').click();
});



</script>


<input type="text" id="control_effectiveness" name="control_effectiveness" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtProbability" name="txtProbability" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtLikelihood" name="txtLikelihood" class="form-control text-center" readonly style="visibility: hidden">
<input type="text" id="txtResidualRisk" name="txtResidualRisk" class="form-control text-center" readonly style="visibility: hidden">
<!-- Modal -->
<!-- Modal -->
<div id="scenarioModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Definition of a Well-Constructed Scenario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>A well-constructed scenario, especially in the context of cybersecurity for industrial systems, is a concise yet detailed narrative that outlines a potential event or situation. It includes:</p>
                <ul>
                    <li><strong>Specificity:</strong> Precise description of the industrial device or system, its operational context, and specific cybersecurity threats or vulnerabilities.</li>
                    <li><strong>Contextual Relevance:</strong> Set within a well-defined operational environment, outlining relevant factors like network connectivity, system architecture, or third-party integrations.</li>
                    <li><strong>Problem Definition:</strong> Clear description of the cybersecurity challenge or threat, including potential cyber attacks or specific vulnerabilities.</li>
                </ul>
                <h3>Examples:</h3>
                <ol>
                    <li><strong>Phishing Attack in a Power Plant:</strong>...</li>
                    <li><strong>Malware in Manufacturing:</strong>...</li>
                    <li><strong>ERP System Vulnerability in Pharmaceutical Industry:</strong>...</li>
                </ol>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
var link = document.getElementById("link-to-resource");
var modal = new bootstrap.Modal(document.getElementById("scenarioModal"), {});

// Check if elements exist
if (link && modal) {
// When the user clicks the link, open the modal
link.addEventListener('click', function() {
modal.show();
});
}
});



</script>

</body>
</html>
