{% extends "base.html" %}

{% block content %}
    {% csrf_token %}

    <div class="row" style="height: 80px;">
    <div class="col-md-1 bg-black"></div>
    <div class="col-md-10 bg-white"></div>
    <div class="col-md-1 bg-black"></div>
</div>
<div class="row">
    <div class="col-md-1 bg-black"></div>
    <div class="col-md-10 bg-white" style="text-align: center"><h5></h5></div>
    <div class="col-md-1 bg-black"></div>
</div>

<div class="row">
<div class="col-md-1 bg-black"></div>
<div class = "col-md-10">
    <div class="row">
        <div class="col-md-6 bg-white" style="text-align: center">
            <table id="usersTable" class="display">
                <thead>
                    <tr>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Actions</th> <!-- New column for actions -->
                    </tr>
                </thead>
                <tbody>
                    {% for user_profile in user_profiles %}
                    <tr>
                        <td>{{ user_profile.user.first_name }}</td>
                        <td>{{ user_profile.user.last_name }}</td>
                        <td>{{ user_profile.user.email }}</td>
                        <td>
                            {% if user_profile.user.id != request.user.id %}
                                <button class="disable-btn" data-user-id="{{ user_profile.user.id }}">Disable</button>
                                <button class="delete-btn" data-user-id="{{ user_profile.user.id }}">Delete</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-md-1 bg-white"></div>
        <div class="col-md-5 bg-white" style="text-align: center">
            {% if user.is_superuser %}
                <h2>Add New User</h2>
                    <form method="post">
                        {% csrf_token %}
                        <div class="card mb-3 shadow-sm"> <!-- Bootstrap card with shadow -->
                            <div class="card-body">
                                {{ user_form.username.label_tag }} {{ user_form.username }}

                                {{ user_form.first_name.label_tag }} {{ user_form.first_name }}

                                {{ user_form.last_name.label_tag }} {{ user_form.last_name }}

                                {{ user_form.email.label_tag }} {{ user_form.email }}
                            </div>
                        </div>


                        {{ profile_form.as_p }}
                        <button type="submit" id="submitButton">Add User</button>
                    </form>
            {% else %}
                <h2>Your Information</h2>
                <p>First Name: {{ user.first_name }}</p>
                <p>Last Name: {{ user.last_name }}</p>
                <p>Email: {{ user.email }}</p>
            {% endif %}
        </div>
    </div>
</div>
    <div class="col-md-1 bg-black"></div>
</div>
<script>
    $(document).ready( function () {
        $('#usersTable').DataTable();
    });

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
$.ajaxSetup({
    headers: { "X-CSRFToken": csrftoken }
});



    $(document).ready(function() {
        $('#usersTable').DataTable();

        // Handle the disable button click
        $('.disable-btn').click(function() {
            const userId = $(this).data('user-id');
            if (confirm('Are you sure you want to disable this user?')) {
                // Send a request to your backend to disable the user
                // You'll need to create an endpoint for this
                $.post(`/OTRisk/disable_user/${userId}/`, function(response) {
                    if (response.success) {
                        alert('User disabled successfully!');
                        location.reload(); // Reload the page to reflect changes
                    } else {
                        alert('Error disabling user.');
                    }
                });
            }
        });

        // Handle the delete button click
        $('.delete-btn').click(function() {
            const userId = $(this).data('user-id');
            if (confirm('Are you sure you want to delete this user?')) {
                // Send a request to your backend to delete the user
                // You'll need to create an endpoint for this
                $.post(`/OTRisk/delete_user/${userId}/`, function(response) {
                    if (response.success) {
                        alert('User deleted successfully!');
                        location.reload(); // Reload the page to reflect changes
                    } else {
                        alert('Error deleting user.');
                    }
                });
            }
        });
    });


</script>


{% endblock %}
